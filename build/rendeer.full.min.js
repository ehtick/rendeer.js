/*!
@fileoverview gl-matrix - High performance matrix and vector operations
@author Brandon Jones
@author Colin MacKenzie IV
@version 2.7.0

Copyright (c) 2015-2018, Brandon Jones, Colin MacKenzie IV.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/
!function(t,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var r=n();for(var a in r)("object"==typeof exports?exports:t)[a]=r[a]}}("undefined"!=typeof self?self:this,function(){return function(t){var n={};function r(a){if(n[a])return n[a].exports;var e=n[a]={i:a,l:!1,exports:{}};return t[a].call(e.exports,e,e.exports,r),e.l=!0,e.exports}return r.m=t,r.c=n,r.d=function(t,n,a){r.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:a})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,n){if(1&n&&(t=r(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var e in t)r.d(a,e,function(n){return t[n]}.bind(null,e));return a},r.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(n,"a",n),n},r.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},r.p="",r(r.s=10)}([function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.setMatrixArrayType=function(t){n.ARRAY_TYPE=t},n.toRadian=function(t){return t*e},n.equals=function(t,n){return Math.abs(t-n)<=a*Math.max(1,Math.abs(t),Math.abs(n))};var a=n.EPSILON=1e-6;n.ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,n.RANDOM=Math.random;var e=Math.PI/180},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.forEach=n.sqrLen=n.len=n.sqrDist=n.dist=n.div=n.mul=n.sub=void 0,n.create=e,n.clone=function(t){var n=new a.ARRAY_TYPE(4);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n},n.fromValues=function(t,n,r,e){var u=new a.ARRAY_TYPE(4);return u[0]=t,u[1]=n,u[2]=r,u[3]=e,u},n.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t},n.set=function(t,n,r,a,e){return t[0]=n,t[1]=r,t[2]=a,t[3]=e,t},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t},n.subtract=u,n.multiply=o,n.divide=i,n.ceil=function(t,n){return t[0]=Math.ceil(n[0]),t[1]=Math.ceil(n[1]),t[2]=Math.ceil(n[2]),t[3]=Math.ceil(n[3]),t},n.floor=function(t,n){return t[0]=Math.floor(n[0]),t[1]=Math.floor(n[1]),t[2]=Math.floor(n[2]),t[3]=Math.floor(n[3]),t},n.min=function(t,n,r){return t[0]=Math.min(n[0],r[0]),t[1]=Math.min(n[1],r[1]),t[2]=Math.min(n[2],r[2]),t[3]=Math.min(n[3],r[3]),t},n.max=function(t,n,r){return t[0]=Math.max(n[0],r[0]),t[1]=Math.max(n[1],r[1]),t[2]=Math.max(n[2],r[2]),t[3]=Math.max(n[3],r[3]),t},n.round=function(t,n){return t[0]=Math.round(n[0]),t[1]=Math.round(n[1]),t[2]=Math.round(n[2]),t[3]=Math.round(n[3]),t},n.scale=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t},n.scaleAndAdd=function(t,n,r,a){return t[0]=n[0]+r[0]*a,t[1]=n[1]+r[1]*a,t[2]=n[2]+r[2]*a,t[3]=n[3]+r[3]*a,t},n.distance=s,n.squaredDistance=c,n.length=f,n.squaredLength=M,n.negate=function(t,n){return t[0]=-n[0],t[1]=-n[1],t[2]=-n[2],t[3]=-n[3],t},n.inverse=function(t,n){return t[0]=1/n[0],t[1]=1/n[1],t[2]=1/n[2],t[3]=1/n[3],t},n.normalize=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=r*r+a*a+e*e+u*u;o>0&&(o=1/Math.sqrt(o),t[0]=r*o,t[1]=a*o,t[2]=e*o,t[3]=u*o);return t},n.dot=function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},n.lerp=function(t,n,r,a){var e=n[0],u=n[1],o=n[2],i=n[3];return t[0]=e+a*(r[0]-e),t[1]=u+a*(r[1]-u),t[2]=o+a*(r[2]-o),t[3]=i+a*(r[3]-i),t},n.random=function(t,n){var r,e,u,o,i,s;n=n||1;do{r=2*a.RANDOM()-1,e=2*a.RANDOM()-1,i=r*r+e*e}while(i>=1);do{u=2*a.RANDOM()-1,o=2*a.RANDOM()-1,s=u*u+o*o}while(s>=1);var c=Math.sqrt((1-i)/s);return t[0]=n*r,t[1]=n*e,t[2]=n*u*c,t[3]=n*o*c,t},n.transformMat4=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3];return t[0]=r[0]*a+r[4]*e+r[8]*u+r[12]*o,t[1]=r[1]*a+r[5]*e+r[9]*u+r[13]*o,t[2]=r[2]*a+r[6]*e+r[10]*u+r[14]*o,t[3]=r[3]*a+r[7]*e+r[11]*u+r[15]*o,t},n.transformQuat=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=r[0],i=r[1],s=r[2],c=r[3],f=c*a+i*u-s*e,M=c*e+s*a-o*u,h=c*u+o*e-i*a,l=-o*a-i*e-s*u;return t[0]=f*c+l*-o+M*-s-h*-i,t[1]=M*c+l*-i+h*-o-f*-s,t[2]=h*c+l*-s+f*-i-M*-o,t[3]=n[3],t},n.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]},n.equals=function(t,n){var r=t[0],e=t[1],u=t[2],o=t[3],i=n[0],s=n[1],c=n[2],f=n[3];return Math.abs(r-i)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(e-s)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(s))&&Math.abs(u-c)<=a.EPSILON*Math.max(1,Math.abs(u),Math.abs(c))&&Math.abs(o-f)<=a.EPSILON*Math.max(1,Math.abs(o),Math.abs(f))};var a=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}(r(0));function e(){var t=new a.ARRAY_TYPE(4);return a.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function u(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t[3]=n[3]-r[3],t}function o(t,n,r){return t[0]=n[0]*r[0],t[1]=n[1]*r[1],t[2]=n[2]*r[2],t[3]=n[3]*r[3],t}function i(t,n,r){return t[0]=n[0]/r[0],t[1]=n[1]/r[1],t[2]=n[2]/r[2],t[3]=n[3]/r[3],t}function s(t,n){var r=n[0]-t[0],a=n[1]-t[1],e=n[2]-t[2],u=n[3]-t[3];return Math.sqrt(r*r+a*a+e*e+u*u)}function c(t,n){var r=n[0]-t[0],a=n[1]-t[1],e=n[2]-t[2],u=n[3]-t[3];return r*r+a*a+e*e+u*u}function f(t){var n=t[0],r=t[1],a=t[2],e=t[3];return Math.sqrt(n*n+r*r+a*a+e*e)}function M(t){var n=t[0],r=t[1],a=t[2],e=t[3];return n*n+r*r+a*a+e*e}n.sub=u,n.mul=o,n.div=i,n.dist=s,n.sqrDist=c,n.len=f,n.sqrLen=M,n.forEach=function(){var t=e();return function(n,r,a,e,u,o){var i=void 0,s=void 0;for(r||(r=4),a||(a=0),s=e?Math.min(e*r+a,n.length):n.length,i=a;i<s;i+=r)t[0]=n[i],t[1]=n[i+1],t[2]=n[i+2],t[3]=n[i+3],u(t,t,o),n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2],n[i+3]=t[3];return n}}()},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.forEach=n.sqrLen=n.len=n.sqrDist=n.dist=n.div=n.mul=n.sub=void 0,n.create=e,n.clone=function(t){var n=new a.ARRAY_TYPE(3);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n},n.length=u,n.fromValues=o,n.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t},n.set=function(t,n,r,a){return t[0]=n,t[1]=r,t[2]=a,t},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t},n.subtract=i,n.multiply=s,n.divide=c,n.ceil=function(t,n){return t[0]=Math.ceil(n[0]),t[1]=Math.ceil(n[1]),t[2]=Math.ceil(n[2]),t},n.floor=function(t,n){return t[0]=Math.floor(n[0]),t[1]=Math.floor(n[1]),t[2]=Math.floor(n[2]),t},n.min=function(t,n,r){return t[0]=Math.min(n[0],r[0]),t[1]=Math.min(n[1],r[1]),t[2]=Math.min(n[2],r[2]),t},n.max=function(t,n,r){return t[0]=Math.max(n[0],r[0]),t[1]=Math.max(n[1],r[1]),t[2]=Math.max(n[2],r[2]),t},n.round=function(t,n){return t[0]=Math.round(n[0]),t[1]=Math.round(n[1]),t[2]=Math.round(n[2]),t},n.scale=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t},n.scaleAndAdd=function(t,n,r,a){return t[0]=n[0]+r[0]*a,t[1]=n[1]+r[1]*a,t[2]=n[2]+r[2]*a,t},n.distance=f,n.squaredDistance=M,n.squaredLength=h,n.negate=function(t,n){return t[0]=-n[0],t[1]=-n[1],t[2]=-n[2],t},n.inverse=function(t,n){return t[0]=1/n[0],t[1]=1/n[1],t[2]=1/n[2],t},n.normalize=l,n.dot=v,n.cross=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=r[0],i=r[1],s=r[2];return t[0]=e*s-u*i,t[1]=u*o-a*s,t[2]=a*i-e*o,t},n.lerp=function(t,n,r,a){var e=n[0],u=n[1],o=n[2];return t[0]=e+a*(r[0]-e),t[1]=u+a*(r[1]-u),t[2]=o+a*(r[2]-o),t},n.hermite=function(t,n,r,a,e,u){var o=u*u,i=o*(2*u-3)+1,s=o*(u-2)+u,c=o*(u-1),f=o*(3-2*u);return t[0]=n[0]*i+r[0]*s+a[0]*c+e[0]*f,t[1]=n[1]*i+r[1]*s+a[1]*c+e[1]*f,t[2]=n[2]*i+r[2]*s+a[2]*c+e[2]*f,t},n.bezier=function(t,n,r,a,e,u){var o=1-u,i=o*o,s=u*u,c=i*o,f=3*u*i,M=3*s*o,h=s*u;return t[0]=n[0]*c+r[0]*f+a[0]*M+e[0]*h,t[1]=n[1]*c+r[1]*f+a[1]*M+e[1]*h,t[2]=n[2]*c+r[2]*f+a[2]*M+e[2]*h,t},n.random=function(t,n){n=n||1;var r=2*a.RANDOM()*Math.PI,e=2*a.RANDOM()-1,u=Math.sqrt(1-e*e)*n;return t[0]=Math.cos(r)*u,t[1]=Math.sin(r)*u,t[2]=e*n,t},n.transformMat4=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=r[3]*a+r[7]*e+r[11]*u+r[15];return o=o||1,t[0]=(r[0]*a+r[4]*e+r[8]*u+r[12])/o,t[1]=(r[1]*a+r[5]*e+r[9]*u+r[13])/o,t[2]=(r[2]*a+r[6]*e+r[10]*u+r[14])/o,t},n.transformMat3=function(t,n,r){var a=n[0],e=n[1],u=n[2];return t[0]=a*r[0]+e*r[3]+u*r[6],t[1]=a*r[1]+e*r[4]+u*r[7],t[2]=a*r[2]+e*r[5]+u*r[8],t},n.transformQuat=function(t,n,r){var a=r[0],e=r[1],u=r[2],o=r[3],i=n[0],s=n[1],c=n[2],f=e*c-u*s,M=u*i-a*c,h=a*s-e*i,l=e*h-u*M,v=u*f-a*h,d=a*M-e*f,b=2*o;return f*=b,M*=b,h*=b,l*=2,v*=2,d*=2,t[0]=i+f+l,t[1]=s+M+v,t[2]=c+h+d,t},n.rotateX=function(t,n,r,a){var e=[],u=[];return e[0]=n[0]-r[0],e[1]=n[1]-r[1],e[2]=n[2]-r[2],u[0]=e[0],u[1]=e[1]*Math.cos(a)-e[2]*Math.sin(a),u[2]=e[1]*Math.sin(a)+e[2]*Math.cos(a),t[0]=u[0]+r[0],t[1]=u[1]+r[1],t[2]=u[2]+r[2],t},n.rotateY=function(t,n,r,a){var e=[],u=[];return e[0]=n[0]-r[0],e[1]=n[1]-r[1],e[2]=n[2]-r[2],u[0]=e[2]*Math.sin(a)+e[0]*Math.cos(a),u[1]=e[1],u[2]=e[2]*Math.cos(a)-e[0]*Math.sin(a),t[0]=u[0]+r[0],t[1]=u[1]+r[1],t[2]=u[2]+r[2],t},n.rotateZ=function(t,n,r,a){var e=[],u=[];return e[0]=n[0]-r[0],e[1]=n[1]-r[1],e[2]=n[2]-r[2],u[0]=e[0]*Math.cos(a)-e[1]*Math.sin(a),u[1]=e[0]*Math.sin(a)+e[1]*Math.cos(a),u[2]=e[2],t[0]=u[0]+r[0],t[1]=u[1]+r[1],t[2]=u[2]+r[2],t},n.angle=function(t,n){var r=o(t[0],t[1],t[2]),a=o(n[0],n[1],n[2]);l(r,r),l(a,a);var e=v(r,a);return e>1?0:e<-1?Math.PI:Math.acos(e)},n.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]},n.equals=function(t,n){var r=t[0],e=t[1],u=t[2],o=n[0],i=n[1],s=n[2];return Math.abs(r-o)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(e-i)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(i))&&Math.abs(u-s)<=a.EPSILON*Math.max(1,Math.abs(u),Math.abs(s))};var a=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}(r(0));function e(){var t=new a.ARRAY_TYPE(3);return a.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function u(t){var n=t[0],r=t[1],a=t[2];return Math.sqrt(n*n+r*r+a*a)}function o(t,n,r){var e=new a.ARRAY_TYPE(3);return e[0]=t,e[1]=n,e[2]=r,e}function i(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t}function s(t,n,r){return t[0]=n[0]*r[0],t[1]=n[1]*r[1],t[2]=n[2]*r[2],t}function c(t,n,r){return t[0]=n[0]/r[0],t[1]=n[1]/r[1],t[2]=n[2]/r[2],t}function f(t,n){var r=n[0]-t[0],a=n[1]-t[1],e=n[2]-t[2];return Math.sqrt(r*r+a*a+e*e)}function M(t,n){var r=n[0]-t[0],a=n[1]-t[1],e=n[2]-t[2];return r*r+a*a+e*e}function h(t){var n=t[0],r=t[1],a=t[2];return n*n+r*r+a*a}function l(t,n){var r=n[0],a=n[1],e=n[2],u=r*r+a*a+e*e;return u>0&&(u=1/Math.sqrt(u),t[0]=n[0]*u,t[1]=n[1]*u,t[2]=n[2]*u),t}function v(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}n.sub=i,n.mul=s,n.div=c,n.dist=f,n.sqrDist=M,n.len=u,n.sqrLen=h,n.forEach=function(){var t=e();return function(n,r,a,e,u,o){var i=void 0,s=void 0;for(r||(r=3),a||(a=0),s=e?Math.min(e*r+a,n.length):n.length,i=a;i<s;i+=r)t[0]=n[i],t[1]=n[i+1],t[2]=n[i+2],u(t,t,o),n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2];return n}}()},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.setAxes=n.sqlerp=n.rotationTo=n.equals=n.exactEquals=n.normalize=n.sqrLen=n.squaredLength=n.len=n.length=n.lerp=n.dot=n.scale=n.mul=n.add=n.set=n.copy=n.fromValues=n.clone=void 0,n.create=s,n.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},n.setAxisAngle=c,n.getAxisAngle=function(t,n){var r=2*Math.acos(n[3]),e=Math.sin(r/2);e>a.EPSILON?(t[0]=n[0]/e,t[1]=n[1]/e,t[2]=n[2]/e):(t[0]=1,t[1]=0,t[2]=0);return r},n.multiply=f,n.rotateX=function(t,n,r){r*=.5;var a=n[0],e=n[1],u=n[2],o=n[3],i=Math.sin(r),s=Math.cos(r);return t[0]=a*s+o*i,t[1]=e*s+u*i,t[2]=u*s-e*i,t[3]=o*s-a*i,t},n.rotateY=function(t,n,r){r*=.5;var a=n[0],e=n[1],u=n[2],o=n[3],i=Math.sin(r),s=Math.cos(r);return t[0]=a*s-u*i,t[1]=e*s+o*i,t[2]=u*s+a*i,t[3]=o*s-e*i,t},n.rotateZ=function(t,n,r){r*=.5;var a=n[0],e=n[1],u=n[2],o=n[3],i=Math.sin(r),s=Math.cos(r);return t[0]=a*s+e*i,t[1]=e*s-a*i,t[2]=u*s+o*i,t[3]=o*s-u*i,t},n.calculateW=function(t,n){var r=n[0],a=n[1],e=n[2];return t[0]=r,t[1]=a,t[2]=e,t[3]=Math.sqrt(Math.abs(1-r*r-a*a-e*e)),t},n.slerp=M,n.random=function(t){var n=a.RANDOM(),r=a.RANDOM(),e=a.RANDOM(),u=Math.sqrt(1-n),o=Math.sqrt(n);return t[0]=u*Math.sin(2*Math.PI*r),t[1]=u*Math.cos(2*Math.PI*r),t[2]=o*Math.sin(2*Math.PI*e),t[3]=o*Math.cos(2*Math.PI*e),t},n.invert=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=r*r+a*a+e*e+u*u,i=o?1/o:0;return t[0]=-r*i,t[1]=-a*i,t[2]=-e*i,t[3]=u*i,t},n.conjugate=function(t,n){return t[0]=-n[0],t[1]=-n[1],t[2]=-n[2],t[3]=n[3],t},n.fromMat3=h,n.fromEuler=function(t,n,r,a){var e=.5*Math.PI/180;n*=e,r*=e,a*=e;var u=Math.sin(n),o=Math.cos(n),i=Math.sin(r),s=Math.cos(r),c=Math.sin(a),f=Math.cos(a);return t[0]=u*s*f-o*i*c,t[1]=o*i*f+u*s*c,t[2]=o*s*c-u*i*f,t[3]=o*s*f+u*i*c,t},n.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"};var a=i(r(0)),e=i(r(5)),u=i(r(2)),o=i(r(1));function i(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}function s(){var t=new a.ARRAY_TYPE(4);return a.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function c(t,n,r){r*=.5;var a=Math.sin(r);return t[0]=a*n[0],t[1]=a*n[1],t[2]=a*n[2],t[3]=Math.cos(r),t}function f(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=r[0],s=r[1],c=r[2],f=r[3];return t[0]=a*f+o*i+e*c-u*s,t[1]=e*f+o*s+u*i-a*c,t[2]=u*f+o*c+a*s-e*i,t[3]=o*f-a*i-e*s-u*c,t}function M(t,n,r,e){var u=n[0],o=n[1],i=n[2],s=n[3],c=r[0],f=r[1],M=r[2],h=r[3],l=void 0,v=void 0,d=void 0,b=void 0,m=void 0;return(v=u*c+o*f+i*M+s*h)<0&&(v=-v,c=-c,f=-f,M=-M,h=-h),1-v>a.EPSILON?(l=Math.acos(v),d=Math.sin(l),b=Math.sin((1-e)*l)/d,m=Math.sin(e*l)/d):(b=1-e,m=e),t[0]=b*u+m*c,t[1]=b*o+m*f,t[2]=b*i+m*M,t[3]=b*s+m*h,t}function h(t,n){var r=n[0]+n[4]+n[8],a=void 0;if(r>0)a=Math.sqrt(r+1),t[3]=.5*a,a=.5/a,t[0]=(n[5]-n[7])*a,t[1]=(n[6]-n[2])*a,t[2]=(n[1]-n[3])*a;else{var e=0;n[4]>n[0]&&(e=1),n[8]>n[3*e+e]&&(e=2);var u=(e+1)%3,o=(e+2)%3;a=Math.sqrt(n[3*e+e]-n[3*u+u]-n[3*o+o]+1),t[e]=.5*a,a=.5/a,t[3]=(n[3*u+o]-n[3*o+u])*a,t[u]=(n[3*u+e]+n[3*e+u])*a,t[o]=(n[3*o+e]+n[3*e+o])*a}return t}n.clone=o.clone,n.fromValues=o.fromValues,n.copy=o.copy,n.set=o.set,n.add=o.add,n.mul=f,n.scale=o.scale,n.dot=o.dot,n.lerp=o.lerp;var l=n.length=o.length,v=(n.len=l,n.squaredLength=o.squaredLength),d=(n.sqrLen=v,n.normalize=o.normalize);n.exactEquals=o.exactEquals,n.equals=o.equals,n.rotationTo=function(){var t=u.create(),n=u.fromValues(1,0,0),r=u.fromValues(0,1,0);return function(a,e,o){var i=u.dot(e,o);return i<-.999999?(u.cross(t,n,e),u.len(t)<1e-6&&u.cross(t,r,e),u.normalize(t,t),c(a,t,Math.PI),a):i>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(u.cross(t,e,o),a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=1+i,d(a,a))}}(),n.sqlerp=function(){var t=s(),n=s();return function(r,a,e,u,o,i){return M(t,a,o,i),M(n,e,u,i),M(r,t,n,2*i*(1-i)),r}}(),n.setAxes=function(){var t=e.create();return function(n,r,a,e){return t[0]=a[0],t[3]=a[1],t[6]=a[2],t[1]=e[0],t[4]=e[1],t[7]=e[2],t[2]=-r[0],t[5]=-r[1],t[8]=-r[2],d(n,h(n,t))}}()},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sub=n.mul=void 0,n.create=function(){var t=new a.ARRAY_TYPE(16);a.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},n.clone=function(t){var n=new a.ARRAY_TYPE(16);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n},n.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t},n.fromValues=function(t,n,r,e,u,o,i,s,c,f,M,h,l,v,d,b){var m=new a.ARRAY_TYPE(16);return m[0]=t,m[1]=n,m[2]=r,m[3]=e,m[4]=u,m[5]=o,m[6]=i,m[7]=s,m[8]=c,m[9]=f,m[10]=M,m[11]=h,m[12]=l,m[13]=v,m[14]=d,m[15]=b,m},n.set=function(t,n,r,a,e,u,o,i,s,c,f,M,h,l,v,d,b){return t[0]=n,t[1]=r,t[2]=a,t[3]=e,t[4]=u,t[5]=o,t[6]=i,t[7]=s,t[8]=c,t[9]=f,t[10]=M,t[11]=h,t[12]=l,t[13]=v,t[14]=d,t[15]=b,t},n.identity=e,n.transpose=function(t,n){if(t===n){var r=n[1],a=n[2],e=n[3],u=n[6],o=n[7],i=n[11];t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=r,t[6]=n[9],t[7]=n[13],t[8]=a,t[9]=u,t[11]=n[14],t[12]=e,t[13]=o,t[14]=i}else t[0]=n[0],t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=n[1],t[5]=n[5],t[6]=n[9],t[7]=n[13],t[8]=n[2],t[9]=n[6],t[10]=n[10],t[11]=n[14],t[12]=n[3],t[13]=n[7],t[14]=n[11],t[15]=n[15];return t},n.invert=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=n[4],i=n[5],s=n[6],c=n[7],f=n[8],M=n[9],h=n[10],l=n[11],v=n[12],d=n[13],b=n[14],m=n[15],p=r*i-a*o,P=r*s-e*o,A=r*c-u*o,E=a*s-e*i,O=a*c-u*i,R=e*c-u*s,y=f*d-M*v,q=f*b-h*v,x=f*m-l*v,_=M*b-h*d,Y=M*m-l*d,L=h*m-l*b,S=p*L-P*Y+A*_+E*x-O*q+R*y;if(!S)return null;return S=1/S,t[0]=(i*L-s*Y+c*_)*S,t[1]=(e*Y-a*L-u*_)*S,t[2]=(d*R-b*O+m*E)*S,t[3]=(h*O-M*R-l*E)*S,t[4]=(s*x-o*L-c*q)*S,t[5]=(r*L-e*x+u*q)*S,t[6]=(b*A-v*R-m*P)*S,t[7]=(f*R-h*A+l*P)*S,t[8]=(o*Y-i*x+c*y)*S,t[9]=(a*x-r*Y-u*y)*S,t[10]=(v*O-d*A+m*p)*S,t[11]=(M*A-f*O-l*p)*S,t[12]=(i*q-o*_-s*y)*S,t[13]=(r*_-a*q+e*y)*S,t[14]=(d*P-v*E-b*p)*S,t[15]=(f*E-M*P+h*p)*S,t},n.adjoint=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=n[4],i=n[5],s=n[6],c=n[7],f=n[8],M=n[9],h=n[10],l=n[11],v=n[12],d=n[13],b=n[14],m=n[15];return t[0]=i*(h*m-l*b)-M*(s*m-c*b)+d*(s*l-c*h),t[1]=-(a*(h*m-l*b)-M*(e*m-u*b)+d*(e*l-u*h)),t[2]=a*(s*m-c*b)-i*(e*m-u*b)+d*(e*c-u*s),t[3]=-(a*(s*l-c*h)-i*(e*l-u*h)+M*(e*c-u*s)),t[4]=-(o*(h*m-l*b)-f*(s*m-c*b)+v*(s*l-c*h)),t[5]=r*(h*m-l*b)-f*(e*m-u*b)+v*(e*l-u*h),t[6]=-(r*(s*m-c*b)-o*(e*m-u*b)+v*(e*c-u*s)),t[7]=r*(s*l-c*h)-o*(e*l-u*h)+f*(e*c-u*s),t[8]=o*(M*m-l*d)-f*(i*m-c*d)+v*(i*l-c*M),t[9]=-(r*(M*m-l*d)-f*(a*m-u*d)+v*(a*l-u*M)),t[10]=r*(i*m-c*d)-o*(a*m-u*d)+v*(a*c-u*i),t[11]=-(r*(i*l-c*M)-o*(a*l-u*M)+f*(a*c-u*i)),t[12]=-(o*(M*b-h*d)-f*(i*b-s*d)+v*(i*h-s*M)),t[13]=r*(M*b-h*d)-f*(a*b-e*d)+v*(a*h-e*M),t[14]=-(r*(i*b-s*d)-o*(a*b-e*d)+v*(a*s-e*i)),t[15]=r*(i*h-s*M)-o*(a*h-e*M)+f*(a*s-e*i),t},n.determinant=function(t){var n=t[0],r=t[1],a=t[2],e=t[3],u=t[4],o=t[5],i=t[6],s=t[7],c=t[8],f=t[9],M=t[10],h=t[11],l=t[12],v=t[13],d=t[14],b=t[15];return(n*o-r*u)*(M*b-h*d)-(n*i-a*u)*(f*b-h*v)+(n*s-e*u)*(f*d-M*v)+(r*i-a*o)*(c*b-h*l)-(r*s-e*o)*(c*d-M*l)+(a*s-e*i)*(c*v-f*l)},n.multiply=u,n.translate=function(t,n,r){var a=r[0],e=r[1],u=r[2],o=void 0,i=void 0,s=void 0,c=void 0,f=void 0,M=void 0,h=void 0,l=void 0,v=void 0,d=void 0,b=void 0,m=void 0;n===t?(t[12]=n[0]*a+n[4]*e+n[8]*u+n[12],t[13]=n[1]*a+n[5]*e+n[9]*u+n[13],t[14]=n[2]*a+n[6]*e+n[10]*u+n[14],t[15]=n[3]*a+n[7]*e+n[11]*u+n[15]):(o=n[0],i=n[1],s=n[2],c=n[3],f=n[4],M=n[5],h=n[6],l=n[7],v=n[8],d=n[9],b=n[10],m=n[11],t[0]=o,t[1]=i,t[2]=s,t[3]=c,t[4]=f,t[5]=M,t[6]=h,t[7]=l,t[8]=v,t[9]=d,t[10]=b,t[11]=m,t[12]=o*a+f*e+v*u+n[12],t[13]=i*a+M*e+d*u+n[13],t[14]=s*a+h*e+b*u+n[14],t[15]=c*a+l*e+m*u+n[15]);return t},n.scale=function(t,n,r){var a=r[0],e=r[1],u=r[2];return t[0]=n[0]*a,t[1]=n[1]*a,t[2]=n[2]*a,t[3]=n[3]*a,t[4]=n[4]*e,t[5]=n[5]*e,t[6]=n[6]*e,t[7]=n[7]*e,t[8]=n[8]*u,t[9]=n[9]*u,t[10]=n[10]*u,t[11]=n[11]*u,t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t},n.rotate=function(t,n,r,e){var u=e[0],o=e[1],i=e[2],s=Math.sqrt(u*u+o*o+i*i),c=void 0,f=void 0,M=void 0,h=void 0,l=void 0,v=void 0,d=void 0,b=void 0,m=void 0,p=void 0,P=void 0,A=void 0,E=void 0,O=void 0,R=void 0,y=void 0,q=void 0,x=void 0,_=void 0,Y=void 0,L=void 0,S=void 0,w=void 0,I=void 0;if(s<a.EPSILON)return null;u*=s=1/s,o*=s,i*=s,c=Math.sin(r),f=Math.cos(r),M=1-f,h=n[0],l=n[1],v=n[2],d=n[3],b=n[4],m=n[5],p=n[6],P=n[7],A=n[8],E=n[9],O=n[10],R=n[11],y=u*u*M+f,q=o*u*M+i*c,x=i*u*M-o*c,_=u*o*M-i*c,Y=o*o*M+f,L=i*o*M+u*c,S=u*i*M+o*c,w=o*i*M-u*c,I=i*i*M+f,t[0]=h*y+b*q+A*x,t[1]=l*y+m*q+E*x,t[2]=v*y+p*q+O*x,t[3]=d*y+P*q+R*x,t[4]=h*_+b*Y+A*L,t[5]=l*_+m*Y+E*L,t[6]=v*_+p*Y+O*L,t[7]=d*_+P*Y+R*L,t[8]=h*S+b*w+A*I,t[9]=l*S+m*w+E*I,t[10]=v*S+p*w+O*I,t[11]=d*S+P*w+R*I,n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]);return t},n.rotateX=function(t,n,r){var a=Math.sin(r),e=Math.cos(r),u=n[4],o=n[5],i=n[6],s=n[7],c=n[8],f=n[9],M=n[10],h=n[11];n!==t&&(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]);return t[4]=u*e+c*a,t[5]=o*e+f*a,t[6]=i*e+M*a,t[7]=s*e+h*a,t[8]=c*e-u*a,t[9]=f*e-o*a,t[10]=M*e-i*a,t[11]=h*e-s*a,t},n.rotateY=function(t,n,r){var a=Math.sin(r),e=Math.cos(r),u=n[0],o=n[1],i=n[2],s=n[3],c=n[8],f=n[9],M=n[10],h=n[11];n!==t&&(t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]);return t[0]=u*e-c*a,t[1]=o*e-f*a,t[2]=i*e-M*a,t[3]=s*e-h*a,t[8]=u*a+c*e,t[9]=o*a+f*e,t[10]=i*a+M*e,t[11]=s*a+h*e,t},n.rotateZ=function(t,n,r){var a=Math.sin(r),e=Math.cos(r),u=n[0],o=n[1],i=n[2],s=n[3],c=n[4],f=n[5],M=n[6],h=n[7];n!==t&&(t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]);return t[0]=u*e+c*a,t[1]=o*e+f*a,t[2]=i*e+M*a,t[3]=s*e+h*a,t[4]=c*e-u*a,t[5]=f*e-o*a,t[6]=M*e-i*a,t[7]=h*e-s*a,t},n.fromTranslation=function(t,n){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t},n.fromScaling=function(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=n[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.fromRotation=function(t,n,r){var e=r[0],u=r[1],o=r[2],i=Math.sqrt(e*e+u*u+o*o),s=void 0,c=void 0,f=void 0;if(i<a.EPSILON)return null;return e*=i=1/i,u*=i,o*=i,s=Math.sin(n),c=Math.cos(n),f=1-c,t[0]=e*e*f+c,t[1]=u*e*f+o*s,t[2]=o*e*f-u*s,t[3]=0,t[4]=e*u*f-o*s,t[5]=u*u*f+c,t[6]=o*u*f+e*s,t[7]=0,t[8]=e*o*f+u*s,t[9]=u*o*f-e*s,t[10]=o*o*f+c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.fromXRotation=function(t,n){var r=Math.sin(n),a=Math.cos(n);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.fromYRotation=function(t,n){var r=Math.sin(n),a=Math.cos(n);return t[0]=a,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.fromZRotation=function(t,n){var r=Math.sin(n),a=Math.cos(n);return t[0]=a,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.fromRotationTranslation=o,n.fromQuat2=function(t,n){var r=new a.ARRAY_TYPE(3),e=-n[0],u=-n[1],i=-n[2],s=n[3],c=n[4],f=n[5],M=n[6],h=n[7],l=e*e+u*u+i*i+s*s;l>0?(r[0]=2*(c*s+h*e+f*i-M*u)/l,r[1]=2*(f*s+h*u+M*e-c*i)/l,r[2]=2*(M*s+h*i+c*u-f*e)/l):(r[0]=2*(c*s+h*e+f*i-M*u),r[1]=2*(f*s+h*u+M*e-c*i),r[2]=2*(M*s+h*i+c*u-f*e));return o(t,n,r),t},n.getTranslation=function(t,n){return t[0]=n[12],t[1]=n[13],t[2]=n[14],t},n.getScaling=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[4],o=n[5],i=n[6],s=n[8],c=n[9],f=n[10];return t[0]=Math.sqrt(r*r+a*a+e*e),t[1]=Math.sqrt(u*u+o*o+i*i),t[2]=Math.sqrt(s*s+c*c+f*f),t},n.getRotation=function(t,n){var r=n[0]+n[5]+n[10],a=0;r>0?(a=2*Math.sqrt(r+1),t[3]=.25*a,t[0]=(n[6]-n[9])/a,t[1]=(n[8]-n[2])/a,t[2]=(n[1]-n[4])/a):n[0]>n[5]&&n[0]>n[10]?(a=2*Math.sqrt(1+n[0]-n[5]-n[10]),t[3]=(n[6]-n[9])/a,t[0]=.25*a,t[1]=(n[1]+n[4])/a,t[2]=(n[8]+n[2])/a):n[5]>n[10]?(a=2*Math.sqrt(1+n[5]-n[0]-n[10]),t[3]=(n[8]-n[2])/a,t[0]=(n[1]+n[4])/a,t[1]=.25*a,t[2]=(n[6]+n[9])/a):(a=2*Math.sqrt(1+n[10]-n[0]-n[5]),t[3]=(n[1]-n[4])/a,t[0]=(n[8]+n[2])/a,t[1]=(n[6]+n[9])/a,t[2]=.25*a);return t},n.fromRotationTranslationScale=function(t,n,r,a){var e=n[0],u=n[1],o=n[2],i=n[3],s=e+e,c=u+u,f=o+o,M=e*s,h=e*c,l=e*f,v=u*c,d=u*f,b=o*f,m=i*s,p=i*c,P=i*f,A=a[0],E=a[1],O=a[2];return t[0]=(1-(v+b))*A,t[1]=(h+P)*A,t[2]=(l-p)*A,t[3]=0,t[4]=(h-P)*E,t[5]=(1-(M+b))*E,t[6]=(d+m)*E,t[7]=0,t[8]=(l+p)*O,t[9]=(d-m)*O,t[10]=(1-(M+v))*O,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},n.fromRotationTranslationScaleOrigin=function(t,n,r,a,e){var u=n[0],o=n[1],i=n[2],s=n[3],c=u+u,f=o+o,M=i+i,h=u*c,l=u*f,v=u*M,d=o*f,b=o*M,m=i*M,p=s*c,P=s*f,A=s*M,E=a[0],O=a[1],R=a[2],y=e[0],q=e[1],x=e[2],_=(1-(d+m))*E,Y=(l+A)*E,L=(v-P)*E,S=(l-A)*O,w=(1-(h+m))*O,I=(b+p)*O,N=(v+P)*R,g=(b-p)*R,T=(1-(h+d))*R;return t[0]=_,t[1]=Y,t[2]=L,t[3]=0,t[4]=S,t[5]=w,t[6]=I,t[7]=0,t[8]=N,t[9]=g,t[10]=T,t[11]=0,t[12]=r[0]+y-(_*y+S*q+N*x),t[13]=r[1]+q-(Y*y+w*q+g*x),t[14]=r[2]+x-(L*y+I*q+T*x),t[15]=1,t},n.fromQuat=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=r+r,i=a+a,s=e+e,c=r*o,f=a*o,M=a*i,h=e*o,l=e*i,v=e*s,d=u*o,b=u*i,m=u*s;return t[0]=1-M-v,t[1]=f+m,t[2]=h-b,t[3]=0,t[4]=f-m,t[5]=1-c-v,t[6]=l+d,t[7]=0,t[8]=h+b,t[9]=l-d,t[10]=1-c-M,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.frustum=function(t,n,r,a,e,u,o){var i=1/(r-n),s=1/(e-a),c=1/(u-o);return t[0]=2*u*i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*u*s,t[6]=0,t[7]=0,t[8]=(r+n)*i,t[9]=(e+a)*s,t[10]=(o+u)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*u*2*c,t[15]=0,t},n.perspective=function(t,n,r,a,e){var u=1/Math.tan(n/2),o=void 0;t[0]=u/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=e&&e!==1/0?(o=1/(a-e),t[10]=(e+a)*o,t[14]=2*e*a*o):(t[10]=-1,t[14]=-2*a);return t},n.perspectiveFromFieldOfView=function(t,n,r,a){var e=Math.tan(n.upDegrees*Math.PI/180),u=Math.tan(n.downDegrees*Math.PI/180),o=Math.tan(n.leftDegrees*Math.PI/180),i=Math.tan(n.rightDegrees*Math.PI/180),s=2/(o+i),c=2/(e+u);return t[0]=s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(o-i)*s*.5,t[9]=(e-u)*c*.5,t[10]=a/(r-a),t[11]=-1,t[12]=0,t[13]=0,t[14]=a*r/(r-a),t[15]=0,t},n.ortho=function(t,n,r,a,e,u,o){var i=1/(n-r),s=1/(a-e),c=1/(u-o);return t[0]=-2*i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(n+r)*i,t[13]=(e+a)*s,t[14]=(o+u)*c,t[15]=1,t},n.lookAt=function(t,n,r,u){var o=void 0,i=void 0,s=void 0,c=void 0,f=void 0,M=void 0,h=void 0,l=void 0,v=void 0,d=void 0,b=n[0],m=n[1],p=n[2],P=u[0],A=u[1],E=u[2],O=r[0],R=r[1],y=r[2];if(Math.abs(b-O)<a.EPSILON&&Math.abs(m-R)<a.EPSILON&&Math.abs(p-y)<a.EPSILON)return e(t);h=b-O,l=m-R,v=p-y,d=1/Math.sqrt(h*h+l*l+v*v),o=A*(v*=d)-E*(l*=d),i=E*(h*=d)-P*v,s=P*l-A*h,(d=Math.sqrt(o*o+i*i+s*s))?(o*=d=1/d,i*=d,s*=d):(o=0,i=0,s=0);c=l*s-v*i,f=v*o-h*s,M=h*i-l*o,(d=Math.sqrt(c*c+f*f+M*M))?(c*=d=1/d,f*=d,M*=d):(c=0,f=0,M=0);return t[0]=o,t[1]=c,t[2]=h,t[3]=0,t[4]=i,t[5]=f,t[6]=l,t[7]=0,t[8]=s,t[9]=M,t[10]=v,t[11]=0,t[12]=-(o*b+i*m+s*p),t[13]=-(c*b+f*m+M*p),t[14]=-(h*b+l*m+v*p),t[15]=1,t},n.targetTo=function(t,n,r,a){var e=n[0],u=n[1],o=n[2],i=a[0],s=a[1],c=a[2],f=e-r[0],M=u-r[1],h=o-r[2],l=f*f+M*M+h*h;l>0&&(l=1/Math.sqrt(l),f*=l,M*=l,h*=l);var v=s*h-c*M,d=c*f-i*h,b=i*M-s*f;(l=v*v+d*d+b*b)>0&&(l=1/Math.sqrt(l),v*=l,d*=l,b*=l);return t[0]=v,t[1]=d,t[2]=b,t[3]=0,t[4]=M*b-h*d,t[5]=h*v-f*b,t[6]=f*d-M*v,t[7]=0,t[8]=f,t[9]=M,t[10]=h,t[11]=0,t[12]=e,t[13]=u,t[14]=o,t[15]=1,t},n.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},n.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t[4]=n[4]+r[4],t[5]=n[5]+r[5],t[6]=n[6]+r[6],t[7]=n[7]+r[7],t[8]=n[8]+r[8],t[9]=n[9]+r[9],t[10]=n[10]+r[10],t[11]=n[11]+r[11],t[12]=n[12]+r[12],t[13]=n[13]+r[13],t[14]=n[14]+r[14],t[15]=n[15]+r[15],t},n.subtract=i,n.multiplyScalar=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=n[7]*r,t[8]=n[8]*r,t[9]=n[9]*r,t[10]=n[10]*r,t[11]=n[11]*r,t[12]=n[12]*r,t[13]=n[13]*r,t[14]=n[14]*r,t[15]=n[15]*r,t},n.multiplyScalarAndAdd=function(t,n,r,a){return t[0]=n[0]+r[0]*a,t[1]=n[1]+r[1]*a,t[2]=n[2]+r[2]*a,t[3]=n[3]+r[3]*a,t[4]=n[4]+r[4]*a,t[5]=n[5]+r[5]*a,t[6]=n[6]+r[6]*a,t[7]=n[7]+r[7]*a,t[8]=n[8]+r[8]*a,t[9]=n[9]+r[9]*a,t[10]=n[10]+r[10]*a,t[11]=n[11]+r[11]*a,t[12]=n[12]+r[12]*a,t[13]=n[13]+r[13]*a,t[14]=n[14]+r[14]*a,t[15]=n[15]+r[15]*a,t},n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]&&t[6]===n[6]&&t[7]===n[7]&&t[8]===n[8]&&t[9]===n[9]&&t[10]===n[10]&&t[11]===n[11]&&t[12]===n[12]&&t[13]===n[13]&&t[14]===n[14]&&t[15]===n[15]},n.equals=function(t,n){var r=t[0],e=t[1],u=t[2],o=t[3],i=t[4],s=t[5],c=t[6],f=t[7],M=t[8],h=t[9],l=t[10],v=t[11],d=t[12],b=t[13],m=t[14],p=t[15],P=n[0],A=n[1],E=n[2],O=n[3],R=n[4],y=n[5],q=n[6],x=n[7],_=n[8],Y=n[9],L=n[10],S=n[11],w=n[12],I=n[13],N=n[14],g=n[15];return Math.abs(r-P)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(P))&&Math.abs(e-A)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(A))&&Math.abs(u-E)<=a.EPSILON*Math.max(1,Math.abs(u),Math.abs(E))&&Math.abs(o-O)<=a.EPSILON*Math.max(1,Math.abs(o),Math.abs(O))&&Math.abs(i-R)<=a.EPSILON*Math.max(1,Math.abs(i),Math.abs(R))&&Math.abs(s-y)<=a.EPSILON*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(c-q)<=a.EPSILON*Math.max(1,Math.abs(c),Math.abs(q))&&Math.abs(f-x)<=a.EPSILON*Math.max(1,Math.abs(f),Math.abs(x))&&Math.abs(M-_)<=a.EPSILON*Math.max(1,Math.abs(M),Math.abs(_))&&Math.abs(h-Y)<=a.EPSILON*Math.max(1,Math.abs(h),Math.abs(Y))&&Math.abs(l-L)<=a.EPSILON*Math.max(1,Math.abs(l),Math.abs(L))&&Math.abs(v-S)<=a.EPSILON*Math.max(1,Math.abs(v),Math.abs(S))&&Math.abs(d-w)<=a.EPSILON*Math.max(1,Math.abs(d),Math.abs(w))&&Math.abs(b-I)<=a.EPSILON*Math.max(1,Math.abs(b),Math.abs(I))&&Math.abs(m-N)<=a.EPSILON*Math.max(1,Math.abs(m),Math.abs(N))&&Math.abs(p-g)<=a.EPSILON*Math.max(1,Math.abs(p),Math.abs(g))};var a=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}(r(0));function e(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function u(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=n[6],f=n[7],M=n[8],h=n[9],l=n[10],v=n[11],d=n[12],b=n[13],m=n[14],p=n[15],P=r[0],A=r[1],E=r[2],O=r[3];return t[0]=P*a+A*i+E*M+O*d,t[1]=P*e+A*s+E*h+O*b,t[2]=P*u+A*c+E*l+O*m,t[3]=P*o+A*f+E*v+O*p,P=r[4],A=r[5],E=r[6],O=r[7],t[4]=P*a+A*i+E*M+O*d,t[5]=P*e+A*s+E*h+O*b,t[6]=P*u+A*c+E*l+O*m,t[7]=P*o+A*f+E*v+O*p,P=r[8],A=r[9],E=r[10],O=r[11],t[8]=P*a+A*i+E*M+O*d,t[9]=P*e+A*s+E*h+O*b,t[10]=P*u+A*c+E*l+O*m,t[11]=P*o+A*f+E*v+O*p,P=r[12],A=r[13],E=r[14],O=r[15],t[12]=P*a+A*i+E*M+O*d,t[13]=P*e+A*s+E*h+O*b,t[14]=P*u+A*c+E*l+O*m,t[15]=P*o+A*f+E*v+O*p,t}function o(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=a+a,s=e+e,c=u+u,f=a*i,M=a*s,h=a*c,l=e*s,v=e*c,d=u*c,b=o*i,m=o*s,p=o*c;return t[0]=1-(l+d),t[1]=M+p,t[2]=h-m,t[3]=0,t[4]=M-p,t[5]=1-(f+d),t[6]=v+b,t[7]=0,t[8]=h+m,t[9]=v-b,t[10]=1-(f+l),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function i(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t[3]=n[3]-r[3],t[4]=n[4]-r[4],t[5]=n[5]-r[5],t[6]=n[6]-r[6],t[7]=n[7]-r[7],t[8]=n[8]-r[8],t[9]=n[9]-r[9],t[10]=n[10]-r[10],t[11]=n[11]-r[11],t[12]=n[12]-r[12],t[13]=n[13]-r[13],t[14]=n[14]-r[14],t[15]=n[15]-r[15],t}n.mul=u,n.sub=i},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sub=n.mul=void 0,n.create=function(){var t=new a.ARRAY_TYPE(9);a.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0);return t[0]=1,t[4]=1,t[8]=1,t},n.fromMat4=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[4],t[4]=n[5],t[5]=n[6],t[6]=n[8],t[7]=n[9],t[8]=n[10],t},n.clone=function(t){var n=new a.ARRAY_TYPE(9);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n},n.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t},n.fromValues=function(t,n,r,e,u,o,i,s,c){var f=new a.ARRAY_TYPE(9);return f[0]=t,f[1]=n,f[2]=r,f[3]=e,f[4]=u,f[5]=o,f[6]=i,f[7]=s,f[8]=c,f},n.set=function(t,n,r,a,e,u,o,i,s,c){return t[0]=n,t[1]=r,t[2]=a,t[3]=e,t[4]=u,t[5]=o,t[6]=i,t[7]=s,t[8]=c,t},n.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},n.transpose=function(t,n){if(t===n){var r=n[1],a=n[2],e=n[5];t[1]=n[3],t[2]=n[6],t[3]=r,t[5]=n[7],t[6]=a,t[7]=e}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8];return t},n.invert=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=n[4],i=n[5],s=n[6],c=n[7],f=n[8],M=f*o-i*c,h=-f*u+i*s,l=c*u-o*s,v=r*M+a*h+e*l;if(!v)return null;return v=1/v,t[0]=M*v,t[1]=(-f*a+e*c)*v,t[2]=(i*a-e*o)*v,t[3]=h*v,t[4]=(f*r-e*s)*v,t[5]=(-i*r+e*u)*v,t[6]=l*v,t[7]=(-c*r+a*s)*v,t[8]=(o*r-a*u)*v,t},n.adjoint=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=n[4],i=n[5],s=n[6],c=n[7],f=n[8];return t[0]=o*f-i*c,t[1]=e*c-a*f,t[2]=a*i-e*o,t[3]=i*s-u*f,t[4]=r*f-e*s,t[5]=e*u-r*i,t[6]=u*c-o*s,t[7]=a*s-r*c,t[8]=r*o-a*u,t},n.determinant=function(t){var n=t[0],r=t[1],a=t[2],e=t[3],u=t[4],o=t[5],i=t[6],s=t[7],c=t[8];return n*(c*u-o*s)+r*(-c*e+o*i)+a*(s*e-u*i)},n.multiply=e,n.translate=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=n[6],f=n[7],M=n[8],h=r[0],l=r[1];return t[0]=a,t[1]=e,t[2]=u,t[3]=o,t[4]=i,t[5]=s,t[6]=h*a+l*o+c,t[7]=h*e+l*i+f,t[8]=h*u+l*s+M,t},n.rotate=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=n[6],f=n[7],M=n[8],h=Math.sin(r),l=Math.cos(r);return t[0]=l*a+h*o,t[1]=l*e+h*i,t[2]=l*u+h*s,t[3]=l*o-h*a,t[4]=l*i-h*e,t[5]=l*s-h*u,t[6]=c,t[7]=f,t[8]=M,t},n.scale=function(t,n,r){var a=r[0],e=r[1];return t[0]=a*n[0],t[1]=a*n[1],t[2]=a*n[2],t[3]=e*n[3],t[4]=e*n[4],t[5]=e*n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t},n.fromTranslation=function(t,n){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=n[0],t[7]=n[1],t[8]=1,t},n.fromRotation=function(t,n){var r=Math.sin(n),a=Math.cos(n);return t[0]=a,t[1]=r,t[2]=0,t[3]=-r,t[4]=a,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},n.fromScaling=function(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=0,t[4]=n[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},n.fromMat2d=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=0,t[3]=n[2],t[4]=n[3],t[5]=0,t[6]=n[4],t[7]=n[5],t[8]=1,t},n.fromQuat=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=r+r,i=a+a,s=e+e,c=r*o,f=a*o,M=a*i,h=e*o,l=e*i,v=e*s,d=u*o,b=u*i,m=u*s;return t[0]=1-M-v,t[3]=f-m,t[6]=h+b,t[1]=f+m,t[4]=1-c-v,t[7]=l-d,t[2]=h-b,t[5]=l+d,t[8]=1-c-M,t},n.normalFromMat4=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=n[4],i=n[5],s=n[6],c=n[7],f=n[8],M=n[9],h=n[10],l=n[11],v=n[12],d=n[13],b=n[14],m=n[15],p=r*i-a*o,P=r*s-e*o,A=r*c-u*o,E=a*s-e*i,O=a*c-u*i,R=e*c-u*s,y=f*d-M*v,q=f*b-h*v,x=f*m-l*v,_=M*b-h*d,Y=M*m-l*d,L=h*m-l*b,S=p*L-P*Y+A*_+E*x-O*q+R*y;if(!S)return null;return S=1/S,t[0]=(i*L-s*Y+c*_)*S,t[1]=(s*x-o*L-c*q)*S,t[2]=(o*Y-i*x+c*y)*S,t[3]=(e*Y-a*L-u*_)*S,t[4]=(r*L-e*x+u*q)*S,t[5]=(a*x-r*Y-u*y)*S,t[6]=(d*R-b*O+m*E)*S,t[7]=(b*A-v*R-m*P)*S,t[8]=(v*O-d*A+m*p)*S,t},n.projection=function(t,n,r){return t[0]=2/n,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},n.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},n.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t[4]=n[4]+r[4],t[5]=n[5]+r[5],t[6]=n[6]+r[6],t[7]=n[7]+r[7],t[8]=n[8]+r[8],t},n.subtract=u,n.multiplyScalar=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=n[7]*r,t[8]=n[8]*r,t},n.multiplyScalarAndAdd=function(t,n,r,a){return t[0]=n[0]+r[0]*a,t[1]=n[1]+r[1]*a,t[2]=n[2]+r[2]*a,t[3]=n[3]+r[3]*a,t[4]=n[4]+r[4]*a,t[5]=n[5]+r[5]*a,t[6]=n[6]+r[6]*a,t[7]=n[7]+r[7]*a,t[8]=n[8]+r[8]*a,t},n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]&&t[6]===n[6]&&t[7]===n[7]&&t[8]===n[8]},n.equals=function(t,n){var r=t[0],e=t[1],u=t[2],o=t[3],i=t[4],s=t[5],c=t[6],f=t[7],M=t[8],h=n[0],l=n[1],v=n[2],d=n[3],b=n[4],m=n[5],p=n[6],P=n[7],A=n[8];return Math.abs(r-h)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(e-l)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(l))&&Math.abs(u-v)<=a.EPSILON*Math.max(1,Math.abs(u),Math.abs(v))&&Math.abs(o-d)<=a.EPSILON*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(i-b)<=a.EPSILON*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(s-m)<=a.EPSILON*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(c-p)<=a.EPSILON*Math.max(1,Math.abs(c),Math.abs(p))&&Math.abs(f-P)<=a.EPSILON*Math.max(1,Math.abs(f),Math.abs(P))&&Math.abs(M-A)<=a.EPSILON*Math.max(1,Math.abs(M),Math.abs(A))};var a=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}(r(0));function e(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=n[6],f=n[7],M=n[8],h=r[0],l=r[1],v=r[2],d=r[3],b=r[4],m=r[5],p=r[6],P=r[7],A=r[8];return t[0]=h*a+l*o+v*c,t[1]=h*e+l*i+v*f,t[2]=h*u+l*s+v*M,t[3]=d*a+b*o+m*c,t[4]=d*e+b*i+m*f,t[5]=d*u+b*s+m*M,t[6]=p*a+P*o+A*c,t[7]=p*e+P*i+A*f,t[8]=p*u+P*s+A*M,t}function u(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t[3]=n[3]-r[3],t[4]=n[4]-r[4],t[5]=n[5]-r[5],t[6]=n[6]-r[6],t[7]=n[7]-r[7],t[8]=n[8]-r[8],t}n.mul=e,n.sub=u},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.forEach=n.sqrLen=n.sqrDist=n.dist=n.div=n.mul=n.sub=n.len=void 0,n.create=e,n.clone=function(t){var n=new a.ARRAY_TYPE(2);return n[0]=t[0],n[1]=t[1],n},n.fromValues=function(t,n){var r=new a.ARRAY_TYPE(2);return r[0]=t,r[1]=n,r},n.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t},n.set=function(t,n,r){return t[0]=n,t[1]=r,t},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t},n.subtract=u,n.multiply=o,n.divide=i,n.ceil=function(t,n){return t[0]=Math.ceil(n[0]),t[1]=Math.ceil(n[1]),t},n.floor=function(t,n){return t[0]=Math.floor(n[0]),t[1]=Math.floor(n[1]),t},n.min=function(t,n,r){return t[0]=Math.min(n[0],r[0]),t[1]=Math.min(n[1],r[1]),t},n.max=function(t,n,r){return t[0]=Math.max(n[0],r[0]),t[1]=Math.max(n[1],r[1]),t},n.round=function(t,n){return t[0]=Math.round(n[0]),t[1]=Math.round(n[1]),t},n.scale=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t},n.scaleAndAdd=function(t,n,r,a){return t[0]=n[0]+r[0]*a,t[1]=n[1]+r[1]*a,t},n.distance=s,n.squaredDistance=c,n.length=f,n.squaredLength=M,n.negate=function(t,n){return t[0]=-n[0],t[1]=-n[1],t},n.inverse=function(t,n){return t[0]=1/n[0],t[1]=1/n[1],t},n.normalize=function(t,n){var r=n[0],a=n[1],e=r*r+a*a;e>0&&(e=1/Math.sqrt(e),t[0]=n[0]*e,t[1]=n[1]*e);return t},n.dot=function(t,n){return t[0]*n[0]+t[1]*n[1]},n.cross=function(t,n,r){var a=n[0]*r[1]-n[1]*r[0];return t[0]=t[1]=0,t[2]=a,t},n.lerp=function(t,n,r,a){var e=n[0],u=n[1];return t[0]=e+a*(r[0]-e),t[1]=u+a*(r[1]-u),t},n.random=function(t,n){n=n||1;var r=2*a.RANDOM()*Math.PI;return t[0]=Math.cos(r)*n,t[1]=Math.sin(r)*n,t},n.transformMat2=function(t,n,r){var a=n[0],e=n[1];return t[0]=r[0]*a+r[2]*e,t[1]=r[1]*a+r[3]*e,t},n.transformMat2d=function(t,n,r){var a=n[0],e=n[1];return t[0]=r[0]*a+r[2]*e+r[4],t[1]=r[1]*a+r[3]*e+r[5],t},n.transformMat3=function(t,n,r){var a=n[0],e=n[1];return t[0]=r[0]*a+r[3]*e+r[6],t[1]=r[1]*a+r[4]*e+r[7],t},n.transformMat4=function(t,n,r){var a=n[0],e=n[1];return t[0]=r[0]*a+r[4]*e+r[12],t[1]=r[1]*a+r[5]*e+r[13],t},n.rotate=function(t,n,r,a){var e=n[0]-r[0],u=n[1]-r[1],o=Math.sin(a),i=Math.cos(a);return t[0]=e*i-u*o+r[0],t[1]=e*o+u*i+r[1],t},n.angle=function(t,n){var r=t[0],a=t[1],e=n[0],u=n[1],o=r*r+a*a;o>0&&(o=1/Math.sqrt(o));var i=e*e+u*u;i>0&&(i=1/Math.sqrt(i));var s=(r*e+a*u)*o*i;return s>1?0:s<-1?Math.PI:Math.acos(s)},n.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]},n.equals=function(t,n){var r=t[0],e=t[1],u=n[0],o=n[1];return Math.abs(r-u)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(e-o)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(o))};var a=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}(r(0));function e(){var t=new a.ARRAY_TYPE(2);return a.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0),t}function u(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t}function o(t,n,r){return t[0]=n[0]*r[0],t[1]=n[1]*r[1],t}function i(t,n,r){return t[0]=n[0]/r[0],t[1]=n[1]/r[1],t}function s(t,n){var r=n[0]-t[0],a=n[1]-t[1];return Math.sqrt(r*r+a*a)}function c(t,n){var r=n[0]-t[0],a=n[1]-t[1];return r*r+a*a}function f(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)}function M(t){var n=t[0],r=t[1];return n*n+r*r}n.len=f,n.sub=u,n.mul=o,n.div=i,n.dist=s,n.sqrDist=c,n.sqrLen=M,n.forEach=function(){var t=e();return function(n,r,a,e,u,o){var i=void 0,s=void 0;for(r||(r=2),a||(a=0),s=e?Math.min(e*r+a,n.length):n.length,i=a;i<s;i+=r)t[0]=n[i],t[1]=n[i+1],u(t,t,o),n[i]=t[0],n[i+1]=t[1];return n}}()},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sqrLen=n.squaredLength=n.len=n.length=n.dot=n.mul=n.setReal=n.getReal=void 0,n.create=function(){var t=new a.ARRAY_TYPE(8);a.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0);return t[3]=1,t},n.clone=function(t){var n=new a.ARRAY_TYPE(8);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n},n.fromValues=function(t,n,r,e,u,o,i,s){var c=new a.ARRAY_TYPE(8);return c[0]=t,c[1]=n,c[2]=r,c[3]=e,c[4]=u,c[5]=o,c[6]=i,c[7]=s,c},n.fromRotationTranslationValues=function(t,n,r,e,u,o,i){var s=new a.ARRAY_TYPE(8);s[0]=t,s[1]=n,s[2]=r,s[3]=e;var c=.5*u,f=.5*o,M=.5*i;return s[4]=c*e+f*r-M*n,s[5]=f*e+M*t-c*r,s[6]=M*e+c*n-f*t,s[7]=-c*t-f*n-M*r,s},n.fromRotationTranslation=i,n.fromTranslation=function(t,n){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*n[0],t[5]=.5*n[1],t[6]=.5*n[2],t[7]=0,t},n.fromRotation=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},n.fromMat4=function(t,n){var r=e.create();u.getRotation(r,n);var o=new a.ARRAY_TYPE(3);return u.getTranslation(o,n),i(t,r,o),t},n.copy=s,n.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},n.set=function(t,n,r,a,e,u,o,i,s){return t[0]=n,t[1]=r,t[2]=a,t[3]=e,t[4]=u,t[5]=o,t[6]=i,t[7]=s,t},n.getDual=function(t,n){return t[0]=n[4],t[1]=n[5],t[2]=n[6],t[3]=n[7],t},n.setDual=function(t,n){return t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3],t},n.getTranslation=function(t,n){var r=n[4],a=n[5],e=n[6],u=n[7],o=-n[0],i=-n[1],s=-n[2],c=n[3];return t[0]=2*(r*c+u*o+a*s-e*i),t[1]=2*(a*c+u*i+e*o-r*s),t[2]=2*(e*c+u*s+r*i-a*o),t},n.translate=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=.5*r[0],s=.5*r[1],c=.5*r[2],f=n[4],M=n[5],h=n[6],l=n[7];return t[0]=a,t[1]=e,t[2]=u,t[3]=o,t[4]=o*i+e*c-u*s+f,t[5]=o*s+u*i-a*c+M,t[6]=o*c+a*s-e*i+h,t[7]=-a*i-e*s-u*c+l,t},n.rotateX=function(t,n,r){var a=-n[0],u=-n[1],o=-n[2],i=n[3],s=n[4],c=n[5],f=n[6],M=n[7],h=s*i+M*a+c*o-f*u,l=c*i+M*u+f*a-s*o,v=f*i+M*o+s*u-c*a,d=M*i-s*a-c*u-f*o;return e.rotateX(t,n,r),a=t[0],u=t[1],o=t[2],i=t[3],t[4]=h*i+d*a+l*o-v*u,t[5]=l*i+d*u+v*a-h*o,t[6]=v*i+d*o+h*u-l*a,t[7]=d*i-h*a-l*u-v*o,t},n.rotateY=function(t,n,r){var a=-n[0],u=-n[1],o=-n[2],i=n[3],s=n[4],c=n[5],f=n[6],M=n[7],h=s*i+M*a+c*o-f*u,l=c*i+M*u+f*a-s*o,v=f*i+M*o+s*u-c*a,d=M*i-s*a-c*u-f*o;return e.rotateY(t,n,r),a=t[0],u=t[1],o=t[2],i=t[3],t[4]=h*i+d*a+l*o-v*u,t[5]=l*i+d*u+v*a-h*o,t[6]=v*i+d*o+h*u-l*a,t[7]=d*i-h*a-l*u-v*o,t},n.rotateZ=function(t,n,r){var a=-n[0],u=-n[1],o=-n[2],i=n[3],s=n[4],c=n[5],f=n[6],M=n[7],h=s*i+M*a+c*o-f*u,l=c*i+M*u+f*a-s*o,v=f*i+M*o+s*u-c*a,d=M*i-s*a-c*u-f*o;return e.rotateZ(t,n,r),a=t[0],u=t[1],o=t[2],i=t[3],t[4]=h*i+d*a+l*o-v*u,t[5]=l*i+d*u+v*a-h*o,t[6]=v*i+d*o+h*u-l*a,t[7]=d*i-h*a-l*u-v*o,t},n.rotateByQuatAppend=function(t,n,r){var a=r[0],e=r[1],u=r[2],o=r[3],i=n[0],s=n[1],c=n[2],f=n[3];return t[0]=i*o+f*a+s*u-c*e,t[1]=s*o+f*e+c*a-i*u,t[2]=c*o+f*u+i*e-s*a,t[3]=f*o-i*a-s*e-c*u,i=n[4],s=n[5],c=n[6],f=n[7],t[4]=i*o+f*a+s*u-c*e,t[5]=s*o+f*e+c*a-i*u,t[6]=c*o+f*u+i*e-s*a,t[7]=f*o-i*a-s*e-c*u,t},n.rotateByQuatPrepend=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=r[0],s=r[1],c=r[2],f=r[3];return t[0]=a*f+o*i+e*c-u*s,t[1]=e*f+o*s+u*i-a*c,t[2]=u*f+o*c+a*s-e*i,t[3]=o*f-a*i-e*s-u*c,i=r[4],s=r[5],c=r[6],f=r[7],t[4]=a*f+o*i+e*c-u*s,t[5]=e*f+o*s+u*i-a*c,t[6]=u*f+o*c+a*s-e*i,t[7]=o*f-a*i-e*s-u*c,t},n.rotateAroundAxis=function(t,n,r,e){if(Math.abs(e)<a.EPSILON)return s(t,n);var u=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);e*=.5;var o=Math.sin(e),i=o*r[0]/u,c=o*r[1]/u,f=o*r[2]/u,M=Math.cos(e),h=n[0],l=n[1],v=n[2],d=n[3];t[0]=h*M+d*i+l*f-v*c,t[1]=l*M+d*c+v*i-h*f,t[2]=v*M+d*f+h*c-l*i,t[3]=d*M-h*i-l*c-v*f;var b=n[4],m=n[5],p=n[6],P=n[7];return t[4]=b*M+P*i+m*f-p*c,t[5]=m*M+P*c+p*i-b*f,t[6]=p*M+P*f+b*c-m*i,t[7]=P*M-b*i-m*c-p*f,t},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t[4]=n[4]+r[4],t[5]=n[5]+r[5],t[6]=n[6]+r[6],t[7]=n[7]+r[7],t},n.multiply=c,n.scale=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=n[7]*r,t},n.lerp=function(t,n,r,a){var e=1-a;f(n,r)<0&&(a=-a);return t[0]=n[0]*e+r[0]*a,t[1]=n[1]*e+r[1]*a,t[2]=n[2]*e+r[2]*a,t[3]=n[3]*e+r[3]*a,t[4]=n[4]*e+r[4]*a,t[5]=n[5]*e+r[5]*a,t[6]=n[6]*e+r[6]*a,t[7]=n[7]*e+r[7]*a,t},n.invert=function(t,n){var r=h(n);return t[0]=-n[0]/r,t[1]=-n[1]/r,t[2]=-n[2]/r,t[3]=n[3]/r,t[4]=-n[4]/r,t[5]=-n[5]/r,t[6]=-n[6]/r,t[7]=n[7]/r,t},n.conjugate=function(t,n){return t[0]=-n[0],t[1]=-n[1],t[2]=-n[2],t[3]=n[3],t[4]=-n[4],t[5]=-n[5],t[6]=-n[6],t[7]=n[7],t},n.normalize=function(t,n){var r=h(n);if(r>0){r=Math.sqrt(r);var a=n[0]/r,e=n[1]/r,u=n[2]/r,o=n[3]/r,i=n[4],s=n[5],c=n[6],f=n[7],M=a*i+e*s+u*c+o*f;t[0]=a,t[1]=e,t[2]=u,t[3]=o,t[4]=(i-a*M)/r,t[5]=(s-e*M)/r,t[6]=(c-u*M)/r,t[7]=(f-o*M)/r}return t},n.str=function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]&&t[6]===n[6]&&t[7]===n[7]},n.equals=function(t,n){var r=t[0],e=t[1],u=t[2],o=t[3],i=t[4],s=t[5],c=t[6],f=t[7],M=n[0],h=n[1],l=n[2],v=n[3],d=n[4],b=n[5],m=n[6],p=n[7];return Math.abs(r-M)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(M))&&Math.abs(e-h)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(h))&&Math.abs(u-l)<=a.EPSILON*Math.max(1,Math.abs(u),Math.abs(l))&&Math.abs(o-v)<=a.EPSILON*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(i-d)<=a.EPSILON*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(s-b)<=a.EPSILON*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(c-m)<=a.EPSILON*Math.max(1,Math.abs(c),Math.abs(m))&&Math.abs(f-p)<=a.EPSILON*Math.max(1,Math.abs(f),Math.abs(p))};var a=o(r(0)),e=o(r(3)),u=o(r(4));function o(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}function i(t,n,r){var a=.5*r[0],e=.5*r[1],u=.5*r[2],o=n[0],i=n[1],s=n[2],c=n[3];return t[0]=o,t[1]=i,t[2]=s,t[3]=c,t[4]=a*c+e*s-u*i,t[5]=e*c+u*o-a*s,t[6]=u*c+a*i-e*o,t[7]=-a*o-e*i-u*s,t}function s(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t}n.getReal=e.copy;n.setReal=e.copy;function c(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=r[4],s=r[5],c=r[6],f=r[7],M=n[4],h=n[5],l=n[6],v=n[7],d=r[0],b=r[1],m=r[2],p=r[3];return t[0]=a*p+o*d+e*m-u*b,t[1]=e*p+o*b+u*d-a*m,t[2]=u*p+o*m+a*b-e*d,t[3]=o*p-a*d-e*b-u*m,t[4]=a*f+o*i+e*c-u*s+M*p+v*d+h*m-l*b,t[5]=e*f+o*s+u*i-a*c+h*p+v*b+l*d-M*m,t[6]=u*f+o*c+a*s-e*i+l*p+v*m+M*b-h*d,t[7]=o*f-a*i-e*s-u*c+v*p-M*d-h*b-l*m,t}n.mul=c;var f=n.dot=e.dot;var M=n.length=e.length,h=(n.len=M,n.squaredLength=e.squaredLength);n.sqrLen=h},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sub=n.mul=void 0,n.create=function(){var t=new a.ARRAY_TYPE(6);a.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0);return t[0]=1,t[3]=1,t},n.clone=function(t){var n=new a.ARRAY_TYPE(6);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n},n.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t},n.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},n.fromValues=function(t,n,r,e,u,o){var i=new a.ARRAY_TYPE(6);return i[0]=t,i[1]=n,i[2]=r,i[3]=e,i[4]=u,i[5]=o,i},n.set=function(t,n,r,a,e,u,o){return t[0]=n,t[1]=r,t[2]=a,t[3]=e,t[4]=u,t[5]=o,t},n.invert=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=n[4],i=n[5],s=r*u-a*e;if(!s)return null;return s=1/s,t[0]=u*s,t[1]=-a*s,t[2]=-e*s,t[3]=r*s,t[4]=(e*i-u*o)*s,t[5]=(a*o-r*i)*s,t},n.determinant=function(t){return t[0]*t[3]-t[1]*t[2]},n.multiply=e,n.rotate=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=Math.sin(r),f=Math.cos(r);return t[0]=a*f+u*c,t[1]=e*f+o*c,t[2]=a*-c+u*f,t[3]=e*-c+o*f,t[4]=i,t[5]=s,t},n.scale=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=r[0],f=r[1];return t[0]=a*c,t[1]=e*c,t[2]=u*f,t[3]=o*f,t[4]=i,t[5]=s,t},n.translate=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=r[0],f=r[1];return t[0]=a,t[1]=e,t[2]=u,t[3]=o,t[4]=a*c+u*f+i,t[5]=e*c+o*f+s,t},n.fromRotation=function(t,n){var r=Math.sin(n),a=Math.cos(n);return t[0]=a,t[1]=r,t[2]=-r,t[3]=a,t[4]=0,t[5]=0,t},n.fromScaling=function(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=n[1],t[4]=0,t[5]=0,t},n.fromTranslation=function(t,n){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=n[0],t[5]=n[1],t},n.str=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},n.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t[4]=n[4]+r[4],t[5]=n[5]+r[5],t},n.subtract=u,n.multiplyScalar=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*r,t[5]=n[5]*r,t},n.multiplyScalarAndAdd=function(t,n,r,a){return t[0]=n[0]+r[0]*a,t[1]=n[1]+r[1]*a,t[2]=n[2]+r[2]*a,t[3]=n[3]+r[3]*a,t[4]=n[4]+r[4]*a,t[5]=n[5]+r[5]*a,t},n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]&&t[4]===n[4]&&t[5]===n[5]},n.equals=function(t,n){var r=t[0],e=t[1],u=t[2],o=t[3],i=t[4],s=t[5],c=n[0],f=n[1],M=n[2],h=n[3],l=n[4],v=n[5];return Math.abs(r-c)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(e-f)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(f))&&Math.abs(u-M)<=a.EPSILON*Math.max(1,Math.abs(u),Math.abs(M))&&Math.abs(o-h)<=a.EPSILON*Math.max(1,Math.abs(o),Math.abs(h))&&Math.abs(i-l)<=a.EPSILON*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-v)<=a.EPSILON*Math.max(1,Math.abs(s),Math.abs(v))};var a=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}(r(0));function e(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=n[4],s=n[5],c=r[0],f=r[1],M=r[2],h=r[3],l=r[4],v=r[5];return t[0]=a*c+u*f,t[1]=e*c+o*f,t[2]=a*M+u*h,t[3]=e*M+o*h,t[4]=a*l+u*v+i,t[5]=e*l+o*v+s,t}function u(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t[3]=n[3]-r[3],t[4]=n[4]-r[4],t[5]=n[5]-r[5],t}n.mul=e,n.sub=u},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sub=n.mul=void 0,n.create=function(){var t=new a.ARRAY_TYPE(4);a.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0);return t[0]=1,t[3]=1,t},n.clone=function(t){var n=new a.ARRAY_TYPE(4);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n},n.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t},n.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},n.fromValues=function(t,n,r,e){var u=new a.ARRAY_TYPE(4);return u[0]=t,u[1]=n,u[2]=r,u[3]=e,u},n.set=function(t,n,r,a,e){return t[0]=n,t[1]=r,t[2]=a,t[3]=e,t},n.transpose=function(t,n){if(t===n){var r=n[1];t[1]=n[2],t[2]=r}else t[0]=n[0],t[1]=n[2],t[2]=n[1],t[3]=n[3];return t},n.invert=function(t,n){var r=n[0],a=n[1],e=n[2],u=n[3],o=r*u-e*a;if(!o)return null;return o=1/o,t[0]=u*o,t[1]=-a*o,t[2]=-e*o,t[3]=r*o,t},n.adjoint=function(t,n){var r=n[0];return t[0]=n[3],t[1]=-n[1],t[2]=-n[2],t[3]=r,t},n.determinant=function(t){return t[0]*t[3]-t[2]*t[1]},n.multiply=e,n.rotate=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=Math.sin(r),s=Math.cos(r);return t[0]=a*s+u*i,t[1]=e*s+o*i,t[2]=a*-i+u*s,t[3]=e*-i+o*s,t},n.scale=function(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=r[0],s=r[1];return t[0]=a*i,t[1]=e*i,t[2]=u*s,t[3]=o*s,t},n.fromRotation=function(t,n){var r=Math.sin(n),a=Math.cos(n);return t[0]=a,t[1]=r,t[2]=-r,t[3]=a,t},n.fromScaling=function(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=n[1],t},n.str=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},n.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},n.LDU=function(t,n,r,a){return t[2]=a[2]/a[0],r[0]=a[0],r[1]=a[1],r[3]=a[3]-t[2]*r[1],[t,n,r]},n.add=function(t,n,r){return t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t[3]=n[3]+r[3],t},n.subtract=u,n.exactEquals=function(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]},n.equals=function(t,n){var r=t[0],e=t[1],u=t[2],o=t[3],i=n[0],s=n[1],c=n[2],f=n[3];return Math.abs(r-i)<=a.EPSILON*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(e-s)<=a.EPSILON*Math.max(1,Math.abs(e),Math.abs(s))&&Math.abs(u-c)<=a.EPSILON*Math.max(1,Math.abs(u),Math.abs(c))&&Math.abs(o-f)<=a.EPSILON*Math.max(1,Math.abs(o),Math.abs(f))},n.multiplyScalar=function(t,n,r){return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t},n.multiplyScalarAndAdd=function(t,n,r,a){return t[0]=n[0]+r[0]*a,t[1]=n[1]+r[1]*a,t[2]=n[2]+r[2]*a,t[3]=n[3]+r[3]*a,t};var a=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}(r(0));function e(t,n,r){var a=n[0],e=n[1],u=n[2],o=n[3],i=r[0],s=r[1],c=r[2],f=r[3];return t[0]=a*i+u*s,t[1]=e*i+o*s,t[2]=a*c+u*f,t[3]=e*c+o*f,t}function u(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t[3]=n[3]-r[3],t}n.mul=e,n.sub=u},function(t,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.vec4=n.vec3=n.vec2=n.quat2=n.quat=n.mat4=n.mat3=n.mat2d=n.mat2=n.glMatrix=void 0;var a=l(r(0)),e=l(r(9)),u=l(r(8)),o=l(r(5)),i=l(r(4)),s=l(r(3)),c=l(r(7)),f=l(r(6)),M=l(r(2)),h=l(r(1));function l(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}n.glMatrix=a,n.mat2=e,n.mat2d=u,n.mat3=o,n.mat4=i,n.quat=s,n.quat2=c,n.vec2=f,n.vec3=M,n.vec4=h}])});'use strict';(function(r){function Y(){return Array.prototype.slice.call(this)}function T(g,e){if(g.constructor===e)return g;if(g.constructor!==Array)return e=e||Float32Array,new e(g);e=e||Float32Array;for(var a=g[0].length,b=new e(g.length*a),c=0;c<g.length;++c)for(var d=0;d<a;++d)b[c*a+d]=g[c][d];return b}function N(g,e,a,b,c){g=g||1024;h.debug&&console.log("GL.Mesh created");null!==c&&(this.gl=c=c||r.gl);this._context_id=c.context_id;this.vertexBuffers={};this.indexBuffers={};this.info={groups:[]};
this._bounding=BBox.create();this.resize(g)}function G(g,e,a,b){this.gl=b=b||r.gl;this._context_id=b.context_id;if(g&&g.constructor!==Array)throw"FBO textures must be an Array";this.handler=null;this.height=this.width=-1;this.color_textures=[];this.depth_texture=null;this.stencil=!!a;this._stencil_enabled=!1;this._num_binded_textures=0;this.order=null;(g&&g.length||e)&&this.setTextures(g,e);this._old_fbo_handler=null;this._old_viewport=new Float32Array(4)}var h=r.GL=r.LiteGL={};if("undefined"==typeof S){if("undefined"==
typeof self)if("undefined"==typeof window){if("undefined"===typeof SKIP_REQUIRES){console.log("importing glMatrix");r.glMatrix=require("./gl-matrix-min.js");var S=r.glMatrix,O;for(O in S)r[O]=S[O]}}else if("undefined"==typeof S)throw"litegl.js requires gl-matrix to work. It must be included before litegl.";}else if(!r.vec2)throw"litegl.js does not support gl-matrix 3.0, download 2.8 https://github.com/toji/gl-matrix/releases/tag/v2.8.1";r.requestAnimationFrame=r.requestAnimationFrame||r.mozRequestAnimationFrame||
r.webkitRequestAnimationFrame||function(g){setTimeout(g,1E3/60)};h.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};h.reverse=null;h.LEFT_MOUSE_BUTTON=0;h.MIDDLE_MOUSE_BUTTON=1;h.RIGHT_MOUSE_BUTTON=2;h.LEFT_MOUSE_BUTTON_MASK=1;h.RIGHT_MOUSE_BUTTON_MASK=2;h.MIDDLE_MOUSE_BUTTON_MASK=4;h.last_context_id=0;h.COLOR_BUFFER_BIT=16384;h.DEPTH_BUFFER_BIT=256;h.STENCIL_BUFFER_BIT=1024;h.TEXTURE_2D=3553;h.TEXTURE_CUBE_MAP=34067;h.TEXTURE_3D=32879;h.TEXTURE_MAG_FILTER=10240;h.TEXTURE_MIN_FILTER=10241;h.TEXTURE_WRAP_S=
10242;h.TEXTURE_WRAP_T=10243;h.BYTE=5120;h.UNSIGNED_BYTE=5121;h.SHORT=5122;h.UNSIGNED_SHORT=5123;h.INT=5124;h.UNSIGNED_INT=5125;h.FLOAT=5126;h.HALF_FLOAT_OES=36193;h.HALF_FLOAT=5131;h.DEPTH_COMPONENT16=33189;h.DEPTH_COMPONENT24=33190;h.DEPTH_COMPONENT32F=36012;h.FLOAT_VEC2=35664;h.FLOAT_VEC3=35665;h.FLOAT_VEC4=35666;h.INT_VEC2=35667;h.INT_VEC3=35668;h.INT_VEC4=35669;h.BOOL=35670;h.BOOL_VEC2=35671;h.BOOL_VEC3=35672;h.BOOL_VEC4=35673;h.FLOAT_MAT2=35674;h.FLOAT_MAT3=35675;h.FLOAT_MAT4=35676;h.TYPE_LENGTH=
{};h.TYPE_LENGTH[h.FLOAT]=h.TYPE_LENGTH[h.INT]=h.TYPE_LENGTH[h.BYTE]=h.TYPE_LENGTH[h.BOOL]=1;h.TYPE_LENGTH[h.FLOAT_VEC2]=h.TYPE_LENGTH[h.INT_VEC2]=h.TYPE_LENGTH[h.BOOL_VEC2]=2;h.TYPE_LENGTH[h.FLOAT_VEC3]=h.TYPE_LENGTH[h.INT_VEC3]=h.TYPE_LENGTH[h.BOOL_VEC3]=3;h.TYPE_LENGTH[h.FLOAT_VEC4]=h.TYPE_LENGTH[h.INT_VEC4]=h.TYPE_LENGTH[h.BOOL_VEC4]=4;h.TYPE_LENGTH[h.FLOAT_MAT3]=9;h.TYPE_LENGTH[h.FLOAT_MAT4]=16;h.SAMPLER_2D=35678;h.SAMPLER_3D=35679;h.SAMPLER_CUBE=35680;h.INT_SAMPLER_2D=36298;h.INT_SAMPLER_3D=
36299;h.INT_SAMPLER_CUBE=36300;h.UNSIGNED_INT_SAMPLER_2D=36306;h.UNSIGNED_INT_SAMPLER_3D=36307;h.UNSIGNED_INT_SAMPLER_CUBE=36308;h.DEPTH_COMPONENT=6402;h.ALPHA=6406;h.RGB=6407;h.RGBA=6408;h.LUMINANCE=6409;h.LUMINANCE_ALPHA=6410;h.DEPTH_STENCIL=34041;h.UNSIGNED_INT_24_8=h.UNSIGNED_INT_24_8_WEBGL=34042;h.R8=33321;h.R16F=33325;h.R32F=33326;h.R8UI=33330;h.RG8=33323;h.RG16F=33327;h.RG32F=33328;h.RGB8=32849;h.SRGB8=35905;h.RGB565=36194;h.R11F_G11F_B10F=35898;h.RGB9_E5=35901;h.RGB16F=34843;h.RGB32F=34837;
h.RGB8UI=36221;h.RGBA8=32856;h.RGB5_A1=32855;h.RGBA16F=34842;h.RGBA32F=34836;h.RGBA8UI=36220;h.RGBA16I=36232;h.RGBA16UI=36214;h.RGBA32I=36226;h.RGBA32UI=36208;h.DEPTH24_STENCIL8=35056;h.NEAREST=9728;h.LINEAR=9729;h.NEAREST_MIPMAP_NEAREST=9984;h.LINEAR_MIPMAP_NEAREST=9985;h.NEAREST_MIPMAP_LINEAR=9986;h.LINEAR_MIPMAP_LINEAR=9987;h.REPEAT=10497;h.CLAMP_TO_EDGE=33071;h.MIRRORED_REPEAT=33648;h.ZERO=0;h.ONE=1;h.SRC_COLOR=768;h.ONE_MINUS_SRC_COLOR=769;h.SRC_ALPHA=770;h.ONE_MINUS_SRC_ALPHA=771;h.DST_ALPHA=
772;h.ONE_MINUS_DST_ALPHA=773;h.DST_COLOR=774;h.ONE_MINUS_DST_COLOR=775;h.SRC_ALPHA_SATURATE=776;h.CONSTANT_COLOR=32769;h.ONE_MINUS_CONSTANT_COLOR=32770;h.CONSTANT_ALPHA=32771;h.ONE_MINUS_CONSTANT_ALPHA=32772;h.VERTEX_SHADER=35633;h.FRAGMENT_SHADER=35632;h.FRONT=1028;h.BACK=1029;h.FRONT_AND_BACK=1032;h.NEVER=512;h.LESS=513;h.EQUAL=514;h.LEQUAL=515;h.GREATER=516;h.NOTEQUAL=517;h.GEQUAL=518;h.ALWAYS=519;h.KEEP=7680;h.REPLACE=7681;h.INCR=7682;h.DECR=7683;h.INCR_WRAP=34055;h.DECR_WRAP=34056;h.INVERT=
5386;h.STREAM_DRAW=35040;h.STATIC_DRAW=35044;h.DYNAMIC_DRAW=35048;h.ARRAY_BUFFER=34962;h.ELEMENT_ARRAY_BUFFER=34963;h.POINTS=0;h.LINES=1;h.LINE_LOOP=2;h.LINE_STRIP=3;h.TRIANGLES=4;h.TRIANGLE_STRIP=5;h.TRIANGLE_FAN=6;h.CW=2304;h.CCW=2305;h.CULL_FACE=2884;h.DEPTH_TEST=2929;h.BLEND=3042;h.temp_vec3=vec3.create();h.temp2_vec3=vec3.create();h.temp_vec4=vec4.create();h.temp_quat=quat.create();h.temp_mat3=mat3.create();h.temp_mat4=mat4.create();r.DEG2RAD=0.0174532925;r.RAD2DEG=57.295779578552306;r.EPSILON=
1E-6;r.isPowerOfTwo=h.isPowerOfTwo=function(g){return 0==Math.log(g)/Math.log(2)%1};r.nearestPowerOfTwo=h.nearestPowerOfTwo=function(g){return Math.pow(2,Math.round(Math.log(g)/Math.log(2)))};r.nextPowerOfTwo=h.nextPowerOfTwo=function(g){return Math.pow(2,Math.ceil(Math.log(g)/Math.log(2)))};[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(g){g.prototype.toJSON||Object.defineProperty(g.prototype,"toJSON",{value:Y,enumerable:!1,configurable:!0,
writable:!0})});r.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);h.getTime=r.getTime;r.isFunction=function(g){return!!(g&&g.constructor&&g.call&&g.apply)};r.isArray=function(g){return g&&g.constructor===Array};r.isNumber=function(g){return null!=g&&g.constructor===Number};r.getClassName=function(g){if(g){if(g.name)return g.name;if(g.toString&&(g=g.toString().match(/function\s*(\w+)/))&&2==g.length)return g[1]}};r.cloneObject=h.cloneObject=function(g,
e){if(g.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";e=e||{};for(var a in g){var b=g[a];if(null===b)e[a]=null;else switch(b.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:e[a]=new b.constructor(b);break;case Boolean:case Number:case String:e[a]=b;break;case Array:e[a]=b.concat();break;case Object:e[a]=h.cloneObject(b)}}return e};r.regexMap=function(g,e,
a){for(var b;null!=(b=g.exec(e));)a(b)};r.createCanvas=h.createCanvas=function(g,e){var a=document.createElement("canvas");a.width=g;a.height=e;return a};r.cloneCanvas=h.cloneCanvas=function(g){var e=document.createElement("canvas");e.width=g.width;e.height=g.height;e.getContext("2d").drawImage(g,0,0);return e};"undefined"!=typeof Image&&(Image.prototype.getPixels=function(){var g=document.createElement("canvas");g.width=this.width;g.height=this.height;g=g.getContext("2d");g.drawImage(this,0,0);return g.getImageData(0,
0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(g){var e=this,a;for(a in g)e=e.split(a).join(g[a]);return e},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var g=0,e,a,b;if(0==this.length)return g;e=0;for(b=this.length;e<b;++e)a=this.charCodeAt(e),g=(g<<5)-g+a,g|=0;return g},enumerable:!1});Array.prototype.hasOwnProperty("clone")||
Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1});Float32Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Float32Array.prototype,"clone",{value:function(){return new Float32Array(this)},enumerable:!1});r.wipeObject=function(g){for(var e in g)g.hasOwnProperty(e)&&delete g[e]};r.extendClass=h.extendClass=function(g,e){for(var a in e)g.hasOwnProperty(a)||(g[a]=e[a]);if(e.prototype){var b=Object.getOwnPropertyNames(e.prototype);for(a=0;a<b.length;++a){var c=
b[a];g.prototype.hasOwnProperty(c)||(e.prototype.__lookupGetter__(c)?g.prototype.__defineGetter__(c,e.prototype.__lookupGetter__(c)):g.prototype[c]=e.prototype[c],e.prototype.__lookupSetter__(c)&&g.prototype.__defineSetter__(c,e.prototype.__lookupSetter__(c)))}}g.hasOwnProperty("superclass")||Object.defineProperty(g,"superclass",{get:function(){return e},enumerable:!1})};r.HttpRequest=h.request=function(g,e,a,b,c){var d=!0;c=c||{};void 0!==c.async&&(d=c.async);if(e){var f=null,f=[],k;for(k in e)f.push(k+
"="+e[k]);f=f.join("&");g=g+"?"+f}var q=new XMLHttpRequest;q.open("GET",g,d);q.responseType=c.responseType||"text";q.onload=function(c){this.getResponseHeader("Content-Type");200!=this.status?(A.trigger(q,"fail",this.status),b&&b(this.status)):(A.trigger(q,"done",this.response),a&&a(this.response))};q.onerror=function(a){A.trigger(q,"fail",a)};if(c){for(k in c)q[k]=c[k];c.binary&&(q.responseType="arraybuffer")}q.send();return q};r.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||
Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(g){A.bind(this,"done",function(e,a){g(a)});return this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(g){A.bind(this,"fail",function(e,a){g(a)});return this}}));r.getFileExtension=function(g){var e=g.indexOf("?");-1!=e&&(g=g.substr(0,e));e=g.lastIndexOf(".");return-1==e?"":g.substr(e+1).toLowerCase()};r.loadFileAtlas=h.loadFileAtlas=
function(g,e,a){var b=null;HttpRequest(g,null,function(a){a=h.processFileAtlas(a);e&&e(a);b&&b(a)},alert,a);return{done:function(a){b=a}}};r.processFileAtlas=h.processFileAtlas=function(g,e){for(var a=g.split("\n"),b={},c=[],d="",f=0,k=a.length;f<k;f++){var q=e?a[f]:a[f].trim();q.length&&("\\"!=q[0]?c.push(q):(c.length&&(b[d]=c.join("\n")),c.length=0,d=q.substr(1)))}c.length&&(b[d]=c.join("\n"));return b};r.typedArrayToArray=function(g){var e=[];e.length=g.length;for(var a=0;a<g.length;a++)e[a]=g[a];
return e};r.RGBToHex=function(g,e,a){g=Math.min(255,255*g)|0;e=Math.min(255,255*e)|0;a=Math.min(255,255*a)|0;return"#"+(16777216+(g<<16)+(e<<8)+a).toString(16).slice(1)};r.HUEToRGB=function(g,e,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?g+6*(e-g)*a:0.5>a?e:a<2/3?g+(e-g)*(2/3-a)*6:g};r.HSLToRGB=function(g,e,a,b){b=b||vec3.create();if(0==e)a=e=g=a;else{var c=0.5>a?a*(1+e):a+e-a*e,d=2*a-c;a=HUEToRGB(d,c,g+1/3);e=HUEToRGB(d,c,g);g=HUEToRGB(d,c,g-1/3)}b[0]=a;b[1]=e;b[2]=g;return b};r.hexColorToRGBA=function(){var g=
{white:[1,1,1],black:[0,0,0],gray:[0.501960813999176,0.501960813999176,0.501960813999176],red:[1,0,0],orange:[1,0.6470588445663452,0],pink:[1,0.7529411911964417,0.7960784435272217],green:[0,0.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[0.9333333373069763,0.5098039507865906,0.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[0.6470588445663452,0.16470588743686676,0.16470588743686676],silver:[0.7529411911964417,0.7529411911964417,0.7529411911964417],gold:[1,0.843137264251709,
0],transparent:[0,0,0,0]};return function(e,a,b){b=void 0===b?1:b;a=a||new Float32Array(4);a[3]=b;if("string"!=typeof e)return a;var c=g[e];if(void 0!==c)return a.set(c),a[3]=3==a.length?b:a[3]*b,a;c=e.indexOf("rgba(");if(-1!=c)return e=e.substr(5,e.length-2),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a[3]=parseFloat(e[3])*b,a;c=e.indexOf("hsla(");if(-1!=c)return e=e.substr(5,e.length-2),e=e.split(","),HSLToRGB(parseInt(e[0])/360,parseInt(e[1])/100,parseInt(e[2])/
100,a),a[3]=parseFloat(e[3])*b,a;a[3]=b;c=e.indexOf("rgb(");if(-1!=c)return e=e.substr(4,e.length-2),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a;c=e.indexOf("hsl(");if(-1!=c)return e=e.substr(4,e.length-2),e=e.split(","),HSLToRGB(parseInt(e[0])/360,parseInt(e[1])/100,parseInt(e[2])/100,a),a;e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,b,c,e){return b+b+c+c+e+e});b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!b)return a;a[0]=parseInt(b[1],
16)/255;a[1]=parseInt(b[2],16)/255;a[2]=parseInt(b[3],16)/255;return a}}();r.toHalfFloat=function(){var g=new Float32Array(1),e=new Int32Array(g.buffer);return function(a){g[0]=a;a=e[0];var b=a>>16&32768,c=(a&2147483647)+4096;if(1199570944<=c)return 1199570944<=(a&2147483647)?2139095040>c?b|31744:b|31744|(a&8388607)>>13:b|31743;if(947912704<=c)return b|c-939524096>>13;if(855638016>c)return b;c=(a&2147483647)>>23;return b|(a&8388607|8388608)+(8388608>>>c-102)>>126-c}}();var U=function(){function g(a){return a.charCodeAt(0)+
(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function e(a,b,c,d){var e=new Uint16Array(4),f=new Uint16Array(c*d),g=0,k=0,l=0,h=k=g=0,m=0,q=0,n=0,v=c/4;d/=4;for(var p=0;p<d;p++)for(var s=0;s<v;s++)l=b+4*(p*v+s),e[0]=a[l],e[1]=a[l+1],g=e[0]&31,k=e[0]&2016,h=e[0]&63488,m=e[1]&31,q=e[1]&2016,n=e[1]&63488,e[2]=5*g+3*m>>3|5*k+3*q>>3&2016|5*h+3*n>>3&63488,e[3]=5*m+3*g>>3|5*q+3*k>>3&2016|5*n+3*h>>3&63488,g=a[l+2],k=4*p*c+4*s,f[k]=e[g&3],f[k+1]=e[g>>2&3],f[k+2]=e[g>>4&3],f[k+3]=e[g>>6&
3],k+=c,f[k]=e[g>>8&3],f[k+1]=e[g>>10&3],f[k+2]=e[g>>12&3],f[k+3]=e[g>>14],g=a[l+3],k+=c,f[k]=e[g&3],f[k+1]=e[g>>2&3],f[k+2]=e[g>>4&3],f[k+3]=e[g>>6&3],k+=c,f[k]=e[g>>8&3],f[k+1]=e[g>>10&3],f[k+2]=e[g>>12&3],f[k+3]=e[g>>14];return f}function a(a){for(var b=0,c=a.length,d=0;b<c;b+=4)d=a[b],a[b]=a[b+2],a[b+2]=d}function b(b,c,d,g){var r=new Int32Array(d,0,s),B,E,F,I,H,K,P,Q,A;if(r[y]!=f)return console.error("Invalid magic number in DDS header"),0;if(!r[z]&m)return console.error("Unsupported format, must contain a FourCC code"),
0;B=r[w];switch(B){case l:E=8;F=c?c.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case h:E=16;F=c?c.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case p:E=16;F=c?c.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:E=4,B=null,F=b.RGBA}P=1;r[t]&k&&!1!==g&&(P=Math.max(1,r[C]));I=r[v];H=r[x];K=r[u]+4;if(r[D+1]&q)for(A=0;6>A;++A)for(I=r[v],H=r[x],Q=0;Q<P;++Q)B?(g=Math.max(4,I)/4*Math.max(4,H)/4*E,c=new Uint8Array(d,K,g),b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+A,Q,F,I,H,0,c)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,
!1),g=I*H*E,c=new Uint8Array(d,K,g),a(c),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+A,Q,F,I,H,0,b.RGBA,b.UNSIGNED_BYTE,c)),K+=g,I*=0.5,H*=0.5;else if(c)for(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),Q=0;Q<P;++Q)B?(g=Math.max(4,I)/4*Math.max(4,H)/4*E,c=new Uint8Array(d,K,g),b.compressedTexImage2D(b.TEXTURE_2D,Q,F,I,H,0,c)):(g=I*H*E,c=new Uint8Array(d,K,g),a(c),b.texImage2D(b.TEXTURE_2D,Q,F,I,H,0,F,b.UNSIGNED_BYTE,c)),K+=g,I*=0.5,H*=0.5;else if(B==l)Math.max(4,I),Math.max(4,H),c=new Uint16Array(d),d=e(c,
K/2,I,H),b.texImage2D(b.TEXTURE_2D,0,b.RGB,I,H,0,b.RGB,b.UNSIGNED_SHORT_5_6_5,d),g&&b.generateMipmap(b.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(B&255,B>>8&255,B>>16&255,B>>24&255),"and no native support"),0;return P}function c(b,c){var d=new Int32Array(b,0,s),g,r,B,E,F,I,H,K,P,A,G;if(d[y]!=f)return console.error("Invalid magic number in DDS header"),0;if(!d[z]&m)return console.error("Unsupported format, must contain a FourCC code"),0;g=d[w];switch(g){case l:r=
8;B="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case h:r=16;B="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case p:r=16;B="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:r=4,B="RGBA"}P=1;d[t]&k&&!1!==loadMipmaps&&(P=Math.max(1,d[C]));E=d[v];F=d[x];H=d[u]+4;var J=[];if(d[D+1]&q)for(G=0;6>G;++G)for(E=d[v],F=d[x],A=0;A<P;++A)g?(I=Math.max(4,E)/4*Math.max(4,F)/4*r,new Uint8Array(b,H,I),J.push({tex:"TEXTURE_CUBE_MAP",face:G,mipmap:A,internalFormat:B,width:E,height:F,offset:0,dataOffset:H,dataLength:I})):(I=E*F*r,K=new Uint8Array(b,
H,I),a(K),J.push({tex:"TEXTURE_CUBE_MAP",face:G,mipmap:A,internalFormat:B,width:E,height:F,offset:0,type:"UNSIGNED_BYTE",dataOffset:H,dataLength:I})),H+=I,E*=0.5,F*=0.5;else if(c)if(g==l)Math.max(4,E),Math.max(4,F),K=new Uint16Array(b),d=e(K,H/2,E,F),J.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:E,height:F,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:d});else return console.error("No manual decoder for",String.fromCharCode(g&255,g>>8&255,g>>16&255,g>>24&255),"and no native support"),
0;else for(A=0;A<P;++A)I=Math.max(4,E)/4*Math.max(4,F)/4*r,new Uint8Array(b,H,I),J.push({tex:"TEXTURE_2D",mipmap:A,internalFormat:B,width:E,height:F,offset:0,type:"UNSIGNED_BYTE",dataOffset:H,dataLength:I}),H+=I,E*=0.5,F*=0.5;return J}function d(a,c,d,e,f,g){var k=new XMLHttpRequest;k.open("GET",d,!0);k.responseType="arraybuffer";k.onload=function(){if(200==this.status){var d=new Int32Array(this.response,0,s),k=d[D+1]&q?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(k,e);var l=b(a,c,this.response,
f);a.texParameteri(k,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(k,a.TEXTURE_MIN_FILTER,1<l?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(k,null);e.texture_type=k;e.width=d[v];e.height=d[x]}g&&g(e)};k.send(null);return e}var f=542327876,k=131072,q=512,m=4,l=g("DXT1"),h=g("DXT3"),p=g("DXT5"),s=31,y=0,u=1,t=2,x=3,v=4,C=7,z=20,w=21,D=27;return{dxtToRgb565:e,uploadDDSLevels:b,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){var f=a.createTexture();b=a.getExtension("WEBGL_compressed_texture_s3tc");
d(a,b,c,f,!0,e);return f},loadDDSTextureFromMemoryEx:function(a,c,d,e,f){var g=new Int32Array(d,0,s),k=!!(g[D+1]&q),l=k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(l,e.handler);c=b(a,c,d,f);a.texParameteri(l,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(l,a.TEXTURE_MIN_FILTER,1<c?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);k&&(a.texParameteri(l,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(l,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));a.bindTexture(l,null);e.handler&&(e.texture_type=l,e.width=g[v],e.height=g[x]);
return e},getDDSTextureFromMemoryEx:function(a){var b=new Int32Array(a,0,s),d=b[D+1]&q?"TEXTURE_CUBE_MAP":"TEXTURE_2D",e=c(a);return{type:d,buffers:e,data:a,width:b[v],height:b[x]}}}}();"undefined"!=typeof r&&(r.DDS=U);if("undefined"==typeof S&&"undefined"!=typeof exports&&void 0!==typeof process&&exports.vec3)for(O in exports)r[O]=exports[O];Math.clamp=function(g,e,a){return e>g?e:a<g?a:g};Math.lerp=function(g,e,a){return g*(1-a)+e*a};Math.lerp01=function(g,e,a){return Math.clamp(g*(1-a)+e*a,0,1)};
Math.iLerp=function(g,e,a){return(a-g)/(e-g)};Math.remap=function(g,e,a,b,c){return Math.lerp(b,c,Math.iLerp(e,a,g))};vec3.ZERO=vec3.fromValues(0,0,0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=vec3.fromValues(1,0,0);vec2.rotate=function(g,e,a){var b=e[0];e=e[1];var c=Math.cos(a);a=Math.sin(a);g[0]=b*c-e*a;g[1]=b*a+e*c;return g};vec3.zero=function(g){g[0]=g[1]=0;return g};vec2.perpdot=function(g,e){return g[1]*e[0]+-g[0]*e[1]};vec2.computeSignedAngle=function(g,e){return Math.atan2(vec2.perpdot(g,
e),vec2.dot(g,e))};vec2.random=function(g,e){e=e||1;g[0]=Math.random()*e;g[1]=Math.random()*e;return g};vec3.zero=function(g){g[0]=g[1]=g[2]=0;return g};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.maxValue=function(g){return g[0]>g[1]&&g[0]>g[2]?g[0]:g[1]>g[2]?g[1]:g[2]};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.addValue=function(g,e,a){g[0]=e[0]+a;g[1]=e[1]+a;g[2]=e[2]+a};vec3.subValue=function(g,e,a){g[0]=e[0]-a;
g[1]=e[1]-a;g[2]=e[2]-a};vec3.toArray=function(g){return[g[0],g[1],g[2]]};vec3.rotateX=function(g,e,a){var b=e[1],c=e[2],d=Math.cos(a);a=Math.sin(a);g[0]=e[0];g[1]=b*d-c*a;g[2]=b*a+c*d;return g};vec3.rotateY=function(g,e,a){var b=e[0],c=e[2],d=Math.cos(a);a=Math.sin(a);g[0]=b*d-c*a;g[1]=e[1];g[2]=b*a+c*d;return g};vec3.rotateZ=function(g,e,a){var b=e[0],c=e[1],d=Math.cos(a);a=Math.sin(a);g[0]=b*d-c*a;g[1]=b*a+c*d;g[2]=e[2];return g};vec3.angle=function(g,e){return Math.acos(vec3.dot(g,e))};vec3.signedAngle=
function(g,e,a){var b=vec3.angle(g,e);g=Math.sign(a[0]*(g[1]*e[2]-g[2]*e[1])+a[1]*(g[2]*e[0]-g[0]*e[2])+a[2]*(g[0]*e[1]-g[1]*e[0]));return b*g};vec3.random=function(g,e){e=e||1;g[0]=Math.random()*e;g[1]=Math.random()*e;g[2]=Math.random()*e;return g};vec3.cartesianToPolar=function(g,e){g=g||vec3.create();var a=e[0],b=e[1],c=e[2];g[0]=Math.sqrt(a*a+b*b+c*c);g[1]=Math.asin(b/g[0]);g[2]=Math.atan2(a,c);return g};vec3.polarToCartesian=function(g,e){var a=e[0],b=e[1],c=e[2];g[0]=a*Math.cos(b)*Math.sin(c);
g[1]=a*Math.sin(b);g[2]=a*Math.cos(b)*Math.cos(c);return g};vec3.reflect=function(g,e,a){var b=e[0],c=e[1],d=e[2];vec3.scale(g,a,-2*vec3.dot(e,a));g[0]+=b;g[1]+=c;g[2]+=d;return g};vec4.random=function(g,e){e=e||1;g[0]=Math.random()*e;g[1]=Math.random()*e;g[2]=Math.random()*e;g[3]=Math.random()*e;return g};vec4.toArray=function(g){return[g[0],g[1],g[2],g[3]]};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(g){return[g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],
g[11],g[12],g[13],g[14],g[15]]};mat4.setUpAndOrthonormalize=function(g,e,a){e!=g&&mat4.copy(g,e);e=g.subarray(0,3);vec3.normalize(g.subarray(4,7),a);g=g.subarray(8,11);vec3.cross(e,a,g);vec3.normalize(e,e);vec3.cross(g,e,a);vec3.normalize(g,g)};mat4.multiplyVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];g[0]=e[0]*b+e[4]*c+e[8]*a+e[12];g[1]=e[1]*b+e[5]*c+e[9]*a+e[13];g[2]=e[2]*b+e[6]*c+e[10]*a+e[14];return g};mat4.projectVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];var d=e[1]*b+e[5]*c+e[9]*a+e[13],
f=e[2]*b+e[6]*c+e[10]*a+e[14],k=e[3]*b+e[7]*c+e[11]*a+e[15];g[0]=((e[0]*b+e[4]*c+e[8]*a+e[12])/k+1)/2;g[1]=(d/k+1)/2;g[2]=(f/k+1)/2;return g};vec3.project=function(g,e,a,b){b=b||gl.viewport_data;var c=e[0],d=e[1];e=e[2];var f=a[3]*c+a[7]*d+a[11]*e+a[15],k=1-((a[1]*c+a[5]*d+a[9]*e+a[13])/f+1)/2,h=((a[2]*c+a[6]*d+a[10]*e+a[14])/f+1)/2;g[0]=((a[0]*c+a[4]*d+a[8]*e+a[12])/f+1)/2*b[2]+b[0];g[1]=k*b[3]+b[1];g[2]=h;return g};var W=mat4.create(),J=vec4.create();vec3.unproject=function(g,e,a,b){J[0]=2*(e[0]-
b[0])/b[2]-1;J[1]=2*(e[1]-b[1])/b[3]-1;J[2]=2*e[2]-1;J[3]=1;if(!mat4.invert(W,a))return null;vec4.transformMat4(J,J,W);if(0===J[3])return null;g[0]=J[0]/J[3];g[1]=J[1]/J[3];g[2]=J[2]/J[3];return g};mat4.rotateVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];g[0]=e[0]*b+e[4]*c+e[8]*a;g[1]=e[1]*b+e[5]*c+e[9]*a;g[2]=e[2]*b+e[6]*c+e[10]*a;return g};mat4.fromTranslationFrontTop=function(g,e,a,b){vec3.cross(g.subarray(0,3),a,b);g.set(b,4);g.set(a,8);g.set(e,12);return g};mat4.translationMatrix=function(g){var e=
mat4.create();e[12]=g[0];e[13]=g[1];e[14]=g[2];return e};mat4.setTranslation=function(g,e){g[12]=e[0];g[13]=e[1];g[14]=e[2];return g};mat4.getTranslation=function(g,e){g[0]=e[12];g[1]=e[13];g[2]=e[14];return g};mat4.toRotationMat4=function(g,e){mat4.copy(g,e);g[12]=g[13]=g[14]=0;return g};mat4.swapRows=function(g,e,a,b){if(g!=e)return mat4.copy(g,e),g[4*a]=e[4*b],g[4*a+1]=e[4*b+1],g[4*a+2]=e[4*b+2],g[4*a+3]=e[4*b+3],g[4*b]=e[4*a],g[4*b+1]=e[4*a+1],g[4*b+2]=e[4*a+2],g[4*b+3]=e[4*a+3],g;e=new Float32Array(matrix.subarray(4*
a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(e,4*b);return g};mat4.scaleAndAdd=function(g,e,a,b){g[0]=e[0]+a[0]*b;g[1]=e[1]+a[1]*b;g[2]=e[2]+a[2]*b;g[3]=e[3]+a[3]*b;g[4]=e[4]+a[4]*b;g[5]=e[5]+a[5]*b;g[6]=e[6]+a[6]*b;g[7]=e[7]+a[7]*b;g[8]=e[8]+a[8]*b;g[9]=e[9]+a[9]*b;g[10]=e[10]+a[10]*b;g[11]=e[11]+a[11]*b;g[12]=e[12]+a[12]*b;g[13]=e[13]+a[13]*b;g[14]=e[14]+a[14]*b;g[15]=e[15]+a[15]*b;return g};quat.fromAxisAngle=function(g,e){var a=quat.create();e*=0.5;var b=Math.sin(e);a[0]=b*g[0];
a[1]=b*g[1];a[2]=b*g[2];a[3]=Math.cos(e);return a};quat.lookRotation=function(){var g=vec3.create(),e=vec3.create(),a=vec3.create();return function(b,c,d){vec3.normalize(g,c);vec3.cross(e,d,g);vec3.normalize(e,e);vec3.cross(a,g,e);var f=e[0];c=e[1];d=e[2];var k=a[0],h=a[1],m=a[2],l=g[0],n=g[1],p=g[2],s=f+h+p;if(0<s)return f=Math.sqrt(s+1),b[3]=0.5*f,f=0.5/f,b[0]=(m-n)*f,b[1]=(l-d)*f,b[2]=(c-k)*f,b;if(f>=h&&f>=p)return f=Math.sqrt(1+f-h-p),h=0.5/f,b[0]=0.5*f,b[1]=(c+k)*h,b[2]=(d+l)*h,b[3]=(m-n)*h,
b;if(h>p)return f=Math.sqrt(1+h-f-p),h=0.5/f,b[0]=(k+c)*h,b[1]=0.5*f,b[2]=(n+m)*h,b[3]=(l-d)*h,b;f=Math.sqrt(1+p-f-h);h=0.5/f;b[0]=(l+d)*h;b[1]=(n+m)*h;b[2]=0.5*f;b[3]=(c-k)*h;return b}}();quat.toEuler=function(g,e){var a=Math.atan2(2*e[1]*e[3]-2*e[0]*e[2],1-2*e[1]*e[1]-2*e[2]*e[2]),b=Math.asin(2*e[0]*e[1]+2*e[2]*e[3]),c=Math.atan2(2*e[0]*e[3]-2*e[1]*e[2],1-2*e[0]*e[0]-2*e[2]*e[2]);g||(g=vec3.create());vec3.set(g,a,b,c);return g};quat.fromEuler=function(g,e){var a=e[0],b=e[1],c=e[2],d=Math.cos(a),
f=Math.cos(b),k=Math.cos(c),a=Math.sin(a),b=Math.sin(b),c=Math.sin(c),h=0.5*Math.sqrt(1+d*f+d*k-a*b*c+f*k);0==h&&(h=1E-6);quat.set(g,(f*c+d*c+a*b*k)/(4*h),(a*f+a*k+d*b*c)/(4*h),(-a*c+d*b*k+b)/(4*h),h);quat.normalize(g,g);return g};quat.fromMat4=function(g,e){var a=e[0]+e[5]+e[10];if(0<a){var b=Math.sqrt(a+1);g[3]=0.5*b;b=0.5/b;g[0]=(e[9]-e[6])*b;g[1]=(e[8]-e[2])*b;g[2]=(e[4]-e[1])*b}else{a=0;e[5]>e[0]&&(a=1);e[10]>e[4*a+a]&&(a=2);var c=(a+1)%3,d=(c+1)%3,b=Math.sqrt(e[4*a+a]-e[4*c+c]-e[4*d+d]+1);g[a]=
0.5*b;b=0.5/b;g[3]=(e[4*d+c]-e[4*c+d])*b;g[c]=(e[4*c+a]+e[4*a+c])*b;g[d]=(e[4*d+a]+e[4*a+d])*b}quat.normalize(g,g)};vec3.getMat3Column=function(g,e,a){g[0]=e[3*a];g[1]=e[3*a+1];g[2]=e[3*a+2];return g};mat3.setColumn=function(g,e,a){g[3*a]=e[0];g[3*a+1]=e[1];g[3*a+2]=e[2];return g};quat.fromMat3AndQuat=function(){var g=mat3.create(),e=quat.create(),a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),h=vec3.create(),m=vec3.create(),l=vec3.create(),n=vec3.create();
mat3.create();return function(p,s,y){y=y||25;for(var u=0;u<y;++u){var t=mat3.fromQuat(g,p);vec3.getMat3Column(a,t,0);vec3.getMat3Column(b,t,1);vec3.getMat3Column(c,t,2);vec3.getMat3Column(d,s,0);vec3.getMat3Column(f,s,1);vec3.getMat3Column(k,s,2);vec3.cross(h,a,d);vec3.cross(m,b,f);vec3.cross(l,c,k);vec3.add(n,h,m);vec3.add(n,n,l);t=1/Math.abs(vec3.dot(a,d)+vec3.dot(b,f)+vec3.dot(c,k))+1E-9;vec3.scale(n,n,t);t=vec3.length(n);if(1E-9>t)break;vec3.scale(n,n,1/t);quat.setAxisAngle(e,n,t);quat.mul(p,
e,p);quat.normalize(p,p)}return p}}();quat.rotateToFrom=function(){var g=vec3.create();return function(e,a,b){e=e||quat.create();var c=vec3.cross(g,a,b);a=vec3.dot(a,b);if(-0.99>a)return e[0]=0,e[1]=1,e[2]=0,e[3]=0,e;e[0]=0.5*c[0];e[1]=0.5*c[1];e[2]=0.5*c[2];e[3]=0.5*(1+a);quat.normalize(e,e);return e}}();quat.lookAt=function(){var g=vec3.create();return function(e,a,b){b=vec3.dot(vec3.FRONT,a);if(1E-6>Math.abs(b- -1))return e.set(vec3.UP),e[3]=Math.PI,e;if(1E-6>Math.abs(b-1))return quat.identity(e);
b=Math.acos(b);vec3.cross(g,vec3.FRONT,a);vec3.normalize(g,g);quat.setAxisAngle(e,g,b);return e}}();h.Indexer=function(){this.unique=[];this.indices=[];this.map={}};h.Indexer.prototype={add:function(g){var e=JSON.stringify(g);e in this.map||(this.map[e]=this.unique.length,this.unique.push(g));return this.map[e]}};h.Buffer=function(g,e,a,b,c){h.debug&&console.log("GL.Buffer created");null!==c&&(c=c||r.gl);this.gl=c;this.buffer=null;this.target=g;this.attribute=null;this.normalize=!1;this.data=e;this.spacing=
a||3;this.data&&this.gl&&this.upload(b)};h.Buffer.prototype.bind=function(g,e){e=e||this.gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer);e.enableVertexAttribArray(g);e.vertexAttribPointer(g,this.spacing,this.buffer.gl_type,this.normalize||!1,0,0)};h.Buffer.prototype.unbind=function(g,e){e=e||this.gl;e.disableVertexAttribArray(g)};h.Buffer.prototype.forEach=function(g){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b)g(e.subarray(a,a+b),a);return this};h.Buffer.prototype.applyTransform=function(g){for(var e=
this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b){var d=e.subarray(a,a+b);vec3.transformMat4(d,d,g)}return this};h.Buffer.prototype.upload=function(g){var e=this.spacing||3,a=this.gl;if(a){if(!this.data)throw"No data supplied";var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||a.createBuffer()){this.buffer.length=b.length;this.buffer.spacing=e;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=
a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=a.SHORT;break;case Uint16Array:this.buffer.gl_type=a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=a.INT;break;case Uint32Array:this.buffer.gl_type=a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";}this.target!=a.ARRAY_BUFFER||this.buffer.gl_type!=a.INT&&this.buffer.gl_type!=a.UNSIGNED_INT||(console.warn("WebGL does not support UINT32 or INT32 as vertex buffer types, converting to FLOAT"),
this.buffer.gl_type=a.FLOAT,b=new Float32Array(b));a.bindBuffer(this.target,this.buffer);a.bufferData(this.target,b,g||this.stream_type||a.STATIC_DRAW)}}};h.Buffer.prototype.compile=h.Buffer.prototype.upload;h.Buffer.prototype.setData=function(g,e){if(!g.buffer)throw"Data must be typed array";e=e||0;if(this.data){if(this.data.length<g.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";if(this.data!=g)if(this.data.length==g.length)this.data.set(g),this.upload();else{var a=
new Uint8Array(g.buffer,g.buffer.byteOffset,g.buffer.byteLength);(new Uint8Array(this.data.buffer)).set(a,e);this.uploadRange(e,a.length)}}else this.data=g,this.upload()};h.Buffer.prototype.uploadRange=function(g,e){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var a=new Uint8Array(this.data.buffer,g,e),b=this.gl;b.bindBuffer(this.target,this.buffer);b.bufferSubData(this.target,g,a)};h.Buffer.prototype.clone=function(g){var e=new h.Buffer;
if(g)for(var a in this)e[a]=this[a];else this.target&&(e.target=this.target),this.gl&&(e.gl=this.gl),this.spacing&&(e.spacing=this.spacing),this.data&&(e.data=new r[this.data.constructor](this.data),e.upload());return e};h.Buffer.prototype.toJSON=function(){return this.data?{data_type:getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)};h.Buffer.prototype.fromJSON=function(g){this.data=
new (r[g.data_type]||Float32Array)(g.data);this.target=g.target;this.spacing=g.spacing||3;this.attribute=g.attribute;this.upload(h.STATIC_DRAW)};h.Buffer.prototype.delete=function(){this.gl.deleteBuffer(this.buffer);this.buffer=null};r.Mesh=h.Mesh=function(g,e,a,b){h.debug&&console.log("GL.Mesh created");null!==b&&(this.gl=b=b||r.gl);this.gl&&(this._context_id=this.gl.context_id);this.vertexBuffers={};this.indexBuffers={};this.info={groups:[]};this._bounding=BBox.create();(g||e)&&this.addBuffers(g,
e,a?a.stream_type:null);if(a)for(var c in a)this[c]=a[c]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal",normalize:!0},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color",normalize:!0},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},
weights:{spacing:4,attribute:"a_weights",normalize:!0},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Object.defineProperty(Mesh.prototype,"bounding",{set:function(g){if(g){if(13>g.length)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(g)}},get:function(){return this._bounding}});Mesh.prototype.addBuffer=
function(g,e){e.target==gl.ARRAY_BUFFER?this.vertexBuffers[g]=e:this.indexBuffers[g]=e;if(!e.attribute){var a=h.Mesh.common_buffers[g];a&&(e.attribute=a.attribute)}};Mesh.prototype.addBuffers=function(g,e,a){var b=0;this.vertexBuffers.vertices&&(b=this.vertexBuffers.vertices.data.length/3);for(var c in g){var d=g[c];if(d){if(d.constructor==h.Buffer||d.data)d=d.data;else if("number"!=typeof d[0]){for(var f=[],k=0,q=1E4;k<d.length;k+=q)f=Array.prototype.concat.apply(f,d.slice(k,k+q));d=f}f=h.Mesh.common_buffers[c];
d.constructor===Array&&(k=h.Mesh.default_datatype,f&&f.type&&(k=f.type),d=new k(d));"vertices"==c&&(b=d.length/3);k=d.length/b;f&&f.spacing&&(k=f.spacing);q="a_"+c;f&&f.attribute&&(q=f.attribute);this.vertexBuffers[c]?this.updateVertexBuffer(c,q,k,d,a):this.createVertexBuffer(c,q,k,d,a)}}if(e)for(c in e)if(d=e[c]){if(d.constructor==h.Buffer||d.data)d=d.data;if("number"!=typeof d[0]){f=[];c=0;for(q=1E4;c<d.length;c+=q)f=Array.prototype.concat.apply(f,d.slice(c,c+q));d=f}d.constructor===Array&&(k=Uint16Array,
65536<b&&(k=Uint32Array),d=new k(d));this.createIndexBuffer(c,d)}};Mesh.prototype.createVertexBuffer=function(g,e,a,b,c){var d=h.Mesh.common_buffers[g];!e&&d&&(e=d.attribute);if(!e)throw"Buffer added to mesh without attribute name";!a&&d&&(a=d&&d.spacing?d.spacing:3);if(!b){b=this.getNumVertices();if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";b=new h.Mesh.default_datatype(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[g]=
new h.Buffer(h.ARRAY_BUFFER,b,a,c,this.gl);a.name=g;a.attribute=e;(b.constructor==Uint8Array||b.constructor==Int8Array||b.constructor==Uint16Array||b.constructor==Int16Array||b.constructor==Uint32Array||b.constructor==Int32Array)&&d&&d.normalize&&(a.normalize=!0);return a};Mesh.prototype.updateVertexBuffer=function(g,e,a,b,c){var d=this.vertexBuffers[g];d?b.length&&(d.attribute=e,d.spacing=a,d.data=b,d.upload(c)):console.log("buffer not found: ",g)};Mesh.prototype.removeVertexBuffer=function(g,e){var a=
this.vertexBuffers[g];a&&(e&&a.delete(),delete this.vertexBuffers[g])};Mesh.prototype.getVertexBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.createIndexBuffer=function(g,e,a){if(e.constructor===Array){var b=Uint16Array,c=this.vertexBuffers.vertices;c&&(65536<c.data.length/3&&(b=Uint32Array),e=new b(e))}return this.indexBuffers[g]=new h.Buffer(h.ELEMENT_ARRAY_BUFFER,e,0,a,this.gl)};Mesh.prototype.getBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.getIndexBuffer=function(g){return this.indexBuffers[g]};
Mesh.prototype.removeIndexBuffer=function(g,e){var a=this.indexBuffers[g];a&&(e&&a.delete(),delete this.indexBuffers[g])};Mesh.prototype.upload=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e];a.upload(g)}for(var b in this.indexBuffers)a=this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var g in this.vertexBuffers){var e=this.vertexBuffers[g];e.delete()}this.vertexBuffers={};for(g in this.indexBuffers)e=
this.indexBuffers[g],e.delete();this.indexBuffers={}};Mesh.prototype.delete=Mesh.prototype.deleteBuffers;Mesh.prototype.bindBuffers=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=g.attributes[a.attribute||e];null!=b&&a.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.buffer.spacing,a.buffer.gl_type,a.normalize||!1,0,0))}};Mesh.prototype.unbindBuffers=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],
b=a.attribute||e;null!=g.attributes[b]&&a.buffer&&gl.disableVertexAttribArray(g.attributes[b])}};Mesh.prototype.clone=function(g){g=g||r.gl;var e={},a={},b;for(b in this.vertexBuffers){var c=this.vertexBuffers[b];e[b]=new c.data.constructor(c.data)}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=new c.data.constructor(c.data);return new h.Mesh(e,a,void 0,g)};Mesh.prototype.cloneShared=function(g){g=g||r.gl;return new h.Mesh(this.vertexBuffers,this.indexBuffers,void 0,g)};Mesh.prototype.toObject=
function(){var g={},e={},a;for(a in this.vertexBuffers){var b=this.vertexBuffers[a];g[a]={spacing:b.spacing,data:new b.data.constructor(b.data)}}for(a in this.indexBuffers)b=this.indexBuffers[a],e[a]={data:new b.data.constructor(b.data)};return{vertexBuffers:g,indexBuffers:e,info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()}};Mesh.prototype.toJSON=function(){var g={vertexBuffers:{},indexBuffers:{},info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()},
e;for(e in this.vertexBuffers)g.vertexBuffers[e]=this.vertexBuffers[e].toJSON();for(e in this.indexBuffers)g.indexBuffers[e]=this.indexBuffers[e].toJSON();return g};Mesh.prototype.fromJSON=function(g){this.vertexBuffers={};this.indexBuffers={};for(var e in g.vertexBuffers)if(g.vertexBuffers[e]){var a=new h.Buffer;a.fromJSON(g.vertexBuffers[e]);!a.attribute&&h.Mesh.common_buffers[e]&&(a.attribute=h.Mesh.common_buffers[e].attribute);this.vertexBuffers[e]=a}for(e in g.indexBuffers)g.indexBuffers[e]&&
(a=new h.Buffer,a.fromJSON(g.indexBuffers[e]),this.indexBuffers[e]=a);g.info&&(this.info=cloneObject(g.info));g.bounding&&(this.bounding=g.bounding)};Mesh.prototype.generateMetadata=function(){var g={},e=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;g.vertices=e.length/3;g.faces=a?a.length/3:e.length/9;g.indexed=!!this.metadata.faces;this.metadata=g};Mesh.prototype.computeWireframe=function(){var g=this.indexBuffers.triangles,e=this.vertexBuffers.vertices.data.length/3;if(g){for(var a=
g.data,b=new h.Indexer,g=0;g<a.length;g+=3)for(var c=a.subarray(g,g+3),d=0;d<c.length;d++){var f=c[d],k=c[(d+1)%c.length];b.add([Math.min(f,k),Math.max(f,k)])}a=b.unique;b=65536<e?new Uint32Array(2*a.length):new Uint16Array(2*a.length);g=0;for(e=a.length;g<e;++g)b.set(a[g],2*g)}else for(g=e/3,b=65536<e?new Uint32Array(6*g):new Uint16Array(6*g),g=0;g<e;g+=3)b[2*g]=g,b[2*g+1]=g+1,b[2*g+2]=g+1,b[2*g+3]=g+2,b[2*g+4]=g+2,b[2*g+5]=g;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.flipNormals=
function(g){var e=this.vertexBuffers.normals;if(e){for(var a=e.data,b=a.length,c=0;c<b;++c)a[c]*=-1;e.upload(g);this.indexBuffers.triangles||this.computeIndices();e=this.indexBuffers.triangles;a=e.data;b=a.length;for(c=0;c<b;c+=3){var d=a[c];a[c]=a[c+1];a[c+1]=d}e.upload(g)}};Mesh.prototype.computeIndices=function(){var g=[],e=[],a=[],b=[],c=this.vertexBuffers.normals,d=this.vertexBuffers.coords,f=this.vertexBuffers.vertices.data,k=null;c&&(k=c.data);c=null;d&&(c=d.data);for(var d={},q=f.length/3,
m=0;m<q;++m){var l=f.subarray(3*m,3*(m+1)),n=1E3*l[0]|0,p=0,s=d[n];if(s)for(var y=s.length;p<y;p++)if(0.01>vec3.sqrDist(l,g[s[p]])){b.push(p);break}s&&p!=y||(g.push(l),d[n]?d[n].push(p):d[n]=[p],k&&e.push(k.subarray(3*m,3*(m+1))),c&&a.push(c.subarray(2*m,2*(m+1))),b.push(p))}this.vertexBuffers={};this.createVertexBuffer("vertices",h.Mesh.common_buffers.vertices.attribute,3,T(g));k&&this.createVertexBuffer("normals",h.Mesh.common_buffers.normals.attribute,3,T(e));c&&this.createVertexBuffer("coords",
h.Mesh.common_buffers.coords.attribute,2,T(a));this.createIndexBuffer("triangles",b)};Mesh.prototype.explodeIndices=function(g){g=g||"triangles";var e=this.getIndexBuffer(g);if(e){var a=e.data,e={},b;for(b in this.vertexBuffers){var c=h.Mesh.common_buffers[b];e[b]=new (c.type||Float32Array)(c.spacing*a.length)}b=0;for(var d=a.length;b<d;++b){var f=a[b],k;for(k in this.vertexBuffers){var q=this.vertexBuffers[k],c=h.Mesh.common_buffers[k],c=q.spacing||c.spacing;e[k].set(q.data.subarray(f*c,f*c+c),b*
c)}}for(b in e)k=this.vertexBuffers[b],this.createVertexBuffer(b,k.attribute,k.spacing,e[b]);delete this.indexBuffers[g]}};Mesh.prototype.computeNormals=function(g){if(!this.vertexBuffers.vertices)return console.error("Cannot compute normals of a mesh without vertices");var e=this.vertexBuffers.vertices.data,a=new Float32Array(e.length),b=null;this.indexBuffers.triangles&&(b=this.indexBuffers.triangles.data);for(var c=h.temp_vec3,d=h.temp2_vec3,f,k,q,m,l,n,p=b?b.length:e.length,s=0;s<p;s+=3)b?(f=
b[s],k=b[s+1],q=b[s+2],m=e.subarray(3*f,3*f+3),l=e.subarray(3*k,3*k+3),n=e.subarray(3*q,3*q+3),f=a.subarray(3*f,3*f+3),k=a.subarray(3*k,3*k+3),q=a.subarray(3*q,3*q+3)):(m=e.subarray(3*s,3*s+3),l=e.subarray(3*s+3,3*s+6),n=e.subarray(3*s+6,3*s+9),f=a.subarray(3*s,3*s+3),k=a.subarray(3*s+3,3*s+6),q=a.subarray(3*s+6,3*s+9)),vec3.sub(c,l,m),vec3.sub(d,n,m),vec3.cross(c,c,d),vec3.normalize(c,c),vec3.add(f,f,c),vec3.add(k,k,c),vec3.add(q,q,c);if(b)for(s=0,p=a.length;s<p;s+=3)e=a.subarray(s,s+3),vec3.normalize(e,
e);if(p=this.vertexBuffers.normals)p.data=a,p.upload(g);else return this.createVertexBuffer("normals",h.Mesh.common_buffers.normals.attribute,3,a);return p};Mesh.prototype.computeTangents=function(){var g=this.vertexBuffers.vertices;if(!g)return console.error("Cannot compute tangents of a mesh without vertices");var e=this.vertexBuffers.normals;if(!e)return console.error("Cannot compute tangents of a mesh without normals");var a=this.vertexBuffers.coords;if(!a)return console.error("Cannot compute tangents of a mesh without uvs");
var b=this.indexBuffers.triangles;if(!b)return console.error("Cannot compute tangents of a mesh without indices");var g=g.data,e=e.data,c=a.data,d=b.data;if(g&&e&&c){var f=g.length/3,b=new Float32Array(4*f),a=new Float32Array(6*f),f=a.subarray(3*f),k,h,m=vec3.create(),l=vec3.create(),n=vec3.create(),p=vec3.create();k=0;for(h=d.length;k<h;k+=3){var s=d[k],y=d[k+1],u=d[k+2],t=g.subarray(3*s,3*s+3),r=g.subarray(3*y,3*y+3),v=g.subarray(3*u,3*u+3),C=c.subarray(2*s,2*s+2),z=c.subarray(2*y,2*y+2),w=c.subarray(2*
u,2*u+2),D=r[0]-t[0],L=v[0]-t[0],M=r[1]-t[1],V=v[1]-t[1],r=r[2]-t[2],t=v[2]-t[2],v=z[0]-C[0],A=w[0]-C[0],z=z[1]-C[1],C=w[1]-C[1],w=v*C-A*z,w=1E-9>Math.abs(w)?0:1/w;vec3.copy(m,[(C*D-z*L)*w,(C*M-z*V)*w,(C*r-z*t)*w]);vec3.copy(l,[(v*L-A*D)*w,(v*V-A*M)*w,(v*t-A*r)*w]);vec3.add(a.subarray(3*s,3*s+3),a.subarray(3*s,3*s+3),m);vec3.add(a.subarray(3*y,3*y+3),a.subarray(3*y,3*y+3),m);vec3.add(a.subarray(3*u,3*u+3),a.subarray(3*u,3*u+3),m);vec3.add(f.subarray(3*s,3*s+3),f.subarray(3*s,3*s+3),l);vec3.add(f.subarray(3*
y,3*y+3),f.subarray(3*y,3*y+3),l);vec3.add(f.subarray(3*u,3*u+3),f.subarray(3*u,3*u+3),l)}k=0;for(h=g.length;k<h;k+=3)g=e.subarray(k,k+3),c=a.subarray(k,k+3),vec3.subtract(n,c,vec3.scale(n,g,vec3.dot(g,c))),vec3.normalize(n,n),g=0>vec3.dot(vec3.cross(p,g,c),f.subarray(k,k+3))?-1:1,b.set([n[0],n[1],n[2],g],k/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,b)}};Mesh.prototype.computeTextureCoordinates=function(g){var e=this.vertexBuffers.vertices;if(!e)return console.error("Cannot compute uvs of a mesh without vertices");
this.explodeIndices("triangles");var e=e.data,a=this.vertexBuffers.coords,b=new Float32Array(e.length/3*2),c=this.indexBuffers.triangles,d=null;c&&(d=c.data);var c=vec3.create(),f=vec3.create(),k=vec3.create(),h=this.getBoundingBox(),m=BBox.getCenter(h),l=vec3.create();l.set(BBox.getHalfsize(h));vec3.scale(l,l,2);for(var h=d?d.length:e.length/3,n=0;n<h;n+=3){if(d)var p=d[n],s=d[n+1],y=d[n+2],u=e.subarray(3*p,3*p+3),t=e.subarray(3*s,3*s+3),r=e.subarray(3*y,3*y+3),p=b.subarray(2*p,2*p+2),s=b.subarray(2*
s,2*s+2),y=b.subarray(2*y,2*y+2);else u=e.subarray(3*n,3*n+3),t=e.subarray(3*(n+1),3*(n+1)+3),r=e.subarray(3*(n+2),3*(n+2)+3),p=b.subarray(2*n,2*n+2),s=b.subarray(2*(n+1),2*(n+1)+2),y=b.subarray(2*(n+2),2*(n+2)+2);vec3.sub(f,u,t);vec3.sub(k,u,r);vec3.cross(c,f,k);c[0]=Math.abs(c[0]);c[1]=Math.abs(c[1]);c[2]=Math.abs(c[2]);c[0]>c[1]&&c[0]>c[2]?(p[0]=(u[2]-m[2])/l[2],p[1]=(u[1]-m[1])/l[1],s[0]=(t[2]-m[2])/l[2],s[1]=(t[1]-m[1])/l[1],y[0]=(r[2]-m[2])/l[2],y[1]=(r[1]-m[1])/l[1]):c[1]>c[2]?(p[0]=(u[0]-
m[0])/l[0],p[1]=(u[2]-m[2])/l[2],s[0]=(t[0]-m[0])/l[0],s[1]=(t[2]-m[2])/l[2],y[0]=(r[0]-m[0])/l[0],y[1]=(r[2]-m[2])/l[2]):(p[0]=(u[0]-m[0])/l[0],p[1]=(u[1]-m[1])/l[1],s[0]=(t[0]-m[0])/l[0],s[1]=(t[1]-m[1])/l[1],y[0]=(r[0]-m[0])/l[0],y[1]=(r[1]-m[1])/l[1])}a?(a.data=b,a.upload(g)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,b)};Mesh.prototype.getNumVertices=function(){var g=this.vertexBuffers.vertices;return g?g.data.length/g.spacing:0};Mesh.prototype.getNumTriangles=function(){var g=
this.getIndexBuffer("triangles");return g?g.data.length/3:this.getNumVertices()/3};Mesh.computeBoundingBox=function(g,e,a){if(g){var b=0;if(a){for(var c=0;c<a.length;++c)if(a[c]){b=c;break}if(b==a.length){console.warn("mask contains only zeros, no vertices marked");return}}for(var d=vec3.clone(g.subarray(3*b,3*b+3)),f=vec3.clone(g.subarray(3*b,3*b+3)),c=3*b;c<g.length;c+=3)if(!a||a[c/3])b=g.subarray(c,c+3),vec3.min(d,b,d),vec3.max(f,b,f);if(isNaN(d[0])||isNaN(d[1])||isNaN(d[2])||isNaN(f[0])||isNaN(f[1])||
isNaN(f[2]))d[0]=d[1]=d[2]=0,f[0]=f[1]=f[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices");g=vec3.add(vec3.create(),d,f);vec3.scale(g,g,0.5);f=vec3.subtract(vec3.create(),f,g);return BBox.setCenterHalfsize(e||BBox.create(),g,f)}};Mesh.prototype.getBoundingBox=function(){if(this._bounding)return this._bounding;this.updateBoundingBox();return this._bounding};Mesh.prototype.updateBoundingBox=function(){var g=this.vertexBuffers.vertices;g&&(h.Mesh.computeBoundingBox(g.data,this._bounding),
this.info&&this.info.groups&&this.info.groups.length&&this.computeGroupsBoundingBoxes())};Mesh.prototype.computeGroupsBoundingBoxes=function(){var g=null,e=this.getIndexBuffer("triangles");e&&(g=e.data);e=this.getVertexBuffer("vertices");if(!e)return!1;e=e.data;if(!e.length)return!1;var a=this.info.groups;if(a){for(var b=0;b<a.length;++b){var c=a[b];c.bounding=c.bounding||BBox.create();var d=null;if(g){for(var d=new Uint8Array(e.length/3),f=c.start,k=0,q=c.length;k<q;k+=3)d[g[f+k]]=1,d[g[f+k+1]]=
1,d[g[f+k+2]]=1;h.Mesh.computeBoundingBox(e,c.bounding,d)}else d=e.subarray(3*c.start,3*(c.start+c.length)),h.Mesh.computeBoundingBox(d,c.bounding)}return!0}};Mesh.prototype.setBoundingBox=function(g,e){BBox.setCenterHalfsize(this._bounding,g,e)};Mesh.prototype.freeData=function(){for(var g in this.vertexBuffers)this.vertexBuffers[g].data=null,delete this[this.vertexBuffers[g].name];for(var e in this.indexBuffers)this.indexBuffers[e].data=null,delete this[this.indexBuffers[e].name]};Mesh.prototype.configure=
function(g,e){var a={},b={};e=e||{};for(var c in g)if(g[c])if("vertexBuffers"==c||"vertex_buffers"==c)for(d in g[c])a[d]=g[c][d];else if("indexBuffers"==c||"index_buffers"==c)for(d in g[c])b[d]=g[c][d];else"indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=g[c]:h.Mesh.common_buffers[c]?a[c]=g[c]:e[c]=g[c];this.addBuffers(a,b,e.stream_type);for(var d in e)this[d]=e[d];e.bounding||this.updateBoundingBox()};Mesh.prototype.totalMemory=function(){var g=0,e;for(e in this.vertexBuffers)g+=this.vertexBuffers[e].data.buffer.byteLength;
for(e in this.indexBuffers)g+=this.indexBuffers[e].data.buffer.byteLength;return g};Mesh.prototype.slice=function(g,e){var a={},b=this.indexBuffers.triangles;if(!b)return console.warn("splice in not indexed not supported yet"),null;var b=b.data,c=[],d=new Int32Array(b.length);d.fill(-1);var f=g+e;f>=b.length&&(f=b.length);for(var k=0,q=g;q<f;++q){var m=b[q];if(-1!=d[m])c.push(d[m]);else{var l=k++;d[m]=l;c.push(l);for(var n in this.vertexBuffers){var p=this.vertexBuffers[n],l=p.data,p=p.spacing;a[n]||
(a[n]=[]);for(var s=a[n],y=0;y<p;++y)s.push(l[y+m*p])}}}a=new h.Mesh(a,{triangles:c},null,gl);a.updateBoundingBox();return a};Mesh.prototype.simplify=function(){var g=this.getBoundingBox(),e=BBox.getMin(g),g=BBox.getHalfsize(g),g=vec3.scale(vec3.create(),g,2),a=new h.Mesh,b=vec3.create(),c;for(c in this.vertexBuffers){var d=this.vertexBuffers[c].data,f=new Float32Array(d.length);if("vertices"==c)for(var k=0,q=d.length;k<q;k+=3){var m=d.subarray(k,k+3);vec3.sub(b,m,e);vec3.div(b,b,g);b[0]=Math.round(256*
b[0])/256;b[1]=Math.round(256*b[1])/256;b[2]=Math.round(256*b[2])/256;vec3.mul(b,b,g);vec3.add(b,b,e);f.set(b,k)}a.addBuffer()}};Mesh.load=function(g,e,a,b){e=e||{};e.no_gl&&(b=null);a=a||new h.Mesh(null,null,null,b);a.configure(g,e);return a};Mesh.mergeMeshes=function(g,e){function a(a,b,c,d){for(c=b+c;b<c;b+=3){var e=a.subarray(b,b+3);vec3.transformMat4(e,e,d)}}function b(a,b,c,d){for(c=b+c;b<c;b+=2){var e=a.subarray(b,b+2);vec2.transformMat3(e,e,d)}}function c(a,b,c,d){if(d)for(c=b+c;b<c;++b)a[b]+=
d}e=e||{};for(var d={},f={},k={},q=[],m=0,l=0,n=[],p=[],s={},y=0,r=null,t=0;t<g.length;++t){var x=g[t],v=x.mesh,C=m;q.push(C);var z=v.vertexBuffers.vertices.data.length/3,m=m+z,w;for(w in v.vertexBuffers)d[w]=d[w]?d[w]+v.vertexBuffers[w].data.length:v.vertexBuffers[w].data.length;for(w in v.indexBuffers)f[w]=f[w]?f[w]+v.indexBuffers[w].data.length:v.indexBuffers[w].data.length;C={name:"mesh_"+t,start:C,length:z,material:""};if(v.bones){x={};for(w=0;w<v.bones.length;++w)z=v.bones[w],s[z[0]]||(s[z[0]]=
p.length,p.push(z)),x[w]=s[z[0]];z=v.vertexBuffers.bone_indices.data;for(w=0;w<z.length;w+=1)z[w]=x[z[w]]}else if(p.length)throw"cannot merge meshes, one contains bones, the other doesnt";n.push(C);if(v.morphs)if(C=Object.values(v.morphs).length,0==y)y=C;else if(y!==C)throw"cannot merge meshes with and without morph targets";}for(w in d)if(t=e[w],null===t)delete d[w];else{if(!t){if(s=v.vertexBuffers[w])s.data&&(s=s.data),s.constructor!==Array&&(t=s.constructor);t||(t=Float32Array)}d[w]=new t(d[w]);
k[w]=0;"vertices"===w&&(l=d[w].length/3)}if(y)for(r=[],t=0;t<y;++t)v=g[0].mesh,s={name:v.morphs[t].name,weight:v.morphs[t].weight,buffers:{vertices:new Float32Array(3*l),normals:new Float32Array(3*l)}},r.push(s);for(w in f)t=65536>m?Uint16Array:Uint32Array,f[w]=new t(f[w]),k[w]=0;for(t=0;t<g.length;++t){x=g[t];v=x.mesh;C=k.vertices;z=0;for(w in v.vertexBuffers)d[w]&&("vertices"==w&&(z=v.vertexBuffers[w].data.length/3),d[w].set(v.vertexBuffers[w].data,k[w]),x[w+"_matrix"]&&(m=x[w+"_matrix"],16==m.length?
a(d[w],k[w],v.vertexBuffers[w].data.length,m):9==m.length&&b(d[w],k[w],v.vertexBuffers[w].data.length,m)),k[w]+=v.vertexBuffers[w].data.length);for(w in v.indexBuffers)f[w].set(v.indexBuffers[w].data,k[w]),c(f[w],k[w],v.indexBuffers[w].data.length,q[t]),k[w]+=v.indexBuffers[w].data.length;if(y)for(w=0;w<v.morphs.length;++w){var m=v.morphs[w],D;for(D in m.buffers)s=m.buffers[D],r[w].buffers[D].set(s,C)}}k={info:{groups:n}};p.length&&(k.bones=p);return e.only_data?{vertexBuffers:d,indexBuffers:f,info:{groups:n},
morphs:r}:(v=new h.Mesh(d,f,k),v.updateBoundingBox(),r&&(v.morphs=r),v)};Mesh.parsers={};Mesh.encoders={};Mesh.binary_file_formats={};Mesh.compressors={};Mesh.decompressors={};Mesh.fromURL=function(g,e,a,b){b=b||{};a=a||r.gl;var c=g.lastIndexOf("."),d=g.substr(c+1).toLowerCase();b.extension&&(d=b.extension);if(!h.Mesh.parsers[d.toLowerCase()])return console.error("No parser available in litegl to parse mesh of type",d),null;var f=new h.Mesh(void 0,void 0,void 0,a);f.ready=!1;b.binary=Mesh.binary_file_formats[d];
HttpRequest(g,null,function(a){f.parse(a,d,b);delete f.ready;e&&e.call(f,f,g,b)},function(a){e&&e(null)},b);return f};Mesh.prototype.parse=function(g,e,a){a=a||{};a.mesh=this;e=e.toLowerCase();var b=h.Mesh.parsers[e];if(b)return b.call(null,g,a);throw"GL.Mesh.parse: no parser found for format "+e;};Mesh.prototype.encode=function(g,e){g=g.toLowerCase();var a=h.Mesh.encoders[g];if(a)return a.call(null,this,e);throw"GL.Mesh.encode: no encoder found for format "+g;};Mesh.getScreenQuad=function(g){g=g||
r.gl;var e=g.meshes[":screen_quad"];if(e)return e;var e=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]),e=new h.Mesh({vertices:e,coords:a},void 0,void 0,g);return g.meshes[":screen_quad"]=e};h.linearizeArray=T;h.Mesh.EXTENSION="wbin";h.Mesh.enable_wbin_compression=!0;N.DEFAULT_NORMAL=vec3.fromValues(0,1,0);N.DEFAULT_COORD=vec2.fromValues(0.5,0.5);N.DEFAULT_COLOR=vec4.fromValues(1,1,1,1);N.prototype.resize=function(g){var e={};this._vertex_data=
new Float32Array(3*g);e.vertices=this._vertex_data;normals&&(e.normals=this._normal_data=new Float32Array(3*g));coords&&(e.coords=this._coord_data=new Float32Array(2*g));colors&&(e.colors=this._color_data=new Float32Array(4*g));this.addBuffers(e);this.current_pos=0;this.max_size=g;this._must_update=!0};N.prototype.clear=function(){this.current_pos=0};N.prototype.addPoint=function(g,e,a,b){if(c>=this.max_size)return console.warn("DynamicMesh: not enough space, reserve more"),!1;var c=this.current_pos++;
this._vertex_data.set(g,3*c);this._normal_data&&this._normal_data.set(e||N.DEFAULT_NORMAL,3*c);this._coord_data&&this._coord_data.set(a||N.DEFAULT_COORD,2*c);this._color_data&&this._color_data.set(b||N.DEFAULT_COLOR,4*c);return this._must_update=!0};N.prototype.update=function(g){if(!this._must_update&&!g)return this.current_pos;this._must_update=!1;this.getBuffer("vertices").upload(gl.STREAM_DRAW);this._normal_data&&this.getBuffer("normal").upload(gl.STREAM_DRAW);this._coord_data&&this.getBuffer("coord").upload(gl.STREAM_DRAW);
this._color_data&&this.getBuffer("color").upload(gl.STREAM_DRAW);return this.current_pos};extendClass(N,Mesh);Mesh.plane=function(g,e){g=g||{};g.triangles=[];var a=g.detailX||g.detail||1,b=g.detailY||g.detail||1,c=g.width||g.size||1,d=g.height||g.size||1,f=g.xz,c=0.5*c,d=0.5*d,k=[],q=[],m=[],l=[],n=vec3.fromValues(0,0,1);f&&n.set([0,1,0]);for(var p=0;p<=b;p++)for(var s=p/b,r=0;r<=a;r++){var u=r/a;f?q.push((2*u-1)*c,0,-(2*s-1)*d):q.push((2*u-1)*c,(2*s-1)*d,0);m.push(u,s);l.push(n[0],n[1],n[2]);r<a&&
p<b&&(u=r+p*(a+1),f?(k.push(u+1,u+a+1,u),k.push(u+1,u+a+2,u+a+1)):(k.push(u,u+1,u+a+1),k.push(u+a+1,u+1,u+a+2)))}a=BBox.fromCenterHalfsize([0,0,0],f?[c,0,d]:[c,d,0]);return h.Mesh.load({vertices:q,normals:l,coords:m,triangles:k},{bounding:a},e)};Mesh.plane2D=function(g,e){var a=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),b=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(g&&g.size)for(var c=0.5*g.size,d=0;d<a.length;++d)a[d]*=c;return new h.Mesh({vertices2D:a,coords:b},null,e)};Mesh.point=function(g){return new h.Mesh({vertices:[0,
0,0]})};Mesh.cube=function(g,e){g=g||{};var a=0.5*(g.size||1),b={};b.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var c=0,d=b.vertices.length;c<d;++c)b.vertices[c]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,
1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,
0],[a,a,a]);return h.Mesh.load(b,g,e)};Mesh.box=function(g,e){g=g||{};var a=g.sizex||1,b=g.sizey||1,c=g.sizez||1,a=0.5*a,b=0.5*b,c=0.5*c,d={};d.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var f=0,k=d.vertices.length;f<k;f+=3)d.vertices[f]*=a,
d.vertices[f+1]*=b,d.vertices[f+2]*=c;d.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);d.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(d.wireframe=
new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,b,c]);return h.Mesh.load(d,g,e)};Mesh.circle=function(g,e){g=g||{};var a=g.size||g.radius||1,b=Math.ceil(g.slices||24),c=g.xz||!1,d=g.empty||!1;3>b&&(b=3);var f=2*Math.PI/b,k=vec3.create(),q=vec3.create(),m=vec3.fromValues(0,0,1),l=vec2.fromValues(0.5,0.5),n=vec2.create();c&&m.set([0,1,0]);var p=c?2:1,s=new Float32Array(3*(b+1)),r=new Float32Array(3*(b+1)),u=new Float32Array(2*(b+
1)),t=null;s.set(k,0);r.set(m,0);u.set(l,0);for(k=l=t=0;k<b;++k)t=Math.sin(f*k),l=Math.cos(f*k),q[0]=t*a,q[p]=l*a,n[0]=0.5*t+0.5,n[1]=0.5*l+0.5,s.set(q,3*k+3),r.set(m,3*k+3),u.set(n,2*k+2);if(d)s=s.subarray(3),r=s.subarray(3),u=s.subarray(2),t=null;else{t=new Uint16Array(3*b);d=2;f=1;c&&(d=1,f=2);for(k=0;k<b-1;++k)t[3*k]=0,t[3*k+1]=k+d,t[3*k+2]=k+f;t[3*k]=0;c?(t[3*k+1]=k+1,t[3*k+2]=1):(t[3*k+1]=1,t[3*k+2]=k+1)}g.bounding=BBox.fromCenterHalfsize([0,0,0],c?[a,0,a]:[a,a,0]);a={vertices:s,normals:r,coords:u,
triangles:t};if(g.wireframe){c=new Uint16Array(2*b);for(k=0;k<b;k++)c[2*k]=k,c[2*k+1]=k+1;c[0]=b;a.wireframe=c}return h.Mesh.load(a,g,e)};Mesh.ring=function(g,e){g=g||{};var a=g.size||g.radius||1,b=g.thickness||0.1*a,c=Math.ceil(g.slices||24),d=g.xz||!1,f=g.empty||!1;3>c&&(c=3);var k=2*Math.PI/c;vec3.create();var q=vec3.create(),m=vec3.create(),l=vec3.fromValues(0,0,1);vec2.fromValues(0.5,0.5);var n=vec2.create();d&&l.set([0,1,0]);for(var p=d?2:1,s=new Float32Array(3*(2*c+2)),r=new Float32Array(3*
(2*c+2)),u=new Float32Array(2*(2*c+2)),t=null,x=t=0,v=0;v<=c;++v)t=Math.sin(k*v),x=Math.cos(k*v),q[0]=t*(a-b),q[p]=x*(a-b),n[0]=v/c,n[1]=0,s.set(q,6*v),r.set(l,6*v),u.set(n,4*v),m[0]=t*(a+b),m[p]=x*(a+b),n[1]=1,s.set(m,6*v+3),r.set(l,6*v+3),u.set(n,4*v+2);if(f)s=s.subarray(3),r=s.subarray(3),u=s.subarray(2),t=null;else for(t=new Uint16Array(6*c),f=2,k=1,d&&(f=1,k=2),v=0;v<c;++v)t[6*v]=2*v,t[6*v+1]=2*v+f,t[6*v+2]=2*v+k,t[6*v+3]=2*v+k,t[6*v+4]=2*v+f,t[6*v+5]=2*v+3;g.bounding=BBox.fromCenterHalfsize([0,
0,0],d?[a+b,0,a+b]:[a+b,a+b,0]);a={vertices:s,normals:r,coords:u,triangles:t};if(g.wireframe){b=new Uint16Array(4*c);for(v=0;v<c;v++)b[4*v]=2*v,b[4*v+1]=2*v+2,b[4*v+2]=2*v+1,b[4*v+3]=2*v+3;a.wireframe=b}return h.Mesh.load(a,g,e)};Mesh.cylinder=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||64,d=new Float32Array(36*c),f=new Float32Array(36*c),k=new Float32Array(24*c),h=2*Math.PI/c,m=null,l=0;l<c;++l){var n=l*h,m=[Math.sin(n),0,Math.cos(n)];d.set([m[0]*a,
0.5*b,m[2]*a],18*l);f.set(m,18*l);k.set([l/c,1],12*l);m=[Math.sin(n),0,Math.cos(n)];d.set([m[0]*a,-0.5*b,m[2]*a],18*l+3);f.set(m,18*l+3);k.set([l/c,0],12*l+2);m=[Math.sin(n+h),0,Math.cos(n+h)];d.set([m[0]*a,-0.5*b,m[2]*a],18*l+6);f.set(m,18*l+6);k.set([(l+1)/c,0],12*l+4);m=[Math.sin(n+h),0,Math.cos(n+h)];d.set([m[0]*a,0.5*b,m[2]*a],18*l+9);f.set(m,18*l+9);k.set([(l+1)/c,1],12*l+6);m=[Math.sin(n),0,Math.cos(n)];d.set([m[0]*a,0.5*b,m[2]*a],18*l+12);f.set(m,18*l+12);k.set([l/c,1],12*l+8);m=[Math.sin(n+
h),0,Math.cos(n+h)];d.set([m[0]*a,-0.5*b,m[2]*a],18*l+15);f.set(m,18*l+15);k.set([(l+1)/c,0],12*l+10)}var m=18*l,p=12*l;if(!1===g.caps)d=d.subarray(0,m),f=f.subarray(0,m),k=k.subarray(0,p);else for(var s=vec3.fromValues(0,0.5*b,0),r=vec3.fromValues(0,-0.5*b,0),u=vec3.fromValues(0,1,0),t=vec3.fromValues(0,-1,0),l=0;l<c;++l){var n=l*h,x=vec3.fromValues(Math.sin(n),0,Math.cos(n)),n=vec3.fromValues(Math.sin(n+h),0,Math.cos(n+h));d.set([x[0]*a,0.5*b,x[2]*a],m+18*l);f.set(u,m+18*l);k.set([0.5*-x[0]+0.5,
0.5*x[2]+0.5],p+12*l);d.set([n[0]*a,0.5*b,n[2]*a],m+18*l+3);f.set(u,m+18*l+3);k.set([0.5*-n[0]+0.5,0.5*n[2]+0.5],p+12*l+2);d.set(s,m+18*l+6);f.set(u,m+18*l+6);k.set([0.5,0.5],p+12*l+4);d.set([n[0]*a,-0.5*b,n[2]*a],m+18*l+9);f.set(t,m+18*l+9);k.set([0.5*n[0]+0.5,0.5*n[2]+0.5],p+12*l+6);d.set([x[0]*a,-0.5*b,x[2]*a],m+18*l+12);f.set(t,m+18*l+12);k.set([0.5*x[0]+0.5,0.5*x[2]+0.5],p+12*l+8);d.set(r,m+18*l+15);f.set(t,m+18*l+15);k.set([0.5,0.5],p+12*l+10)}c={vertices:d,normals:f,coords:k};g.bounding=BBox.fromCenterHalfsize([0,
0,0],[a,0.5*b,a]);g.info={groups:[]};!1!==g.caps&&(g.info.groups.push({name:"side",start:0,length:m/3}),g.info.groups.push({name:"caps",start:m/3,length:(d.length-m)/3}));return Mesh.load(c,g,e)};Mesh.cone=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||64,d=new Float32Array(18*c),f=new Float32Array(18*c),k=new Float32Array(12*c),h=2*Math.PI/c,m=null,l=a/b,n=0;n<c;++n){var p=n*h,m=[Math.sin(p+0.5*h),l,Math.cos(p+0.5*h)];vec3.normalize(m,m);d.set([0,b,0],
18*n);f.set(m,18*n);k.set([n/c,1],12*n);m=[Math.sin(p),l,Math.cos(p)];d.set([m[0]*a,0,m[2]*a],18*n+3);vec3.normalize(m,m);f.set(m,18*n+3);k.set([n/c,0],12*n+2);m=[Math.sin(p+h),l,Math.cos(p+h)];d.set([m[0]*a,0,m[2]*a],18*n+6);vec3.normalize(m,m);f.set(m,18*n+6);k.set([(n+1)/c,0],12*n+4)}m=vec3.fromValues(0,0,0);l=vec3.fromValues(0,-1,0);for(n=0;n<c;++n){var p=n*h,s=vec3.fromValues(Math.sin(p),0,Math.cos(p)),p=vec3.fromValues(Math.sin(p+h),0,Math.cos(p+h));d.set([p[0]*a,0,p[2]*a],18*n+9);f.set(l,18*
n+9);k.set([0.5*p[0]+0.5,0.5*p[2]+0.5],12*n+6);d.set([s[0]*a,0,s[2]*a],18*n+12);f.set(l,18*n+12);k.set([0.5*s[0]+0.5,0.5*s[2]+0.5],12*n+8);d.set(m,18*n+15);f.set(l,18*n+15);k.set([0.5,0.5],12*n+10)}c={vertices:d,normals:f,coords:k};g.bounding=BBox.fromCenterHalfsize([0,0.5*b,0],[a,0.5*b,a]);return Mesh.load(c,g,e)};Mesh.torus=function(g,e){g=g||{};var a=g.outerradius||g.radius||1,b=Math.ceil(g.outerslices||g.slices||24),c=g.innerradius||0.1*a,d=Math.ceil(g.innerslices||b),f=g.angle||2*Math.PI,k=2*
Math.PI/d,q=f/b;vec3.create();var m=vec3.create(),l=vec3.fromValues(0,0,1);vec2.fromValues(0.5,0.5);for(var n=vec2.create(),f=f==2*Math.PI,p=new Float32Array(3*d),s=new Float32Array(3*d),r=0,u=0,t=0;t<d;++t)r=Math.sin(k*t),u=Math.cos(k*t),m[0]=r*c,m[1]=u*c,n[0]=0.5*r+0.5,n[1]=0.5*u+0.5,p.set(m,3*t),vec3.normalize(l,m),s.set(l,3*t);var k=new Float32Array(3*b*d),n=new Float32Array(3*b*d),r=new Float32Array(2*b*d),u=null,x=mat4.create(),v=vec3.fromValues(-a,0,0),C=vec3.fromValues(0,1,0);vec3.create();
for(var u=[],z=d,t=0;t<b;++t){mat4.identity(x);mat4.rotate(x,x,t*q,C);mat4.translate(x,x,v);var w=t*d,z=d;t>=b-1&&(z=(b-1)*-d,f||(z=0));for(var D=0;D<d;++D){var L=p.subarray(3*D,3*D+3),M=s.subarray(3*D,3*D+3);mat4.multiplyVec3(m,x,L);mat4.rotateVec3(l,x,M);k.set(m,3*D+3*t*d);n.set(l,3*D+3*t*d);r.set([t/b,D/d],2*D+2*t*d);L=w+D;M=w+(D+1)%d;u.push(M,L,L+z,M,L+z,M+z)}}a=c+a;g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,c]);return h.Mesh.load({vertices:k,normals:n,coords:r,triangles:u},g,e)};Mesh.sphere=
function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.lat||g.subdivisions||16,c=g["long"]||g.subdivisions||16,d=new Float32Array((b+1)*(c+1)*3),f=new Float32Array((b+1)*(c+1)*3),k=new Float32Array((b+1)*(c+1)*2),q=new Uint16Array(b*c*6),m=g.hemi?0.5*Math.PI:Math.PI,l=0,n=0,p=0;p<=b;p++)for(var s=p*m/b,r=Math.sin(s),u=Math.cos(s),s=0;s<=c;s++){var t=2*s*Math.PI/c,x=Math.sin(t),t=Math.cos(t)*r,v=u,x=x*r,C=1-s/c,z=1-p/b;d.set([a*t,a*v,a*x],l);f.set([t,v,x],l);k.set([C,z],n);l+=3;n+=2}for(p=l=0;p<b;p++)for(s=
0;s<c;s++)m=p*(c+1)+s,n=m+c+1,q.set([n,m,m+1],l),q.set([n+1,n,m+1],l+3),l+=6;d={vertices:d,normals:f,coords:k,triangles:q};if(g.wireframe){f=new Uint16Array(c*b*4);for(l=k=0;l<b;l++){for(q=0;q<c;q++)f[k]=l*(c+1)+q,f[k+1]=l*(c+1)+q+1,k+=2;f[k-2*c]=l*(c+1)+q}for(l=0;l<c;l++)for(q=0;q<b;q++)f[k]=q*(c+1)+l,f[k+1]=(q+1)*(c+1)+l,k+=2;d.wireframe=f}g.bounding=g.hemi?BBox.fromCenterHalfsize([0,0.5*a,0],[a,0.5*a,a],a):BBox.fromCenterHalfsize([0,0,0],[a,a,a],a);return h.Mesh.load(d,g,e)};Mesh.grid=function(g,
e){g=g||{};var a=g.lines||11;0>a&&(a=1);for(var b=g.size||10,c=new Float32Array(12*a),d=0.5*b,f=0,k=-d,b=b/(a-1),q=0;q<a;q++)c[f]=k,c[f+2]=-d,c[f+3]=k,c[f+5]=d,c[f+6]=d,c[f+8]=k,c[f+9]=-d,c[f+11]=k,k+=b,f+=12;return new h.Mesh({vertices:c},g,e)};Mesh.icosahedron=function(g,e){function a(a,c){var d=m[a]<m[c]?m[a]+":"+m[c]:m[c]+":"+m[a],e=u[d];if(e)return e;e=f.length/3;f.push(0.5*(f[3*m[a]]+f[3*m[c]]),0.5*(f[3*m[a]+1]+f[3*m[c]+1]),0.5*(f[3*m[a]+2]+f[3*m[c]+2]));var g=Math.sqrt(f[3*e]*f[3*e]+f[3*e+
1]*f[3*e+1]+f[3*e+2]*f[3*e+2]),h=f[3*e]/g,l=f[3*e+1]/g,n=f[3*e+2]/g;k.push(h,l,n);q.push(Math.atan2(h,n)/Math.PI*0.5,Math.acos(l)/Math.PI);f[3*e]*=b/g;f[3*e+1]*=b/g;f[3*e+2]*=b/g;return u[d]=e}g=g||{};var b=g.radius||g.size||1,c=void 0===g.subdivisions?0:g.subdivisions;6<c&&(c=6);for(var d=(1+Math.sqrt(5))/2,f=[-1,d,0,1,d,0,-1,-d,0,1,-d,0,0,-1,d,0,1,d,0,-1,-d,0,1,-d,d,0,-1,d,0,1,-d,0,-1,-d,0,1],k=[],q=[],m=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,
8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],d=f.length,l=0;l<d;l+=3){var n=Math.sqrt(f[l]*f[l]+f[l+1]*f[l+1]+f[l+2]*f[l+2]),p=f[l]/n,s=f[l+1]/n,r=f[l+2]/n;k.push(p,s,r);q.push(Math.atan2(p,r),Math.acos(s));f[l]*=b/n;f[l+1]*=b/n;f[l+2]*=b/n}for(var u={},n=0;n<c;++n){p=[];d=m.length;for(l=0;l<d;l+=3){var s=a(l,l+1),r=a(l+1,l+2),t=a(l+2,l);p.push(m[l],s,t);p.push(m[l+1],r,s);p.push(m[l+2],t,r);p.push(s,r,t)}m=p}g.bounding=BBox.fromCenterHalfsize([0,0,0],[b,b,b],b);return new h.Mesh.load({vertices:f,coords:q,
normals:k,triangles:m},g,e)};Mesh.shape=function(g,e,a){function b(a,b){var c=a[b+1];a[b+1]=a[b+2];a[b+2]=-c}e=e||{};if("undefined"===typeof earcut)throw"To use GL.Mesh.shape you must download and include earcut.js (do not link it directly!): https://raw.githubusercontent.com/mapbox/earcut/master/src/earcut.js";if(!g||!g.length||1==g.length%2)throw"GL.Mesh.shape line missing, must be an array of 2D vertices";var c=e.extrude||0;g[0].constructor===Array&&(g=earcut.flatten(g));var d=earcut(g).reverse();
console.log(d);for(var f=[],k=[],q=[],m=[g[0],g[1]],l=[g[0],g[1]],n=0;n<g.length;n+=2)m[0]=Math.min(m[0],g[n]),m[1]=Math.max(m[1],g[n]),l[0]=Math.min(l[0],g[n+1]),l[1]=Math.max(l[1],g[n+1]);var p=m[1]-m[0],s=l[1]-l[0],r=[],u=null;if(c){for(var u=[],t=vec3.create(),x=g.length,n=0;n<g.length;n+=2){var v=g[n],C=g[n+1],z=g[(n+2)%x],w=g[(n+3)%x],D=f.length/3;f.push(v,0.5*c,C);f.push(v,-0.5*c,C);f.push(z,0.5*c,w);f.push(z,-0.5*c,w);vec3.normalize(t,vec3.cross(t,[0,1,0],[z-v,0,w-C]));k.push(t[0],t[1],t[2],
t[0],t[1],t[2],t[0],t[1],t[2],t[0],t[1],t[2]);var L=(v-m[0])/p,M=(C-l[0])/s,v=(z-m[0])/p,C=(w-l[0])/s;q.push(L,M,L,M,v,C,v,C);u.push(D,D+2,D+1,D+2,D+3,D+1)}r.push({name:"side",start:0,length:u.length});t=f.length/3;x=u.length;for(n=0;n<g.length;n+=2)v=g[n],C=g[n+1],L=(v-m[0])/p,M=(C-l[0])/s,f.push(v,0.5*c,C),f.push(v,-0.5*c,C),k.push(0,1,0,0,-1,0),q.push(L,M,L,M);for(n=0;n<d.length;n+=3)u.push(t+2*d[n],t+2*d[n+1],t+2*d[n+2]),u.push(t+2*d[n]+1,t+2*d[n+2]+1,t+2*d[n+1]+1);r.push({name:"caps",start:x,
length:u.length});e.bounding=BBox.fromCenterHalfsize([0.5*(m[0]+m[1]),0,0.5*(l[0]+l[1])],[0.5*p,0.5*c,0.5*s],vec2.len([0.5*p,0.5*c,0.5*s]))}else{for(n=0;n<g.length;n+=2)f.push(g[n],0,g[n+1]),k.push(0,1,0),q.push((g[n]-m[0])/p,(g[n+1]-l[0])/s);u=d;r.push({name:"side",start:0,length:u.length});e.bounding=BBox.fromCenterHalfsize([0.5*(m[0]+m[1]),0,0.5*(l[0]+l[1])],[0.5*p,0,0.5*s],vec2.len([0.5*p,0,0.5*s]))}if(e.xy){for(n=0;n<f.length;n+=3)b(f,n),b(k,n);e.bounding=c?BBox.fromCenterHalfsize([0.5*(m[0]+
m[1]),0.5*(l[0]+l[1]),0],[0.5*p,0.5*s,0.5*c],vec2.len([0.5*p,0.5*s,0.5*c])):BBox.fromCenterHalfsize([0.5*(m[0]+m[1]),0.5*(l[0]+l[1]),0],[0.5*p,0.5*s,0],vec2.len([0.5*p,0.5*s,0]))}e.info={groups:r};return new h.Mesh.load({vertices:f,coords:q,normals:k,triangles:u},e,a)};r.Texture=h.Texture=function e(a,b,c,d){function f(a){return a.constructor!==Array?a:k==h.FLOAT?new Float32Array(a):k==h.HALF_FLOAT_OES?new Uint16Array(a):new Uint8Array(a)}c=c||{};this.gl=d=d||r.gl;this._context_id=d.context_id;a=
parseInt(a);b=parseInt(b);h.debug&&console.log("GL.Texture created: ",a,b);this.handler=d.createTexture();this.width=a;this.height=b;c.depth&&(this.depth=c.depth);this.texture_type=c.texture_type||d.TEXTURE_2D;this.format=c.format||e.DEFAULT_FORMAT;this.internalFormat=c.internalFormat;this.type=c.type||e.DEFAULT_TYPE;this.magFilter=c.magFilter||c.filter||e.DEFAULT_MAG_FILTER;this.minFilter=c.minFilter||c.filter||e.DEFAULT_MIN_FILTER;this.wrapS=c.wrap||c.wrapS||e.DEFAULT_WRAP_S;this.wrapT=c.wrap||
c.wrapT||e.DEFAULT_WRAP_T;this.data=null;e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==d.DEPTH_COMPONENT&&1==d.webgl_version&&!d.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==d.FLOAT&&!d.extensions.OES_texture_float&&1==d.webgl_version)throw"Float Texture not supported";if(this.type==d.HALF_FLOAT_OES){if(!d.extensions.OES_texture_half_float&&1==d.webgl_version)throw"Half Float Texture extension not supported.";
1<d.webgl_version&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),this.type=this.format==d.RGB?d.RGB16F:d.RGBA16F)}if(!(isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(this.minFilter==d.NEAREST||this.minFilter==d.LINEAR)&&this.wrapS==d.CLAMP_TO_EDGE&&this.wrapT==d.CLAMP_TO_EDGE))if(c.ignore_pot)this.minFilter=this.magFilter=d.LINEAR,this.wrapS=this.wrapT=d.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(a&&
b){this.internalFormat||this.computeInternalFormat();d.activeTexture(d.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1);d.bindTexture(this.texture_type,this.handler);d.texParameteri(this.texture_type,d.TEXTURE_MAG_FILTER,this.magFilter);d.texParameteri(this.texture_type,d.TEXTURE_MIN_FILTER,this.minFilter);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_S,this.wrapS);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_T,this.wrapT);c.anisotropic&&d.extensions.EXT_texture_filter_anisotropic&&d.texParameterf(h.TEXTURE_2D,
d.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.anisotropic);var k=this.type,q=c.pixel_data;if(q&&!q.buffer){if(this.texture_type==h.TEXTURE_CUBE_MAP)if(q[0].constructor===Number)q=f(q),q=[q,q,q,q,q,q];else for(var m=0;m<q.length;++m)q[m]=f(q[m]);else q=f(q);this.data=q}e.setUploadOptions(c);if(this.texture_type==h.TEXTURE_2D)d.texImage2D(h.TEXTURE_2D,0,this.internalFormat,a,b,0,this.format,this.type,q||null),h.isPowerOfTwo(a)&&h.isPowerOfTwo(b)&&c.minFilter&&c.minFilter!=
d.NEAREST&&c.minFilter!=d.LINEAR&&(d.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==h.TEXTURE_CUBE_MAP)for(a=a*a*(this.format==h.RGBA?4:3),m=0;6>m;++m)(b=q)&&(b.constructor===Array?b=b[m]:b.subarray(a*m,a*(m+1))),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,this.internalFormat,this.width,this.height,0,this.format,this.type,b||null);else if(this.texture_type==h.TEXTURE_3D){if(1==this.gl.webgl_version)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by passing webgl2:true to the context";
if(!c.depth)throw"3d texture depth must be set in the options.depth";d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1);d.texImage3D(h.TEXTURE_3D,0,this.internalFormat,a,b,c.depth,0,this.format,this.type,q||null)}d.bindTexture(this.texture_type,null);d.activeTexture(d.TEXTURE0)}};Texture.DEFAULT_TYPE=h.UNSIGNED_BYTE;Texture.DEFAULT_FORMAT=h.RGBA;Texture.DEFAULT_MAG_FILTER=h.LINEAR;Texture.DEFAULT_MIN_FILTER=h.LINEAR;Texture.DEFAULT_WRAP_S=h.CLAMP_TO_EDGE;Texture.DEFAULT_WRAP_T=
h.CLAMP_TO_EDGE;Texture.EXTENSION="png";Texture.framebuffer=null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.CROSS_ORIGIN_CREDENTIALS="Anonymous";Texture.prototype.computeInternalFormat=function(){this.internalFormat=this.format;1==gl.webgl_version?this.type==h.HALF_FLOAT&&(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=h.HALF_FLOAT_OES):this.type==h.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),
this.type=h.HALF_FLOAT);if(this.format==h.DEPTH_COMPONENT||this.format===h.DEPTH_STENCIL)if(this.minFilter=h.NEAREST,2==gl.webgl_version)if(this.type===h.UNSIGNED_INT_24_8&&this.format===h.DEPTH_STENCIL)this.internalFormat=h.DEPTH24_STENCIL8;else if(this.type===h.FLOAT&&this.format===h.DEPTH_STENCIL)this.internalFormat=gl.FLOAT_32_UNSIGNED_INT_24_8_REV;else if(this.type==h.UNSIGNED_SHORT)this.internalFormat=h.DEPTH_COMPONENT16;else if(this.type==h.UNSIGNED_INT)this.internalFormat=h.DEPTH_COMPONENT24;
else if(this.type==h.FLOAT)this.internalFormat=h.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";else{if(1==gl.webgl_version){if(this.type==h.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=h.DEPTH_COMPONENT}}else if(this.format==gl.RGBA)2==gl.webgl_version&&(this.type==h.FLOAT?this.internalFormat=h.RGBA32F:this.type==h.HALF_FLOAT&&(this.internalFormat=h.RGBA16F));else if(this.format==gl.RGB&&2==gl.webgl_version)if(this.type==h.FLOAT)this.internalFormat=
h.RGB32F;else if(this.type==h.HALF_FLOAT)throw"GL.RGB HALF_FLOAT is not supported, use RGBA instead";};Texture.prototype.delete=function(){gl.deleteTexture(this.handler);this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.hasSameProperties=function(e){return e?e.width==this.width&&
e.height==this.height&&e.type==this.type&&e.format==this.format&&e.texture_type==this.texture_type:!1};Texture.prototype.hasSameSize=function(e){return e?e.width==this.width&&e.height==this.height:!1};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(e){void 0==e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,this.handler);return e};Texture.prototype.unbind=
function(e){void 0===e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(e,a){this.bind(0);this.gl.texParameteri(this.texture_type,e,a);switch(e){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=a;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=a;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=a;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=a}};Texture.setUploadOptions=function(e,a){a=a||r.gl;Texture.disable_deprecated||
(e?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0)));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.flipYData=function(e,a,b,c){var d=new e.constructor(a*c),f=0,k=a*(b-1)*c;b=Math.floor(0.5*b);for(var h=0;h<b;++h){var m=e.subarray(f,f+a*c),l=e.subarray(k,k+a*c);d.set(m);m.set(l);l.set(d);f+=a*c;k-=a*c;if(f>k)break}};Texture.prototype.uploadImage=
function(e,a){this.bind();var b=this.gl;if(!e)throw"uploadImage parameter must be Image";Texture.setUploadOptions(a,b);try{if(a&&a.subimage)1==b.webgl_version?b.texSubImage2D(b.TEXTURE_2D,0,0,0,this.format,this.type,e):b.texSubImage2D(b.TEXTURE_2D,0,0,0,e.videoWidth||e.width,e.videoHeight||e.height,this.format,this.type,e);else{var c=e.videoWidth||e.width,d=e.videoHeight||e.height;c==this.width&&d==this.height||1==this.width||1==this.height||console.warn("image uploaded has a different size than texture, resizing it.");
b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,e);this.width=c;this.height=d}this.data=e}catch(f){console.error(f);if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=
!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(e,a,b){a=a||{};if(!e)throw"no data passed";var c=this.gl;this.bind();Texture.setUploadOptions(a,c);var d=a.mipmap_level||0,f=this.width,k=this.height,f=f>>d,k=k>>d,q=this.internalFormat||this.format;this.type==h.HALF_FLOAT_OES&&e.constructor===Float32Array&&console.warn("cannot uploadData to a HALF_FLOAT texture from a Float32Array, must be Uint16Array. To upload it we recomment to create a FLOAT texture, upload data there and copy to your HALF_FLOAT.");
if(this.texture_type==h.TEXTURE_2D)1==c.webgl_version?e.buffer&&e.buffer.constructor==ArrayBuffer?c.texImage2D(this.texture_type,d,q,f,k,0,this.format,this.type,e):c.texImage2D(this.texture_type,d,q,this.format,this.type,e):2==c.webgl_version&&c.texImage2D(this.texture_type,d,q,f,k,0,this.format,this.type,e);else if(this.texture_type==h.TEXTURE_3D)c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),c.texImage3D(this.texture_type,d,q,f,k,this.depth>>d,0,this.format,
this.type,e);else if(this.texture_type==h.TEXTURE_CUBE_MAP)c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+(a.cubemap_face||0),d,q,f,k,0,this.format,this.type,e);else throw"cannot uploadData for this texture type";this.data=e;!b&&this.minFilter&&this.minFilter!=c.NEAREST&&this.minFilter!=c.LINEAR&&(c.generateMipmap(this.texture_type),this.has_mipmaps=!0);c.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,
0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}];Texture.prototype.drawTo=
function(e,a){function b(){6E4<=h.getTime()-this.time?(c.deleteRenderbuffer(c._renderbuffers_pool[l]),delete c._renderbuffers_pool[l]):setTimeout(b.bind(this),6E4)}var c=this.gl,d=c.getViewport(),f=h.getTime(),k=c.getParameter(c.FRAMEBUFFER_BINDING),q=c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,q);var m=null;if(Texture.use_renderbuffer_pool){c._renderbuffers_pool||(c._renderbuffers_pool={});var l=this.width+":"+this.height;c._renderbuffers_pool[l]?(m=c._renderbuffers_pool[l],
m.time=f,c.bindRenderbuffer(c.RENDERBUFFER,m)):(c._renderbuffers_pool[l]=m=c.createRenderbuffer(),m.time=f,m.width=this.width,m.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,m),setTimeout(b.bind(m),6E4))}else m=c._renderbuffer=c._renderbuffer||c.createRenderbuffer(),m.width=this.width,m.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,m);this.format===c.DEPTH_COMPONENT?c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,this.width,this.height):c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,
this.width,this.height);c.viewport(0,0,this.width,this.height);c._current_texture_drawto=this;c._current_fbo_color=q;c._current_fbo_depth=m;if(this.texture_type==c.TEXTURE_2D)this.format!==c.DEPTH_COMPONENT?(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,m)):(c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,m),c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,
c.TEXTURE_2D,this.handler,0)),e(this,a);else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(this.format!==c.DEPTH_COMPONENT?c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,m):c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,m),f=0;6>f;f++)this.format!==c.DEPTH_COMPONENT?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0):c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_CUBE_MAP_POSITIVE_X+
f,this.handler,0),e(this,f,a);this.data=null;c._current_texture_drawto=null;c._current_fbo_color=null;c._current_fbo_depth=null;c.bindFramebuffer(c.FRAMEBUFFER,k);c.bindRenderbuffer(c.RENDERBUFFER,null);c.viewport(d[0],d[1],d[2],d[3]);return this};Texture.prototype.copyTo=function(e,a,b){var c=this.gl;if(!e)throw"target_texture required";var d=c.getParameter(c.FRAMEBUFFER_BINDING),f=c.getViewport();a||(a=this.texture_type==c.TEXTURE_2D?h.Shader.getScreenShader():h.Shader.getCubemapCopyShader());c.disable(c.BLEND);
c.disable(c.DEPTH_TEST);a&&b&&a.uniforms(b);b=c.__copy_fbo;b||(b=c.__copy_fbo=c.createFramebuffer());c.bindFramebuffer(c.FRAMEBUFFER,b);c.viewport(0,0,e.width,e.height);if(this.texture_type==c.TEXTURE_2D)if(this.format!==c.DEPTH_COMPONENT&&this.format!==c.DEPTH_STENCIL)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e.handler,0),this.toViewport(a);else{a=c._color_renderbuffer=c._color_renderbuffer||c.createRenderbuffer();b=a.width=e.width;var k=a.height=e.height;c.bindRenderbuffer(c.RENDERBUFFER,
a);c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,b,k);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,a);b=e.format==c.DEPTH_STENCIL?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,e.handler,0);a=c.checkFramebufferStatus(c.FRAMEBUFFER);if(a!==c.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+a;c.enable(c.DEPTH_TEST);c.depthFunc(c.ALWAYS);c.colorMask(!1,!1,!1,!1);a=h.Shader.getCopyDepthShader();this.toViewport(a);c.colorMask(!0,
!0,!0,!0);c.disable(c.DEPTH_TEST);c.depthFunc(c.LEQUAL);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,null);c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,null,0)}else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(a.uniforms({u_texture:0}),b=h.temp_mat3,k=0;6>k;k++){c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+k,e.handler,0);var q=h.Texture.cubemap_camera_parameters[k];mat3.identity(b);b.set(q.right,0);b.set(q.up,3);b.set(q.dir,
6);this.toViewport(a,{u_rotation:b})}c.setViewport(f);c.bindFramebuffer(c.FRAMEBUFFER,d);e.minFilter&&e.minFilter!=c.NEAREST&&e.minFilter!=c.LINEAR&&(e.bind(),c.generateMipmap(e.texture_type),e.has_mipmaps=!0);e.data=null;c.bindTexture(e.texture_type,null);return this};Texture.prototype.blit=function(){var e=new Float32Array(4);return function(a,b,c){var d=this.gl;if(this.texture_type!=d.TEXTURE_2D||this.format===d.DEPTH_COMPONENT||this.format===d.DEPTH_STENCIL)throw"blit only support TEXTURE_2D of RGB or RGBA. use copyTo instead";
var f=d.getParameter(d.FRAMEBUFFER_BINDING);e.set(d.viewport_data);(b=b||h.Shader.getScreenShader())&&c&&b.uniforms(c);c=d.__copy_fbo;c||(c=d.__copy_fbo=d.createFramebuffer());d.bindFramebuffer(d.FRAMEBUFFER,c);d.viewport(0,0,a.width,a.height);d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,a.handler,0);this.bind(0);b.draw(h.Mesh.getScreenQuad(),d.TRIANGLES);d.setViewport(e);d.bindFramebuffer(d.FRAMEBUFFER,f);a.data=null;d.bindTexture(a.texture_type,null);return this}}();Texture.prototype.toViewport=
function(e,a){e=e||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);a&&e.uniforms(a);e.draw(b,gl.TRIANGLES)};Texture.prototype.fill=function(e,a){if(e.constructor===h.Shader)this.drawTo(function(){e.toViewport()});else{var b=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(e[0],e[1],e[2],e[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(b[0],b[1],b[2],b[3])}!a&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),
this.has_mipmaps=!0)};Texture.prototype.renderQuad=function(){var e=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,1,1,1);return function(d,f,k,h,m,l){a[0]=d;a[1]=f;b[0]=k;b[1]=h;m=m||Shader.getQuadShader(this.gl);d=Mesh.getScreenQuad(this.gl);this.bind(0);m.uniforms({u_texture:0,u_position:a,u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e});l&&m.uniforms(l);m.draw(d,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(e,a,b,c,d){var f=this.gl;void 0===
e&&(e=1);void 0===a&&(a=1);f.disable(f.DEPTH_TEST);f.disable(f.BLEND);c=c||this;var k=!d;if(d===c)throw"cannot use applyBlur in a texture using as temporary itself";if(c&&this.texture_type!==c.texture_type)throw"cannot use applyBlur with textures of different texture_type";var q=f.getParameter(f.FRAMEBUFFER_BINDING),m=f.getViewport(),l=f.__copy_fbo;l||(l=f.__copy_fbo=f.createFramebuffer());f.bindFramebuffer(f.FRAMEBUFFER,l);f.viewport(0,0,this.width,this.height);if(this.texture_type===f.TEXTURE_2D)l=
h.Shader.getBlurShader(),d||(d=h.Texture.getTemporary(this.width,this.height,this)),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,d.handler,0),this.toViewport(l,{u_texture:0,u_intensity:b,u_offset:[0,a/this.height]}),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,c.handler,0),f.viewport(0,0,c.width,c.height),d.toViewport(l,{u_intensity:b,u_offset:[e/d.width,0]}),k&&h.Texture.releaseTemporary(d);else if(this.texture_type===f.TEXTURE_CUBE_MAP){l=h.Shader.getCubemapBlurShader();
l.uniforms({u_texture:0,u_intensity:b,u_offset:[e/this.width,a/this.height]});this.bind(0);e=Mesh.getScreenQuad();e.bindBuffers(l);l.bind();a=null;a=d||c!=this?c:d=h.Texture.getTemporary(c.width,c.height,c);b=h.temp_mat3;for(var n=0;6>n;++n){f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+n,a.handler,0);var p=h.Texture.cubemap_camera_parameters[n];mat3.identity(b);b.set(p.right,0);b.set(p.up,3);b.set(p.dir,6);l._setUniform("u_rotation",b);f.drawArrays(f.TRIANGLES,
0,6)}e.unbindBuffers(l);d&&d.copyTo(c);d&&k&&h.Texture.releaseTemporary(d)}f.setViewport(m);f.bindFramebuffer(f.FRAMEBUFFER,q);c.data=null;c.minFilter&&c.minFilter!=f.NEAREST&&c.minFilter!=f.LINEAR&&(c.bind(),f.generateMipmap(c.texture_type),c.has_mipmaps=!0);f.bindTexture(c.texture_type,null)};Texture.fromURL=function(e,a,b,c){c=c||r.gl;a=a||{};a=Object.create(a);var d=a.texture||new h.Texture(1,1,a,c);64>e.length&&(d.url=e);d.bind();var f=a.temp_color||Texture.loading_color;c.pixelStorei(c.UNPACK_ALIGNMENT,
4);f=a.type==c.FLOAT?new Float32Array(f):new Uint8Array(f);c.texImage2D(c.TEXTURE_2D,0,d.format,d.width,d.height,0,d.format,d.type,f);c.bindTexture(d.texture_type,null);d.ready=!1;f=null;a.extension&&(f=a.extension);if(!f&&512>e.length){var k=e,q=e.indexOf("?");-1!=q&&(k=e.substr(0,q));q=k.lastIndexOf(".");-1!=q&&(f=k.substr(q+1).toLowerCase())}"dds"==f?(f=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),k=new h.Texture(0,0,a,c),U.loadDDSTextureEx(c,
f,e,k.handler,!0,function(a){d.texture_type=a.texture_type;d.handler=a;delete d.ready;b&&b(d,e)})):"tga"==f?HttpRequest(e,null,function(f){if(f=h.Texture.parseTGA(f))a.texture=d,f.flipY&&(a.no_flip=!0),"RGB"==f.format&&(d.format=c.RGB),d=h.Texture.fromMemory(f.width,f.height,f.pixels,a),delete d.ready,b&&b(d,e)},null,{binary:!0}):(f=new Image,f.src=e,f.crossOrigin=Texture.CROSS_ORIGIN_CREDENTIALS,f.onload=function(){a.texture=d;h.Texture.fromImage(this,a);delete d.ready;b&&b(d,e)},f.onerror=function(){b&&
b(null)});return d};Texture.parseTGA=function(e){if(!e||e.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";e=new Uint8Array(e);for(var a=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),b=e.subarray(0,12),c=0;c<b.length;c++)if(a[c]!=b[c])return console.error("TGA header is not valid"),null;c=e.subarray(12,18);a={};a.width=256*c[1]+c[0];a.height=256*c[3]+c[2];a.bpp=c[4];a.bytesPerPixel=a.bpp/8;a.imageSize=a.width*a.height*a.bytesPerPixel;a.pixels=e.subarray(18,18+a.imageSize);a.pixels=new Uint8Array(a.pixels);
a.flipY=0==(c[5]&32);for(c=0;c<a.imageSize;c+=a.bytesPerPixel)e=a.pixels[c],a.pixels[c]=a.pixels[c+2],a.pixels[c+2]=e;a.format=32==a.bpp?"RGBA":"RGB";return a};Texture.fromImage=function(e,a){a=a||{};var b=a.texture||new h.Texture(e.width,e.height,a);b.uploadImage(e,a);b.bind();gl.texParameteri(b.texture_type,gl.TEXTURE_MAG_FILTER,b.magFilter||Texture.DEFAULT_MAG_FILTER);gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,b.minFilter||Texture.DEFAULT_MIN_FILTER);gl.texParameteri(b.texture_type,
gl.TEXTURE_WRAP_S,b.wrapS||Texture.DEFAULT_WRAP_S);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,b.wrapT||Texture.DEFAULT_WRAP_T);h.isPowerOfTwo(b.width)&&h.isPowerOfTwo(b.height)||1<gl.webgl_version?a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0):(gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,h.LINEAR),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,
h.CLAMP_TO_EDGE),b.has_mipmaps=!1);gl.bindTexture(b.texture_type,null);b.data=e;a.keep_image&&(b.img=e);return b};Texture.fromVideo=function(e,a){a=a||{};var b=a.texture||new h.Texture(e.videoWidth,e.videoHeight,a);b.bind();b.uploadImage(e,a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0,b.data=e);gl.bindTexture(b.texture_type,null);return b};Texture.fromTexture=function(e,a){a=a||{};var b=new h.Texture(e.width,e.height,
a);e.copyTo(b);return b};Texture.prototype.clone=function(e){var a=this.getProperties();if(e)for(var b in e)a[b]=e[b];return Texture.fromTexture(this,a)};Texture.fromMemory=function(e,a,b,c){c=c||{};var d=c.texture||new h.Texture(e,a,c);Texture.setUploadOptions(c);d.bind();b.constructor===Array&&(b=c.type==gl.FLOAT?new Float32Array(b):c.type==h.HALF_FLOAT||c.type==h.HALF_FLOAT_OES?new Uint16Array(b):new Uint8Array(b));gl.texImage2D(gl.TEXTURE_2D,0,d.format,e,a,0,d.format,d.type,b);d.width=e;d.height=
a;d.data=b;c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);gl.bindTexture(d.texture_type,null);return d};Texture.fromDDSInMemory=function(e,a){a=a||{};var b=a.texture||new h.Texture(0,0,a);h.Texture.setUploadOptions(a);b.bind();var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");U.loadDDSTextureFromMemoryEx(gl,c,e,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=
function(e,a,b,c){c=c||{};e=new h.Texture(e,a,c);e.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var a=Mesh.getScreenQuad();b.draw(a)});return e};Texture.cubemapFromImages=function(e,a){a=a||{};if(6!=e.length)throw"missing images to create cubemap";var b=e[0].width,c=e[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;var d=null;a.texture?(d=a.texture,d.width=b,d.height=c):d=new h.Texture(b,c,a);Texture.setUploadOptions(a);d.bind();try{for(b=0;6>b;b++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+
b,0,d.format,d.format,d.type,e[b]);d.data=e}catch(f){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),d.has_mipmaps=!0);d.unbind();return d};Texture.cubemapFromImage=function(e,a){a=a||{};if(e.width!=
e.height/6&&0!=e.height%6&&!a.faces&&!a.is_polar)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",e.width,e.height),null;var b=e.width,c=e.height;if(a.is_polar){var d=a.size||h.nearestPowerOfTwo(e.height),f=h.Texture.fromImage(e,{ignore_pot:!0,wrap:gl.REPEAT,filter:gl.LINEAR}),b=new h.Texture(d,d,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGBA});if(a.texture){var c=a.texture,k;for(k in b)c[k]=b[k];b=c}var q=mat3.create(),m={u_texture:0,u_rotation:q};
gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var l=h.Shader.getPolarToCubemapShader();b.drawTo(function(a,b){var c=h.Texture.cubemap_camera_parameters[b];mat3.identity(q);q.set(c.right,0);q.set(c.up,3);q.set(c.dir,6);f.toViewport(l,m)});a.keep_image&&(b.img=e);return b}void 0!==a.is_cross?(a.faces=Texture.generateCubemapCrossFacesInfo(e.width,a.is_cross),b=c=e.width/4):a.faces?(b=a.width||a.faces[0].width,c=a.height||a.faces[0].height):c/=6;if(b!=c)return console.log("Texture not valid, width and height for every face must be square"),
null;d=b;a.no_flip=!0;var n=[];for(k=0;6>k;k++){var p=createCanvas(d,d),s=p.getContext("2d");a.faces?s.drawImage(e,a.faces[k].x,a.faces[k].y,a.faces[k].width||d,a.faces[k].height||d,0,0,d,d):s.drawImage(e,0,c*k,b,c,0,0,d,d);n.push(p)}k=Texture.cubemapFromImages(n,a);a.keep_image&&(k.img=e);return k};Texture.generateCubemapCrossFacesInfo=function(e,a){void 0===a&&(a=1);var b=e/4;return[{x:2*b,y:b,width:b,height:b},{x:0,y:b,width:b,height:b},{x:a*b,y:0,width:b,height:b},{x:a*b,y:2*b,width:b,height:b},
{x:b,y:b,width:b,height:b},{x:3*b,y:b,width:b,height:b}]};Texture.cubemapFromURL=function(e,a,b){a=a||{};a=Object.create(a);a.texture_type=gl.TEXTURE_CUBE_MAP;var c=a.texture||new h.Texture(1,1,a);c.bind();Texture.setUploadOptions(a);for(var d=a.temp_color||[0,0,0,255],d=a.type==gl.FLOAT?new Float32Array(d):new Uint8Array(d),f=0;6>f;f++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,c.format,1,1,0,c.format,c.type,d);gl.bindTexture(c.texture_type,null);c.ready=!1;d=new Image;d.src=e;d.onload=function(){a.texture=
c;(c=h.Texture.cubemapFromImage(this,a))&&delete c.ready;b&&b(c)};return c};Texture.prototype.getPixels=function(e,a){a=a||0;var b=this.gl,c=b.getViewport(),d=b.getParameter(b.FRAMEBUFFER_BINDING);if(this.format==b.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";b.disable(b.DEPTH_TEST);var f=b.__copy_fbo;f||(f=b.__copy_fbo=b.createFramebuffer());b.bindFramebuffer(b.FRAMEBUFFER,f);var f=null,k=this.width>>a,q=this.height>>a;b.viewport(0,0,k,q);this.texture_type==b.TEXTURE_2D?b.framebufferTexture2D(b.FRAMEBUFFER,
b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.handler,a):this.texture_type==b.TEXTURE_CUBE_MAP&&b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+(e||0),this.handler,a);var m=this.format==b.RGB?3:4,m=4,l=this.type,f=l==b.UNSIGNED_BYTE?new Uint8Array(k*q*m):l==h.HALF_FLOAT||l==h.HALF_FLOAT_OES?new Uint16Array(k*q*m):new Float32Array(k*q*m);b.readPixels(0,0,k,q,3==m?b.RGB:b.RGBA,l,f);b.bindFramebuffer(b.FRAMEBUFFER,d);b.viewport(c[0],c[1],c[2],c[3]);return f};Texture.prototype.setPixels=
function(e,a,b,c){a={no_flip:a};c&&(a.cubemap_face=c);this.uploadData(e,a,b)};Texture.prototype.getCubemapPixels=function(){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap";return[this.getPixels(0),this.getPixels(1),this.getPixels(2),this.getPixels(3),this.getPixels(4),this.getPixels(5)]};Texture.prototype.setCubemapPixels=function(e,a){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap, it should be created with { texture_type: gl.TEXTURE_CUBE_MAP }";
for(var b=0;6>b;++b)this.setPixels(e[b],a,5!=b,b)};Texture.prototype.toCanvas=function(e,a,b){b=b||8192;var c=this.gl,d=Math.min(this.width,b),f=Math.min(this.height,b);this.texture_type==c.TEXTURE_CUBE_MAP&&(d*=4,f*=3);e=e||createCanvas(d,f);e.width!=d&&(e.width=d);e.height!=f&&(e.height=f);var k=null;if(this.texture_type==c.TEXTURE_2D)this.width!=d||this.height!=f||this.type!=c.UNSIGNED_BYTE?(k=new h.Texture(d,f,{format:c.RGBA,filter:c.NEAREST}),this.copyTo(k),k=k.getPixels()):k=this.getPixels(),
b=e.getContext("2d"),c=b.getImageData(0,0,d,f),c.data.set(k),b.putImageData(c,0,0),a&&(k=createCanvas(d,f),a=k.getContext("2d"),a.translate(0,k.height),a.scale(1,-1),a.drawImage(e,0,0,k.width,k.height),b.clearRect(0,0,b.canvas.width,b.canvas.height),b.drawImage(k,0,0));else if(this.texture_type==c.TEXTURE_CUBE_MAP){d=createCanvas(this.width,this.height);a=d.getContext("2d");f=h.Texture.generateCubemapCrossFacesInfo(e.width,1);b=e.getContext("2d");b.fillStyle="black";b.fillRect(0,0,e.width,e.height);
var q=this;this.type!=c.UNSIGNED_BYTE&&(q=new h.Texture(this.width,this.height,{format:c.RGBA,texture_type:c.TEXTURE_CUBE_MAP,filter:c.NEAREST,type:c.UNSIGNED_BYTE}),this.copyTo(q));for(var m=0;6>m;m++)c=a.getImageData(0,0,d.width,d.height),k=q.getPixels(m),c.data.set(k),a.putImageData(c,0,0),b.drawImage(d,f[m].x,f[m].y,d.width,d.height)}return e};Texture.binary_extension="png";Texture.prototype.toBinary=function(e,a){for(var b=this.toCanvas(null,e).toDataURL(a),c=b.indexOf(","),b=b.substr(c+1),b=
atob(b),c=b.length,d=new Uint8Array(c),f=0;f<c;++f)d[f]=b.charCodeAt(f);return d};Texture.prototype.toBlob=function(e,a){var b=this.toBinary(e);return new Blob([b],{type:a||"image/png"})};Texture.prototype.toBlobAsync=function(e,a,b){var c=this.toCanvas(null,e);c.toBlob?c.toBlob(b,a):(e=this.toBlob(e,a),b&&b(e))};Texture.prototype.toBase64=function(e){var a=this.width,b=this.height,c=this.getPixels(),d=createCanvas(a,b),f=d.getContext("2d"),k=f.getImageData(0,0,a,b);k.data.set(c);f.putImageData(k,
0,0);e&&(e=createCanvas(a,b),a=e.getContext("2d"),a.translate(0,b),a.scale(1,-1),a.drawImage(d,0,0),d=e);return d.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var e={};e.width=this.width;e.height=this.height;this.metadata=e};Texture.compareFormats=function(e,a){return e&&a?e==a?!0:e.width!=a.width||e.height!=a.height||e.type!=a.type||e.format!=a.format||e.texture_type!=a.texture_type?!1:!0:!1};Texture.blend=function(e,a,b,c){if(!e||!a)return!1;if(e==a)return c?e.copyTo(c):
e.toViewport(),!0;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var d=h.Shader.getBlendShader(),f=h.Mesh.getScreenQuad();a.bind(1);d.uniforms({u_texture:0,u_texture2:1,u_factor:b});if(c)return c.drawTo(function(){if(e==c||a==c)throw"Blend output cannot be the same as the input";e.bind(0);d.draw(f,gl.TRIANGLES)}),!0;e.bind(0);d.draw(f,gl.TRIANGLES);return!0};Texture.cubemapToTexture2D=function(e,a,b,c,d){if(!e||e.texture_type!=gl.TEXTURE_CUBE_MAP)throw"No cubemap in convert";
a=a||e.width;c=c?e.type:gl.UNSIGNED_BYTE;d=d||0;b||(b=new h.Texture(2*a,a,{minFilter:gl.NEAREST,type:c}));var f=gl.shaders.cubemap_to_texture2D;f||(f=gl.shaders.cubemap_to_texture2D=new h.Shader(h.Shader.SCREEN_VERTEX_SHADER,"\t\tprecision mediump float;\n\t\t#define PI 3.14159265358979323846264\n\t\tuniform samplerCube texture;\t\tvarying vec2 v_coord;\t\tuniform float u_yaw;\n\t\tvoid main() {\t\t\tfloat alpha = ((1.0 - v_coord.x) * 2.0) * PI + u_yaw;\t\t\tfloat beta = (v_coord.y * 2.0 - 1.0) * PI * 0.5;\t\t\tvec3 N = vec3( -cos(alpha) * cos(beta), sin(beta), sin(alpha) * cos(beta) );\t\t\tgl_FragColor = textureCube(texture,N);\t\t}"));
f.setUniform("u_yaw",d);b.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);e.toViewport(f)});return b};Texture.getWhiteTexture=function(e){e=e||r.gl;var a=e.textures[":white"];if(a)return a;a=new Uint8Array([255,255,255,255]);return e.textures[":white"]=new h.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(e){e=e||r.gl;var a=e.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,255]);return e.textures[":black"]=new h.Texture(1,1,{pixel_data:a})};
Texture.getTemporary=function(e,a,b,c){c=c||r.gl;c._texture_pool||(c._texture_pool=[]);var d=h.TEXTURE_2D,f=Texture.DEFAULT_TYPE,k=Texture.DEFAULT_FORMAT;b&&(b.texture_type&&(d=b.texture_type),b.type&&(f=b.type),b.format&&(k=b.format));b=d+":"+f+":"+e+"x"+a+":"+k;for(var q=c._texture_pool,m=0;m<q.length;++m){var l=q[m];if(l._key==b)return q.splice(m,1),l._pool=0,l}l=new h.Texture(e,a,{type:f,texture_type:d,format:k,filter:c.LINEAR});l._key=b;l._pool=0;return l};Texture.releaseTemporary=function(e,
a){a=a||r.gl;a._texture_pool||(a._texture_pool=[]);0<e._pool&&console.warn("this texture is already in the textures pool");var b=a._texture_pool;b||(b=a._texture_pool=[]);e._pool=getTime();b.push(e);20<b.length&&(b.sort(function(a,b){return b._pool-a._pool}),e=b.pop(),e._pool=0,e.delete())};Texture.nextPOT=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))};h.FBO=G;G.prototype.setTextures=function(e,a,b){if(a&&a.constructor===h.Texture){if(a.format!==h.DEPTH_COMPONENT&&a.format!==h.DEPTH_STENCIL&&
a.format!==h.DEPTH_COMPONENT16&&a.format!==h.DEPTH_COMPONENT24&&a.format!==h.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";if(a.type!=h.UNSIGNED_SHORT&&a.type!=h.UNSIGNED_INT&&a.type!=h.UNSIGNED_INT_24_8_WEBGL&&a.type!=h.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL";}var c=this.depth_texture==a;if(c&&e){if(e.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";
if(e.length==this.color_textures.length)for(var d=0;d<e.length;++d){if(e[d]!=this.color_textures[d]){c=!1;break}}else c=!1}this._stencil_enabled!==this.stencil&&(c=!1);if(!c){this.color_textures.length=e?e.length:0;if(e)for(d=0;d<e.length;++d)this.color_textures[d]=e[d];this.depth_texture=a;this.update(b)}};G.prototype.update=function(e){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler||(this.handler=gl.createFramebuffer());var a=-1,b=-1,c=null,d=null,f=this.color_textures,
k=this.depth_texture;if(f&&f.length)for(var q=0;q<f.length;q++){var m=f[q];if(m.constructor!==h.Texture)throw"FBO can only bind instances of GL.Texture";if(-1==a)a=m.width;else if(a!=m.width)throw"Cannot bind textures with different dimensions";if(-1==b)b=m.height;else if(b!=m.height)throw"Cannot bind textures with different dimensions";if(null==c)c=m.type,d=m.format;else if(c!=m.type)throw"Cannot bind textures to a FBO with different pixel formats";if(m.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO";
}else a=k.width,b=k.height;this.width=a;this.height=b;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var l=gl.extensions.WEBGL_draw_buffers;if(1==gl.webgl_version&&!l&&f&&1<f.length)throw"Rendering to several textures not supported by your browser";var n=1==gl.webgl_version?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;gl.framebufferRenderbuffer(n,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null);gl.framebufferRenderbuffer(n,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null);if(k&&k.constructor===h.Texture){if(1==gl.webgl_version&&
!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&k.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format");k.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(n,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,k.handler,0):gl.framebufferTexture2D(n,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,k.handler,0)}else q=null,k&&k.constructor===WebGLRenderbuffer&&k.width==a&&k.height==b?q=this._depth_renderbuffer=
k:(q=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),q.width=a,q.height=b),gl.bindRenderbuffer(gl.RENDERBUFFER,q),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,a,b),gl.framebufferRenderbuffer(n,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,q)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b),gl.framebufferRenderbuffer(n,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,q));if(f&&f.length)for(this.order=[],q=0;q<f.length;q++)m=f[q],gl.framebufferTexture2D(n,
gl.COLOR_ATTACHMENT0+q,gl.TEXTURE_2D,m.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+q);else k=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer(),k.width=a,k.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,k),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,b),gl.framebufferRenderbuffer(n,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,k);for(q=a=f?f.length:0;q<this._num_binded_textures;++q)gl.framebufferTexture2D(n,gl.COLOR_ATTACHMENT0+q,gl.TEXTURE_2D,null,0);this._num_binded_textures=
a;this._stencil_enabled=this.stencil;f&&1<f.length&&(l?l.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));f=gl.checkFramebufferStatus(n);if(f!==gl.FRAMEBUFFER_COMPLETE)throw d!=h.RGB||c!=h.FLOAT&&c!=h.HALF_FLOAT_OES||console.error("Tip: Firefox does not support RGB channel float/half_float textures, you must use RGBA"),"FBO not complete: "+f;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);e||gl.bindFramebuffer(n,this._old_fbo_handler)};G.prototype.bind=function(e){if(this.multi_sample)this._old_fbo_handler=
gl.getParameter(gl.FRAMEBUFFER_BINDING),this._old_viewport.set(gl.viewport_data),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer);else{if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo_handler=e?gl.getParameter(gl.FRAMEBUFFER_BINDING):
null;this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0)}gl.viewport(0,0,this.width,this.height);G.current=this};G.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport);for(var e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=
!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);G.current=null};G.prototype.switchTo=function(e){e._old_fbo_handler=this._old_fbo_handler;e._old_viewport.set(this._old_viewport);gl.bindFramebuffer(gl.FRAMEBUFFER,e.handler);this._old_fbo_handler=null;gl.viewport(0,0,this.width,this.height);for(var a=0;a<this.color_textures.length;++a)this.color_textures[a]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(a=0;a<e.color_textures.length;++a)e.color_textures[a]._in_current_fbo=
!0;e.depth_texture&&(e.depth_texture._in_current_fbo=!0);G.current=e};G.prototype.delete=function(){gl.deleteFramebuffer(this.handler);this.handler=null};G.supported={};G.testSupport=function(e,a){var b=e+":"+a;if(null!=G.supported[b])return G.supported[b];var c=new h.Texture(1,1,{format:a,type:e});try{new h.FBO([c])}catch(d){return console.warn("This browser WEBGL implementation doesn't support this FBO format: "+h.reverse[e]+" "+h.reverse[a]),G.supported[b]=!1}return G.supported[b]=!0};G.prototype.toSingle=
function(e){e=e||0;if(!(2>this.color_textures.length)){var a=gl.extensions.WEBGL_draw_buffers;a?a.drawBuffersWEBGL([this.order[e]]):gl.drawBuffers([this.order[e]])}};G.prototype.toMulti=function(){if(!(2>this.color_textures.length)){var e=gl.extensions.WEBGL_draw_buffers;e?e.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}};G.prototype.clearSecondary=function(e){if(this.order&&!(2>this.order.length)){for(var a=gl.extensions.WEBGL_draw_buffers,b=[gl.NONE],c=1;c<this.order.length;++c)b.push(this.order[c]);
a?a.drawBuffersWEBGL(b):gl.drawBuffers(b);gl.clearColor(e[0],e[1],e[2],e[3]);gl.clear(gl.COLOR_BUFFER_BIT);a?a.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}};G.prototype.makeMultiSample=function(e,a,b,c){if(1==this.gl.webgl_version)throw"cannot use makeMultiSample in webgl 1.0";this.width=e;this.height=a;b=b||4;c=c||{};e=c.format||gl.RGBA8;a=gl.DEPTH_COMPONENT16;this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,
this.handler);this.colorRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.colorRenderbuffer);gl.renderbufferStorageMultisample(gl.RENDERBUFFER,b,e,this.width,this.height);this.depthRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthRenderbuffer);gl.renderbufferStorageMultisample(gl.RENDERBUFFER,b,a,this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,
this.colorRenderbuffer);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;this.multi_sample=!0};G.prototype.blitMultisample=function(e){if(!e||e.constructor!==h.FBO)throw"parameter must be GL.FBO";gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this.handler);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,e.handler);gl.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,
gl.COLOR_BUFFER_BIT,gl.LINEAR);gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport)};r.Shader=h.Shader=function a(b,c,d){h.debug&&console.log("GL.Shader created");if(!b||!c)throw"GL.Shader source code parameter missing";this._context_id=r.gl.context_id;var f=this.gl=r.gl,k=a.expandMacros(d);d=b.constructor===String?a.injectCode(k,b,f):b;k=c.constructor===
String?a.injectCode(k,c,f):c;this.program=f.createProgram();b=b.constructor===String?h.Shader.compileSource(f.VERTEX_SHADER,d):b;c=c.constructor===String?h.Shader.compileSource(f.FRAGMENT_SHADER,k):c;f.attachShader(this.program,b,f);f.attachShader(this.program,c,f);f.linkProgram(this.program);this.vs_shader=b;this.fs_shader=c;this.attributes={};this.uniformInfo={};this.samplers={};a.use_async?this._first_use=!0:this.checkLink()};Shader.use_async=!0;Shader.expandMacros=function(a){var b="";if(a)for(var c in a)b+=
"#define "+c+" "+(a[c]?a[c]:"")+"\n";return b};Shader.injectCode=function(a,b,c){var d=b.indexOf("\n");c=c?"#define WEBGL"+c.webgl_version+"\n":"";var f=b.substr(0,d).trim();return-1==f.indexOf("#version")?c+a+b:f+"\n"+c+a+b.substr(d)};Shader.compileSource=function(a,b,c,d){c=c||r.gl;d=d||c.createShader(a);c.shaderSource(d,b);c.compileShader(d);return d};Shader.parseError=function(a,b,c){if(!a)return null;var d=a.split(" "),f=d[5].split(":");return{type:d[0],line_number:parseInt(f[1]),line_pos:parseInt(f[0]),
line_code:("Fragment"==d[0]?c:b).split("\n")[parseInt(f[1])],err:a}};Shader.prototype.delete=function(){this.program&&this.gl.deleteProgram(this.program);this.vs_shader&&this.gl.deleteShader(this.vs_shader);this.fs_shader&&this.gl.deleteShader(this.fs_shader);this.gl=null;this.attributes={};this.uniformInfo={};this.samplers={}};Shader.prototype.updateShader=function(a,b,c){var d=this.gl||r.gl,f=Shader.expandMacros(c);this.program?(d.detachShader(this.program,this.vs_shader),d.detachShader(this.program,
this.fs_shader)):this.program=d.createProgram();f=Shader.expandMacros(c);c=a.constructor===String?Shader.injectCode(f,a,d):a;f=b.constructor===String?Shader.injectCode(f,b,d):b;a=a.constructor===String?h.Shader.compileSource(d.VERTEX_SHADER,c):a;b=b.constructor===String?h.Shader.compileSource(d.FRAGMENT_SHADER,f):b;d.attachShader(this.program,a,d);d.attachShader(this.program,b,d);d.linkProgram(this.program);this.vs_shader=a;this.fs_shader=b;this.attributes={};this.uniformInfo={};this.samplers={};
Shader.use_async?this._first_use=!0:this.checkLink()};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS),c=0;c<b;++c){var d=a.getActiveUniform(this.program,c);if(!d)break;var f=d.name,k=f.indexOf("[");-1!=k&&-1==f.indexOf("].")&&(f=f.substr(0,k));if(d.type==h.SAMPLER_2D||d.type==h.SAMPLER_CUBE||d.type==h.SAMPLER_3D||d.type==h.INT_SAMPLER_2D||d.type==h.INT_SAMPLER_CUBE||d.type==h.INT_SAMPLER_3D||d.type==h.UNSIGNED_INT_SAMPLER_2D||
d.type==h.UNSIGNED_INT_SAMPLER_CUBE||d.type==h.UNSIGNED_INT_SAMPLER_3D)this.samplers[f]=d.type;var k=Shader.getUniformFunc(d),q=!1;if(d.type==a.FLOAT_MAT2||d.type==a.FLOAT_MAT3||d.type==a.FLOAT_MAT4)q=!0;var m=h.TYPE_LENGTH[d.type]||1;this.uniformInfo[f]={type:d.type,func:k,size:d.size,type_length:m,is_matrix:q,loc:a.getUniformLocation(this.program,f),data:new Float32Array(m*d.size)}}c=0;for(b=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);c<b;++c){d=a.getActiveAttrib(this.program,c);if(!d)break;
k=Shader.getUniformFunc(d);m=h.TYPE_LENGTH[d.type]||1;this.uniformInfo[d.name]={type:d.type,func:k,type_length:m,size:d.size,loc:null};"gl_VertexID"!==d.name&&(this.attributes[d.name]=a.getAttribLocation(this.program,d.name))}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){var b=null;switch(a.type){case h.FLOAT:b=1==a.size?gl.uniform1f:gl.uniform1fv;break;case h.FLOAT_MAT2:b=
gl.uniformMatrix2fv;break;case h.FLOAT_MAT3:b=gl.uniformMatrix3fv;break;case h.FLOAT_MAT4:b=gl.uniformMatrix4fv;break;case h.FLOAT_VEC2:b=gl.uniform2fv;break;case h.FLOAT_VEC3:b=gl.uniform3fv;break;case h.FLOAT_VEC4:b=gl.uniform4fv;break;case h.UNSIGNED_INT:case h.INT:b=1==a.size?gl.uniform1i:gl.uniform1iv;break;case h.INT_VEC2:b=gl.uniform2iv;break;case h.INT_VEC3:b=gl.uniform3iv;break;case h.INT_VEC4:b=gl.uniform4iv;break;case h.SAMPLER_2D:case h.SAMPLER_3D:case h.SAMPLER_CUBE:case h.INT_SAMPLER_2D:case h.INT_SAMPLER_3D:case h.INT_SAMPLER_CUBE:case h.UNSIGNED_INT_SAMPLER_2D:case h.UNSIGNED_INT_SAMPLER_3D:case h.UNSIGNED_INT_SAMPLER_CUBE:b=
gl.uniform1i;break;default:b=gl.uniform1f}return b};Shader.fromURL=function(a,b,c){function d(){var a=new h.Shader(k,q),b;for(b in a)f[b]=a[b];f.ready=!0}var f=new h.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");f.ready=!1;var k=null,q=
null;HttpRequest(a,null,function(a){k=a;q&&d()});HttpRequest(b,null,function(a){q=a;k&&d()});return f};Shader.prototype.checkLink=function(){this._first_use=!1;if(!gl.getShaderParameter(this.vs_shader,gl.COMPILE_STATUS))throw"Vertex shader compile error: "+gl.getShaderInfoLog(this.vs_shader);if(!gl.getShaderParameter(this.fs_shader,gl.COMPILE_STATUS))throw"Fragment shader compile error: "+gl.getShaderInfoLog(this.fs_shader);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+
gl.getProgramInfoLog(this.program);this.extractShaderInfo()};Shader.prototype.bind=function(){var a=this.gl;Shader.use_async&&this._first_use&&(this.checkLink(),this._first_use=!1);a.useProgram(this.program);a._current_shader=this};Shader.prototype.getLocation=function(a){return this.uniformInfo[a]?this.uniformInfo[a].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;this._first_use&&this.checkLink();b.useProgram(this.program);b._current_shader=
this;for(var c in a)this.uniformInfo[c]&&this._setUniform(c,a[c]);return this};Shader.prototype.uniformsArray=function(a){var b=this.gl;this._first_use&&this.checkLink();b.useProgram(this.program);b._current_shader=this;for(var b=0,c=a.length;b<c;++b){var d=a[b],f;for(f in d)this._setUniform(f,d[f])}return this};Shader.prototype.setUniform=function(){return function(a,b){this.gl._current_shader!=this&&this.bind();var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(c.data.set(b),
b=c.data),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))}}();Shader.prototype._setUniform=function(){return function(a,b){this._first_use&&this.checkLink();var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(c.data.set(b),b=c.data),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))}}();Shader.prototype.draw=function(a,b,c){c=void 0===c?b==gl.LINES?"lines":"triangles":c;this.drawBuffers(a.vertexBuffers,c?a.indexBuffers[c]:null,
2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,d,f){f=void 0===f?b==gl.LINES?"lines":"triangles":f;this.drawBuffers(a.vertexBuffers,f?a.indexBuffers[f]:null,b,c,d)};var R=new Uint8Array(16),X=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,d,f){if(0!=f){var k=this.gl;this._first_use&&this.checkLink();k.useProgram(this.program);var h=0;R.set(X);for(var m in a){var l=a[m],n=l.attribute||m,p=this.attributes[n];null!=p&&l.buffer&&(R[p]=1,k.bindBuffer(k.ARRAY_BUFFER,
l.buffer),k.enableVertexAttribArray(p),k.vertexAttribPointer(p,l.buffer.spacing,l.buffer.gl_type,l.normalize,0,0),h=l.buffer.length/l.buffer.spacing)}a=0;0<d&&(a=d);b&&(h=b.buffer.length-a);0<f&&f<h&&(h=f);a*=b&&b.data?b.data.constructor.BYTES_PER_ELEMENT:1;for(n in this.attributes)p=this.attributes[n],R[p]||k.disableVertexAttribArray(this.attributes[n]);!h||b&&!b.buffer||(b?(k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,b.buffer),k.drawElements(c,h,b.buffer.gl_type,a),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null)):
k.drawArrays(c,a,h),k.draw_calls++);return this}};Shader._instancing_arrays=[];Shader.prototype.drawInstanced=function(a,b,c,d,f,k,q){if(0!==k){var m=this.gl;if(1==m.webgl_version&&!m.extensions.ANGLE_instanced_arrays)throw"instancing not supported";this._first_use&&this.checkLink();m.useProgram(this.program);var l=0;R.set(X);var n=a.vertexBuffers,p;for(p in n){var s=n[p],r=s.attribute||p,u=this.attributes[r];null!=u&&s.buffer&&(R[u]=1,m.bindBuffer(m.ARRAY_BUFFER,s.buffer),m.enableVertexAttribArray(u),
m.vertexAttribPointer(u,s.buffer.spacing,s.buffer.gl_type,s.normalize,0,0),l=s.buffer.length/s.buffer.spacing)}n=null;c&&(c.constructor===String?n=a.getIndexBuffer(c):c.constructor===h.Buffer&&(n=c));a=0;0<f&&(a=f);n&&(l=n.buffer.length-a);0<k&&k<l&&(l=k);a*=n&&n.data?n.data.constructor.BYTES_PER_ELEMENT:1;for(r in this.attributes)u=this.attributes[r],R[u]||m.disableVertexAttribArray(this.attributes[r]);f=m.extensions.ANGLE_instanced_arrays;k=u=0;for(var t in d){p=d[t];u=p.length;r=this.attributes[t];
if(null==r)return;var x=c=0;p.constructor===Array?(c=p[0].constructor===Number?1:p[0].length,x=c*p.length):(c=this.uniformInfo[t].type_length,x=p.length,u=x/c);s=Shader._instancing_arrays[k];if(!s||s.data.length<x)s=Shader._instancing_arrays[k]={data:new Float32Array(x),buffer:m.createBuffer()};s.uniform=t;s.element_size=c;if(p.constructor===Array)for(x=0;x<p.length;++x)s.data.set(p[x],x*c);else s.data.set(p);m.bindBuffer(m.ARRAY_BUFFER,s.buffer);m.bufferData(m.ARRAY_BUFFER,s.data,m.STREAM_DRAW);
if(16==c)for(c=0;4>c;++c)m.enableVertexAttribArray(r+c),m.vertexAttribPointer(r+c,4,m.FLOAT,!1,64,16*c),f?f.vertexAttribDivisorANGLE(r+c,1):m.vertexAttribDivisor(r+c,1);else m.enableVertexAttribArray(r),m.vertexAttribPointer(r,c,m.FLOAT,!1,4*c,0),f?f.vertexAttribDivisorANGLE(r,1):m.vertexAttribDivisor(r,1);k+=1}q&&(u=q);f?n?(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,n.buffer),f.drawElementsInstancedANGLE(b,l,n.buffer.gl_type,a,u),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null)):f.drawArraysInstancedANGLE(b,a,
l,u):n?(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,n.buffer),m.drawElementsInstanced(b,l,n.buffer.gl_type,a,u),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null)):m.drawArraysInstanced(b,a,l,u);for(b=0;b<k;++b)if(d=Shader._instancing_arrays[b],r=this.attributes[d.uniform],c=d.element_size,16==c)for(c=0;4>c;++c)m.disableVertexAttribArray(r+c),f?f.vertexAttribDivisorANGLE(r+c,0):m.vertexAttribDivisor(r+c,0);else m.enableVertexAttribArray(r),f?f.vertexAttribDivisorANGLE(r,0):m.vertexAttribDivisor(r,0);return this}};
Shader.expandImports=function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";return a.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,function(a){a=a.split('"')[1];if(c[a])return"//already imported: "+a+"\n";var f=b[a];c[a]=!0;return f?f+"\n":"//import code not found: "+a+"\n"})};Shader.dumpErrorToConsole=function(a,b,c){console.error(a);var d=null,d=-1!=a.indexOf("Fragment")?c:b;a=d.split("\n");for(var f in a)a[f]=f+"| "+a[f];console.groupCollapsed("Shader code");
console.log(a.join("\n"));console.groupEnd()};Shader.convertTo100=function(a,b){};Shader.convertTo300=function(a,b){};Shader.validateValue=function(a,b){if(null===a||void 0===a)return!1;switch(b.type){case h.INT:case h.FLOAT:case h.SAMPLER_2D:case h.SAMPLER_3D:case h.SAMPLER_CUBE:case h.INT_SAMPLER_2D:case h.INT_SAMPLER_3D:case h.INT_SAMPLER_CUBE:case h.UNSIGNED_INT_SAMPLER_2D:case h.UNSIGNED_INT_SAMPLER_3D:case h.UNSIGNED_INT_SAMPLER_CUBE:return isNumber(a);case h.INT_VEC2:case h.FLOAT_VEC2:return 2===
a.length;case h.INT_VEC3:case h.FLOAT_VEC3:return 3===a.length;case h.INT_VEC4:case h.FLOAT_VEC4:case h.FLOAT_MAT2:return 4===a.length;case h.FLOAT_MAT3:return 8===a.length;case h.FLOAT_MAT4:return 16===a.length}return!0};Shader.DEFAULT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec3 v_position;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";Shader.SCREEN_300_VERTEX_SHADER="#version 300 es\n\t\t\tprecision highp float;\n\t\t\tin vec3 a_vertex;\n\t\t\tin vec2 a_coord;\n\t\t\tout vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";
Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t";
Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.SCREEN_FLAT_FRAGMENT_SHADER=Shader.FLAT_FRAGMENT_SHADER;Shader.createFX=function(a,b,c){a=h.Shader.removeComments(a,!0);b=h.Shader.removeComments(b,!0);a={FX_CODE:a,FX_UNIFORMS:b||""};if(!c)return new h.Shader(h.Shader.SCREEN_VERTEX_SHADER,h.Shader.SCREEN_FRAGMENT_FX,a);c.updateShader(h.Shader.SCREEN_VERTEX_SHADER,h.Shader.SCREEN_FRAGMENT_FX,
a);return c};Shader.replaceCodeUsingContext=function(a,b){return a.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(a){a=a.replace(/[\{\}]/g,"");return b[a]||""})};Shader.removeComments=function(a,b){if(!a)return"";a=a.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,"");for(var c=a.split("\n"),d=[],f=0;f<c.length;++f){var k=c[f],h=k.indexOf("//");-1!=h&&(k=c[f].substr(0,h));k=k.trim();k.length&&d.push(k)}return d.join(b?"":"\n")};Shader.prototype.toViewport=function(a){var b=h.Mesh.getScreenQuad();
a&&this.uniforms(a);this.draw(b)};Shader.getScreenShader=function(a){a=a||r.gl;var b=a.shaders[":screen"];if(b)return b;b=a.shaders[":screen"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return b.uniforms({u_texture:0})};Shader.getFlatScreenShader=function(a){a=a||r.gl;var b=a.shaders[":flat_screen"];if(b)return b;b=a.shaders[":flat_screen"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);return b.uniforms({u_color:[1,1,1,1]})};Shader.getColoredScreenShader=
function(a){a=a||r.gl;var b=a.shaders[":colored_screen"];if(b)return b;b=a.shaders[":colored_screen"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return b.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new h.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad2"];return b?
b:a.shaders[":quad2"]=new h.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlendShader=function(a){a=a||r.gl;var b=a.shaders[":blend"];return b?b:a.shaders[":blend"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER)};Shader.getBlurShader=function(a){a=a||r.gl;var b=a.shaders[":blur"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.getCopyDepthShader=function(a){a=a||r.gl;var b=a.shaders[":copy_depth"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_EXT_frag_depth : enable\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;\n\t\t\t   gl_FragColor = vec4(1.0);\n\t\t\t}\n\t\t\t");return a.shaders[":copy_depth"]=b};Shader.getCubemapShowShader=
function(a){a=a||r.gl;var b=a.shaders[":show_cubemap"];if(b)return b;b=new h.Shader(Shader.DEFAULT_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = textureCube( u_texture, v_normal );\n\t\t\t}\n\t\t\t");b.uniforms({u_texture:0});return a.shaders[":show_cubemap"]=b};Shader.getPolarToCubemapShader=function(a){a=a||r.gl;var b=a.shaders[":polar_to_cubemap"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,
"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = normalize( vec3( uv - vec2(0.5), 0.5 ));\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t\tfloat u = atan(dir.x,dir.z) / 6.28318531;\n\t\t\t\tfloat v = (asin(dir.y) / 1.57079633) * 0.5 + 0.5;\n\t\t\t\tu = mod(u,1.0);\n\t\t\t\tv = mod(v,1.0);\n\t\t\t   gl_FragColor = texture2D( u_texture, vec2(u,v) );\n\t\t\t}\n\t\t\t");
return a.shaders[":polar_to_cubemap"]=b};Shader.getCubemapCopyShader=function(a){a=a||r.gl;var b=a.shaders[":copy_cubemap"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t");
return a.shaders[":copy_cubemap"]=b};Shader.getCubemapBlurShader=function(a){a=a||r.gl;var b=a.shaders[":blur_cubemap"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur_cubemap"]=b};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t/* fragCoord MUST BE IN PIXELS */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\t//return vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(a){a=a||r.gl;var b=a.shaders[":fxaa"];if(b)return b;var b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t"),c=vec2.fromValues(a.viewport_data[2],a.viewport_data[3]),d=vec2.fromValues(1/a.viewport_data[2],1/a.viewport_data[3]);b.setup=
function(){c[0]=a.viewport_data[2];c[1]=a.viewport_data[3];d[0]=1/a.viewport_data[2];d[1]=1/a.viewport_data[3];this.uniforms({u_viewportSize:c,u_iViewportSize:d})};return a.shaders[":fxaa"]=b};Shader.getFlatShader=function(a){a=a||r.gl;var b=a.shaders[":flat"];if(b)return b;b=new h.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);b.uniforms({u_color:[1,1,1,1]});return a.shaders[":flat"]=b};h.create=function(a){function b(a){if(!l.ignore_events){var c=l.mouse.buttons;h.augmentEvent(a,
k);a.eventType=a.eventType||a.type;var d=getTime();s.dragging=a.dragging;s.position[0]=a.canvasx;s.position[1]=a.canvasy;s.x=a.canvasx;s.y=a.canvasy;s.mousex=a.mousex;s.mousey=a.mousey;s.canvasx=a.canvasx;s.canvasy=a.canvasy;s.clientx=a.mousex;s.clienty=a.mousey;s.buttons=a.buttons;s.left_button=!!(s.buttons&h.LEFT_MOUSE_BUTTON_MASK);s.middle_button=!!(s.buttons&h.MIDDLE_MOUSE_BUTTON_MASK);s.right_button=!!(s.buttons&h.RIGHT_MOUSE_BUTTON_MASK);if("mousedown"==a.eventType){0==c&&(k.removeEventListener("mousemove",
b),c=k.ownerDocument,c.addEventListener("mousemove",b),c.addEventListener("mouseup",b));p=d;if(l.onmousedown)l.onmousedown(a);A.trigger(l,"mousedown")}else if("mousemove"==a.eventType){if(l.onmousemove)l.onmousemove(a);A.trigger(l,"mousemove",a)}else if("mouseup"==a.eventType){0==l.mouse.buttons&&(k.addEventListener("mousemove",b),c=k.ownerDocument,c.removeEventListener("mousemove",b),c.removeEventListener("mouseup",b));a.click_time=d-p;if(l.onmouseup)l.onmouseup(a);A.trigger(l,"mouseup",a)}else if("mousewheel"==
a.eventType||"wheel"==a.eventType||"DOMMouseScroll"==a.eventType){a.eventType="mousewheel";a.wheel="wheel"==a.type?-a.deltaY:null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;a.delta=void 0!==a.wheelDelta?a.wheelDelta/40:a.deltaY?-a.deltaY/3:0;if(l.onmousewheel)l.onmousewheel(a);A.trigger(l,"mousewheel",a)}else if("dragstart"==a.eventType){if(l.ondragstart)l.ondragstart(a);A.trigger(l,"dragstart",a)}if(l.onmouse)l.onmouse(a);if(!a.skip_preventDefault)return"mousemove"!=a.eventType&&a.stopPropagation(),
a.preventDefault(),!1}}function c(a){var b=a.srcEvent,c=document.createEvent("MouseEvent");c.initMouseEvent("wheel",!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);c.originalEvent=c;c.is_touch=!0;var d=!1;"pinchin"===a.additionalEvent?(c.deltaY=1,d=!0):"pinchout"===a.additionalEvent&&(c.deltaY=-1,d=!0);d&&(c.pinchScaling=0.0312*a.distance,b.target.dispatchEvent(c));b.preventDefault()}function d(a){var b=a.changedTouches,c=b[0],d="";if(!(l.ontouch&&!0===l.ontouch(a)||!0===
A.trigger(l,a.type,a)||!u||a.touches.length&&a.changedTouches[0].identifier!==a.touches[0].identifier||1<b)){switch(a.type){case "touchstart":d="mousedown";break;case "touchmove":d="mousemove";break;case "touchend":d="mouseup";break;default:return}b=document.createEvent("MouseEvent");b.initMouseEvent(d,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null);b.originalEvent=b;b.is_touch=!0;c.target.dispatchEvent(b);a.preventDefault()}}function f(a){a.eventType=a.type;l.ongesture&&
!1===l.ongesture(a)||!1!==A.trigger(l,a.type,a)&&a.preventDefault()}a=a||{};var k=null;if(a.canvas)if("string"==typeof a.canvas){if(k=document.getElementById(a.canvas),!k)throw"Canvas element not found: "+a.canvas;}else k=a.canvas;else{var q=null;a.container&&(q=a.container.constructor===String?document.querySelector(a.container):a.container);if(q&&!a.width){var m=q.getBoundingClientRect();a.width=m.width;a.height=m.height}k=createCanvas(a.width||800,a.height||600);q&&q.appendChild(k)}"alpha"in a||
(a.alpha=!1);var l=null,q=null;2==a.version?q=["webgl2","experimental-webgl2"]:1==a.version||void 0===a.version?q=["webgl","experimental-webgl"]:0===a.version&&(q=["webgl2","experimental-webgl2","webgl","experimental-webgl"]);if(!q)throw"Incorrect WebGL version, must be 1 or 2";m={alpha:void 0===a.alpha?!0:a.alpha,depth:void 0===a.depth?!0:a.depth,stencil:void 0===a.stencil?!0:a.stencil,antialias:void 0===a.antialias?!0:a.antialias,premultipliedAlpha:void 0===a.premultipliedAlpha?!0:a.premultipliedAlpha,
preserveDrawingBuffer:void 0===a.preserveDrawingBuffer?!0:a.preserveDrawingBuffer};for(a=0;a<q.length;++a){try{l=k.getContext(q[a],m)}catch(n){}if(l)break}if(!l){if(k.getContext("webgl"))throw"WebGL supported but not with those parameters";throw"WebGL not supported";}l.webgl_version="WebGL2RenderingContext"===l.constructor.name?2:1;r.gl=l;k.is_webgl=!0;k.gl=l;l.context_id=this.last_context_id++;l.extensions={};q=l.getSupportedExtensions();for(a=0;a<q.length;++a)l.extensions[q[a]]=l.getExtension(q[a]);
l.HIGH_PRECISION_FORMAT=1==l.webgl_version?l.extensions.OES_texture_half_float?h.HALF_FLOAT_OES:l.extensions.OES_texture_float?h.FLOAT:h.UNSIGNED_BYTE:h.HALF_FLOAT_OES;l.max_texture_units=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS);l._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):(l._viewport_func=l.viewport,l.viewport_data=new Float32Array([0,0,l.canvas.width,l.canvas.height]),l.viewport=function(a,b,c,d){var f=this.viewport_data;f[0]=a|0;f[1]=b|0;f[2]=c|0;f[3]=d|
0;this._viewport_func(a,b,c,d)},l.getViewport=function(a){return a?(a[0]=l.viewport_data[0],a[1]=l.viewport_data[1],a[2]=l.viewport_data[2],a[3]=l.viewport_data[3],a):new Float32Array(l.viewport_data)},l.setViewport=function(a,b){l.viewport_data.set(a);b&&(l.viewport_data[1]=this.drawingBufferHeight-a[1]-a[3]);this._viewport_func(a[0],l.viewport_data[1],a[2],a[3])});if(!h.reverse)for(a in h.reverse={},l)l[a]&&l[a].constructor===Number&&(h.reverse[l[a]]=a);if(void 0==window.glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";
var p=0;l.shaders={};l.textures={};l.meshes={};l.draw_calls=0;l.makeCurrent=function(){r.gl=this};l.execute=function(a){var b=r.gl;r.gl=this;a();r.gl=b};l.animate=function(a){function b(){if(!l.destroyed){f._requestFrame_id=c(b);var a=getTime(),h=0.001*(a-d);f.mouse&&(f.mouse.last_buttons=k);k=f.mouse.buttons;if(f.onupdate)f.onupdate(h);A.trigger(f,"update",h);f.ondraw&&(h=r.gl,r.gl=f,f.ondraw(),A.trigger(f,"draw"),r.gl=h);d=a}}if(!1===a)r.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=
null;else{var c=r.requestAnimationFrame,d=getTime(),f=this,k=0;this._requestFrame_id=c(b)}};l.destroy=function(){t&&(document.removeEventListener("keydown",t),document.removeEventListener("keyup",t));y&&(this.canvas.removeEventListener("mousedown",y),this.canvas.removeEventListener("mousemove",y),this.canvas.removeEventListener("mouseup",y),this.canvas.addEventListener("drag",y),this.canvas.addEventListener("dragstart",y),this.canvas.addEventListener("wheel",y));for(var a in this.shaders)this.shaders[a].delete(),
this.shaders[a]=null;this.shaders={};for(a in this.meshes)this.meshes[a].deleteBuffers(),this.meshes[a]=null;this.meshes={};for(a in this.textures)this.textures[a].delete(),this.textures[a]=null;this.textures={};this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;r.gl==this&&(r.gl=null)};var s=l.mouse={buttons:0,last_buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(a,
b,c,d,f){var k=this.y;f&&(k=l.canvas.height-k);return this.x>a&&this.x<a+c&&k>b&&k<b+d?!0:!1},isButtonPressed:function(a){if(a==h.LEFT_MOUSE_BUTTON)return this.buttons&h.LEFT_MOUSE_BUTTON_MASK;if(a==h.MIDDLE_MOUSE_BUTTON)return this.buttons&h.MIDDLE_MOUSE_BUTTON_MASK;if(a==h.RIGHT_MOUSE_BUTTON)return this.buttons&h.RIGHT_MOUSE_BUTTON_MASK},wasButtonPressed:function(a){var b=0;a==h.LEFT_MOUSE_BUTTON?b=h.LEFT_MOUSE_BUTTON_MASK:a==h.MIDDLE_MOUSE_BUTTON?b=h.MIDDLE_MOUSE_BUTTON_MASK:a==h.RIGHT_MOUSE_BUTTON&&
(b=h.RIGHT_MOUSE_BUTTON_MASK);return this.buttons&b&&!(this.last_buttons&b)}};l.captureMouse=function(a,c){k.addEventListener("mousedown",b);k.addEventListener("mousemove",b);k.addEventListener("drag",b);k.addEventListener("dragstart",b);a&&(k.addEventListener("mousewheel",b,!1),k.addEventListener("wheel",b,!1));k.addEventListener("contextmenu",function(a){a.preventDefault();return!1});c&&this.captureTouch(!0)};var y=b,u=!1;"undefined"!==typeof Hammer&&(a=new Hammer.Manager(k),q=new Hammer.Pinch({threshold:0.3}),
a&&q&&(a.add(q),a.on("pinch",c)));l.captureTouch=function(a){u=a;k.addEventListener("touchstart",d,!0);k.addEventListener("touchmove",d,!0);k.addEventListener("touchend",d,!0);k.addEventListener("touchcancel",d,!0);k.addEventListener("gesturestart",f);k.addEventListener("gesturechange",f);k.addEventListener("gestureend",f)};l.keys={};var t=null;l.captureKeys=function(a,b){function c(b){var d=a;b.eventType=b.type;var f=b.target.nodeName.toLowerCase();if("input"!==f&&"textarea"!==f&&"select"!==f&&"true"!==
b.target.contentEditable){b.character=String.fromCharCode(b.keyCode).toLowerCase();var f=!1,k=h.mapKeyCode(b.keyCode);k||(k=b.character);var m=b.altKey||b.ctrlKey||b.metaKey;m||(k&&(l.keys[k]="keydown"==b.type),f=l.keys[b.keyCode],l.keys[b.keyCode]="keydown"==b.type);if(f!=l.keys[b.keyCode]||m){if("keydown"==b.type&&l.onkeydown)l.onkeydown(b);else if("keyup"==b.type&&l.onkeyup)l.onkeyup(b);A.trigger(l,b.type,b)}if(l.onkey)l.onkey(b);d&&(b.isChar||h.blockable_keys[b.keyIdentifier||b.key])&&b.preventDefault()}}
t||(l.keys={},document.addEventListener("keydown",c),document.addEventListener("keyup",c),t=c)};l.gamepads=null;l.captureGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator))};l.getGamepads=function(a){var b=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(b){b=b.call(navigator);this.gamepads||(this.gamepads=[]);for(var c=0;4>c;c++){var d=b[c];if(d&&!a){var f=d,k=f.xbox||{axes:[],buttons:{},
hat:""};k.axes.lx=f.axes[0];k.axes.ly=f.axes[1];k.axes.rx=f.axes[2];k.axes.ry=f.axes[3];k.axes.triggers=f.axes[4];for(var h=0;h<f.buttons.length;h++)switch(h){case 0:k.buttons.a=f.buttons[h].pressed;break;case 1:k.buttons.b=f.buttons[h].pressed;break;case 2:k.buttons.x=f.buttons[h].pressed;break;case 3:k.buttons.y=f.buttons[h].pressed;break;case 4:k.buttons.lb=f.buttons[h].pressed;break;case 5:k.buttons.rb=f.buttons[h].pressed;break;case 6:k.buttons.lt=f.buttons[h].pressed;break;case 7:k.buttons.rt=
f.buttons[h].pressed;break;case 8:k.buttons.back=f.buttons[h].pressed;break;case 9:k.buttons.start=f.buttons[h].pressed;break;case 10:k.buttons.ls=f.buttons[h].pressed;break;case 11:k.buttons.rs=f.buttons[h].pressed;break;case 12:f.buttons[h].pressed&&(k.hat+="up");break;case 13:f.buttons[h].pressed&&(k.hat+="down");break;case 14:f.buttons[h].pressed&&(k.hat+="left");break;case 15:f.buttons[h].pressed&&(k.hat+="right");break;case 16:k.buttons.home=f.buttons[h].pressed}f.xbox=k}if(d&&!d.prev_buttons){d.prev_buttons=
new Uint8Array(32);f=new CustomEvent("gamepadconnected");f.eventType=f.type;f.gamepad=d;if(this.ongamepadconnected)this.ongamepadconnected(f);A.trigger(l,"gamepadconnected",f)}if(d)for(k=0;k<d.buttons.length;++k){h=d.buttons[k];h.was_pressed=!1;if(h.pressed&&!d.prev_buttons[k]){h.was_pressed=!0;f=new CustomEvent("gamepadButtonDown");f.eventType=f.type;f.button=h;f.which=k;f.gamepad=d;if(l.onbuttondown)l.onbuttondown(f);A.trigger(l,"buttondown",f)}else if(!h.pressed&&d.prev_buttons[k]){f=new CustomEvent("gamepadButtonUp");
f.eventType=f.type;f.button=h;f.which=k;f.gamepad=d;if(l.onbuttondown)l.onbuttondown(f);A.trigger(l,"buttonup",f)}d.prev_buttons[k]=h.pressed?1:0}}return this.gamepads=b}};l.fullscreen=function(){var a=this.canvas;a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.error("Fullscreen not supported")};l.snapshot=function(a,b,c,d,f){var k=createCanvas(c,d),h=k.getContext("2d"),m=h.getImageData(0,0,k.width,
k.height),q=new Uint8Array(c*d*4);l.readPixels(a,b,k.width,k.height,l.RGBA,l.UNSIGNED_BYTE,q);m.data.set(q);h.putImageData(m,0,0);if(f)return k;a=createCanvas(c,d);h=a.getContext("2d");h.translate(0,d);h.scale(1,-1);h.drawImage(k,0,0);return a};var x={};l.loadTexture=function(a,b,c){if(this.textures[a])return this.textures[a];if(x[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=h.Texture.fromImage(this,b);a.img=this;l.textures[this.url]=a;delete x[this.url];c&&c(a)};d.src=a;x[a]=
!0;return null};l.drawTexture=function(){var a=mat3.create(),b=vec2.create(),c=vec2.create(),d=vec4.create(),f=vec4.fromValues(1,1,1,1),k=vec2.create(),h={u_texture:0,u_position:b,u_color:f,u_size:c,u_texture_area:d,u_viewport:k,u_transform:a};return function(a,f,m,q,n,p,s,r,t,u,v){b[0]=f;b[1]=m;void 0===q&&(q=a.width);void 0===n&&(n=a.height);c[0]=q;c[1]=n;void 0===p&&(p=0);void 0===s&&(s=0);void 0===r&&(r=a.width);void 0===t&&(t=a.height);d[0]=p/a.width;d[1]=s/a.height;d[2]=(p+r)/a.width;d[3]=(s+
t)/a.height;k[0]=this.viewport_data[2];k[1]=this.viewport_data[3];u=u||Shader.getPartialQuadShader(this);f=Mesh.getScreenQuad(this);a.bind(0);u.uniforms(h);v&&u.uniforms(v);u.draw(f,l.TRIANGLES)}}();l.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault();l.context_lost=!0;if(l.onlosecontext)l.onlosecontext(a)},!1);l.reset=function(){l.viewport(0,0,this.canvas.width,this.canvas.height);l.disable(l.BLEND);l.disable(l.CULL_FACE);l.disable(l.DEPTH_TEST);l.frontFace(l.CCW);l._current_texture_drawto=
null;l._current_fbo_color=null;l._current_fbo_depth=null};l.dump=function(){console.log("userAgent: ",navigator.userAgent);console.log("Supported extensions:");var a=l.getSupportedExtensions();console.log(a.join(","));a="VENDOR VERSION MAX_VERTEX_ATTRIBS MAX_VARYING_VECTORS MAX_VERTEX_UNIFORM_VECTORS MAX_VERTEX_TEXTURE_IMAGE_UNITS MAX_FRAGMENT_UNIFORM_VECTORS MAX_TEXTURE_SIZE MAX_TEXTURE_IMAGE_UNITS".split(" ");console.log("WebGL info:");for(var b in a)console.log(" * "+a[b]+": "+l.getParameter(l[a[b]]));
console.log("*************************************************")};l.reset();return l};h.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",33:"PAGEUP",34:"PAGEDOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};h.dragging=!1;h.last_pos=[0,0];h.augmentEvent=function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.clientX-c.left;a.mousey=a.clientY-c.top;
a.canvasx=a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;a.is_touch&&(gl.mouse.buttons=a.which);document.pointerLockElement===b&&(a.canvasx=a.mousex=0.5*c.width,a.canvasy=a.mousey=0.5*c.height);"mousedown"==a.type?this.dragging=!0:"mousemove"!=a.type&&"mouseup"==a.type&&0==a.buttons&&(this.dragging=!1);void 0===a.movementX||a.is_touch||h.isMobile()?(a.deltax=a.mousex-this.last_pos[0],a.deltay=a.mousey-this.last_pos[1]):(a.deltax=a.movementX,a.deltay=a.movementY);this.last_pos[0]=a.mousex;
this.last_pos[1]=a.mousey;a.dragging=this.dragging;a.leftButton=!!(gl.mouse.buttons&h.LEFT_MOUSE_BUTTON_MASK);a.middleButton=!!(gl.mouse.buttons&h.MIDDLE_MOUSE_BUTTON_MASK);a.rightButton=!!(gl.mouse.buttons&h.RIGHT_MOUSE_BUTTON_MASK);a.buttons_mask=0;a.leftButton&&(a.buttons_mask=1);a.middleButton&&(a.buttons_mask|=2);a.rightButton&&(a.buttons_mask|=4);a.isButtonPressed=function(a){return this.buttons_mask&1<<a}};h.isMobile=function(){return void 0!==this.mobile?this.mobile:r.navigator?navigator.userAgent.match(/iPhone/i)||
navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/SamsungBrowser/i)||navigator.userAgent.match(/Mobile\ VR/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1};var A=r.LEvent=h.LEvent={bind:function(a,b,c,d){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";var f=a.__levents;f||(Object.defineProperty(a,"__levents",{value:{},
enumerable:!1}),f=a.__levents);f.hasOwnProperty(b)?f[b].push([c,d]):f[b]=[[c,d]];if(a.onLEventBinded)a.onLEventBinded(b,c,d)},unbind:function(a,b,c,d){if(!a)throw"cannot unbind event to null";if(!c)throw"cannot unbind from null callback";if(a.constructor===String)throw"cannot bind event to a string";var f=a.__levents;if(f&&f.hasOwnProperty(b)){for(var k=0,h=f[b].length;k<h;++k){var m=f[b][k];if(m[0]===c&&m[1]===d){f[b].splice(k,1);break}}0==f[b].length&&delete f[b];if(a.onLEventUnbinded)a.onLEventUnbinded(b,
c,d)}},unbindAll:function(a,b,c){if(!a)throw"cannot unbind events in null";var d=a.__levents;if(d){if(a.onLEventUnbindAll)a.onLEventUnbindAll(b,c);if(b)for(var f in d){a=d[f];for(var k=a.length-1;0<=k;--k)a[k][1]!=b||c&&c!==a[k][0]||a.splice(k,1)}else delete a.__levents}},unbindAllEvent:function(a,b){if(!a)throw"cannot unbind events in null";var c=a.__levents;if(c&&(delete c[b],a.onLEventUnbindAll))a.onLEventUnbindAll(b,target_instance,callback)},isBind:function(a,b,c,d){if(!a)throw"LEvent cannot have null as instance";
if(a=a.__levents){if(!a.hasOwnProperty(b))return!1;for(var f=0,k=a[b].length;f<k;++f){var h=a[b][f];if(h[0]===c&&h[1]===d)return!0}return!1}},hasBind:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;return c&&c.hasOwnProperty(b)&&c[b].length?!0:!1},hasBindTo:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;if(!c)return!1;for(var d in c)for(var f=c[d],k=0;k<f.length;++k)if(f[k][1]===b)return!0;return!1},trigger:function(a,b,c,d,f){if(!a)throw"cannot trigger event from null";
if(a.constructor===String)throw"cannot bind event to a string";a=a.__levents;if(!a||!a.hasOwnProperty(b))return!1;a=a[b];if(d)for(d=a.length-1;0<=d;--d){var k=a[d];if(f){if(k&&!0===k[0].apply(k[1],c))return!0}else if(k&&!0===k[0].call(k[1],b,c))return!0}else{d=0;for(var h=a.length;d<h;++d)if(k=a[d],f){if(k&&!0===k[0].apply(k[1],c))return!0}else if(k&&!0===k[0].call(k[1],b,c))return!0}return!1},triggerArray:function(a,b,c,d,f){for(var k=!1,h=0,m=a.length;h<m;++h){var l=a[h];if(!l)throw"cannot trigger event from null";
if(l.constructor===String)throw"cannot bind event to a string";if((l=l.__levents)&&l.hasOwnProperty(b))if(d)for(var n=l[b].length-1;0<=n;--n){var p=l[b][n];if(f){if(!0===p[0].apply(p[1],c)){k=!0;break}}else if(!0===p[0].call(p[1],b,c)){k=!0;break}}else for(var n=0,s=l[b].length;n<s;++n)if(p=l[b][n],f){if(!0===p[0].apply(p[1],c)){k=!0;break}}else if(!0===p[0].call(p[1],b,c)){k=!0;break}}return k},extendObject:function(a){a.bind=function(a,c,d){return A.bind(this,a,c,d)};a.trigger=function(a,c){return A.trigger(this,
a,c)};a.unbind=function(a,c,d){return A.unbind(this,a,c,instance)};a.unbindAll=function(a,c){return A.unbindAll(this,a,c)}},extendClass:function(a){this.extendObject(a.prototype)}};r.CLIP_INSIDE=h.CLIP_INSIDE=0;r.CLIP_OUTSIDE=h.CLIP_OUTSIDE=1;r.CLIP_OVERLAP=h.CLIP_OVERLAP=2;r.geo={last_t:-1,createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},planeFromTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(d,f,k,h){vec3.sub(a,k,f);vec3.sub(b,
h,f);vec3.cross(c,a,b);vec3.normalize(c,c);d[0]=c[0];d[1]=c[1];d[2]=c[2];d[3]=-vec3.dot(f,c);return d}}(),computeTriangleNormal:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(d,f,k,h){vec3.sub(a,k,f);vec3.sub(b,h,f);vec3.cross(c,a,b);vec3.normalize(c,c);d[0]=c[0];d[1]=c[1];d[2]=c[2];return d}}(),distancePointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*
b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnLine:function(){var a=vec3.create(),b=vec3.create();return function(c,d,f,k){k=k||vec3.create();vec3.sub(a,c,d);vec3.sub(b,f,d);c=vec3.dot(a,b)/vec3.dot(b,b);k[0]=d[0]+c*b[0];k[1]=d[1]+c*b[1];k[2]=d[2]+c*b[2];return k}}(),project2DPointOnLine:function(a,b,c,d){d=d||vec2.create();a=vec2.fromValues(a[0]-b[0],a[1]-b[1]);c=vec2.fromValues(c[0]-b[0],c[1]-b[1]);a=vec2.dot(a,c)/vec2.dot(c,c);d[0]=b[0]+a*c[0];d[1]=b[1]+a*c[1];return d},closestPointToSegment:function(){var a=
vec3.create(),b=vec3.create();return function(c,d,f,k){k=k||vec3.create();vec3.sub(a,c,d);vec3.sub(b,f,d);c=vec3.dot(a,b)/vec3.dot(b,b);c=Math.min(1,Math.max(0,c));k[0]=d[0]+c*b[0];k[1]=d[1]+c*b[1];k[2]=d[2]+c*b[2];return k}}(),projectPointOnPlane:function(){var a=vec3.create();return function(b,c,d,f){f=f||vec3.create();vec3.sub(a,b,c);c=vec3.dot(a,d);vec3.scale(a,d,c);return vec3.sub(f,b,a)}}(),isPointInsideTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),
f=vec3.create(),k=vec3.create();return function(h,m,l,n){vec3.sub(a,m,h);vec3.sub(b,l,h);vec3.sub(c,n,h);vec3.cross(d,b,c);vec3.cross(f,c,a);vec3.cross(k,a,b);return 0>vec3.dot(d,f)||0>vec3.dot(d,k)?!1:!0}}(),reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,d,f){c=vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,b);if(Math.abs(d)<
EPSILON)return!1;d=this.last_t=c/d;if(0>d)return!1;f&&vec3.add(f,a,vec3.scale(f,b,d));return!0},testSegmentPlane:function(){var a=vec3.create();return function(b,c,d,f,k){d=vec3.dot(d,f)-vec3.dot(f,b);c=vec3.sub(a,c,b);f=vec3.dot(f,c);if(Math.abs(f)<EPSILON)return!1;f=this.last_t=d/f;if(0>f||1<f)return!1;k&&vec3.add(k,b,vec3.scale(k,c,f));return!0}}(),testRaySphere:function(){var a=vec3.create();return function(b,c,d,f,k,h){var m=vec3.subtract(a,b,d),l=c[0]*c[0]+c[1]*c[1]+c[2]*c[2];d=2*m[0]*c[0]+
2*m[1]*c[1]+2*m[2]*c[2];f=d*d-4*l*(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]-f*f);if(0>f)return!1;if(k){f=Math.sqrt(f);m=1/(2*l);l=(-d+f)*m;d=(-d-f)*m;d=l<d?l:d;if(void 0!==h&&d>h)return!1;this.last_t=d;vec3.add(k,b,vec3.scale(k,c,d))}return!0}}(),hitTestTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create();return function(k,h,m,l,n,p){vec3.subtract(a,l,m);vec3.subtract(b,n,m);vec3.cross(c,a,b);vec3.normalize(c,c);l=vec3.dot(c,vec3.subtract(d,m,k))/vec3.dot(c,
h);if(0<l){vec3.add(f,k,vec3.scale(d,h,l));var s=vec3.subtract(d,d,m);m=vec3.dot(b,b);n=vec3.dot(b,a);var r=vec3.dot(b,s),u=vec3.dot(a,a),s=vec3.dot(a,s),t=m*u-n*n,u=(u*r-n*s)/t;m=(m*s-n*r)/t;if(0<=u&&0<=m&&1>=u+m)return this.last_t=l,p&&vec3.add(p,k,vec3.scale(d,h,l)),!0}return!1}}(),testRayCylinder:function(a,b,c,d,f,k){var h=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));var m=0;b=vec3.subtract(vec3.create(),d,c);var l=vec3.subtract(vec3.create(),h,c);c=vec3.subtract(vec3.create(),
a,h);d=vec3.dot(l,b);a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>d&&0>d+a||d>b&&d+a>b)return!1;var n=vec3.dot(c,c),p=vec3.dot(l,c),m=b*n-a*a;f=vec3.dot(l,l)-f*f;var s=b*f-d*d;if(Math.abs(m)<EPSILON){if(0<s)return!1;k&&vec3.add(k,h,vec3.scale(k,c,0>d?-p/n:d>b?(a-p)/n:0));return!0}l=b*p-a*d;s=l*l-m*s;if(0>s)return!1;m=(-l-Math.sqrt(s))/m;if(0>m||1<m)return!1;if(0>d+m*a){if(0>=a)return!1;m=-d/a;k&&vec3.add(k,h,vec3.scale(k,c,m));return 0>=f+2*m*(p+m*n)}if(d+m*a>b){if(0<=a)return!1;m=(b-d)/a;k&&vec3.add(k,h,
vec3.scale(k,c,m));return 0>=f+b-2*d+m*(2*(p-a)+m*n)}this.last_t=m;k&&vec3.add(k,h,vec3.scale(k,c,m));return!0},testRayBox:function(){var a=new Float32Array(3),b=new Float32Array(3),c=new Float32Array(3);return function(d,f,k,h,m,l){l=l||Number.MAX_VALUE;var n=!0,p=0;a.fill(0);c.fill(0);b.fill(0);for(p=0;3>p;++p)d[p]<k[p]?(a[p]=1,b[p]=k[p],n=!1):d[p]>h[p]?(a[p]=0,b[p]=h[p],n=!1):a[p]=2;if(n)return this.last_t=0,m&&vec3.copy(m,d),!0;for(p=0;3>p;++p)c[p]=2!=a[p]&&0!=f[p]?(b[p]-d[p])/f[p]:-1;n=0;for(p=
1;3>p;p++)c[n]<c[p]&&(n=p);if(0>c[n]||c[n]>l)return!1;this.last_t=c[n];for(p=0;3>p;++p)if(n!=p){l=d[p]+c[n]*f[p];if(l<k[p]||l>h[p])return!1;m&&(m[p]=l)}else m&&(m[p]=b[p]);return!0}}(),testRayBBox:function(){var a=mat4.create(),b=vec3.create(),c=vec3.create();return function(d,f,k,h,m,l,n){if(!d||!f||!k)throw"parameters missing";h&&(mat4.invert(a,h),vec3.add(b,d,f),d=vec3.transformMat4(c,d,a),vec3.transformMat4(b,b,a),vec3.sub(b,b,d),f=vec3.normalize(b,b));d=this.testRayBox(d,f,k.subarray(6,9),k.subarray(9,
12),m,l);!n&&h&&m&&vec3.transformMat4(m,m,h);return d}}(),testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(c=BBox.getMax(b),geo.testPointBBox(c,a));return!0},testSphereBBox:function(a,b,c){for(var d=0,f=BBox.getMin(c),k=BBox.getMax(c),h=0;3>h;++h)a[h]<f[h]?(c=a[h]-
f[h],d+=c*c):a[h]>k[h]&&(c=a[h]-k[h],d+=c*c);return d<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,d,f,k){b=vec3.subtract(vec3.create(),b,a);d=vec3.subtract(vec3.create(),d,c);var h=vec3.subtract(vec3.create(),a,c),m=vec3.dot(b,b),l=vec3.dot(b,d),n=vec3.dot(d,d),p=vec3.dot(b,h),s=vec3.dot(d,h),r=m*n-l*l,u;r<EPSILON?(u=0,m=l>n?p/l:s/n):(u=(l*s-n*p)/r,m=(m*s-l*p)/r);f&&vec3.add(f,a,vec3.scale(vec3.create(),b,u));k&&vec3.add(k,c,vec3.scale(vec3.create(),d,m));a=vec3.add(vec3.create(),h,vec3.subtract(vec3.create(),
vec3.scale(vec3.create(),b,u),vec3.scale(vec3.create(),d,m)));return vec3.length(a)},extractPlanes:function(a,b){function c(a){var c=b.subarray(a,a+3),c=vec3.length(c);0!==c&&(c=1/c,b[a]*=c,b[a+1]*=c,b[a+2]*=c,b[a+3]*=c)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],12);c(12);b.set([a[3]-a[2],
a[7]-a[6],a[11]-a[10],a[15]-a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,b){var c=0,d=0,c=planeBoxOverlap(a.subarray(0,4),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(4,8),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(8,12),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(12,16),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(16,
20),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(20,24),b);return c==CLIP_OUTSIDE?CLIP_OUTSIDE:0==d+c?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,b,c){var d,f=!1;d=distanceToPlane(a.subarray(0,4),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(4,8),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(8,12),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(12,16),b);if(d<
-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(16,20),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(20,24),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);return f?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,b){for(var c=!1,d=-1,f=a.length,k=f-1;++d<f;k=d)(a[d][1]<=b[1]&&b[1]<a[k][1]||a[k][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[k][0]-a[d][0])*(b[1]-a[d][1])/(a[k][1]-a[d][1])+a[d][0]&&(c=!c);return c}};r.BBox=h.BBox={center:0,halfsize:3,
min:6,max:9,radius:12,data_length:13,corners:[vec3.fromValues(1,1,1),vec3.fromValues(1,1,-1),vec3.fromValues(1,-1,1),vec3.fromValues(1,-1,-1),vec3.fromValues(-1,1,1),vec3.fromValues(-1,1,-1),vec3.fromValues(-1,-1,1),vec3.fromValues(-1,-1,-1)],create:function(){return new Float32Array(13)},clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},fromMinMax:function(a,b){var c=this.create();
this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,b){var c=this.create();this.setCenterHalfsize(c,a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=a.subarray(6,9),d=a.subarray(9,12);c[0]=b[0];c[1]=b[1];c[2]=b[2];d.set(c);for(var f=3,k=b.length;f<k;f+=3){var h=b[f],m=b[f+1],l=b[f+2];h<c[0]?c[0]=h:h>d[0]&&(d[0]=h);m<c[1]?c[1]=m:m>d[1]&&(d[1]=m);l<c[2]?c[2]=l:l>d[2]&&(d[2]=l)}a[0]=0.5*(c[0]+d[0]);a[1]=0.5*(c[1]+
d[1]);a[2]=0.5*(c[2]+d[2]);a[3]=d[0]-a[0];a[4]=d[1]-a[1];a[5]=d[2]-a[2];a[12]=Math.sqrt(a[3]*a[3]+a[4]*a[4]+a[5]*a[5]);return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];var d=a.subarray(3,6);vec3.sub(d,c,b);vec3.scale(d,d,0.5);a[0]=c[0]-d[0];a[1]=c[1]-d[1];a[2]=c[2]-d[2];a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,d){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];a[6]=a[0]-a[3];a[7]=a[1]-a[4];a[8]=a[2]-
a[5];a[9]=a[0]+a[3];a[10]=a[1]+a[4];a[11]=a[2]+a[5];a[12]=d?d:vec3.length(c);return a},transformMat4:function(){for(var a=0,b=0,c=0,d=new Float32Array(24),f=[],k=0;24>k;k+=3)f.push(d.subarray(k,k+3));return function(k,h,l){var n=h[0],p=h[1],s=h[2];a=h[3];b=h[4];c=h[5];h=this.corners;for(var r=0;8>r;++r){var u=h[r],t=f[r];t[0]=a*u[0]+n;t[1]=b*u[1]+p;t[2]=c*u[2]+s;mat4.multiplyVec3(t,l,t)}return this.setFromPoints(k,d)}}(),getCorners:function(a,b){var c=a.subarray(3,6),d=null;b?(b.set(this.corners),
d=b):d=new Float32Array(this.corners);for(var f=0;8>f;++f){var k=d.subarray(3*f,3*f+3);vec3.multiply(k,c,k);vec3.add(k,k,a)}return d},merge:function(a,b,c){var d=a.subarray(6,9),f=a.subarray(9,12);vec3.min(d,b.subarray(6,9),c.subarray(6,9));vec3.max(f,b.subarray(9,12),c.subarray(9,12));return BBox.setMinMax(a,d,f)},extendToPoint:function(a,b){b[0]<a[6]?a[6]=b[0]:b[0]>a[9]&&(a[9]=b[0]);b[1]<a[7]?a[7]=b[1]:b[1]>a[10]&&(a[10]=b[1]);b[2]<a[8]?a[8]=b[2]:b[2]>a[11]&&(a[11]=b[2]);var c=a.subarray(6,9),d=
a.subarray(9,12),c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},clampPoint:function(a,b,c){a[0]=Math.clamp(c[0],b[0]-b[3],b[0]+b[3]);a[1]=Math.clamp(c[1],b[1]-b[4],b[1]+b[4]);a[2]=Math.clamp(c[2],b[2]-b[5],b[2]+b[5])},isPointInside:function(a,b){return a[0]-a[3]>b[0]||a[1]-a[4]>b[1]||a[2]-a[5]>b[2]||a[0]+a[3]<b[0]||a[1]+a[4]<b[1]||a[2]+a[5]<b[2]?!1:!0},getCenter:function(a){return a.subarray(0,3)},getHalfsize:function(a){return a.subarray(3,
6)},getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,12)},getRadius:function(a){return a[12]}};r.distanceToPlane=h.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};r.planeBoxOverlap=h.planeBoxOverlap=function(a,b){var c=a[3],d=Math.abs(b[3]*a[0])+Math.abs(b[4]*a[1])+Math.abs(b[5]*a[2]),c=vec3.dot(a,b)+c;return c<=-d?CLIP_OUTSIDE:c<=d?CLIP_OVERLAP:CLIP_INSIDE};r.Octree=h.Octree=function(a,b,c){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a,
b,c),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=0.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=0.01;Octree.OCTREE_MIN_MARGIN=0.1;Octree.NEAREST=0;Octree.FIRST=1;Octree.ALL=2;Octree.prototype.buildFromMesh=function(a,b,c){this.total_nodes=this.total_depth=0;b=b||0;var d=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=a.data;c||(c=a?a.length:d.length/3);var f=null;this.root=f=a?this.computeAABBFromIndices(d,a,b,c):this.computeAABB(d);this.total_nodes=
1;this.total_triangles=a?a.length/3:d.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var k=vec3.create();vec3.scale(k,f.size,Octree.OCTREE_MARGIN_RATIO);k[0]<Octree.OCTREE_MIN_MARGIN&&(k[0]=Octree.OCTREE_MIN_MARGIN);k[1]<Octree.OCTREE_MIN_MARGIN&&(k[1]=Octree.OCTREE_MIN_MARGIN);k[2]<Octree.OCTREE_MIN_MARGIN&&(k[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(f.min,f.min,k);vec3.add(f.max,f.max,k);f.faces=[];f.inside=0;k=b+c;if(a)for(;b<k;b+=3){var h=new Float32Array([d[3*
a[b]],d[3*a[b]+1],d[3*a[b]+2],d[3*a[b+1]],d[3*a[b+1]+1],d[3*a[b+1]+2],d[3*a[b+2]],d[3*a[b+2]+1],d[3*a[b+2]+2],b/3]);Octree.isValidFace(h)&&this.addToNode(h,f,0)}else for(b*=3;b<3*c;b+=9)h=new Float32Array(10),h.set(d.subarray(b,b+9)),h[9]=b/9,Octree.isValidFace(h)&&this.addToNode(h,f,0);return f};Octree.isValidFace=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(d){var f=d.subarray(0,3),k=d.subarray(3,6);d=d.subarray(6,9);vec3.sub(a,k,f);vec3.sub(b,d,f);vec3.cross(c,
a,b);return 0<vec3.length(c)}}();Octree.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){for(var d=this.computeAABB(a),f=!1,k=0;k<b.c.length;++k){var h=b.c[k];if(Octree.isInsideAABB(d,h)){this.addToNode(a,h,c+1);f=!0;break}}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<Octree.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var m=b.faces.concat();b.faces=null;for(k=
0;k<m.length;++k){a=m[k];for(var d=this.computeAABB(a),f=!1,l=0;l<b.c.length;++l)if(h=b.c[l],Octree.isInsideAABB(d,h)){this.addToNode(a,h,c+1);f=!0;break}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(a){a.c=[];for(var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-a.min[1]),0.5*(a.max[2]-a.min[2])],c=0;c<this.octree_pos_ref.length;++c){var d=this.octree_pos_ref[c],
f={};this.total_nodes+=1;f.min=[a.min[0]+b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];f.max=[f.min[0]+b[0],f.min[1]+b[1],f.min[2]+b[2]];f.faces=null;f.inside=0;a.c.push(f)}};Octree.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array(b),d=3;d<a.length-1;d+=3)for(var f=0;3>f;f++)b[f]>a[d+f]&&(b[f]=a[d+f]),c[f]<a[d+f]&&(c[f]=a[d+f]);return{min:b,max:c,size:vec3.sub(vec3.create(),c,b)}};Octree.prototype.computeAABBFromIndices=function(a,b,c,d){c=c||0;
d=d||b.length;for(var f=b[c],k=new Float32Array([a[3*f],a[3*f+1],a[3*f+2]]),h=new Float32Array([a[3*f],a[3*f+1],a[3*f+2]]),m=c+1;m<c+d;++m)for(var f=3*b[m],l=0;3>l;l++)k[l]>a[f+l]&&(k[l]=a[f+l]),h[l]<a[f+l]&&(h[l]=a[f+l]);return{min:k,max:h,size:vec3.sub(vec3.create(),h,k)}};Octree.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;for(var b=1,c=[],d=a.c,f=0;f<d.length;++f)d[f].inside&&(c.push(d[f]),b+=this.trim(d[f]));a.c=c;return b};Octree.prototype.testRay=function(){var a=vec3.create(),
b=vec3.create(),c=vec3.create(),d=vec3.create();return function(f,k,h,m,l,n){n=n||Octree.NEAREST;if(!this.root)throw"Error: octree not build";a.set(f);b.set(k);c.set(this.root.min);d.set(this.root.max);h=Octree.hitTestBox(a,b,c,d);if(!h)return null;h=Octree.testRayInNode(this.root,a,b,l,n);if(null==h)return null;if(n==Octree.ALL)return h;k=vec3.scale(vec3.create(),k,h.t);vec3.add(k,k,f);h.pos=k;return h}}();Octree.testRayInNode=function(a,b,c,d,f){var k=null,h=null;if(a.faces)for(var m=0,l=a.faces.length;m<
l;++m){var n=a.faces[m],k=Octree.hitTestTriangle(b,c,n.subarray(0,3),n.subarray(3,6),n.subarray(6,9),d);if(null!=k){if(f==Octree.FIRST)return k;f==Octree.ALL?(h||(h=[]),h.push(k)):(k.face=n,h?h.mergeWith(k):h=k)}}var l=vec3.create(),n=vec3.create(),p;if(a.c)for(m=0;m<a.c.length;++m)if(p=a.c[m],l.set(p.min),n.set(p.max),k=Octree.hitTestBox(b,c,l,n),null!=k&&!(f!=Octree.ALL&&h&&k.t>h.t)&&(k=Octree.testRayInNode(p,b,c,d,f),null!=k)){if(f==Octree.FIRST)return k;f==Octree.ALL?(h||(h=[]),h.push(k)):h?h.mergeWith(k):
h=k}return h};Octree.prototype.testSphere=function(a,b){a=vec3.clone(a);if(!this.root)throw"Error: octree not build";var c=b*b;return Octree.testSphereBox(a,c,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,a,c):!1};Octree.testSphereInNode=function(a,b,c){if(a.faces)for(var d=0,f=a.faces.length;d<f;++d){var k=a.faces[d];if(Octree.testSphereTriangle(b,c,k.subarray(0,3),k.subarray(3,6),k.subarray(6,9)))return!0}var f=vec3.create(),k=vec3.create(),h;if(a.c)for(d=
0;d<a.c.length;++d)if(h=a.c[d],f.set(h.min),k.set(h.max),Octree.testSphereBox(b,c,f,k)&&Octree.testSphereInNode(h,b,c))return!0;return!1};Octree.prototype.findNearestPoint=function(a,b,c,d){c=c||Infinity;if(a===b)throw"findNearestPoint input point and output cannot be the same";return Octree.nearestInNode(this.root,a,b,c,d)};Octree.nearestInNode=function(a,b,c,d,f){var k=vec3.create(),h;f&&(h=vec3.create());if(a.faces)for(var m=0,l=a.faces.length;m<l;++m){var n=a.faces[m],p=n.subarray(0,3),s=n.subarray(3,
6),n=n.subarray(6,9);Octree.closestPointOnTriangle(b,p,s,n,k);var r=vec3.dist(k,b);r<d&&(d=r,vec3.copy(c,k),f&&geo.computeTriangleNormal(f,p,s,n))}if(!a.c)return d;for(m=0;m<a.c.length;++m)l=a.c[m],Octree.distanceToBox(b,l.min,l.max)>d||(r=Octree.nearestInNode(l,b,k,d,h),r<d&&(d=r,vec3.copy(c,k),f&&vec3.copy(f,h)));return d};Octree.closestPointOnTriangle=function(){var a=new Float32Array(4),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create();return function(k,h,m,l,n){geo.planeFromTriangle(a,
h,m,l);if(1E-8<vec3.length(a)&&(geo.projectPointOnPlane(k,h,a,b),geo.isPointInsideTriangle(b,h,m,l)))return vec3.copy(n,b),n;geo.closestPointToSegment(b,h,m,c);geo.closestPointToSegment(b,m,l,d);geo.closestPointToSegment(b,l,h,f);k=vec3.sqrDist(b,c);h=vec3.sqrDist(b,d);m=vec3.sqrDist(b,f);m=Math.min(k,h,m);m===k?vec3.copy(n,c):m===h?vec3.copy(n,d):vec3.copy(n,f);return n}}();Octree.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>
b.max[1]||a.max[2]>b.max[2]?!1:!0};Octree.distanceToBox=function(a,b,c){var d=0.5*(c[0]+b[0]),f=0.5*(c[1]+b[1]);b=0.5*(c[2]+b[2]);var k=c[0]-d,h=c[1]-f;c=c[2]-b;d=Math.abs(a[0]-d)-k;f=Math.abs(a[1]-f)-h;a=Math.abs(a[2]-b)-c;b=Math.min(Math.max(d,f,a),0);d=Math.max(d,0);f=Math.max(f,0);a=Math.max(a,0);return Math.sqrt(d*d+f*f+a*a)+b};Octree.hitTestBox=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),h=vec3.fromValues(1E-6,1E-6,1E-6);return function(m,
l,n,p){vec3.subtract(a,n,m);vec3.subtract(b,p,m);if(0>vec3.maxValue(a)&&0<vec3.minValue(b))return new HitTest(0,m,l);c[0]=1/l[0];c[1]=1/l[1];c[2]=1/l[2];vec3.multiply(a,a,c);vec3.multiply(b,b,c);vec3.min(d,a,b);vec3.max(f,a,b);var r=vec3.maxValue(d),y=vec3.minValue(f);return 0<r&&r<y?(m=vec3.add(vec3.create(),vec3.scale(k,l,r),m),vec3.add(n,n,h),vec3.subtract(n,n,h),new HitTest(r,m,vec3.fromValues((m[0]>p[0])-(m[0]<n[0]),(m[1]>p[1])-(m[1]<n[1]),(m[2]>p[2])-(m[2]<n[2])))):null}}();Octree.hitTestTriangle=
function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(f,k,h,m,l,n){vec3.subtract(a,m,h);vec3.subtract(b,l,h);m=vec3.cross(vec3.create(),a,b);vec3.normalize(m,m);if(!n&&0<vec3.dot(m,k))return null;n=vec3.dot(m,vec3.subtract(d,h,f))/vec3.dot(m,k);if(0<n){k=vec3.scale(vec3.create(),k,n);vec3.add(k,k,f);vec3.subtract(c,k,h);f=vec3.dot(b,b);h=vec3.dot(b,a);l=vec3.dot(b,c);var p=vec3.dot(a,a),r=vec3.dot(a,c),y=f*p-h*h,p=(p*l-h*r)/y;f=(f*r-h*l)/y;if(0<=p&&0<=f&&1>=
p+f)return new HitTest(n,k,m)}return null}}();Octree.testSphereTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),h=vec3.create(),m=vec3.create();return function(l,n,p,r,y){vec3.sub(a,p,l);vec3.sub(b,r,l);vec3.sub(c,y,l);vec3.sub(d,b,a);vec3.sub(f,c,a);vec3.cross(m,d,f);l=vec3.dot(a,m);p=vec3.dot(m,m);l=l*l>n*p;var u=vec3.dot(a,a),t=vec3.dot(a,b),x=vec3.dot(a,c),v=vec3.dot(b,b),C=vec3.dot(b,c),z=vec3.dot(c,c);p=u>n&t>u&x>u;r=v>n&
t>v&C>v;y=z>n&x>z&C>z;var u=t-u,t=C-v,w=x-z;vec3.sub(k,c,b);vec3.sub(h,a,c);v=vec3.dot(d,d);z=vec3.dot(k,k);x=vec3.dot(h,h);C=vec3.scale(vec3.create(),a,v);vec3.sub(C,C,vec3.scale(vec3.create(),d,u));u=vec3.scale(vec3.create(),b,z);vec3.sub(u,u,vec3.scale(vec3.create(),k,t));t=vec3.scale(vec3.create(),c,x);vec3.sub(t,t,vec3.scale(vec3.create(),h,w));var D=vec3.scale(vec3.create(),c,v),D=vec3.sub(D,D,C),A=vec3.scale(vec3.create(),a,z),A=vec3.sub(A,A,u),w=vec3.scale(vec3.create(),b,x),w=vec3.sub(w,
w,t),v=vec3.dot(C,C)>n*v*v&0<vec3.dot(C,D),z=vec3.dot(u,u)>n*z*z&0<vec3.dot(u,A);n=vec3.dot(t,t)>n*x*x&0<vec3.dot(t,w);return!(l|p|r|y|v|z|n)}}();Octree.testSphereBox=function(a,b,c,d){for(var f,k=0,h=0;3>h;++h)a[h]<c[h]?(f=a[h]-c[h],k+=f*f):a[h]>d[h]&&(f=a[h]-d[h],k+=f*f);return k<=b?!0:!1};r.HitTest=h.HitTest=function(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c;this.face=null};HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=
a.normal,this.face=a.face)}};r.Ray=h.Ray=function(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();this.t=-1;a&&this.origin.set(a);b&&this.direction.set(b)};Ray.prototype.testPlane=function(a,b){var c=geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point);this.t=geo.last_t;return c};Ray.prototype.testSphere=function(a,b,c){a=geo.testRaySphere(this.origin,this.direction,a,b,this.collision_point,c);this.t=geo.last_t;return a};Ray.prototype.testBBox=
function(a,b,c,d){a=geo.testRayBBox(this.origin,this.direction,a,c,this.collision_point,b,d);this.t=geo.last_t;return a};r.Raytracer=h.Raytracer=function(a,b){this.viewport=vec4.create();this.ray00=vec3.create();this.ray10=vec3.create();this.ray01=vec3.create();this.ray11=vec3.create();this.eye=vec3.create();this.setup(a,b)};Raytracer.prototype.setup=function(a,b){b=b||gl.viewport_data;this.viewport.set(b);var c=b[0],d=c+b[2],f=b[1],k=f+b[3];vec3.set(this.ray00,c,f,1);vec3.set(this.ray10,d,f,1);vec3.set(this.ray01,
c,k,1);vec3.set(this.ray11,d,k,1);vec3.unproject(this.ray00,this.ray00,a,b);vec3.unproject(this.ray10,this.ray10,a,b);vec3.unproject(this.ray01,this.ray01,a,b);vec3.unproject(this.ray11,this.ray11,a,b);c=this.eye;vec3.unproject(c,c,a,b);vec3.subtract(this.ray00,this.ray00,c);vec3.subtract(this.ray10,this.ray10,c);vec3.subtract(this.ray01,this.ray01,c);vec3.subtract(this.ray11,this.ray11,c)};Raytracer.prototype.getRayForPixel=function(){var a=vec3.create(),b=vec3.create();return function(c,d,f){f=
f||vec3.create();c=(c-this.viewport[0])/this.viewport[2];d=1-(d-this.viewport[1])/this.viewport[3];vec3.lerp(a,this.ray00,this.ray10,c);vec3.lerp(b,this.ray01,this.ray11,c);vec3.lerp(f,a,b,d);return vec3.normalize(f,f)}}();var Z=mat4.create();Raytracer.hitTestBox=function(a,b,c,d,f){var k=new Float32Array(30);f&&(f=mat4.invert(Z,f),a=mat4.multiplyVec3(k.subarray(3,6),f,a),b=mat4.rotateVec3(k.subarray(6,9),f,b));var h=vec3.subtract(k.subarray(9,12),c,a);vec3.divide(h,h,b);var m=vec3.subtract(k.subarray(12,
15),d,a);vec3.divide(m,m,b);f=vec3.min(k.subarray(15,18),h,m);h=vec3.max(k.subarray(18,21),h,m);f=vec3.maxValue(f);h=vec3.minValue(h);return 0<f&&f<=h?(b=vec3.scale(k.subarray(21,24),b,f),vec3.add(b,a,b),vec3.addValue(k.subarray(24,27),c,1E-6),vec3.subValue(k.subarray(27,30),d,1E-6),new HitTest(f,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,d){var f=vec3.subtract(vec3.create(),a,c),k=vec3.dot(b,b),h=2*vec3.dot(b,
f),f=vec3.dot(f,f)-d*d,f=h*h-4*k*f;return 0<f?(k=(-h-Math.sqrt(f))/(2*k),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,k)),new HitTest(k,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};Raytracer.hitTestTriangle=function(a,b,c,d,f){var k=vec3.subtract(vec3.create(),d,c),h=vec3.subtract(vec3.create(),f,c);f=vec3.cross(vec3.create(),k,h);vec3.normalize(f,f);d=vec3.dot(f,vec3.subtract(vec3.create(),c,a))/vec3.dot(f,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),
b,d));var m=vec3.subtract(vec3.create(),a,c);c=vec3.dot(h,h);b=vec3.dot(h,k);var h=vec3.dot(h,m),l=vec3.dot(k,k),k=vec3.dot(k,m),m=c*l-b*b,l=(l*h-b*k)/m,k=(c*k-b*h)/m;if(0<=l&&0<=k&&1>=l+k)return new HitTest(d,a,f)}return null};Mesh.parseOBJ=function(a,b){function c(a){var b,c,d,f=!1;if(-1==a.indexOf("-")){var k=v.get(a);if(void 0!==k)return k}else f=!0;d||(d=a.split("/"));if(1==d.length)d=c=b=parseInt(d[0]);else if(2==d.length)b=parseInt(d[0]),c=parseInt(d[1]),d=b;else if(3==d.length)b=parseInt(d[0]),
c=parseInt(d[1]),d=parseInt(d[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;0>b&&(b=q.length/3+b+1);0>d&&(d=m.length/2+d+1);0>c&&(c=l.length/2+c+1);if(f&&(a=b+"/"+c+"/"+d,k=v.get(a),void 0!==k))return k;b-=1;c-=1;d-=1;n.push(q[3*b+0],q[3*b+1],q[3*b+2]);l.length&&r.push(l[2*c+0],l[2*c+1]);m.length&&p.push(m[3*d+0],m[3*d+1],m[3*d+2]);k=C;v.set(a,k);++C;return k}function d(a){a={name:a||"",material:"",start:-1,length:-1,indices:[]};y.push(a);return a}function f(a){if(!x.material)return x.material=
a+k,u[a]=x;var b=u[a];b||(b=d(t+"_"+a),b.material=a+k,u[a]=b);return x=b}b=b||{};var k=b.matextension||"",q=[],m=[],l=[],n=[],p=[],r=[],y=[],u={},t=null,x=d(),v=new Map,C=0,z=1;b.scale&&(z=b.scale);for(var w={v:1,vt:2,vn:3,f:4,g:5,o:6,usemtl:7,mtllib:8},D,A,G,J=a.split("\n"),N=J.length,O=0;O<N;++O){var B=J[O],B=B.replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if("\\"==B[B.length-1])var O=O+1,E=J[O].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),B=(B.substr(0,B.length-1)+E).replace(/[ \t]+/g," ").replace(/\s\s*$/,
"");if("#"!=B[0]&&""!=B)switch(E=B.split(" "),B=w[E[0]],3>=B&&(D=parseFloat(E[1]),A=parseFloat(E[2]),2!=B&&(G=parseFloat(E[3]))),B){case 1:D*=z;A*=z;G*=z;q.push(D,A,G);break;case 2:l.push(D,A);break;case 3:m.push(D,A,G);break;case 4:if(4>E.length)continue;for(var F=[],B=1;B<E.length;++B)F.push(c(E[B]));x.indices.push(F[0],F[1],F[2]);for(B=2;B<F.length-1;++B)x.indices.push(F[0],F[B],F[B+1]);break;case 5:case 6:t=B=E[1];x.name?(u={},x=d(B)):x.name=B;break;case 7:f(E[1])}}w=[];D=0;z=[];for(B=0;B<y.length;++B)x=
y[B],x.indices&&(x.start=D,x.length=x.indices.length,w=w.concat(x.indices),delete x.indices,D+=x.length,z.push(x));y=z;z={};if(!q.length)return console.error("mesh without vertices"),null;if(b.flip_normals&&p.length)for(m=p,B=0;B<m.length;++B)m[B]*=-1;z.vertices=new Float32Array(n);p.length&&(z.normals=new Float32Array(p));r.length&&(z.coords=new Float32Array(r));w&&0<w.length&&(z.triangles=new (65536<D?Uint32Array:Uint16Array)(w));z.bounding=h.Mesh.computeBoundingBox(z.vertices);w={};1<y.length&&
(w.groups=y);z.info=w;if(!z.bounding)return console.log("empty mesh"),null;if(b.only_data)return z;w=null;return w=Mesh.load(z,null,b.mesh)};Mesh.parsers.obj=Mesh.parseOBJ;Mesh.encoders.obj=function(a,b){var c=a.getBuffer("vertices");if(!c)return null;var d=[];d.push("# Generated with liteGL.js by Javi Agenjo\n");for(var f=c.data,k=0;k<f.length;k+=3)d.push("v "+f[k].toFixed(4)+" "+f[k+1].toFixed(4)+" "+f[k+2].toFixed(4));if(c=a.getBuffer("normals"))for(d.push(""),c=c.data,k=0;k<c.length;k+=3)d.push("vn "+
c[k].toFixed(4)+" "+c[k+1].toFixed(4)+" "+c[k+2].toFixed(4));if(c=a.getBuffer("coords"))for(d.push(""),c=c.data,k=0;k<c.length;k+=2)d.push("vt "+c[k].toFixed(4)+" "+c[k+1].toFixed(4)+"  0.0000");c=a.info.groups;if(k=a.getIndexBuffer("triangles")){f=k.data;c&&c.length||(c=[{start:0,length:f.length,name:"mesh"}]);for(var h=0;h<c.length;++h){k=c[h];d.push("g "+k.name);var m=k.material||"mat_"+h;-1!=m.indexOf(".json")&&(m=m.substr(0,m.indexOf(".json")));d.push("usemtl "+m);for(var m=k.start,l=m+k.length,
k=m;k<l;k+=3)d.push("f "+(f[k]+1)+"/"+(f[k]+1)+"/"+(f[k]+1)+" "+(f[k+1]+1)+"/"+(f[k+1]+1)+"/"+(f[k+1]+1)+" "+(f[k+2]+1)+"/"+(f[k+2]+1)+"/"+(f[k+2]+1))}}else for(c&&c.length||(c=[{start:0,length:f.length/3,name:"mesh"}]),h=0;h<c.length;++h)for(k=c[h],d.push("g "+k.name),d.push("usemtl "+(k.material||"mat_"+h)),m=k.start,l=m+k.length,k=m;k<l;k+=3)d.push("f "+(k+1)+"/"+(k+1)+"/"+(k+1)+" "+(k+2)+"/"+(k+2)+"/"+(k+2)+" "+(k+3)+"/"+(k+3)+"/"+(k+3));return d.join("\n")};Mesh.parsers.mesh=function(a,b){for(var c=
{},d=a.split("\n"),f=0;f<d.length;++f){var k=d[f],h=k[0],k=k.substr(1).split(","),m=k[0];if("-"==h){var l=1,h=Float32Array;if("weights"==m||"bone_indices"==m)h=Uint8Array;"weights"==m&&(l=255);for(var n=new h(Number(k[1])),h=0;h<n.length;++h)n[h]=Number(k[h+2])*l;c[m]=n}else if("*"==h){h=Uint16Array;65536<Number(k[1])&&(h=Uint32Array);n=new h(Number(k[1]));for(h=0;h<n.length;++h)n[h]=Number(k[h+2]);c[m]=n}else if("@"==h)if("bones"==m){m=[];l=Number(k[1]);for(h=0;h<l;++h)n=k.slice(3+17*h,3+17*(h+1)-
1).map(Number),m.push([k[2+17*h],n]);c.bones=m}else if("bind_matrix"==m)c.bind_matrix=k.slice(1,17).map(Number);else{if("groups"==m)for(c.info={groups:[]},m=Number(k[1]),h=0;h<m;++h)c.info.groups.push({name:k[2+4*h],material:k[4*h+3],start:Number(k[4*h+4]),length:Number(k[4*h+5])})}else console.warn("type unknown: "+k[0])}if(b.only_data)return c;d=null;d=Mesh.load(c,null,b.mesh);d.updateBoundingBox();return d};Mesh.encoders.mesh=function(a,b){var c=[],d;for(d in a.vertexBuffers){var f=a.vertexBuffers[d],
h=typedArrayToArray(f.data);if(f.normalize&&f.data.constructor==Uint8Array)for(var q=0;q<h.length;++q)h[q]/=255;q=["-"+d,f.data.length,f.data,h];c.push(q.join(","))}for(d in a.indexBuffers)f=a.indexBuffers[d],h=typedArrayToArray(f.data),q=["*"+d,f.data.length,f.data,h],c.push(q.join(","));a.bounding&&c.push(["@bounding",typedArrayToArray(a.bounding.subarray(0,6))].join());if(a.info&&a.info.groups){d=[];for(q=0;q<a.info.groups.length;++q)f=a.info.groups[q],d.push(f.name,f.material,f.start,f.length);
c.push(["@groups",a.info.groups.length].concat(d).join(","))}a.bones&&c.push(["@bones",a.bones.length,a.bones.flat()].join());a.bind_matrix&&c.push(["@bind_matrix",typedArrayToArray(a.bind_matrix)].join());return c.join("\n")};r.WBin&&(r.WBin.classes.Mesh=Mesh);Mesh.binary_file_formats.wbin=!0;Mesh.parsers.wbin=Mesh.fromBinary=function(a,b){b=b||{};var c=null;if(a.constructor==ArrayBuffer){if(!r.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";
c=WBin.load(a,!0)}else c=a;c.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",c["@classname"]);c.format&&h.Mesh.decompress(c);var d={};if(c.vertex_buffers)for(var f in c.vertex_buffers)d[c.vertex_buffers[f]]=c[c.vertex_buffers[f]];else c.vertices&&(d.vertices=c.vertices),c.normals&&(d.normals=c.normals),c.coords&&(d.coords=c.coords),c.weights&&(d.weights=c.weights),c.bone_indices&&(d.bone_indices=c.bone_indices);var k={};if(c.index_buffers)for(f in c.index_buffers)k[c.index_buffers[f]]=
c[c.index_buffers[f]];else c.triangles&&(k.triangles=c.triangles),c.wireframe&&(k.wireframe=c.wireframe);d={vertex_buffers:d,index_buffers:k,bounding:c.bounding,info:c.info};if(c.bones){d.bones=c.bones;for(f=0;f<d.bones.length;++f)d.bones[f][1]=mat4.clone(d.bones[f][1]);c.bind_matrix&&(d.bind_matrix=mat4.clone(c.bind_matrix))}c.morph_targets&&(d.morph_targets=c.morph_targets);if(b.only_data)return d;c=b.mesh||new h.Mesh;c.configure(d);return c};Mesh.encoders.wbin=function(a,b){a.updateBoundingBox();
return a.toBinary(b)};Mesh.prototype.toBinary=function(a){if(!r.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});a={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var b=[],c=0;c<this.bones.length;++c)b.push([this.bones[c][0],mat4.toArray(this.bones[c][1])]);a.bones=b;this.bind_matrix&&(a.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox();a.bounding=this.bounding;var b=[],d=[];for(c in this.vertexBuffers){var f=
this.vertexBuffers[c];a[f.name]=f.data;b.push(f.name);"vertices"==f.name&&(a.info.num_vertices=f.data.length/3)}for(c in this.indexBuffers)f=this.indexBuffers[c],a[c]=f.data,d.push(c);a.vertex_buffers=b;a.index_buffers=d;h.Mesh.enable_wbin_compression&&h.Mesh.compress(a);return WBin.create(a,"Mesh")};Mesh.compress=function(a,b){b=b||"bounding_compressed";a.format={type:b};var c=Mesh.compressors[b];if(!c)throw"compression format not supported:"+b;return c(a)};Mesh.decompress=function(a){if(a.format){var b=
Mesh.decompressors[a.format.type];if(!b)throw"decompression format not supported:"+a.format.type;return b(a)}};Mesh.compressors.bounding_compressed=function(a){if(!a.vertex_buffers)throw"buffers not found";for(var b=BBox.getMin(a.bounding),c=BBox.getMax(a.bounding),d=vec3.sub(vec3.create(),c,b),f=a.vertices,h=new Uint16Array(f.length),c=0;c<f.length;c+=3)h[c]=(f[c]-b[0])/d[0]*65535,h[c+1]=(f[c+1]-b[1])/d[1]*65535,h[c+2]=(f[c+2]-b[2])/d[2]*65535;a.vertices=h;if(a.normals){d=a.normals;b=new Uint8Array(d.length);
f=b.constructor==Uint8Array?255:65535;for(c=0;c<d.length;c+=3)b[c]=(0.5*d[c]+0.5)*f,b[c+1]=(0.5*d[c+1]+0.5)*f,b[c+2]=(0.5*d[c+2]+0.5)*f;a.normals=b}if(a.coords){b=a.coords;f=[1E4,1E4,-1E4,-1E4];for(c=0;c<b.length;c+=2)d=b[c],f[0]>d?f[0]=d:f[2]<d&&(f[2]=d),d=b[c+1],f[1]>d?f[1]=d:f[3]<d&&(f[3]=d);a.format.uvs_bounding=f;h=new Uint16Array(b.length);d=[f[2]-f[0],f[3]-f[1]];for(c=0;c<b.length;c+=2)h[c]=(b[c]-f[0])/d[0]*65535,h[c+1]=(b[c+1]-f[1])/d[1]*65535;a.coords=h}if(a.weights){d=a.weights;b=new Uint16Array(d.length);
f=b.constructor==Uint8Array?255:65535;for(c=0;c<d.length;c+=4)b[c]=d[c]*f,b[c+1]=d[c+1]*f,b[c+2]=d[c+2]*f,b[c+3]=d[c+3]*f;a.weights=b}};Mesh.decompressors.bounding_compressed=function(a){var b=a.bounding;if(!b)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";for(var c=BBox.getMin(b),b=BBox.getMax(b),d=vec3.sub(vec3.create(),b,c),f=a.format,h=1/255,q=1/65535,m=a.vertices,l=new Float32Array(m.length),b=0,n=m.length;b<n;b+=3)l[b]=m[b]*q*d[0]+c[0],l[b+
1]=m[b+1]*q*d[1]+c[1],l[b+2]=m[b+2]*q*d[2]+c[2];a.vertices=l;if(a.normals&&a.normals.constructor!=Float32Array){d=a.normals;c=new Float32Array(d.length);m=d.constructor==Uint8Array?h:q;b=0;for(n=d.length;b<n;b+=3)c[b]=d[b]*m*2-1,c[b+1]=d[b+1]*m*2-1,c[b+2]=d[b+2]*m*2-1,l=c.subarray(b,b+3),vec3.normalize(l,l);a.normals=c}if(a.coords&&f.uvs_bounding&&a.coords.constructor!=Float32Array){c=a.coords;f=f.uvs_bounding;d=[f[2]-f[0],f[3]-f[1]];m=new Float32Array(c.length);b=0;for(n=c.length;b<n;b+=2)m[b]=c[b]*
q*d[0]+f[0],m[b+1]=c[b+1]*q*d[1]+f[1];a.coords=m}if(a.weights&&a.weights.constructor!=Float32Array){f=a.weights;d=new Float32Array(f.length);h=f.constructor==Uint8Array?h:q;b=0;for(n=f.length;b<n;b+=4)d[b]=f[b]*h,d[b+1]=f[b+1]*h,d[b+2]=f[b+2]*h,d[b+3]=f[b+3]*h;a.weights=d}}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(w){function g(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();a&&this.origin.set(a);b&&this.direction.set(b)}function z(a,b){return vec3.dot(a,b)+a[3]}function q(a,b,d){var l=a[3];d=Math.abs(d[0]*a[0])+Math.abs(d[1]*a[1])+Math.abs(d[2]*a[2]);a=vec3.dot(a,b)+l;return a<=-d?H:a<=d?I:A}var f=w.RD={version:.5};f.ZERO=vec3.fromValues(0,0,0);f.ONE=vec3.fromValues(1,1,1);f.RIGHT=vec3.fromValues(1,0,0);f.LEFT=vec3.fromValues(-1,0,0);f.UP=vec3.fromValues(0,
1,0);f.DOWN=vec3.fromValues(0,-1,0);f.FRONT=vec3.fromValues(0,0,-1);f.BACK=vec3.fromValues(0,0,1);f.FRONT2D=vec2.fromValues(0,1);f.WHITE=vec3.fromValues(1,1,1);f.BLACK=vec3.fromValues(0,0,0);f.IDENTITY=mat4.create();f.ONES4=vec4.fromValues(1,1,1,1);f.TRANS10_IDENTITY=new Float32Array([0,0,0,0,0,0,1,1,1,1]);f.CENTER=0;f.TOP_LEFT=1;f.TOP_RIGHT=2;f.BOTTOM_LEFT=3;f.BOTTOM_RIGHT=4;f.TOP_CENTER=5;f.BOTTOM_CENTER=6;f.PRIORITY_BACKGROUND=30;f.PRIORITY_OPAQUE=20;f.PRIORITY_ALPHA=10;f.PRIORITY_HUD=0;f.BLEND_NONE=
0;f.BLEND_ALPHA=1;f.BLEND_ADD=2;f.BLEND_MULTIPLY=3;f.NO_BILLBOARD=0;f.BILLBOARD_SPHERIC=1;f.BILLBOARD_PARALLEL_SPHERIC=2;f.BILLBOARD_CYLINDRIC=3;f.BILLBOARD_PARALLEL_CYLINDRIC=4;f.UNKNOWN=0;f.NUMBER=f.SCALAR=1;f.VEC2=2;f.VEC3=3;f.VEC4=4;f.QUAT=5;f.MAT3=6;f.TRANS10=7;f.MAT4=8;f.STRING=9;f.TYPES={NUMBER:f.NUMBER,SCALAR:f.NUMBER,VEC2:f.VEC2,VEC3:f.VEC3,VEC4:f.VEC4,QUAT:f.QUAT,MAT3:f.MAT3,TRANS10:f.TRANS10,MAT4:f.MAT4,STRING:f.STRING};f.TYPES_SIZE=[0,1,2,3,4,4,9,10,16,0];f.NO_INTERPOLATION=0;f.LINEAR=
1;f.CUBIC=2;var n=f.DEG2RAD=.0174532925;f.RAD2DEG=57.295779578552306;var v={COLOR:1,COORD1:2,INSTANCING:4,SKINNING:8,POINTS:16,NO_TRIANGLES:32,TEXTURE:64,ALBEDO:128,EMISSIVE:256,OCCLUSION:512,ALPHA_HASH:1024,UV_TRANSFORM:2048,LIGHTS:4096,SHADOWS:8192,FOG:1<<143,FLAT_NORMAL:32768,UNLIT:65536,SECOND_BUFFER:131072,FLAT_COLOR:262144,MORPHTARGETS:524288},t=vec3.create(),E=vec3.create();f.Materials={};f.Images={};f.setup=function(a){a=a||{};if(f.configuration)throw"already called setup";f.configuration=
a};var C=0;"undefined"==typeof extendClass&&(w.extendClass=function(a,b){for(var d in b)a.hasOwnProperty(d)||(a[d]=b[d]);if(b.prototype){var l=Object.getOwnPropertyNames(b.prototype);for(d=0;d<l.length;++d){var k=l[d];a.prototype.hasOwnProperty(k)||(b.prototype.__lookupGetter__(k)?a.prototype.__defineGetter__(k,b.prototype.__lookupGetter__(k)):a.prototype[k]=b.prototype[k],b.prototype.__lookupSetter__(k)&&a.prototype.__defineSetter__(k,b.prototype.__lookupSetter__(k)))}}a.hasOwnProperty("superclass")||
Object.defineProperty(a,"superclass",{get:function(){return b},enumerable:!1})});mat3.create();var c=mat4.create(),p=mat3.create(),e=mat4.create(),h=vec2.create();t=vec3.create();E=vec3.create();vec4.create();var r=quat.create();class u{set id(a){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=a}get id(){return this._id}get position(){return this._position}set position(a){this._position.set(a);this._must_update_matrix=!0}get x(){return this._position[0]}set x(a){this._position[0]=
a;this._must_update_matrix=!0}get y(){return this._position[1]}set y(a){this._position[1]=a;this._must_update_matrix=!0}get z(){return this._position[2]}set z(a){this._position[2]=a;this._must_update_matrix=!0}get rotation(){return this._rotation}set rotation(a){this._rotation.set(a);this._must_update_matrix=!0}get scaling(){return this._scale}set scaling(a){a.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=a:this._scale.set(a);this._must_update_matrix=!0}get transform(){return this._transform}set transform(a){this._transform.set(a);
quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0}get matrix(){return this._local_matrix}set matrix(a){this.fromMatrix(a)}get pivot(){return this._pivot}set pivot(a){this._must_update_matrix=!0;a?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(a),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)}set color(a){if(this.material){var b=this.getMaterial();b&&(b.color=a)}else console.warn("cannot set color of node without material")}get color(){var a=this.getMaterial();
a&&a.color;console.warn("cannot get color of node without material");return null}get mustUpdate(){return this._must_update_matrix}set mustUpdate(a){a&&(this._must_update_matrix=!0)}get visible(){return this.flags.visible}set visible(a){this.flags.visible=a}get scene(){return this._scene}set scene(a){throw"cannot set scene, you must use addChild in its parent node";}get parentNode(){return this._parent}set parentNode(a){throw"Cannot set parentNode of SceneNode, use addChild on parent";}constructor(a){this._uid=
C++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.layers=3;this.draw_range=this.instances=this.mesh=null;this.submesh=-1;this.primitives=[];this.material=null;this.flags={visible:!0,collides:!0};this.extras={};this._parent=null;this.children=
[];quat.identity(this._rotation);this._scale.set(f.ONE);a&&this.fromJSON(a)}clone(a){var b=new this.constructor,d;for(d in this)if("_"!=d[0])if("children"==d){if(a)for(var l=0;l<this.children.length;++l)b.addChild(this.children[l].clone(a))}else l=this[d],void 0!==l&&(null===l?b[d]=null:l.constructor===Object?b[d]=GL.cloneObject(l):l.constructor===Array?b[d]=l.concat():b[d]!==l&&(b[d]=l));b.position=this.position;b.rotation=this.rotation;b.scaling=this.scaling;return b}toJSON(){var a={position:[this._position[0],
this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(a.name=this.name);this.primitives&&this.primitives.length&&(a.primitives=this.primitives.map(function(l){return Object.assign({},l)}));this.mesh&&(a.mesh=this.mesh);this.material&&(a.material=this.material);null!=this.submesh&&(a.submesh=this.submesh);this.flags&&(a.flags=JSON.parse(JSON.stringify(this.flags)));
this.extras&&(a.extras=this.extras);this.animation&&(a.animation=this.animation);if(this.animations){a.animations=[];for(var b=0;b<this.animations.length;++b)a.animations.push(this.animations[b].toJSON())}if(this.skin)for(a.skin={},a.skin.joints=this.skin.joints.concat(),a.skin.skeleton_root=this.skin.skeleton_root,a.skin.bindMatrices=[],b=0;b<this.skin.bindMatrices.length;++b)a.skin.bindMatrices.push(typedArrayToArray(this.skin.bindMatrices[b]));this.skeleton&&(a.skeleton=this.skeleton.toJSON());
if(this.onSerialize)this.onSerialize(a);if(this.children){b=0;for(var d=this.children.length;b<d;b++)a.children.push(this.children[b].toJSON())}return a}fromJSON(a){var b=null,d;for(d in a){switch(d){case "children":continue;case "uniforms":for(var l in a.uniforms)this.uniforms[l]=a.uniforms[l];continue;case "flags":for(l in a.flags)this.flags[l]=a.flags[l];continue;case "scale":case "scaling":vec3.copy(this._scale,[1,1,1]);this.scale(a[d]);continue;case "tiling":isNumber(a[d])?this.setTextureTiling(a[d],
a[d]):this.setTextureTiling(a[d][0],a[d][1],a[d][2],a[d][3]);continue;case "skeleton":var k=new f.Skeleton;k.fromJSON(a[d]);this.skeleton=k;continue;case "animations":this.animations=[];for(l=0;l<a.animations.length;++l)k=new f.Animation,k.fromJSON(a.animations[l]),this.animations.push(k);continue;case "primitives":this.primitives=a.primitives.map(function(x){return Object.assign({},x)});continue;case "material":this.material=a[d]&&a[d].constructor===Object?(new P(a[d])).register().name:a[d];continue;
case "name":case "mesh":case "ref":case "draw_range":case "submesh":case "skin":case "extra":case "extras":case "animation":this[d]=a[d];continue;case "parent":b=a[d]}k=this[d];void 0!==k&&(k&&k.constructor===Float32Array?k.set(a[d]):this[d]=a[d])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(a.children)for(this.removeAllChildren(),d=0;d<a.children.length;++d)l=new f.SceneNode,l.fromJSON(a.children[d]),this.addChild(l);b&&(this.parentNode?console.error("This node already has a parent"):
b.addChild(this))}setMesh(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null}addChild(a,b){function d(l,k){if(l._scene&&l._scene!=k){var x=l._scene._nodes.indexOf(l);-1!=x&&l._scene._nodes.splice(x,1);l.id&&l._scene._nodes_by_id[l.id]==l&&delete l._scene._nodes_by_id[l.id]}if(l._scene=k)k._nodes.push(l),l.id&&k&&(k._nodes_by_id[l.id]=l);if(l.children){x=0;for(var y=l.children.length;x<y;x++){var F=l.children[x];F._scene!=k&&d(F,k)}}}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";
a._parent=this;b&&a.fromMatrix(a._global_matrix);this.children||(this.children=[]);this.children.push(a);this._scene!=a._scene&&d(a,this._scene);return this}removeChild(a,b){function d(k){if(k._scene){k.id&&k._scene._nodes_by_id[k.id]==k&&delete k._scene._nodes_by_id[k.id];var x=k._scene._nodes.indexOf(k);-1!=x&&k._scene._nodes.splice(x,1)}k._scene=null;x=0;for(var y=k.children.length;x<y;x++)d(k.children[x])}if(a._parent!=this)throw"removeChild: Not its children";if(!this.children)return this;var l=
this.children.indexOf(a);if(-1==l)throw"removeChild: impossible, should be children";this.children.splice(l,1);a._parent=null;b?a.fromMatrix(a._global_matrix):a._global_matrix.set(a._local_matrix);d(a);return this}removeAllChildren(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])}clear(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-1])}remove(){this._parent&&this._parent.removeChild(this)}destroy(a){!this.scene||a?
this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)}setChildIndex(a,b){if(this.children){var d=this.children.indexOf(a);-1!=d&&(this.children.splice(d,1),this.children.splice(b,0,a))}}getAllChildren(a){a=a||[];if(!this.children)return a;for(var b=0,d=this.children.length;b<d;b++){var l=this.children[b];a.push(l);l.getAllChildren(a)}return a}getVisibleChildren(a,b,d){a=a||[];null==b&&(b=65535);if(!this.children||!1===this.flags.visible)return a;for(var l=0,k=this.children.length;l<
k;l++){var x=this.children[l];if(!1!==x.flags.visible){var y=x.layers&b;if(!d||y)y&&a.push(x),x.updateGlobalMatrix(!0),x.getVisibleChildren(a,b)}}return a}findNode(a){for(var b=0,d=this.children.length;b<d;b++){var l=this.children[b];if(l.id==a||(l=l.findNode(a)))return l}return null}findNodeByName(a){if(null==a)return null;for(var b=0,d=this.children.length;b<d;b++){var l=this.children[b];if(l.name==a||(l=l.findNodeByName(a)))return l}return null}findNodesByFilter(a,b,d){null==b&&(b=65535);d=d||
[];for(var l=0,k=this.children.length;l<k;l++){var x=this.children[l];x.layers&b&&(a&&!a(x)||d.push(x),x.findNodesByFilter(a,b,d))}return d}propagate(a,b){for(var d=0,l=this.children.length;d<l;d++){var k=this.children[d];k&&(k[a]&&k[a].apply(k,b),k.children&&k.children.length&&k.propagate(a,b))}}resetTransform(){this._position.set(f.ZERO);quat.identity(this._rotation);this._scale.set(f.ONE);this._must_update_matrix=!0}translate(a,b){b?this.getGlobalVector(a,t):t.set(a);vec3.add(this._position,this._position,
t);this._must_update_matrix=!0}moveLocal(a){this.translate(a,!0)}setEulerRotation(a,b,d){a&&3<=a.length?quat.fromEuler(this._rotation,a):quat.fromEuler(this._rotation,[a,b,d]);this._must_update_matrix=!0}getEulerRotation(a){a=a||vec3.create();quat.toEuler(a,this._rotation);return a}rotate(a,b,d){d&&(b=this.getGlobalVector(b,t));quat.setAxisAngle(r,b,a);quat.multiply(this._rotation,r,this._rotation);this._must_update_matrix=!0}rotateQuat(a,b){b?quat.multiply(this._rotation,a,this._rotation):quat.multiply(this._rotation,
this._rotation,a);this._must_update_matrix=!0}scale(a){a.constructor===Number?(t[0]=t[1]=t[2]=a,vec3.mul(this._scale,this._scale,t)):vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0}lookAt(a,b,d,l){this.position=a;this.orientTo(b,l,d)}orientTo(a,b,d,l,k,x){var y=this.getGlobalPosition(),F=vec3.create();l?F.set(a):vec3.sub(F,y,a);k&&(F[1]=0);d=d||f.UP;vec3.normalize(F,F);b&&vec3.scale(F,F,-1);a=mat3.create();d=vec3.cross(vec3.create(),d,F);vec3.normalize(d,d);b=vec3.cross(vec3.create(),
F,d);vec3.normalize(b,b);mat3.setColumn(a,d,0);mat3.setColumn(a,b,1);mat3.setColumn(a,F,2);quat.fromMat3(this._rotation,a);x&&quat.invert(this._rotation,this._rotation);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0;return this}setPivot(a){this.pivot=a}getLocalMatrix(a){this._must_update_matrix&&this.updateLocalMatrix();return a?(a.set(this._global_matrix),a):this._local_matrix}getGlobalMatrix(a,b){this.updateGlobalMatrix(b);return a?(a.set(this._global_matrix),a):this._global_matrix}getGlobalRotation(a){a=
a||vec4.create();quat.identity(a);for(var b=this,d=this._scene?this._scene._root:null;b!=d;)quat.multiply(a,b._rotation,a),b=b._parent;return a}updateLocalMatrix(){var a=this._local_matrix;this._must_update_matrix=!1;mat4.identity(a);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(a[12]=this._pivot[0],a[13]=this._pivot[1],a[14]=this._pivot[2]),mat4.translate(a,a,this._position),mat4.fromQuat(e,this._rotation),mat4.multiply(a,a,e),mat4.scale(a,a,this._scale),this.flags.pivot&&this._pivot&&
mat4.translate(a,a,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))}updateGlobalMatrix(a,b){this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?(a=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,
b)}updateMatrices(a){this.updateLocalMatrix();this.updateGlobalMatrix(a)}fromMatrix(a,b){b&&this._parent&&this._parent._transform&&(mat4.copy(this._global_matrix,a),b=this._parent.getGlobalMatrix(),mat4.invert(b,b),a=mat4.multiply(this._local_matrix,b,a));b=mat4.clone(a);mat4.multiplyVec3(this._position,b,[0,0,0]);var d=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(d,b,f.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(d,b,f.UP));this._scale[2]=vec3.length(mat4.rotateVec3(d,b,f.BACK));
b=mat3.fromMat4(p,b);quat.fromMat3AndQuat(this._rotation,b);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1}getLocalPoint(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,a,this._local_matrix)}getParentVector(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)}getLocalVector(a){console.error("DEPRECATED: SceneNode.prototype.getLocalVector, use getGlobalVector or getParentVector")}getGlobalPosition(a,
b){a=a||vec3.create();if(b)return vec3.transformMat4(a,f.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return a.set(this._position),a;b=this.getGlobalMatrix();return vec3.transformMat4(a,f.ZERO,b)}localToGlobal(a,b,d){b=b||vec3.create();d=this.getGlobalMatrix(null,d);return vec3.transformMat4(b,a,d)}globalToLocal(a,b){b=b||vec3.create();var d=this.getGlobalMatrix();mat4.invert(e,d);return vec3.transformMat4(b,a,e)}globalVectorToLocal(a,b){b=b||vec3.create();var d=this.getGlobalRotation();
quat.invert(d,d);return vec3.transformQuat(b,a,d)}getGlobalVector(a,b){b=b||vec3.create();var d=this.getGlobalRotation(r);return vec3.transformQuat(b,a,d)}getGlobalRotation(a){a=a||quat.create();if(!this._parent||!this._parent._transform)return a.set(this._rotation),a;this._parent.getGlobalRotation(a);quat.multiply(a,a,this._rotation);return a}getDistanceTo(a){var b=this.getGlobalMatrix();return vec3.distance(a,b.subarray(12,15))}updateBoundingBox(a){var b=this._global_matrix,d=gl.meshes[this.mesh],
l=null;d&&(l=d.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),l=BBox.transformMat4(this.bounding_box,l,b));if(a||!this.children||0==this.children.length)return l;for(a=0;a<this.children.length;++a)if(b=this.children[a].updateBoundingBox())l?BBox.merge(l,l,b):(l=this.bounding_box=BBox.create(),l.set(b));return l}createMaterial(a){a=new f.Material(a);this.material=a.register().name;return a}replaceMaterial(a,b){for(let l=0;l<this.primitives.length;++l){var d=this.primitives[l];
d.material===a&&(d.material=b)}this.material===a&&(this.material=b)}getMaterial(a){a=a||0;return this.material?f.Materials[this.material]:this.primitives&&this.primitives.length>a?f.Materials[this.primitives[a].material]:null}setLayerBit(a,b){a=1<<a;this.layers&=~a;b&&(this.layers|=a)}isInLayerBit(a){return 0!==(this.layers&1<<a)}setRangeFromSubmesh(a){if(null!=a&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(a.constructor===String){for(var d=0;d<b.info.groups.length;++d)if(b.info.groups[d].name==
a){a=d;break}if(d===b.info.groups.length)return!1}if(a=b.info.groups[a])this.draw_range[0]=a.start,this.draw_range[1]=a.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null}findNodesInSphere(a,b,d,l){null==d&&(d=65535);l=l||[];for(var k=0;k<this.children.length;++k){var x=this.children[k];x.layers&d&&(x.getGlobalPosition(t,!0),vec3.distance(t,a)<=b&&l.push(x));x.children.length&&x.findNodesInSphere(a,b,d,l)}return l}}f.SceneNode=u;u["@position"]=
{type:"vec3"};u["@scaling"]={type:"vec3"};u["@rotation"]={type:"quat"};u.prototype.testRay=function(){var a=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();mat4.create();return function(b,d,l,k,x,y){l=null==l?Number.MAX_VALUE:l;null==k&&(k=65535);d=d||vec3.create();void 0!==G._ray_tested_objects&&G._ray_tested_objects++;var F=null,D=null;if(!1===this.flags.visible)return null;this.layers&k&&!1!==this.flags.collides&&this.mesh&&(D=this.testRayWithMesh(b,a,l,k,x,
y));D&&(y=vec3.distance(b.origin,a),null==l||y<l)&&(l=y,d.set(a),F=this);if(!this.children||!this.children.length)return F;D=vec3.create();for(var B=0,K=this.children.length;B<K;++B){var M=this.children[B].testRay(b,D,l,k,x);M&&(y=vec3.distance(b.origin,D),y>l||(l=y,d.set(D),F=M))}return F}}();u.prototype.testRayWithMesh=function(){var a=vec3.create(),b=vec3.create(),d=vec3.create(),l=mat4.create(),k=mat4.create();return function(x,y,F,D,B){if(!this.mesh)return!1;var K=gl.meshes[this.mesh];if(!K||
!1===K.ready)return!1;var M=null==this.submesh?-1:this.submesh,Q=this.getGlobalMatrix(l,!0),O=K.getBoundingBox(),S=Math.abs(Q[0]+Q[1]+Q[2]),T=Math.abs(Q[4]+Q[5]+Q[6]),Y=Math.abs(Q[8]+Q[9]+Q[10]),R=vec3.length(O.subarray(3,6))*Math.sqrt(S);if(.001>Math.abs(S-T)&&.001>Math.abs(S-Y)&&!geo.testRaySphere(x.origin,x.direction,vec3.transformMat4(a,O.subarray(0,3),Q),R,void 0,F))return!1;mat4.invert(k,Q);vec3.transformMat4(a,x.origin,k);vec3.add(d,x.origin,x.direction);vec3.transformMat4(d,d,k);vec3.sub(b,
d,a);vec3.normalize(b,b);O=this.flags.two_sided;this.primitives&&this.primitives.length&&(S=f.Materials[this.primitives[0].material])&&(O=S.flags.two_sided);return f.testRayMesh(x,a,b,Q,K,M,y,F,D,B,O)}}();u.prototype.testSphere=function(){return function(a,b,d,l){null==d&&(d=65535);var k=null;if(!1===this.flags.visible)return null;this.layers&d&&!1!==this.flags.collides&&this.mesh&&(k=this.testSphereWithMesh(a,b,d,l));if(k)return this;if(!this.children||!this.children.length)return null;k=0;for(var x=
this.children.length;k<x;++k){var y=this.children[k].testSphere(a,b,d,l);if(y)return y}return null}}();u.prototype.testSphereWithMesh=function(){var a=vec3.create();vec3.create();vec3.create();var b=mat4.create(),d=mat4.create();return function(l,k,x,y){if(!this.mesh)return!1;var F=gl.meshes[this.mesh];if(!F||!1===F.ready)return!1;var D=null==this.submesh?-1:this.submesh,B=this.getGlobalMatrix(b,!0);mat4.invert(d,B);vec3.transformMat4(a,l,d);l=k/vec3.length(B);k=this.flags.two_sided;if(this.primitives&&
this.primitives.length){var K=f.Materials[this.primitives[0].material];K&&(k=K.flags.two_sided)}return f.testSphereMesh(a,l,B,F,D,x,y,k)}}();u.prototype.findNearestPointToMesh=function(){var a=mat4.create(),b=mat4.create(),d=vec3.create();return function(l,k,x,y,F){if(!this.mesh)return!1;var D=gl.meshes[this.mesh];if(!D||!1===D.ready)return Infinity;F?vec3.copy(d,l):(this.getGlobalMatrix(a),mat4.invert(b,a),vec3.transformMat4(d,l,b));D.octree||(D.octree=new GL.Octree(D));l=D.octree.findNearestPoint(d,
x,k,y);if(l===k)return l;F||vec3.transformMat4(x,x,a);return l}}();u.prototype.findNearestPointToNode=function(a,b,d,l){var k=null,x=b;this.mesh&&this.flags.collides&&(x=this.findNearestPointToMesh(a,b,d,l),x<b&&(k={node:this,distance:x}));for(let y=0;y<this.children.length;++y)this.children[y].flags.collides&&(b=this.findNearestPointToNode(a,x,d,l),b.distance<x&&(k=b));return k};f.findNearestPointToNodes=function(a,b,d,l,k){var x=null,y=vec3.create(),F=vec3.create();l=l||vec3.create();k=k||vec3.create();
for(let B=0;B<b.length;++B){var D=b[B];D.mesh&&(d=D.findNearestPointToMesh(a,d,y,F),!x||d<x.distance)&&(vec3.copy(l,y),vec3.copy(k,F),x||={node:D,distance:d,position:l,normal:k},x.node=D,x.distance=d)}return x};class m{static $jscomp$static$init$427572457$0$PERSPECTIVE(){return 1}static $jscomp$static$init$427572457$1$ORTHOGRAPHIC(){return 2}constructor(a){this.type=f.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=
.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._inv_viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();this._uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,
u_viewprojection:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(.1,1E3)};a&&this.fromJSON(a);this.updateMatrices()}}m.PERSPECTIVE=m.$jscomp$static$init$427572457$0$PERSPECTIVE();m.ORTHOGRAPHIC=m.$jscomp$static$init$427572457$1$ORTHOGRAPHIC();f.Camera=m;m.prototype.fromJSON=function(a){null!=a.type&&(this.type=a.type);a.position&&this._position.set(a.position);a.target&&this._target.set(a.target);a.up&&this._up.set(a.up);a.near&&
(this.near=a.near);a.far&&(this.far=a.far);a.fov&&(this.fov=a.fov);a.aspect&&(this.aspect=a.aspect)};m.prototype.toJSON=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};Object.defineProperty(m.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!1});
Object.defineProperty(m.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(m.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(m.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(m.prototype,"aspect",{get:function(){return this._aspect},
set:function(a){this._aspect=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(m.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(a){this._frustum_size=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(m.prototype,"near",{get:function(){return this._near},set:function(a){this._near=this._uniforms.u_camera_planes[0]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(m.prototype,"far",{get:function(){return this._far},
set:function(a){this._far=this._uniforms.u_camera_planes[1]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(m.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(a){this._view_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(m.prototype,"projection_matrix",{get:function(){return this._projection_matrix},set:function(a){this._projection_matrix.set(a);mat4.multiply(this._viewprojection_matrix,
this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(m.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(a){this._viewprojection_matrix.set(a)},enumerable:!1});m.prototype.perspective=function(a,b,d,l){this.type=m.PERSPECTIVE;this._fov=a;this._aspect=b;this._near=d;this._far=l;this._must_update_matrix=!0};m.prototype.orthographic=function(a,b,d,l){this.type=m.ORTHOGRAPHIC;this._frustum_size=a;1<arguments.lenth&&(this._near=
b,this._far=d,this._aspect=l||1);this._must_update_matrix=!0};m.prototype.lookAt=function(a,b,d){this._position==b&&(b=vec3.clone(b));vec3.copy(this._position,a);vec3.copy(this._target,b);vec3.copy(this._up,d);this._must_update_matrix=!0};m.prototype.updateMatrices=function(a){if(this._autoupdate_matrices||a)if(this.type==m.ORTHOGRAPHIC?this.frustum_size.constructor===Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,
this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*n,this._aspect,this._near,this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,
this._up),this.view_texel_grid&&this.type==m.ORTHOGRAPHIC){a=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var b=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/a)*a;this._view_matrix[13]=Math.floor(this._view_matrix[13]/b)*b}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,
this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);mat4.invert(this._inv_viewprojection_matrix,this._viewprojection_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,f.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,f.UP);mat4.rotateVec3(this._front,this._model_matrix,f.FRONT);this.distance=vec3.distance(this._position,this._target);this._uniforms.u_camera_planes[0]=this._near;this._uniforms.u_camera_planes[1]=this._far};
m.prototype.getModel=function(a){a=a||mat4.create();this._must_update_matrix&&this.updateMatrices();mat4.copy(a,this._model_matrix);return a};m.prototype.updateVectors=function(a){var b=vec3.subtract(t,this._target,this._position);b=vec3.length(b);mat4.multiplyVec3(this._position,a,f.ZERO);mat4.multiplyVec3(this._target,a,[0,0,-b]);mat4.rotateVec3(this._up,a,f.UP)};m.prototype.getLocalVector=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,
a)};m.prototype.localToGlobal=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};m.prototype.getLocalPoint=m.prototype.localToGlobal;m.prototype.globalToLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._view_matrix)};m.prototype.globalVectorToLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._view_matrix,
a)};m.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this._target,this._position);vec3.normalize(a,a);return a};m.prototype.move=function(a,b){void 0!==b&&(vec3.scale(t,a,b),a=t);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};m.prototype.moveLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();a=mat4.rotateVec3(t,this._model_matrix,a);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);
vec3.add(this._position,this._position,a);this._must_update_matrix=!0};m.prototype.rotate=function(a,b){a=quat.setAxisAngle(r,b,a);b=vec3.subtract(t,this._target,this._position);vec3.transformQuat(b,b,a);vec3.add(this._target,this._position,b);this._must_update_matrix=!0};m.prototype.rotateLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();b=mat4.rotateVec3(E,this._model_matrix,b);a=quat.setAxisAngle(r,b,a);b=vec3.subtract(t,this._target,this._position);vec3.transformQuat(b,b,a);
vec3.add(this._target,this._position,b);this._must_update_matrix=!0};m.prototype.orbit=function(a,b,d,l){if(!b)throw"RD: orbit axis missing";d=d||this._target;l&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(E,this._model_matrix,b));a=quat.setAxisAngle(r,b,a);b=vec3.subtract(t,this._position,this._target);vec3.transformQuat(b,b,a);vec3.add(this._position,d,b);this._must_update_matrix=!0};m.prototype.orbitDistanceFactor=function(a,b){b=b||this._target;var d=vec3.subtract(t,this._position,
b);vec3.scale(d,d,a);vec3.add(this._position,b,d);this._must_update_matrix=!0};m.prototype.project=function(a,b,d){d=d||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(d,this._viewprojection_matrix,a);d[0]=d[0]*b[2]+b[0];d[1]=d[1]*b[3]+b[1];return d};m.prototype.computeProjectedRadius=function(a,b,d,l){d=d||gl.viewport_data;if(l)return l=vec4.create(),l.set(a),l[3]=1,a=vec4.transformMat4(l,l,this._viewprojection_matrix),Math.max(1,d[3]*this._projection_matrix[5]*
b/a[3]);if(this.type==f.Camera.ORTHOGRAPHIC)return b/(this._frustum_size.constructor===Number?this._frustum_size:1)*d[3]/2;a=vec3.distance(a,this.position);return 0==a?0:1/Math.tan(this.fov/2*Math.PI/180)*b/Math.sqrt(a*a-b*b)*(d[3]/2)};m.prototype.unproject=function(a,b,d){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(d||vec3.create(),a,this._viewprojection_matrix,b)};m.prototype.getRay=function(a,b,d,l){if(void 0===a||void 0===b)throw"RD.Camera.getRay requires x and y parameters";
d=d||gl.viewport_data;l||=new f.Ray;this._must_update_matrix&&this.updateMatrices();var k=l.origin;vec3.set(k,a,b,0);this.type==f.Camera.ORTHOGRAPHIC?vec3.unproject(k,k,this._viewprojection_matrix,d):vec3.copy(k,this.position);var x=l.direction;vec3.set(x,a,b,1);vec3.unproject(x,x,this._viewprojection_matrix,d);vec3.sub(x,x,k);vec3.normalize(x,x);return l};m.prototype.getRayPlaneCollision=function(a,b,d,l,k,x){k=k||vec3.create();a=this.getRay(a,b,x);return geo.testRayPlane(a.origin,a.direction,d,
l,k)?k:null};m.prototype.getModelForScreenPixel=function(a,b,d,l,k){k=k||mat4.create();a=this.unproject([a,b,-1]);b=vec3.sub(vec3.create(),a,this._position);vec3.normalize(b,b);vec3.scaleAndAdd(a,a,b,d);vec3.normalize(b,b);mat4.fromTranslationFrontTop(k,a,b,this._up);return k};m.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};m.prototype.applyController=function(a,b,d,l){d=d||10;if(a){var k=vec3.create();if(gl.keys[m.controller_keys.forward]||l&&gl.keys.W)k[2]=-1;else if(gl.keys[m.controller_keys.back]||
l&&gl.keys.S)k[2]=1;if(gl.keys[m.controller_keys.left]||l&&gl.keys.A)k[0]=-1;else if(gl.keys[m.controller_keys.right]||l&&gl.keys.D)k[0]=1;vec3.sqrLen(k)&&this.moveLocal(k,a*d)}b&&(a=b.deltax||b.movementX,b=b.deltay||b.movementY,a&&this.rotate(-.005*a,f.UP),b&&this.rotateLocal(-.005*b,f.RIGHT))};m.prototype.lerp=function(a,b){vec3.lerp(this._position,this._position,a._position,b);vec3.lerp(this._target,this._target,a._target,b);vec3.lerp(this._up,this._up,a._up,b);this._fov=this._fov*(1-b)+a._fov*
b;this._near=this._near*(1-b)+a._near*b;this._far=this._far*(1-b)+a._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+a._frustum_sizer*b);this._must_update_matrix=!0};m.prototype.orientMatrixToCamera=function(a){a.set(this._right,0);a.set(this._top,4);a.set(this._front,8)};m.prototype.followNode=function(a,b){var d=a.getGlobalPosition();a=a.localToGlobal([0,0,-1]);this.lookAt(d,a,b||[0,1,0])};m.prototype.extractPlanes=function(){function a(l){var k=d.subarray(l,
l+3);k=vec3.length(k);k=1/k;d[l]*=k;d[l+1]*=k;d[l+2]*=k;d[l+3]*=k}var b=this._viewprojection_matrix,d=this._planes_data||new Float32Array(24);d.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);a(0);d.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);d.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);a(8);d.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);d.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);d.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);a(20);
this._planes_data=d;this._frustrum_planes||(this._frustrum_planes=[d.subarray(0,4),d.subarray(4,8),d.subarray(8,12),d.subarray(12,16),d.subarray(16,20),d.subarray(20,24)])};var A=f.CLIP_INSIDE=0,H=f.CLIP_OUTSIDE=1,I=f.CLIP_OVERLAP=2;m.prototype.testMesh=function(){if(w.BBox){var a=BBox.create(),b=a.subarray(0,3),d=a.subarray(3,6);return function(l,k){l=l.bounding;if(!l)return A;BBox.transformMat4(a,l,k);return this.testBox(b,d)}}}();m.prototype.testBBox=function(a){return this.testBox(a,a.subarray(3,
6))};m.prototype.testBox=function(a,b){this._frustrum_planes||this.extractPlanes();var d=this._frustrum_planes,l=0;var k=q(d[0],a,b);if(k==H)return H;l+=k;k=q(d[1],a,b);if(k==H)return H;l+=k;k=q(d[2],a,b);if(k==H)return H;l+=k;k=q(d[3],a,b);if(k==H)return H;l+=k;k=q(d[4],a,b);if(k==H)return H;l+=k;k=q(d[5],a,b);return k==H?H:0==l+k?A:I};m.prototype.testSphere=function(a,b){this._frustrum_planes||this.extractPlanes();var d=this._frustrum_planes,l=!1;var k=z(d[0],a);if(k<-b)return H;k>=-b&&k<=b&&(l=
!0);k=z(d[1],a);if(k<-b)return H;k>=-b&&k<=b&&(l=!0);k=z(d[2],a);if(k<-b)return H;k>=-b&&k<=b&&(l=!0);k=z(d[3],a);if(k<-b)return H;k>=-b&&k<=b&&(l=!0);k=z(d[4],a);if(k<-b)return H;k>=-b&&k<=b&&(l=!0);k=z(d[5],a);if(k<-b)return H;k>=-b&&k<=b&&(l=!0);return l?I:A};m.prototype.projectedSphereSize=function(a,b){var d=mat4.projectVec3(t,this.viewprojection_matrix,a);a=vec3.scaleAndAdd(E,a,this._right,b);mat4.projectVec3(a,this.viewprojection_matrix,a);return vec2.distance(d,a)};m.prototype.computeAproximateScreenSize=
function(a){return this.projectedSphereSize(a,a[12])};class G{constructor(){this._root=new f.SceneNode;this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}}f.Scene=G;G.prototype.clear=function(){this._root=new f.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};G.prototype.add=function(a){this.root.addChild(a)};G.prototype.remove=function(a){this.root.removeChild(a)};G.prototype.getNodeById=
function(a){return this._nodes_by_id[a]};G.prototype.findNodesInBBox=function(a,b,d){null==b&&(b=65535);d=d||[];for(var l=0;l<this.nodes.length;++l){var k=this.nodes[l];k.bounding_box&&k.layers&b&&geo.testBBoxBBox(k.bounding_box,a)&&d.push(k)}return d};G.prototype.update=function(a){this.time+=a;this._root.propagate("update",[a]);this.destroyPendingNodes()};G.prototype.destroyPendingNodes=function(a){if(this._to_destroy.length)for(;a=this._to_destroy.pop();)a._parent&&a._parent.removeChild(a)};Object.defineProperty(G.prototype,
"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});G.prototype.testRay=function(a,b,d,l,k){f.Scene._ray_tested_objects=0;b||(b=a.collision_point);null==k&&(k=!0);return this.root.testRay(a,b,d,null==l?65535:l,k)};G.prototype.testSphere=function(a,b,d,l){null==l&&(l=!0);return this.root.testSphere(a,b,null==d?65535:d,l)};G.prototype.gatherObjects=function(a,b,d){d=d||[];a.updateGlobalMatrix(!0);if(a.mesh&&b&a.layers&&!a.skeleton){if(a.primitives&&
a.primitives.length)for(var l=0;l<a.primitives.length;++l){var k=a.primitives[l];(this.overwrite_material||f.Materials[k.material])&&d.push([a,a._global_matrix,a.mesh,l,a.material])}}else d.push([a,a._global_matrix,a.mesh,-1,a.material]);for(l=0;l<a.children.length;++l)this.gatherObjects(a.children[l],b,d);return d};f.testRayWithNodes=function(a,b,d,l,k,x,y){f.testRayWithNodes.coll_node=null;l=null==l?Number.MAX_VALUE:l;k=null==k?65535:k;f.Scene._ray_tested_objects=0;d||(d=a.collision_point);f.testRayWithNodes.local_result||
(f.testRayWithNodes.local_result=vec3.create());for(var F=f.testRayWithNodes.local_result,D=null,B=0;B<b.length;++B){var K=b[B],M=K.testRay(a,F,l,k,x);if(M){var Q=vec3.distance(a.origin,F);Q>l||(l=Q,d.set(F),f.testRayWithNodes.coll_node=M,D=y?M:K)}}return D};f.last_hit_test=null;f.testRayMesh=function(a,b,d,l,k,x,y,F,D,B,K){F=null==F?Number.MAX_VALUE:F;-1==x?(D=k.getBoundingBox(),x=k):(x=k.info.groups[x],D=x.bounding,D||(k.computeGroupsBoundingBoxes(),D=x.bounding));if(!D)return!1;F||=1E7;if(!geo.testRayBBox(b,
d,D,null,t))return!1;vec3.transformMat4(y,t,l);D=vec3.distance(a.origin,y);if(D>F)return!1;if(!B)return!0;x._octree||(x._octree=x==k?new GL.Octree(k):new GL.Octree(k,x.start,x.length));b=x._octree.testRay(b,d,0,F,K);if(!b)return!1;f.last_hit_test=b;y.set(b.hit);vec3.transformMat4(y,y,l);D=vec3.distance(a.origin,y);return D>F?!1:!0};f.testSphereMesh=function(a,b,d,l,k,x,y){-1==k?(d=l.getBoundingBox(),k=l):(k=l.info.groups[k],d=k.bounding,d||(l.computeGroupsBoundingBoxes(),d=k.bounding));if(!d||!geo.testSphereBBox(a,
b,d))return!1;if(!y)return!0;k._octree||(k._octree=k==l?new GL.Octree(l):new GL.Octree(l,k.start,k.length));return k._octree.testSphere(a,b)?!0:!1};G.prototype.fromJSON=function(a){this.root.clear();this.root.fromJSON(a)};G.prototype.toJSON=function(a){function b(k,x){if(a){if(!a(k,x))return!1}else{if(!k.flags.no_transform){x.position=typedArrayToArray(k.position);if(0!=k.rotation[0]||0!=k.rotation[1]||0!=k.rotation[2]||1!=k.rotation[3])x.rotation=typedArrayToArray(k.rotation);if(1!=k.scaling[0]||
1!=k.scaling[1]||1!=k.scaling[2])x.scaling=typedArrayToArray(k.scaling)}k.id&&(x.id=k.id);k.ref=x.ref=d++;k.mesh&&(x.mesh=k.mesh);null!=k.submesh&&(x.submesh=k.submesh);k.draw_range&&(x.draw_range=k.draw_range.concat());k.material&&(x.material=k.material);k.extra&&(x.extra=k.extra);x.layers=k.layers;x.flags=k.flags}if(!k.children.length)return!0;for(var y=[],F=0;F<k.children.length;++F){var D={};b(k.children[F],D)&&y.push(D)}y.length&&(x.children=y);return!0}a&&a.constructor!==Function&&(a=null);
var d=0,l={};b(this.root,l);return l};var L={u_model:null};class P{static $jscomp$static$init$427572457$2$last_material_id(){return 0}constructor(a){this._color=vec4.fromValues(1,1,1,1);this._emissive=vec3.fromValues(0,0,0);this.shader_name=null;this.uniforms={};this.textures={};this.primitive=-1;this.blend_mode=f.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};a&&this.fromJSON(a)}set color(a){this._color.set(a)}get color(){return this._color}set albedo(a){this._color.set(a)}get albedo(){return this._color}set emissive(a){this._emissive.set(a)}get emissive(){return this._emissive}set opacity(a){this._color[3]=
a}get opacity(){return this._color[3]}set two_sided(a){this.flags.two_sided=a}get two_sided(){return this.flags.two_sided}register(a){a||=this.name||f.makeHash(32);this.name=a;f.Materials[this.name]=this;return this}setUVTransform(a,b,d,l,k){this.uv_transform||(this.uv_transform=mat3.create());var x=mat3.identity(this.uv_transform);mat3.translate(x,x,[a,k?1-b:b]);mat3.scale(x,x,[d,l])}fromJSON(a){for(var b in a){var d=a[b];if(d)if("name"===b)this.register(d);else if("material"===b&&d)d.constructor===
Object?(d=new f.Material(d),this.register(),d=d.name):d.constructor===f.Material&&(this.register(),d=d.name);else if("texture"===b){this.textures.color=d;continue}else d.constructor===Object?d=JSON.parse(JSON.stringify(d)):d.constructor===Array?d=d.concat():d.constructor===Float32Array&&(d=new Float32Array(d));this[b]=d}}toJSON(){var a={flags:JSON.parse(JSON.stringify(this.flags)),textures:JSON.parse(JSON.stringify(this.textures))};a.color=Array.from(this._color);this.name&&(a.name=this.name);this.alphaMode&&
(a.alphaMode=this.alphaMode);this.blendMode&&(a.blendMode=this.blendMode);.5!=this.alphaCutoff&&(a.alphaCutoff=this.alphaCutoff);this.uv_transform&&(a.uv_transform=Array.from(this.uv_transform));this.normalFactor&&(a.normalFactor=this.normalFactor);this.displacementFactor&&(a.displacementFactor=this.displacementFactor);this.backface_color&&(a.backface_color=Array.from(this.backface_color));this.emissive&&(a.emissive=Array.from(this.emissive));this.model&&(a.model=this.model,a.metallicFactor=this.metallicFactor,
a.roughnessFactor=this.roughnessFactor);return a}}P.last_material_id=P.$jscomp$static$init$427572457$2$last_material_id();f.Material=P;f.SPOT_LIGHT=1;f.POINT_LIGHT=2;f.DIRECTIONAL_LIGHT=3;class N extends f.SceneNode{static $jscomp$static$init$427572457$3$DEFAULT_SHADOWMAP_RESOLUTION(){return 2048}constructor(){super();this.intensity=1;this.area=10;this.cast_shadows=!1;this.max_distance=10;this.light_type=f.SPOT_LIGHT;this.cone_start=30;this.cone_end=45;this._shadowmap_index=-1;this._color=vec3.fromValues(.9,
.9,.9);this._center=vec3.create();this._front=vec3.create()}set color(a){this._color.set(a)}get color(){return this._color}followCamera(a,b){var d=b||5;b=vec3.scaleAndAdd(vec3.create(),a.target,this._vector,-b);this.lookAt(b,a.target,a.up);this.camera.orthographic(d,.01,3*d,1);this.camera.updateMatrices()}insideCamera(a){if(this.light_type===f.DIRECTIONAL_LIGHT)return!0;var b=this.getGlobalPosition();return a.testSphere(b,this.max_distance)!==H}overlaps(a){return this.light_type===f.DIRECTIONAL_LIGHT||
a.skin||geo.testSphereBBox(this._center,this.max_distance,a.bounding)!==f.CLIP_OUTSIDE}}N.DEFAULT_SHADOWMAP_RESOLUTION=N.$jscomp$static$init$427572457$3$DEFAULT_SHADOWMAP_RESOLUTION();f.Light=N;class U{constructor(){this.height=this.width=0;this.layers=255;this.textures={};this.fbos={}}}f.View=U;class J{set color(a){this._color.set(a)}get color(){return this._color}set ambient_light(a){this._ambient_light.set(a)}get ambient_light(){return this._ambient_light}set light_vector(a){this._light_vector.set(a)}get light_vector(){return this._light_vector}set light_color(a){this._light_color.set(a)}get light_color(){return this._light_color}set fog_color(a){this._fog_uniforms.u_fog_color.set([a[0],
a[1],a[2]])}get fog_color(){return this._fog_uniforms.u_fog_color.subarray(0,3)}set fog_density(a){this._fog_uniforms.u_fog_color[3]=a}get fog_density(){return this._fog_uniforms.u_fog_color[3]}constructor(a,b){this._color=vec4.fromValues(1,1,1,1);this._ambient_light=vec3.fromValues(.9,.9,.9);this._light_color=vec3.fromValues(.1,.1,.1);this._light_vector=vec3.fromValues(.5442,.6385,.544);this._main_view=new U;b||a.constructor!==Object||(b=a,a=null);b=b||{};a||(a=document.createElement("canvas"),a.width=
b.width||document.body.offsetWidth,a.height=b.height||document.body.offsetHeight);var d=this.gl=this.context=a=a.constructor===HTMLCanvasElement?GL.create({canvas:a,version:2,alpha:b.alpha}):a;if(!d||!d.enable)throw"litegl GL context not found.";a!=w.gl&&d.makeCurrent();this.assets_folder="";this.use_fog=this.use_flat_normal=this.use_alpha_hash=!1;this.small_objects_ratio_threshold=0;this.layers_affect_children=!1;this.force_update_bones=this.allow_instancing=!0;this.point_size=1;this.disable_cull_face=
this.reverse_normals=!1;this._model_matrix=mat4.create();this._mvp_matrix=mat4.create();this._texture_matrix=mat3.create();this.renderables=[];this.renderables_pool=[];this.rendered_renderables=this.used_renderables=0;this.outline_renderables=[];this.morph_textures=new Map;this.lights=[];this._nodes=[];this._uniforms={u_model:this._model_matrix,u_global_alpha_clip:0,u_point_size:this.point_size,u_res:new Float32Array([1,1,1,1])};this._lights_uniforms={u_num_lights:0,u_light_color:new Float32Array(16),
u_light_position:new Float32Array(16),u_light_front:new Float32Array(16),u_light_params:new Float32Array(16)};this._fog_uniforms={u_fog_color:new Float32Array([.5,.5,.5,1])};this.global_uniforms_containers=[this._uniforms];this.outline_color=[1,1,1,1];this._phong_uniforms={u_ambient:this._ambient_light,u_sun_light_vector:this._light_vector,u_sun_light_color:this._light_color};w.gl=this.gl;this.canvas=d.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:
!0;this.default_texture_settings={wrap:d.REPEAT,minFilter:d.LINEAR_MIPMAP_LINEAR,magFilter:d.LINEAR};this.default_cubemap_settings={minFilter:d.LINEAR_MIPMAP_LINEAR,magFilter:d.LINEAR,is_cross:1};this.default_material=new f.Material;this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=
this.default_texture=new GL.Texture(1,1,{filter:d.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:d.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.textures.bayer8x8=this._bayer_texture=new GL.Texture(8,8,{format:GL.LUMINANCE,pixel_data:new Uint8Array([0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,
22,41,25,37,21])});this._bayer_texture.setParameter(GL.TEXTURE_MAG_FILTER,d.NEAREST);this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.frame=0;this.stats={draw_calls:0,updated_shadowmaps:0};this.supports_instancing=d.extensions.ANGLE_instanced_arrays||1<d.webgl_version;this.createShaders();this.pipelineShader=new f.UberShader(J.getMasterVertexShader,J.getMasterFragmentShader);b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}}f.Renderer=J;J.prototype.setDataFolder=
function(a){a?(this.assets_folder=a,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};J.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],3<=a.length?a[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};J.prototype.destroy=function(){gl.destroy();f.Materials={}};J.prototype.render=function(a,b,d,l,k,x){null==l&&(l=65535);if(!a)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=
null,"Cannot render an scene while rendering an scene";b=b||a.camera;if(!b)throw"Renderer.render: camera not provided";w.gl=this.gl;this._nodes.length=0;d||a._root.getVisibleChildren(this._nodes,l,this.layers_affect_children);d=d||this._nodes;for(var y=0;y<d.length;++y)d[y].preRender&&d[y].preRender();y=this.getAllRenderables(d,l,b);this._state=[];this._meshes_missing=0;this.resetStats();this._current_scene=a;this._uniforms.u_time=a.time;vec3.normalize(this._light_vector,this._light_vector);k=k||
this.pipeline;d=y.filter(F=>F.flags&Z||b.testBBox(F.bounding)!==f.CLIP_OUTSIDE);0<this.small_objects_ratio_threshold&&(d=d.filter(F=>F.flags&Z||b.computeAproximateScreenSize(F.bounding)>this.small_objects_ratio_threshold));d=d.sort((F,D)=>F.material.blend_mode-D.material.blend_mode);l=this.lights.filter(F=>F.insideCamera(b)&&(!this.small_objects_ratio_threshold||b.projectedSphereSize(F._center,F.max_distance)>this.small_objects_ratio_threshold));this.updateShadowmaps(l,y,d);this.enableCamera(b);this._uniforms.u_res[0]=
gl.viewport_data[2];this._uniforms.u_res[1]=gl.viewport_data[3];this._uniforms.u_res[2]=1/gl.viewport_data[2];this._uniforms.u_res[3]=1/gl.viewport_data[3];this._uniforms.u_point_size=this.point_size;if(k)k.render(this,d,l,b,a,x);else for(this.allow_instancing&&this.supports_instancing&&(d=this.groupRenderablesForInstancing(d)),this.skybox_texture&&this.renderSkybox(b,this.skybox_texture),y=0;y<d.length;++y)k=d[y],k.node.flags.was_rendered=!0,this.renderRenderable(k,l);this.outline_renderables.length&&
this.renderOutline(this.outline_renderables,b);this.morph_texture&&(gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),this.morph_texture.toViewport());if(this.onPostRender)this.onPostRender(b);a.frame++;this.frame++;this._current_scene=null};J.prototype.renderRenderable=function(a,b){if(a.material.render)return a.material.render(this,a,b);b=b.filter(Y=>Y.overlaps(a));var d=a.mesh,l=a.node,k=a.skin,x=this._camera,y=a.material,F=a.primitive;if(null==F||-1==F)F=gl.TRIANGLES;var D=
!1;if(b.length&&!this.rendering_only_depth)for(var B=this._lights_uniforms.u_num_lights=Math.min(b.length,4),K=0;K<B;++K){var M=b[K];this._lights_uniforms.u_light_color[4*K]=M.color[0]*M.intensity;this._lights_uniforms.u_light_color[4*K+1]=M.color[1]*M.intensity;this._lights_uniforms.u_light_color[4*K+2]=M.color[2]*M.intensity;this._lights_uniforms.u_light_color[4*K+3]=M.light_type;M.light_type!==f.DIRECTIONAL_LIGHT&&(this._lights_uniforms.u_light_position.set(M._center,4*K),this._lights_uniforms.u_light_position[4*
K+3]=M.max_distance);this._lights_uniforms.u_light_front.set(M._front,4*K);this._lights_uniforms.u_light_params[4*K]=Math.cos(M.cone_start*n*.5);this._lights_uniforms.u_light_params[4*K+1]=Math.cos(M.cone_end*n*.5);this._lights_uniforms.u_light_params[4*K+2]=M._shadowmap_index;-1!==M._shadowmap_index&&(M=this.shadows_info.shadows[M._shadowmap_index],this.shadows_info.uniforms.u_shadowmap_rect.set(M.rect,4*K),this.shadows_info.uniforms.u_shadowmap_vps.set(M.vp,16*K),D|=1)}B=null;if(this.on_getShader){if(B=
this.on_getShader(a.node,x),!B)return}else if(B=this.shader_overwrite||y.shader_name){if(B=gl.shaders[B],!B)return}else B=0,k&&(B|=v.SKINNING),a.morphs&&(B|=v.MORPHTARGETS),a.instances&&this.supports_instancing&&(B|=v.INSTANCING),this.rendering_only_depth||(F!==GL.TRIANGLES&&F!==GL.TRIANGLE_STRIP&&F!==GL.TRIANGLE_FAN&&(B|=v.NO_TRIANGLES),this.use_alpha_hash&&0!=y.blend_mode&&(B|=v.ALPHA_HASH),this.use_flat_normal&&(B|=v.FLAT_NORMAL),this.use_secondary_buffer&&(B|=v.SECOND_BUFFER),this.rendering_flat?
B|=v.FLAT_COLOR:(this.use_fog&&(B|=v.FOG),d.vertexBuffers.colors&&(B|=v.COLOR),d.vertexBuffers.coords1&&(B|=v.COORD1),y.textures.color&&(B|=v.TEXTURE),y.textures.albedo&&(B|=v.ALBEDO),y.textures.emissive&&(B|=v.EMISSIVE),y.textures.occlusion&&(B|=v.OCCLUSION),y.uv_transform&&(B|=v.UV_TRANSFORM),"unlit"===y.model&&(B|=v.UNLIT),b.length&&(B|=v.LIGHTS,D&&(B|=v.SHADOWS)))),B=this.pipelineShader.getShader(B);M=!1;a.instances&&this.supports_instancing&&(M=!0);M&&!B.attributes.u_model&&(M=!1);var Q=0,O=
null;for(K in y.textures){var S=y.textures[K];if(S){S.constructor===Object&&(S=S.texture);var T="u_"+K+"_texture";if(!B||B.samplers[T])O=gl.textures[S],O||(this.autoload_assets&&-1!=S.indexOf(".")&&this.loadTexture(S,this.default_texture_settings),O=gl.textures.white),S=Q++,y.uniforms[T]=O.bind(S)}}O||(B.samplers.u_albedo_texture||B.samplers.u_color_texture)&&gl.textures.white.bind(0);this.enableItemFlags(y);k&&B.uniformInfo.u_bones&&(k.constructor===f.Skeleton?(this.bones=k.computeFinalBoneMatrices(this.bones,
d),B.setUniform("u_bones",this.bones)):k._bone_matrices&&B.setUniform("u_bones",k._bone_matrices));this._uniforms.u_global_alpha_clip=null!=y.alphaCutoff&&"MASK"==y.alphaMode?y.alphaCutoff:-1;this._uniforms.u_model.set(a.model);B.uniforms(this._uniforms);b.length&&B.uniforms(this._lights_uniforms);B.uniforms(x._uniforms);this.use_fog&&B.uniforms(this._fog_uniforms);B.uniforms(this._phong_uniforms);B.setUniform("u_color",y._color);B.setUniform("u_emissive",y._emissive);y.uv_transform&&B.setUniform("u_uvtransform",
y.uv_transform);B.uniforms(y.uniforms);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,B,l);B.hasUniform("u_bayer_texture")&&B.uniforms({u_bayer_texture:this._bayer_texture.bind(Q++)});a.morphs&&B.uniforms({u_morph_texture:a.morphs.bind(Q++)});D&&(this.shadows_info.uniforms.u_shadowmap=this.shadows_info.texture.bind(Q++),B.uniforms(this.shadows_info.uniforms));b=null;null!=a.group_index&&d.info&&d.info.groups&&d.info.groups[a.group_index]&&(b=d.info.groups[a.group_index]);if(M)L.u_model=
a.instances,b?B.drawInstanced(d,F,a.index_buffer_name,L,b.start,b.length):l.draw_range?B.drawInstanced(d,F,a.index_buffer_name,L,a.draw_range[0],a.draw_range[1]):B.drawInstanced(d,F,a.index_buffer_name,L);else if(a.instances){for(K=0;K<a.instances.length;K++)B.setUniform("u_model",a.instances[K]),b?B.drawRange(d,F,b.start,b.length,a.index_buffer_name):a.draw_range?B.drawRange(d,F,a.index_buffer_name,a.draw_range[0],a.draw_range[1]):B.draw(d,F,a.index_buffer_name),this.stats.draw_calls+=1;this.stats.draw_calls--}else b?
B.drawRange(d,F,b.start,b.length,a.index_buffer_name):a.draw_range?B.drawRange(d,F,a.index_buffer_name,a.draw_range[0],a.draw_range[1]):B.draw(d,F,a.index_buffer_name);this.disableItemFlags(y);this.stats.draw_calls+=1};J.shader_snippets={testShadowmap:"\n\tuniform vec4 u_shadowmap_rect[4];\n\tuniform mat4 u_shadowmap_vps[4];\n\tuniform sampler2D u_shadowmap;\n\n\tfloat testShadowmap( vec3 pos, vec4 rect, mat4 vp )\n\t{\n\t\tconst float bias = 0.004;\n\t\tvec4 proj = vp * vec4(pos, 1.0);\n\t\tvec2 sample = (proj.xy / proj.w) * vec2(0.5) + vec2(0.5);\n\t\tif(sample.x >= 0.0 && sample.x <= 1.0 && sample.y >= 0.0 && sample.y <= 1.0 )\n\t\t{\n\t\t\tsample = remap( sample, vec2(0.0), vec2(1.0), rect.xy, rect.zw );\n\t\t\tfloat depth = texture( u_shadowmap, sample ).x;\n\t\t\tif( depth > 0.0 && depth < 1.0 && depth <= ( ((proj.z-bias) / proj.w) * 0.5 + 0.5) )\n\t\t\t\treturn 0.0;\n\t\t}\n\t\treturn 1.0;\n\t}\n\t",
fog_code:"\n\t\t//float normalized_depth = linearize_depth(gl_FragCoord.z);//(gl_FragCoord.z * gl_FragCoord.w);\n\t\tfloat fog_factor = length( u_camera_position - v_pos ) / u_camera_planes.y;\n\t\tcolor.xyz = mix(color.xyz, u_fog_color.xyz, pow( fog_factor, 1.0 / u_fog_color.w ));\n\t",modify_ndotl:"",modify_attenuation:"",modify_prelight_equation:"",modify_light_equation:"",modify_color:"",modify_emissive:"",custom_uniforms:""};J.getMasterVertexShader=function(a){return`#version 300 es
precision highp float;
in vec3 a_vertex;
#ifndef FLAT_NORMAL
	in vec3 a_normal;
#endif
in vec2 a_coord;
#ifdef COORD1
	in vec2 a_coord1;
	out vec2 v_coord1;
#endif
out vec3 v_pos;
out vec3 v_normal;
out vec2 v_coord;
#ifdef COLOR
	in vec4 a_color;
	out vec4 v_color;
#endif

${a&v.SKINNING?f.Skeleton.shader_code:""}

#ifdef MORPHTARGETS
	uniform sampler2D u_morph_texture;
#endif

#ifdef INSTANCING
	in mat4 u_model;
#else
	uniform mat4 u_model;
#endif
uniform mat4 u_viewprojection;
uniform float u_point_size;

#ifdef UV_TRANSFORM
uniform mat3 u_uvtransform;
#endif

void main() {
	v_pos = a_vertex;

	${a&v.MORPHTARGETS?"v_pos += texelFetch(u_morph_texture,ivec2(gl_VertexID,0),0).xyz;":""}
	
	${a&v.SKINNING?"computeSkinning(v_pos,v_normal);":""}

	v_pos = (u_model * vec4(v_pos,1.0)).xyz;
	#ifndef FLAT_NORMAL
	v_normal = a_normal;
	${a&v.MORPHTARGETS?"v_pos += texelFetch(u_morph_texture,ivec2(gl_VertexID,1),0).xyz;":""}
	v_normal = (u_model * vec4(v_normal,0.0)).xyz;
	#endif
	v_coord = a_coord;
	#ifdef UV_TRANSFORM
		v_coord = (u_uvtransform * vec3(v_coord,1.0)).xy;
	#endif

	#ifdef COORD1
		v_coord1 = a_coord1;
	#endif
	#ifdef COLOR
	v_color = a_color;
	#endif
	gl_Position = u_viewprojection * vec4( v_pos, 1.0 );
	gl_PointSize = u_point_size;
}
`};J.getMasterFragmentShader=function(){return`#version 300 es
	
	precision highp float;
	in vec3 v_pos;
	in vec2 v_coord;
	in vec3 v_normal;
	#ifdef COLOR
	in vec4 v_color;
	#endif
	#ifdef COORD1
		in vec2 v_coord1;
	#else
		vec2 v_coord1;
	#endif	

	//material
	uniform vec4 u_color;
	uniform vec3 u_emissive;
	#ifdef TEXTURE
		uniform sampler2D u_color_texture;
	#endif
	#ifdef ALBEDO
		uniform sampler2D u_albedo_texture;
	#endif
	#ifdef EMISSIVE
		uniform sampler2D u_emissive_texture;
	#endif
	#ifdef OCCLUSION
		uniform sampler2D u_occlusion_texture;
	#endif
	uniform float u_global_alpha_clip;

	//globals
	uniform vec3 u_ambient;
	uniform vec3 u_sun_light_vector;
	uniform vec3 u_sun_light_color;

	#ifdef FOG
		uniform vec4 u_fog_color;
	#endif

	vec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }	

	#ifdef LIGHTS
		uniform int u_num_lights;
		uniform vec4 u_light_color[4]; //color, type
		uniform vec4 u_light_position[4]; //pos or vector, max_dist
		uniform vec4 u_light_front[4]; //front, 
		uniform vec4 u_light_params[4]; //cos cone start, cos cone end, shadowmap index, ?
	#endif

	#ifdef SHADOWS
	${J.shader_snippets.testShadowmap}
	#endif

	uniform sampler2D u_bayer_texture;
	float bayer8x8() {
		int x = int(mod(gl_FragCoord.x, 8.0));
		int y = int(mod(gl_FragCoord.y, 8.0));
		return texture( u_bayer_texture, vec2(float(x)/8.0,float(y)/8.0)).x * 4.0;
	}

	uniform vec4 u_res;
	uniform vec3 u_camera_position;
	uniform vec2 u_camera_planes;

	float linearize_depth(float d)
	{
		float z_n = 2.0 * d - 1.0;
		return 2.0 * u_camera_planes.x * u_camera_planes.y / (u_camera_planes.y + u_camera_planes.x - z_n * (u_camera_planes.y - u_camera_planes.x));
	}

	${J.shader_snippets.custom_uniforms}

	out vec4 FragColor;

	void main() {
		vec4 color = u_color;
		#ifdef FLAT_COLOR
			FragColor = color;
			return;
		#endif

		#ifndef COORD1
			v_coord1 = v_coord;
		#endif		
		#ifdef ALBEDO
			color *= texture(u_albedo_texture, v_coord);
		#endif
		#ifdef TEXTURE
			color *= texture(u_color_texture, v_coord);
		#endif
		#ifdef COLOR
			color *= v_color;
		#endif
		if(color.a <= u_global_alpha_clip)
			discard;
		#ifdef ALPHA_HASH
		if(color.a < bayer8x8())
			discard;
		#endif

		#ifdef FLAT_NORMAL
			vec3 A = dFdx(v_pos);
			vec3 B = dFdy(v_pos);
			vec3 N = normalize(cross(A,B));
		#else
			vec3 N = normalize(v_normal);
		#endif

		#ifdef NO_TRIANGLES
			N = normalize(v_pos - u_camera_position);
		#endif

		float NdotL = (dot(N,u_sun_light_vector)*0.5 + 0.5);
		#ifdef UNLIT
			NdotL = 1.0;
		#endif
		vec3 total_light = u_ambient + u_sun_light_color * NdotL;
		#ifdef OCCLUSION
			total_light = texture(u_occlusion_texture, v_coord1).xyz;
		#endif
		#ifdef LIGHTS
		for(int i = 0; i < 4; ++i)
		{
			if(i > u_num_lights)
				break;
			vec3 L = u_light_position[i].xyz - v_pos;
			int light_type = int(u_light_color[i].w);
			float att = 1.0;
			if( light_type == 3 ) //directional
			{
				L = -u_light_front[i].xyz;
			}
			else //spot and point
			{
				float light_dist = length(L);
				if(light_dist > u_light_position[i].w)
					continue;
				L /= light_dist;
				att = max(0.0,(u_light_position[i].w - light_dist) / u_light_position[i].w);
			}
			NdotL = max( 0.0, dot( N, L ) );
			#ifdef UNLIT
				NdotL = 1.0;
			#endif
			${J.shader_snippets.modify_ndotl}
			
			if( light_type == 1 ) //spot
			{
				float cos_angle = dot( u_light_front[i].xyz, -L );
				if(cos_angle < u_light_params[i].y )
					att = 0.0;
				else if (cos_angle < u_light_params[i].x )
					att *= 1.0 - (cos_angle - u_light_params[i].x) / (u_light_params[i].y - u_light_params[i].x);
			}

			${J.shader_snippets.modify_attenuation}

			#ifdef SHADOWS
				if (u_light_params[i].z != -1.0) //has shadowmap
				{
					att *= testShadowmap( v_pos, u_shadowmap_rect[ i ], u_shadowmap_vps[ i ] );
				}
			#endif

			${J.shader_snippets.modify_prelight_equation}
			vec3 light = u_light_color[i].xyz * att * NdotL;
			${J.shader_snippets.modify_light_equation}
			total_light += light;
		}
		#endif

		color.xyz *= total_light;
		vec3 emissive = u_emissive;
		#ifdef EMISSIVE
			emissive *= texture(u_emissive_texture, v_coord).xyz;
		#endif

		${J.shader_snippets.modify_emissive}
		color.xyz += emissive;

		#ifdef FOG
			${J.shader_snippets.fog_code}
		#endif

		${J.shader_snippets.modify_color}

		FragColor = color;
		#ifdef SECOND_BUFFER
		#endif
	}
	`};J.prototype.clearMorphTargets=function(){this.morph_textures.forEach(a=>a.delete());this.morph_textures.clear()};J.prototype.computeMorphTargets=function(a){if(a.morphs.length){var b=gl.meshes[a.mesh];if(!b.morphs)return null;var d=b.getBuffer("vertices").data.length/3,l=this.morph_textures.get(b);l||(l=new GL.Texture(d,2,{type:GL.HALF_FLOAT,format:GL.RGBA,filter:GL.NEAREST,wrap:GL.CLAMP_TO_EDGE}),this.morph_textures.set(b,l));var k=GL.Shader.getColoredScreenShader(),x=0;for(let B=0;B<a.morphs.length;++B){var y=
a.morphs[B];if(!(0>=y.weight)){x+=Math.abs(y.weight);y=b.morphs[B].buffers.vertices;var F=b.morphs[B].buffers.normals,D=this.morph_textures.get(y);D||(D=new Float32Array(2*y.length),D.set(y,0),F&&D.set(F,y.length),D=new GL.Texture(d,2,{type:GL.FLOAT,format:GL.RGB,pixel_data:D,filter:GL.NEAREST,wrap:GL.CLAMP_TO_EDGE}),this.morph_textures.set(y,D))}}if(.001>x)return null;l.drawTo(()=>{gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(GL.DEPTH_TEST);gl.enable(GL.BLEND);gl.blendFunc(GL.SRC_ALPHA,
GL.ONE);for(let M=0;M<a.morphs.length;++M){var B=a.morphs[M];if(!(0>=B.weight)){var K=this.morph_textures.get(b.morphs[M].buffers.vertices);K&&K.toViewport(k,{u_color:[1,1,1,B.weight]})}}});return l}};J.prototype.enableCamera=function(a){this._camera=a;a.updateMatrices();a.extractPlanes()};J.prototype.renderSkybox=function(a,b){var d=this._skybox_shader,l=gl.meshes.cube,k=gl.textures[b];k?(b=this._model_matrix,mat4.identity(b),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),mat4.setTranslation(b,
a.position),a=.5*a.far+.5*a.near,mat4.scale(b,b,[a,a,a]),this.renderMesh(b,l,k,[1,1,1,1],d)):this.autoload_assets&&-1!=b.indexOf(".")&&this.loadTexture(b,renderer.default_texture_settings)};J.prototype.renderOutline=function(a,b){b=gl.viewport_data[2];var d=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==b&&this._selection_buffer.height==d||(this._selection_buffer=new GL.Texture(b,d,{magFilter:gl.NEAREST}));J.outline_material||(J.outline_material=new f.Material);gl.disable(gl.SCISSOR_TEST);
this._selection_buffer.drawTo(()=>{gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var k=this.onNodeShaderUniforms;this.onNodeShaderUniforms=function(y,F){F.setUniform("u_color",[1,1,1,1])};var x=this.pipeline;this.pipeline=null;this.overwrite_material=f.Renderer.outline_material;this.rendering_flat=!0;for(let y=0;y<a.length;++y)this.renderRenderable(a[y],[]);this.shader_overwrite=null;this.onNodeShaderUniforms=k;this.rendering_flat=!1;this.pipeline=x;this.overwrite_material=
null});var l=gl.shaders.outline;l||=gl.shaders.outline=GL.Shader.createFX("\n\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\t"+(this.outline_diagonals?"\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\t":
"\n\t\t\tvec3 outline = vec3( abs(color.x - colorU.x) + abs(color.x - colorL.x) > 0.0 ? 1.0 : 0.0);\n\t\t\t")+"\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t","uniform vec2 u_res;\n");gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(l,{u_color:this.outline_color,u_res:[1/b,1/d]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)};J.prototype.setGlobalUniforms=function(a){for(var b in a)this._uniforms[b]&&
this._uniforms[b].set?this._uniforms[b].set(a[b]):this._uniforms[b]=a[b]};J.prototype.updateShadowmaps=function(a,b,d){a.forEach(B=>B._shadowmap_index=-1);a=a.filter(B=>B.cast_shadows&&B.light_type!==f.POINT_LIGHT);if(0!=a.length){this.shadows_info||(d=new GL.Texture(2048,2048,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadows_info={num_shadows:0,texture:d,fbo:new GL.FBO(null,d),uniforms:{u_shadowmap:0,u_shadowmap_rect:new Float32Array(16),u_shadowmap_vps:new Float32Array(64)},
shadows:[]});this.shadows_info.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);this.shadow_camera||(this.shadow_camera=new m);var l=this.shadow_camera;this.rendering_only_depth=!0;for(d=0;d<a.length;++d){var k=a[d],x=d%2*1024,y=1024*Math.floor(d/2);gl.viewport(x,y,1024,1024);k.light_type===f.SPOT_LIGHT?l.perspective(k.cone_end,1,.1,k.max_distance):l.orthographic(k.area,.1,k.max_distance,1);l.lookAt(k.getGlobalPosition(),k.localToGlobal([0,0,-1]),[0,1,0]);this.enableCamera(l);gl.enable(gl.DEPTH_TEST);var F=
b.filter(B=>B.instances||B.skin||l.testMesh(B.mesh,B.model)!==f.CLIP_OUTSIDE);F=this.groupRenderablesForInstancing(F);for(var D=0;D<F.length;++D)this.renderRenderable(F[D],[]);k._shadowmap_index=d;(k=this.shadows_info.shadows[d])||(k=this.shadows_info.shadows[d]={rect:vec4.create(),vp:mat4.create()});k.rect.set([x/2048,y/2048,(x+1024)/2048,(y+1024)/2048]);k.vp.set(l._viewprojection_matrix);this.stats.updated_shadowmaps++}this.shadows_info.num_shadows=a.length;this.shadows_info.fbo.unbind();this.shadows_info.texture.bind();
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);this.rendering_only_depth=!1}};J.prototype.renderMesh=function(a,b,d,l,k,x,y,F){b&&(a||(a=f.IDENTITY),this._uniforms.u_model.set(a),k||=this.getMasterShader(d?v.ALBEDO:0),d&&(this._uniforms.u_texture=d.bind(0)),k.uniforms(this._uniforms),k.uniforms(this._camera._uniforms),l&&k.uniforms({u_color:l}),null!=F?(a=b.info.groups[F],k.drawRange(b,null==x?gl.TRIANGLES:x,a.start,
a.length,y)):k.draw(b,null==x?gl.TRIANGLES:x,y),this.stats.draw_calls+=1)};J.prototype.getAllRenderables=function(a,b,d){this.resetRenderablesPool();var l=this.renderables;l.length=0;this.lights.length=0;for(var k=this.outline_renderables.length=0;k<a.length;++k){var x=a[k];x.flags.was_renderer=!1;!1!==x.flags.visible&&x.layers&b&&((x.mesh||x._mesh)&&this.getNodeRenderables(x,d),x.constructor===f.Light&&(x.getGlobalVector(f.FRONT,x._front),x.getGlobalPosition(x._center),this.lights.push(x)))}if(this.onFilterRenderables)this.onFilterRenderables(l);
if(d){for(k=0;k<l.length;++k)l[k].computeRenderPriority(d._position);l=l.sort((y,F)=>F._render_priority-y._render_priority)}return l};J.prototype.resetStats=function(){this.stats.draw_calls=0;this.stats.updated_shadowmaps=0};J.prototype.resetRenderablesPool=function(){this.used_renderables=0};J.prototype.getRenderablesFromPool=function(){if(this.used_renderables<this.renderables_pool.length){var a=this.renderables_pool[this.used_renderables];this.used_renderables++;return a}a=new f.Renderable;a.id=
this.used_renderables;this.renderables_pool.push(a);this.used_renderables++;return a};J.prototype.getNodeRenderables=function(a,b){var d=null;if(a._mesh)d=a._mesh;else if(a.mesh&&(d=gl.meshes[a.mesh],!d)){this.autoload_assets&&-1!=a.mesh.indexOf(".")&&this.loadMesh(a.mesh);return}if(d){var l=a.skeleton||a.skin||null;!l||l.bones||l.joints||(l=null);l&&l.bones&&!l.bones.length&&(l=null);l&&l.joints&&!l.joints.length&&(l=null);l&&l.joints&&(!l._bone_matrices||this.force_update_bones)&&a.updateSkinningBones(a._parent);
J.temp_bbox||(J.temp_bbox=BBox.create(),J.aabb_center=BBox.getCenter(J.temp_bbox),J.aabb_halfsize=BBox.getHalfsize(J.temp_bbox));var k=J.temp_bbox;BBox.transformMat4(k,d.getBoundingBox(),a._global_matrix);if(!l&&b&&!a._instances){if(b.testBox(J.aabb_center,J.aabb_halfsize)==f.CLIP_OUTSIDE)return;a._last_rendered_frame=this.frame}b=null;a.morphs&&(b=this.computeMorphTargets(a));if(a.primitives&&a.primitives.length)for(var x=0;x<a.primitives.length;++x){var y=a.primitives[x],F;if(F=y.material?f.Materials[y.material]:
this.default_material){var D=this.getRenderablesFromPool();D.material=F;D.model=a._global_matrix;D.mesh=d;D.group_index=x;D.node=a;D.draw_range=null;D._render_priority=F.render_priority||0;D.instances=a._instances;D.flags=D.instances||l?Z:0;D.reverse_faces=a.flags.frontFace==GL.CW;D.skin=l;D.index_buffer_name="triangles";D.primitive=null!=y.mode?y.mode:F.primitive;D.bounding.set(k);D.morphs=b;this.renderables.push(D);0==x&&a.flags.outline&&(y=this.getRenderablesFromPool(),y.copyFrom(D),y.group_index=
-1,this.outline_renderables.push(y))}}else a.material&&(F=f.Materials[a.material])&&(D=this.getRenderablesFromPool(),D.material=F,D.model=a._global_matrix,D.mesh=d,D.group_index=a.submesh,D.node=a,D.instances=a._instances,D.skin=l,D.draw_range=a.draw_range,D.primitive=null!=a.primitive?a.primitive:F.primitive,D._render_priority=F.render_priority||0,D.reverse_faces=a.flags.frontFace==GL.CW,D.bounding.set(k),D.index_buffer_name=a.indices_name||"triangles",D.morphs=b,D.flags=D.instances||l?Z:0,this.renderables.push(D),
a.flags.outline&&(y=this.getRenderablesFromPool(),y.copyFrom(D),y.group_index=-1,this.outline_renderables.push(y)))}};J._last_mesh_id=0;J.prototype.groupRenderablesForInstancing=function(a){for(var b=new Map,d=0,l=0;l<a.length;++l){var k=a[l];k.mesh.name||(k.mesh.name="##M"+J._last_mesh_id++);var x=k.instances||k.skin||k.draw_range?d++:k.mesh.name+":"+k.group_index+"/"+k.primitive+"/"+k.material.name+(k.reverse_faces?"[R]":"");b.has(x)?b.get(x).push(k):b.set(x,[k])}a=[];k=b.values();for(var y of k)if(0!=
y.length)if(1==y.length)k=y[0],this.debug_instancing||a.push(k);else{k=this.getRenderablesFromPool();k.copyFrom(y[0]);k.instances=Array(y.length);for(b=0;b<y.length;++b)d=y[b],b&&BBox.merge(k.bounding,k.bounding,d.bounding),k.instances[b]=d.model;a.push(k)}return a};J.prototype.renderBounding=function(a,b,d){if(a){b=b||f.IDENTITY;var l=this._uniforms.u_model;a=a.constructor===GL.Mesh?a._bounding:a;d=d||[1,1,0,1];var k=a.subarray(3,6);mat4.translate(l,b,a.subarray(0,3));mat4.scale(l,l,[2*k[0],2*k[1],
2*k[2]]);this.renderMesh(l,gl.meshes.cube,null,d,null,gl.LINES,"wireframe")}};J.prototype.enableItemFlags=function(a){var b=a.flags.flip_normals;this.reverse_normals&&(b=!b);gl.frontFace(b?gl.CW:gl.CCW);!1===a.flags.depth_test?gl.disable(gl.DEPTH_TEST):gl.enable(gl.DEPTH_TEST);!1===a.flags.depth_write&&gl.depthMask(!1);!0===a.flags.two_sided||this.disable_cull_face?gl.disable(gl.CULL_FACE):gl.enable(gl.CULL_FACE);if(this.rendering_only_depth||a.blend_mode===f.BLEND_NONE||this.use_alpha_hash)gl.disable(gl.BLEND);
else switch(gl.enable(gl.BLEND),a.blend_mode){case f.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case f.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case f.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}this.rendering_only_depth||this.use_alpha_hash||"BLEND"!==a.alphaMode||(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};J.prototype.disableItemFlags=function(a){a.flags.flip_normals&&gl.frontFace(gl.CCW);!1===a.flags.depth_test&&
gl.enable(gl.DEPTH_TEST);a.blend_mode!==f.BLEND_NONE&&gl.disable(gl.BLEND);a.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===a.flags.depth_write&&gl.depthMask(!0);"BLEND"==a.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};J.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};f.Renderer.prototype.renderPoints=function(a,b,d,l,k,x,y,F,D){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";k||(y==GL.LINES||
y==GL.LINE_LOOP?k=this.shaders.flat:F?(k=this.shaders._points_textured,k||(k=this.shaders._points_textured=new GL.Shader(f.points_vs_shader,f.points_fs_shader,{TEXTURED:""}),k.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(k=this.shaders[b?"_points_color":"_points"],k||(k=b?this.shaders._points_color=new GL.Shader(f.points_vs_shader,f.points_fs_shader,{COLORED:""}):this.shaders._points=new GL.Shader(f.points_vs_shader,f.points_fs_shader),k.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));x=
x||1;var B=1024;l=l||a.length/3;var K=this._points_mesh;l>a.length/3&&(l=a.length/3);if(!K||a.length>3*B){l>B&&(B=GL.Texture.nextPOT(l));var M=new Float32Array(3*B);B=new Float32Array(4*B);K=this._points_mesh=GL.Mesh.load({vertices:M,extra4:B})}else M=this._points_mesh.getBuffer("vertices").data,B=this._points_mesh.getBuffer("extra4").data;M.set(M.length>a.length?a:a.subarray(0,M.length));b?B.set(B.length>b.length?b:b.subarray(0,B.length)):B.fill&&B.fill(0);K.upload(GL.DYNAMIC_STREAM);k.setUniform("u_color",
this._color);k.setUniform("u_pointSize",x);k.setUniform("u_camera_perspective",d._projection_matrix[5]);k.setUniform("u_model",D||f.IDENTITY);k.setUniform("u_viewport",gl.viewport_data);k.setUniform("u_viewprojection",d._viewprojection_matrix);F&&k.setUniform("u_texture",F.bind(0));k.drawRange(K,null!=y?y:GL.POINTS,0,l);return K};f.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
f.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvarying vec4 v_extra4;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef COLORED\n\t\tcolor *= v_extra4;\n\t#endif\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
J.prototype.renderLines=function(a,b,d){this.renderPoints(a,null,null,null,null,null,gl.LINES,null,d)};J.prototype.render3DLines=function(a,b,d,l){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var k=this.shaders._lines;k||=this.shaders._lines=new GL.Shader(f.lines_vs_shader,this._flat_fragment_shader);var x=this._camera,y=a.length/3,F=d?2*y:4*y;var D=this._lines_mesh;if(!D||3*F>D.getBuffer("vertices").data.length){D=GL.Texture.nextPOT(F);F=new Float32Array(3*
D);var B=new Float32Array(3*D);var K=new Float32Array(2*D);indices_data=new Uint16Array(3*D);D=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:F,normals:B,extra2:K})}else F=this._lines_mesh.getBuffer("vertices").data,B=this._lines_mesh.getBuffer("normals").data,K=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data;var M=vec2.fromValues(-1,-1),Q=vec2.fromValues(1,-1),O=vec2.fromValues(-1,1),S=vec2.fromValues(1,1),T=vec3.create();if(d)throw"strip lines not supported yet";
for(var Y=Math.floor(y/2),R=0;R<Y;++R){var V=2*R,aa=a.subarray(3*V,3*V+3);V=a.subarray(3*V+3,3*V+6);vec3.sub(T,V,aa);F.set(aa,12*R);F.set(aa,12*R+3);F.set(V,12*R+6);F.set(V,12*R+9);B.set(T,12*R);B.set(T,12*R+3);B.set(T,12*R+6);B.set(T,12*R+9);K.set(M,8*R);K.set(Q,8*R+2);K.set(O,8*R+4);K.set(S,8*R+6);indices_data.set([4*R,4*R+2,4*R+1,4*R+1,4*R+2,4*R+3],6*R)}D.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);k.setUniform("u_model",l||f.IDENTITY);k.setUniform("u_color",this._color);k.setUniform("u_camera_front",
x._front);k.setUniform("u_camera_position",x.eye);k.setUniform("u_lineWidth",.5*b);k.setUniform("u_camera_perspective",x._projection_matrix[5]);k.setUniform("u_viewport",gl.viewport_data);k.setUniform("u_viewprojection",x._viewprojection_matrix);k.drawRange(D,gl.TRIANGLES,0,y*(d?6:3));return D};f.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
f.Renderer.prototype.drawImage=function(a,b,d,l,k,x,y,F,D){a.constructor===String&&(a=this.loadTexture(a));if(a){if(null==l||null==k)x=b,y=d,l=F=a.width,k=D=a.height;else if(null==x||null==y||null==F||null==D)x=b,y=d,F=l,D=k,d=b=0,l=a.width,k=a.height;var B=this.shaders._textured_quad;B||=this.shaders._textured_quad=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_rect;\n\t\tuniform vec4 u_src_rect;\n\t\tuniform vec4 u_viewport;\n\t\tfloat remap(in float value, in float low1, in float high1, in float low2, in float high2 ) { float range1 = high1 - low1; float range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n\t\t\n\t\tvoid main() {\n\t\t\tv_coord = a_coord;\n\t\t\tvec4 pos = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\tpos.x = remap(pos.x, -1.0, 1.0, u_rect.x, u_rect.x + u_rect.z );\n\t\t\tpos.x = remap(pos.x, 0.0, u_viewport.z, -1.0, 1.0 );\n\t\t\tpos.y = remap(pos.y, -1.0, 1.0, u_rect.y, u_rect.y + u_rect.w );\n\t\t\tpos.y = remap(pos.y, 0.0, u_viewport.w, 1.0, -1.0 );\n\t\t\tv_coord.x = remap( v_coord.x, 0.0, 1.0, u_src_rect.x, u_src_rect.x + u_src_rect.z );\n\t\t\tv_coord.y = remap( v_coord.y, 1.0, 0.0, u_src_rect.y, u_src_rect.y + u_src_rect.w );\n\t\t\tgl_Position = pos;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform sampler2D u_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D( u_texture, v_coord );\n\t\t\tif(color.a == 0.0) discard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t");var K=GL.Mesh.getScreenQuad();B.bind();B.setUniform("u_color",this._color);B.setUniform("u_rect",[x,y,F,D]);B.setUniform("u_src_rect",[b/a.width,d/a.height,l/a.width,k/a.height]);B.setUniform("u_viewport",gl.viewport_data);
B.setUniform("u_texture",a.bind(0));gl.disable(GL.DEPTH_TEST);gl.disable(GL.CULL_FACE);B.draw(K,GL.TRIANGLES)}};J.prototype.getAssetFullPath=function(a,b){if(-1==a.indexOf("://")&&!b&&this.assets_folder){if(this.onGetAssetsFolder)return this.onGetAssetFolder(a);b="/"==this.assets_folder.substr(-1);var d="/"==a[0];return b!=d?this.assets_folder+a:b&&d?this.assets_folder+a.substr(1):this.assets_folder+"/"+a}return a};J.prototype.loadMesh=function(a,b,d){if(!a)return console.error("loadMesh: Cannot load null name");
if(!this.assets_loading[a]&&!this.assets_not_found[a]){var l=this.meshes[a];if(l)return b&&b(l),l;var k=this;d=this.getAssetFullPath(a,d);d=GL.Mesh.fromURL(d,function(x){x?k.meshes[a]=x:(k.assets_not_found[a]=!0,delete k.meshes[a]);k.num_assets_loading--;delete k.assets_loading[a];b&&b(x,a)});this.assets_loading[a]=d;this.num_assets_loading++;return this.meshes[a]=d}};J.prototype.loadTexture=function(a,b,d,l){function k(B){F.debug&&console.log(" + texture loaded: "+a);B?F.textures[x]=B:F.assets_not_found[a]=
!0;d&&d(B,x);F.num_assets_loading--;delete F.assets_loading[a];if(F.on_texture_load)F.on_texture_load(B,x)}if(!a)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var x=a;b&&(b.name&&(x=b.name),b.preview&&(x=b.preview));var y=this.textures[x];if(y&&!y.is_preview)return d&&d(y),y;var F=this;l=this.getAssetFullPath(a,l);var D=null;-1!=a.indexOf("CUBEMAP")?D=GL.Texture.cubemapFromURL(l,this.default_cubemap_settings,k):this.credentials?(this.credentials.headers?
this.credentials.headers["Content-Type"]="application/octet-stream":this.credentials.headers={"Content-Type":"application/octet-stream"},D=new GL.Texture(1,1,b),fetch(l,this.credentials).then(function(B){if(!B.ok)throw Error("HTTP "+B.status+":"+B.statusText);return B.arrayBuffer()}).then(function(B){var K=URL.createObjectURL(new Blob([B]));b.texture=D;D=GL.Texture.fromURL(K,b,k);b.texture=null;setTimeout(function(){URL.revokeObjectURL(K)},6E4)})):D=GL.Texture.fromURL(l,b,k);b&&b.preview&&(D.is_preview=
!0);this.assets_loading[a]=D;this.num_assets_loading++;return this.textures[x]=D}};J.prototype.createShaders=function(){var a=this._vertex_shader="\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec3 v_pos;\n\t\tvarying vec3 v_normal;\n\t\tvarying vec2 v_coord;\n\t\t#ifdef COLOR\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t\tvoid main() {\n\t\t\tv_pos = a_vertex;\n\t\t\tv_normal = a_normal;\n\t\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t\tv_coord = a_coord;\n\t\t\t#ifdef COLOR\n\t\t\tv_color = a_color;\n\t\t\t#endif\n\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\tgl_PointSize = 2.0;\n\t\t}\n\t",
b=this._flat_fragment_shader="\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\t#ifdef COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t\t#endif\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color = u_color;\n\t\t\t\t\t#ifdef COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t\t#endif\n\t\t\t\t  gl_FragColor = color;\n\t\t\t\t}\n\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,b);gl.shaders.flat_color=this._flat_instancing_shader=new GL.Shader(a,b,{COLOR:""});this._point_shader=new GL.Shader("\n\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tuniform mat4 u_model;\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tuniform float u_pointSize;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\t\tvec3 vertex = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\t}\n\t\t\t\t",
"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\n\t\t\t\t     discard;\n\t\t\t\t  gl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t\tuniform vec4 u_color;\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t\tvoid main() {\n\t\t\tv_color = a_color * u_color;\n\t\t\tvec3 vertex = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec4 v_color;\n\t\tvoid main() {\n\t\t  gl_FragColor = v_color;\n\t\t}\n\t");gl.shaders.color=this._color_shader;gl.shaders.texture=this._texture_shader=new GL.Shader(a,"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\t#ifdef COLOR\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\t#ifdef COLOR\n\t\t\t\tcolor *= v_color;\n\t\t\t#endif\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");
gl.shaders.skybox=this._skybox_shader=new GL.Shader("\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\tvarying vec3 v_pos;\n\tvarying vec3 v_wPos;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\t\n\tvoid main() {\n\t\tv_coord = a_coord;\n\t\tvec3 vertex = a_vertex;\t\n\t\tv_pos = vertex;\n\t\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\t\tv_wNormal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\tgl_Position = u_viewprojection * vec4(v_wPos,1.0);\n\t}\n\t",
"\n\tprecision highp float;\n\tvarying vec3 v_pos;\n\tvarying vec3 v_wPos;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\t\n\tuniform vec4 u_color;\n\tuniform samplerCube u_color_texture;\n\tuniform vec3 u_camera_position;\n\t\n\tvoid main() {\n\t  vec3 L = normalize(vec3(1.,1.,-1.));\n\t  vec3 N = normalize( v_wNormal );\n\t\tvec3 E = normalize( v_wPos - u_camera_position );\n\t  vec4 color = u_color;\n\t  color.xyz = textureCube( u_color_texture, -E * vec3(1.0,-1.0,1.0) ).xyz;\n\t  gl_FragColor = color;\n\t}\n\t")};
J.prototype.loadTextureAtlas=function(a,b,d){"string"==typeof a&&(a=JSON.parse(a));var l=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(k){var x=a.files;l.textures[":atlas"]=k;for(var y in x)if(!l.textures[y]||l.textures[y].is_preview){var F=x[y],D=new GL.Texture(a.size,a.size,{wrap:gl.REPEAT,filter:gl.LINEAR});D.drawTo(function(){k.gl.drawTexture(k,0,0,a.size,a.size,F.x,F.y,F.width||a.size,F.height||a.size)});D.is_preview=!0;l.textures[y]=D}d&&d(x)})};J.prototype.loadShaders=
function(a,b,d,l){var k=this;-1!=a.indexOf("://")||l||(a=this.assets_folder+a);a+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(a,function(x){k.compileShadersFromAtlas(x,d);k.loading_shaders=!1;b&&b(x)})};J.prototype.compileShadersFromAtlasCode=function(a,b){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a,b)};J.prototype.compileShadersFromAtlas=function(a,b){var d=a.shaders;if(d){this.shader_files=a;for(var l in a)a[l]=GL.Shader.expandImports(a[l],a);d=d.split("\n");for(l=
0;l<d.length;++l){var k=d[l].trim().split(" "),x=k[0].trim();if("//"!=x.substr(0,2)){var y=a[k[1]],F=a[k[2]],D=null,B={};if(3<k.length)for(var K=3;K<k.length;++K)if("#"==k[K][0])B[k[K].substr(1)]=!0;else{D=k.slice(K).join(" ");break}if(!B.WEBGL1||1==gl.webgl_version)if(!B.WEBGL2||2==gl.webgl_version){k[1]&&"@"==k[1][0]&&(B=k[1].substr(1)+"_VERTEX_SHADER",GL.Shader[B]&&(y=GL.Shader[B]));k[2]&&"@"==k[2][0]&&(B=k[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[B]&&(F=GL.Shader[B]));if(D)try{D=JSON.parse(D)}catch(Q){console.error("Error in shader macros: ",
x,D,Q)}if(D&&b){B={};for(var M in D)B[M]=D[M];for(M in b)B[M]=b[M];D=B}else b&&(D=b);try{y&&F?this.shaders[x]?this.shaders[x].updateShader(y,F,D):this.shaders[x]=new GL.Shader(y,F,D):console.warn("Shader subfile not found: ",k[1],k[2])}catch(Q){GL.Shader.dumpErrorToConsole(Q,y,F)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};J.prototype.setShadersFromFile=function(a){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a)};J.cubemap_info=[{front:[1,0,0],
up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];J.prototype.renderToCubemap=function(a,b,d,l,k,x,y){var F=J.cubemap_camera;F||(J.cubemap_camera=F=new f.Camera);F.perspective(90,1,x||.1,y||1E3);var D=vec3.create(),B=this;a.drawTo(function(K,M){K=J.cubemap_info[M];vec3.add(D,d,K.front);F.lookAt(d,D,K.up);B.clear();B.render(b,F,l,k)});return a};J.prototype.drawSphere3D=function(a,b,d){gl.meshes.sphere||
(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var l=gl.shaders.flat;l.setUniform("u_color",d);l.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(e);mat4.translate(e,e,a);mat4.scale(e,e,[b,b,b]);l.setUniform("u_model",e);l.draw(gl.meshes.sphere);this.stats.draw_calls+=1};J.prototype.drawCircle2D=function(a,b,d,l,k){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:.02,slices:64}));var x=
gl.shaders.flat;x.setUniform("u_color",l);x.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(e);mat4.translate(e,e,[a,b,0]);mat4.scale(e,e,[2*d,2*d,2*d]);x.setUniform("u_model",e);x.draw(gl.meshes[k?"circle":"ring"]);this.stats.draw_calls+=1};J.prototype.drawLine2D=function(a,b,d,l,k,x,y){var F=gl.meshes.plane;y=y||gl.shaders.flat;y.setUniform("u_color",x);y.setUniform("u_viewprojection",this._viewprojection2D_matrix);var D=d-a,B=l-b;x=Math.atan2(D,B);D=Math.sqrt(D*D+B*B);
k/=2;mat4.identity(e);mat4.translate(e,e,[.5*(a+d),.5*(b+l),0]);mat4.rotate(e,e,x,f.FRONT);a=k;mat4.scale(e,e,[a,D,a]);y.setUniform("u_model",e);y.draw(F);this.stats.draw_calls+=1};J.prototype.renderDebugSceneTree=function(a,b){for(var d=[],l=0;l<a._nodes.length;++l){var k=a._nodes[l];if(k._parent&&k._parent!=a.root){var x=k._parent.getGlobalPosition();k=k.getGlobalPosition();d.push(x[0],x[1],x[2],k[0],k[1],k[2])}}d=new Float32Array(d);this.renderPoints(d,null,b,null,null,null,GL.LINES);this.renderPoints(d,
null,b,null,null,-10,GL.POINTS)};f.generateTextureAtlas=function(a,b,d,l,k){b=b||1024;d=d||1024;l=l||64;var x=0,y;for(y in a)x++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);x=new GL.Texture(b,d);var F={width:b,height:d,size:l,files:{}},D=0,B=0,K={};x.drawTo(function(){for(var M in a)if(":"!=M[0]&&"white"!=M&&"black"!=M&&"notfound"!=M){var Q=a[M];if(!Q.is_preview&&Q.texture_type==gl.TEXTURE_2D){if(k){var O=Q.toBase64().hashCode();if(K[O]){F.files[M]=F.files[K[O]];continue}K[O]=
M}F.files[M]={x:D,y:B};Q.renderQuad(D,B,l,l);D+=l;if(D==b&&(D=0,B+=l,B==d)){console.warn("Atlas too small, some textures wont be stored.");break}}}});x.info=F;console.log(F);return x};J.prototype.computeResourcesLoaded=function(a){var b=0,d;for(d in a){var l=a[d],k=this.textures[l];k&&!1===k.ready||(l=this.meshes[l])&&!1===l.ready||(k||l)&&b++}return b};Object.defineProperty(J.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(a){},enumerable:!0});Object.defineProperty(J.prototype,
"textures",{get:function(){return this.gl.textures},set:function(a){},enumerable:!0});Object.defineProperty(J.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(a){},enumerable:!0});J.prototype.addMesh=function(a,b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};f.Renderer=J;class W{constructor(){this.name="";this.id=-1;this.flags=0;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=this.draw_range=null;this.reverse_faces=
!1;this.primitive=-1;this.morphs=this.skin=null;this.bounding=BBox.create();this.node=this.instances=null;this._render_priority=0}copyFrom(a){this.name=a.name;this.id=a.id;this.flags=a.flags;this.mesh=a.mesh;this.model=a.model;this.index_buffer_name=a.index_buffer_name;this.group_index=a.group_index;this.material=a.material;this.reverse_faces=a.reverse_faces;this.skin=a.skin;this.draw_range=a.draw_range;this.primitive=a.primitive;this.instances=a.instances;this.morphs=a.morphs;this.bounding.set(a.bounding);
this._render_priority=a._render_priority;this.node=a.node}computeRenderPriority(a){this.name=this.node.name;var b=this.mesh.getBoundingBox();b&&(b=mat4.multiplyVec3(t,this.model,b),this._render_priority=this.material.render_priority||0,a=vec3.distance(a,b),"BLEND"==this.material.alphaMode?(this._render_priority+=.001*a,this._render_priority-=100):this._render_priority+=1E3-.001*a)}}f.Renderable=W;class X{constructor(a,b){this.name="";this.shaders=new Map;this.fs_generator=this.vs_generator=null;this.vs_generator=
a;this.fs_generator=b}replacePragmas(a,b){for(var d in b)a=a.replaceAll("#pragma "+d,b[d])}getShader(a){a=a||0;var b=this.shaders,d=b.get(a);if(d)return d;d=this.vs_generator(a);var l=this.fs_generator(a),k=null;if(a){k={};for(var x in v)a&v[x]&&(k[x]="")}d=new GL.Shader(d,l,k);b.set(a,d);return d}}f.UberShader=X;f.Ray=g;g.prototype.testPlane=function(a,b){return geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point)};g.prototype.testSphere=function(a,b,d){return geo.testRaySphere(this.origin,
this.direction,a,b,this.collision_point,d)};g.prototype.closestPointOnRay=function(a,b,d){d=d||vec3.create();var l=vec3.create();vec3.add(l,this.origin,this.direction);var k=vec3.create();vec3.add(k,a,b);geo.closestPointBetweenLines(this.origin,l,a,k,null,d);return d};f.Factory=function(a,b,d){a=f.Factory.templates[a];var l=new f.SceneNode;a&&l.fromJSON(a);b&&(b.constructor===f.Scene?b.root:b).addChild(l);d&&l.fromJSON(d);return l};f.Factory.templates={grid:{mesh:"grid",material:{primitive:1,color:[.5,
.5,.5,.5],blend_mode:f.BLEND_ALPHA}},sphere:{mesh:"sphere"},floor:{mesh:"planeXZ",scaling:10}};f.parseTextConfig=function(a){function b(l,k){for(var x=d.shift();x;)if(0==x.trim().length)x=d.shift();else{for(var y=0;"\t"==x[y]&&y<x.length;)y++;if(y<k)break;var F={children:[]};try{var D=x.trim();-1!=D.indexOf(":")&&(D="{"+D+"}");var B=new Function("return "+D);F.data=B()}catch(K){console.error(K)}y>=k&&(l&&l.children.push(F),x=b(F,y+1))}return x}var d=a.split("\n");a={data:"",children:[]};b(a,0);return a};
var Z=1;f.orientNodeToCamera=function(a,b,d,l){a&&(a==f.BILLBOARD_CYLINDRIC||a==f.BILLBOARD_PARALLEL_CYLINDRIC?(a==f.BILLBOARD_CYLINDRIC?(a=b.getGlobalPosition(E),vec3.sub(t,d._position,a),h[0]=t[0],h[1]=t[2]):(h[0]=d._front[0],h[1]=d._front[2]),d=vec2.computeSignedAngle(h,f.FRONT2D),isNaN(d)||(mat4.rotateY(e,c,-d),b._global_matrix.set(e),mat4.setTranslation(b._global_matrix,b._position),mat4.scale(b._global_matrix,b._global_matrix,b._scale))):(a==f.BILLBOARD_PARALLEL_SPHERIC?(b._global_matrix.set(d._model_matrix),
mat4.setTranslation(b._global_matrix,b._position)):(mat4.lookAt(b._global_matrix,b._position,d.position,f.UP),mat4.invert(b._global_matrix,b._global_matrix)),mat4.scale(b._global_matrix,b._global_matrix,b._scale)))};f.makeHash=function(a){let b="";for(var d=0;d<a;d++)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(62*Math.random()|0);return b};f.readPixels=function(a,b){var d=new Image;d.src=a;d.onload=function(){var l=document.createElement("canvas");l.width=this.width;
l.height=this.height;var k=l.getContext("2d");k.drawImage(this,0,0);l=k.getImageData(0,0,l.width,l.height);b(l,this)}};f.alignDivToNode=function(a,b,d,l,k,x){function y(O){return 1E-5>Math.abs(O)?0:O}function F(O){return"matrix3d("+y(O[0])+","+y(-O[1])+","+y(O[2])+","+y(O[3])+","+y(O[4])+","+y(-O[5])+","+y(O[6])+","+y(O[7])+","+y(O[8])+","+y(-O[9])+","+y(O[10])+","+y(O[11])+","+y(O[12])+","+y(-O[13])+","+y(O[14])+","+y(O[15])+")"}var D=parseInt(a.clientWidth),B=parseInt(a.clientHeight),K=.5*D,M=.5*
B,Q=k._projection_matrix[5]*M;a.style.width=gl.canvas.width+"px";a.style.height=gl.canvas.height+"px";a.style.perspective=Q+"px";a.style.pointerEvents="none";b&&(a="translateZ("+Q+"px) "+F(k._view_matrix),b.style.transformStyle="preserve-3d",b.style.transform=a+" translate("+K+"px,"+M+"px)",b.style.width=D+"px",b.style.height=B+"px",b.style.pointerEvents="none");l=l.getGlobalMatrix();D=1/d.clientWidth;B=1/d.clientHeight;d.parentNode!=b&&b.appendChild(d);d.style.pointerEvents=x?"auto":"none";d.style.transform=
function(O){return"translate(-50%,-50%) matrix3d("+(y(O[0])+","+y(O[1])+","+y(O[2])+","+y(O[3])+","+y(-O[4])+","+y(-O[5])+","+y(-O[6])+","+y(-O[7])+","+y(O[8])+","+y(O[9])+","+y(O[10])+","+y(O[11])+","+y(O[12])+","+y(O[13])+","+y(O[14])+","+y(O[15])+")")}(l)+" scale3D("+D+","+B+",1)"};u.prototype.move=u.prototype.translate;u.prototype.setRotationFromEuler=u.prototype.setEulerRotation;u.prototype.getGlobalPoint=u.prototype.localToGlobal;u.prototype.serialize=u.prototype.toJSON;u.prototype.configure=
u.prototype.fromJSON;u.ctor=u.prototype._ctor;P.prototype.configure=P.prototype.fromJSON;P.prototype.serialize=P.prototype.toJSON;m.prototype.configure=m.prototype.fromJSON;m.prototype.serialize=m.prototype.toJSON;"undefined"==typeof GL&&(mat4.rotateVec3=function(a,b,d){var l=d[0],k=d[1];d=d[2];a[0]=b[0]*l+b[4]*k+b[8]*d;a[1]=b[1]*l+b[5]*k+b[9]*d;a[2]=b[2]*l+b[6]*k+b[10]*d;return a},mat4.projectVec3=function(a,b,d){var l=d[0],k=d[1];d=d[2];var x=b[1]*l+b[5]*k+b[9]*d+b[13],y=b[2]*l+b[6]*k+b[10]*d+b[14],
F=b[3]*l+b[7]*k+b[11]*d+b[15];a[0]=((b[0]*l+b[4]*k+b[8]*d+b[12])/F+1)/2;a[1]=(x/F+1)/2;a[2]=(y/F+1)/2;return a})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(w){function g(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=.5;this.particles_acceleration=vec3.create();this.velocity_variation=this.particles_end_scale=this.particles_start_scale=
1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function z(){this._ctor()}function q(n){this._ctor();n&&this.configure(n)}class f extends RD.SceneNode{constructor(n){super();this.build();
n&&this.fromJSON(n)}}f.prototype.build=function(){this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};f.prototype.updateVertices=function(n){n&&(this.vertices=n);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),
this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};f.prototype.updateNormals=function(n){n&&(this.normals=n);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};
f.prototype.updateCoords=function(n){n&&(this.coords=n);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};f.prototype.updateIndices=function(n){n&&(this.indices=n);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=
new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=n.length};f.prototype.preRender=function(){this._total&&(this.draw_range=[0,this._total_indices?this._total_indices:this._total/3])};RD.DynamicMeshNode=f;extendClass(g,RD.SceneNode);RD.ParticlesEmissor=g;g.prototype.update=function(n){var v=
this.particles.length,t=this.particles_damping,E=this.particles_acceleration,C=vec3.length(E);if(v){for(var c=[],p=0;p<v;p++){var e=this.particles[p];vec3.scaleAndAdd(e.pos,e.pos,e.vel,n);C&&vec3.scaleAndAdd(e.vel,e.vel,E,n);t&&vec3.scaleAndAdd(e.vel,e.vel,e.vel,-n*t);e.ttl-=n;0<e.ttl&&c.push(e)}this.particles=c}v=this.getGlobalPosition();t=this.emissor_direction;E=this.particles_life;C=this.num_textures*this.num_textures;c=this.velocity_variation;if(0<this.particles_per_second)for(n=this.particles_per_second*
(n+this._accumulated_time),this._accumulated_time=(n-Math.floor(n))/this.particles_per_second,n=Math.floor(n),p=0;p<n&&!(this.particles.length>=this.max_particles);p++)t=vec3.clone(t),t[0]+=.5*Math.random()*c,t[2]+=.5*Math.random()*c,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*C)/C,pos:vec3.clone(v),vel:t,ttl:E})};g.prototype.render=function(n,v){if(0!=this.particles.length){this.updateVertices();var t=this._meshes[n.gl.context_id];t||(t=new GL.Mesh(void 0,void 0,
n.gl),this._vertices_buffer=t.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=t.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=t;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);t=gl.shaders[this.shader];t||(t=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(g._vertex_shader,g._pixel_shader));this.draw_range[1]=this.particles.length;t=gl.getViewport();
this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/t[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(n._model_matrix);n._mvp_matrix.set(n._viewprojection_matrix);n.renderNode(this,n,v)}};g.prototype.updateVertices=function(n){if(n=this.particles.length)for(var v=
this._vertices,t=this._extra,E=0,C=this.particles_life,c=this.num_textures*this.num_textures,p=0;p<n;p++){var e=this.particles[p];v.set(e.pos,E);t[E]=1;t[E+1]=e.ttl/C;1<c&&(t[E+2]=e.tex);E+=3}};extendClass(z,RD.SceneNode);RD.Billboard=z;z.SPHERIC=1;z.PARALLEL_SPHERIC=2;z.CYLINDRIC=3;z.PARALLEL_CYLINDRIC=4;z.prototype._ctor=function(){this.billboard_mode=z.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};z.prototype.render=function(n,v){!1!==this.flags.visible&&(this.auto_orient&&
RD.orientNodeToCamera(this.billboard_mode,this,v,n),n.renderNode(this,n,v))};q.prototype._ctor=function(){SceneNode.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=RD.TOP_LEFT;this.blend_mode=RD.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};
Object.defineProperty(q.prototype,"angle",{get:function(){return this._angle},set:function(n){this._angle=n;quat.setAxisAngle(this._rotation,RD.FRONT,this._angle*DEG2RAD);this._must_update_matrix=!0},enumerable:!0});q.prototype.setSize=function(n,v){this.size[0]=n;this.size[1]=v};q.createFrames=function(n,v,t){t=t||{};if(n.constructor!=Number){num_columns=n[0];var E=n[1]}else E=num_columns=n;var C=n=0,c=1/num_columns,p=1/E;E*=num_columns;if(!v){v=[];for(var e=0;e<E;++e)v.push(String(e))}for(e=0;e<
v.length&&!(t[v[e]]={pos:[n,C],size:[c,p],normalized:!0},n+=c,1<=n&&(n=0,C+=p),1<=C);++e);return t};q.prototype.createFrames=function(n,v){q.createFrames(n,v,this.frames)};q.prototype.addFrame=function(n,v,t,E,C,c){this.frames[n]={pos:vec2.fromValues(v,t),size:vec2.fromValues(E,C),normalized:!!c}};q.prototype.updateTextureMatrix=function(n){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var v=n.textures[this.texture];if(!v&&n.autoload_assets){var t=this;-1!=this.texture.indexOf(".")&&
n.loadTexture(this.texture,n.default_texture_settings,function(c){c&&0==t.size[0]&&0==t.size[0]&&t.setSize(c.width,c.height)});v=gl.textures.white}if(!v)return!1;n=this.texture_matrix;var E=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!E)return!1;if(!E)return this.flags.flipX&&(temp_vec2[0]=this.flags.flipX?1:0,temp_vec2[1]=0,mat3.translate(n,n,temp_vec2),temp_vec2[0]=this.flags.flipX?-1:1,temp_vec2[1]=1,mat3.scale(n,n,temp_vec2)),!0;if(E.normalized)temp_vec2[0]=this.flags.flipX?
E.pos[0]+E.size[0]:E.pos[0],temp_vec2[1]=1-E.pos[1]-E.size[1],mat3.translate(n,n,temp_vec2),temp_vec2[0]=E.size[0]*(this.flags.flipX?-1:1),temp_vec2[1]=E.size[1];else{var C=v.height;temp_vec2[0]=(this.flags.flipX?E.pos[0]+E.size[0]:E.pos[0])/v.width;temp_vec2[1]=(C-E.pos[1]-E.size[1])/C;mat3.translate(n,n,temp_vec2);temp_vec2[0]=E.size[0]*(this.flags.flipX?-1:1)/v.width;temp_vec2[1]=E.size[1]/v.height}mat3.scale(n,n,temp_vec2);return!0};q.prototype.render=function(n,v){if(this.texture&&this.updateTextureMatrix(n)){var t=
n.textures[this.texture];if(t){this.flags.pixelated&&(t.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.billboard_mode&&RD.orientNodeToCamera(this.billboard_mode,this,v,n);0==this.size[0]&&!1!==t.ready&&(this.size[0]=t.width);0==this.size[1]&&!1!==t.ready&&(this.size[1]=t.height);var E=this.size,C=0,c=0;temp_mat4.set(this._global_matrix);
var p=!1;this.current_frame&&this.current_frame.size&&(E=this.current_frame.size,p=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case RD.TOP_LEFT:C=.5;c=-.5;break;case RD.TOP_CENTER:c=-.5;break;case RD.TOP_RIGHT:C=-.5;break;case RD.BOTTOM_LEFT:c=C=.5;break;case RD.BOTTOM_CENTER:c=.5;break;case RD.BOTTOM_RIGHT:C=-.5,c=.5}mat4.translate(temp_mat4,temp_mat4,[C*t.width*E[0],c*t.height*E[1],0])}p?mat4.scale(temp_mat4,temp_mat4,[t.width*E[0],t.height*E[1],1]):mat4.scale(temp_mat4,
temp_mat4,[this.size[0],this.size[1],1]);n.setModelMatrix(temp_mat4);n.renderNode(this,n,v)}}};extendClass(q,RD.SceneNode);RD.Sprite=q})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(w){class g extends RD.SceneNode{constructor(e){super(e);e&&this.configure(e);this.render_priority=0;this.targets=null;this.size=150;this.mode=g.DEFAULT;this.coordinates=g.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();this.onDuplicateTargets=this.onActionFinished=null;e={x:g.XAXIS_COLOR,y:g.YAXIS_COLOR,z:g.ZAXIS_COLOR};var h="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");
this.actions={};for(var r in h){var u=h[r],m={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:.15,visible:!1,flag:g[u.toUpperCase()]};0==u.indexOf("move")&&(m.move=!0);0==u.indexOf("rotate")&&(m.rotate=!0);0==u.indexOf("scale")&&(m.scale=!0);m.color=e[u[u.length-1]];if(m.move||m.rotate)m.cursor="crosshair";this.actions[u]=m}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=
vec3.fromValues(0,1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1;this.mesh="sphere";this.createMaterial({name:"gizmo"}).render=g.prototype.render.bind(this)}}g.MOVEX=1;g.MOVEY=2;g.MOVEZ=4;g.MOVEXY=8;g.MOVEXZ=16;g.MOVEYZ=32;g.ROTATEX=64;g.ROTATEY=128;g.ROTATEZ=
256;g.SCALEX=512;g.SCALEY=1024;g.SCALEZ=2048;g.SCALEXY=4096;g.SCALEYZ=8192;g.SCALEXZ=16384;g.SCALE=32768;g.DRAG=65536;g.ROTATE=131072;g.ROTATEFRONT=262144;g.RESIZE=524288;g.MOVEAXIS=g.MOVEX|g.MOVEY|g.MOVEZ;g.MOVEPLANAR=g.MOVEXY|g.MOVEXZ|g.MOVEYZ;g.MOVEALL=g.DRAG|g.MOVEAXIS|g.MOVEPLANAR;g.PLANAR=g.MOVEX|g.MOVEZ|g.MOVEXZ|g.ROTATEY|g.SCALE;g.ROTATEALL=g.ROTATEX|g.ROTATEY|g.ROTATEZ|g.ROTATEFRONT;g.SCALEALL=g.SCALE|g.SCALEX|g.SCALEY|g.SCALEZ|g.SCALEXY|g.SCALEYZ|g.SCALEXZ;g.MOVEROTATESCALE=g.MOVEAXIS|g.MOVEPLANAR|
g.ROTATEALL|g.SCALE;g.ALL=g.MOVEAXIS|g.MOVEPLANAR|g.ROTATEALL|g.SCALEALL;g.DEFAULT=g.PLANAR;g.OBJECT_SPACE=1;g.WORLD_SPACE=2;w=mat4.create();var z=mat4.create(),q=mat4.create();mat4.create();mat4.create();mat4.create();var f=mat4.create(),n=mat4.create();mat4.create();var v=vec3.create(),t=vec3.create(),E=vec3.create(),C=vec4.create();vec4.create();mat4.translate(w,w,[1.1,0,0]);mat4.rotate(w,w,90*DEG2RAD,[0,0,-1]);mat4.translate(z,z,[0,1.1,0]);mat4.translate(q,q,[0,0,1.1]);mat4.rotate(q,q,90*DEG2RAD,
[1,0,0]);w=mat4.create();mat4.scale(w,w,[-1,-1,-1]);g.full_viewport=null;var c=mat4.create(),p=mat4.create();g.XAXIS_COLOR=[.901,.247,.349,1];g.YAXIS_COLOR=[.55,.81,.11,1];g.ZAXIS_COLOR=[.23,.57,.93,1];g.XYAXIS_COLOR=[.9,.7,.23,.75];g.XZAXIS_COLOR=[.6,.4,.7,.75];g.YZAXIS_COLOR=[.39,.69,.52,.75];g.SPHERE_COLOR=[.8,.8,.8,.4];g.RING_COLOR=[.5,.5,.5,1];g.INNERSPHERE_COLOR=[.6,.6,.6,1];g.SELECTED_COLOR=[1,1,1,1];g.NOAXIS_COLOR=[.901,.247,.749,1];g.STATIC_SPHERE_COLOR=[.1,.1,.1,.3];g.prototype.isTarget=
function(e){return-1!=this.targets.indexOf(e)};g.prototype.setTargets=function(e,h){if(e&&e.constructor!==Array)throw"nodes must be an Array";e&&0!=e.length?(h&&this.targets&&(e=this.targets.concat(e)),this.targets=e=e.filter(function(r,u){return e.indexOf(r)===u}),this.resetTransform(),this.position=this.computeCenter(this.targets)):h||(this.targets=null)};g.prototype.computeCenter=function(e){if((e=e||this.targets)&&e.length){for(var h=null,r=0;r<e.length;++r){var u=e[r];u.layers&this.layers&&(u=
u.getGlobalPosition(),h?vec3.add(h,h,u):h=u)}if(!h)return[0,0,0];vec3.scale(h,h,1/e.length);return h}};g.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?(this.transform=this.targets[0].transform,this.scaling=[1,1,1]):this.position=this.computeCenter(this.targets)))};g.prototype.updateTargets=function(){if(this.targets)for(var e=this.getGlobalMatrix(mat4.create()),
h=0;h<this.targets.length;++h){var r=this.targets[h];r.layers&this.layers&&r.fromMatrix(e,!0)}};g.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var e=0;e<this.targets.length;++e){var h=this.targets[e];h.layers&this.layers&&(this.target_tranforms[e]=new Float32Array(h.transform))}}};g.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var e=0;e<this.targets.length;++e){var h=
this.targets[e];h.layers&this.layers&&(h.transform=this.target_tranforms[e])}};g.prototype.removeTargetsFromScene=function(){if(this.targets){for(var e=0;e<this.targets.length;++e){var h=this.targets[e];h.layers&this.layers&&h.parentNode&&h.parentNode.removeChild(h)}this.targets=null}};g.prototype.getTargetBaseNodes=function(){function e(A){return-1!=r.indexOf(A)?!0:A.parentNode?e(A.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var h=[],r=this.targets,u=0;u<r.length;++u){var m=
r[u];m.layers&this.layers&&(m.parentNode&&e(m.parentNode)||h.push(m))}return h};g.prototype.applyTransformToTarget=function(e,h){var r=this.getGlobalMatrix(mat4.create()),u=mat4.invert(mat4.create(),r),m=mat4.create(),A=this.getTargetBaseNodes();if(A){for(var H=[1,1,1],I=0;I<A.length;++I){var G=A[I];H[0]=0<=G.scaling[0]?1:-1;H[1]=0<=G.scaling[1]?1:-1;H[2]=0<=G.scaling[2]?1:-1;h?(mat4.multiply(m,e,G.matrix),G.fromMatrix(m)):(G.getGlobalMatrix(m),this.coordinates==g.WORLD_SPACE&&mat4.multiply(m,u,m),
mat4.multiply(m,e,m),this.coordinates==g.WORLD_SPACE&&mat4.multiply(m,r,m),G.fromMatrix(m,!0));vec3.mul(G._scale,G._scale,H);G.position=this.applySnap(G.position);if(this.grid_size){var L=quat.toEuler(vec3.create(),G.rotation);L[0]=15*Math.round(L[0]*RAD2DEG/15)*DEG2RAD;L[1]=15*Math.round(L[1]*RAD2DEG/15)*DEG2RAD;L[2]=15*Math.round(L[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(G.rotation,L);quat.normalize(G.rotation,G.rotation)}}mat4.multiply(m,r,e);this.fromMatrix(m);this.scaling=[1,1,1];this.updateGizmo()}};
g.prototype.applyTranslation=function(e,h){var r=mat4.create();mat4.translate(r,r,e);this.applyTransformToTarget(r,h)};g.prototype.applyRotation=function(e,h,r){var u=mat4.create();if(r){var m=mat4.create();mat4.setTranslation(m,r);mat4.mul(u,u,m);mat4.rotate(u,u,e,h);mat4.setTranslation(m,[-r[0],-r[1],-r[2]]);mat4.mul(u,u,m)}else mat4.rotate(u,u,e,h);this.applyTransformToTarget(u)};g.prototype.applyScale=function(e,h){e.constructor===Number&&(e=[e,e,e]);var r=mat4.create();mat4.scale(r,r,e);this.applyTransformToTarget(r,
h)};g.prototype.applySnap=function(e){if(!this.grid_size)return e;e[0]=Math.round(e[0]/this.grid_size)*this.grid_size;e[1]=Math.round(e[1]/this.grid_size)*this.grid_size;e[2]=Math.round(e[2]/this.grid_size)*this.grid_size;return e};g.prototype.setColor=function(e){if(this.targets)for(var h=0;h<this.targets.length;++h){var r=this.targets[h];r.layers&this.layers&&(r=r.getMaterial())&&(r.color=e)}};g.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var e=
[],h=0;h<this.targets.length;++h){var r=this.targets[h];if(r.layers&this.layers){var u=r.clone(!0);r.parentNode.addChild(u);e.push(r)}}return this.targets=e}};g.prototype.onMouse=function(e){if(this._camera&&this.targets&&!1!==this.visible){var h=this._camera,r=h.getFront(),u=[e.canvasx,e.canvasy],m=h.getRay(u[0],u[1]),A=this.position,H=vec3.sub(vec3.create(),A,h.position);vec3.normalize(H,H);var I=this._selected_action,G=this.actions[I],L=this._global_matrix;h.project(A,null,this.center_2D);var P=
mat4.invert(mat4.create(),L),N=this.coordinates==g.OBJECT_SPACE;if("mousedown"==e.type){if(this.click_2D[0]=this.click_2D2[0]=u[0],this.click_2D[1]=this.click_2D2[0]=u[1],e.is_touch&&this.testMouseOver(e),I=this._selected_action=this._hover_action,G=this.actions[I])G.move&&G.axis?(P=vec3.clone(G.axis),mat4.rotateVec3(P,L,P),vec3.normalize(P,P),this._last=m.closestPointOnRay(A,P),e.shiftKey&&this.cloneTargets()):G.move&&G.normal&&(m.testPlane(A,G.normal)&&(this.click_pos=m.collision_point),e.shiftKey&&
this.cloneTargets()),"drag"==I&&(m.testPlane(A,r),this._last=m.collision_point,e.shiftKey&&this.cloneTargets()),"rotatefront"==I?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,.5*this.size),this.click_2D2.set(this.click_2D)):G.rotate&&(G.axis?(I=mat4.rotateVec3(vec3.create(),L,G.axis),m.testPlane(A,I)&&(vec3.sub(this.click_pos,m.collision_point,A),vec3.normalize(this.click_pos,
this.click_pos),A=vec3.scaleAndAdd(vec3.create(),A,this.click_pos,this.current_size),this.current_2D=this.click_2D=h.project(A))):m.testSphere(A,this.current_size)&&(this._last=m.collision_point,vec3.sub(this.click_pos,m.collision_point,A),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),H,this.click_pos))),this.click_model.set(L),this.click_transform.set(this.transform),this.click_dist=vec3.distance(this.click_2D,this.center_2D),this.saveTargetTransforms()}else if("mousemove"==
e.type)if(e.dragging&&this._selected_action){if("rotatefront"==I)return G=vec2.sub(vec3.create(),u,this.center_2D),vec2.normalize(G,G),A=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,G,.5*this.size),A=Math.atan2(G[0],G[1])-Math.atan2(A[0],A[1]),e.shiftKey&&(A=2*Math.PI*Math.ceil(36*A/(2*Math.PI))/36),A&&(this.restoreTargetTransforms(),this.applyRotation(A,H)),!0;if(G.rotate)return G.axis?(I=mat4.rotateVec3(vec3.create(),L,G.axis),m.testPlane(A,I)&&(e=vec3.sub(vec3.create(),m.collision_point,
A),vec3.normalize(e,e),A=vec3.scaleAndAdd(vec3.create(),A,e,this.current_size),this.current_2D=h.project(A),h=Math.clamp(vec3.dot(e,this.click_pos),-1,1),A=Math.acos(h),e=vec3.cross(vec3.create(),e,this.click_pos),vec3.normalize(e,e),h=vec3.dot(I,e),0<h&&(A*=-1),this.restoreTargetTransforms(),this.applyRotation(A,G.axis))):(P=vec3.cross(vec3.create(),H,this.click_pos),A=.01*(vec2.dist(this.center_2D,u)-this.click_dist),e=vec2.sub(vec2.create(),this.center_2D,u),G=vec2.sub(vec2.create(),this.center_2D,
this.click_2D),0>vec2.dot(e,G)&&(A=-A),console.log(A),this.restoreTargetTransforms(),this.applyRotation(A,P),this.click_axis=P),!0;H=null;if(G.move&&G.normal){if(m.testPlane(A,G.normal)&&(G=m.collision_point,this.applySnap(G),H=vec3.sub(vec3.create(),G,this.click_pos),this.click_pos=G,this.coordinates==g.OBJECT_SPACE))return mat4.rotateVec3(H,P,H),this.applyTranslation(H,!0),!0}else if(G.move||G.scale){h=null;G.axis&&(P=vec3.clone(G.axis),mat4.rotateVec3(P,L,P),vec3.normalize(P,P),h=m.closestPointOnRay(A,
P));if("scale"==I||G.scale&&e.ctrlKey)return e=1+.01*(u[1]-this.click_2D[1]),this.applyScale(e,N),this.click_2D[0]=u[0],this.click_2D[1]=u[1],!0;if("scalexy"==I||"scalexz"==I||"scaleyz"==I){e=1+.01*(u[1]-this.click_2D[1]);switch(I){case "scalexy":this.applyScale([e,e,1],N);break;case "scaleyz":this.applyScale([1,e,e],N);break;case "scalexz":this.applyScale([e,1,e],N)}this.click_2D[0]=u[0];this.click_2D[1]=u[1];return!0}if(G.scale)return e=vec2.distance(u,this.center_2D),G=e/this.click_dist,"scalex"==
I?this.applyScale([G,1,1],N):"scaley"==I?this.applyScale([1,G,1],N):"scalez"==I&&this.applyScale([1,1,G],N),this.click_dist=e,!0;G.move&&(N||this.applySnap(h),H=vec3.sub(vec3.create(),h,this._last),this._last.set(h))}"drag"==I&&(m.testPlane(A,this._camera.getFront()),h=m.collision_point,this.applySnap(h),H=vec3.sub(vec3.create(),h,this._last),this._last=h);if(H)return this.applyTranslation(H),!0}else this.testMouseOver(e);else if("wheel"==e.type){if("scale"==this._selected_action)return e=1+2E-4*
e.wheel,this.applyScale(e),!0;if("drag"==this._selected_action)return H=vec3.sub(vec3.create(),A,h.position),e=1+2E-4*e.wheel,vec3.scaleAndAdd(H,h.position,H,e),vec3.sub(H,H,A),this.applyTranslation(H),this._last=A,!0}if("mouseup"==e.type||this._selected_action&&0==e.buttons)if(this.saveTargetTransforms(),this._selected_action){this._selected_action=null;this.render(this._last_renderer,this._last_camera);this.testMouseOver(e);this.updateGizmo();if(this.onActionFinished)this.onActionFinished();return!0}return!1}};
g.prototype.testMouseOver=function(e){this._hover_action=null;var h=[e.canvasx,e.canvasy],r=1E5;e=null;for(var u in this.actions){var m=this.actions[u];if(m.visible){var A=vec2.distance(m.pos2D,h);A<m.radius*this.size&&A<r&&(r=A,e=u)}}e||(u=vec2.distance(this.center_2D,h),this.actions.rotatefront.visible&&10>Math.abs(u-.5*this.size)?e="rotatefront":this.mode&g.ROTATE&&u<.5*this.size&&(e="rotate"));return this._hover_action=e};g.prototype.cancel=function(){this._selected_action&&(this._selected_action=
null,this.restoreTargetTransforms())};g.prototype.render=function(e){this._last_renderer=e;var h=this._last_camera=e._camera;for(r in this.actions)this.actions[r].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.cube=GL.Mesh.cube({size:1}),gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:.1,height:.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:.02,
outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:.5*Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}));var r=gl.meshes.torus;var u=h.getFront(),m=h.getLocalVector(RD.UP);h.getLocalVector(RD.RIGHT);var A=this._position;C.set(A);C[3]=1;var H=h._projection_matrix[5];this.updateMatrices();f.set(this._global_matrix);var I=vec3.sub(vec3.create(),A,h.position);
vec3.normalize(I,I);this._camera=h;this._unitary_model=f;var G=this._hover_action,L=this._selected_action;L&&(G=L);var P=L?this.actions[L]:null,N=this.mode;mat4.rotateVec3(t,f,RD.RIGHT);mat4.rotateVec3(E,f,RD.UP);mat4.rotateVec3(v,f,RD.FRONT);vec3.normalize(t,t);vec3.normalize(E,E);vec3.normalize(v,v);mat4.fromTranslationFrontTop(n,A,u,m);vec4.transformMat4(C,C,h._viewprojection_matrix);this.current_size=m=gl.canvas.width/gl.canvas.height*this.size*C[3]/(gl.canvas.width*H);mat4.scale(f,f,[m,m,m]);
mat4.scale(n,n,[m,m,m]);m=vec3.dot(I,t);H=vec3.dot(I,E);var U=vec3.dot(I,v),J=vec3.dot(u,RD.RIGHT),W=vec3.dot(u,RD.UP),X=vec3.dot(u,RD.FRONT);this._camera.project(A,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);I=gl.shaders[this.shader];I.uniforms(e._uniforms);I.uniforms(h._uniforms);I.uniforms(this.uniforms);if("movex"==L)mat4.rotateZ(c,f,-Math.PI/2),this.drawAxis(c,
g.XAXIS_COLOR);else if("movey"==L)this.drawAxis(f,g.YAXIS_COLOR);else if("movez"==L)mat4.rotateX(c,f,-Math.PI/2),this.drawAxis(c,g.ZAXIS_COLOR);else if("drag"==L)e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.XAXIS_COLOR,!0);else if(P&&P.normal&&this.render_move_plane)c.set(f),"movexz"==L?mat4.rotateX(c,c,Math.PI/2):"moveyz"==L&&mat4.rotateY(c,c,Math.PI/2),mat4.scale(c,c,[100,100,100]),I.setUniform("u_model",c),I.setUniform("u_color",[.1,.1,.1,.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),
I.draw(gl.meshes.plane),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==L)mat4.rotateX(c,n,Math.PI/2),I.setUniform("u_model",c),I.draw(r),e.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g.XAXIS_COLOR,!0),e.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,g.XAXIS_COLOR,!0),e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.XAXIS_COLOR,!0),e.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g.XAXIS_COLOR),e.drawLine2D(this.click_2D2[0],
this.click_2D2[1],this.center_2D[0],this.center_2D[1],4,g.XAXIS_COLOR);else{if("rotate"==L){this.click_axis&&(mat4.fromTranslationFrontTop(c,A,u,this.click_axis),mat4.scale(c,c,[this.current_size,this.current_size,this.current_size]),this.drawAxis(c,g.NOAXIS_COLOR));this.drawRotateSphere(f,g.SPHERE_COLOR);e.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g.NOAXIS_COLOR,!0);return}if(P&&P.rotate){h=P.color||g.XAXIS_COLOR;"rotatex"==L?mat4.rotateZ(c,f,Math.PI/2):"rotatey"==L?mat4.rotateY(c,f,Math.PI/
2):"rotatez"==L&&mat4.rotateX(c,f,Math.PI/2);I.setUniform("u_model",c);I.setUniform("u_color",h);I.draw(r);e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,h,!0);e.drawCircle2D(this.click_2D[0],this.click_2D[1],2,h,!0);e.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,h);e.drawCircle2D(this.current_2D[0],this.current_2D[1],2,h,!0);e.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,h);return}}"scale"==L?(e.drawCircle2D(this.center_2D[0],
this.click_2D[1],2,g.INNERSPHERE_COLOR,!0),e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.INNERSPHERE_COLOR,!0),e.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g.INNERSPHERE_COLOR)):(this.drawRotateSphere(f,g.STATIC_SPHERE_COLOR),N&g.ROTATE&&"rotate"==G&&this.drawRotateSphere(f,g.SPHERE_COLOR),N&g.ROTATEFRONT&&(mat4.rotateX(c,n,Math.PI/2),I.setUniform("u_model",c),I.setUniform("u_color","rotatefront"==G?g.SELECTED_COLOR:g.RING_COLOR),I.draw(r),this.actions.rotatefront.visible=
!0),.1<Math.abs(m)&&N&g.ROTATEX&&(mat4.rotateZ(c,f,Math.PI/2),0>X&&mat4.rotateX(c,c,Math.PI),0>W&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatex"==G?g.SELECTED_COLOR:g.XAXIS_COLOR,"rotatex")),.1<Math.abs(H)&&N&g.ROTATEY&&(c.set(f),0<J&&0>X?mat4.rotateY(c,c,-Math.PI/2):0>J&&0>X?mat4.rotateY(c,c,Math.PI):0>J&&0<X&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatey"==G?g.SELECTED_COLOR:g.YAXIS_COLOR,"rotatey")),.1<Math.abs(U)&&N&g.ROTATEZ&&(c.set(f),mat4.rotateX(c,c,Math.PI/2),0<J&&0>W?
mat4.rotateY(c,c,-Math.PI/2):0>J&&0>W?mat4.rotateY(c,c,Math.PI):0>J&&0<W&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatez"==G?g.SELECTED_COLOR:g.ZAXIS_COLOR,"rotatez")),.95>Math.abs(m)&&(mat4.rotateZ(c,f,0>J?-Math.PI/2:Math.PI/2),N&g.MOVEX&&this.drawArrow(c,"movex"==G?g.SELECTED_COLOR:g.XAXIS_COLOR,"movex"),N&g.SCALEX&&this.drawScale(c,"scalex"==G?g.SELECTED_COLOR:g.XAXIS_COLOR,"scalex")),.95>Math.abs(H)&&(0<W?mat4.rotateZ(c,f,Math.PI):c.set(f),N&g.MOVEY&&this.drawArrow(c,"movey"==G?g.SELECTED_COLOR:
g.YAXIS_COLOR,"movey"),N&g.SCALEY&&this.drawScale(c,"scaley"==G?g.SELECTED_COLOR:g.YAXIS_COLOR,"scaley")),.95>Math.abs(U)&&(mat4.rotateX(c,f,0>X?-Math.PI/2:Math.PI/2),N&g.MOVEZ&&this.drawArrow(c,"movez"==G?g.SELECTED_COLOR:g.ZAXIS_COLOR,"movez"),N&g.SCALEZ&&this.drawScale(c,"scalez"==G?g.SELECTED_COLOR:g.ZAXIS_COLOR,"scalez")),.2<Math.abs(U)&&(N&g.MOVEXY||N&g.SCALEXY)&&(mat4.translate(c,f,[.45*(0>m?1:-1),.45*(0>H?1:-1),0]),N&g.MOVEXY?this.drawFlat(c,"movexy"==G?g.SELECTED_COLOR:g.XYAXIS_COLOR,"movexy"):
this.drawFlat(c,"scalexy"==G?g.SELECTED_COLOR:g.XYAXIS_COLOR,"scalexy","circle")),.2<Math.abs(H)&&(N&g.MOVEXZ||N&g.SCALEXZ)&&(mat4.rotateX(c,f,Math.PI/2),mat4.translate(c,c,[.45*(0>m?1:-1),.45*(0>U?-1:1),0]),N&g.MOVEXZ?this.drawFlat(c,"movexz"==G?g.SELECTED_COLOR:g.XZAXIS_COLOR,"movexz"):this.drawFlat(c,"scalexz"==G?g.SELECTED_COLOR:g.XZAXIS_COLOR,"scalexz","circle")),.2<Math.abs(m)&&(N&g.MOVEYZ||N&g.SCALEYZ)&&(mat4.rotateY(c,f,Math.PI/2),mat4.translate(c,c,[.45*(0>U?1:-1),.45*(0>H?1:-1),0]),N&g.MOVEYZ?
this.drawFlat(c,"moveyz"==G?g.SELECTED_COLOR:g.YZAXIS_COLOR,"moveyz"):this.drawFlat(c,"scaleyz"==G?g.SELECTED_COLOR:g.YZAXIS_COLOR,"scaleyz","circle")),N&g.DRAG&&this.drawInnerSphere(f,"drag"),N&g.SCALE&&this.drawInnerSphere(f,"scale"),N&g.RESIZE&&this.drawResize(f,"resize"),gl.enable(gl.DEPTH_TEST))}}};g.prototype.drawArrow=function(e,h,r){var u=gl.shaders[this.shader],m=gl.meshes.cone,A=gl.meshes.cylinder,H=this._hover_action;mat4.translate(p,e,[0,1.1,0]);u.setUniform("u_model",p);u.setUniform("u_color",
H==r?g.SELECTED_COLOR:h);u.draw(m);this.mode==g.MOVEALL?(mat4.translate(p,p,[0,-.4,0]),mat4.scale(p,p,[1,1,1])):(mat4.translate(p,p,[0,-.15,0]),mat4.scale(p,p,[1,.5,1]));u.setUniform("u_model",p);u.draw(A);this.toScreen(p,r,[0,.6,0])};g.prototype.drawAxis=function(e,h){var r=gl.shaders[this.shader],u=gl.meshes.sphere;mat4.scale(p,e,[.01,100,.01]);r.setUniform("u_model",p);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);r.setUniform("u_color",
[h[0],h[1],h[2],.2]);gl.depthFunc(gl.GREATER);r.draw(u);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);r.setUniform("u_color",h);r.draw(u);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(e)};g.prototype.drawFlat=function(e,h,r,u){u=gl.meshes[u||"plane"];var m=gl.shaders[this.shader];mat4.scale(c,e,[.25,.25,.25]);m.setUniform("u_color",h);m.setUniform("u_model",c);gl.enable(gl.BLEND);m.draw(u);gl.disable(gl.BLEND);this.toScreen(c,r)};g.prototype.drawRotator=function(e,h,r){var u=gl.meshes.quartertorus,
m=gl.shaders[this.shader];mat4.scale(c,e,[.9,.9,.9]);m.setUniform("u_color",h);m.setUniform("u_model",c);m.draw(u);this.toScreen(c,r,[-.75,0,.75])};g.prototype.drawScale=function(e,h,r){var u=gl.meshes.cylinder,m=gl.meshes.sphere,A=gl.shaders[this.shader];A.setUniform("u_color",h);this.mode==g.SCALEALL?(mat4.translate(c,e,[0,.5,0]),mat4.scale(c,c,[1,1,1])):(mat4.translate(c,e,[0,.25,0]),mat4.scale(c,c,[1,.5,1]));A.setUniform("u_model",c);A.draw(u);mat4.translate(c,e,[0,.4,0]);this.mode==g.SCALEALL?
mat4.scale(c,c,[.1,.1,.1]):mat4.scale(c,c,[.1,.2,.1]);A.setUniform("u_model",c);A.draw(m);this.toScreen(c,r)};g.prototype.drawRotateSphere=function(e,h){var r=gl.shaders[this.shader],u=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(c,e,[.9,.9,.9]);r.setUniform("u_model",c);r.setUniform("u_color",h);r.draw(u);gl.disable(gl.BLEND)};g.prototype.drawInnerSphere=function(e,h){var r=gl.shaders[this.shader],u=gl.meshes.sphere,m=this._hover_action;mat4.scale(c,
e,[.1,.1,.1]);r.setUniform("u_model",c);r.setUniform("u_color",m==h?g.SELECTED_COLOR:g.INNERSPHERE_COLOR);r.draw(u);"drag"==h&&(mat4.scale(c,e,[.07,.07,.07]),r.setUniform("u_model",c),r.setUniform("u_color",m==h?g.INNERSPHERE_COLOR:[0,0,0,1]),r.draw(u));h&&this.toScreen(c,h)};g.prototype.drawResize=function(e,h){};g.prototype.computeBounding=function(e){e=e||BBox.create();for(var h=0;h<this.targets.length;++h){var r=this.targets[h].updateBoundingBox();0==h?BBox.copy(e,r):BBox.merge(e,e,r)}return e};
g.prototype.renderOutline=function(e,h,r,u){if((u=u||this.targets)&&u.length){var m=this.layers;u=u.filter(function(L){return L.layers&m});var A=gl.viewport_data[2],H=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==A&&this._selection_buffer.height==H||(this._selection_buffer=new GL.Texture(A,H,{magFilter:gl.NEAREST}));g.outline_material||(g.outline_material=new RD.Material({shader_name:"flat"}));var I=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,
0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);e.shader_overwrite=I;var L=e.onNodeShaderUniforms;e.onNodeShaderUniforms=function(N,U){U.setUniform("u_color",[1,1,1,1])};var P=e.pipeline;e.pipeline=null;e.overwrite_material=RD.Gizmo.outline_material;e.render(h,r,u);e.shader_overwrite=null;e.onNodeShaderUniforms=L;e.pipeline=P;e.overwrite_material=null});var G=gl.shaders.outline;G||=gl.shaders.outline=GL.Shader.createFX("\n\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n");gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(G,{u_color:[1,1,1,1],u_res:[1/A,1/H]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};g.prototype.renderCameraGizmo=function(e,h){this.drawInnerSphere};g.prototype.toScreen=function(e,h,r){h=this.actions[h];mat4.multiplyVec3(h.pos,e,r||[0,0,0]);this._camera.project(h.pos,g.full_viewport,h.pos2D);h.visible=!0};extendClass(g,RD.SceneNode);RD.Gizmo=g})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,convert_skeletons:!1,overwrite_materials:!0,rename_assets:!1,prefabs:{},meshes:{},
texture_options:{format:GL.RGBA,magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT,no_flip:!1},supports_anisotropy:!1,force_anisotropy:!1,load:function(w,g,z,q){function f(h){function r(A){var H=this.buffer;H.data=A;H.dataview=new Uint8Array(A);h.length?f(h):n()}var u=h.pop(),m=C+"/"+u.uri;"blob:"==u.uri.substr(0,5)&&(m=u.uri);"data:"==u.uri.substr(0,5)?(m=_base64ToArrayBuffer(u.uri.substr(37)),r.call({buffer:u},m)):fetch(m).then(function(A){return A.arrayBuffer()}).then(r.bind({buffer:u}))}
function n(){t.filename=E;t.folder=C;t.url=w;RD.GLTF.parseBuffers(t,e);var h=RD.GLTF.parse(t),r=h.serialize();RD.GLTF.prefabs[w]=r;g&&g(h)}function v(h){"gltf"==z?(t=h,f(t.buffers.concat())):"glb"==z&&((t=RD.GLTF.parseGLB(h))?n():console.error("error parsing GLB:",E))}if(!w)throw"url missing";var t=null,E="",C="";"undefined"!==typeof gl&&(this.meshes=gl.meshes,gl.extensions.EXT_texture_filter_anisotropic&&(this.supports_anisotropy=!0));if(w.constructor===String)if(C=w.split("/"),E=C.pop(),z=z||E.split(".").pop().toLowerCase(),
C=C.join("/"),"undefined"!==typeof fs){var c=new Uint8Array(fs.readFileSync(w,{}).buffer);v(c.buffer)}else{var p=new XMLHttpRequest;p.onload=function(){200!=this.status?(console.error("GLTF not found",w),g&&g(null)):v(p.response)};p.onerror=function(){console.error("Network Error");g&&g(null)};q&&(p.onprogress=function(h){q(w,h.loaded,h.total)});p.responseType="gltf"==z?"json":"arraybuffer";p.open("GET",w);p.send()}else{var e=w;if(E=e.main)w=E,c=e[E],"glb"==c.extension?(t=RD.GLTF.parseGLB(c.data))&&
n():(t=c.data,this.parseBuffers(),n())}},parseBuffers:function(w,g){for(var z=0;z<w.buffers.length;++z){var q=w.buffers[z];if(!q.data){if(q.uri&&"data:"==q.uri.substr(0,5))q.data=_base64ToArrayBuffer(q.uri.substr(37));else{if(!g)throw"missing data in glb";q.data=g[q.uri].data}q.dataview=new Uint8Array(q.data)}}},parseGLB:function(w){var g=new Uint8Array(w),z=new DataView(w);if(1179937895!=z.getUint32(0,!0))return console.error("incorrect gltf header"),null;var q=z.getUint32(4,!0);console.log("GLTF Version: "+
q);z.getUint32(8,!0);q=12;for(var f=null,n=0;q<g.length;){var v=z.getUint32(q,!0),t=z.getUint32(q+4,!0),E=w.slice(q+8,q+8+v);q+=8+v;if(t==RD.GLTF.JSON_CHUNK){if("undefined"===typeof TextDecoder)throw"Sorry, this browser does not support TextDecoder...";f=(new TextDecoder("utf-8")).decode(E);f=JSON.parse(f)}else t==RD.GLTF.BINARY_CHUNK?(v=f.buffers[n],v.data=E,v.dataview=new Uint8Array(E),n++):console.warn("gltf unknown chunk type: ","0x"+t.toString(16))}return f},parse:function(w,g){console.log(w);
w.url||(w.url=g||"scene.glb");g={};1<w.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var z=w.scenes[w.scene||0].nodes;this.gltf_materials={};if(w.buffers&&w.buffers.length)for(var q=0;q<w.buffers.length;++q){var f=w.buffers[q];f.uri&&!f.data&&"data:"==f.uri.substr(0,5)&&(f.data=_base64ToArrayBuffer(f.uri.substr(37)),f.dataview=new Uint8Array(f.data))}if(w.skins)for(q=0;q<w.skins.length;++q){f=w.skins[q];for(var n=0;n<f.joints.length;++n)w.nodes[f.joints[n]]._is_joint=
!0}f=null;1<z.length&&(f=new RD.SceneNode,f.name="root");for(q=0;q<z.length;++q){var v=n=z[q];null!=n.node&&(v=n.node);n=RD.GLTF.parseNode(null,v,w);f||=n;1<z.length&&f.addChild(n);n.id=w.url.replace(/\//gi,"_")+"::node_"+q;g[n.id]=g[q]=n}if(w.animations&&w.animations.length){if(RD.Animation)for(f.animations=[],q=0;q<w.animations.length;++q)z=this.parseAnimation(q,w,g),z.id=w.filename+"::"+z.name,z&&(RD.Animations[z.id]=z,f.animations.push(z));else console.error("you must include rendeer-animation.js to allow animations");
this.convert_skeletons&&this.convertSkinToSkeleton(f,f)}f.materials=this.gltf_materials;f.meta={asset:w.asset};return f},parseNode:function(w,g,z){var q=z.nodes[g];w=q.extensions&&q.extensions.KHR_lights_punctual?w||new RD.Light:w||new RD.SceneNode;for(var f in q){var n=q[f];switch(f){case "name":w.name=n;break;case "translation":w.position=n;break;case "rotation":w.rotation=n;break;case "scale":w.scaling=n;var v=0;0>w.scaling[0]&&v++;0>w.scaling[1]&&v++;0>w.scaling[2]&&v++;1==v%2&&(w.flags.frontFace=
GL.CW);break;case "matrix":w.fromMatrix(n);0>mat4.determinant(n)&&(w.flags.frontFace=GL.CW);break;case "mesh":if(n=RD.GLTF.parseMesh(n,z)){w.mesh=n.name;w.primitives=[];for(v=0;v<n.info.groups.length;++v){var t=n.info.groups[v],E=null;null!=t.material&&(E=this.parseMaterial(t.material,z));w.primitives.push({index:v,material:E?E.name:null,mode:t.mode});!w.material&&E&&(w.material=E.name)}n.morphs&&(w.morphs=n.morphs.map(C=>({name:C.name,weight:C.weight})))}break;case "skin":w.skin=this.parseSkin(n,
z);break;case "camera":w.camera=z.cameras[n];break;case "children":if(n.length)for(v=0;v<n.length;++v)t=RD.GLTF.parseNode(null,n[v],z),w.addChild(t);break;case "extras":case "extra":w.extras=n;break;case "extensions":n.KHR_lights_punctual&&this.parseLight(w,z.extensions.KHR_lights_punctual.lights[n.KHR_lights_punctual.light]);break;default:"_"!=f[0]&&console.log("gltf node info ignored:",f,q[f])}}if(w.mesh&&w.skin)for(n=this.meshes[w.mesh],n.bones=[],v=0;v<w.skin.joints.length;++v)n.bones.push([w.skin.joints[v],
w.skin.bindMatrices[v]]);q.name||(q.name=w.name="node_"+g);q._is_joint&&(w.is_joint=!0);return w},parseLight:function(w,g){w.color=g.color?g.color:[1,1,1];null!=g.intensity&&vec3.scale(w.color,w.color,g.intensity/1E3);"spot"===g.type?w.light_type=RD.SPOT_LIGHT:"point"===g.type?w.light_type=RD.POINT_LIGHT:"directional"===g.type&&(w.light_type=RD.DIRECTIONAL_LIGHT);g.spot&&(w.cone_start=g.spot.innerConeAngle*RAD2DEG*2,w.cone_end=g.spot.outerConeAngle*RAD2DEG*2);null!=g.range&&(w.max_distance=g.range)},
parseMesh:function(w,g){for(var z=g.meshes[w],q=this.meshes,f=[],n=[],v=0,t=0;t<z.primitives.length;++t){var E=z.primitives[t],C=this.parsePrimitive(E,g);if(C){C.start=v;v+=C.length;n.push(C);var c={vertexBuffers:{},indexBuffers:{}},p;for(p in C.buffers){var e=p;"bones"==e&&(e="bone_indices");"indices"==e||"triangles"==e?c.indexBuffers[e]={data:C.buffers[p]}:c.vertexBuffers[e]={data:C.buffers[p]}}f.push({mesh:c});if(E.targets){c.morphs=[];for(let m=0;m<E.targets.length;++m){C=E.targets[m];e={name:"",
weight:0,buffers:{}};z.extras&&z.extras.targetNames&&(e.name=z.extras.targetNames[m]);z.weights&&(e.weight=z.weights[m]);for(var h in this.buffer_names){var r=this.buffer_names[h],u=C[h];null!=u&&(u=this.parseAccessor(u,g,!1))&&(e.buffers[r]=u)}c.morphs.push(e)}}}}v=null;1<f.length?v=GL.Mesh.mergeMeshes(f):1==f.length&&(t=f[0].mesh,v=new GL.Mesh(t.vertexBuffers,t.indexBuffers),v.info&&t.info&&(v.info=t.info),v.morphs=t.morphs);if(!v)return null;for(t=0;t<z.primitives.length;++t)(f=v.info.groups[t])||
(v.info.groups[t]=f={}),C=z.primitives[t],f.material=C.material,f.mode=null!=C.mode?C.mode:4,f.start=n[t].start,f.length=n[t].length;v.name=z.name+"_"+w;if(!v.name||this.rename_assets)v.name=g.filename+"::mesh_"+(z.name||w);v.updateBoundingBox();v.computeGroupsBoundingBoxes();return q[v.name]=v},parsePrimitive:function(w,g){var z={buffers:{}},q=z.buffers;if(w.extensions)if(w.extensions.KHR_draco_mesh_compression){if("undefined"==typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";
q=z.buffers=this.decompressDraco(w,g);if(!q)return null}else throw"mesh data is compressed, this importer does not support it yet";else{null==!w.attributes.POSITION&&console.warn("gltf mesh without positions");for(var f in this.buffer_names){var n=this.buffer_names[f],v=w.attributes[f];if(null!=v){var t=this.parseAccessor(v,g,this.flip_uv&&("coords"==n||"coords1"==n));t&&("COLOR_0"===f&&(t=this.convertVertexColor(t,g.accessors[v])),q[n]=t)}}null!=w.indices&&(q.triangles=this.parseAccessor(w.indices,
g))}if(!q.vertices)return console.error("primitive without vertices"),null;z.mode=w.mode;z.material=w.material;z.start=0;z.length=q.triangles?q.triangles.length:q.vertices.length/3;return z},parseAccessor:function(w,g,z,q,f){f=g.accessors[w];if(!f)return console.warn("gltf accessor not found"),null;var n=this.numComponents[f.type];if(!n)return console.warn("gltf accessor of unknown type:",f.type),null;q=f.count*n;switch(f.componentType){case RD.GLTF.FLOAT:var v=new Float32Array(q);break;case RD.GLTF.UNSIGNED_INT:v=
new Uint32Array(q);break;case RD.GLTF.SHORT:v=new Int16Array(q);break;case RD.GLTF.UNSIGNED_SHORT:v=new Uint16Array(q);break;case RD.GLTF.BYTE:v=new Int8Array(q);break;case RD.GLTF.UNSIGNED_BYTE:v=new Uint8Array(q);break;default:console.warn("gltf accessor of unsupported type: ",f.componentType),v=new Float32Array(q)}q=f.bufferView;f.sparse&&f.sparse.values&&(q=f.sparse.values.bufferView);q=g.bufferViews[q];if(!q)return console.warn("gltf bufferView not found"),null;w=g.buffers[q.buffer];if(!w||!w.data)return console.warn("gltf buffer not found or data not loaded"),
null;g=new Uint8Array(v.buffer);null==q.byteOffset&&(q.byteOffset=0);var t=q.byteOffset+(f.byteOffset||0);if(q.byteStride&&q.byteStride!=n*v.BYTES_PER_ELEMENT){g=n*v.BYTES_PER_ELEMENT;t=w.dataview.subarray(t,t+q.byteLength);for(var E=new v.constructor(n),C=new Uint8Array(E.buffer),c=w=0;c<f.count;++c)C.set(t.subarray(w,w+g)),v.set(E,c*n),w+=q.byteStride}else t=w.dataview.subarray(t,t+g.length),g.set(t);if(z)for(c=1;c<v.length;c+=n)v[c]=1-v[c];return v},installDracoModule:function(w){var g=this.draco_data_types=
{},z=this;this.decoderModule?w&&w(this.decoderModule):"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(q){var f=z.decoderModule=q;g[f.DT_INT8]=Int8Array;g[f.DT_UINT8]=Uint8Array;g[f.DT_INT16]=Int16Array;g[f.DT_UINT16]=Uint16Array;g[f.DT_INT32]=Int32Array;g[f.DT_UINT32]=Uint32Array;g[f.DT_FLOAT32]=Float32Array;w&&w(q)}):console.error("Draco3D not installed")},decompressDraco:function(w,g){if(!this.decoderModule||!this.decoderModule.Decoder)return console.warn("Mesh with DRACO encoding, DRACO Decoder Module not found"),
null;this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,w,g)},decodePrimitive:function(w,g,z){var q={};g=z.buffers[z.bufferViews[g.extensions.KHR_draco_mesh_compression.bufferView].buffer];var f=g.dataview.buffer;z=this.decoderModule;g=new z.DecoderBuffer;g.Init(new Int8Array(f),f.byteLength);if(w.GetEncodedGeometryType(g)==z.TRIANGULAR_MESH){var n=new z.Mesh;f=w.DecodeBufferToMesh(g,n);if(!f.ok()||0===n.ptr)throw Error("GLTF Draco: Decoding failed: "+
f.error_msg());n.num_points();for(var v in this.buffer_names){f=this.buffer_names[v];var t=v;"COLOR_0"==t?t="COLOR":"TEXCOORD_0"==t&&(t="TEX_COORD");if(t=this.decodeBuffer(n,z[t],"coords"==f||"coords1"==f,w))q[f]=t.data}v=3*n.num_faces();f=4*v;t=z._malloc(f);w.GetTrianglesUInt32Array(n,f,t);q.triangles=(new Uint32Array(z.HEAPF32.buffer,t,v)).slice();z._free(t)}z.destroy(g);z.destroy(n);return q},decodeBuffer:function(w,g,z,q){if(null==g)return null;var f=this.decoderModule;g=q.GetAttributeId(w,g);
if(-1==g)return null;var n=q.GetAttribute(w,g);g=n.data_type();var v=n.num_components(),t=w.num_points();n.size();var E=t*v,C=this.draco_data_types[g];f=new f.DracoFloat32Array;q.GetAttributeFloatForAllPoints(w,n,f);w=new C(E);for(q=0;q<w.length;++q)w[q]=f.GetValue(q);if(z)for(q=1;q<w.length;q+=v)w[q]=1-w[q];return{num_points:t,num_comps:v,data_type:g,data:w}},parseMaterial:function(w,g){var z=g.materials[w];if(!z)return console.warn("gltf material not found"),null;var q=z.name;if(!q||this.rename_assets)q=
g.filename+"::mat_"+(z.name||w);if((w=RD.Materials[q])&&(!this.overwrite_materials||w.from_filename==g.filename))return w;w=new RD.Material;w.name=q;w.from_filename=g.filename;null!=z.alphaMode&&(w.alphaMode=z.alphaMode);w.alphaCutoff=null!=z.alphaCutoff?z.alphaCutoff:.5;null!=z.doubleSided&&(w.flags.two_sided=z.doubleSided);w.normalmapFactor=1;z.pbrMetallicRoughness&&(w.model="pbrMetallicRoughness",w.color.set([1,1,1]),w.opacity=1,w.metallicFactor=1,w.roughnessFactor=1,null!=z.pbrMetallicRoughness.baseColorFactor&&
(w.color=z.pbrMetallicRoughness.baseColorFactor),z.pbrMetallicRoughness.baseColorTexture&&(w.textures.albedo=this.parseTexture(z.pbrMetallicRoughness.baseColorTexture,g),"MASK"==w.alphaMode&&this.supports_anisotropy&&RD.GLTF.force_anisotropy&&(q=gl.textures[w.textures.albedo.texture]))&&(q.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8)),null!=z.pbrMetallicRoughness.metallicFactor&&(w.metallicFactor=z.pbrMetallicRoughness.metallicFactor),
null!=z.pbrMetallicRoughness.roughnessFactor&&(w.roughnessFactor=z.pbrMetallicRoughness.roughnessFactor),z.pbrMetallicRoughness.metallicRoughnessTexture&&(w.textures.metallicRoughness=this.parseTexture(z.pbrMetallicRoughness.metallicRoughnessTexture,g)));z.occlusionTexture&&(w.textures.occlusion=this.parseTexture(z.occlusionTexture,g));z.normalTexture&&(w.textures.normal=this.parseTexture(z.normalTexture,g));z.emissiveTexture&&(w.textures.emissive=this.parseTexture(z.emissiveTexture,g));z.emissiveFactor&&
(w.emissive=z.emissiveFactor);z.extensions&&z.extensions.KHR_materials_emissive_strength&&w.emissive&&vec3.scale(w.emissive,w.emissive,z.extensions.KHR_materials_emissive_strength.emissiveStrength);z.extras&&(w.extras=z.extras);RD.Materials[w.name]&&console.debug("Material overwritten: "+w.name);RD.Materials[w.name]=w;return this.gltf_materials[w.name]=w},parseTexture:function(w,g){var z=g.textures[w.index];if(!z)return console.warn("gltf texture not found"),null;if("undefined"===typeof gl)return null;
var q=g.images[z.source];if(q.uri){var f=q.uri;f.split(".").pop()}else{f=g.url.replace(/[\/\.:]/gi,"_")+"_image_"+w.index;var n=q.mimeType?q.mimeType.split("/").pop():"png";f+="."+n}var v={};if(!gl.textures[f])if(q.uri){var t=q.uri;if("data:"==t.substr(0,5)){var E=q.uri.indexOf(","),C=q.uri.substr(5,E);n=C.split("/").pop().toLowerCase();f=g.folder+"/"+t+"image_"+w.index+"."+n;n=_base64ToArrayBuffer(q.uri.substr(E+1));C=URL.createObjectURL(new Blob([n],{type:C}));C=GL.Texture.fromURL(C,this.texture_options);
C.name=f;gl.textures[f]=C}else"blob:"==t.substr(0,5)?v.texture=t:v.texture=g.folder+"/"+t}else null!=q.bufferView&&(C=g.bufferViews[q.bufferView],null==C.byteOffset&&(C.byteOffset=0),n=g.buffers[C.buffer].data.slice(C.byteOffset,C.byteOffset+C.byteLength),C=URL.createObjectURL(new Blob([n],{type:q.mimeType})),C=GL.Texture.fromURL(C,this.texture_options),C.name=f,gl.textures[f]=C,g.asset&&g.asset.low_quality&&(q=g.folder+"/"+g.filename.replace(/\.[^/.]+$/,"")+"/"+q.name,g.asset.hd_textures||(g.asset.hd_textures=
{}),g.asset.hd_textures[f]=q));v.texture||(v.texture=f);null!=z.sampler&&(g=g.samplers[z.sampler],null!=g.magFilter&&(v.magFilter=g.magFilter),null!=g.minFilter&&(v.minFilter=g.minFilter));w.texCoord&&(v.uv_channel=w.texCoord);return v},parseSkin:function(w,g){w=g.skins[w];var z={};null!=w.skeleton&&(z.skeleton_root=g.nodes[w.skeleton].name);var q=this.parseAccessor(w.inverseBindMatrices,g);if(!q)return console.warn("accessor is null"),null;z.bindMatrices=this.splitBuffer(q,16);z.joints=[];for(q=
0;q<w.joints.length;++q){var f=g.nodes[w.joints[q]];z.joints.push(f.id||f.name)}return z},convertSkinToSkeleton:function(w,g){if(w.skin){var z=g.findNodeByName(w.skin.skeleton_root);w.skeleton||(w.skeleton=new RD.Skeleton);w.skeleton.importSkeleton(z||g)}for(z=0;z<w.children.length;++z)this.convertSkinToSkeleton(w.children[z],g)},splitBuffer:function(w,g){w||console.warn("buffer is null");for(var z=w.length,q=[],f=0;f<z;f+=g)q.push(new w.constructor(w.subarray(f,f+g)));return q},convertVertexColor:function(w,
g){if("VEC4"===g.type)return w;var z="VEC4"===g.type?4:3,q=new Uint8Array(4*g.count),f=1;g.componentType===GL.FLOAT&&(f=255);for(let n=0;n<w.length;n+=z)g=4*Math.floor(n/z),q[g]=w[n]*f,q[g+1]=w[n+1]*f,q[g+2]=w[n+2]*f,q[g+3]=4===z?w[n+3]*f:f;return q},parseAnimation:function(w,g,z){z=g.animations[w];var q=new RD.Animation;q.name=z.name||"anim_"+w;for(var f=w=0;f<z.channels.length;++f){var n=new RD.Animation.Track,v=z.channels[f],t=z.samplers[v.sampler];n.target_node=g.nodes[v.target.node].name;n.target_property=
v.target.path.toLowerCase();if(v=this.rename_animation_properties[n.target_property])n.target_property=v;v=this.parseAccessor(t.input,g);var E=this.parseAccessor(t.output,g);if(E){t=g.accessors[t.output];var C=t.type,c=RD.TYPES[C];c==RD.VEC4&&"rotation"==n.target_property&&(c=RD.QUAT);n.type=c;if(c=E.length/v.length){C=E.length;for(var p=new Float32Array((1+c)*C),e=0;e<C;++e){p[e*(1+c)]=v[e];var h=E.subarray(e*c,e*c+c);p.set(h,e*(1+c)+1)}n.data=p;n.packed_data=!0;n.num_components="SCALAR"===t.type&&
1<c?c:1;w=Math.max(w,v[v.length-1]);q.addTrack(n)}else console.warn("gltf unknown type:",C)}else console.warn("animation accedor missing")}q.duration=w;return q},loadFromFiles:function(w,g){function z(p){var e=p.target.result,h=this.extension;const r=n.texture_options.magFilter,u=n.texture_options.minFilter;"gltf"==h?(e=JSON.parse(e),q.main=this.filename):"glb"==h?q.main=this.filename:"bin"==h?v.push(this.filename):"jpeg"!=h&&"jpg"!=h&&"png"!=h&&"webp"!=h||"undefined"===typeof gl||(p=URL.createObjectURL(new Blob([e],
{type:p.target.mimeType})),h=GL.Texture.fromURL(p,{wrap:gl.REPEAT,extension:h,magFilter:r,minFilter:u}),h.name=this.filename,gl.textures[h.name]=h,gl.textures["/textures/"+h.name]&&(gl.textures["/textures/"+h.name]=h));q[this.filename]={filename:this.filename,data:e,extension:this.extension};f--;0==f&&(q.binaries=v,n.load(q,function(m){g&&g(m)}))}for(var q={},f=w.length,n=this,v=[],t=0;t<w.length;++t){var E=w[t],C=new FileReader,c=E.name.split(".");c=c[c.length-1].toLowerCase();C.onload=z;C.filename=
E.name;C.extension=c;"gltf"==c?C.readAsText(E):C.readAsArrayBuffer(E)}},removeRootPathFromTextures:function(w,g,z){if(g)for(var q in w){g=w[q];for(var f in g.textures)if(z=g.textures[f])z.constructor===String&&0==z.indexOf(ROOM.root_path)&&-1!=z.texture.indexOf("/")?z.substr(ROOM.root_path.length):z.texture&&0==z.texture.indexOf(ROOM.root_path)&&-1!=z.texture.indexOf("/")&&(z.texture=z.texture.substr(ROOM.root_path.length))}},encodeGLTF:function(w,g){function z(m,A){A=A.data?A.data:A;var H=A.length,
I=1,G=q.FLOAT;A.constructor===Uint32Array?(G=q.UNSIGNED_INT,m="SCALAR"):A.constructor===Uint16Array?(G=q.UNSIGNED_SHORT,m="SCALAR"):"TEXCOORD_0"==m||"TEXCOORD_1"==m?(I=2,m="VEC2"):(I=3,m="VEC3");H/=I;var L=Array.from(A.subarray(0,I));var P=Array.from(A.subarray(0,I));for(var N=0;N<A.length;N++)L[N%I]=Math.min(A[N],L[N%I]),P[N%I]=Math.max(A[N],P[N%I]);A={bufferView:f.push(A)-1,byteOffset:0,componentType:G,count:H,type:m,max:P,min:L};return n.accessors.push(A)-1}var q=WebGL2RenderingContext,f=[],n=
{accessors:[],asset:{generator:"RendeerJS",version:"2.0"},bufferViews:[],buffers:[{}],meshes:[],nodes:[],scene:0,scenes:[{nodes:[0]}]},v=0;g=[];var t=0,E=[];w=w.root.getAllChildren([w.root]);for(var C=0;C<w.length;++C){var c=w[C];c._index_in_glb=C;var p=c.mesh?this.meshes[c.mesh]:null;if(p&&null==p._index_in_glb){p._index_in_glb=v++;g[p._index_in_glb]=p;p._glb_attributes={};p._glb_attributes.POSITION=z("POSITION",p.vertexBuffers.vertices);if(p.vertexBuffers.normals){for(var e=0;e<p.vertexBuffers.normals.data.length;e+=
3){var h=p.vertexBuffers.normals.data.subarray(e,e+3);vec3.normalize(h,h)}p._glb_attributes.NORMAL=z("NORMAL",p.vertexBuffers.normals)}p.vertexBuffers.coords&&(p._glb_attributes.TEXCOORD_0=z("TEXCOORD_0",p.vertexBuffers.coords));p.vertexBuffers.coords1&&(p._glb_attributes.TEXCOORD_1=z("TEXCOORD_1",p.vertexBuffers.coords1));p.indexBuffers.triangles&&(p._glb_indices=z("INDICES",p.indexBuffers.triangles));if(p.indexBuffers.triangles&&p.info&&p.info.groups){h=p.indexBuffers.triangles;var r=[];for(e=0;e<
p.info.groups.length;++e){var u=p.info.groups[e];u=new h.data.constructor(h.data.subarray(u.start,u.start+u.length));u=z("INDICES",u);r.push(u)}p._glb_indices_group=r}}c.material&&(c=RD.Materials[c.material])&&null==c._index_in_glb&&(c._index_in_glb=t++,E[c._index_in_glb]=c)}for(C=0;C<w.length;++C){c=w[C];v={};c.name&&(v.name=c.name);if(c.mesh&&(t=RD.Materials[c.material],p=this.meshes[c.mesh])){if(c.primitives&&c.primitives.length){e={primitives:[]};for(r=0;r<c.primitives.length;++r){h={attributes:p._glb_attributes,
mode:q.TRIANGLES};if(u=RD.Materials[c.primitives[C].material]||t)h.material=u._index_in_glb;null!=p._glb_indices_group[r]&&(h.indices=p._glb_indices_group[r]);e.primitives.push(h)}r=n.meshes.length}else r=n.meshes.length,h={attributes:p._glb_attributes,mode:q.TRIANGLES},t&&(h.material=t._index_in_glb),e={primitives:[h]},null!=c.submesh&&p._glb_indices_group?h.indices=p._glb_indices_group[c.submesh]:null!=p._glb_indices&&(h.indices=p._glb_indices);n.meshes.push(e);v.mesh=r}Object.keys(c.extras).length&&
(v.extras=c.extras);if(c.children&&c.children.length)for(v.children=[],e=0;e<c.children.length;e++)v.children.push(c.children[e]._index_in_glb);p=mat4.create();for(e=0;16>e;++e)if(c._local_matrix[e]!=p[e]){v.matrix=typedArrayToArray(c._local_matrix);break}n.nodes[C]=v}if(E.length)for(n.materials=[],C=0;C<E.length;C++)c=E[C],n.materials[C]={alphaMode:"OPAQUE",doubleSided:c.flags.two_sided,emissiveFactor:[0,0,0],pbrMetallicRoughness:{baseColorFactor:Array.from(c.color)}};for(C=E=c=0;C<f.length;C++)c+=
f[C].byteLength;n.buffers[0].byteLength=c;c=new Uint8Array(c);for(C=0;C<f.length;C++){p=f[C];v=new Uint8Array(p.buffer);c.set(v,E);t={buffer:0,byteOffset:E,byteLength:v.byteLength};if(p.constructor===Float32Array)t.target=q.ARRAY_BUFFER;else if(p.constructor===Uint16Array||p.constructor===Uint32Array)t.target=q.ELEMENT_ARRAY_BUFFER;n.bufferViews.push(t);E+=v.byteLength}for(C=0;C<g.length;++C)delete g[C]._glb_indices,delete g[C]._index_in_glb,delete g[C]._glb_attributes;for(C=0;C<w.length;++C)delete w[C]._index_in_glb;
return{json:n,binary:c}},encodeGLB:function(w,g){w=JSON.stringify(w);var z=(new TextEncoder).encode(w);w=4*Math.ceil(z.byteLength/4);var q=4*Math.ceil(g.byteLength/4),f=new Uint8Array(20+w+8+q),n=new DataView(f.buffer);n.setUint32(0,1179937895,!0);n.setUint32(4,2,!0);n.setUint32(8,f.byteLength,!0);var v=12;n.setUint32(v,w,!0);n.setUint32(v+4,RD.GLTF.JSON_CHUNK,!0);f.set(z,v+8);for(z=z.byteLength;z<w;++z)f[v+8+z]=32;v+=8+w;n.setUint32(v,q,!0);n.setUint32(v+4,RD.GLTF.BINARY_CHUNK,!0);f.set(g,v+8);return f}};
RD.SceneNode.prototype.loadGLTF=function(w,g,z){function q(n){f.loading=!1;n.updateGlobalMatrix(!1,!0);n&&f.addChild(n);g&&g(f,n)}var f=this;RD.GLTF.prefabs[w]&&!z?(z=new RD.SceneNode,z.configure(RD.GLTF.prefabs[w]),q(z)):(this.loading=!0,RD.GLTF.load(w,q))};function _base64ToArrayBuffer(w){w=window.atob(w);for(var g=w.length,z=new Uint8Array(g),q=0;q<g;q++)z[q]=w.charCodeAt(q);return z.buffer}"undefined"!=typeof DracoDecoderModule&&RD.GLTF.installDracoModule(RD.GLTF.onReady);
(function(w){function g(q){this.renderer=q;this.mode=g.FORWARD;this.visible_layers=65535;this.bgcolor=vec4.fromValues(.1,.1,.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.emissive_factor=this.occlusion_gamma=this.occlusion_factor=this.exposure=this.environment_factor=1;this.postfx_shader_name=null;this.timer_queries_enabled=!0;this.brightness=this.contrast=1;this.gamma=2.2;this.parallax_reflection=!1;
this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=mat4.create();this.texture_matrix=mat3.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.skip_background=this.single_pass=!1;this.allow_instancing=!0;this.debug_instancing=!1;this.use_rendertexture=!0;this.alpha_composite_target_texture=this.fx=null;this.frame_time=-1;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_occlusion_gamma:this.occlusion_gamma,
u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_gamma:this.gamma,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_viewport:gl.viewport_data,u_camera_perspective:1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec3.fromValues(0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),u_backface_color:vec3.fromValues(.5,
.5,.5),u_normalFactor:1,u_metallicRough:!1,u_reflectance:.1,u_texture_matrix:this.texture_matrix,u_displacement_factor:0,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:.5,u_isAnisotropic:!1,u_anisotropy:.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this._instancing_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.current_camera=this.final_fbo=this.final_texture=
null;this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new z.Material;this.onRenderBackground=null}var z=w.RD;g.FORWARD=1;g.DEFERRED=2;g.MACROS={UVS2:1,COLOR:2,POINTS:4,INSTANCING:8,SKINNING:16,PARALLAX_REFLECTION:32};g.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");g.maps_sampler=[];for(w=0;w<g.maps.length;++w)g.maps_sampler[w]="u_"+
g.maps[w]+"_texture";g.prototype.render=function(q,f,n,v,t,E,C){this.renderer=q;this.current_camera=v;this.mode==g.FORWARD?this.renderForward(f,n,v,E,C):this.mode==g.DEFERRED&&this.renderDeferred(f,n,v,C)};g.prototype.fillGlobalUniforms=function(q){var f=this.getBRDFIntegratorTexture();f&&f.bind(0);this.environment_texture?(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=
!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;this.global_uniforms.u_occlusion_gamma=this.occlusion_gamma;this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3);this.global_uniforms.u_camera_perspective=q._projection_matrix[5];this.global_uniforms.u_tonemapper=
0;this.quality?(this.global_uniforms.u_exposure=this.exposure,this.global_uniforms.u_gamma=this.gamma):(this.global_uniforms.u_exposure=Math.pow(this.exposure,1/2.2),this.global_uniforms.u_gamma=this.use_rendertexture?this.gamma:1)};g.prototype.renderForward=function(q,f,n,v,t){f=Math.floor(gl.viewport_data[2]*this.resolution_factor);var E=Math.floor(gl.viewport_data[3]*this.resolution_factor);f=Math.min(f,this.max_texture_size);E=Math.min(E,this.max_texture_size);this.use_rendertexture&&!v&&(this.frame_texture&&
this.frame_texture.width==f&&this.frame_texture.height==E||(this.frame_texture=new GL.Texture(f,E,{format:gl.RGBA,type:gl.HALF_FLOAT,filter:gl.LINEAR}),this.final_fbo?this.final_fbo.setTextures([this.frame_texture]):this.final_fbo=new GL.FBO([this.frame_texture],null,!0),this.frame_texture.name=":frame_texture",gl.textures[this.frame_texture.name]=this.frame_texture,this.final_texture=new GL.Texture(f,E,{format:gl.RGB,filter:gl.LINEAR}),this.final_texture.name=":final_frame_texture",gl.textures[this.final_texture.name]=
this.final_texture),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);if(!this.skip_background){if(this.onRenderBackground)this.onRenderBackground(n,this);else this.renderSkybox(n);LEvent.trigger(this,"renderSkybox",this)}this.fillGlobalUniforms(n);if(this.onRenderOpaque)this.onRenderOpaque(this,this.renderer,
n);LEvent.trigger(this,"renderOpaque",this);this.renderRenderables(q,n,t);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,n);LEvent.trigger(this,"renderAlpha",this);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,n);LEvent.trigger(this,"renderGizmos",this);this.use_rendertexture&&!v&&this.renderFinalBuffer();if(this.renderer.overlay_renderables&&this.renderer.overlay_renderables.length)for(q=this.renderer.overlay_renderables,this.global_uniforms.u_gamma=1,this.global_uniforms.u_exposure=
1,gl.clear(gl.DEPTH_BUFFER_BIT),n=0;n<q.length;++n)v=q[n],this.renderMeshWithMaterial(v.model,v.mesh,v.material,v.index_buffer_name,v.group_index,v.node.extra_uniforms,v.reverse_faces,v.skin)};g.prototype.renderRenderables=function(q,f,n){f=(this.alpha_composite_callback||this.alpha_composite_target_texture)&&GL.FBO.current;n=!0;for(var v=0;v<q.length;++v){var t=q[v];n&&f&&"BLEND"==t.material.alphaMode&&(n=!1,this.alpha_composite_target_texture&&GL.FBO.current.color_textures[0].copyTo(this.alpha_composite_target_texture),
this.alpha_composite_callback&&this.alpha_composite_callback(GL.FBO.current,this.alpha_composite_target_texture));var E=t.model;t.instances&&t.instances.length&&(E=GL.linearizeArray(t.instances,Float32Array));this.renderMeshWithMaterial(E,t.mesh,t.material,t.index_buffer_name,t.group_index,t.primitive,t.node.extra_uniforms,t.reverse_faces,t.skin)}};g.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.frame_texture,
null,this.frame_texture);this.fx_uniforms.u_viewportSize[0]=this.frame_texture.width;this.fx_uniforms.u_viewportSize[1]=this.frame_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.frame_texture.width;this.fx_uniforms.u_iViewportSize[1]=1/this.frame_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=this.brightness;this.fx_uniforms.u_gamma=this.gamma;this.frame_texture.copyTo(this.final_texture,gl.shaders.fxaa_tonemapper,this.fx_uniforms);var q=null;this.postfx_shader_name&&
(q=gl.shaders[this.postfx_shader_name])&&q.setUniform("u_size",[this.final_texture.width,this.final_texture.height]);this.final_texture.toViewport(q)};g.prototype.setParallaxReflectionTransform=function(q){this.parallax_reflection_matrix.set(q);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};
g.prototype.resetShadersCache=function(){this.compiled_shaders={}};g.prototype.getShader=function(q,f,n){n=n||"";var v=n+":"+f,t=this.compiled_shaders[v];t||=this.compiled_shaders[v]=new Map;if(v=t.get(q))return v;if(!this.renderer.shader_files)return null;n=this.renderer.shader_files[n||"default.vs"];f=this.renderer.shader_files[f];if(!n||!f)return null;v=null;if(q){v={};for(var E in g.MACROS)q&g.MACROS[E]&&(v[E]="")}v=new GL.Shader(n,f,v);t.set(q,v);return v};g.prototype.renderRenderable=function(q){var f=
q.model;q.instances&&q.instances.length&&(f=new Float32Array(q.instances.flat()));this.renderMeshWithMaterial(f,q.mesh,q.material,q.index_buffer_name,q.group_index,q.primitive,q.node?.extra_uniforms,q.reverse_faces,q.skin)};g.default_backface_color=[.1,.1,.1];g.prototype.renderMeshWithMaterial=function(q,f,n,v,t,E,C,c,p){var e=this.renderer;if(!n||n.constructor===String)throw"no material in renderMeshWithMaterial";if(!("BLEND"==n.alphaMode&&0>=n.color[3])){var h=this.material_uniforms,r=this.sampler_uniforms,
u=q.length/16;h.u_albedo=n.color.subarray(0,3);h.u_emissive.set(n.emissive||z.ZERO);1!=this.emissive_factor&&vec3.scale(h.u_emissive,h.u_emissive,this.emissive_factor);h.u_backface_color=n.backface_color||g.default_backface_color;var m=0;f.vertexBuffers.coords1&&(m|=g.MACROS.UVS2);f.vertexBuffers.colors&&(m|=g.MACROS.COLOR);p&&(m|=g.MACROS.SKINNING);this.parallax_reflection&&(m|=g.MACROS.PARALLAX_REFLECTION);n.primitive==GL.POINTS&&(m|=g.MACROS.POINTS);1<u&&(m|=g.MACROS.INSTANCING);this.overwrite_shader_name?
m=gl.shaders[this.overwrite_shader_name]:this.overwrite_shader_mode?m=this.getShader(m,this.overwrite_shader_mode):n.shader_name?m=gl.shaders[n.shader_name]:n.overlay?m=this.getShader(m,"overlay.fs"):"pbrMetallicRoughness"==n.model&&this.quality?(h.u_metalness=n.metallicFactor,h.u_roughness=n.roughnessFactor,h.u_metallicRough=!!n.textures.metallicRoughness,m=this.getShader(m,"pbr.fs")):m=this.getShader(m,"nopbr.fs");if(m){h.u_alpha=n.opacity;h.u_alpha_cutoff=0;h.u_normalFactor=null!=n.normalmapFactor?
n.normalmapFactor:1;h.u_displacement_factor=null!=n.displacementFactor?n.displacementFactor:1;n.uv_transform?this.texture_matrix.set(n.uv_transform):mat3.identity(this.texture_matrix);for(var A=2,H=h.u_maps_info,I=0;I<g.maps.length;++I){var G=g.maps[I];H[I]=-1;if(G=n.textures[G]){var L=null;G.constructor===Object?L=G.texture:G.constructor===String&&(L=G,G=null);if(L){var P=g.maps_sampler[I];if(!m||m.samplers[P]){var N=gl.textures[L];N||(e.autoload_assets&&-1!=L.indexOf(".")&&e.loadTexture(L,e.default_texture_settings),
N=gl.textures.white);L=16>this.max_textures?A++:I+2;r[P]=N.bind(L);H[I]=G&&null!=G.uv_channel?Math.clamp(G.uv_channel,0,3):0}}}}c||gl.frontFace(GL.CCW);e.enableItemFlags(n);c&&gl.frontFace(GL.CW);"BLEND"==n.alphaMode?(gl.enable(gl.BLEND),n.additive||"ADD"==n.blendMode?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):"MULTIPLY"==n.blendMode?gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1),h.u_alpha_cutoff=0):"MASK"==n.alphaMode?h.u_alpha_cutoff=
n.alphaCutoff:gl.disable(gl.BLEND);if(p){if(p.constructor===z.Skeleton)this.bones=p.computeFinalBoneMatrices(this.bones,f),m.setUniform("u_bones",this.bones);else if(p._bone_matrices)m.setUniform("u_bones",p._bone_matrices);else return;p.joints&&(p.skip_model=!0)}1==u&&e._uniforms.u_model.set(q);p&&p.skip_model&&mat4.identity(e._uniforms.u_model);m.uniforms(e._uniforms);m.uniforms(this.global_uniforms);m.uniforms(camera._uniforms);m.uniforms(n.uniforms);m.uniforms(h);m.uniforms(r);C&&m.uniforms(C);
n.primitive==GL.POINTS&&m.setUniform("u_pointSize",n.point_size||-1);C=null;null!=t&&f.info&&f.info.groups&&f.info.groups[t]&&(C=f.info.groups[t]);-1<n.primitive&&(E=n.primitive);t=this._instancing_uniforms;t.u_model=q;n.flags.preAlpha&&(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),1<u?m.drawInstanced(f,E,v,t):C?m.drawRange(f,E,C.start,C.length,v):m.draw(f,E,v),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL),this.rendered_renderables++);1<u?C?m.drawInstanced(f,E,v,t,C.start,C.length):m.drawInstanced(f,
E,v,t):C?m.drawRange(f,E,C.start,C.length,v):m.draw(f,E,v);this.rendered_renderables++;e.disableItemFlags(n);c&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};g.prototype.renderDeferred=function(q,f,n,v,t){v=this.prepareGBuffers();v.fbo.bind();this.renderToGBuffers(q,n,t);v.fbo.unbind();v.final_fbo.bind();this.renderFinalPass(v,f,n);v.final_fbo.unbind();this.applyPostFX(v)};g.prototype.prepareGBuffers=function(q){var f=gl.drawingBufferWidth,n=gl.drawingBufferHeight;if(this._gbuffers&&
this._gbuffers.width==f&&this._gbuffers.height==n)return this._gbuffers;this._gbuffers||(this._gbuffers={});q=this._gbuffers;q.fbo||(q.fbo=new GL.FBO);q.final_fbo||(q.final_fbo=new GL.FBO);q.width=f;q.height=n;var v={format:GL.RGBA,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE},t=new GL.Texture(f,n,v),E=new GL.Texture(f,n,v),C=new GL.Texture(f,n,v);v=new GL.Texture(f,n,v);var c=new GL.Texture(f,n,{format:GL.DEPTH_STENCIL,type:GL.UNSIGNED_INT_24_8,filter:gl.NEAREST});q.fbo.setTextures([t,E,C,v],c);f=new GL.Texture(f,
n,{format:GL.RGBA,type:gl.HALF_FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE});q.final_fbo.setTextures([f]);q.albedo=t;q.matprop=E;q.emissive=C;q.normal=v;q.depth=c;q.final=f;return q};g.prototype.renderToGBuffers=function(q,f,n){gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);this.fillGlobalUniforms(f);for(f=0;f<q.length;++f)n=
q[f],this.renderMeshWithMaterialToGBuffers(n.model,n.mesh,n.material,n.index_buffer_name,n.group_index,n.node.extra_uniforms,n.reverse_faces,n.skin)};g.prototype.renderFinalPass=function(q,f,n){gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);(f=gl.shaders.deferred_global)&&q.albedo.toViewport(f,{normal_texture:q.normal.bind(1),material_texture:q.matprop.bind(2),emissive_texture:q.emissive.bind(3),depth_texture:q.depth.bind(4),u_invVP:n._inv_viewprojection_matrix})};g.prototype.applyPostFX=function(q){gl.disable(GL.DEPTH_TEST);
gl.disable(GL.BLEND);var f=q.width,n=q.height;this.debug&&(gl.viewport(0,0,.5*f,.5*n),q.albedo.toViewport(),gl.viewport(.5*f,0,.5*f,.5*n),q.matprop.toViewport(),gl.viewport(0,.5*n,.5*f,.5*n),q.emissive.toViewport(),gl.viewport(.5*f,.5*n,.5*f,.5*n),q.normal.toViewport(),gl.viewport(0,0,f,n));q.final.toViewport()};g.prototype.renderMeshWithMaterialToGBuffers=function(q,f,n,v,t,E,C,c){var p=this.renderer,e=p._camera;if(!n||n.constructor===String)throw"no material in renderMeshWithMaterial";if("BLEND"!=
n.alphaMode){var h=this.material_uniforms,r=this.sampler_uniforms,u=q.length/16;h.u_albedo=n.color.subarray(0,3);h.u_emissive.set(n.emissive||z.ZERO);1!=this.emissive_factor&&vec3.scale(h.u_emissive,h.u_emissive,this.emissive_factor);h.u_backface_color=n.backface_color||g.default_backface_color;var m=0;f.vertexBuffers.coords1&&(m|=g.MACROS.UVS2);f.vertexBuffers.colors&&(m|=g.MACROS.COLOR);c&&(m|=g.MACROS.SKINNING);n.primitive==GL.POINTS&&(m|=g.MACROS.POINTS);1<u&&(m|=g.MACROS.INSTANCING);if(m=this.getShader(m,
"gbuffer.fs")){h.u_alpha=n.opacity;h.u_alpha_cutoff=0;h.u_normalFactor=null!=n.normalmapFactor?n.normalmapFactor:1;h.u_displacement_factor=null!=n.displacementFactor?n.displacementFactor:1;n.uv_transform?this.texture_matrix.set(n.uv_transform):mat3.identity(this.texture_matrix);for(var A=2,H=h.u_maps_info,I=0;I<g.maps.length;++I){var G=g.maps[I];H[I]=-1;if(G=n.textures[G]){var L=null;G.constructor===Object?L=G.texture:G.constructor===String&&(L=G,G=null);if(L){var P=g.maps_sampler[I];if(!m||m.samplers[P]){var N=
gl.textures[L];N||(p.autoload_assets&&-1!=L.indexOf(".")&&p.loadTexture(L,p.default_texture_settings),N=gl.textures.white);L=16>this.max_textures?A++:I+2;r[P]=N.bind(L);H[I]=G&&null!=G.uv_channel?Math.clamp(G.uv_channel,0,3):0}}}}C||gl.frontFace(GL.CCW);p.enableItemFlags(n);C&&gl.frontFace(GL.CW);"MASK"==n.alphaMode&&(h.u_alpha_cutoff=n.alphaCutoff);if(c){if(c.constructor===z.Skeleton)this.bones=c.computeFinalBoneMatrices(this.bones,f),m.setUniform("u_bones",this.bones);else if(c._bone_matrices)m.setUniform("u_bones",
c._bone_matrices);else return;c.joints&&(c.skip_model=!0)}1==u&&p._uniforms.u_model.set(q);c&&c.skip_model&&mat4.identity(p._uniforms.u_model);m.uniforms(p._uniforms);m.uniforms(this.global_uniforms);m.uniforms(e._uniforms);m.uniforms(n.uniforms);m.uniforms(h);m.uniforms(r);E&&m.uniforms(E);n.primitive==GL.POINTS&&m.setUniform("u_pointSize",n.point_size||-1);E=null;null!=t&&f.info&&f.info.groups&&f.info.groups[t]&&(E=f.info.groups[t]);t=this._instancing_uniforms;t.u_model=q;q=gl.TRIANGLES;1<u?E?m.drawInstanced(f,
q,v,t,E.start,E.length):m.drawInstanced(f,q,v,t):E?m.drawRange(f,q,E.start,E.length,v):m.draw(f,q,v);this.rendered_renderables++;p.disableItemFlags(n);C&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};g.prototype.renderSkybox=function(q){if((!this.onRenderSkybox||!this.onRenderSkybox(this,q))&&this.environment_texture&&this.render_skybox){var f=gl.meshes.cube,n=gl.shaders[this.overwrite_shader_name||"skybox"];if(n){var v=this.skybox_texture||this.environment_texture;if(v&&v.texture_type===
GL.TEXTURE_CUBE_MAP){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var t=this.renderer._model_matrix;mat4.identity(t);mat4.translate(t,t,q.position);mat4.scale(t,t,[10,10,10]);n.uniforms(this.renderer._uniforms);n.uniforms(q._uniforms);n.uniforms({u_color_texture:v.bind(1),u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD});n.draw(f,GL.TRIANGLES)}}}};g.prototype.loadEnvironment=function(q,f,n){var v=this,t=gl.textures[q];
t?(n?v.skybox_texture=t:(t.shs&&(v.environment_sh_coeffs=t.shs),v.environment_texture=t),f&&f(t)):HDRE.load(q,function(E){var C=E.toTexture(!0);C&&(gl.textures[q]=C,n?v.skybox_texture=C:(C.shs=E.shs?E.shs:null,v.environment_texture=C,C.shs&&(v.environment_sh_coeffs=C.shs)));f&&f(C)})};g.prototype.captureEnvironment=function(q,f,n){n=n||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(n,n,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,
texture_type:GL.TEXTURE_CUBE_MAP}));var v=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,q,f);this.use_rendertexture=v;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);this.environment_texture||(this.environment_texture=new GL.Texture(n,n,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};
g.prototype.getBRDFIntegratorTexture=function(q){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var f=gl.shaders.brdf_integrator;if(f){var n=gl.textures.brdf_integrator=new GL.Texture(128,128,{format:gl.RGBA,type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});if(q)return fetch(q).then(function(t){return t.arrayBuffer()}).then(function(t){n.uploadData(new Float32Array(t),{no_flip:!0})}),n;var v=gl.textures.hammersley_sample_texture;v||=this.createHammersleySampleTexture();
n.drawTo(function(t){v&&v.bind(0);f.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return n}};g.prototype.createHammersleySampleTexture=function(q){q=q||8192;for(var f=4*q,n=new Float32Array(f),v=0;v<f;v+=4){var t=2*Math.radical_inverse(v)*Math.PI;n[v]=Math.cos(t);n[v+1]=Math.sin(t)}q=new GL.Texture(q,1,{type:gl.FLOAT,format:gl.RGBA,filter:gl.LINEAR,pixel_data:n});return gl.textures.hammersley_sample_texture=q};g.prototype.setClippingPlane=function(q,f){q?this.global_uniforms.u_clipping_plane.set([f[0],
f[1],f[2],vec3.dot(q,f)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};g.prototype.startGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var q=gl.extensions.EXT_disjoint_timer_query;this._waiting_gpu_query||(void 0===this._useQueryTimestamps&&(this._useQueryTimestamps=!1,0<q.getQueryEXT(q.TIMESTAMP_EXT,q.QUERY_COUNTER_BITS_EXT)&&(this._useQueryTimestamps=!0)),gl.getParameter(q.GPU_DISJOINT_EXT),this._useQueryTimestamps?(this._start_gpu_query=q.createQueryEXT(),
this._end_gpu_query=q.createQueryEXT(),q.queryCounterEXT(this._start_gpu_query,q.TIMESTAMP_EXT)):(this._timeElapsed_gpu_query=q.createQueryEXT(),q.beginQueryEXT(q.TIME_ELAPSED_EXT,this._timeElapsed_gpu_query)))}};g.prototype.endGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled&&!this._waiting_gpu_query){var q=gl.extensions.EXT_disjoint_timer_query;this._useQueryTimestamps?q.queryCounterEXT(this._end_gpu_query,q.TIMESTAMP_EXT):q.endQueryEXT(q.TIME_ELAPSED_EXT);
this._waiting_gpu_query=!0}};g.prototype.resolveQueries=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var q=gl.extensions.EXT_disjoint_timer_query,f=this._start_gpu_query,n=this._end_gpu_query,v=this._timeElapsed_gpu_query,t=this._useQueryTimestamps;if(f||n||v){var E=gl.getParameter(q.GPU_DISJOINT_EXT),C;if(!E&&(C=t?q.getQueryObjectEXT(n,q.QUERY_RESULT_AVAILABLE_EXT):q.getQueryObjectEXT(v,q.QUERY_RESULT_AVAILABLE_EXT))){if(t){var c=q.getQueryObjectEXT(f,q.QUERY_RESULT_EXT);
c=q.getQueryObjectEXT(n,q.QUERY_RESULT_EXT)-c}else c=q.getQueryObjectEXT(v,q.QUERY_RESULT_EXT);this.frame_time=1E-6*c}if(C||E)t?(q.deleteQueryEXT(f),q.deleteQueryEXT(n),this._end_gpu_query=this._start_gpu_query=null):(q.deleteQueryEXT(v),this._timeElapsed_gpu_query=null),this._waiting_gpu_query=!1}return this.frame_time}};Math.radical_inverse=function(q){for(var f=0,n=.5;q;n*=.5,q>>=1)q&1&&(f+=n);return f};z.PBRPipeline=g})(this);
(function(w){})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(w){function g(){this.name="";this.tracks=[];this.duration=10}function z(c,p,e){return c*(1-e)+p*e}function q(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function f(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function n(){this.skeleton=new q;this.duration=0;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this._loading=!1;this.bones_map=new Uint8Array(n.MAX_BONES);
this.keyframes=null}function v(c,p,e){for(var h="",r=0;r<e;++r){var u=c.getUint8(p+r);if(!u)break;h+=String.fromCharCode(u)}return h}var t=w.RD=w.RD||{};t.Animations={};g.prototype.addTrack=function(c,p){if(p)for(p=0;p<this.tracks.length;++p)if(this.tracks[p].target_node==c.target_node){this.tracks.splice(p+1,0,c);return}this.tracks.push(c)};g.prototype.applyAnimation=function(c,p,e,h){for(var r=0;r<this.tracks.length;++r){var u=this.tracks[r];!1!==u.enabled&&(h&&(p%=this.duration),u.applyTrack(c,
p,e))}};g.prototype.toJSON=function(){for(var c={name:this.name,duration:this.duration,tracks:[]},p=0;p<this.tracks.length;++p)c.tracks.push(this.tracks[p].toJSON());return c};g.prototype.fromJSON=function(c){this.name=c.name;this.duration=c.duration;for(var p=this.tracks.length=0;p<c.tracks.length;++p){var e=new t.Animation.Track;e.fromJSON(c.tracks[p]);this.tracks.push(e)}return c};g.prototype.findNearestLeft=function(c){for(var p=0,e=0;e<this.tracks.length;++e){var h=this.tracks[e],r=h.findTimeIndex(c);
-1!=r&&(h=h.data[r],h>p&&(p=h))}return p};g.prototype.findNearestRight=function(c){for(var p=this.duration,e=0;e<this.tracks.length;++e){var h=this.tracks[e],r=h.findTimeIndex(c);-1!=r&&(h=h.data[r+1],null!=h&&h<p&&(p=h))}return p};t.Animation=g;class E{constructor(){this.enabled=!0;this.target_property=this.target_node="";this.type=t.SCALAR;this.num_components=1;this.data=[];this.packed_data=!1;this._target=null}get value_size(){return t.TYPES_SIZE[this.type]}}g.Track=E;E.prototype.addKeyframe=function(c,
p,e){1<this.value_size&&(p=new Float32Array(p));for(var h=0;h<this.data.length;++h)if(!(this.data[h][0]<c))return this.data[h][0]!=c||e?this.data.splice(h,0,[c,p]):this.data[h][1]=p,h;this.data.push([c,p]);return this.data.length-1};E.prototype.getKeyframe=function(c){if(0>c||c>=this.data.length)return console.warn("keyframe index out of bounds"),null;var p=t.TYPES_SIZE[this.type];return this.packed_data?(c*=1+p,c>this.data.length-p?null:[this.data[c],this.data.subarray(c+1,c+p+1)]):this.data[c]};
E.prototype.findTimeIndex=function(c){var p=this.data;if(!p||0==p.length)return-1;var e=t.TYPES_SIZE[this.type]*this.num_components;if(this.packed_data){e+=1;var h=p.length/e,r=0,u=0,m=h;if(0==h)return-1;if(1==h)return 0;if(p[(m-1)*e]<c)return m-1;for(;m>=r;){u=.5*(m+r)|0;h=p[u*e];if(h==c)break;if(r==m-1)return r;h<c?r=u:m=u}return u}h=p.length;u=r=0;m=h;if(0==h)return-1;if(1==h)return 0;if(p[m-1][0]<c)return m-1;for(;m>=r;){u=.5*(m+r)|0;h=p[u][0];if(h==c)break;if(r==m-1)return r;h<c?r=u:m=u}return u};
E.prototype.getSample=function(c,p,e){if(this.data&&0!==this.data.length)return this.packed_data?this.getSamplePacked(c,p,e):this.getSampleUnpacked(c,p,e)};E.prototype.getSampleUnpacked=function(c,p,e){c=Math.clamp(c,0,this.data[this.data.length-1][0]);var h=this.findTimeIndex(c);-1===h&&(h=0);var r=h,u=h+1,m=this.data;var A=t.TYPES_SIZE[this.type];if(!p||0==A||1==m.length||u==m.length||0==r&&this.data[0][0]>c)return this.data[h][1];r=m[r];u=m[u];c=(u[0]-c)/(u[0]-r[0]);1<A&&(e=e||this._result,e&&
e.length==A||(e=this._result=new Float32Array(A)));if(p===t.LINEAR)return 1==A?r[1]*c+u[1]*(1-c):t.interpolateLinear(r[1],u[1],c,e,this.type,A,this);if(p===t.CUBIC){p=0<h?m[h-1]:r;h=h<m.length-2?m[h+2]:u;if(1===A)return t.EvaluateHermiteSpline(r[1],u[1],p[1],h[1],1-c);e=t.EvaluateHermiteSplineVector(r[1],u[1],p[1],h[1],1-c,e);this.type==t.QUAT?(quat.slerp(e,u[1],r[1],c),quat.normalize(e,e)):this.type==t.TRANS10&&(A=e.subarray(3,7),r=r[1].subarray(3,7),u=u[1].subarray(3,7),quat.slerp(A,u,r,c),quat.normalize(A,
A));return e}return null};E.prototype.getSamplePacked=function(c,p,e){if(!this.data.length)return null;var h=t.TYPES_SIZE[this.type]*this.num_components;c=Math.clamp(c,0,this.data[this.data.length-h-1]);var r=this.findTimeIndex(c);-1==r&&(r=0);var u=h+1,m=r,A=r+1,H=this.data,I=H.length/u;if(!p||1==I||A==I||0==m&&this.data[0]>c)return this.getKeyframe(r)[1];1<h&&(e=e||this._result,e&&e.length==h||(e=this._result=new Float32Array(h)));var G=H.subarray(m*u,(m+1)*u);m=H.subarray(A*u,(A+1)*u);c=(m[0]-
c)/(m[0]-G[0]);if(p===t.LINEAR){if(1==h)return G[1]*c+m[1]*(1-c);u=G.subarray(1,h+1);m=m.subarray(1,h+1);return t.interpolateLinear(u,m,c,e,this.type,h,this)}if(p===t.CUBIC){if(0===h)return G[1];p=0<r?H.subarray((r-1)*u,r*u):G;A=A<I-1?H.subarray((A+1)*u,(A+2)*u):m;if(1===h)return t.EvaluateHermiteSpline(G[1],m[1],p[1],A[1],1-c);h=G.subarray(1,u);m=m.subarray(1,u);e=t.EvaluateHermiteSplineVector(h,m,p.subarray(1,u),A.subarray(1,u),1-c,e);this.type==t.QUAT?(quat.slerp(e,m,h,c),quat.normalize(e,e)):
this.type==t.TRANS10&&(u=e.subarray(3,7),h=h.subarray(3,7),m=m.subarray(3,7),quat.slerp(u,m,h,c),quat.normalize(u,u));return e}return null};E.prototype.applyTrack=function(c,p,e){if(c){p=this.getSample(p,e);if(c.constructor===t.SceneNode){if(c=c.name==this.target_node?c:c.findNodeByName(this.target_node))if(c.morphs&&"weights"===this.target_property)for(e=0;e<this.num_components;++e)c.morphs[e].weight=p[e];else c[this.target_property]=p}else c.constructor===t.Skeleton&&(c=c.getBone(this.target_node))&&
this.type==t.MAT4&&(this._bone=c,c.model.set(p));return p}};E.prototype.toJSON=function(){return{enabled:this.enabled,target_node:this.target_node,target_property:this.target_property,type:this.type,data:this.data.constructor==Array?this.data.concat():typedArrayToArray(this.data),packed_data:this.packed_data}};E.prototype.fromJSON=function(c){this.enabled=c.enabled;this.target_node=c.target_node;this.target_property=c.target_property;if(c.property){var p=c.property.indexOf("/");this.target_node=c.property.substr(0,
p);this.target_property=c.property.substr(p+1)}null!=c.type&&(this.type=c.type.constructor===String?t.TYPES[c.type.toUpperCase()]||0:c.type);c.packed_data||c.data.constructor===Float32Array?(this.packed_data=!0,this.data=new Float32Array(c.data)):(this.packed_data=!1,this.data=c.data.concat())};t.interpolateLinear=function(c,p,e,h,r,u,m){if(1==u)return c*e+p*(1-e);h=h||m._result;h&&h.length==u||(h=m._result=new Float32Array(u));switch(r){case t.QUAT:quat.slerp(h,p,c,e);quat.normalize(h,h);break;case t.TRANS10:for(r=
0;3>r;r++)h[r]=c[r]*e+p[r]*(1-e);for(r=7;10>r;r++)h[r]=c[r]*e+p[r]*(1-e);c=c.subarray(3,7);p=p.subarray(3,7);u=h.subarray(3,7);quat.slerp(u,p,c,e);quat.normalize(u,u);break;default:for(r=0;r<u;r++)h[r]=c[r]*e+p[r]*(1-e)}return h};t.EvaluateHermiteSpline=function(c,p,e,h,r){var u=r*r,m=u*r;return(2*m-3*u+1)*c+(-2*m+3*u)*p+(m-2*u+r)*(p-e)+(m-u)*(h-c)};t.EvaluateHermiteSplineVector=function(c,p,e,h,r,u){u=u||new Float32Array(u.length);var m=r*r,A=m*r,H=2*A-3*m+1,I=-2*A+3*m;r=A-2*m+r;m=A-m;A=0;for(var G=
u.length;A<G;++A)u[A]=H*c[A]+I*p[A]+r*(p[A]-e[A])+m*(h[A]-c[A]);return u};Math.lerp||(Math.lerp=z);t.Skeleton=q;q.Bone=f;f.prototype.toJSON=function(){return{name:this.name,model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};f.prototype.fromJSON=function(c){this.name=c.name;this.model.set(c.model);this.parent=c.parent;this.layer=c.layer;this.num_children=0;this.index=null!=c.index?
c.index:-1;c.children&&(this.children.set(c.children),this.num_children=c.children.constructor===Array?c.children.length:c.num_children)};q.prototype.applyTransformToBones=function(c,p){(c=this.getBone(c))&&mat4.multiply(c.model,c.model,p)};q.prototype.getBone=function(c){return this.bones[this.bones_by_name.get(c)]};q.identity=mat4.create();q.prototype.getBoneMatrix=function(c,p,e){var h=-1;c.constructor===String?h=this.bones_by_name.get(c):c.constructor===Number&&(h=c);if(void 0===h)return q.identity;
if(!p)return this.bones[h].model;c=this.global_bone_matrices[h];if(!e)return c;e=this.bones[h];c.set(e.model);for(e=this.bones[e.parent];e;)c=mat4.mul(c,e.model,c),e=this.bones[e.parent];return c};q.prototype.updateBoneGlobalMatrix=function(c){var p=this.bones[c];if(p)for(c=this.global_bone_matrices[c],c.set(p.model),p=this.bones[p.parent];p;)c=mat4.mul(c,p.model,c),p=this.bones[p.parent]};q.prototype.updateChildBonesGlobalMatrices=function(c){if(c=c.constructor==q.Bone?c:this.getBone(c)){var p=this.global_bone_matrices[c.index];
mat4.mul(p,this.global_bone_matrices[c.parent],p);for(c=0;c<this.num_children;++c)this.updateChildBonesGlobalMatrices(this.children[c])}};q.prototype.importSkeleton=function(c,p){function e(u){var m=new f;m.name=u.name||u.id;u.model?m.model.set(u.model):u.transform&&u.getLocalMatrix&&m.model.set(u.getLocalMatrix());m.index=r.length;r.push(m);h.bones_by_name.set(m.name,m.index);h.global_bone_matrices.push(mat4.create());if(u.children&&u.children.length){m.num_children=u.children.length;for(var A=0;A<
u.children.length;++A){var H=e(u.children[A]);m.children[A]=H.index;H.parent=m.index}}return m}var h=this;r?this.bones.length=0:this.bones=[];var r=this.bones;e(c);p&&mat4.mul(r[0].model,p,r[0].model);this.updateGlobalMatrices()};q.temp_mat4=mat4.create();q.temp_mat43=q.temp_mat4.subarray(0,12);q.prototype.computeFinalBoneMatrices=function(c,p,e){if(!this.bones.length||!p||!p.bones)return c||[];this.updateGlobalMatrices();var h=e?12*p.bones.length:16*p.bones.length;c&&c.length==h||(c=new Float32Array(h));
if(e){var r=q.temp_mat43;for(e=0;e<p.bones.length;++e)h=p.bones[e],mat4.multiply(temp_mat4,this.getBoneMatrix(h[0],!0),h[1]),p.bind_matrix&&mat4.multiply(temp_mat4,temp_mat4,p.bind_matrix),mat4.transpose(temp_mat4,temp_mat4),c.set(r,12*e)}else for(e=0;e<p.bones.length;++e)h=p.bones[e],r=c.subarray(16*e,16*e+16),mat4.multiply(r,this.getBoneMatrix(h[0],!0),h[1]),p.bind_matrix&&mat4.multiply(r,r,p.bind_matrix);return c};q.prototype.computeFinalBoneMatricesAsArray=function(c,p,e){if(!this.bones.length||
!p||!p.bones)return c||[];this.updateGlobalMatrices();c=c||[];c.length=p.bones.length;for(var h=0;h<p.bones.length;++h){var r=p.bones[h];c[h]||(c[h]=mat4.create());var u=c[h];mat4.multiply(u,this.getBoneMatrix(r[0],!0),r[1]);p.bind_matrix&&mat4.multiply(u,u,p.bind_matrix);e&&mat4.multiply(u,e,u)}return c};q.prototype.updateGlobalMatrices=function(){var c=this.bones;if(c.length){var p=this.bones.length;this.global_bone_matrices[0].set(c[0].model);for(var e=1;e<p;++e){var h=c[e];mat4.multiply(this.global_bone_matrices[e],
this.global_bone_matrices[h.parent],h.model)}}};q.prototype.assignLayer=function(c,p){};q.temp_vec3=vec3.create();q.temp_vec4=vec4.create();q.temp_mat4=mat4.create();q.prototype.applyTracksAnimation=function(c,p){for(var e=q.temp_vec3,h=q.temp_vec4,r=q.temp_mat4,u=0;u<c.tracks.length;++u){var m=c.tracks[u],A=this.bones_by_name.get(m.target_node);null!=A&&(A=this.bones[A],"model"==m.target_property||"matrix"==m.target_property?m.getSample(p,t.LINEAR,A.model):"position"==m.target_property?(m.getSample(p,
t.LINEAR,e),mat4.setTranslation(A.model,e)):"rotation"==m.target_property?(m.getSample(p,t.LINEAR,h),mat4.fromQuat(r,h),mat4.getTranslation(e,A.model),mat4.setTranslation(r,e),A.model.set(r)):"scaling"==m.target_property&&(m.getSample(p,t.LINEAR,e),mat4.scale(A.model,A.model,e)))}};q.prototype.getVertices=function(c,p){if(!this.bones.length)return null;p||this.updateGlobalMatrices();p=6*(this.bones.length-1);this._vertices&&this._vertices.length==p||(this._vertices=new Float32Array(p));p=this._vertices;
for(var e=0,h=1;h<this.bones.length;++h){var r=this.global_bone_matrices[this.bones[h].parent],u=this.global_bone_matrices[h],m=p.subarray(e,e+3),A=p.subarray(e+3,e+6);mat4.getTranslation(m,u);mat4.getTranslation(A,r);c&&(vec3.transformMat4(m,m,c),vec3.transformMat4(A,A,c));e+=6}return p};q.prototype.resizeBones=function(c){if(this.bones.length!=c)if(this.bones.length>c)this.bones.length=c,this.global_bone_matrices.length=c;else{var p=this.bones.length;for(this.bones.length=c;p<c;++p)this.bones[p]=
new f,this.global_bone_matrices[p]=mat4.create()}};q.prototype.copyFrom=function(c){this.resizeBones(c.bones.length);for(var p=0;p<c.bones.length;++p)this.bones[p].copyFrom(c.bones[p]),this.global_bone_matrices[p].set(c.global_bone_matrices[p]);this.bones_by_name=new Map(c.bones_by_name)};q.prototype.toJSON=function(){for(var c={bones:[],bone_names:{}},p=0;p<this.bones.length;++p)c.bones.push(this.bones[p].toJSON());return c};q.prototype.fromJSON=function(c){this.resizeBones(c.bones.length);c.bones_by_name?
this.bones_by_name=new Map(c.bones_by_name):this.bones_by_name.clear();for(var p=0;p<c.bones.length;++p){var e=this.bones[p];e.copyFrom(c.bones[p]);e.index=p;c.global_bone_matrices?this.global_bone_matrices[p].set(c.global_bone_matrices[p]):this.bones_by_name.set(this.bones[p].name,p)}};var C=vec3.create();q.blend=function(c,p,e,h,r,u){if(c.bones.length!=p.bones.length)console.error("skeleton must contain the same number of bones");else{e=Math.clamp(e,0,1);if(255==r){if(0==e){if(h==c)return;h.copyFrom(c);
return}if(1==e){h.copyFrom(p);return}}if(h!=c){h.resizeBones(c.bones.length);for(r=0;r<h.bones.length;++r){var m=h.bones[r];m||=h.bones[r]=new q.Bone;m.copyFrom(c.bones[r])}h.bones_by_name=new Map(c.bones_by_name)}for(r=0;r<h.bones.length;++r){var A=h.bones[r],H=c.bones[r],I=p.bones[r];for(m=0;16>m;++m)A.model[m]=Math.lerp(H.model[m],I.model[m],e);if(!u)for(A=A.model,m=0;3>m;++m)C[0]=A[0+m],C[1]=A[4+m],C[2]=A[8+m],vec3.normalize(C,C),A[0+m]=C[0],A[4+m]=C[1],A[8+m]=C[2]}}};q.shader_code="\n\t#ifdef WEBGL1\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\t#else\n\tin vec4 a_bone_indices;\n\tin vec4 a_weights;\n\t#endif\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
q.vertex_shader_code=`
	precision highp float;
	attribute vec3 a_vertex;
	attribute vec3 a_normal;
	attribute vec2 a_coord;
	
	varying vec3 v_wPosition;
	varying vec3 v_wNormal;
	varying vec2 v_coord;
	
	uniform mat4 u_viewprojection;
	uniform mat4 u_model;
	uniform mat4 u_normal_matrix;
	
	${q.shader_code} //
	
	void main() {
		v_wPosition = a_vertex;
		v_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;
		v_coord = a_coord;
		
		computeSkinning( v_wPosition, v_wNormal);
		
		v_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;
		
		gl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );
	}
`;n.MAX_BONES=64;n.VERSION=4;t.SkeletalAnimation=n;n.prototype.load=function(c,p){var e=this,h=-1!=c.toLowerCase().indexOf(".abin");this._loading=!0;return HttpRequest(c,null,function(r){e._loading=!1;r.constructor===String?e.fromData(r):e.fromBinary(r);p&&p(e)},null,{binary:h})};n.prototype.assignTime=function(c,p,e,h){if(this.duration&&this.samples_per_second){p||void 0===p?(c%=this.duration,0>c&&(c=this.duration+c)):c=Math.clamp(c,0,this.duration-1/this.samples_per_second);void 0===e&&(e=!0);c*=
this.samples_per_second;h=Math.floor(c);var r=(h+1)%this.num_keyframes;h%=this.num_keyframes;c-=Math.floor(c);var u=this.num_animated_bones;p=16*u;h*=p;r*=p;var m=this.skeleton,A=this.keyframes,H=this.bones_map;u=Math.min(u,H.length);for(var I=0;I<u;++I){var G=m.bones[H[I]];if(!G)throw"bone not found in skeleton";p=16*I;if(e)for(var L=0;16>L;++L)G.model[L]=z(A[h+p+L],A[r+p+L],c);else G.model.set(A.subarray(h+p,h+p+16))}}};n.prototype.resize=function(c,p){this.num_keyframes=Math.floor(c);this.num_animated_bones=
p;this.keyframes=new Float32Array(c*p*16)};n.prototype.assignPoseToKeyframe=function(c,p){if(p>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";p=p*this.num_animated_bones*16;for(var e=0;e<this.num_animated_bones;++e){var h=c.bones[this.bones_map[e]];null!=h&&this.keyframes.set(h.model,p+16*e)}};n.prototype.fromData=function(c){var p=c.split("\n"),e=p[0].split(",");this.duration=Number(e[0]);this.samples_per_second=Number(e[1]);this.num_keyframes=
Number(e[2]);this._datasize=c.length;this.skeleton.resizeBones(Number(e[3]));c=0;for(e=1;e<p.length;++e){var h=p[e],r=h[0];h=h.substr(1).split(",");if("B"==r){var u=Number(h[0]),m=this.skeleton.bones[u];if(!m)throw"bone not found in skeleton";m.name=h[1];m.parent=Number(h[2]);for(r=0;16>r;++r)m.model[r]=Number(h[3+r]);-1!=m.parent&&(h=this.skeleton.bones[m.parent],16<=h.num_children?console.warn("too many child bones, max is 16"):h.children[h.num_children++]=u);this.skeleton.bones_by_name.set(m.name,
u)}else if("@"==r){this.num_animated_bones=Number(h[0]);for(r=0;r<this.num_animated_bones;++r)this.bones_map[r]=Number(h[r+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==r){u=c*this.num_animated_bones*16;r=0;for(m=16*this.num_animated_bones;r<m;++r)this.keyframes[u+r]=Number(h[r+1]);c++}else break}this.assignTime(0,!1,!1)};n.prototype.toData=function(){var c=[];c.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());
for(var p=this.skeleton.bones,e=0;e<p.length;++e){var h=p[e];c.push("B"+e+","+h.name+","+h.parent+","+typedArrayToArray(h.model))}p=[];for(e=0;e<this.num_animated_bones;++e)p.push(this.bones_map[e]);c.push("@"+p.length+","+p.join(","));p=1/this.samples_per_second;for(e=0;e<this.num_keyframes;++e){h=16*e*this.num_animated_bones;h=this.keyframes.subarray(h,h+16*this.num_animated_bones);for(var r=0;r<h.length;++r)1E-6>Math.abs(h[r])&&(h[r]=0);c.push("K"+(e*p).toFixed(3)+","+h.join(","))}return c.join("\n")};
n.prototype.fromPose=function(c){this.samples_per_second=15;this.duration=1/this.samples_per_second;this.skeleton.copyFrom(c);for(var p=c.bones.length,e=0;e<c.bones.length;++e)this.bones_map[e]=e;this.resize(1,p);this.assignPoseToKeyframe(this.skeleton,0)};n.prototype.fromTracksAnimation=function(c,p,e,h){this.duration=p.duration;this.samples_per_second=e;this.skeleton.copyFrom(c);for(var r=0,u={},m=0;m<p.tracks.length;++m){var A=p.tracks[m],H=c.bones_by_name.get(A.target_node);null!=H&&(this.bones_map[r]=
H,null==u[A.target_node]&&(u[A.target_node]=A.target_node,r++))}r>c.bones.length&&console.warn("more animated bones than bones?");this.resize(Math.floor(p.duration*e),r);for(m=0;m<this.num_keyframes;++m)this.skeleton.applyTracksAnimation(p,1/e*m),h&&mat4.mul(this.skeleton.bones[0].model,h,this.skeleton.bones[0].model),this.assignPoseToKeyframe(this.skeleton,m)};n.prototype.toBinary=function(){for(var c=this.skeleton.bones.length,p=new Uint8Array(176+115*c+this.num_keyframes*this.num_animated_bones*
64),e=new DataView(p.buffer),h=0;4>h;++h)e.setUint8(h,"ABIN".charCodeAt(h));e.setInt32(4,n.VERSION,!0);e.setInt32(8,172,!0);e.setFloat32(12,this.duration,!0);e.setFloat32(16,this.samples_per_second,!0);e.setUint32(20,this.num_animated_bones,!0);e.setUint32(24,this.num_keyframes,!0);e.setUint32(28,c,!0);for(h=0;h<this.bones_map.length;++h)e.setUint8(32+h,this.bones_map[h]);var r=176;for(h=0;h<this.skeleton.bones.length;++h){var u=this.skeleton.bones[h];e.setInt8(r,u.parent);for(var m=0;32>m;++m)e.setInt8(r+
m+1,u.name.charCodeAt(m)||0);for(m=0;16>m;++m)e.setFloat32(r+32+1+4*m,u.model[m],!0);e.setUint8(r+32+1+64,u.layer);e.setUint8(r+32+2+64,u.num_children);for(m=0;16>m;++m)e.setInt8(r+32+3+64+m,u.children[m]);r+=115}r=176+115*c;c=new Uint8Array(this.keyframes.buffer);p.set(c,r);return p};n.prototype.fromBinary=function(c){c.constructor===ArrayBuffer&&(c=new Uint8Array(c));var p=new DataView(c.buffer);if("ABIN"!=v(p,0,4))return console.error("not an animation file"),!1;var e=p.getInt32(4,!0);p.getInt32(8,
!0);this.duration=p.getFloat32(12,!0);this.samples_per_second=3==e?p.getInt32(16,!0):p.getFloat32(16,!0);this.num_animated_bones=p.getUint32(20,!0);this.num_keyframes=p.getUint32(24,!0);e=p.getUint32(28,!0);for(var h=0;h<this.bones_map.length;++h)this.bones_map[h]=p.getUint8(32+h);var r=176;this.skeleton.resizeBones(e);this.skeleton.bones_by_name.clear();for(h=0;h<e;++h){var u=this.skeleton.bones[h];u.parent=p.getInt8(r);u.name=v(p,r+1,32);for(var m=0;16>m;++m)u.model[m]=p.getFloat32(r+32+1+4*m,!0);
u.layer=p.getUint8(r+32+1+64);u.num_children=p.getUint8(r+32+2+64);for(m=0;16>m;++m)u.children[m]=p.getInt8(r+32+3+64+m);r+=115;this.skeleton.bones_by_name.set(u.name,h)}r=176+115*e;p=new Uint8Array(c.subarray(r,r+this.num_keyframes*this.num_animated_bones*64));this.keyframes=new Float32Array(p.buffer);this._datasize=c.length};t.SceneNode&&(t.SceneNode.prototype.assignSkeleton=function(c){var p=gl.meshes[this.mesh];p&&(this.bones=c.computeFinalBoneMatrices(this.bones,p),this.uniforms.u_bones=this.bones)},
t.SceneNode.prototype.assignAnimation=function(c){this.assignSkeleton(c.skeleton)},t.SceneNode.prototype.updateSkinningBones=function(c){c=c||this;this.skin&&this.mesh&&t.collectBones(c,this.skin,gl.meshes[this.mesh]);if(this.children&&this.children.length)for(var p=0;p<this.children.length;++p)this.children[p].updateSkinningBones(c)});t.collectBones=function(c,p,e){function h(L,P,N){if(!P||!L)return N;if(L==P)return mat4.mul(N,L.getGlobalMatrix(),N),N;mat4.mul(N,L.matrix,N);return h(L._parent,P,
N)}if(e&&e.bones){var r=e.bones.length;p._bone_matrices||(p._bone_matrices=new Float32Array(16*r));r=p._bone_matrices;mat4.create();var u=null;p.skeleton_root&&(u=c.findNodeByName(p.skeleton_root));u||=c;p=mat4.create();for(var m=mat4.invert(mat4.create(),c.getGlobalMatrix()),A=0;A<e.bones.length;++A){var H=e.bones[A],I=r.subarray(16*A,16*A+16),G=c.findNodeByName(H[0]);G&&(mat4.identity(p),h(G,u,p),m&&mat4.multiply(p,m,p),mat4.multiply(I,p,H[1]),e.bind_matrix&&mat4.multiply(I,I,e.bind_matrix))}return r}};
t.AnimatedCharacterFromScene=function(c,p,e){var h=[],r=[],u=e=null;u=c.constructor===t.SceneNode?c:c.root;for(var m=0;m<u.children.length;++m){var A=u.children[m];if(A.name&&("Armature"==A.name||-1!=A.name.indexOf("_Hips"))||"JOINT"==A.type||A.is_joint)e=A;else if(A.mesh){h.push(A);var H=null;gl.meshes[A.mesh]?H=gl.meshes[A.mesh]:c.meshes&&c.meshes[A.mesh]&&(H=GL.Mesh.load(c.meshes[A.mesh]));H&&r.push({mesh:H})}}!e&&u.findNodesByFilter&&(m=u.findNodesByFilter(function(I){return I.skin}))&&m.length&&
(e=m[0]);!h.length&&u.findNodesByFilter&&(h=u.findNodesByFilter(function(I){return I.mesh}));h.length&&h[0].skin&&h[0].skin.skeleton_root&&(e=u.findNodeByName(h[0].skin.skeleton_root));if(!e)throw"this scene doesnt contain an animated character";m=u=null;h.length&&(A=null,1<h.length?(m=GL.Mesh.mergeMeshes(r),A=h[0].mesh,m.filename=A):(A=h[0].mesh,gl.meshes[A]?(m=gl.meshes[A],m.filename=A):c.meshes&&(m=GL.Mesh.fromBinary(c.meshes[A]),m.filename=A)),gl.meshes[A]=m,r=null,h[0].material?r=h[0].material:
h[0].primitives&&h[0].primitives.length&&(r=h[0].primitives[0].material),t.Materials[r]?u=t.Materials[r]:c.materials&&(u=c.materials[r]));h=new t.Skeleton;h.importSkeleton(e,null);r=null;c.root&&c.root.animation?r=c.root.animation:c.animations&&(r=c.animations[0].id);e=null;null!=r&&(t.Animations[r]?e=t.Animations[r]:c.resources&&(c=c.resources[r],e=new t.Animation,e.fromJSON(c.takes["default"])));e?(c=new t.SkeletalAnimation,c.fromTracksAnimation(h,e,30,null)):(console.warn("no animation in scene, creating pose one"),
c=new t.SkeletalAnimation,c.fromPose(h));c.filename=p;return{mesh:m?m.filename:null,material:u,skeleton:h,skeletal_anim:c,tracks_anim:e}};g.prototype.serialize=g.prototype.toJSON;g.prototype.configure=g.prototype.fromJSON;E.prototype.serialize=E.prototype.toJSON;E.prototype.configure=E.prototype.fromJSON;q.prototype.serialize=q.prototype.toJSON;q.prototype.configure=q.prototype.fromJSON;f.prototype.serialize=f.prototype.toJSON;f.prototype.configure=f.prototype.fromJSON;f.prototype.copyFrom=f.prototype.configure})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
