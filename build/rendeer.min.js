'use strict';(function(l){function a(d){if(this.constructor!==b.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();d&&this.configure(d)}function h(d){this.type=b.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=0.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=
mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();this.uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection_matrix:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(0.1,1E3)};d&&this.configure(d);this.updateMatrices()}function q(){this._root=new b.SceneNode;
this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}function g(d){this._color=vec4.fromValues(1,1,1,1);this.shader_name=null;this.uniforms={u_color:this._color};this.textures={};this.primitive=GL.TRIANGLES;this.blend_mode=b.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};d&&this.configure(d)}function f(d,b){b=b||{};var e=this.gl=this.context=d;if(!e||!e.enable)throw"litegl GL context not found.";d!=
l.gl&&e.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this.layers_affect_children=this.disable_cull_face=this.reverse_normals=this.sort_by_distance=!1;this.light_model="flat";this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._texture_matrix=mat3.create();this._color=vec4.fromValues(1,1,1,1);this._viewprojection2D_matrix=mat4.create();this._nodes=
[];this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_color:this._color,u_texture_matrix:this._texture_matrix};this.global_uniforms_containers=[this._uniforms];this.ambient_light=vec3.fromValues(0.6,0.67,0.8);this.light_color=vec3.fromValues(0.5,0.4,0.3);this.light_vector=vec3.fromValues(0.5442,0.6385,0.544);this._phong_uniforms={u_ambient:this.ambient_light,u_light_vector:this.light_vector,
u_light_color:this.light_color};l.gl=this.gl;this.canvas=e.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:e.REPEAT,minFilter:e.LINEAR_MIPMAP_LINEAR,magFilter:e.LINEAR};this.default_cubemap_settings={minFilter:e.LINEAR_MIPMAP_LINEAR,magFilter:e.LINEAR,is_cross:1};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});
this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:e.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:e.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;b.ignore_shaders||this.createShaders();
b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}function k(d,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();d&&this.origin.set(d);b&&this.direction.set(b)}function c(d){this._ctor();d&&this.configure(d)}function r(d){this._ctor();d&&this.configure(d)}function s(d){a.prototype._ctor.call(this,d);this._ctor();d&&this.configure(d)}function e(d,b){return vec3.dot(d,b)+d[3]}function n(d,b,e){var a=d[3],f=Math.abs(e[0]*d[0]),m=Math.abs(e[1]*
d[1]);e=Math.abs(e[2]*d[2]);f=f+m+e;d=vec3.dot(d,b)+a;return d<=-f?z:d<=f?C:B}var b=l.RD={version:0.5};b.ZERO=vec3.fromValues(0,0,0);b.ONE=vec3.fromValues(1,1,1);b.RIGHT=vec3.fromValues(1,0,0);b.LEFT=vec3.fromValues(-1,0,0);b.UP=vec3.fromValues(0,1,0);b.DOWN=vec3.fromValues(0,-1,0);b.FRONT=vec3.fromValues(0,0,-1);b.BACK=vec3.fromValues(0,0,1);b.FRONT2D=vec2.fromValues(0,1);b.WHITE=vec3.fromValues(1,1,1);b.BLACK=vec3.fromValues(0,0,0);b.IDENTITY=mat4.create();b.ONES4=vec4.fromValues(1,1,1,1);b.TRANS10_IDENTITY=
new Float32Array([0,0,0,0,0,0,1,1,1,1]);b.CENTER=0;b.TOP_LEFT=1;b.TOP_RIGHT=2;b.BOTTOM_LEFT=3;b.BOTTOM_RIGHT=4;b.TOP_CENTER=5;b.BOTTOM_CENTER=6;b.PRIORITY_BACKGROUND=30;b.PRIORITY_OPAQUE=20;b.PRIORITY_ALPHA=10;b.PRIORITY_HUD=0;b.BLEND_NONE=0;b.BLEND_ALPHA=1;b.BLEND_ADD=2;b.BLEND_MULTIPLY=3;b.NO_BILLBOARD=0;b.BILLBOARD_SPHERIC=1;b.BILLBOARD_PARALLEL_SPHERIC=2;b.BILLBOARD_CYLINDRIC=3;b.BILLBOARD_PARALLEL_CYLINDRIC=4;b.UNKNOWN=0;b.NUMBER=b.SCALAR=1;b.VEC2=2;b.VEC3=3;b.VEC4=4;b.QUAT=5;b.MAT3=6;b.TRANS10=
7;b.MAT4=8;b.STRING=9;b.TYPES={NUMBER:b.NUMBER,SCALAR:b.NUMBER,VEC2:b.VEC2,VEC3:b.VEC3,VEC4:b.VEC4,QUAT:b.QUAT,MAT3:b.MAT3,TRANS10:b.TRANS10,MAT4:b.MAT4,STRING:b.STRING};b.TYPES_SIZE=[0,1,2,3,4,4,9,10,16,0];b.NO_INTERPOLATION=0;b.LINEAR=1;b.CUBIC=2;var m=b.DEG2RAD=0.0174532925;b.RAD2DEG=57.295779578552306;b.Materials={};b.Images={};b.setup=function(d){d=d||{};if(b.configuration)throw"already called setup";b.configuration=d};var p=0;"undefined"==typeof extendClass&&(l.extendClass=function(d,b){for(var e in b)d.hasOwnProperty(e)||
(d[e]=b[e]);if(b.prototype){var a=Object.getOwnPropertyNames(b.prototype);for(e=0;e<a.length;++e){var f=a[e];d.prototype.hasOwnProperty(f)||(b.prototype.__lookupGetter__(f)?d.prototype.__defineGetter__(f,b.prototype.__lookupGetter__(f)):d.prototype[f]=b.prototype[f],b.prototype.__lookupSetter__(f)&&d.prototype.__defineSetter__(f,b.prototype.__lookupSetter__(f)))}}d.hasOwnProperty("superclass")||Object.defineProperty(d,"superclass",{get:function(){return b},enumerable:!1})});var w=mat4.create(),t=
mat3.create(),v=mat4.create(),A=vec2.create(),y=vec3.create(),u=vec3.create();vec4.create();var x=quat.create();b.SceneNode=a;a.prototype._ctor=function(){this._uid=p++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);quat.identity(this._rotation);this._scale.set(b.ONE);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;
this.bounding_box=null;this.render_priority=b.PRIORITY_OPAQUE;this.layers=3;this._instances=this.draw_range=null;this.primitive=GL.TRIANGLES;this.primitives=[];this.mesh=null;this.textures={};this.shader=null;this.blend_mode=b.BLEND_NONE;this._color=vec4.fromValues(1,1,1,1);this.material=null;this.onRender||(this.onRender=null);this.onShaderUniforms||(this.onShaderUniforms=null);this.flags={visible:!0,collides:!0};this.children=[];this._uniforms={u_color:this._color,u_color_texture:0}};a.ctor=a.prototype._ctor;
a["@position"]={type:"vec3"};a["@rotation"]={type:"quat"};a.prototype.clone=function(d){var b=new this.constructor,e;for(e in this)if("_"!=e[0])if("children"==e){if(d)for(var a=0;a<this.children.length;++a)b.addChild(this.children[a].clone(d))}else a=this[e],void 0!==a&&(null===a?b[e]=null:a.constructor===Object?b[e]=GL.cloneObject(a):a.constructor===Array?b[e]=a.concat():b[e]!==a&&(b[e]=a));return b};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(d){this._scene?
console.error("Cannot change id of a node already in a scene."):this._id=d},enumerable:!0});Object.defineProperty(a.prototype,"uniforms",{get:function(){return this._uniforms},set:function(d){GL.cloneObject(d,this._uniforms);this._uniforms.u_color=this._color},enumerable:!0});Object.defineProperty(a.prototype,"position",{get:function(){return this._position},set:function(d){this._position.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"x",{get:function(){return this._position[0]},
set:function(d){this._position[0]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"y",{get:function(){return this._position[1]},set:function(d){this._position[1]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"z",{get:function(){return this._position[2]},set:function(d){this._position[2]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rotation},set:function(d){this._rotation.set(d);
this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"scaling",{get:function(){return this._scale},set:function(d){d.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=d:this._scale.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"transform",{get:function(){return this._transform},set:function(d){this._transform.set(d);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,
"matrix",{get:function(){return this._local_matrix},set:function(d){this.fromMatrix(d)},enumerable:!1});Object.defineProperty(a.prototype,"pivot",{get:function(){return this._pivot},set:function(d){this._must_update_matrix=!0;d?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(d),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(a.prototype,"mustUpdate",{get:function(){return this._must_update_matrix},set:function(d){d&&(this._must_update_matrix=
!0)},enumerable:!1});Object.defineProperty(a.prototype,"color",{get:function(){return this._color},set:function(d){this._color.set(d)},enumerable:!0});Object.defineProperty(a.prototype,"opacity",{get:function(){return this._color[3]},set:function(d){this._color[3]=d},enumerable:!0});Object.defineProperty(a.prototype,"visible",{get:function(){return this.flags.visible},set:function(d){this.flags.visible=d},enumerable:!0});Object.defineProperty(a.prototype,"texture",{get:function(){return this.textures.color},
set:function(d){this.textures.color=d},enumerable:!1});Object.defineProperty(a.prototype,"scene",{get:function(){return this._scene},set:function(d){throw"cannot set scene, you must use addChild in its parent node";},enumerable:!1});Object.defineProperty(a.prototype,"parentNode",{get:function(){return this._parent},set:function(d){throw"Cannot set parentNode of SceneNode";},enumerable:!1});a.prototype.addChild=function(d,b){function e(d,b){if(d._scene&&d._scene!=b){var D=d._scene._nodes.indexOf(d);
-1!=D&&d._scene._nodes.splice(D,1);d.id&&d._scene._nodes_by_id[d.id]==d&&delete d._scene._nodes_by_id[d.id]}if(d._scene=b)b._nodes.push(d),d.id&&b&&(b._nodes_by_id[d.id]=d);if(d.children)for(var D=0,a=d.children.length;D<a;D++){var f=d.children[D];f._scene!=b&&e(f,b)}}if(d._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";d._parent=this;b&&d.fromMatrix(d._global_matrix);this.children||(this.children=[]);this.children.push(d);this._scene!=d._scene&&e(d,this._scene);
return this};a.prototype.removeChild=function(d,b){function e(d){if(d._scene){d.id&&d._scene._nodes_by_id[d.id]==d&&delete d._scene._nodes_by_id[d.id];var b=d._scene._nodes.indexOf(d);-1!=b&&d._scene._nodes.splice(b,1)}d._scene=null;for(var b=0,D=d.children.length;b<D;b++)e(d.children[b])}if(d._parent!=this)throw"removeChild: Not its children";if(!this.children)return this;var a=this.children.indexOf(d);if(-1==a)throw"removeChild: impossible, should be children";this.children.splice(a,1);d._parent=
null;b?d.fromMatrix(d._global_matrix):d._global_matrix.set(d._local_matrix);e(d);return this};a.prototype.removeAllChildren=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])};a.prototype.clear=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-1])};a.prototype.remove=function(){this._parent&&this._parent.removeChild(this)};a.prototype.setChildIndex=function(d,b){if(this.children){var e=this.children.indexOf(d);
-1!=e&&(this.children.splice(e,1),this.children.splice(b,0,d))}};a.prototype.getAllChildren=function(d){d=d||[];if(!this.children)return d;for(var b=0,e=this.children.length;b<e;b++){var a=this.children[b];d.push(a);a.getAllChildren(d)}return d};a.prototype.getVisibleChildren=function(d,b,e){d=d||[];null==b&&(b=65535);if(!this.children||!1===this.flags.visible)return d;for(var a=0,f=this.children.length;a<f;a++){var m=this.children[a];if(!1!==m.flags.visible){var p=m.layers&b;if(!e||p)p&&d.push(m),
m.getVisibleChildren(d,b)}}return d};a.prototype.serialize=function(){var d={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(d.name=this.name);this.primitives&&this.primitives.length&&(d.primitives=this.primitives.map(function(d){return Object.assign({},d)}));this.mesh&&(d.mesh=this.mesh);this.material&&(d.material=this.material);
null!=this.submesh&&(d.submesh=this.submesh);this.flags&&(d.flags=JSON.parse(JSON.stringify(this.flags)));this.extra&&(d.extra=this.extra);this.animation&&(d.animation=this.animation);if(this.animations){d.animations=[];for(var b=0;b<this.animations.length;++b)d.animations.push(this.animations[b].serialize())}if(this.skin)for(d.skin={},d.skin.joints=this.skin.joints.concat(),d.skin.skeleton_root=this.skin.skeleton_root,d.skin.bindMatrices=[],b=0;b<this.skin.bindMatrices.length;++b)d.skin.bindMatrices.push(typedArrayToArray(this.skin.bindMatrices[b]));
this.skeleton&&(d.skeleton=this.skeleton.serialize());if(this.onSerialize)this.onSerialize(d);if(this.children)for(var b=0,e=this.children.length;b<e;b++)d.children.push(this.children[b].serialize());return d};a.prototype.configure=function(d){var e=null,a;for(a in d){switch(a){case "children":continue;case "uniforms":for(var f in d.uniforms)this.uniforms[f]=d.uniforms[f];continue;case "texture":this[a]=d[a];continue;case "flags":for(f in d.flags)this.flags[f]=d.flags[f];continue;case "scale":case "scaling":vec3.copy(this._scale,
[1,1,1]);this.scale(d[a]);continue;case "tiling":isNumber(d[a])?this.setTextureTiling(d[a],d[a]):this.setTextureTiling(d[a][0],d[a][1],d[a][2],d[a][3]);continue;case "skeleton":var m=new b.Skeleton;m.configure(d[a]);this.skeleton=m;continue;case "animations":this.animations=[];for(f=0;f<d.animations.length;++f)m=new b.Animation,m.configure(d.animations[f]),this.animations.push(m);continue;case "primitives":this.primitives=d.primitives.map(function(d){return Object.assign({},d)});continue;case "name":case "mesh":case "material":case "ref":case "draw_range":case "submesh":case "skin":case "extra":case "animation":this[a]=
d[a];continue;case "parent":e=d[a]}m=this[a];void 0!==m&&(m&&m.constructor===Float32Array?m.set(d[a]):this[a]=d[a])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(d.children)for(this.removeAllChildren(),a=0;a<d.children.length;++a)f=new b.SceneNode,f.configure(d.children[a]),this.addChild(f);e&&(this.parentNode?console.error("This node already has a parent"):e.addChild(this))};a.prototype.setMesh=function(d){d?"string"==typeof d?this.mesh=d:this._mesh=d:this.mesh=null};a.prototype.setTexture=
function(d,b){b?"string"==typeof b&&(this.textures[d]=b):this.textures[d]=null};a.prototype.resetTransform=function(){this._position.set(b.ZERO);quat.identity(this._rotation);this._scale.set(b.ONE);this._must_update_matrix=!0};a.prototype.translate=function(d,b){b?this.getGlobalVector(d,y):y.set(d);vec3.add(this._position,this._position,y);this._must_update_matrix=!0};a.prototype.move=a.prototype.translate;a.prototype.moveLocal=function(d){this.translate(d,!0)};a.prototype.setEulerRotation=function(d,
b,e){d&&3<=d.length?quat.fromEuler(this._rotation,d):quat.fromEuler(this._rotation,[d,b,e]);this._must_update_matrix=!0};a.prototype.setRotationFromEuler=a.prototype.setEulerRotation;a.prototype.getEulerRotation=function(d){d=d||vec3.create();quat.toEuler(d,this._rotation);return d};a.prototype.rotate=function(d,b,e){quat.setAxisAngle(x,b,d);e?quat.multiply(this._rotation,x,this._rotation):quat.multiply(this._rotation,this._rotation,x);this._must_update_matrix=!0};a.prototype.rotateQuat=function(d,
b){b?quat.multiply(this._rotation,d,this._rotation):quat.multiply(this._rotation,this._rotation,d);this._must_update_matrix=!0};a.prototype.scale=function(d){d.constructor===Number?(y[0]=y[1]=y[2]=d,vec3.mul(this._scale,this._scale,y)):vec3.mul(this._scale,this._scale,d);this._must_update_matrix=!0};a.prototype.lookAt=function(d,b,e,a){this.position=d;this.orientTo(b,a,e)};a.prototype.orientTo=function(d,e,a,f,m){var p=this.getGlobalPosition(),c=vec3.create();f?c.set(d):vec3.sub(c,p,d);m&&(c[1]=0);
a=a||b.UP;vec3.normalize(c,c);e&&vec3.scale(c,c,-1);d=mat3.create();a=vec3.cross(vec3.create(),a,c);vec3.normalize(a,a);e=vec3.cross(vec3.create(),c,a);vec3.normalize(e,e);mat3.setColumn(d,a,0);mat3.setColumn(d,e,1);mat3.setColumn(d,c,2);quat.fromMat3(this._rotation,d);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0};a.prototype.setPivot=function(d){this.pivot=d};a.prototype.setTextureTiling=function(d,b,e,a){this.texture_matrix||(this.texture_matrix=mat3.create(),this._uniforms.u_texture_matrix=
this.texture_matrix);e=e||0;a=a||0;this.shader||(this.shader="texture_transform");mat3.identity(this.texture_matrix);mat3.translate(this.texture_matrix,this.texture_matrix,[e,a]);mat3.scale(this.texture_matrix,this.texture_matrix,[d,b])};a.prototype.getLocalMatrix=function(d){this._must_update_matrix&&this.updateLocalMatrix();return d?(d.set(this._global_matrix),d):this._local_matrix};a.prototype.getGlobalMatrix=function(d,b){this.updateGlobalMatrix(b);return d?(d.set(this._global_matrix),d):this._global_matrix};
a.prototype.getGlobalRotation=function(d){d=d||vec4.create();quat.identity(d);for(var b=this,e=this._scene?this._scene._root:null;b!=e;)quat.multiply(d,b._rotation,d),b=b._parent;return d};a.prototype.updateLocalMatrix=function(){var d=this._local_matrix;this._must_update_matrix=!1;mat4.identity(d);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(d[12]=this._pivot[0],d[13]=this._pivot[1],d[14]=this._pivot[2]),mat4.translate(d,d,this._position),mat4.fromQuat(v,this._rotation),mat4.multiply(d,
d,v),mat4.scale(d,d,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(d,d,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))};a.prototype.updateGlobalMatrix=function(d,b){var e=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?(e=d?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(e):mat4.multiply(this._global_matrix,e,this._local_matrix)):
this._global_matrix.set(this._local_matrix);if(b)for(e=0;e<this.children.length;e++)this.children[e].updateGlobalMatrix(!0,b)};a.prototype.updateMatrices=function(d){this.updateLocalMatrix();this.updateGlobalMatrix(d)};a.prototype.fromMatrix=function(d,e){if(e&&this._parent&&this._parent._transform){mat4.copy(this._global_matrix,d);var a=this._parent.getGlobalMatrix();mat4.invert(a,a);d=mat4.multiply(this._local_matrix,a,d)}a=mat4.clone(d);mat4.multiplyVec3(this._position,a,[0,0,0]);var f=vec3.create();
this._scale[0]=vec3.length(mat4.rotateVec3(f,a,b.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(f,a,b.UP));this._scale[2]=vec3.length(mat4.rotateVec3(f,a,b.BACK));a=mat3.fromMat4(t,a);quat.fromMat3AndQuat(this._rotation,a);d!=this._local_matrix&&mat4.copy(this._local_matrix,d);this._must_update_matrix=!1};a.prototype.getLocalPoint=function(d,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,d,this._local_matrix)};a.prototype.getParentVector=function(d,
b){b=b||vec3.create();return vec3.transformQuat(b,d,this._rotation)};a.prototype.getLocalVector=function(d){console.error("DEPRECATED: SceneNode.prototype.getLocalVector, use getGlobalVector or getParentVector")};a.prototype.getGlobalPosition=function(d,e){d=d||vec3.create();if(e)return vec3.transformMat4(d,b.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return d.set(this._position),d;var a=this.getGlobalMatrix();return vec3.transformMat4(d,b.ZERO,a)};a.prototype.localToGlobal=
function(d,b,e){b=b||vec3.create();e=this.getGlobalMatrix(null,e);return vec3.transformMat4(b,d,e)};a.prototype.getGlobalPoint=a.prototype.localToGlobal;a.prototype.globalToLocal=function(d,b){b=b||vec3.create();var e=this.getGlobalMatrix();mat4.invert(v,e);return vec3.transformMat4(b,d,v)};a.prototype.globalVectorToLocal=function(d,b){b=b||vec3.create();var e=this.getGlobalRotation();quat.invert(e,e);return vec3.transformQuat(b,d,e)};a.prototype.getGlobalVector=function(d,b){b=b||vec3.create();var e=
this.getGlobalRotation(x);return vec3.transformQuat(b,d,e)};a.prototype.getDistanceTo=function(d){var b=this.getGlobalMatrix();return vec3.distance(d,b.subarray(12,15))};a.prototype.findNode=function(d){for(var b=0,e=this.children.length;b<e;b++){var a=this.children[b];if(a.id==d||(a=a.findNode(d)))return a}return null};a.prototype.findNodeByName=function(d){if(null==d)return null;for(var b=0,e=this.children.length;b<e;b++){var a=this.children[b];if(a.name==d||(a=a.findNodeByName(d)))return a}return null};
a.prototype.findNodesByFilter=function(d,b,e){null==b&&(b=65535);e=e||[];for(var a=0,f=this.children.length;a<f;a++){var m=this.children[a];m.layers&b&&(d&&!d(m)||e.push(m),m.findNodesByFilter(d,b,e))}return e};a.prototype.propagate=function(d,b){for(var e=0,a=this.children.length;e<a;e++){var f=this.children[e];f&&(f[d]&&f[d].apply(f,b),f.children&&f.children.length&&f.propagate(d,b))}};a.prototype.loadTextConfig=function(d,e){GL.request(d,null,function(d){d=b.parseTextConfig(d);e&&e(d)},alert)};
a.prototype.destroy=function(d){!this.scene||d?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)};a.prototype.updateBoundingBox=function(d){var b=this._global_matrix,e=gl.meshes[this.mesh],a=null;e&&(a=e.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),a=BBox.transformMat4(this.bounding_box,a,b));if(d||!this.children||0==this.children.length)return a;for(d=0;d<this.children.length;++d)if(b=this.children[d].updateBoundingBox())a?BBox.merge(a,a,b):(a=
this.bounding_box=BBox.create(),a.set(b));return a};a.prototype.getMaterial=function(d){d=d||0;return this.material?b.Materials[this.material]:this.primitives&&this.primitives.length>d?b.Materials[this.primitives[d].material]:null};a.prototype.setLayerBit=function(d,b){var e=1<<d;this.layers&=~e;b&&(this.layers|=e)};a.prototype.isInLayerBit=function(d){return 0!==(this.layers&1<<d)};a.prototype.testRay=function(){var d=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();
mat4.create();return function(b,e,a,f,m,c){a=null==a?Number.MAX_VALUE:a;null==f&&(f=65535);e=e||vec3.create();void 0!==q._ray_tested_objects&&q._ray_tested_objects++;var p=null,n=null;if(!1===this.flags.visible)return null;this.layers&f&&!this.flags.ignore_collisions&&this.mesh&&(n=this.testRayWithMesh(b,d,a,f,m,c));n&&(c=vec3.distance(b.origin,d),null==a||c<a)&&(a=c,e.set(d),p=this);if(!this.children||!this.children.length)return p;for(var n=vec3.create(),k=0,t=this.children.length;k<t;++k){var w=
this.children[k].testRay(b,n,a,f,m);w&&(c=vec3.distance(b.origin,n),c>a||(a=c,e.set(n),p=w))}return p}}();a.prototype.testRayWithMesh=function(){var d=vec3.create(),e=vec3.create(),a=vec3.create(),f=mat4.create(),m=mat4.create();return function(c,p,n,k,t){if(!this.mesh)return!1;var w=gl.meshes[this.mesh];if(!w||!1===w.ready)return!1;var g=null==this.submesh?-1:this.submesh,h=this.getGlobalMatrix(f,!0);mat4.invert(m,h);vec3.transformMat4(d,c.origin,m);vec3.add(a,c.origin,c.direction);vec3.transformMat4(a,
a,m);vec3.sub(e,a,d);vec3.normalize(e,e);var r=this.flags.two_sided;if(this.primitives&&this.primitives.length){var v=b.Materials[this.primitives[0].material];v&&(r=v.flags.two_sided)}return b.testRayMesh(c,d,e,h,w,g,p,n,k,t,r)}}();a.prototype.testSphere=function(){return function(d,b,e,a){null==e&&(e=65535);var f=null;if(!1===this.flags.visible)return null;this.layers&e&&!this.flags.ignore_collisions&&this.mesh&&(f=this.testSphereWithMesh(d,b,e,a));if(f)return this;if(!this.children||!this.children.length)return null;
for(var f=0,m=this.children.length;f<m;++f){var c=this.children[f].testSphere(d,b,e,a);if(c)return c}return null}}();a.prototype.testSphereWithMesh=function(){var d=vec3.create();vec3.create();vec3.create();var e=mat4.create(),a=mat4.create();return function(f,m,c,p){if(!this.mesh)return!1;var n=gl.meshes[this.mesh];if(!n||!1===n.ready)return!1;var k=null==this.submesh?-1:this.submesh,t=this.getGlobalMatrix(e,!0);mat4.invert(a,t);vec3.transformMat4(d,f,a);f=m/vec3.length(t);m=this.flags.two_sided;
if(this.primitives&&this.primitives.length){var w=b.Materials[this.primitives[0].material];w&&(m=w.flags.two_sided)}return b.testSphereMesh(d,f,t,n,k,c,p,m)}}();a.prototype.setRangeFromSubmesh=function(d){if(null!=d&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(d.constructor===String){for(var e=0;e<b.info.groups.length;++e)if(b.info.groups[e].name==d){d=e;break}if(e===b.info.groups.length)return!1}if(d=b.info.groups[d])this.draw_range[0]=d.start,this.draw_range[1]=d.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=
null};a.prototype.findNodesInSphere=function(d,b,e,a){null==e&&(e=65535);a=a||[];for(var f=0;f<this.children.length;++f){var m=this.children[f];m.layers&e&&(m.getGlobalPosition(y,!0),vec3.distance(y,d)<=b&&a.push(m));m.children.length&&m.findNodesInSphere(d,b,e,a)}return a};b.Camera=h;h.PERSPECTIVE=1;h.ORTHOGRAPHIC=2;h.prototype.configure=function(d){null!=d.type&&(this.type=d.type);d.position&&this._position.set(d.position);d.target&&this._target.set(d.target);d.up&&this._up.set(d.up);d.near&&(this.near=
d.near);d.far&&(this.far=d.far);d.fov&&(this.fov=d.fov);d.aspect&&(this.aspect=d.aspect)};h.prototype.serialize=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};Object.defineProperty(h.prototype,"position",{get:function(){return this._position},set:function(d){this._position.set(d);this._must_update_matrix=!0},enumerable:!1});
Object.defineProperty(h.prototype,"target",{get:function(){return this._target},set:function(d){this._target.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"up",{get:function(){return this._up},set:function(d){this._up.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"fov",{get:function(){return this._fov},set:function(d){this._fov=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"aspect",{get:function(){return this._aspect},
set:function(d){this._aspect=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(d){this._frustum_size=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"near",{get:function(){return this._near},set:function(d){this._near=this.uniforms.u_camera_planes[0]=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"far",{get:function(){return this._far},
set:function(d){this._far=this.uniforms.u_camera_planes[1]=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(d){this._view_matrix.set(d);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(h.prototype,"projection_matrix",{get:function(){return this._projection_matrix},set:function(d){this._projection_matrix.set(d);mat4.multiply(this._viewprojection_matrix,
this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(h.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(d){this._viewprojection_matrix.set(d)},enumerable:!1});h.prototype.perspective=function(d,b,e,a){this.type=h.PERSPECTIVE;this._fov=d;this._aspect=b;this._near=e;this._far=a;this._must_update_matrix=!0};h.prototype.orthographic=function(d,b,e,a){this.type=h.ORTHOGRAPHIC;this._frustum_size=d;1<arguments.lenth&&(this._near=
b,this._far=e,this._aspect=a||1);this._must_update_matrix=!0};h.prototype.lookAt=function(d,b,e){this._position==b&&(b=vec3.clone(b));vec3.copy(this._position,d);vec3.copy(this._target,b);vec3.copy(this._up,e);this._must_update_matrix=!0};h.prototype.updateMatrices=function(d){if(this._autoupdate_matrices||d)if(this.type==h.ORTHOGRAPHIC?this.frustum_size.constructor===Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,
this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*m,this._aspect,this._near,this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,
this._up),this.view_texel_grid&&this.type==h.ORTHOGRAPHIC){d=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var e=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/d)*d;this._view_matrix[13]=Math.floor(this._view_matrix[13]/e)*e}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,
this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,b.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,b.UP);mat4.rotateVec3(this._front,this._model_matrix,b.FRONT);this.distance=vec3.distance(this._position,this._target);this.uniforms.u_camera_planes[0]=this._near;this.uniforms.u_camera_planes[1]=this._far};h.prototype.getModel=function(d){d=d||mat4.create();this._must_update_matrix&&
this.updateMatrices();mat4.copy(d,this._model_matrix);return d};h.prototype.updateVectors=function(d){var e=vec3.subtract(y,this._target,this._position),e=vec3.length(e);mat4.multiplyVec3(this._position,d,b.ZERO);mat4.multiplyVec3(this._target,d,[0,0,-e]);mat4.rotateVec3(this._up,d,b.UP)};h.prototype.getLocalVector=function(d,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,d)};h.prototype.localToGlobal=function(d,b){this._must_update_matrix&&
this.updateMatrices();return vec3.transformMat4(b||vec3.create(),d,this._model_matrix)};h.prototype.getLocalPoint=h.prototype.localToGlobal;h.prototype.globalToLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),d,this._view_matrix)};h.prototype.globalVectorToLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._view_matrix,d)};h.prototype.getFront=function(d){d=d||vec3.create();
vec3.subtract(d,this._target,this._position);vec3.normalize(d,d);return d};h.prototype.move=function(d,b){void 0!==b&&(vec3.scale(y,d,b),d=y);vec3.add(this._target,this._target,d);vec3.add(this._position,this._position,d);this._must_update_matrix=!0};h.prototype.moveLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();var e=mat4.rotateVec3(y,this._model_matrix,d);void 0!==b&&vec3.scale(e,e,b);vec3.add(this._target,this._target,e);vec3.add(this._position,this._position,e);this._must_update_matrix=
!0};h.prototype.rotate=function(d,b){var e=quat.setAxisAngle(x,b,d),a=vec3.subtract(y,this._target,this._position);vec3.transformQuat(a,a,e);vec3.add(this._target,this._position,a);this._must_update_matrix=!0};h.prototype.rotateLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();var e=mat4.rotateVec3(u,this._model_matrix,b),e=quat.setAxisAngle(x,e,d),a=vec3.subtract(y,this._target,this._position);vec3.transformQuat(a,a,e);vec3.add(this._target,this._position,a);this._must_update_matrix=
!0};h.prototype.orbit=function(d,b,e,a){if(!b)throw"RD: orbit axis missing";e=e||this._target;a&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(u,this._model_matrix,b));d=quat.setAxisAngle(x,b,d);b=vec3.subtract(y,this._position,this._target);vec3.transformQuat(b,b,d);vec3.add(this._position,e,b);this._must_update_matrix=!0};h.prototype.orbitDistanceFactor=function(d,b){b=b||this._target;var e=vec3.subtract(y,this._position,b);vec3.scale(e,e,d);vec3.add(this._position,b,e);this._must_update_matrix=
!0};h.prototype.project=function(d,b,e){e=e||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(e,this._viewprojection_matrix,d);e[0]=e[0]*b[2]+b[0];e[1]=e[1]*b[3]+b[1];return e};h.prototype.computeProjectedRadius=function(d,e,a,f){a=a||gl.viewport_data;if(f)return f=vec4.create(),f.set(d),f[3]=1,d=vec4.transformMat4(f,f,this._viewprojection_matrix),Math.max(1,a[3]*this._projection_matrix[5]*e/d[3]);if(this.type==b.Camera.ORTHOGRAPHIC)return e/(this._frustum_size.constructor===
Number?this._frustum_size:1)*a[3]/2;d=vec3.distance(d,this.position);return 0==d?0:1/Math.tan(this.fov/2*Math.PI/180)*e/Math.sqrt(d*d-e*e)*(a[3]/2)};h.prototype.unproject=function(d,b,e){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(e||vec3.create(),d,this._viewprojection_matrix,b)};h.prototype.getRay=function(d,e,a,f){if(void 0===d||void 0===e)throw"RD.Camera.getRay requires x and y parameters";a=a||gl.viewport_data;f||(f=new b.Ray);this._must_update_matrix&&
this.updateMatrices();var m=f.origin;vec3.set(m,d,e,0);this.type==b.Camera.ORTHOGRAPHIC?vec3.unproject(m,m,this._viewprojection_matrix,a):vec3.copy(m,this.position);var c=f.direction;vec3.set(c,d,e,1);vec3.unproject(c,c,this._viewprojection_matrix,a);vec3.sub(c,c,m);vec3.normalize(c,c);return f};h.prototype.getRayPlaneCollision=function(d,b,e,a,f,m){f=f||vec3.create();d=this.getRay(d,b,m);return geo.testRayPlane(d.origin,d.direction,e,a,f)?f:null};h.prototype.getModelForScreenPixel=function(d,b,e,
a,f){f=f||mat4.create();d=this.unproject([d,b,-1]);b=vec3.sub(vec3.create(),d,this._position);vec3.normalize(b,b);vec3.scaleAndAdd(d,d,b,e);vec3.normalize(b,b);mat4.fromTranslationFrontTop(f,d,b,this._up);return f};h.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};h.prototype.applyController=function(d,e,a,f){a=a||10;if(d){var m=vec3.create();if(gl.keys[h.controller_keys.forward]||f&&gl.keys.W)m[2]=-1;else if(gl.keys[h.controller_keys.back]||f&&gl.keys.S)m[2]=1;if(gl.keys[h.controller_keys.left]||
f&&gl.keys.A)m[0]=-1;else if(gl.keys[h.controller_keys.right]||f&&gl.keys.D)m[0]=1;vec3.sqrLen(m)&&this.moveLocal(m,d*a)}e&&(e.deltax&&this.rotate(-0.005*e.deltax,b.UP),e.deltay&&this.rotateLocal(-0.005*e.deltay,b.RIGHT))};h.prototype.lerp=function(d,b){vec3.lerp(this._position,this._position,d._position,b);vec3.lerp(this._target,this._target,d._target,b);vec3.lerp(this._up,this._up,d._up,b);this._fov=this._fov*(1-b)+d._fov*b;this._near=this._near*(1-b)+d._near*b;this._far=this._far*(1-b)+d._far*
b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+d._frustum_sizer*b);this._must_update_matrix=!0};h.prototype.orientMatrixToCamera=function(d){d.set(this._right,0);d.set(this._top,4);d.set(this._front,8)};h.prototype.extractPlanes=function(){function d(d){var b=e.subarray(d,d+3),b=vec3.length(b);0!==!b&&(b=1/b,e[d]*=b,e[d+1]*=b,e[d+2]*=b,e[d+3]*=b)}var b=this._viewprojection_matrix,e=this._planes_data||new Float32Array(24);e.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],
b[15]-b[12]],0);d(0);e.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);d(4);e.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);d(8);e.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);d(12);e.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);d(16);e.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);d(20);this._planes_data=e;this._frustrum_planes||(this._frustrum_planes=[e.subarray(0,4),e.subarray(4,8),e.subarray(8,12),e.subarray(12,16),e.subarray(16,20),e.subarray(20,24)])};var B=
b.CLIP_INSIDE=0,z=b.CLIP_OUTSIDE=1,C=b.CLIP_OVERLAP=2;h.prototype.testMesh=function(){if(l.BBox){var d=BBox.create(),b=d.subarray(0,3),e=d.subarray(3,6);return function(a,f){var m=a.bounding;if(!m)return B;BBox.transformMat4(d,m,f);return this.testBox(b,e)}}}();h.prototype.testBox=function(d,b){this._frustrum_planes||this.extractPlanes();var e=this._frustrum_planes,a=0,f=0,a=n(e[0],d,b);if(a==z)return z;f+=a;a=n(e[1],d,b);if(a==z)return z;f+=a;a=n(e[2],d,b);if(a==z)return z;f+=a;a=n(e[3],d,b);if(a==
z)return z;f+=a;a=n(e[4],d,b);if(a==z)return z;f+=a;a=n(e[5],d,b);return a==z?z:0==f+a?B:C};h.prototype.testSphere=function(d,b){this._frustrum_planes||this.extractPlanes();var a=this._frustrum_planes,f,m=!1;f=e(a[0],d);if(f<-b)return z;f>=-b&&f<=b&&(m=!0);f=e(a[1],d);if(f<-b)return z;f>=-b&&f<=b&&(m=!0);f=e(a[2],d);if(f<-b)return z;f>=-b&&f<=b&&(m=!0);f=e(a[3],d);if(f<-b)return z;f>=-b&&f<=b&&(m=!0);f=e(a[4],d);if(f<-b)return z;f>=-b&&f<=b&&(m=!0);f=e(a[5],d);if(f<-b)return z;f>=-b&&f<=b&&(m=!0);
return m?C:B};b.Scene=q;q.prototype.clear=function(){this._root=new b.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};q.prototype.getNodeById=function(d){return this._nodes_by_id[d]};q.prototype.findNodesInBBox=function(d,b,e){null==b&&(b=65535);e=e||[];for(var a=0;a<this.nodes.length;++a){var f=this.nodes[a];f.bounding_box&&f.layers&b&&geo.testBBoxBBox(f.bounding_box,d)&&e.push(f)}return e};q.prototype.update=function(d){this.time+=d;this._root.propagate("update",
[d]);this.destroyPendingNodes()};q.prototype.destroyPendingNodes=function(d){if(this._to_destroy.length)for(d=null;d=this._to_destroy.pop();)d._parent&&d._parent.removeChild(d)};Object.defineProperty(q.prototype,"root",{get:function(){return this._root},set:function(d){throw"Cannot set root of scene";},enumerable:!1});q.prototype.testRay=function(d,e,a,f,m){b.Scene._ray_tested_objects=0;e||(e=d.collision_point);null==m&&(m=!0);return this.root.testRay(d,e,a,null==f?65535:f,m)};q.prototype.testSphere=
function(d,b,e,a){null==a&&(a=!0);return this.root.testSphere(d,b,null==e?65535:e,a)};q.prototype.gatherObjects=function(d,e,a){a=a||[];d.updateGlobalMatrix(!0);if(d.mesh&&e&d.layers&&!d.skeleton){if(d.primitives&&d.primitives.length)for(var f=0;f<d.primitives.length;++f){var m=d.primitives[f];(this.overwrite_material||b.Materials[m.material])&&a.push([d,d._global_matrix,d.mesh,f,d.material])}}else a.push([d,d._global_matrix,d.mesh,-1,d.material]);for(f=0;f<d.children.length;++f)this.gatherObjects(d.children[f],
e,a);return a};b.testRayWithNodes=function(d,e,a,f,m,c,p){b.testRayWithNodes.coll_node=null;f=null==f?Number.MAX_VALUE:f;m=null==m?65535:m;b.Scene._ray_tested_objects=0;a||(a=d.collision_point);b.testRayWithNodes.local_result||(b.testRayWithNodes.local_result=vec3.create());for(var n=b.testRayWithNodes.local_result,k=null,t=0;t<e.length;++t){var w=e[t],g=w.testRay(d,n,f,m,c);if(g){var h=vec3.distance(d.origin,n);h>f||(f=h,a.set(n),b.testRayWithNodes.coll_node=g,k=p?g:w)}}return k};b.last_hit_test=
null;b.testRayMesh=function(d,e,a,f,m,c,p,n,k,t,w){n=null==n?Number.MAX_VALUE:n;var g=null;k=null;-1==c?(g=m.getBoundingBox(),k=m):(k=m.info.groups[c],g=k.bounding,g||(m.computeGroupsBoundingBoxes(),g=k.bounding));if(!g)return!1;n||(n=1E7);if(!geo.testRayBBox(e,a,g,null,y))return!1;vec3.transformMat4(p,y,f);c=vec3.distance(d.origin,p);if(c>n)return!1;if(!t)return!0;k._octree||(k._octree=k==m?new GL.Octree(m):new GL.Octree(m,k.start,k.length));e=k._octree.testRay(e,a,0,n,w);if(!e)return!1;b.last_hit_test=
e;p.set(e.hit);vec3.transformMat4(p,p,f);c=vec3.distance(d.origin,p);return c>n?!1:!0};b.testSphereMesh=function(d,b,e,a,f,m,c){m=e=null;-1==f?(e=a.getBoundingBox(),m=a):(m=a.info.groups[f],e=m.bounding,e||(a.computeGroupsBoundingBoxes(),e=m.bounding));if(!e||!geo.testSphereBBox(d,b,e))return!1;if(!c)return!0;m._octree||(m._octree=m==a?new GL.Octree(a):new GL.Octree(a,m.start,m.length));return m._octree.testSphere(d,b)?!0:!1};q.prototype.fromJSON=function(d){this.root.clear();this.root.configure(d)};
q.prototype.toJSON=function(d){function b(a,f){if(d){if(!d(a,f))return!1}else{if(!a.flags.no_transform){f.position=typedArrayToArray(a.position);if(0!=a.rotation[0]||0!=a.rotation[1]||0!=a.rotation[2]||1!=a.rotation[3])f.rotation=typedArrayToArray(a.rotation);if(1!=a.scaling[0]||1!=a.scaling[1]||1!=a.scaling[2])f.scaling=typedArrayToArray(a.scaling)}a.id&&(f.id=a.id);a.ref=f.ref=e++;a.mesh&&(f.mesh=a.mesh);null!=a.submesh&&(f.submesh=a.submesh);a.draw_range&&(f.draw_range=a.draw_range.concat());a.material&&
(f.material=a.material);a.shader&&(f.shader=a.shader);if(1!=a.color[0]||1!=a.color[1]||1!=a.color[2]||1!=a.color[3])f.color=typedArrayToArray(a.color);0<Object.values(a.textures).filter(function(d){return d})&&(f.shader=a.shader);a.extra&&(f.extra=a.extra);f.layers=a.layers;f.flags=a.flags}if(!a.children.length)return!0;for(var m=[],c=0;c<a.children.length;++c){var p={};b(a.children[c],p)&&m.push(p)}m.length&&(f.children=m);return!0}d&&d.constructor!==Function&&(d=null);var e=0,a={};b(this.root,a);
return a};g.default_shader_name="texture";Object.defineProperty(g.prototype,"color",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!0});Object.defineProperty(g.prototype,"opacity",{get:function(){return this._color[3]},set:function(d){this._color[3]=d},enumerable:!0});Object.defineProperty(g.prototype,"albedo",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!1});g.prototype.configure=function(d){for(var b in d){var e=d[b];e&&(e.constructor===
Object?e=JSON.parse(JSON.stringify(e)):e.constructor===Array?e=e.concat():e.constructor===Float32Array&&(e=new Float32Array(e)));this[b]=e}};g.prototype.register=function(d){d&&(this.name=d);if(!this.name)throw"cannot register material without name";b.Materials[this.name]=this;return this};g.prototype.serialize=function(){var d={flags:JSON.parse(JSON.stringify(this.flags)),textures:JSON.parse(JSON.stringify(this.textures))};d.color=typedArrayToArray(this._color);this.name&&(d.name=this.name);this.alphaMode&&
(d.alphaMode=this.alphaMode);this.blendMode&&(d.blendMode=this.blendMode);0.5!=this.alphaCutoff&&(d.alphaCutoff=this.alphaCutoff);this.uv_transform&&(d.uv_transform=this.uv_transform);this.normalFactor&&(d.normalFactor=this.normalFactor);this.displacementFactor&&(d.displacementFactor=this.displacementFactor);this.backface_color&&(d.backface_color=typedArrayToArray(this.backface_color));this.emissive&&(d.emissive=typedArrayToArray(this.emissive));this.model&&(d.model=this.model,d.metallicFactor=this.metallicFactor,
d.roughnessFactor=this.roughnessFactor);return d};g.MACROS={TEXTURE:1,ALBEDO:2,COLOR:4,INSTANCING:8,SKINNING:16,PHONG:32,POINTS:64};g.prototype.render=function(d,b,e,a,f,m,c){d.on_getShader?shader=d.on_getShader(c,d._camera):(c=this.shader_name)?shader=gl.shaders[c]:(c=0,this.textures.color&&(c|=g.MACROS.TEXTURE),this.textures.albedo&&(c=g.MACROS.ALBEDO),e.vertexBuffers.colors&&(c|=g.MACROS.COLOR),m&&(c|=g.MACROS.SKINNING),"phong"==d.light_model&&(c|=g.MACROS.PHONG),shader=d.getMasterShader(c));shader||
(c=this.textures.color||this.textures.albedo,shader=m?c?d._texture_skinning_shader:d._flat_skinning_shader:c?d._texture_shader:d._flat_shader);c=0;var p=null,n;for(n in this.textures){var k=this.textures[n];if(k){k.constructor===Object&&(k=k.texture);var t="u_"+n+"_texture";if(!shader||shader.samplers[t])p=gl.textures[k],p||(d.autoload_assets&&-1!=k.indexOf(".")&&d.loadTexture(k,d.default_texture_settings),p=gl.textures.white),this.uniforms[t]=p.bind(c++)}}p||(shader.samplers.u_albedo_texture||shader.samplers.u_color_texture)&&
gl.textures.white.bind(0);d.enableItemFlags(this);d._uniforms.u_model.set(b);m&&shader.uniformInfo.u_bones&&(this.bones=m.computeFinalBoneMatrices(this.bones,e),shader.setUniform("u_bones",this.bones));d._uniforms.u_global_alpha_clip=null!=this.alphaCutoff&&"MASK"==this.alphaMode?this.alphaCutoff:-1;shader.uniforms(d._uniforms);shader.uniforms(this.uniforms);"phong"==d.light_model&&shader.uniforms(d._phong_uniforms);b=null;null!=f&&e.info&&e.info.groups&&e.info.groups[f]&&(b=e.info.groups[f]);b?shader.drawRange(e,
this.primitive,b.start,b.length,a):shader.draw(e,this.primitive,a);d.disableItemFlags(this);d.draw_calls+=1};b.Material=g;f.prototype.getMasterShader=function(d){this.master_shaders_compiled||(this.master_shaders_compiled=new Map);var e=this.master_shaders_compiled,a=e.get(d);if(a)return a;var a=f.master_vertex_shader,m=f.master_fragment_shader;b.Skeleton&&d&g.MACROS.SKINNING&&(a=a.replaceAll("#pragma SKINNING_HEADER","\n\t\t#ifdef SKINNING\n\t\t\t"+b.Skeleton.shader_code+"\n\t\t#endif\n\t\t"),a=
a.replaceAll("#pragma SKINNING_BODY","\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t"));var c=null;if(d){var c={},p;for(p in g.MACROS)d&g.MACROS[p]&&(c[p]="")}a=new GL.Shader(a,m,c);e.set(d,a);return a};f.master_vertex_shader="\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\tvarying vec3 v_pos;\n\tvarying vec3 v_normal;\n\tvarying vec2 v_coord;\n\t#ifdef COLOR\n\tattribute vec4 a_color;\n\tvarying vec4 v_color;\n\t#endif\n\t#pragma SKINNING_HEADER\n\t#ifdef INSTANCING\n\t\tattribute mat4 u_model;\n\t#else\n\t\tuniform mat4 u_model;\n\t#endif\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tv_pos = a_vertex;\n\t\tv_normal = a_normal;\n\t\t#pragma SKINNING_BODY\n\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\tv_coord = a_coord;\n\t\t#ifdef COLOR\n\t\tv_color = a_color;\n\t\t#endif\n\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\tgl_PointSize = 2.0;\n\t}";
f.master_fragment_shader="\tprecision highp float;\tvarying vec2 v_coord;\tvarying vec3 v_normal;\tuniform vec4 u_color;\n\t#ifdef COLOR\n\tvarying vec4 v_color;\n\t#endif\n\t#ifdef ALBEDO\n\t\tuniform sampler2D u_albedo_texture;\n\t#endif\n\t#ifdef TEXTURE\n\t\tuniform sampler2D u_color_texture;\n\t#endif\n\t#ifdef PHONG\n\t\tuniform vec3 u_ambient;\n\t\tuniform vec3 u_light_color;\n\t\tuniform vec3 u_light_vector;\n\t#endif\n\tuniform float u_global_alpha_clip;\n\tvoid main() {\n\t\tvec4 color = u_color;\n\t\t#ifdef ALBEDO\n\t\t\tcolor *= texture2D(u_albedo_texture, v_coord);\n\t\t#endif\n\t\t#ifdef TEXTURE\n\t\t\tcolor *= texture2D(u_color_texture, v_coord);\n\t\t#endif\n\t\t#ifdef COLOR\n\t\t\tcolor *= v_color;\n\t\t#endif\n\t\tif(color.w <= u_global_alpha_clip)\n\t\t\tdiscard;\n\t\tvec3 N = normalize(v_normal);\n\t\t#ifdef PHONG\n\t\t\tfloat NdotL = max(dot(N,u_light_vector),0.0);\n\t\t\tcolor.xyz *= u_ambient + NdotL * u_light_color;\n\t\t#endif\n\t\tgl_FragColor = color;\t}";
b.Renderer=f;Object.defineProperty(f.prototype,"color",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!0});f.prototype.setDataFolder=function(d){d?(this.assets_folder=d,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};f.prototype.clear=function(d){d?this.gl.clearColor(d[0],d[1],d[2],3<=d.length?d[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};f._sort_by_dist_func=function(d,b){return b._distance-
d._distance};f._sort_by_priority_func=function(d,b){return b.render_priority-d.render_priority};f._sort_by_priority_and_dist_func=function(d,b){var e=b.render_priority-d.render_priority;return 0!=e?e:b._distance-d._distance};f.prototype.destroy=function(){gl.destroy();b.Materials={}};f.prototype.render=function(d,e,a,f,m,c){null==f&&(f=65535);if(!d)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";e=e||
d.camera;if(!e)throw"Renderer.render: camera not provided";l.gl=this.gl;this._nodes.length=0;a||d._root.getVisibleChildren(this._nodes,f,this.layers_affect_children);a=a||this._nodes;this.enableCamera(e);this.enable2DView();this._state=[];this._meshes_missing=0;this._current_scene=d;this._uniforms.u_time=d.time;this.sort_by_distance&&a.forEach(function(d){d._distance=d.getDistanceTo(e._position)});var p=this;a=a.filter(function(d){return!d.mustRender||!1!=d.mustRender(p,e)});this.sort_by_distance&&
this.sort_by_priority?a.sort(b.Renderer._sort_by_priority_and_dist_func):this.sort_by_priority?a.sort(b.Renderer._sort_by_priority_func):this.sort_by_distance&&a.sort(b.Renderer._sort_by_dist_func);if(this.onPreRender)this.onPreRender(e);d._root.preRender&&d._root.preRender(this,e);if(m=m||this.pipeline)m.render(this,a,e,d,c);else{for(m=0;m<a.length;++m){c=a[m];c.updateGlobalMatrix(!0);if(this.onPreRenderNode)this.onPreRenderNode(c,e);c.preRender&&c.preRender(this,e)}for(m=0;m<a.length;++m)c=a[m],
c.flags.was_rendered=!1,!1!==c.flags.visible&&c.layers&f&&(!this.mustRenderNode||!1!==this.mustRenderNode(c,e))&&(c.flags.was_rendered=!0,this.setModelMatrix(c._global_matrix),c.render?c.render(this,e):this.renderNode(c,e));d._root.postRender&&d._root.postRender(this,e);for(m=0;m<a.length;++m)if(c=a[m],c.postRender&&c.postRender(this,e),this.onPostRenderNode)this.onPostRenderNode(c,e)}if(this.onPostRender)this.onPostRender(e);d.frame++;this.frame++;this._current_scene=null};f.prototype.enableCamera=
function(d){this._camera=d;d.updateMatrices();d.extractPlanes();this._view_matrix.set(d._view_matrix);this._projection_matrix.set(d._projection_matrix);this._viewprojection_matrix.set(d._viewprojection_matrix);this._uniforms.u_camera_position=d.position};f.prototype.enable2DView=function(){mat4.ortho(this._viewprojection2D_matrix,0,gl.viewport_data[2],0,gl.viewport_data[3],-1,1)};f.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};f.prototype.restoreState=function(){var d=
this.state.pop(),b=this.camera=d.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=d.nodes};f.prototype.setModelMatrix=function(d){this._model_matrix.set(d);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,d)};f.prototype.setGlobalUniforms=function(d){for(var b in d)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(d[b]):
this._uniforms[b]=d[b]};var E={u_model:null};f.prototype.renderNode=function(d,e){var a=null;d._mesh?a=d._mesh:d.mesh&&(a=gl.meshes[d.mesh],a||(this._meshes_missing++,this.autoload_assets&&-1!=d.mesh.indexOf(".")&&this.loadMesh(d.mesh)));if(d.primitives&&d.primitives.length){if(a)for(var f=0;f<d.primitives.length;++f){var m=d.primitives[f],c=this.overwrite_material||b.Materials[m.material];!c||this.onFilterByMaterial&&!1==this.onFilterByMaterial(c,b.Materials[m.material])||this.renderMeshWithMaterial(d._global_matrix,
a,c,"triangles",f,d.skeleton,d)}}else{if(a&&(d.material||this.overwrite_material)&&(c=this.overwrite_material||b.Materials[d.material])){if(c.render){this.renderMeshWithMaterial(d._global_matrix,a,c,d.indices,d.submesh,d.skeleton,d);return}d.color=c.color}if(a){m=!1;d._instances&&(1<gl.webgl_version||gl.extensions.ANGLE_instanced_arrays)&&(m=!0);var c=null,p=d.shader;this.on_getShader?c=this.on_getShader(d,e):(!c&&d.shader&&(c=gl.shaders[p]),this.shader_overwrite&&(c=gl.shaders[this.shader_overwrite]));
c||(c=0,d.textures.color&&(c|=g.MACROS.TEXTURE),d.textures.albedo&&(c|=g.MACROS.ALBEDO),a.vertexBuffers.colors&&(c|=g.MACROS.COLOR),d.skeleton&&(c|=g.MACROS.SKINNING),m&&(c|=g.MACROS.INSTANCING),"phong"==this.light_model&&(c|=g.MACROS.PHONG),c=this.getMasterShader(c));m&&!c.attributes.u_model&&(m=!1);var p=0,n=null;for(f in d.textures){var k=d.textures[f];if(k){k.constructor===Object&&(k=k.texture);var t="u_"+f+"_texture";if(!c||c.samplers[t])n=gl.textures[k],n||(this.autoload_assets&&-1!=k.indexOf(".")&&
this.loadTexture(k,this.default_texture_settings),n=gl.textures.white),d.flags.pixelated?(n.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST)):!1===d.flags.pixelated&&(n.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)),d._uniforms[t]=n.bind(p++)}}this.ignore_flags||this.enableItemFlags(d);if(d.onRender)d.onRender(this,
e,c);d.skeleton&&(d.bones=d.skeleton.computeFinalBoneMatrices(d.bones,a),c.setUniform("u_bones",d.bones));"phong"==this.light_model&&c.uniforms(this._phong_uniforms);for(f=0;f<this.global_uniforms_containers.length;++f)c.uniforms(this.global_uniforms_containers[f]);this.skip_node_uniforms||c.uniforms(d._uniforms);if(d.onShaderUniforms)d.onShaderUniforms(this,c);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,c,d);f=null;null!=d.submesh&&a.info&&a.info.groups&&a.info.groups[d.submesh]&&
(f=a.info.groups[d.submesh]);m?(E.u_model=d._instances,f?c.drawInstanced(a,null==d.primitive?gl.TRIANGLES:d.primitive,d.indices,E,f.start,f.length):d.draw_range?c.drawInstanced(a,null==d.primitive?gl.TRIANGLES:d.primitive,d.indices,E,d.draw_range[0],d.draw_range[1]):c.drawInstanced(a,null==d.primitive?gl.TRIANGLES:d.primitive,d.indices,E)):f?c.drawRange(a,null==d.primitive?gl.TRIANGLES:d.primitive,f.start,f.length,d.indices):d.draw_range?c.drawRange(a,null==d.primitive?gl.TRIANGLES:d.primitive,d.draw_range[0],
d.draw_range[1],d.indices):c.draw(a,null==d.primitive?gl.TRIANGLES:d.primitive,d.indices);this.ignore_flags||this.disableItemFlags(d);this.draw_calls+=1}else if(d.onRender)d.onRender(this,e)}};f.prototype.renderMesh=function(d,e,a,f,m,c,p,n){e&&(f&&this._uniforms.u_color.set(f),d||(d=b.IDENTITY),this._uniforms.u_model.set(d),m||(m=a?gl.shaders.texture:gl.shaders.flat),a&&(this._uniforms.u_texture=a.bind(0)),m.uniforms(this._uniforms),m.draw(e,null==c?gl.TRIANGLES:c,p),this.draw_calls+=1)};f.prototype.renderMeshWithMaterial=
function(d,b,e,a,f,m,c){e.render&&e.render(this,d,b,a,f,m,c)};f.prototype.renderBounding=function(d,e,a){if(d){e=e||b.IDENTITY;var f=this._uniforms.u_model,m=null,m=d.constructor===GL.Mesh?d._bounding:d;a=a||[1,1,0,1];d=m.subarray(3,6);mat4.translate(f,e,m.subarray(0,3));mat4.scale(f,f,[2*d[0],2*d[1],2*d[2]]);this.renderMesh(f,gl.meshes.cube,null,a,null,gl.LINES,"wireframe")}};f.prototype.enableItemFlags=function(d){var e=d.flags.flip_normals;this.reverse_normals&&(e=!e);gl.frontFace(e?gl.CW:gl.CCW);
gl[!1===d.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST);!1===d.flags.depth_write&&gl.depthMask(!1);gl[!0===d.flags.two_sided||this.disable_cull_face?"disable":"enable"](gl.CULL_FACE);if(d.blend_mode!==b.BLEND_NONE)switch(gl.enable(gl.BLEND),d.blend_mode){case b.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case b.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case b.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND);"BLEND"==d.alphaMode&&
(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};f.prototype.disableItemFlags=function(d){d.flags.flip_normals&&gl.frontFace(gl.CCW);!1===d.flags.depth_test&&gl.enable(gl.DEPTH_TEST);d.blend_mode!==b.BLEND_NONE&&gl.disable(gl.BLEND);d.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===d.flags.depth_write&&gl.depthMask(!0);"BLEND"==d.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};f.prototype.setPointSize=function(d){this.point_size=d;gl.shaders.point.uniforms({u_pointSize:this.point_size})};
b.Renderer.prototype.renderPoints=function(d,e,a,f,m,c,p,n,k){if(!d||d.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";m||(p==GL.LINES||p==GL.LINE_LOOP?m=this.shaders.flat:n?(m=this.shaders._points_textured,m||(m=this.shaders._points_textured=new GL.Shader(b.points_vs_shader,b.points_fs_shader,{TEXTURED:""}),m.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(m=this.shaders[e?"_points_color":"_points"],m||(m=e?this.shaders._points_color=new GL.Shader(b.points_vs_shader,
b.points_fs_shader,{COLORED:""}):this.shaders._points=new GL.Shader(b.points_vs_shader,b.points_fs_shader),m.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));c=c||1;var t=1024;f=f||d.length/3;var w=null,g=null,h=this._points_mesh;f>d.length/3&&(f=d.length/3);!h||d.length>3*t?(f>t&&(t=GL.Texture.nextPOT(f)),w=new Float32Array(3*t),g=new Float32Array(4*t),h=this._points_mesh=GL.Mesh.load({vertices:w,extra4:g})):(w=this._points_mesh.getBuffer("vertices").data,g=this._points_mesh.getBuffer("extra4").data);
w.set(w.length>d.length?d:d.subarray(0,w.length));e?g.set(g.length>e.length?e:e.subarray(0,g.length)):g.fill&&g.fill(0);h.upload(GL.DYNAMIC_STREAM);m.setUniform("u_color",this._color);m.setUniform("u_pointSize",c);m.setUniform("u_camera_perspective",a._projection_matrix[5]);m.setUniform("u_model",k||b.IDENTITY);m.setUniform("u_viewport",gl.viewport_data);m.setUniform("u_viewprojection",a._viewprojection_matrix);n&&m.setUniform("u_texture",n.bind(0));m.drawRange(h,null!=p?p:GL.POINTS,0,f);return h};
b.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
b.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvarying vec4 v_extra4;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef COLORED\n\t\tcolor *= v_extra4;\n\t#endif\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
f.prototype.renderLines=function(d,b,e){this.renderPoints(d,null,null,null,null,null,gl.LINES,null,e)};f.prototype.render3DLines=function(d,e,a,f){if(!d||d.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var m=this.shaders._lines;m||(m=this.shaders._lines=new GL.Shader(b.lines_vs_shader,this._flat_fragment_shader));var c=this._camera,p=1024,n=d.length/3,k=a?2*n:4*n,t=null,w=null,g=null,p=this._lines_mesh;!p||3*k>p.getBuffer("vertices").data.length?(p=GL.Texture.nextPOT(k),
t=new Float32Array(3*p),w=new Float32Array(3*p),g=new Float32Array(2*p),indices_data=new Uint16Array(3*p),p=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:t,normals:w,extra2:g})):(t=this._lines_mesh.getBuffer("vertices").data,w=this._lines_mesh.getBuffer("normals").data,g=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data);var k=vec2.fromValues(-1,-1),h=vec2.fromValues(1,-1),r=vec2.fromValues(-1,1),v=vec2.fromValues(1,1),l=vec3.create();
if(a)throw"strip lines not supported yet";for(var q=Math.floor(n/2),s=0;s<q;++s){var u=2*s,A=d.subarray(3*u,3*u+3),u=d.subarray(3*u+3,3*u+6);vec3.sub(l,u,A);t.set(A,12*s);t.set(A,12*s+3);t.set(u,12*s+6);t.set(u,12*s+9);w.set(l,12*s);w.set(l,12*s+3);w.set(l,12*s+6);w.set(l,12*s+9);g.set(k,8*s);g.set(h,8*s+2);g.set(r,8*s+4);g.set(v,8*s+6);indices_data.set([4*s+0,4*s+2,4*s+1,4*s+1,4*s+2,4*s+3],6*s)}p.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);m.setUniform("u_model",f||b.IDENTITY);m.setUniform("u_color",
this._color);m.setUniform("u_camera_front",c._front);m.setUniform("u_camera_position",c.eye);m.setUniform("u_lineWidth",0.5*e);m.setUniform("u_camera_perspective",c._projection_matrix[5]);m.setUniform("u_viewport",gl.viewport_data);m.setUniform("u_viewprojection",c._viewprojection_matrix);m.drawRange(p,gl.TRIANGLES,0,n*(a?6:3));return p};b.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
f.prototype.getAssetFullPath=function(d,b){if(-1==d.indexOf("://")&&!b&&this.assets_folder){if(this.onGetAssetsFolder)return this.onGetAssetFolder(d);var e="/"==this.assets_folder.substr(-1),a="/"==d[0];return e!=a?this.assets_folder+d:e&&a?this.assets_folder+d.substr(1):this.assets_folder+"/"+d}return d};f.prototype.loadMesh=function(d,b,e){if(!d)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[d]&&!this.assets_not_found[d]){var a=this.meshes[d];if(a)return b&&b(a),
a;var f=this;e=this.getAssetFullPath(d,e);e=GL.Mesh.fromURL(e,function(e){e?f.meshes[d]=e:(f.assets_not_found[d]=!0,delete f.meshes[d]);f.num_assets_loading--;delete f.assets_loading[d];b&&b(e,d)});this.assets_loading[d]=e;this.num_assets_loading++;return this.meshes[d]=e}};f.prototype.loadTexture=function(d,b,e,a){function f(b){p.debug&&console.log(" + texture loaded: "+d);b?p.textures[m]=b:p.assets_not_found[d]=!0;e&&e(b,m);p.num_assets_loading--;delete p.assets_loading[d];if(p.on_texture_load)p.on_texture_load(b,
m)}if(!d)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[d]&&!this.assets_not_found[d]){var m=d;b&&(b.name&&(m=b.name),b.preview&&(m=b.preview));var c=this.textures[m];if(c&&!c.is_preview)return e&&e(c),c;var p=this;a=this.getAssetFullPath(d,a);var n=null;-1!=d.indexOf("CUBEMAP")?n=GL.Texture.cubemapFromURL(a,this.default_cubemap_settings,f):this.credentials?(this.credentials.headers?this.credentials.headers["Content-Type"]="application/octet-stream":this.credentials.headers=
{"Content-Type":"application/octet-stream"},n=new GL.Texture(1,1,b),fetch(a,this.credentials).then(function(b){if(!b.ok)throw Error("HTTP "+b.status+":"+b.statusText);return b.arrayBuffer()}).then(function(d){var e=URL.createObjectURL(new Blob([d]));b.texture=n;n=GL.Texture.fromURL(e,b,f);b.texture=null;setTimeout(function(){URL.revokeObjectURL(e)},6E4)})):n=GL.Texture.fromURL(a,b,f);b&&b.preview&&(n.is_preview=!0);this.assets_loading[d]=n;this.num_assets_loading++;return this.textures[m]=n}};f.prototype.loadTextureAtlas=
function(b,e,a){"string"==typeof b&&(b=JSON.parse(b));var f=this;-1==e.indexOf("://")&&(e=this.assets_folder+e);GL.Texture.fromURL(e,null,function(e){var m=b.files;f.textures[":atlas"]=e;for(var c in m)if(!f.textures[c]||f.textures[c].is_preview){var p=m[c],n=new GL.Texture(b.size,b.size,{wrap:gl.REPEAT,filter:gl.LINEAR});n.drawTo(function(){e.gl.drawTexture(e,0,0,b.size,b.size,p.x,p.y,p.width||b.size,p.height||b.size)});n.is_preview=!0;f.textures[c]=n}a&&a(m)})};f.prototype.loadShaders=function(b,
e,a,f){var m=this;-1!=b.indexOf("://")||f||(b=this.assets_folder+b);b+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(b,function(b){m.compileShadersFromAtlas(b,a);m.loading_shaders=!1;e&&e(b)})};f.prototype.reloadShaders=function(b){};f.prototype.compileShadersFromAtlasCode=function(b,e){var a=GL.processFileAtlas(b);this.compileShadersFromAtlas(a,e)};f.prototype.compileShadersFromAtlas=function(b,e){var a=b.shaders;if(a){this.shader_files=b;for(var f in b)b[f]=GL.Shader.expandImports(b[f],
b);a=a.split("\n");for(f=0;f<a.length;++f){var m=a[f].trim().split(" "),c=m[0].trim();if("//"!=c.substr(0,2)){var p=b[m[1]],n=b[m[2]],k=null,t={};if(3<m.length)for(var w=3;w<m.length;++w)if("#"==m[w][0])t[m[w].substr(1)]=!0;else{k=m.slice(w).join(" ");break}if(!t.WEBGL1||1==gl.webgl_version)if(!t.WEBGL2||2==gl.webgl_version){m[1]&&"@"==m[1][0]&&(t=m[1].substr(1)+"_VERTEX_SHADER",GL.Shader[t]&&(p=GL.Shader[t]));m[2]&&"@"==m[2][0]&&(t=m[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[t]&&(n=GL.Shader[t]));
if(k)try{k=JSON.parse(k)}catch(g){console.error("Error in shader macros: ",c,k,g)}if(k&&e){var t={},h;for(h in k)t[h]=k[h];for(h in e)t[h]=e[h];k=t}else e&&(k=e);try{p&&n?this.shaders[c]?this.shaders[c].updateShader(p,n,k):this.shaders[c]=new GL.Shader(p,n,k):console.warn("Shader subfile not found: ",m[1],m[2])}catch(r){GL.Shader.dumpErrorToConsole(r,p,n)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};f.prototype.setShadersFromFile=function(b){b=GL.processFileAtlas(b);
this.compileShadersFromAtlas(b)};f.cubemap_info=[{front:[1,0,0],up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];f.prototype.renderToCubemap=function(d,e,a,m,c,p,n){var k=f.cubemap_camera;k||(f.cubemap_camera=k=new b.Camera);k.perspective(90,1,p||0.1,n||1E3);var t=vec3.create(),w=this;d.drawTo(function(b,d){var p=f.cubemap_info[d];vec3.add(t,a,p.front);k.lookAt(a,t,p.up);w.clear();w.render(e,
k,m,c)});return d};f.prototype.drawSphere3D=function(b,e,a){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var f=gl.shaders.flat;f.setUniform("u_color",a);f.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(v);mat4.translate(v,v,b);mat4.scale(v,v,[e,e,e]);f.setUniform("u_model",v);f.draw(gl.meshes.sphere);this.draw_calls+=1};f.prototype.drawCircle2D=function(b,e,a,f,m){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||
(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:0.02,slices:64}));var c=gl.shaders.flat;c.setUniform("u_color",f);c.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(v);mat4.translate(v,v,[b,e,0]);mat4.scale(v,v,[2*a,2*a,2*a]);c.setUniform("u_model",v);c.draw(gl.meshes[m?"circle":"ring"]);this.draw_calls+=1};f.prototype.drawLine2D=function(d,e,a,f,m,c,p){var n=gl.meshes.plane;p=p||gl.shaders.flat;p.setUniform("u_color",c);p.setUniform("u_viewprojection",this._viewprojection2D_matrix);
var k=a-d,t=f-e;c=Math.atan2(k,t);k=Math.sqrt(k*k+t*t);m/=2;mat4.identity(v);mat4.translate(v,v,[0.5*(d+a),0.5*(e+f),0]);mat4.rotate(v,v,c,b.FRONT);d=m;mat4.scale(v,v,[d,k,d]);p.setUniform("u_model",v);p.draw(n);this.draw_calls+=1};f.prototype.renderDebugSceneTree=function(b,e){for(var a=[],f=0;f<b._nodes.length;++f){var m=b._nodes[f];if(m._parent&&m._parent!=b.root){var c=m._parent.getGlobalPosition(),m=m.getGlobalPosition();a.push(c[0],c[1],c[2],m[0],m[1],m[2])}}a=new Float32Array(a);this.renderPoints(a,
null,e,null,null,null,GL.LINES);this.renderPoints(a,null,e,null,null,-10,GL.POINTS)};b.sortByDistance=function(b,e){b.forEach(function(b){b._distance=b.getDistanceTo(e)});b.sort(function(b,d){return d._distance-b._distance})};b.noBlending=function(d){return d.blend_mode===b.BLEND_NONE};b.generateTextureAtlas=function(b,e,a,f,m){e=e||1024;a=a||1024;f=f||64;var c=0,p;for(p in b)c++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var c=new GL.Texture(e,a),n={width:e,height:a,
size:f,files:{}},k=0,t=0,w={};c.drawTo(function(){for(var c in b)if(":"!=c[0]&&"white"!=c&&"black"!=c&&"notfound"!=c){var p=b[c];if(!p.is_preview&&p.texture_type==gl.TEXTURE_2D){if(m){var g=p.toBase64().hashCode();if(w[g]){n.files[c]=n.files[w[g]];continue}w[g]=c}n.files[c]={x:k,y:t};p.renderQuad(k,t,f,f);k+=f;if(k==e&&(k=0,t+=f,t==a)){console.warn("Atlas too small, some textures wont be stored.");break}}}});c.info=n;console.log(n);return c};f.prototype.computeResourcesLoaded=function(b){var e=0,
a;for(a in b){var f=b[a],m=this.textures[f];m&&!1===m.ready||(f=this.meshes[f])&&!1===f.ready||(m||f)&&e++}return e};Object.defineProperty(f.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(b){},enumerable:!0});Object.defineProperty(f.prototype,"textures",{get:function(){return this.gl.textures},set:function(b){},enumerable:!0});Object.defineProperty(f.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(b){},enumerable:!0});f.prototype.addMesh=function(b,
e){e.gl!=this.gl&&(e=e.cloneShared(this.gl));this.gl.meshes[b]=e};b.Renderer=f;b.Ray=k;k.prototype.testPlane=function(b,e){return geo.testRayPlane(this.origin,this.direction,b,e,this.collision_point)};k.prototype.testSphere=function(b,e,a){return geo.testRaySphere(this.origin,this.direction,b,e,this.collision_point,a)};k.prototype.closestPointOnRay=function(b,e,a){a=a||vec3.create();var f=vec3.create();vec3.add(f,this.origin,this.direction);var m=vec3.create();vec3.add(m,b,e);geo.closestPointBetweenLines(this.origin,
f,b,m,null,a);return a};b.Factory=function(d,e,a){d=b.Factory.templates[d];var f=new b.SceneNode;d&&f.configure(d);e&&(e.constructor===b.Scene?e.root:e).addChild(f);a&&f.configure(a);return f};b.Factory.templates={grid:{mesh:"grid",primitive:1,color:[0.5,0.5,0.5,0.5],blend_mode:b.BLEND_ALPHA},mesh:{shader:"phong"},sphere:{mesh:"sphere",shader:"phong"},floor:{mesh:"planeXZ",scaling:10,shader:"phong"}};c.prototype._ctor=function(){a.prototype._ctor.call(this);this.vertices=[];this.normals=[];this.coords=
[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};c.prototype.updateVertices=function(b){b&&(this.vertices=b);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);
this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};c.prototype.updateNormals=function(b){b&&(this.normals=b);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};c.prototype.updateCoords=function(b){b&&(this.coords=
b);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};c.prototype.updateIndices=function(b){b&&(this.indices=b);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=new Float32Array(2*this.indices.length),
this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=b.length};c.prototype.render=function(b,e){if(this._total){var a=b.shaders[this.shader||"flat"];if(a){b.setModelMatrix(this._global_matrix);var f=this._mesh,m=this._total_indices?this._total_indices:this._total/3;b.enableItemFlags(this);a.uniforms(b._uniforms).uniforms(this._uniforms).drawRange(f,
null==this.primitive?GL.TRIANGLES:this.primitive,0,m,this._total_indices?"triangles":null);b.disableItemFlags(this)}}};extendClass(c,a);b.DynamicMeshNode=c;r.prototype._ctor=function(){a.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=b.TOP_LEFT;this.blend_mode=b.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=
mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};Object.defineProperty(r.prototype,"angle",{get:function(){return this._angle},set:function(d){this._angle=d;quat.setAxisAngle(this._rotation,b.FRONT,this._angle*m);this._must_update_matrix=!0},enumerable:!0});r.prototype.setSize=function(b,e){this.size[0]=b;this.size[1]=e};r.createFrames=function(b,e,a){a=a||{};var f;b.constructor!=Number?(num_columns=b[0],f=b[1]):f=num_columns=b;var m=b=0,c=1/num_columns,p=1/f;f*=num_columns;if(!e){e=
[];for(var n=0;n<f;++n)e.push(String(n))}for(n=0;n<e.length&&!(a[e[n]]={pos:[b,m],size:[c,p],normalized:!0},b+=c,1<=b&&(b=0,m+=p),1<=m);++n);return a};r.prototype.createFrames=function(b,e){r.createFrames(b,e,this.frames)};r.prototype.addFrame=function(b,e,a,f,m,c){this.frames[b]={pos:vec2.fromValues(e,a),size:vec2.fromValues(f,m),normalized:!!c}};r.prototype.updateTextureMatrix=function(b){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var e=b.textures[this.texture];if(!e&&b.autoload_assets){var a=
this;-1!=this.texture.indexOf(".")&&b.loadTexture(this.texture,b.default_texture_settings,function(b){b&&0==a.size[0]&&0==a.size[0]&&a.setSize(b.width,b.height)});e=gl.textures.white}if(!e)return!1;b=this.texture_matrix;var f=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!f)return!1;if(!f)return this.flags.flipX&&(A[0]=this.flags.flipX?1:0,A[1]=0,mat3.translate(b,b,A),A[0]=this.flags.flipX?-1:1,A[1]=1,mat3.scale(b,b,A)),!0;if(f.normalized)A[0]=this.flags.flipX?f.pos[0]+f.size[0]:
f.pos[0],A[1]=1-f.pos[1]-f.size[1],mat3.translate(b,b,A),A[0]=f.size[0]*(this.flags.flipX?-1:1),A[1]=f.size[1];else{var m=e.height;A[0]=(this.flags.flipX?f.pos[0]+f.size[0]:f.pos[0])/e.width;A[1]=(m-f.pos[1]-f.size[1])/m;mat3.translate(b,b,A);A[0]=f.size[0]*(this.flags.flipX?-1:1)/e.width;A[1]=f.size[1]/e.height}mat3.scale(b,b,A);return!0};r.prototype.render=function(e,a){if(this.texture&&this.updateTextureMatrix(e)){var f=e.textures[this.texture];if(f){this.flags.pixelated&&(f.bind(0),gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.billboard_mode&&b.orientNodeToCamera(this.billboard_mode,this,a,e);0==this.size[0]&&!1!==f.ready&&(this.size[0]=f.width);0==this.size[1]&&!1!==f.ready&&(this.size[1]=f.height);var m=this.size,c=0,p=0;v.set(this._global_matrix);var n=!1;this.current_frame&&this.current_frame.size&&(m=this.current_frame.size,
n=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case b.TOP_LEFT:c=0.5;p=-0.5;break;case b.TOP_CENTER:p=-0.5;break;case b.TOP_RIGHT:c=-0.5;break;case b.BOTTOM_LEFT:p=c=0.5;break;case b.BOTTOM_CENTER:p=0.5;break;case b.BOTTOM_RIGHT:c=-0.5,p=0.5}mat4.translate(v,v,[c*f.width*m[0],p*f.height*m[1],0])}n?mat4.scale(v,v,[f.width*m[0],f.height*m[1],1]):mat4.scale(v,v,[this.size[0],this.size[1],1]);e.setModelMatrix(v);e.renderNode(this,e,a)}}};extendClass(r,a);b.Sprite=r;s.prototype._ctor=
function(){this.mesh="cube";this.shader="skybox";this.scaling=[10,10,10];this.flags.depth_test=!1;this.flags.two_sided=!0};s.prototype.render=function(b,e){this.position=e.position;this.updateGlobalMatrix(!0);b.setModelMatrix(this._global_matrix);b.renderNode(this,e)};extendClass(s,a);b.Skybox=s;b.parseTextConfig=function(b){function e(b,d){for(var f=a.shift();f;)if(0==f.trim().length)f=a.shift();else{for(var m=0;"\t"==f[m]&&m<f.length;)m++;if(m<d)break;var c={children:[]};try{var p=f.trim();-1!=
p.indexOf(":")&&(p="{"+p+"}");var n=new Function("return "+p);c.data=n()}catch(k){console.error(k)}m>=d&&(b&&b.children.push(c),f=e(c,m+1))}return f}var a=b.split("\n");b={data:"",children:[]};e(b,0);return b};f.prototype.createShaders=function(){gl._shaders_created&&(this._flat_shader=gl.shaders.flat,this._flat_instancing_shader=gl.shaders.flat_instancing,this._flat_skinning_shader=gl.shaders.flat_skinning,this._point_shader=gl.shaders.point,this._color_shader=gl.shaders.color,this._texture_shader=
gl.shaders.texture,this._texture_albedo_shader=gl.shaders.texture_albedo,this._texture_instancing_shader=gl.shaders.texture_instancing,this._texture_albedo_instancing_shader=gl.shaders.texture_albedo_instancing,b.Skeleton&&(this._texture_skinning_shader=gl.shaders.texture_skinning),this._texture_transform_shader=gl.shaders.texture_transform,this._phong_shader=gl.shaders.phong,this._phong_shader._uniforms=this._phong_uniforms,this._phong_shader.uniforms(this._phong_uniforms),this._phong_instancing_shader=
gl.shaders.phong_instancing,this._phong_instancing_shader._uniforms=this._phong_uniforms,this._phong_instancing_shader.uniforms(this._phong_uniforms),this._textured_phong_shader=gl.shaders.textured_phong,this._textured_phong_shader.uniforms(this._phong_uniforms),this._textured_phong_instancing_shader=gl.shaders.textured_phong_instancing,this._textured_phong_instancing_shader.uniforms(this._phong_uniforms),this._normal_shader=gl.shaders.normal,this._uvs_shader=gl.shaders.uvs);var e="",a="";b.Skeleton&&
(e="\n\t\t#ifdef SKINNING\n\t\t\t"+b.Skeleton.shader_code+"\n\t\t#endif\n\t\t",a="\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t");e=this._vertex_shader="\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tattribute vec3 a_normal;\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec3 v_pos;\n\t\t\t\tvarying vec3 v_normal;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\t#ifdef COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t\t#endif\n\t\t\t\t"+
e+"\n\t\t\t\t#ifdef INSTANCING\n\t\t\t\t\tattribute mat4 u_model;\n\t\t\t\t#else\n\t\t\t\t\tuniform mat4 u_model;\n\t\t\t\t#endif\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tvoid main() {\n\t\t\t\t\tv_pos = a_vertex;\n\t\t\t\t\tv_normal = a_normal;\n\t\t\t\t\t"+a+"\n\t\t\t\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t\t\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t\t#ifdef COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t\t#endif\n\t\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t\t\tgl_PointSize = 2.0;\n\t\t\t\t}\t\t\t\t";
a=this._flat_fragment_shader="\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\n\t\t\t\t#ifdef COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t\t#endif\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color = u_color;\n\t\t\t\t\t#ifdef COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t\t#endif\n\t\t\t\t  gl_FragColor = color;\n\t\t\t\t}\t";gl.shaders.flat=this._flat_shader=new GL.Shader(e,a);gl.shaders.flat_color=this._flat_instancing_shader=new GL.Shader(e,a,{COLOR:""});gl.shaders.flat_instancing=this._flat_instancing_shader=
new GL.Shader(e,a,{INSTANCING:""});gl.shaders.flat_color_instancing=this._flat_instancing_shader=new GL.Shader(e,a,{INSTANCING:"",COLOR:""});gl.shaders.flat_skinning=this._flat_skinning_shader=new GL.Shader(e,a,{SKINNING:""});gl.shaders.flat_color_skinning=this._flat_skinning_shader=new GL.Shader(e,a,{SKINNING:"",COLOR:""});this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t",
"\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=this._color_shader;a="\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\n\t\t#ifdef COLOR\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\t#ifdef COLOR\n\t\t\t\tcolor *= v_color;\n\t\t\t#endif\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\t\t}\t";
gl.shaders.texture=this._texture_shader=new GL.Shader(e,a);gl.shaders.texture_albedo=this._texture_albedo_shader=new GL.Shader(e,a,{ALBEDO:""});gl.shaders.texture_albedo_color=this._texture_albedo_color_shader=new GL.Shader(e,a,{ALBEDO:"",COLOR:""});gl.shaders.texture_albedo_skinning=this._texture_albedo_skinning_shader=new GL.Shader(e,a,{SKINNING:"",ALBEDO:""});gl.shaders.texture_albedo_color_skinning=this._texture_albedo_color_skinning_shader=new GL.Shader(e,a,{SKINNING:"",ALBEDO:"",COLOR:""});
gl.shaders.texture_instancing=this._texture_instancing_shader=new GL.Shader(e,a,{INSTANCING:""});gl.shaders.texture_albedo_instancing=this._texture_albedo_instancing_shader=new GL.Shader(e,a,{ALBEDO:"",INSTANCING:""});gl.shaders.texture_albedo_color_instancing=this._texture_albedo_instancing_shader=new GL.Shader(e,a,{ALBEDO:"",INSTANCING:"",COLOR:""});b.Skeleton&&(gl.shaders.texture_skinning=this._texture_skinning_shader=new GL.Shader(e,a,{SKINNING:""}));this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_mvp;\n\t\tuniform mat3 u_texture_matrix;\n\t\tvoid main() {\n\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform float u_global_alpha_clip;\n\t\tuniform sampler2D u_color_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\t");gl.shaders.texture_transform=this._texture_transform_shader;a=this._fragment_shader="\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec3 u_ambient;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_vector;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef TEXTURED\n\t\t\t\tuniform sampler2D u_color_texture;\n\t\t\t#endif\n\t\t\t#ifdef UNIFORMS\n\t\t\t\tUNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef TEXTURED\n\t\t\t\t\tcolor *= texture2D( u_color_texture, v_coord );\n\t\t\t\t#endif\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(u_light_vector,N));\n\t\t\t\t#ifdef EXTRA\n\t\t\t\t\tEXTRA\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color * (vec4(u_ambient,1.0) + NdotL * vec4(u_light_color,1.0));\n\t\t\t}\t";
gl.shaders.phong=this._phong_shader=new GL.Shader(e,a);this._phong_shader._uniforms=this._phong_uniforms;this._phong_shader.uniforms(this._phong_uniforms);gl.shaders.phong_instancing=this._phong_instancing_shader=new GL.Shader(e,a,{INSTANCING:""});this._phong_instancing_shader._uniforms=this._phong_uniforms;this._phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.textured_phong=this._textured_phong_shader=new GL.Shader(e,a,{TEXTURED:""});this._textured_phong_shader.uniforms(this._phong_uniforms);
gl.shaders.textured_phong_instancing=this._textured_phong_instancing_shader=new GL.Shader(e,a,{INSTANCING:"",TEXTURED:""});this._textured_phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.normal=this._normal_shader=new GL.Shader(e,"\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4( normalize(v_normal),1.0);\n\t\t\t}\t");gl.shaders.uvs=this._uvs_shader=new GL.Shader(e,"\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(v_coord,0.0,1.0);\n\t\t\t}\t");
gl._shaders_created=!0};b.orientNodeToCamera=function(e,a,f,m){if(e){if(e==b.BILLBOARD_CYLINDRIC||e==b.BILLBOARD_PARALLEL_CYLINDRIC){var c=null;e==b.BILLBOARD_CYLINDRIC?(c=a.getGlobalPosition(u),vec3.sub(y,f._position,c),A[0]=y[0],A[1]=y[2]):(A[0]=f._front[0],A[1]=f._front[2]);e=vec2.computeSignedAngle(A,b.FRONT2D);isNaN(e)||(mat4.rotateY(v,w,-e),a._global_matrix.set(v),mat4.setTranslation(a._global_matrix,a._position),mat4.scale(a._global_matrix,a._global_matrix,a._scale))}else e==b.BILLBOARD_PARALLEL_SPHERIC?
(a._global_matrix.set(f._model_matrix),mat4.setTranslation(a._global_matrix,a._position)):(mat4.lookAt(a._global_matrix,a._position,f.position,b.UP),mat4.invert(a._global_matrix,a._global_matrix)),mat4.scale(a._global_matrix,a._global_matrix,a._scale);m.setModelMatrix(a._global_matrix)}};b.readPixels=function(b,e){var a=new Image;a.src=b;a.onload=function(){var b=document.createElement("canvas");b.width=this.width;b.height=this.height;var a=b.getContext("2d");a.drawImage(this,0,0);b=a.getImageData(0,
0,b.width,b.height);e(b,this)}};b.alignDivToNode=function(b,e,a,f,m,c){function p(b){return 1E-5>Math.abs(b)?0:b}function n(b){return"matrix3d("+p(b[0])+","+p(-b[1])+","+p(b[2])+","+p(b[3])+","+p(b[4])+","+p(-b[5])+","+p(b[6])+","+p(b[7])+","+p(b[8])+","+p(-b[9])+","+p(b[10])+","+p(b[11])+","+p(b[12])+","+p(-b[13])+","+p(b[14])+","+p(b[15])+")"}var k=parseInt(b.clientWidth),t=parseInt(b.clientHeight),w=0.5*k,g=0.5*t,h=m._projection_matrix[5]*g;b.style.width=gl.canvas.width+"px";b.style.height=gl.canvas.height+
"px";b.style.perspective=h+"px";b.style.pointerEvents="none";e&&(b="translateZ("+h+"px) "+n(m._view_matrix)+" translate("+w+"px,"+g+"px)",e.style.transformStyle="preserve-3d",e.style.transform=b,e.style.width=k+"px",e.style.height=t+"px",e.style.pointerEvents="none");f=f.getGlobalMatrix();k=1/a.clientWidth;t=1/a.clientHeight;a.parentNode!=e&&e.appendChild(a);a.style.pointerEvents=c?"auto":"none";a.style.transform=function(b){return"translate(-50%,-50%) "+("matrix3d("+p(b[0])+","+p(b[1])+","+p(b[2])+
","+p(b[3])+","+p(-b[4])+","+p(-b[5])+","+p(-b[6])+","+p(-b[7])+","+p(b[8])+","+p(b[9])+","+p(b[10])+","+p(b[11])+","+p(b[12])+","+p(b[13])+","+p(b[14])+","+p(b[15])+")")}(f)+" scale3D("+k+","+t+",1)"};"undefined"==typeof GL&&(mat4.rotateVec3=function(b,e,a){var f=a[0],m=a[1];a=a[2];b[0]=e[0]*f+e[4]*m+e[8]*a;b[1]=e[1]*f+e[5]*m+e[9]*a;b[2]=e[2]*f+e[6]*m+e[10]*a;return b},mat4.projectVec3=function(b,e,a){var f=a[0],m=a[1];a=a[2];var c=e[1]*f+e[5]*m+e[9]*a+e[13],p=e[2]*f+e[6]*m+e[10]*a+e[14],n=e[3]*
f+e[7]*m+e[11]*a+e[15];b[0]=((e[0]*f+e[4]*m+e[8]*a+e[12])/n+1)/2;b[1]=(c/n+1)/2;b[2]=(p/n+1)/2;return b})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(l){function a(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);
this._meshes={};this._last_point_id=this._accumulated_time=0}function h(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.velocity_variation=
this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function q(){this._ctor()}function g(a){this._ctor();a&&this.configure(a)}extendClass(a,
RD.SceneNode);RD.PointCloud=a;a.prototype.render=function(f,k){if(0!=this.points.length){this.updateVertices();var c=this._meshes[f.gl.context_id];c||(c=new GL.Mesh(void 0,void 0,f.gl),this._vertices_buffer=c.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=c.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=c;this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);c=gl.shaders[this.shader];
c||(c=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(a._vertex_shader,a._pixel_shader));this.draw_range[1]=this.points.length;c=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/c[2]);this._uniforms.u_color=this.color;0<this.num_textures?(this._uniforms.u_texture_info[0]=1/this.num_textures,this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures):this._uniforms.u_texture_info[0]=0;this.ignore_transform&&(mat4.identity(f._model_matrix),f._mvp_matrix.set(f._viewprojection_matrix));
f.renderNode(this,f,k)}};a.prototype.updateVertices=function(a){if(a=this.points.length)for(var k=this._vertices,c=this._extra,g=0,h=this.num_textures*this.num_textures,e=0;e<a;e++){var n=this.points[e];k.set(n.pos?n.pos:n,g);c[g]=1;c[g+1]=1;1<h&&(c[g+2]=n.tex);g+=3}};a._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
a._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(h,RD.SceneNode);RD.ParticlesEmissor=h;h.prototype.update=function(a){var k=this.particles.length,c=this.particles_damping,g=this.particles_acceleration,h=vec3.length(g);if(k){for(var e=[],n=0;n<k;n++){var b=this.particles[n];vec3.scaleAndAdd(b.pos,b.pos,b.vel,a);h&&vec3.scaleAndAdd(b.vel,b.vel,g,a);c&&vec3.scaleAndAdd(b.vel,b.vel,b.vel,-a*c);b.ttl-=a;0<b.ttl&&e.push(b)}this.particles=e}k=this.getGlobalPosition();c=this.emissor_direction;g=this.particles_life;h=this.num_textures*this.num_textures;
e=this.velocity_variation;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),n=0;n<a&&!(this.particles.length>=this.max_particles);n++)c=vec3.clone(c),c[0]+=0.5*Math.random()*e,c[2]+=0.5*Math.random()*e,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*h)/h,pos:vec3.clone(k),vel:c,ttl:g})};h.prototype.render=function(a,k){if(0!=this.particles.length){this.updateVertices();
var c=this._meshes[a.gl.context_id];c||(c=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=c.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=c.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=c;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);c=gl.shaders[this.shader];c||(c=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(h._vertex_shader,h._pixel_shader));
this.draw_range[1]=this.particles.length;c=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/c[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,
k)}};h.prototype.updateVertices=function(a){if(a=this.particles.length)for(var k=this._vertices,c=this._extra,g=0,h=this.particles_life,e=this.num_textures*this.num_textures,n=0;n<a;n++){var b=this.particles[n];k.set(b.pos,g);c[g]=1;c[g+1]=b.ttl/h;1<e&&(c[g+2]=b.tex);g+=3}};h._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
h._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(q,RD.SceneNode);RD.Billboard=q;q.SPHERIC=1;q.PARALLEL_SPHERIC=2;q.CYLINDRIC=3;q.PARALLEL_CYLINDRIC=4;q.prototype._ctor=function(){this.billboard_mode=q.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};q.prototype.render=function(a,k){!1!==this.flags.visible&&(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,k,a),a.renderNode(this,a,k))};g.prototype._ctor=function(){RD.SceneNode.prototype._ctor.call(this);this.size=1;this._atlas_size=vec2.fromValues(1,
1);this.max_sprites=1024;this.positions=new Float32Array(3*this.max_sprites);this.sprite_info=new Float32Array(4*this.max_sprites);this.index=0;this.shader=null;this.use_points=!1;this.mode=g.CYLINDRICAL;this.must_update_buffers=!0};RD.SpritesBatch=g;g.XY=0;g.XZ=1;g.CYLINDRICAL=2;g.SPHERICAL=3;g.FLAT=4;Object.defineProperty(g.prototype,"atlas_size",{get:function(){return this._atlas_size},set:function(a){this._atlas_size.set(a)}});g.prototype.clear=function(){this.index=0};g.prototype.add=function(a,
k,c,g,h){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var e=this.index;this.index+=1;this.positions.set(a,3*e);2==a.length&&(this.positions[3*e+2]=0);a=4*e;this.sprite_info[a]=k||0;this.sprite_info[a+1]=c?1:0;this.sprite_info[a+2]=null==g?1:g;this.sprite_info[a+3]=h||0;this.must_update_buffers=!0}};g.prototype.addData=function(a,k){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var c=this.index;this.index+=
1;this.positions.set(a,3*c);this.sprite_info.set(k,4*c);this.must_update_buffers=!0}};g.prototype.render=function(a,k){if(this.texture){var c=a.textures[this.texture];c&&this.flags.pixelated&&(c.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.renderSprites(c,k,this.size,this.atlas_size,this.color,this.mode)}};g.prototype.renderSprites=
function(a,k,c,h,l,e){if(this.index){var n=gl.shaders[this.shader];n||(n=gl.shaders[this.use_points?"point_sprites":"quad_sprites"]);n||(n=this.use_points?gl.shaders.point_sprites=new GL.Shader(g.point_sprites_vertex_shader,g.point_sprites_fragment_shader):gl.shaders.quad_sprites=new GL.Shader(g.quad_sprites_vertex_shader,g.quad_sprites_fragment_shader));e=e||0;if(this.use_points)n.uniforms(GFX.scene_renderer._uniforms),n.setUniform("u_pointSize",c),n.setUniform("u_atlas",h),n.setUniform("u_texture",
a.bind(0)),RD.renderPoints(this.positions,this.sprite_info,k,this.index,n);else{if(!this.vertex_buffer_data){this.vertex_buffer_data=new Float32Array(12*this.max_sprites);this.extra4_buffer_data=new Float32Array(16*this.max_sprites);for(var b=new Int8Array(8*this.max_sprites),m=new Int8Array([-1,1,1,1,-1,-1,1,-1]),p=0;p<b.length;p+=8)b.set(m,p);for(var m=new Int16Array([0,2,1,1,2,3]),w=new Uint16Array(6*this.max_sprites),p=0;p<w.length;++p)w[p]=m[p%6]+4*Math.floor(p/6);this.vertex_buffer=new GL.Buffer(gl.ARRAY_BUFFER,
this.vertex_buffer_data,3,gl.DYNAMIC_DRAW);this.extra4_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this.extra4_buffer_data,4,gl.DYNAMIC_DRAW);this.extra2_buffer=new GL.Buffer(gl.ARRAY_BUFFER,b,2,gl.STATIC_DRAW);this.indices_buffer=new GL.Buffer(gl.ELEMENT_ARRAY_BUFFER,w,1,gl.STATIC_DRAW)}if(this.must_update_buffers){b=this.vertex_buffer_data;m=this.extra4_buffer_data;w=Math.min(this.index,this.positions.length/3);for(p=0;p<w;++p){var t=3*p,v=this.positions.subarray(t,t+3);b.set(v,4*t);b.set(v,4*t+3);b.set(v,
4*t+6);b.set(v,4*t+9);t=4*p;v=this.sprite_info.subarray(t,t+4);m.set(v,4*t);m.set(v,4*t+4);m.set(v,4*t+8);m.set(v,4*t+12)}this.vertex_buffer.uploadRange(0,48*this.index);this.extra4_buffer.uploadRange(0,64*this.index);this.must_update_buffers=!1}p=a.width/h[0]/(a.height/h[1]);b=RD.UP;m=RD.RIGHT;switch(e){case RD.SpritesBatch.SPHERICAL:b=k.getLocalVector(RD.UP);case RD.SpritesBatch.CYLINDRICAL:m=k.getLocalVector(RD.RIGHT);break;case RD.SpritesBatch.FLAT:b=k.getLocalVector(RD.FRONT);m=k.getLocalVector(RD.RIGHT);
break;case RD.SpritesBatch.XZ:b=RD.FRONT}n.bind();n.setUniform("u_model",RD.IDENTITY);n.setUniform("u_viewprojection",k._viewprojection_matrix);n.setUniform("u_color",l||RD.ONES4);n.setUniform("u_size",[c,c/p]);n.setUniform("u_top",b);n.setUniform("u_right",m);n.setUniform("u_atlas",h);n.setUniform("u_texture",a.bind(0));n.setUniform("u_itexsize",[1/a.width,1/a.height]);n.setUniform("u_viewport",gl.viewport_data);a=n.attributes.a_vertex;k=n.attributes.a_extra4;n=n.attributes.a_extra2;this.vertex_buffer.bind(a);
this.extra4_buffer.bind(k);this.extra2_buffer.bind(n);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer.buffer);gl.drawElements(gl.TRIANGLES,6*this.index,gl.UNSIGNED_SHORT,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.vertex_buffer.unbind(a);this.extra4_buffer.unbind(k);this.extra2_buffer.unbind(n)}}};extendClass(g,RD.SceneNode);g.quad_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4; //frame,flipx,scale,extranum\nattribute vec2 a_extra2;//expanse direction\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec2 u_size;\nuniform vec3 u_top;\nuniform vec3 u_right;\nuniform vec4 u_color;\nuniform vec2 u_atlas;\nuniform vec2 u_itexsize;\n\nvoid main() {\n\tvec3 vertex = a_vertex + a_extra4.z * u_size.y * u_top * a_extra2.y + a_extra4.z * u_size.x * u_right * a_extra2.x;\n\tvec2 uv = a_extra2;\n\tif( a_extra4.y != 0.0) //flip X\n\t\tuv.x *= -1.0;\n\tuv.x *= 1.0 - u_itexsize.x;\n\tuv.y *= -1.0;\n\tuv = uv * 0.5 + vec2(0.5);\n\t\n\tvec2 i_atlas = vec2(1.0) / u_atlas; \n\tfloat frame = a_extra4.x;\n\tfloat frame_x = mod( frame, u_atlas.x );\n\tfloat frame_y = floor( frame * i_atlas.x );\n\tuv.x = (uv.x + frame_x) * i_atlas.x;\n\tuv.y += frame_y;\n\tuv.y = 1.0 - uv.y * i_atlas.y;\n\tv_uv = uv;\n\tv_pos = (u_model * vec4(vertex,1.0)).xyz;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\t//gl_Position.x = floor(gl_Position.x * u_viewport.z * 1.0) / (u_viewport.z * 1.0);\n\t//gl_Position.y = floor(gl_Position.y * u_viewport.w * 1.0) / (u_viewport.w * 1.0);\n}\n\n";
g.quad_sprites_fragment_shader="\nprecision highp float;\nprecision mediump int;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n\tvec4 color = texture2D( u_texture, v_uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tcolor *= u_color;\n\tgl_FragColor = color;\n}\n";g.point_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_mvp;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tvec3 vertex = a_vertex;\t\n\tv_pos = vertex;\n\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_mvp * vec4(vertex,1.0);\n\tgl_Position.x = floor(gl_Position.x * u_viewport.z) / u_viewport.z;\n\tgl_Position.y = floor(gl_Position.y * u_viewport.w) / u_viewport.w;\n\tgl_PointSize = computePointSize( u_pointSize * u_extra4.z, gl_Position.w );\n}\n";
g.point_sprites_fragment_shader="\nprecision highp float;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4; //id,flip,scale,extra\nuniform float u_atlas;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\tfloat i_atlas = 1.0 / u_atlas;\n\tfloat frame = v_extra4.x;\n\tfloat x = frame * i_atlas;\n\tfloat y = floor(x);\n\tx = (x - y);\n\ty = y / u_atlas;\n\tif( v_extra4.y > 0.0 ) //must flip in x\n\t\tx -= gl_PointCoord.x * i_atlas - i_atlas;\n\telse\n\t\tx += gl_PointCoord.x * i_atlas;\n\t\n\tvec2 uv = vec2( x, 1.0 - (y + gl_PointCoord.y / u_atlas) );\n\tvec4 color = texture2D( u_texture, uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tgl_FragColor = color;\n}\n"})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
(function(l){function a(b){this._ctor();b&&this.configure(b);this.render_priority=0;this.targets=null;this.size=150;this.mode=a.DEFAULT;this.coordinates=a.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();this.onDuplicateTargets=this.onActionFinished=null;b={x:a.XAXIS_COLOR,y:a.YAXIS_COLOR,z:a.ZAXIS_COLOR};var e="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");this.actions=
{};for(var f in e){var c=e[f],n={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:0.15,visible:!1,flag:a[c.toUpperCase()]};0==c.indexOf("move")&&(n.move=!0);0==c.indexOf("rotate")&&(n.rotate=!0);0==c.indexOf("scale")&&(n.scale=!0);n.color=b[c[c.length-1]];if(n.move||n.rotate)n.cursor="crosshair";this.actions[c]=n}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=vec3.fromValues(0,
1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=0.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
0.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1}a.MOVEX=1;a.MOVEY=2;a.MOVEZ=4;a.MOVEXY=8;a.MOVEXZ=16;a.MOVEYZ=32;a.ROTATEX=64;a.ROTATEY=128;a.ROTATEZ=256;a.SCALEX=512;a.SCALEY=1024;a.SCALEZ=2048;a.SCALEXY=4096;a.SCALEYZ=8192;a.SCALEXZ=
16384;a.SCALE=32768;a.DRAG=65536;a.ROTATE=131072;a.ROTATEFRONT=262144;a.RESIZE=524288;a.MOVEAXIS=a.MOVEX|a.MOVEY|a.MOVEZ;a.MOVEPLANAR=a.MOVEXY|a.MOVEXZ|a.MOVEYZ;a.MOVEALL=a.DRAG|a.MOVEAXIS|a.MOVEPLANAR;a.PLANAR=a.MOVEX|a.MOVEZ|a.MOVEXZ|a.ROTATEY|a.SCALE;a.ROTATEALL=a.ROTATEX|a.ROTATEY|a.ROTATEZ|a.ROTATEFRONT;a.SCALEALL=a.SCALE|a.SCALEX|a.SCALEY|a.SCALEZ|a.SCALEXY|a.SCALEYZ|a.SCALEXZ;a.MOVEROTATESCALE=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALE;a.ALL=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALEALL;
a.DEFAULT=a.PLANAR;a.OBJECT_SPACE=1;a.WORLD_SPACE=2;l=mat4.create();var h=mat4.create(),q=mat4.create();mat4.create();mat4.create();mat4.create();var g=mat4.create(),f=mat4.create();mat4.create();var k=vec3.create(),c=vec3.create(),r=vec3.create(),s=vec4.create();vec4.create();mat4.translate(l,l,[1.1,0,0]);mat4.rotate(l,l,90*DEG2RAD,[0,0,-1]);mat4.translate(h,h,[0,1.1,0]);mat4.translate(q,q,[0,0,1.1]);mat4.rotate(q,q,90*DEG2RAD,[1,0,0]);l=mat4.create();mat4.scale(l,l,[-1,-1,-1]);a.full_viewport=null;
var e=mat4.create(),n=mat4.create();a.XAXIS_COLOR=[0.901,0.247,0.349,1];a.YAXIS_COLOR=[0.55,0.81,0.11,1];a.ZAXIS_COLOR=[0.23,0.57,0.93,1];a.XYAXIS_COLOR=[0.9,0.7,0.23,0.75];a.XZAXIS_COLOR=[0.6,0.4,0.7,0.75];a.YZAXIS_COLOR=[0.39,0.69,0.52,0.75];a.SPHERE_COLOR=[0.8,0.8,0.8,0.4];a.RING_COLOR=[0.5,0.5,0.5,1];a.INNERSPHERE_COLOR=[0.6,0.6,0.6,1];a.SELECTED_COLOR=[1,1,1,1];a.NOAXIS_COLOR=[0.901,0.247,0.749,1];a.STATIC_SPHERE_COLOR=[0.1,0.1,0.1,0.3];a.prototype.isTarget=function(b){return-1!=this.targets.indexOf(b)};
a.prototype.setTargets=function(b,e){if(b&&b.constructor!==Array)throw"nodes must be an Array";b&&0!=b.length?(e&&this.targets&&(b=this.targets.concat(b)),this.targets=b=b.filter(function(e,a){return b.indexOf(e)===a}),this.resetTransform(),this.position=this.computeCenter(this.targets)):e||(this.targets=null)};a.prototype.computeCenter=function(b){if((b=b||this.targets)&&b.length){for(var e=null,a=0;a<b.length;++a){var f=b[a];f.layers&this.layers&&(f=f.getGlobalPosition(),e?vec3.add(e,e,f):e=f)}if(!e)return[0,
0,0];vec3.scale(e,e,1/b.length);return e}};a.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?(this.transform=this.targets[0].transform,this.scaling=[1,1,1]):this.position=this.computeCenter(this.targets)))};a.prototype.updateTargets=function(){if(this.targets)for(var b=this.getGlobalMatrix(mat4.create()),e=0;e<this.targets.length;++e){var a=this.targets[e];
a.layers&this.layers&&a.fromMatrix(b,!0)}};a.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var b=0;b<this.targets.length;++b){var e=this.targets[b];e.layers&this.layers&&(this.target_tranforms[b]=new Float32Array(e.transform))}}};a.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var b=0;b<this.targets.length;++b){var e=this.targets[b];e.layers&this.layers&&(e.transform=
this.target_tranforms[b])}};a.prototype.removeTargetsFromScene=function(){if(this.targets){for(var b=0;b<this.targets.length;++b){var e=this.targets[b];e.layers&this.layers&&e.parentNode&&e.parentNode.removeChild(e)}this.targets=null}};a.prototype.getTargetBaseNodes=function(){function b(e){return-1!=a.indexOf(e)?!0:e.parentNode?b(e.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var e=[],a=this.targets,f=0;f<a.length;++f){var c=a[f];c.layers&this.layers&&(c.parentNode&&b(c.parentNode)||
e.push(c))}return e};a.prototype.applyTransformToTarget=function(b,e){var f=this.getGlobalMatrix(mat4.create()),c=mat4.invert(mat4.create(),f),n=mat4.create(),k=this.getTargetBaseNodes();if(k){for(var g=[1,1,1],h=0;h<k.length;++h){var r=k[h];g[0]=0<=r.scaling[0]?1:-1;g[1]=0<=r.scaling[1]?1:-1;g[2]=0<=r.scaling[2]?1:-1;e?(mat4.multiply(n,b,r.matrix),r.fromMatrix(n)):(r.getGlobalMatrix(n),this.coordinates==a.WORLD_SPACE&&mat4.multiply(n,c,n),mat4.multiply(n,b,n),this.coordinates==a.WORLD_SPACE&&mat4.multiply(n,
f,n),r.fromMatrix(n,!0));vec3.mul(r._scale,r._scale,g);r.position=this.applySnap(r.position);if(this.grid_size){var l=quat.toEuler(vec3.create(),r.rotation);l[0]=15*Math.round(l[0]*RAD2DEG/15)*DEG2RAD;l[1]=15*Math.round(l[1]*RAD2DEG/15)*DEG2RAD;l[2]=15*Math.round(l[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(r.rotation,l);quat.normalize(r.rotation,r.rotation)}}mat4.multiply(n,f,b);this.fromMatrix(n);this.scaling=[1,1,1];this.updateGizmo()}};a.prototype.applyTranslation=function(b,e){var a=mat4.create();
mat4.translate(a,a,b);this.applyTransformToTarget(a,e)};a.prototype.applyRotation=function(b,e,a){var f=mat4.create();if(a){var c=mat4.create();mat4.setTranslation(c,a);mat4.mul(f,f,c);mat4.rotate(f,f,b,e);mat4.setTranslation(c,[-a[0],-a[1],-a[2]]);mat4.mul(f,f,c)}else mat4.rotate(f,f,b,e);this.applyTransformToTarget(f)};a.prototype.applyScale=function(b,e){b.constructor===Number&&(b=[b,b,b]);var a=mat4.create();mat4.scale(a,a,b);this.applyTransformToTarget(a,e)};a.prototype.applySnap=function(b){if(!this.grid_size)return b;
b[0]=Math.round(b[0]/this.grid_size)*this.grid_size;b[1]=Math.round(b[1]/this.grid_size)*this.grid_size;b[2]=Math.round(b[2]/this.grid_size)*this.grid_size;return b};a.prototype.setColor=function(b){if(this.targets)for(var e=0;e<this.targets.length;++e){var a=this.targets[e];a.layers&this.layers&&(a.color=b)}};a.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var b=[],e=0;e<this.targets.length;++e){var a=this.targets[e];
if(a.layers&this.layers){var f=a.clone(!0);a.parentNode.addChild(f);b.push(a)}}return this.targets=b}};a.prototype.onMouse=function(b){if(this._camera&&this.targets&&!1!==this.visible){var e=this._camera,f=e.getFront(),c=[b.canvasx,b.canvasy],n=e.getRay(c[0],c[1]),k=this.position,g=vec3.sub(vec3.create(),k,e.position);vec3.normalize(g,g);var h=this._selected_action,r=this.actions[h],l=this._global_matrix;e.project(k,null,this.center_2D);var s=mat4.invert(mat4.create(),l),q=this.coordinates==a.OBJECT_SPACE;
if("mousedown"==b.type){if(this.click_2D[0]=this.click_2D2[0]=c[0],this.click_2D[1]=this.click_2D2[0]=c[1],b.is_touch&&this.testMouseOver(b),h=this._selected_action=this._hover_action,r=this.actions[h])r.move&&r.axis?(s=vec3.clone(r.axis),mat4.rotateVec3(s,l,s),vec3.normalize(s,s),this._last=n.closestPointOnRay(k,s),b.shiftKey&&this.cloneTargets()):r.move&&r.normal&&(n.testPlane(k,r.normal)&&(this.click_pos=n.collision_point),b.shiftKey&&this.cloneTargets()),"drag"==h&&(n.testPlane(k,f),this._last=
n.collision_point,b.shiftKey&&this.cloneTargets()),"rotatefront"==h?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,0.5*this.size),this.click_2D2.set(this.click_2D)):r.rotate&&(r.axis?(h=mat4.rotateVec3(vec3.create(),l,r.axis),n.testPlane(k,h)&&(vec3.sub(this.click_pos,n.collision_point,k),vec3.normalize(this.click_pos,this.click_pos),k=vec3.scaleAndAdd(vec3.create(),
k,this.click_pos,this.current_size),this.current_2D=this.click_2D=e.project(k))):n.testSphere(k,this.current_size)&&(this._last=n.collision_point,vec3.sub(this.click_pos,n.collision_point,k),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),g,this.click_pos))),this.click_model.set(l),this.click_transform.set(this.transform),this.click_dist=vec3.distance(this.click_2D,this.center_2D),this.saveTargetTransforms()}else if("mousemove"==b.type)if(b.dragging&&
this._selected_action){if("rotatefront"==h)return k=vec2.sub(vec3.create(),c,this.center_2D),vec2.normalize(k,k),r=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,k,0.5*this.size),k=Math.atan2(k[0],k[1]),r=Math.atan2(r[0],r[1]),k-=r,b.shiftKey&&(k=2*Math.PI*Math.ceil(36*k/(2*Math.PI))/36),k&&(this.restoreTargetTransforms(),this.applyRotation(k,g)),!0;if(r.rotate)return r.axis?(h=mat4.rotateVec3(vec3.create(),l,r.axis),n.testPlane(k,h)&&(b=vec3.sub(vec3.create(),n.collision_point,
k),vec3.normalize(b,b),k=vec3.scaleAndAdd(vec3.create(),k,b,this.current_size),this.current_2D=e.project(k),e=Math.clamp(vec3.dot(b,this.click_pos),-1,1),k=Math.acos(e),b=vec3.cross(vec3.create(),b,this.click_pos),vec3.normalize(b,b),e=vec3.dot(h,b),0<e&&(k*=-1),this.restoreTargetTransforms(),this.applyRotation(k,r.axis))):(s=vec3.cross(vec3.create(),g,this.click_pos),k=0.01*(vec2.dist(this.center_2D,c)-this.click_dist),b=vec2.sub(vec2.create(),this.center_2D,c),r=vec2.sub(vec2.create(),this.center_2D,
this.click_2D),0>vec2.dot(b,r)&&(k=-k),console.log(k),this.restoreTargetTransforms(),this.applyRotation(k,s),this.click_axis=s),!0;g=null;if(r.move&&r.normal){if(n.testPlane(k,r.normal)&&(r=n.collision_point,this.applySnap(r),g=vec3.sub(vec3.create(),r,this.click_pos),this.click_pos=r,this.coordinates==a.OBJECT_SPACE))return mat4.rotateVec3(g,s,g),this.applyTranslation(g,!0),!0}else if(r.move||r.scale){e=null;r.axis&&(s=vec3.clone(r.axis),mat4.rotateVec3(s,l,s),vec3.normalize(s,s),e=n.closestPointOnRay(k,
s));if("scale"==h||r.scale&&b.ctrlKey)return b=1+0.01*(c[1]-this.click_2D[1]),this.applyScale(b,q),this.click_2D[0]=c[0],this.click_2D[1]=c[1],!0;if("scalexy"==h||"scalexz"==h||"scaleyz"==h){b=1+0.01*(c[1]-this.click_2D[1]);switch(h){case "scalexy":this.applyScale([b,b,1],q);break;case "scaleyz":this.applyScale([1,b,b],q);break;case "scalexz":this.applyScale([b,1,b],q)}this.click_2D[0]=c[0];this.click_2D[1]=c[1];return!0}if(r.scale)return b=vec2.distance(c,this.center_2D),r=b/this.click_dist,"scalex"==
h?this.applyScale([r,1,1],q):"scaley"==h?this.applyScale([1,r,1],q):"scalez"==h&&this.applyScale([1,1,r],q),this.click_dist=b,!0;r.move&&(q||this.applySnap(e),g=vec3.sub(vec3.create(),e,this._last),this._last.set(e))}"drag"==h&&(n.testPlane(k,this._camera.getFront()),e=n.collision_point,this.applySnap(e),g=vec3.sub(vec3.create(),e,this._last),this._last=e);if(g)return this.applyTranslation(g),!0}else this.testMouseOver(b);else if("wheel"==b.type){if("scale"==this._selected_action)return b=1+2E-4*
b.wheel,this.applyScale(b),!0;if("drag"==this._selected_action)return g=vec3.sub(vec3.create(),k,e.position),b=1+2E-4*b.wheel,vec3.scaleAndAdd(g,e.position,g,b),vec3.sub(g,g,k),this.applyTranslation(g),this._last=k,!0}if("mouseup"==b.type||this._selected_action&&0==b.buttons)if(this.saveTargetTransforms(),this._selected_action){this._selected_action=null;this.render(this._last_renderer,this._last_camera);this.testMouseOver(b);this.updateGizmo();if(this.onActionFinished)this.onActionFinished();return!0}return!1}};
a.prototype.testMouseOver=function(b){this._hover_action=null;var e=[b.canvasx,b.canvasy],f=1E5;b=null;for(var c in this.actions){var n=this.actions[c];if(n.visible){var k=vec2.distance(n.pos2D,e);k<n.radius*this.size&&k<f&&(f=k,b=c)}}b||(c=vec2.distance(this.center_2D,e),this.actions.rotatefront.visible&&10>Math.abs(c-0.5*this.size)?b="rotatefront":this.mode&a.ROTATE&&c<0.5*this.size&&(b="rotate"));return this._hover_action=b};a.prototype.cancel=function(){this._selected_action&&(this._selected_action=
null,this.restoreTargetTransforms())};a.prototype.render=function(b,m){this._last_renderer=b;this._last_camera=m;for(var n in this.actions)this.actions[n].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.cube=GL.Mesh.cube({size:1}),gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:0.1,height:0.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:0.02,outerslices:64,
innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:0.5*Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}));n=gl.meshes.torus;var h=m.getFront(),t=m.getLocalVector(RD.UP);m.getLocalVector(RD.RIGHT);var l=this._position;s.set(l);s[3]=1;var q=m._projection_matrix[5];this.updateMatrices();g.set(this._global_matrix);var y=vec3.sub(vec3.create(),l,m.position);vec3.normalize(y,
y);this._camera=m;this._unitary_model=g;var u=this._hover_action,x=this._selected_action;x&&(u=x);var B=x?this.actions[x]:null,z=this.mode;mat4.rotateVec3(c,g,RD.RIGHT);mat4.rotateVec3(r,g,RD.UP);mat4.rotateVec3(k,g,RD.FRONT);vec3.normalize(c,c);vec3.normalize(r,r);vec3.normalize(k,k);mat4.fromTranslationFrontTop(f,l,h,t);vec4.transformMat4(s,s,m._viewprojection_matrix);this.current_size=t=gl.canvas.width/gl.canvas.height*this.size*s[3]/(gl.canvas.width*q);mat4.scale(g,g,[t,t,t]);mat4.scale(f,f,[t,
t,t]);var t=vec3.dot(y,c),q=vec3.dot(y,r),C=vec3.dot(y,k),E=vec3.dot(h,RD.RIGHT),d=vec3.dot(h,RD.UP),D=vec3.dot(h,RD.FRONT);this._camera.project(l,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);y=gl.shaders[this.shader];y.uniforms(b._uniforms);y.uniforms(m.uniforms);y.uniforms(this.uniforms);if("movex"==x)mat4.rotateZ(e,g,-Math.PI/2),this.drawAxis(e,a.XAXIS_COLOR);else if("movey"==
x)this.drawAxis(g,a.YAXIS_COLOR);else if("movez"==x)mat4.rotateX(e,g,-Math.PI/2),this.drawAxis(e,a.ZAXIS_COLOR);else if("drag"==x)b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0);else if(B&&B.normal&&this.render_move_plane)e.set(g),"movexz"==x?mat4.rotateX(e,e,Math.PI/2):"moveyz"==x&&mat4.rotateY(e,e,Math.PI/2),mat4.scale(e,e,[100,100,100]),y.setUniform("u_model",e),y.setUniform("u_color",[0.1,0.1,0.1,0.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),y.draw(gl.meshes.plane),
gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==x)mat4.rotateX(e,f,Math.PI/2),y.setUniform("u_model",e),y.draw(n),b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0),b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR),b.drawLine2D(this.click_2D2[0],this.click_2D2[1],this.center_2D[0],
this.center_2D[1],4,a.XAXIS_COLOR);else{if("rotate"==x){this.click_axis&&(mat4.fromTranslationFrontTop(e,l,h,this.click_axis),mat4.scale(e,e,[this.current_size,this.current_size,this.current_size]),this.drawAxis(e,a.NOAXIS_COLOR));this.drawRotateSphere(g,a.SPHERE_COLOR);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.NOAXIS_COLOR,!0);return}if(B&&B.rotate){h=B.color||a.XAXIS_COLOR;"rotatex"==x?mat4.rotateZ(e,g,Math.PI/2):"rotatey"==x?mat4.rotateY(e,g,Math.PI/2):"rotatez"==x&&mat4.rotateX(e,g,
Math.PI/2);y.setUniform("u_model",e);y.setUniform("u_color",h);y.draw(n);b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,h,!0);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,h,!0);b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,h);b.drawCircle2D(this.current_2D[0],this.current_2D[1],2,h,!0);b.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,h);return}}"scale"==x?(b.drawCircle2D(this.center_2D[0],this.click_2D[1],2,
a.INNERSPHERE_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.INNERSPHERE_COLOR,!0),b.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.INNERSPHERE_COLOR)):(this.drawRotateSphere(g,a.STATIC_SPHERE_COLOR),z&a.ROTATE&&"rotate"==u&&this.drawRotateSphere(g,a.SPHERE_COLOR),z&a.ROTATEFRONT&&(mat4.rotateX(e,f,Math.PI/2),y.setUniform("u_model",e),y.setUniform("u_color","rotatefront"==u?a.SELECTED_COLOR:a.RING_COLOR),y.draw(n),this.actions.rotatefront.visible=
!0),0.1<Math.abs(t)&&z&a.ROTATEX&&(mat4.rotateZ(e,g,Math.PI/2),0>D&&mat4.rotateX(e,e,Math.PI),0>d&&mat4.rotateY(e,e,Math.PI/2),this.drawRotator(e,"rotatex"==u?a.SELECTED_COLOR:a.XAXIS_COLOR,"rotatex")),0.1<Math.abs(q)&&z&a.ROTATEY&&(e.set(g),0<E&&0>D?mat4.rotateY(e,e,-Math.PI/2):0>E&&0>D?mat4.rotateY(e,e,Math.PI):0>E&&0<D&&mat4.rotateY(e,e,Math.PI/2),this.drawRotator(e,"rotatey"==u?a.SELECTED_COLOR:a.YAXIS_COLOR,"rotatey")),0.1<Math.abs(C)&&z&a.ROTATEZ&&(e.set(g),mat4.rotateX(e,e,Math.PI/2),0<E&&
0>d?mat4.rotateY(e,e,-Math.PI/2):0>E&&0>d?mat4.rotateY(e,e,Math.PI):0>E&&0<d&&mat4.rotateY(e,e,Math.PI/2),this.drawRotator(e,"rotatez"==u?a.SELECTED_COLOR:a.ZAXIS_COLOR,"rotatez")),0.95>Math.abs(t)&&(mat4.rotateZ(e,g,0>E?-Math.PI/2:Math.PI/2),z&a.MOVEX&&this.drawArrow(e,"movex"==u?a.SELECTED_COLOR:a.XAXIS_COLOR,"movex"),z&a.SCALEX&&this.drawScale(e,"scalex"==u?a.SELECTED_COLOR:a.XAXIS_COLOR,"scalex")),0.95>Math.abs(q)&&(0<d?mat4.rotateZ(e,g,Math.PI):e.set(g),z&a.MOVEY&&this.drawArrow(e,"movey"==u?
a.SELECTED_COLOR:a.YAXIS_COLOR,"movey"),z&a.SCALEY&&this.drawScale(e,"scaley"==u?a.SELECTED_COLOR:a.YAXIS_COLOR,"scaley")),0.95>Math.abs(C)&&(mat4.rotateX(e,g,0>D?-Math.PI/2:Math.PI/2),z&a.MOVEZ&&this.drawArrow(e,"movez"==u?a.SELECTED_COLOR:a.ZAXIS_COLOR,"movez"),z&a.SCALEZ&&this.drawScale(e,"scalez"==u?a.SELECTED_COLOR:a.ZAXIS_COLOR,"scalez")),0.2<Math.abs(C)&&(z&a.MOVEXY||z&a.SCALEXY)&&(mat4.translate(e,g,[0.45*(0>t?1:-1),0.45*(0>q?1:-1),0]),z&a.MOVEXY?this.drawFlat(e,"movexy"==u?a.SELECTED_COLOR:
a.XYAXIS_COLOR,"movexy"):this.drawFlat(e,"scalexy"==u?a.SELECTED_COLOR:a.XYAXIS_COLOR,"scalexy","circle")),0.2<Math.abs(q)&&(z&a.MOVEXZ||z&a.SCALEXZ)&&(mat4.rotateX(e,g,Math.PI/2),mat4.translate(e,e,[0.45*(0>t?1:-1),0.45*(0>C?-1:1),0]),z&a.MOVEXZ?this.drawFlat(e,"movexz"==u?a.SELECTED_COLOR:a.XZAXIS_COLOR,"movexz"):this.drawFlat(e,"scalexz"==u?a.SELECTED_COLOR:a.XZAXIS_COLOR,"scalexz","circle")),0.2<Math.abs(t)&&(z&a.MOVEYZ||z&a.SCALEYZ)&&(mat4.rotateY(e,g,Math.PI/2),mat4.translate(e,e,[0.45*(0>C?
1:-1),0.45*(0>q?1:-1),0]),z&a.MOVEYZ?this.drawFlat(e,"moveyz"==u?a.SELECTED_COLOR:a.YZAXIS_COLOR,"moveyz"):this.drawFlat(e,"scaleyz"==u?a.SELECTED_COLOR:a.YZAXIS_COLOR,"scaleyz","circle")),z&a.DRAG&&this.drawInnerSphere(g,"drag"),z&a.SCALE&&this.drawInnerSphere(g,"scale"),z&a.RESIZE&&this.drawResize(g,"resize"),gl.enable(gl.DEPTH_TEST))}}};a.prototype.drawArrow=function(b,e,f){var c=gl.shaders[this.shader],k=gl.meshes.cone,g=gl.meshes.cylinder,h=this._hover_action;mat4.translate(n,b,[0,1.1,0]);c.setUniform("u_model",
n);c.setUniform("u_color",h==f?a.SELECTED_COLOR:e);c.draw(k);this.mode==a.MOVEALL?(mat4.translate(n,n,[0,-0.4,0]),mat4.scale(n,n,[1,1,1])):(mat4.translate(n,n,[0,-0.15,0]),mat4.scale(n,n,[1,0.5,1]));c.setUniform("u_model",n);c.draw(g);this.toScreen(n,f,[0,0.6,0])};a.prototype.drawAxis=function(b,e){var a=gl.shaders[this.shader],f=gl.meshes.sphere;mat4.scale(n,b,[0.01,100,0.01]);a.setUniform("u_model",n);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);
gl.depthMask(!1);a.setUniform("u_color",[e[0],e[1],e[2],0.2]);gl.depthFunc(gl.GREATER);a.draw(f);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);a.setUniform("u_color",e);a.draw(f);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(b)};a.prototype.drawFlat=function(b,a,f,c){c=gl.meshes[c||"plane"];var n=gl.shaders[this.shader];mat4.scale(e,b,[0.25,0.25,0.25]);n.setUniform("u_color",a);n.setUniform("u_model",e);gl.enable(gl.BLEND);n.draw(c);gl.disable(gl.BLEND);this.toScreen(e,f)};a.prototype.drawRotator=
function(b,a,f){var c=gl.meshes.quartertorus,n=gl.shaders[this.shader];mat4.scale(e,b,[0.9,0.9,0.9]);n.setUniform("u_color",a);n.setUniform("u_model",e);n.draw(c);this.toScreen(e,f,[-0.75,0,0.75])};a.prototype.drawScale=function(b,f,c){var n=gl.meshes.cylinder,k=gl.meshes.sphere,g=gl.shaders[this.shader];g.setUniform("u_color",f);this.mode==a.SCALEALL?(mat4.translate(e,b,[0,0.5,0]),mat4.scale(e,e,[1,1,1])):(mat4.translate(e,b,[0,0.25,0]),mat4.scale(e,e,[1,0.5,1]));g.setUniform("u_model",e);g.draw(n);
mat4.translate(e,b,[0,0.4,0]);this.mode==a.SCALEALL?mat4.scale(e,e,[0.1,0.1,0.1]):mat4.scale(e,e,[0.1,0.2,0.1]);g.setUniform("u_model",e);g.draw(k);this.toScreen(e,c)};a.prototype.drawRotateSphere=function(b,a){var f=gl.shaders[this.shader],c=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(e,b,[0.9,0.9,0.9]);f.setUniform("u_model",e);f.setUniform("u_color",a);f.draw(c);gl.disable(gl.BLEND)};a.prototype.drawInnerSphere=function(b,f){var c=gl.shaders[this.shader],
n=gl.meshes.sphere,k=this._hover_action;mat4.scale(e,b,[0.1,0.1,0.1]);c.setUniform("u_model",e);c.setUniform("u_color",k==f?a.SELECTED_COLOR:a.INNERSPHERE_COLOR);c.draw(n);"drag"==f&&(mat4.scale(e,b,[0.07,0.07,0.07]),c.setUniform("u_model",e),c.setUniform("u_color",k==f?a.INNERSPHERE_COLOR:[0,0,0,1]),c.draw(n));f&&this.toScreen(e,f)};a.prototype.drawResize=function(b,e){};a.prototype.computeBounding=function(b){b=b||BBox.create();for(var e=0;e<this.targets.length;++e){var a=this.targets[e].updateBoundingBox();
0==e?BBox.copy(b,a):BBox.merge(b,b,a)}return b};a.prototype.renderOutline=function(b,e,f,c){if((c=c||this.targets)&&c.length){var n=this.layers;c=c.filter(function(b){return b.layers&n});var k=gl.viewport_data[2],g=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==k&&this._selection_buffer.height==g||(this._selection_buffer=new GL.Texture(k,g,{magFilter:gl.NEAREST}));a.outline_material||(a.outline_material=new RD.Material({shader_name:"flat"}));var h=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,
0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);b.shader_overwrite=h;var a=b.onNodeShaderUniforms;b.onNodeShaderUniforms=function(b,e){e.setUniform("u_color",[1,1,1,1])};var n=b.pipeline;b.pipeline=null;b.overwrite_material=RD.Gizmo.outline_material;b.render(e,f,c);b.shader_overwrite=null;b.onNodeShaderUniforms=a;b.pipeline=n;b.overwrite_material=null});var r=gl.shaders.outline;r||(r=gl.shaders.outline=GL.Shader.createFX("\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n"));gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(r,{u_color:[1,1,1,1],u_res:[1/k,1/g]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};a.prototype.renderCameraGizmo=function(b,e){this.drawInnerSphere};a.prototype.toScreen=function(b,e,f){e=this.actions[e];mat4.multiplyVec3(e.pos,b,f||[0,0,0]);this._camera.project(e.pos,a.full_viewport,e.pos2D);e.visible=!0};extendClass(a,RD.SceneNode);RD.Gizmo=a})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,convert_skeletons:!1,overwrite_materials:!0,rename_assets:!1,prefabs:{},texture_options:{format:GL.RGBA,
magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT,no_flip:!1},load:function(l,a,h,q){function g(b){function e(a){var c=this.buffer;c.data=a;c.dataview=new Uint8Array(a);b.length?g(b):f()}var a=b.pop(),c=r+"/"+a.uri;"blob:"==a.uri.substr(0,5)&&(c=a.uri);"data:"==a.uri.substr(0,5)?(c=_base64ToArrayBuffer(a.uri.substr(37)),e.call({buffer:a},c)):fetch(c).then(function(b){return b.arrayBuffer()}).then(e.bind({buffer:a}))}function f(){k.filename=c;k.folder=r;k.url=l;RD.GLTF.parseBuffers(k,
e);var b=RD.GLTF.parse(k),f=b.serialize();RD.GLTF.prefabs[l]=f;a&&a(b)}if(!l)throw"url missing";var k=null,c="",r="";if(l.constructor===String){r=l.split("/");c=r.pop();h=h||c.split(".").pop().toLowerCase();var r=r.join("/"),s=new XMLHttpRequest;s.onload=function(){if(200!=this.status)console.error("GLTF not found",l),a&&a(null);else{var b=s.response;"gltf"==h?(k=b,g(k.buffers.concat())):"glb"==h&&((k=RD.GLTF.parseGLB(b))?f():console.error("error parsing GLB:",c))}};s.onerror=function(){console.error("Network Error");
a&&a(null)};q&&(s.onprogress=function(b){q(l,b.loaded,b.total)});s.responseType="gltf"==h?"json":"arraybuffer";s.open("GET",l);s.send()}else{var e=l;if(c=e.main){l=c;var n=e[c];"glb"==n.extension?(k=RD.GLTF.parseGLB(n.data))&&f():(k=n.data,this.parseBuffers(),f())}}},parseBuffers:function(l,a){for(var h=0;h<l.buffers.length;++h){var q=l.buffers[h];if(!q.data){if(q.uri&&"data:"==q.uri.substr(0,5))q.data=_base64ToArrayBuffer(q.uri.substr(37));else{if(!a)throw"missing data in glb";q.data=a[q.uri].data}q.dataview=
new Uint8Array(q.data)}}},parseGLB:function(l){var a=new Uint8Array(l),h=new DataView(l);if(1179937895!=h.getUint32(0,!0))return console.error("incorrect gltf header"),null;h.getUint32(4,!0);h.getUint32(8,!0);for(var q=12,g=null,f=0;q<a.length;){var k=h.getUint32(q,!0),c=h.getUint32(q+4,!0),r=l.slice(q+8,q+8+k),q=q+(8+k);if(c==RD.GLTF.JSON_CHUNK){if(!("TextDecoder"in window))throw"Sorry, this browser does not support TextDecoder...";g=(new TextDecoder("utf-8")).decode(r);g=JSON.parse(g)}else c==RD.GLTF.BINARY_CHUNK?
(k=g.buffers[f],k.data=r,k.dataview=new Uint8Array(r),f++):console.warn("gltf unknown chunk type: ","0x"+c.toString(16))}return g},parse:function(l,a){l.url||(l.url=a||"scene.glb");var h=null,q={};1<l.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var g=l.scenes[l.scene||0].nodes;this.gltf_materials={};if(l.buffers&&l.buffers.length)for(var f=0;f<l.buffers.length;++f)h=l.buffers[f],h.uri&&!h.data&&"data:"==h.uri.substr(0,5)&&(h.data=_base64ToArrayBuffer(h.uri.substr(37)),
h.dataview=new Uint8Array(h.data));if(l.skins)for(f=0;f<l.skins.length;++f)for(var h=l.skins[f],k=0;k<h.joints.length;++k)l.nodes[h.joints[k]]._is_joint=!0;h=null;1<g.length&&(h=new RD.SceneNode,h.name="root");for(f=0;f<g.length;++f){var c=k=g[f];null!=k.node&&(c=k.node);k=RD.GLTF.parseNode(null,c,l);h||(h=k);1<g.length&&h.addChild(k);k.id=l.url.replace(/\//gi,"_")+"::node_"+f;q[k.id]=q[f]=k}if(l.animations&&l.animations.length){if(RD.Animation)for(h.animations=[],f=0;f<l.animations.length;++f)g=
this.parseAnimation(f,l,q),g.id=l.filename+"::"+g.name,g&&(RD.Animations[g.id]=g,h.animations.push(g));else console.error("you must include rendeer-animation.js to allow animations");this.convert_skeletons&&this.convertSkinToSkeleton(h,h)}h.materials=this.gltf_materials;h.meta={asset:l.asset};return h},parseNode:function(l,a,h){var q=h.nodes[a];l=l||new RD.SceneNode;for(var g in q){var f=q[g];switch(g){case "name":l.name=f;break;case "translation":l.position=f;break;case "rotation":l.rotation=f;break;
case "scale":l.scaling=f;var k=0;0>l.scaling[0]&&k++;0>l.scaling[1]&&k++;0>l.scaling[2]&&k++;1==k%2&&(l.flags.frontFace=GL.CW);break;case "matrix":l.fromMatrix(f);0>mat4.determinant(f)&&(l.flags.frontFace=GL.CW);break;case "mesh":if(f=RD.GLTF.parseMesh(f,h))for(l.mesh=f.name,l.primitives=[],k=0;k<f.info.groups.length;++k){var c=f.info.groups[k],r=null;null!=c.material&&(r=this.parseMaterial(c.material,h));l.primitives.push({index:k,material:r?r.name:null,mode:c.mode})}break;case "skin":l.skin=this.parseSkin(f,
h);break;case "children":if(f.length)for(k=0;k<f.length;++k)c=RD.GLTF.parseNode(null,f[k],h),l.addChild(c);break;case "extras":break;default:"_"!=g[0]&&console.log("gltf node info ignored:",g,q[g])}}if(l.mesh&&l.skin)for(f=gl.meshes[l.mesh],f.bones=[],k=0;k<l.skin.joints.length;++k)f.bones.push([l.skin.joints[k],l.skin.bindMatrices[k]]);q.name||(q.name=l.name="node_"+a);q._is_joint&&(l.is_joint=!0);return l},parseMesh:function(l,a){for(var h=a.meshes[l],q=gl.meshes,g=[],f=[],k=0,c=0;c<h.primitives.length;++c){var r=
this.parsePrimitive(h,c,a);if(r){r.start=k;k+=r.length;f.push(r);var s={vertexBuffers:{},indexBuffers:{}},e;for(e in r.buffers){var n=e;"bones"==n&&(n="bone_indices");"indices"==n||"triangles"==n?s.indexBuffers[n]={data:r.buffers[e]}:s.vertexBuffers[n]={data:r.buffers[e]}}g.push({mesh:s})}}k=null;1<g.length?k=GL.Mesh.mergeMeshes(g):1==g.length&&(c=g[0].mesh,k=new GL.Mesh(c.vertexBuffers,c.indexBuffers),k.info&&c.info&&(k.info=c.info));if(!k)return null;for(c=0;c<h.primitives.length;++c)(g=k.info.groups[c])||
(k.info.groups[c]=g={}),r=h.primitives[c],g.material=r.material,g.mode=null!=r.mode?r.mode:4,g.start=f[c].start,g.length=f[c].length;k.name=h.name+"_"+l;if(!k.name||this.rename_assets)k.name=a.filename+"::mesh_"+(h.name||l);k.updateBoundingBox();k.computeGroupsBoundingBoxes();return q[k.name]=k},parsePrimitive:function(l,a,h){var q={buffers:{}},g=q.buffers;l=l.primitives[a];if(l.extensions)if(l.extensions.KHR_draco_mesh_compression){if("undefined"==typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";
g=q.buffers=this.decompressDraco(l,h)}else throw"mesh data is compressed, this importer does not support it yet";else{null==!l.attributes.POSITION&&console.warn("gltf mesh without positions");for(var f in this.buffer_names){a=this.buffer_names[f];var k=this.flip_uv&&("coords"==a||"coords1"==a),c=l.attributes[f];null!=c&&(k=this.parseAccessor(c,h,k))&&(g[a]=k)}null!=l.indices&&(g.triangles=this.parseAccessor(l.indices,h))}if(!g.vertices)return console.error("primitive without vertices"),null;q.mode=
l.mode;q.material=l.material;q.start=0;q.length=g.triangles?g.triangles.length:g.vertices.length/3;return q},convertSkinToSkeleton:function(l,a){if(l.skin){var h=a.findNodeByName(l.skin.skeleton_root);l.skeleton||(l.skeleton=new RD.Skeleton);l.skeleton.importSkeleton(h||a)}for(h=0;h<l.children.length;++h)this.convertSkinToSkeleton(l.children[h],a)},installDracoModule:function(l){var a=this.draco_data_types={},h=this;this.decoderModule?l&&l(this.decoderModule):"undefined"!=typeof DracoDecoderModule?
DracoDecoderModule({}).then(function(q){var g=h.decoderModule=q;a[g.DT_INT8]=Int8Array;a[g.DT_UINT8]=Uint8Array;a[g.DT_INT16]=Int16Array;a[g.DT_UINT16]=Uint16Array;a[g.DT_INT32]=Int32Array;a[g.DT_UINT32]=Uint32Array;a[g.DT_FLOAT32]=Float32Array;l&&l(q)}):console.error("Draco3D not installed")},decompressDraco:function(l,a){this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,l,a)},decodePrimitive:function(l,a,h){var q={};a=h.buffers[h.bufferViews[a.extensions.KHR_draco_mesh_compression.bufferView].buffer];
var g=a.dataview.buffer;h=this.decoderModule;a=new h.DecoderBuffer;a.Init(new Int8Array(g),g.byteLength);if(l.GetEncodedGeometryType(a)==h.TRIANGULAR_MESH){var f=new h.Mesh,g=l.DecodeBufferToMesh(a,f);if(!g.ok()||0===f.ptr)throw Error("GLTF Draco: Decoding failed: "+g.error_msg());f.num_points();for(var k in this.buffer_names){var g=this.buffer_names[k],c=k;"COLOR_0"==c?c="COLOR":"TEXCOORD_0"==c&&(c="TEX_COORD");if(c=this.decodeBuffer(f,h[c],"coords"==g||"coords1"==g,l))q[g]=c.data}k=3*f.num_faces();
g=4*k;c=h._malloc(g);l.GetTrianglesUInt32Array(f,g,c);q.triangles=(new Uint32Array(h.HEAPF32.buffer,c,k)).slice();h._free(c)}h.destroy(a);h.destroy(f);return q},decodeBuffer:function(l,a,h,q){if(null==a)return null;var g=this.decoderModule;a=q.GetAttributeId(l,a);if(-1==a)return null;var f=q.GetAttribute(l,a);a=f.data_type();var k=f.num_components(),c=l.num_points();f.size();var r=c*k,s=this.draco_data_types[a],g=new g.DracoFloat32Array;q.GetAttributeFloatForAllPoints(l,f,g);l=new s(r);for(q=0;q<
l.length;++q)l[q]=g.GetValue(q);if(h)for(q=1;q<l.length;q+=k)l[q]=1-l[q];return{num_points:c,num_comps:k,data_type:a,data:l}},parseAccessor:function(l,a,h,q,g){g=a.accessors[l];if(!g)return console.warn("gltf accessor not found"),null;var f=this.numComponents[g.type];if(!f)return console.warn("gltf accessor of unknown type:",g.type),null;l=g.count*f;var k=null;switch(g.componentType){case RD.GLTF.FLOAT:k=new Float32Array(l);break;case RD.GLTF.UNSIGNED_INT:k=new Uint32Array(l);break;case RD.GLTF.SHORT:k=
new Int16Array(l);break;case RD.GLTF.UNSIGNED_SHORT:k=new Uint16Array(l);break;case RD.GLTF.BYTE:k=new Int8Array(l);break;case RD.GLTF.UNSIGNED_BYTE:k=new Uint8Array(l);break;default:console.warn("gltf accessor of unsupported type: ",g.componentType),k=new Float32Array(l)}null==q&&(q=a.bufferViews[g.bufferView]);if(!q)return console.warn("gltf bufferView not found"),null;l=a.buffers[q.buffer];if(!l||!l.data)return console.warn("gltf buffer not found or data not loaded"),null;a=new Uint8Array(k.buffer);
null==q.byteOffset&&(q.byteOffset=0);var c=q.byteOffset+(g.byteOffset||0);if(q.byteStride&&q.byteStride!=f*k.BYTES_PER_ELEMENT){a=f*k.BYTES_PER_ELEMENT;for(var c=l.dataview.subarray(c,c+q.byteLength),r=new k.constructor(f),s=new Uint8Array(r.buffer),e=l=0;e<g.count;++e)s.set(c.subarray(l,l+a)),k.set(r,e*f),l+=q.byteStride}else c=l.dataview.subarray(c,c+a.length),a.set(c);if(h)for(e=1;e<k.length;e+=f)k[e]=1-k[e];return k},parseMaterial:function(l,a){var h=a.materials[l];if(!h)return console.warn("gltf material not found"),
null;var q=h.name;if(!q||this.rename_assets)q=a.filename+"::mat_"+(h.name||l);var g=RD.Materials[q];if(g&&(!this.overwrite_materials||g.from_filename==a.filename))return g;g=new RD.Material;g.name=q;g.from_filename=a.filename;null!=h.alphaMode&&(g.alphaMode=h.alphaMode);g.alphaCutoff=null!=h.alphaCutoff?h.alphaCutoff:0.5;null!=h.doubleSided&&(g.flags.two_sided=h.doubleSided);g.normalmapFactor=1;h.pbrMetallicRoughness&&(g.model="pbrMetallicRoughness",g.color.set([1,1,1]),g.opacity=1,g.metallicFactor=
1,g.roughnessFactor=1,null!=h.pbrMetallicRoughness.baseColorFactor&&(g.color=h.pbrMetallicRoughness.baseColorFactor),h.pbrMetallicRoughness.baseColorTexture&&(g.textures.albedo=this.parseTexture(h.pbrMetallicRoughness.baseColorTexture,a),"MASK"==g.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic&&(q=gl.textures[g.textures.albedo.texture]))&&(q.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8)),null!=h.pbrMetallicRoughness.metallicFactor&&
(g.metallicFactor=h.pbrMetallicRoughness.metallicFactor),null!=h.pbrMetallicRoughness.roughnessFactor&&(g.roughnessFactor=h.pbrMetallicRoughness.roughnessFactor),h.pbrMetallicRoughness.metallicRoughnessTexture&&(g.textures.metallicRoughness=this.parseTexture(h.pbrMetallicRoughness.metallicRoughnessTexture,a)));h.occlusionTexture&&(g.textures.occlusion=this.parseTexture(h.occlusionTexture,a));h.normalTexture&&(g.textures.normal=this.parseTexture(h.normalTexture,a));h.emissiveTexture&&(g.textures.emissive=
this.parseTexture(h.emissiveTexture,a));h.emissiveFactor&&(g.emissive=h.emissiveFactor);RD.Materials[g.name]=g;return this.gltf_materials[g.name]=g},parseTexture:function(l,a){var h=a.textures[l.index];if(!h)return console.warn("gltf texture not found"),null;var q=a.images[h.source],g="",f=null;q.uri?(f=q.uri,f.split(".").pop()):(f=a.url.replace(/[\/\.\:]/gi,"_")+"_image_"+l.index,g=q.mimeType?q.mimeType.split("/").pop():"png",f+="."+g);var k={};if(!gl.textures[f])if(q.uri){var c=q.uri;if("data:"==
c.substr(0,5)){var r=q.uri.indexOf(","),s=q.uri.substr(5,r),g=s.split("/").pop().toLowerCase(),f=a.folder+"/"+c+"image_"+l.index+"."+g,g=_base64ToArrayBuffer(q.uri.substr(r+1)),s=URL.createObjectURL(new Blob([g],{type:s})),s=GL.Texture.fromURL(s,this.texture_options);s.name=f;gl.textures[f]=s}else"blob:"==c.substr(0,5)?k.texture=c:k.texture=a.folder+"/"+c}else null!=q.bufferView&&(s=a.bufferViews[q.bufferView],null==s.byteOffset&&(s.byteOffset=0),g=a.buffers[s.buffer].data.slice(s.byteOffset,s.byteOffset+
s.byteLength),s=URL.createObjectURL(new Blob([g],{type:q.mimeType})),s=GL.Texture.fromURL(s,this.texture_options),s.name=f,gl.textures[f]=s,a.asset&&a.asset.low_quality&&(q=a.folder+"/"+a.filename.replace(/\.[^/.]+$/,"")+"/"+q.name,a.asset.hd_textures||(a.asset.hd_textures={}),a.asset.hd_textures[f]=q));k.texture||(k.texture=f);null!=h.sampler&&(h=a.samplers[h.sampler],null!=h.magFilter&&(k.magFilter=h.magFilter),null!=h.minFilter&&(k.minFilter=h.minFilter));l.texCoord&&(k.uv_channel=l.texCoord);
return k},parseSkin:function(l,a){var h=a.skins[l],q={};null!=h.skeleton&&(q.skeleton_root=a.nodes[h.skeleton].name);var g=this.parseAccessor(h.inverseBindMatrices,a);if(!g)return console.warn("accessor is null"),null;q.bindMatrices=this.splitBuffer(g,16);q.joints=[];for(g=0;g<h.joints.length;++g){var f=a.nodes[h.joints[g]];q.joints.push(f.id||f.name)}return q},splitBuffer:function(l,a){l||console.warn("buffer is null");for(var h=l.length,q=[],g=0;g<h;g+=a)q.push(new l.constructor(l.subarray(g,g+
a)));return q},parseAnimation:function(l,a,h){h=a.animations[l];var q=new RD.Animation;q.name=h.name||"anim_"+l;for(var g=l=0;g<h.channels.length;++g){var f=new RD.Animation.Track,k=h.channels[g],c=h.samplers[k.sampler];f.target_node=a.nodes[k.target.node].name;f.target_property=k.target.path.toLowerCase();if(k=this.rename_animation_properties[f.target_property])f.target_property=k;var k=this.parseAccessor(c.input,a),r=this.parseAccessor(c.output,a);if(r){var s=a.accessors[c.output].type,c=RD.TYPES[s];
c==RD.VEC4&&"rotation"==f.target_property&&(c=RD.QUAT);f.type=c;if(c=RD.TYPES_SIZE[c]){for(var s=r.length/c,e=new Float32Array((1+c)*s),n=0;n<s;++n){e[n*(1+c)]=k[n];var b=r.subarray(n*c,n*c+c);e.set(b,n*(1+c)+1)}f.data=e;f.packed_data=!0;l=Math.max(l,k[k.length-1]);q.addTrack(f)}else console.warn("gltf unknown type:",s)}else console.warn("animation accedor missing")}q.duration=l;return q},loadFromFiles:function(l,a){function h(e){var b=e.target.result,c=this.extension;if("gltf"==c)b=JSON.parse(b),
q.main=this.filename;else if("glb"==c)q.main=this.filename;else if("bin"==c)k.push(this.filename);else if("jpeg"==c||"jpg"==c||"png"==c)e=URL.createObjectURL(new Blob([b],{type:e.target.mimeType})),c=GL.Texture.fromURL(e,{wrap:gl.REPEAT,extension:c}),c.name=this.filename,gl.textures[c.name]=c,gl.textures["/textures/"+c.name]&&(gl.textures["/textures/"+c.name]=c);q[this.filename]={filename:this.filename,data:b,extension:this.extension};g--;0==g&&(q.binaries=k,f.load(q,function(b){a&&a(b)}))}for(var q=
{},g=l.length,f=this,k=[],c=0;c<l.length;++c){var r=l[c],s=new FileReader,e=r.name.split("."),e=e[e.length-1].toLowerCase();s.onload=h;s.filename=r.name;s.extension=e;"gltf"==e?s.readAsText(r):s.readAsArrayBuffer(r)}},removeRootPathFromTextures:function(l,a,h){if(a)for(var q in l){a=l[q];for(var g in a.textures)if(h=a.textures[g])h.constructor===String&&0==h.indexOf(ROOM.root_path)&&-1!=h.texture.indexOf("/")?h.substr(ROOM.root_path.length):h.texture&&0==h.texture.indexOf(ROOM.root_path)&&-1!=h.texture.indexOf("/")&&
(h.texture=h.texture.substr(ROOM.root_path.length))}},exportToGLB:function(l,a){console.error("export not supported yet");for(var h=0;h<l._nodes.length;++h);}};RD.SceneNode.prototype.loadGLTF=function(l,a){function h(f){q.loading=!1;f&&q.addChild(f);a&&a(q,f)}var q=this;if(RD.GLTF.prefabs[l]){var g=new RD.SceneNode;g.configure(RD.GLTF.prefabs[l]);h(g)}else this.loading=!0,RD.GLTF.load(l,h)};
function _base64ToArrayBuffer(l){l=window.atob(l);for(var a=l.length,h=new Uint8Array(a),q=0;q<a;q++)h[q]=l.charCodeAt(q);return h.buffer}"undefined"!=typeof DracoDecoderModule&&RD.GLTF.installDracoModule(RD.GLTF.onReady);
(function(l){function a(f){this.renderer=f;this.mode=a.FORWARD;this.visible_layers=65535;this.bgcolor=vec4.fromValues(0.1,0.1,0.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.emissive_factor=this.occlusion_gamma=this.occlusion_factor=this.exposure=this.environment_factor=1;this.postfx_shader_name=null;this.allow_overlay=this.timer_queries_enabled=!0;this.brightness=this.contrast=1;this.gamma=2.2;this.parallax_reflection=
!1;this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=mat4.create();this.texture_matrix=mat3.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.skip_background=this.single_pass=!1;this.allow_instancing=!0;this.debug_instancing=!1;this.use_rendertexture=!0;this.alpha_composite_target_texture=this.fx=null;this.frame_time=-1;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_occlusion_gamma:this.occlusion_gamma,
u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_gamma:this.gamma,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_viewport:gl.viewport_data,u_camera_perspective:1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec4.fromValues(0,0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),
u_backface_color:vec3.fromValues(0.5,0.5,0.5),u_normalFactor:1,u_metallicRough:!1,u_reflectance:0.1,u_texture_matrix:this.texture_matrix,u_displacement_factor:0,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:0.5,u_isAnisotropic:!1,u_anisotropy:0.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this._instancing_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.final_fbo=
this.final_texture=null;this.render_calls=[];this.render_calls_pool=[];this.rendered_render_calls=this.used_render_calls=0;this.current_camera=null;this.overlay_rcs=[];this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new q.Material;this.onRenderBackground=null}function h(){this.name="";this.id=-1;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=
null;this.reverse_faces=!1;this.node=this._instancing=this.skin=null;this._render_priority=0}var q=l.RD;a.FORWARD=1;a.DEFERRED=2;a.MACROS={UVS2:1,COLOR:2,POINTS:4,INSTANCING:8,SKINNING:16,PARALLAX_REFLECTION:32};a.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");a.maps_sampler=[];for(l=0;l<a.maps.length;++l)a.maps_sampler[l]="u_"+a.maps[l]+"_texture";a.prototype.render=function(f,k,c,g,h,e){this.renderer=f;this.current_camera=c;this.mode==a.FORWARD?
this.renderForward(k,c,h,e):this.mode==a.DEFERRED&&this.renderDeferred(k,c,e)};a.prototype.fillGlobalUniforms=function(a){var k=this.getBRDFIntegratorTexture();k&&k.bind(0);this.environment_texture?(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=
this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;this.global_uniforms.u_occlusion_gamma=this.occlusion_gamma;this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3);this.global_uniforms.u_camera_perspective=a._projection_matrix[5];this.global_uniforms.u_tonemapper=0;this.quality?(this.global_uniforms.u_exposure=this.exposure,this.global_uniforms.u_gamma=this.gamma):(this.global_uniforms.u_exposure=
Math.pow(this.exposure,1/2.2),this.global_uniforms.u_gamma=this.use_rendertexture?this.gamma:1)};a.prototype.renderForward=function(a,k,c,g){var h=Math.floor(gl.viewport_data[2]*this.resolution_factor),e=Math.floor(gl.viewport_data[3]*this.resolution_factor),h=Math.min(h,this.max_texture_size),e=Math.min(e,this.max_texture_size);this.use_rendertexture&&!c&&(this.frame_texture&&this.frame_texture.width==h&&this.frame_texture.height==e||(this.frame_texture=new GL.Texture(h,e,{format:gl.RGBA,type:gl.HIGH_PRECISION_FORMAT,
filter:gl.LINEAR}),this.final_fbo?this.final_fbo.setTextures([this.frame_texture]):this.final_fbo=new GL.FBO([this.frame_texture],null,!0),this.frame_texture.name=":frame_texture",gl.textures[this.frame_texture.name]=this.frame_texture,this.final_texture=new GL.Texture(h,e,{format:gl.RGB,filter:gl.LINEAR}),this.final_texture.name=":final_frame_texture",gl.textures[this.final_texture.name]=this.final_texture),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);
gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);if(!this.skip_background){if(this.onRenderBackground)this.onRenderBackground(k,this);else this.renderSkybox(k);LEvent.trigger(this,"renderSkybox",this)}this.fillGlobalUniforms(k);if(this.onRenderOpaque)this.onRenderOpaque(this,this.renderer,k);LEvent.trigger(this,"renderOpaque",this);this.renderNodes(a,k,g);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,
k);LEvent.trigger(this,"renderAlpha",this);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,k);LEvent.trigger(this,"renderGizmos",this);this.use_rendertexture&&!c&&this.renderFinalBuffer();if(this.overlay_rcs.length)for(a=this.overlay_rcs,this.global_uniforms.u_gamma=1,this.global_uniforms.u_exposure=1,gl.clear(gl.DEPTH_BUFFER_BIT),k=0;k<a.length;++k)c=a[k],this.renderMeshWithMaterial(c.model,c.mesh,c.material,c.index_buffer_name,c.group_index,c.node.extra_uniforms,c.reverse_faces,c.skin)};
a.prototype.renderNodes=function(a,k,c){a=this.getAllRenderCalls(a,k,c);k=(this.alpha_composite_callback||this.alpha_composite_target_texture)&&GL.FBO.current;c=!0;for(var g=this.overlay_rcs,h=g.length=0;h<a.length;++h){var e=a[h];if(e.material.overlay&&this.allow_overlay)g.push(e);else{c&&k&&"BLEND"==e.material.alphaMode&&(c=!1,this.alpha_composite_target_texture&&GL.FBO.current.color_textures[0].copyTo(this.alpha_composite_target_texture),this.alpha_composite_callback&&this.alpha_composite_callback(GL.FBO.current,
this.alpha_composite_target_texture));var n=e.model;e._instancing&&e._instancing.length&&(n=GL.linearizeArray(e._instancing,Float32Array));this.renderMeshWithMaterial(n,e.mesh,e.material,e.index_buffer_name,e.group_index,e.node.extra_uniforms,e.reverse_faces,e.skin)}}};a.prototype.getAllRenderCalls=function(f,k,c){this.resetRenderCallsPool();for(var g=this.render_calls,h=g.length=0;h<f.length;++h)this.getNodeRenderCalls(f[h],k,c);if(this.onFilterRenderCalls)this.onFilterRenderCalls(g);for(h=0;h<g.length;++h)g[h].computeRenderPriority(k._position);
g=g.sort(a.rc_sort_function);this.allow_instancing&&gl.extensions.ANGLE_instanced_arrays&&(g=this.groupRenderCallsForInstancing(g));return g};a.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.frame_texture,null,this.frame_texture);this.fx_uniforms.u_viewportSize[0]=this.frame_texture.width;this.fx_uniforms.u_viewportSize[1]=this.frame_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.frame_texture.width;
this.fx_uniforms.u_iViewportSize[1]=1/this.frame_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=this.brightness;this.fx_uniforms.u_gamma=this.gamma;this.frame_texture.copyTo(this.final_texture,gl.shaders.fxaa_tonemapper,this.fx_uniforms);var a=null;this.postfx_shader_name&&(a=gl.shaders[this.postfx_shader_name])&&a.setUniform("u_size",[this.final_texture.width,this.final_texture.height]);this.final_texture.toViewport(a)};a.prototype.getNodeRenderCalls=function(f,
k,c){var g=null;if(f._mesh)g=f._mesh;else if(f.mesh&&(g=gl.meshes[f.mesh],!g)){this.renderer.autoload_assets&&-1!=f.mesh.indexOf(".")&&this.renderer.loadMesh(f.mesh);return}void 0===c&&(c=65535);f.updateGlobalMatrix(!0);if(g&&!1!==f.flags.visible&&f.layers&c){c=f.skeleton||f.skin||null;!c||c.bones||c.joints||(c=null);c&&c.bones&&!c.bones.length&&(c=null);c&&c.joints&&!c.joints.length&&(c=null);c&&c.joints&&(c._bone_matrices||f.updateSkinningBones(f.parentNode));if(this.test_visibility&&!c){a.temp_bbox||
(a.temp_bbox=BBox.create(),a.aabb_center=BBox.getCenter(a.temp_bbox),a.aabb_halfsize=BBox.getHalfsize(a.temp_bbox));BBox.transformMat4(a.temp_bbox,g.getBoundingBox(),f._global_matrix);if(k.testBox(a.aabb_center,a.aabb_halfsize)==q.CLIP_OUTSIDE)return;f._last_rendered_frame=this.renderer.frame}if(f.primitives&&f.primitives.length)for(k=0;k<f.primitives.length;++k){var h=f.primitives[k],e=null;if(e=h.material?q.Materials[h.material]:this.default_material)h=this.getRenderCallFromPool(),h.material=e,
h.model=f._global_matrix,h.mesh=g,h.group_index=k,h.node=f,h._render_priority=e.render_priority||0,h._instancing=null,h.reverse_faces=f.flags.frontFace==GL.CW,h.skin=c,this.render_calls.push(h)}else f.material&&(e=q.Materials[f.material])&&(h=this.getRenderCallFromPool(),h.material=e,h.model=f._global_matrix,h.mesh=g,h.group_index=-1,h.node=f,h._instancing=null,h.skin=c,h._render_priority=e.render_priority||0,h.reverse_faces=f.flags.frontFace==GL.CW,this.render_calls.push(h))}};a.prototype.groupRenderCallsForInstancing=
function(a){for(var k={},c=0,h=0;h<a.length;++h){var g=a[h],e=null,e=g._instancing||g.skin?c++:g.mesh.name+":"+g.group_index+"/"+g.material.name+(g.reverse_faces?"[R]":"");k[e]?k[e].push(g):k[e]=[g]}a=[];for(h in k)if(c=k[h],0!=c.length)if(1==c.length)g=c[0],this.debug_instancing||a.push(g);else{g=this.getRenderCallFromPool();g.copyFrom(c[0]);g._instancing=Array(c.length);for(e=0;e<c.length;++e)g._instancing[e]=c[e].model;a.push(g)}return a};a.rc_sort_function=function(a,k){return k._render_priority-
a._render_priority};a.prototype.setParallaxReflectionTransform=function(a){this.parallax_reflection_matrix.set(a);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};a.prototype.resetShadersCache=function(){this.compiled_shaders={}};a.prototype.getShader=function(f,k,c){c=c||"";
var g=c+":"+k,h=this.compiled_shaders[g];h||(h=this.compiled_shaders[g]=new Map);if(g=h.get(f))return g;if(!this.renderer.shader_files)return null;c=this.renderer.shader_files[c||"default.vs"];k=this.renderer.shader_files[k];if(!c||!k)return null;g=null;if(f){var g={},e;for(e in a.MACROS)f&a.MACROS[e]&&(g[e]="")}g=new GL.Shader(c,k,g);h.set(f,g);return g};a.prototype.renderRenderCall=function(a){var k=a.model;a._instancing&&a._instancing.length&&(k=new Float32Array(a._instancing.flat()));this.renderMeshWithMaterial(k,
a.mesh,a.material,a.index_buffer_name,a.group_index,a.node.extra_uniforms,a.reverse_faces,a.skin)};a.default_backface_color=[0.1,0.1,0.1];a.prototype.renderMeshWithMaterial=function(f,k,c,g,h,e,n,b){var m=this.renderer,p=null;if(!c||c.constructor===String)throw"no material in renderMeshWithMaterial";if(!("BLEND"==c.alphaMode&&0>=c.color[3])){var l=this.material_uniforms,t=this.sampler_uniforms,v=f.length/16;l.u_albedo=c.color.subarray(0,3);l.u_emissive.set(c.emissive||q.ZERO);l.u_emissive[3]=c.emissive_clamp_to_edge?
1:0;1!=this.emissive_factor&&vec3.scale(l.u_emissive,l.u_emissive,this.emissive_factor);l.u_backface_color=c.backface_color||a.default_backface_color;p=0;k.vertexBuffers.coords1&&(p|=a.MACROS.UVS2);k.vertexBuffers.colors&&(p|=a.MACROS.COLOR);b&&(p|=a.MACROS.SKINNING);this.parallax_reflection&&(p|=a.MACROS.PARALLAX_REFLECTION);c.primitive==GL.POINTS&&(p|=a.MACROS.POINTS);1<v&&(p|=a.MACROS.INSTANCING);this.overwrite_shader_name?p=gl.shaders[this.overwrite_shader_name]:this.overwrite_shader_mode?p=this.getShader(p,
this.overwrite_shader_mode):c.shader_name?p=gl.shaders[c.shader_name]:c.overlay?p=this.getShader(p,"overlay.fs"):"pbrMetallicRoughness"==c.model&&this.quality?(l.u_metalness=c.metallicFactor,l.u_roughness=c.roughnessFactor,l.u_metallicRough=Boolean(c.textures.metallicRoughness),p=this.getShader(p,"pbr.fs")):p=this.getShader(p,"nopbr.fs");if(p){l.u_alpha=c.opacity;l.u_alpha_cutoff=0;l.u_normalFactor=null!=c.normalmapFactor?c.normalmapFactor:1;l.u_displacement_factor=null!=c.displacementFactor?c.displacementFactor:
1;c.uv_transform?this.texture_matrix.set(c.uv_transform):mat3.identity(this.texture_matrix);for(var A=2,y=l.u_maps_info,u=0;u<a.maps.length;++u){var x=a.maps[u];y[u]=-1;if(x=c.textures[x]){var B=null;x.constructor===Object?B=x.texture:x.constructor===String&&(B=x,x=null);if(B){var z=a.maps_sampler[u];if(!p||p.samplers[z]){var C=gl.textures[B];C||(m.autoload_assets&&-1!=B.indexOf(".")&&m.loadTexture(B,m.default_texture_settings),C=gl.textures.white);B=16>this.max_textures?A++:u+2;t[z]=C.bind(B);y[u]=
x&&null!=x.uv_channel?Math.clamp(x.uv_channel,0,3):0}}}}n||gl.frontFace(GL.CCW);m.enableItemFlags(c);n&&gl.frontFace(GL.CW);"BLEND"==c.alphaMode?(gl.enable(gl.BLEND),c.additive||"ADD"==c.blendMode?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):"MULTIPLY"==c.blendMode?gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1),l.u_alpha_cutoff=0):"MASK"==c.alphaMode?l.u_alpha_cutoff=c.alphaCutoff:gl.disable(gl.BLEND);if(b){if(b.constructor===q.Skeleton)this.bones=
b.computeFinalBoneMatrices(this.bones,k),p.setUniform("u_bones",this.bones);else if(b._bone_matrices)p.setUniform("u_bones",b._bone_matrices);else return;b.joints&&(b.skip_model=!0)}1==v&&m._uniforms.u_model.set(f);b&&b.skip_model&&mat4.identity(m._uniforms.u_model);p.uniforms(m._uniforms);p.uniforms(this.global_uniforms);p.uniforms(c.uniforms);p.uniforms(l);p.uniforms(t);e&&p.uniforms(e);c.primitive==GL.POINTS&&p.setUniform("u_pointSize",c.point_size||-1);e=null;null!=h&&k.info&&k.info.groups&&k.info.groups[h]&&
(e=k.info.groups[h]);h=this._instancing_uniforms;h.u_model=f;c.flags.preAlpha&&(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),1<v?p.drawInstanced(k,void 0===c.primitive?gl.TRIANGLES:c.primitive,g,h):e?p.drawRange(k,c.primitive,e.start,e.length,g):p.draw(k,c.primitive,g),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL),this.rendered_render_calls++);1<v?e?p.drawInstanced(k,void 0===c.primitive?gl.TRIANGLES:c.primitive,g,h,e.start,e.length):p.drawInstanced(k,void 0===c.primitive?gl.TRIANGLES:c.primitive,
g,h):e?p.drawRange(k,c.primitive,e.start,e.length,g):p.draw(k,c.primitive,g);this.rendered_render_calls++;m.disableItemFlags(c);n&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};a.prototype.renderDeferred=function(a,k,c,g){c=this.prepareBuffers();c.fbo.bind();this.renderToGBuffers(a,k,g);c.fbo.unbind();c.final_fbo.bind();a=this.gatherLightsFromNodes(a,g);this.renderFinalPass(c,a,k);c.final_fbo.unbind();this.applyPostFX(c)};a.prototype.prepareBuffers=function(a){a=gl.drawingBufferWidth;
var k=gl.drawingBufferHeight;if(this._gbuffers&&this._gbuffers.width==a&&this._gbuffers.height==k)return this._gbuffers;this._gbuffers||(this._gbuffers={});var c=this._gbuffers;c.fbo||(c.fbo=new GL.FBO);c.final_fbo||(c.final_fbo=new GL.FBO);var g={format:GL.RGBA,minFilter:gl.NEAREST,magFilter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE},h=new GL.Texture(a,k,g),e=new GL.Texture(a,k,g),n=new GL.Texture(a,k,g),g=new GL.Texture(a,k,g),b=new GL.Texture(a,k,{format:GL.DEPTH_STENCIL,type:GL.UNSIGNED_INT_24_8_WEBGL}),
m=new GL.Texture(a,k,{format:GL.RGB,type:gl.HIGH_PRECISION_FORMAT,magFilter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE});c.fbo.setTextures([h,e,n,g],b);c.final_fbo.setTextures([m]);c.albedo=h;c.matprop=e;c.emissive=n;c.normal=g;c.width=a;c.height=k;return c};a.prototype.renderToGBuffers=function(a,k,c){a=this.getAllRenderCalls(a,k,c);gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);
gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);this.fillGlobalUniforms(k);for(k=0;k<a.length;++k)if(c=a[k],c.material.overlay&&this.allow_overlay)overlay_rcs.push(c);else{var g=c.model;c._instancing&&c._instancing.length&&(g=GL.linearizeArray(c._instancing,Float32Array));this.renderMeshWithMaterialToGBuffers(g,c.mesh,c.material,c.index_buffer_name,c.group_index,c.node.extra_uniforms,c.reverse_faces,c.skin)}};a.prototype.renderFinalPass=function(a,k,c){a.albedo.toViewport()};a.prototype.applyPostFX=
function(a){gl.disable(GL.DEPTH_TEST);gl.disable(GL.BLEND);var k=a.width,c=a.height;gl.viewport(0,0,0.5*k,0.5*c);a.albedo.toViewport();gl.viewport(0.5*k,0,0.5*k,0.5*c);a.matprop.toViewport();gl.viewport(0,0.5*c,0.5*k,0.5*c);a.emissive.toViewport();gl.viewport(0.5*k,0.5*c,0.5*k,0.5*c);a.normal.toViewport();gl.viewport(0,0,k,c)};a.prototype.gatherLightsFromNodes=function(a,k){};a.prototype.renderMeshWithMaterialToGBuffers=function(f,k,c,g,h,e,n,b){var m=this.renderer,p=null;if(!c||c.constructor===String)throw"no material in renderMeshWithMaterial";
if("BLEND"!=c.alphaMode){var l=this.material_uniforms,t=this.sampler_uniforms,v=f.length/16;l.u_albedo=c.color.subarray(0,3);l.u_emissive.set(c.emissive||q.ZERO);l.u_emissive[3]=c.emissive_clamp_to_edge?1:0;1!=this.emissive_factor&&vec3.scale(l.u_emissive,l.u_emissive,this.emissive_factor);l.u_backface_color=c.backface_color||a.default_backface_color;p=0;k.vertexBuffers.coords1&&(p|=a.MACROS.UVS2);k.vertexBuffers.colors&&(p|=a.MACROS.COLOR);b&&(p|=a.MACROS.SKINNING);c.primitive==GL.POINTS&&(p|=a.MACROS.POINTS);
1<v&&(p|=a.MACROS.INSTANCING);if(p=this.getShader(p,"gbuffer.fs")){l.u_alpha=c.opacity;l.u_alpha_cutoff=0;l.u_normalFactor=null!=c.normalmapFactor?c.normalmapFactor:1;l.u_displacement_factor=null!=c.displacementFactor?c.displacementFactor:1;c.uv_transform?this.texture_matrix.set(c.uv_transform):mat3.identity(this.texture_matrix);for(var A=2,y=l.u_maps_info,u=0;u<a.maps.length;++u){var x=a.maps[u];y[u]=-1;if(x=c.textures[x]){var B=null;x.constructor===Object?B=x.texture:x.constructor===String&&(B=
x,x=null);if(B){var z=a.maps_sampler[u];if(!p||p.samplers[z]){var C=gl.textures[B];C||(m.autoload_assets&&-1!=B.indexOf(".")&&m.loadTexture(B,m.default_texture_settings),C=gl.textures.white);B=16>this.max_textures?A++:u+2;t[z]=C.bind(B);y[u]=x&&null!=x.uv_channel?Math.clamp(x.uv_channel,0,3):0}}}}n||gl.frontFace(GL.CCW);m.enableItemFlags(c);n&&gl.frontFace(GL.CW);"MASK"==c.alphaMode&&(l.u_alpha_cutoff=c.alphaCutoff);if(b){if(b.constructor===q.Skeleton)this.bones=b.computeFinalBoneMatrices(this.bones,
k),p.setUniform("u_bones",this.bones);else if(b._bone_matrices)p.setUniform("u_bones",b._bone_matrices);else return;b.joints&&(b.skip_model=!0)}1==v&&m._uniforms.u_model.set(f);b&&b.skip_model&&mat4.identity(m._uniforms.u_model);p.uniforms(m._uniforms);p.uniforms(this.global_uniforms);p.uniforms(c.uniforms);p.uniforms(l);p.uniforms(t);e&&p.uniforms(e);c.primitive==GL.POINTS&&p.setUniform("u_pointSize",c.point_size||-1);e=null;null!=h&&k.info&&k.info.groups&&k.info.groups[h]&&(e=k.info.groups[h]);
h=this._instancing_uniforms;h.u_model=f;1<v?e?p.drawInstanced(k,void 0===c.primitive?gl.TRIANGLES:c.primitive,g,h,e.start,e.length):p.drawInstanced(k,void 0===c.primitive?gl.TRIANGLES:c.primitive,g,h):e?p.drawRange(k,c.primitive,e.start,e.length,g):p.draw(k,c.primitive,g);this.rendered_render_calls++;m.disableItemFlags(c);n&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};a.prototype.getRenderCallFromPool=function(){if(this.used_render_calls<this.render_calls_pool.length){var a=this.render_calls_pool[this.used_render_calls];
this.used_render_calls++;return a}a=new q.RenderCall;a.id=this.used_render_calls;this.render_calls_pool.push(a);this.used_render_calls++;return a};a.prototype.resetRenderCallsPool=function(){this.used_render_calls=0};a.prototype.renderSkybox=function(a){if((!this.onRenderSkybox||!this.onRenderSkybox(this,a))&&this.environment_texture&&this.render_skybox){var k=gl.meshes.cube,c=gl.shaders[this.overwrite_shader_name||"skybox"];if(c){var g=this.skybox_texture||this.environment_texture;if(g&&g.texture_type===
GL.TEXTURE_CUBE_MAP){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var h=this.renderer._model_matrix;mat4.identity(h);mat4.translate(h,h,a.position);mat4.scale(h,h,[10,10,10]);this.renderer.setModelMatrix(h);c.uniforms(this.renderer._uniforms);c.uniforms({u_color_texture:g.bind(1),u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD,u_camera_position:a.position});c.draw(k,GL.TRIANGLES)}}}};a.prototype.loadEnvironment=function(a,
k,c){var g=this,h=gl.textures[a];h?(c?g.skybox_texture=h:(h.shs&&(g.environment_sh_coeffs=h.shs),g.environment_texture=h),k&&k(h)):HDRE.load(a,function(e){var n=e.toTexture(!0);n&&(gl.textures[a]=n,c?g.skybox_texture=n:(n.shs=e.shs?e.shs:null,g.environment_texture=n,n.shs&&(g.environment_sh_coeffs=n.shs)));k&&k(n)})};a.prototype.captureEnvironment=function(a,g,c){c=c||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(c,c,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,
texture_type:GL.TEXTURE_CUBE_MAP}));var h=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,a,g);this.use_rendertexture=h;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);this.environment_texture||(this.environment_texture=new GL.Texture(c,c,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};
a.prototype.getBRDFIntegratorTexture=function(a){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var g=gl.shaders.brdf_integrator;if(g){var c=gl.textures.brdf_integrator=new GL.Texture(128,128,{type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});if(a)return fetch(a).then(function(a){return a.arrayBuffer()}).then(function(a){c.uploadData(new Float32Array(a),{no_flip:!0})}),c;var h=gl.textures.hammersley_sample_texture;h||(h=this.createHammersleySampleTexture());c.drawTo(function(a){h&&
h.bind(0);g.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return c}};a.prototype.createHammersleySampleTexture=function(a){a=a||8192;for(var g=3*a,c=new Float32Array(g),h=0;h<g;h+=3){var l=2*Math.radical_inverse(h)*Math.PI;c[h]=Math.cos(l);c[h+1]=Math.sin(l);c[h+2]=0}a=new GL.Texture(a,1,{pixel_data:c,type:GL.FLOAT,format:GL.RGB});return gl.textures.hammersley_sample_texture=a};a.prototype.setClippingPlane=function(a,g){a?this.global_uniforms.u_clipping_plane.set([g[0],
g[1],g[2],vec3.dot(a,g)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};a.prototype.startGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var a=gl.extensions.EXT_disjoint_timer_query;this._waiting_gpu_query||(void 0===this._useQueryTimestamps&&(this._useQueryTimestamps=!1,0<a.getQueryEXT(a.TIMESTAMP_EXT,a.QUERY_COUNTER_BITS_EXT)&&(this._useQueryTimestamps=!0)),gl.getParameter(a.GPU_DISJOINT_EXT),this._useQueryTimestamps?(this._start_gpu_query=a.createQueryEXT(),
this._end_gpu_query=a.createQueryEXT(),a.queryCounterEXT(this._start_gpu_query,a.TIMESTAMP_EXT)):(this._timeElapsed_gpu_query=a.createQueryEXT(),a.beginQueryEXT(a.TIME_ELAPSED_EXT,this._timeElapsed_gpu_query)))}};a.prototype.endGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled&&!this._waiting_gpu_query){var a=gl.extensions.EXT_disjoint_timer_query;this._useQueryTimestamps?a.queryCounterEXT(this._end_gpu_query,a.TIMESTAMP_EXT):a.endQueryEXT(a.TIME_ELAPSED_EXT);
this._waiting_gpu_query=!0}};a.prototype.resolveQueries=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var a=gl.extensions.EXT_disjoint_timer_query,g=this._start_gpu_query,c=this._end_gpu_query,h=this._timeElapsed_gpu_query,l=this._useQueryTimestamps;if(g||c||h){var e=gl.getParameter(a.GPU_DISJOINT_EXT),n;if(!e&&(n=l?a.getQueryObjectEXT(c,a.QUERY_RESULT_AVAILABLE_EXT):a.getQueryObjectEXT(h,a.QUERY_RESULT_AVAILABLE_EXT))){var b;l?(b=a.getQueryObjectEXT(g,a.QUERY_RESULT_EXT),
b=a.getQueryObjectEXT(c,a.QUERY_RESULT_EXT)-b):b=a.getQueryObjectEXT(h,a.QUERY_RESULT_EXT);this.frame_time=1E-6*b}if(n||e)l?(a.deleteQueryEXT(g),a.deleteQueryEXT(c),this._end_gpu_query=this._start_gpu_query=null):(a.deleteQueryEXT(h),this._timeElapsed_gpu_query=null),this._waiting_gpu_query=!1}return this.frame_time}};Math.radical_inverse=function(a){for(var g=0,c=0.5;a;c*=0.5,a>>=1)a&1&&(g+=c);return g};var g=vec3.create();h.prototype.copyFrom=function(a){this.name=a.name;this.id=a.id;this.mesh=
a.mesh;this.model=a.model;this.index_buffer_name=a.index_buffer_name;this.group_index=a.group_index;this.material=a.material;this.reverse_faces=a.reverse_faces;this.node=a.node;this.skin=a.skin;this._instancing=a._instancing;this._render_priority=a._render_priority};h.prototype.computeRenderPriority=function(a){this.name=this.node.name;var h=this.mesh.getBoundingBox();h&&(h=mat4.multiplyVec3(g,this.model,h),this._render_priority=this.material.render_priority||0,a=vec3.distance(a,h),"BLEND"==this.material.alphaMode?
(this._render_priority+=0.001*a,this._render_priority-=100):this._render_priority+=1E3-0.001*a)};q.PBRPipeline=a;q.RenderCall=h})(this);
(function(l){function a(){this.area=this.intensity=1;this._color=vec3.fromValues(0.9,0.9,0.9);this._position=vec3.fromValues(10,20,5);this._target=vec3.create();this._vector=vec3.create();this.camera=new RD.Camera;this._castShadows=!1;this.shadowmap={texture:null,resolution:2048,bias:1E-5,uniforms:{u_shadowmap_matrix:this.camera._viewprojection_matrix,u_shadowmap_texture:4,u_shadowbias:1E-5}};this.uniforms={u_light_position:this._position,u_light_color:vec3.create(),u_light_vector:this._vector};this.flags=
{skip_shadows:!1}}Object.defineProperty(a.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});Object.defineProperty(a.prototype,"castShadows",{set:function(a){a?this.enableShadows():this.disableShadows()},get:function(){return this._castShadows},enumerable:!0});a.DEFAULT_SHADOWMAP_RESOLUTION=2048;a.prototype.updateData=function(){vec3.sub(this._vector,this._target,this._position);vec3.normalize(this._vector,this._vector)};a.prototype.setUniforms=
function(a){this.shadowmap.uniforms.u_shadowbias=this.shadowmap.bias;this.uniforms.u_light_color.set(this._color);vec3.scale(this.uniforms.u_light_color,this.uniforms.u_light_color,this.intensity);if(a.constructor===GL.Shader)a.uniforms(this.uniforms),this._castShadows&&(a.uniforms(this.shadowmap.uniforms),this.shadowmap.texture.bind(this.shadowmap.uniforms.u_shadowmap_texture));else{for(var l in this.uniforms)a[l]=this.uniforms[l];if(this._castShadows)for(l in this.shadowmap.uniforms)a[l]=this.shadowmap.uniforms[l]}};
a.prototype.lookAt=function(a,l,g){this._position.set(a);this._target.set(l);this.camera.lookAt(a,l,g);this.updateData()};a.prototype.setView=function(a,l,g){this.area=a;this.camera.orthographic(a,l,g,1);this.updateData()};a.prototype.followCamera=function(a,l){var g=l||5,f=vec3.scaleAndAdd(vec3.create(),a.target,this._vector,-l);this.lookAt(f,a.target,a.up);this.camera.orthographic(g,0.01,3*g,1);this.camera.updateMatrices()};a.prototype.enableShadows=function(){this._castShadows=!0;var h=this.shadowmap.resolution||
a.DEFAULT_SHADOWMAP_RESOLUTION;this.shadowmap.texture&&this.shadowmap.texture.width==h||(this.shadowmap.texture=new GL.Texture(h,h,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadowmap.fbo=new GL.FBO(null,this.shadowmap.texture))};a.prototype.disableShadows=function(){this._castShadows=!1;this.shadowmap.texture=null;this.shadowmap.fbo=null};a.prototype.generateShadowmap=function(a,l,g){if(this.castShadows){if(!this.shadowmap.fbo)throw"no shadowmap fbo";this.camera.view_texel_grid=
[this.shadowmap.resolution,this.shadowmap.resolution];a.generating_shadowmap=!0;this.shadowmap.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);a.shader_overwrite="flat";if(l.constructor===Array)for(var f=0;f<l.length;++f)a.render(l[f],this.camera,null,g||255);else a.render(l,this.camera,null,g||255);a.shader_overwrite=null;this.shadowmap.fbo.unbind();a.generating_shadowmap=!1;this.shadowmap.texture.bind(4);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR)}};a.shadow_shader_function="uniform mat4 u_shadowmap_matrix;\n\tuniform sampler2D u_shadowmap_texture;\n\t\n\tfloat testShadowmap( vec3 pos )\n\t{\n\t\tconst float bias = 0.004;\n\t\tvec4 proj = u_shadowmap_matrix * vec4(pos, 1.0);\n\t\tvec2 sample = (proj.xy / proj.w) * vec2(0.5) + vec2(0.5);\n\t\tif(sample.x >= 0.0 && sample.x <= 1.0 && sample.y >= 0.0 && sample.y <= 1.0 )\n\t\t{\n\t\t\tfloat depth = texture2D( u_shadowmap_texture, sample ).x;\n\t\t\tif( depth > 0.0 && depth < 1.0 && depth <= ( ((proj.z-bias) / proj.w) * 0.5 + 0.5) )\n\t\t\t\treturn 0.0;\n\t\t}\n\t\treturn 1.0;\n\t}";
RD.Light=a})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(l){function a(){this.name="";this.tracks=[];this.duration=10}function h(){this.enabled=!0;this.target_property=this.target_node="";this.type=r.SCALAR;this.data=[];this.packed_data=!1;this._target=null}function q(a,c,b){return a*(1-b)+c*b}function g(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function f(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function k(){this.skeleton=
new g;this.duration=0;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this._loading=!1;this.bones_map=new Uint8Array(k.MAX_BONES);this.keyframes=null}function c(a,c,b){for(var f="",g=0;g<b;++g){var h=a.getUint8(c+g);if(!h)break;f+=String.fromCharCode(h)}return f}var r=l.RD=l.RD||{};r.Animations={};a.prototype.addTrack=function(a,c){if(c)for(var b=0;b<this.tracks.length;++b)if(this.tracks[b].target_node==a.target_node){this.tracks.splice(b+1,0,a);return}this.tracks.push(a)};
a.prototype.applyAnimation=function(a,c,b){for(var f=0;f<this.tracks.length;++f){var g=this.tracks[f];!1!==g.enabled&&g.applyTrack(a,c,b)}};a.prototype.serialize=function(){for(var a={name:this.name,duration:this.duration,tracks:[]},c=0;c<this.tracks.length;++c)a.tracks.push(this.tracks[c].serialize());return a};a.prototype.configure=function(a){this.name=a.name;this.duration=a.duration;for(var c=this.tracks.length=0;c<a.tracks.length;++c){var b=new r.Animation.Track;b.configure(a.tracks[c]);this.tracks.push(b)}return a};
a.prototype.findNearestLeft=function(a){for(var c=0,b=0;b<this.tracks.length;++b){var f=this.tracks[b],g=f.findTimeIndex(a);-1!=g&&(f=f.data[g],f>c&&(c=f))}return c};a.prototype.findNearestRight=function(a){for(var c=this.duration,b=0;b<this.tracks.length;++b){var f=this.tracks[b],g=f.findTimeIndex(a);-1!=g&&(f=f.data[g+1],null!=f&&f<c&&(c=f))}return c};r.Animation=a;a.Track=h;Object.defineProperty(h.prototype,"value_size",{set:function(a){throw"cannot be set, use type instead";},get:function(){return r.TYPES_SIZE[this.type]}});
h.prototype.addKeyframe=function(a,c,b){1<this.value_size&&(c=new Float32Array(c));for(var f=0;f<this.data.length;++f)if(!(this.data[f][0]<a))return this.data[f][0]!=a||b?this.data.splice(f,0,[a,c]):this.data[f][1]=c,f;this.data.push([a,c]);return this.data.length-1};h.prototype.getKeyframe=function(a){if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),null;var c=r.TYPES_SIZE[this.type];return this.packed_data?(a*=1+c,a>this.data.length-c?null:[this.data[a],this.data.subarray(a+
1,a+c+1)]):this.data[a]};h.prototype.findTimeIndex=function(a){var c=this.data;if(!c||0==c.length)return-1;var b=r.TYPES_SIZE[this.type];if(this.packed_data){var b=b+1,f=c.length/b,g=0,h=0,k=f;if(0==f)return-1;if(1==f)return 0;if(c[(k-1)*b]<a)return k-1;for(;k>=g;){h=0.5*(k+g)|0;f=c[h*b];if(f==a)break;if(g==k-1)return g;f<a?g=h:k=h}return h}f=c.length;h=g=0;k=f;if(0==f)return-1;if(1==f)return 0;if(c[k-1][0]<a)return k-1;for(;k>=g;){h=0.5*(k+g)|0;f=c[h][0];if(f==a)break;if(g==k-1)return g;f<a?g=h:
k=h}return h};h.prototype.getSample=function(a,c,b){return this.data&&0!==this.data.length?this.packed_data?this.getSamplePacked(a,c,b):this.getSampleUnpacked(a,c,b):void 0};h.prototype.getSampleUnpacked=function(a,c,b){var f=r.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-1][0]);var g=this.findTimeIndex(a);-1===g&&(g=0);var h=g,k=g+1,l=this.data,f=r.TYPES_SIZE[this.type];if(!c||0==f||1==l.length||k==l.length||0==h&&this.data[0][0]>a)return this.data[g][1];h=l[h];k=l[k];a=(k[0]-
a)/(k[0]-h[0]);1<f&&(b=b||this._result,b&&b.length==f||(b=this._result=new Float32Array(f)));if(c===r.LINEAR)return 1==f?h[1]*a+k[1]*(1-a):r.interpolateLinear(h[1],k[1],a,b,this.type,f,this);if(c===r.CUBIC){c=0<g?l[g-1]:h;g=g<l.length-2?l[g+2]:k;if(1===f)return r.EvaluateHermiteSpline(h[1],k[1],c[1],g[1],1-a);b=r.EvaluateHermiteSplineVector(h[1],k[1],c[1],g[1],1-a,b);this.type==r.QUAT?(quat.slerp(b,k[1],h[1],a),quat.normalize(b,b)):this.type==r.TRANS10&&(f=b.subarray(3,7),h=h[1].subarray(3,7),k=k[1].subarray(3,
7),quat.slerp(f,k,h,a),quat.normalize(f,f));return b}return null};h.prototype.getSamplePacked=function(a,c,b){if(!this.data.length)return null;var f=r.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-f-1]);var g=this.findTimeIndex(a);-1==g&&(g=0);var h=f+1,k=g,l=g+1,q=this.data,s=q.length/h;if(!c||1==s||l==s||0==k&&this.data[0]>a)return this.getKeyframe(g)[1];1<f&&(b=b||this._result,b&&b.length==f||(b=this._result=new Float32Array(f)));var u=q.subarray(k*h,(k+1)*h),k=q.subarray(l*
h,(l+1)*h);a=(k[0]-a)/(k[0]-u[0]);if(c===r.LINEAR){if(1==f)return u[1]*a+k[1]*(1-a);h=u.subarray(1,f+1);k=k.subarray(1,f+1);return r.interpolateLinear(h,k,a,b,this.type,f,this)}if(c===r.CUBIC){if(0===f)return u[1];c=0<g?q.subarray((g-1)*h,g*h):u;l=l<s-1?q.subarray((l+1)*h,(l+2)*h):k;if(1===f)return r.EvaluateHermiteSpline(u[1],k[1],c[1],l[1],1-a);f=u.subarray(1,h);k=k.subarray(1,h);b=r.EvaluateHermiteSplineVector(f,k,c.subarray(1,h),l.subarray(1,h),1-a,b);this.type==r.QUAT?(quat.slerp(b,k,f,a),quat.normalize(b,
b)):this.type==r.TRANS10&&(h=b.subarray(3,7),f=f.subarray(3,7),k=k.subarray(3,7),quat.slerp(h,k,f,a),quat.normalize(h,h));return b}return null};h.prototype.applyTrack=function(a,c,b){if(a){c=this.getSample(c,b);if(a.constructor===r.SceneNode){if(b=null,b=a.name==this.target_node?a:a.findNodeByName(this.target_node))this._node=b,b[this.target_property]=c}else a.constructor===r.Skeleton&&(a=a.getBone(this.target_node))&&this.type==r.MAT4&&(this._bone=a,a.model.set(c));return c}};h.prototype.serialize=
function(){return{enabled:this.enabled,target_node:this.target_node,target_property:this.target_property,type:this.type,data:this.data.constructor==Array?this.data.concat():typedArrayToArray(this.data),packed_data:this.packed_data}};h.prototype.configure=function(a){this.enabled=a.enabled;this.target_node=a.target_node;this.target_property=a.target_property;if(a.property){var c=a.property.indexOf("/");this.target_node=a.property.substr(0,c);this.target_property=a.property.substr(c+1)}null!=a.type&&
(this.type=a.type.constructor===String?r.TYPES[a.type.toUpperCase()]||0:a.type);a.packed_data||a.data.constructor===Float32Array?(this.packed_data=!0,this.data=new Float32Array(a.data)):(this.packed_data=!1,this.data=a.data.concat())};r.interpolateLinear=function(a,c,b,f,g,h,k){if(1==h)return a*b+c*(1-b);f=f||k._result;f&&f.length==h||(f=k._result=new Float32Array(h));switch(g){case r.QUAT:quat.slerp(f,c,a,b);quat.normalize(f,f);break;case r.TRANS10:for(g=0;3>g;g++)f[g]=a[g]*b+c[g]*(1-b);for(g=7;10>
g;g++)f[g]=a[g]*b+c[g]*(1-b);a=a.subarray(3,7);c=c.subarray(3,7);h=f.subarray(3,7);quat.slerp(h,c,a,b);quat.normalize(h,h);break;default:for(g=0;g<h;g++)f[g]=a[g]*b+c[g]*(1-b)}return f};r.EvaluateHermiteSpline=function(a,c,b,f,g){var h=g*g,k=h*g;return(2*k-3*h+1)*a+(-2*k+3*h)*c+(k-2*h+g)*(c-b)+(k-h)*(f-a)};r.EvaluateHermiteSplineVector=function(a,c,b,f,g,h){h=h||new Float32Array(h.length);var k=g*g,l=k*g,q=2*l-3*k+1,r=-2*l+3*k;g=l-2*k+g;for(var k=l-k,l=0,s=h.length;l<s;++l)h[l]=q*a[l]+r*c[l]+g*(c[l]-
b[l])+k*(f[l]-a[l]);return h};Math.lerp||(Math.lerp=q);r.Skeleton=g;g.Bone=f;f.prototype.serialize=function(){return{name:this.name,model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};f.prototype.configure=function(a){this.name=a.name;this.model.set(a.model);this.parent=a.parent;this.layer=a.layer;this.num_children=0;this.index=null!=a.index?a.index:-1;a.children&&(this.children.set(a.children),
this.num_children=a.children.constructor===Array?a.children.length:a.num_children)};f.prototype.copyFrom=f.prototype.configure;g.prototype.applyTransformToBones=function(a,c){var b=this.getBone(a);b&&mat4.multiply(b.model,b.model,c)};g.prototype.getBone=function(a){return this.bones[this.bones_by_name.get(a)]};g.identity=mat4.create();g.prototype.getBoneMatrix=function(a,c,b){var f=-1;a.constructor===String?f=this.bones_by_name.get(a):a.constructor===Number&&(f=a);if(void 0===f)return g.identity;
if(!c)return this.bones[f].model;a=this.global_bone_matrices[f];if(!b)return a;b=this.bones[f];a.set(b.model);for(b=this.bones[b.parent];b;)a=mat4.mul(a,b.model,a),b=this.bones[b.parent];return a};g.prototype.updateBoneGlobalMatrix=function(a){var c=this.bones[a];if(c)for(a=this.global_bone_matrices[a],a.set(c.model),c=this.bones[c.parent];c;)a=mat4.mul(a,c.model,a),c=this.bones[c.parent]};g.prototype.updateChildBonesGlobalMatrices=function(a){var c=null;if(c=a.constructor==g.Bone?a:this.getBone(a))for(a=
this.global_bone_matrices[c.index],mat4.mul(a,this.global_bone_matrices[c.parent],a),c=0;c<this.num_children;++c)this.updateChildBonesGlobalMatrices(this.children[c])};g.prototype.importSkeleton=function(a,c){function b(a){var e=new f;e.name=a.name||a.id;a.model?e.model.set(a.model):a.transform&&a.getLocalMatrix&&e.model.set(a.getLocalMatrix());e.index=h.length;h.push(e);g.bones_by_name.set(e.name,e.index);g.global_bone_matrices.push(mat4.create());if(a.children&&a.children.length){e.num_children=
a.children.length;for(var c=0;c<a.children.length;++c){var k=b(a.children[c]);e.children[c]=k.index;k.parent=e.index}}return e}var g=this;h?this.bones.length=0:this.bones=[];var h=this.bones;b(a);c&&mat4.mul(h[0].model,c,h[0].model);this.updateGlobalMatrices()};g.temp_mat4=mat4.create();g.temp_mat43=g.temp_mat4.subarray(0,12);g.prototype.computeFinalBoneMatrices=function(a,c,b){if(!this.bones.length||!c||!c.bones)return a||[];this.updateGlobalMatrices();var f=b?12*c.bones.length:16*c.bones.length;
a&&a.length==f||(a=new Float32Array(f));if(b){var h=g.temp_mat4,h=g.temp_mat43;for(b=0;b<c.bones.length;++b)f=c.bones[b],mat4.multiply(temp_mat4,this.getBoneMatrix(f[0],!0),f[1]),c.bind_matrix&&mat4.multiply(temp_mat4,temp_mat4,c.bind_matrix),mat4.transpose(temp_mat4,temp_mat4),a.set(h,12*b)}else for(b=0;b<c.bones.length;++b)f=c.bones[b],h=a.subarray(16*b,16*b+16),mat4.multiply(h,this.getBoneMatrix(f[0],!0),f[1]),c.bind_matrix&&mat4.multiply(h,h,c.bind_matrix);return a};g.prototype.computeFinalBoneMatricesAsArray=
function(a,c,b){if(!this.bones.length||!c||!c.bones)return a||[];this.updateGlobalMatrices();a=a||[];a.length=c.bones.length;for(var f=0;f<c.bones.length;++f){var g=c.bones[f];a[f]||(a[f]=mat4.create());var h=a[f];mat4.multiply(h,this.getBoneMatrix(g[0],!0),g[1]);c.bind_matrix&&mat4.multiply(h,h,c.bind_matrix);b&&mat4.multiply(h,b,h)}return a};g.prototype.updateGlobalMatrices=function(){var a=this.bones;if(a.length){var c=this.bones.length;this.global_bone_matrices[0].set(a[0].model);for(var b=1;b<
c;++b){var f=a[b];mat4.multiply(this.global_bone_matrices[b],this.global_bone_matrices[f.parent],f.model)}}};g.prototype.assignLayer=function(a,c){};g.temp_vec3=vec3.create();g.temp_vec4=vec4.create();g.temp_mat4=mat4.create();g.prototype.applyTracksAnimation=function(a,c){for(var b=g.temp_vec3,f=g.temp_vec4,h=g.temp_mat4,k=0;k<a.tracks.length;++k){var l=a.tracks[k],q=this.bones_by_name.get(l.target_node);null!=q&&(q=this.bones[q],"model"==l.target_property||"matrix"==l.target_property?l.getSample(c,
r.LINEAR,q.model):"position"==l.target_property?(l.getSample(c,r.LINEAR,b),mat4.setTranslation(q.model,b)):"rotation"==l.target_property?(l.getSample(c,r.LINEAR,f),mat4.fromQuat(h,f),mat4.getTranslation(b,q.model),mat4.setTranslation(h,b),q.model.set(h)):"scaling"==l.target_property&&(l.getSample(c,r.LINEAR,b),mat4.scale(q.model,q.model,b)))}};g.prototype.getVertices=function(a,c){if(!this.bones.length)return null;c||this.updateGlobalMatrices();var b=6*(this.bones.length-1);this._vertices&&this._vertices.length==
b||(this._vertices=new Float32Array(b));for(var b=this._vertices,f=0,g=1;g<this.bones.length;++g){var h=this.global_bone_matrices[this.bones[g].parent],k=this.global_bone_matrices[g],l=b.subarray(f,f+3),q=b.subarray(f+3,f+6);mat4.getTranslation(l,k);mat4.getTranslation(q,h);a&&(vec3.transformMat4(l,l,a),vec3.transformMat4(q,q,a));f+=6}return b};g.prototype.resizeBones=function(a){if(this.bones.length!=a)if(this.bones.length>a)this.bones.length=a,this.global_bone_matrices.length=a;else{var c=this.bones.length;
for(this.bones.length=a;c<a;++c)this.bones[c]=new f,this.global_bone_matrices[c]=mat4.create()}};g.prototype.copyFrom=function(a){this.resizeBones(a.bones.length);for(var c=0;c<a.bones.length;++c)this.bones[c].copyFrom(a.bones[c]),this.global_bone_matrices[c].set(a.global_bone_matrices[c]);this.bones_by_name=new Map(a.bones_by_name)};g.prototype.serialize=function(){for(var a={bones:[],bone_names:{}},c=0;c<this.bones.length;++c)a.bones.push(this.bones[c].serialize());return a};g.prototype.configure=
function(a){this.resizeBones(a.bones.length);a.bones_by_name?this.bones_by_name=new Map(a.bones_by_name):this.bones_by_name.clear();for(var c=0;c<a.bones.length;++c){var b=this.bones[c];b.copyFrom(a.bones[c]);b.index=c;a.global_bone_matrices?this.global_bone_matrices[c].set(a.global_bone_matrices[c]):this.bones_by_name.set(this.bones[c].name,c)}};var s=vec3.create();g.blend=function(a,c,b,f,h,k){if(a.bones.length!=c.bones.length)console.error("skeleton must contain the same number of bones");else{b=
Math.clamp(b,0,1);if(255==h){if(0==b){if(f==a)return;f.copyFrom(a);return}if(1==b){f.copyFrom(c);return}}if(f!=a){f.resizeBones(a.bones.length);for(h=0;h<f.bones.length;++h){var l=f.bones[h];l||(l=f.bones[h]=new g.Bone);l.copyFrom(a.bones[h])}f.bones_by_name=new Map(a.bones_by_name)}for(h=0;h<f.bones.length;++h){for(var q=f.bones[h],r=a.bones[h],y=c.bones[h],l=0;16>l;++l)q.model[l]=Math.lerp(r.model[l],y.model[l],b);if(!k)for(q=q.model,l=0;3>l;++l)s[0]=q[0+l],s[1]=q[4+l],s[2]=q[8+l],vec3.normalize(s,
s),q[0+l]=s[0],q[4+l]=s[1],q[8+l]=s[2]}}};g.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
g.vertex_shader_code="\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\t\n\tvarying vec3 v_wPosition;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\t\n\tuniform mat4 u_viewprojection;\n\tuniform mat4 u_model;\n\tuniform mat4 u_normal_matrix;\n\t\n\t"+g.shader_code+"\n\t\n\tvoid main() {\n\t\tv_wPosition = a_vertex;\n\t\tv_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;\n\t\tv_coord = a_coord;\n\t\t\n\t\tcomputeSkinning( v_wPosition, v_wNormal);\n\t\t\n\t\tv_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;\n\t\t\n\t\tgl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );\n\t}\n";
k.MAX_BONES=64;r.SkeletalAnimation=k;k.prototype.load=function(a,c){var b=this,f=-1!=a.toLowerCase().indexOf(".abin");this._loading=!0;return HttpRequest(a,null,function(a){b._loading=!1;a.constructor===String?b.fromData(a):b.fromBinary(a);c&&c(b)},null,{binary:f})};k.prototype.assignTime=function(a,c,b,f){if(this.duration&&this.samples_per_second){c||void 0===c?(a%=this.duration,0>a&&(a=this.duration+a)):a=Math.clamp(a,0,this.duration-1/this.samples_per_second);void 0===b&&(b=!0);a*=this.samples_per_second;
f=Math.floor(a);var g=(f+1)%this.num_keyframes;f%=this.num_keyframes;a-=Math.floor(a);var h=this.num_animated_bones;c=16*h;f*=c;for(var g=g*c,k=this.skeleton,l=this.keyframes,r=this.bones_map,h=Math.min(h,r.length),s=0;s<h;++s){var u=k.bones[r[s]];if(!u)throw"bone not found in skeleton";c=16*s;if(b)for(var x=0;16>x;++x)u.model[x]=q(l[f+c+x],l[g+c+x],a);else u.model.set(l.subarray(f+c,f+c+16))}}};k.prototype.resize=function(a,c){this.num_keyframes=Math.floor(a);this.num_animated_bones=c;this.keyframes=
new Float32Array(a*c*16)};k.prototype.assignPoseToKeyframe=function(a,c){if(c>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";for(var b=c*this.num_animated_bones*16,f=0;f<this.num_animated_bones;++f){var g=a.bones[this.bones_map[f]];null!=g&&this.keyframes.set(g.model,b+16*f)}};k.prototype.fromData=function(a){var c=a.split("\n"),b=c[0].split(",");this.duration=Number(b[0]);this.samples_per_second=Number(b[1]);this.num_keyframes=
Number(b[2]);this._datasize=a.length;this.skeleton.resizeBones(Number(b[3]));a=0;for(b=1;b<c.length;++b){var f=c[b],g=f[0],f=f.substr(1).split(",");if("B"==g){var h=Number(f[0]),k=this.skeleton.bones[h];if(!k)throw"bone not found in skeleton";k.name=f[1];k.parent=Number(f[2]);for(g=0;16>g;++g)k.model[g]=Number(f[3+g]);-1!=k.parent&&(f=this.skeleton.bones[k.parent],16<=f.num_children?console.warn("too many child bones, max is 16"):f.children[f.num_children++]=h);this.skeleton.bones_by_name.set(k.name,
h)}else if("@"==g){this.num_animated_bones=Number(f[0]);for(g=0;g<this.num_animated_bones;++g)this.bones_map[g]=Number(f[g+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==g){h=a*this.num_animated_bones*16;g=0;for(k=16*this.num_animated_bones;g<k;++g)this.keyframes[h+g]=Number(f[g+1]);a++}else break}this.assignTime(0,!1,!1)};k.prototype.toData=function(){var a=[];a.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());
for(var c=this.skeleton.bones,b=0;b<c.length;++b){var f=c[b];a.push("B"+b+","+f.name+","+f.parent+","+typedArrayToArray(f.model))}c=[];for(b=0;b<this.num_animated_bones;++b)c.push(this.bones_map[b]);a.push("@"+c.length+","+c.join(","));c=1/this.samples_per_second;for(b=0;b<this.num_keyframes;++b){for(var f=16*b*this.num_animated_bones,f=this.keyframes.subarray(f,f+16*this.num_animated_bones),g=0;g<f.length;++g)1E-6>Math.abs(f[g])&&(f[g]=0);a.push("K"+(b*c).toFixed(3)+","+f.join(","))}return a.join("\n")};
k.prototype.fromPose=function(a){this.samples_per_second=15;this.duration=1/this.samples_per_second;this.skeleton.copyFrom(a);for(var c=a.bones.length,b=0;b<a.bones.length;++b)this.bones_map[b]=b;this.resize(1,c);this.assignPoseToKeyframe(this.skeleton,0)};k.prototype.fromTracksAnimation=function(a,c,b,f){this.duration=c.duration;this.samples_per_second=b;this.skeleton.copyFrom(a);for(var g=0,h={},k=0;k<c.tracks.length;++k){var l=c.tracks[k],q=a.bones_by_name.get(l.target_node);null!=q&&(this.bones_map[g]=
q,null==h[l.target_node]&&(h[l.target_node]=l.target_node,g++))}g>a.bones.length&&console.warn("more animated bones than bones?");this.resize(Math.floor(c.duration*b),g);for(k=0;k<this.num_keyframes;++k)this.skeleton.applyTracksAnimation(c,1/b*k),f&&mat4.mul(this.skeleton.bones[0].model,f,this.skeleton.bones[0].model),this.assignPoseToKeyframe(this.skeleton,k)};k.prototype.toBinary=function(){for(var a=this.skeleton.bones.length,c=new Uint8Array(176+115*a+this.num_keyframes*this.num_animated_bones*
64),b=new DataView(c.buffer),f=0;4>f;++f)b.setUint8(f,"ABIN".charCodeAt(f));b.setInt32(4,3,!0);b.setInt32(8,172,!0);b.setFloat32(12,this.duration,!0);b.setUint32(16,this.samples_per_second,!0);b.setUint32(20,this.num_animated_bones,!0);b.setUint32(24,this.num_keyframes,!0);b.setUint32(28,a,!0);for(f=0;f<this.bones_map.length;++f)b.setUint8(32+f,this.bones_map[f]);for(var g=176,f=0;f<this.skeleton.bones.length;++f){var h=this.skeleton.bones[f];b.setInt8(g,h.parent);for(var k=0;32>k;++k)b.setInt8(g+
k+1,h.name.charCodeAt(k)||0);for(k=0;16>k;++k)b.setFloat32(g+32+1+4*k,h.model[k],!0);b.setUint8(g+32+1+64,h.layer);b.setUint8(g+32+2+64,h.num_children);for(k=0;16>k;++k)b.setInt8(g+32+3+64+k,h.children[k]);g+=115}g=176+115*a;a=new Uint8Array(this.keyframes.buffer);c.set(a,g);return c};k.prototype.fromBinary=function(a){a.constructor===ArrayBuffer&&(a=new Uint8Array(a));var f=new DataView(a.buffer);if("ABIN"!=c(f,0,4))return console.error("not an animation file"),!1;f.getInt32(4,!0);f.getInt32(8,!0);
this.duration=f.getFloat32(12,!0);this.samples_per_second=f.getUint32(16,!0);this.num_animated_bones=f.getUint32(20,!0);this.num_keyframes=f.getUint32(24,!0);for(var b=f.getUint32(28,!0),g=0;g<this.bones_map.length;++g)this.bones_map[g]=f.getUint8(32+g);var h=176;this.skeleton.resizeBones(b);this.skeleton.bones_by_name.clear();for(g=0;g<b;++g){var k=this.skeleton.bones[g];k.parent=f.getInt8(h);k.name=c(f,h+1,32);for(var l=0;16>l;++l)k.model[l]=f.getFloat32(h+32+1+4*l,!0);k.layer=f.getUint8(h+32+1+
64);k.num_children=f.getUint8(h+32+2+64);for(l=0;16>l;++l)k.children[l]=f.getInt8(h+32+3+64+l);h+=115;this.skeleton.bones_by_name.set(k.name,g)}h=176+115*b;f=new Uint8Array(a.subarray(h,h+this.num_keyframes*this.num_animated_bones*64));this.keyframes=new Float32Array(f.buffer);this._datasize=a.length};r.SceneNode&&(r.SceneNode.prototype.assignSkeleton=function(a){var c=gl.meshes[this.mesh];c&&(this.bones=a.computeFinalBoneMatrices(this.bones,c),this.uniforms.u_bones=this.bones)},r.SceneNode.prototype.assignAnimation=
function(a){this.assignSkeleton(a.skeleton)},r.SceneNode.prototype.updateSkinningBones=function(a){a=a||this;this.skin&&this.mesh&&r.collectBones(a,this.skin,gl.meshes[this.mesh]);if(this.children&&this.children.length)for(var c=0;c<this.children.length;++c)this.children[c].updateSkinningBones(a)});r.collectBones=function(a,c,b){function f(a,b,c){if(!b||!a)return c;if(a==b)return mat4.mul(c,a.getGlobalMatrix(),c),c;mat4.mul(c,a.matrix,c);return f(a._parent,b,c)}if(b&&b.bones){var g=b.bones.length;
c._bone_matrices||(c._bone_matrices=new Float32Array(16*g));g=c._bone_matrices;mat4.create();(c=a.findNodeByName(c.skeleton_root))||c==a;for(var h=mat4.create(),k=0;k<b.bones.length;++k){var l=b.bones[k],q=g.subarray(16*k,16*k+16),r=a.findNodeByName(l[0]);r&&(mat4.identity(h),f(r,c,h),mat4.multiply(q,h,l[1]),b.bind_matrix&&mat4.multiply(q,q,b.bind_matrix))}return g}};r.AnimatedCharacterFromScene=function(a,c,b){for(var f=[],g=[],h=b=null,h=a.constructor===r.SceneNode?a:a.root,k=0;k<h.children.length;++k){var l=
h.children[k];if(l.name&&("Armature"==l.name||-1!=l.name.indexOf("_Hips"))||"JOINT"==l.type||l.is_joint)b=l;else if(l.mesh){f.push(l);var q=null;gl.meshes[l.mesh]?q=gl.meshes[l.mesh]:a.meshes&&a.meshes[l.mesh]&&(q=GL.Mesh.load(a.meshes[l.mesh]));q&&g.push({mesh:q})}}!b&&h.findNodesByFilter&&(k=h.findNodesByFilter(function(a){return a.skin}))&&k.length&&(b=k[0]);!f.length&&h.findNodesByFilter&&(f=h.findNodesByFilter(function(a){return a.mesh}));if(!b)throw"this scene doesnt contain an animated character";
k=h=null;f.length&&(l=null,1<f.length?(k=GL.Mesh.mergeMeshes(g),l=f[0].mesh,k.filename=l):(l=f[0].mesh,gl.meshes[l]?(k=gl.meshes[l],k.filename=l):a.meshes&&(k=GL.Mesh.fromBinary(a.meshes[l]),k.filename=l)),gl.meshes[l]=k,g=null,f[0].material?g=f[0].material:f[0].primitives&&f[0].primitives.length&&(g=f[0].primitives[0].material),r.Materials[g]?h=r.Materials[g]:a.materials&&(h=a.materials[g]));f=new r.Skeleton;f.importSkeleton(b,null);g=null;a.root&&a.root.animation?g=a.root.animation:a.animations&&
(g=a.animations[0].id);b=null;null!=g&&(r.Animations[g]?b=r.Animations[g]:a.resources&&(a=a.resources[g],b=new r.Animation,b.configure(a.takes["default"])));b?(a=new r.SkeletalAnimation,a.fromTracksAnimation(f,b,30,null)):(console.warn("no animation in scene, creating pose one"),a=new r.SkeletalAnimation,a.fromPose(f));a.filename=c;return{mesh:k?k.filename:null,material:h,skeleton:f,skeletal_anim:a,tracks_anim:b}}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
