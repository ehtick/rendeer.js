'use strict';(function(m){function a(c){if(this.constructor!==b.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();c&&this.configure(c)}function f(c){this.type=b.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=0.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=
mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();this.uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection_matrix:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(0.1,1E3)};c&&this.configure(c);this.updateMatrices()}function g(){this._root=new b.SceneNode;
this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}function e(c){this._color=vec4.fromValues(1,1,1,1);this.shader_name=null;this.uniforms={u_color:this._color};this.textures={};this.primitive=GL.TRIANGLES;this.blend_mode=b.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};c&&this.configure(c)}function h(c,y){y=y||{};var b=this.gl=this.context=c;if(!b||!b.enable)throw"litegl GL context not found.";c!=
m.gl&&b.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this.reverse_normals=this.sort_by_distance=!1;this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._texture_matrix=mat3.create();this._color=vec4.fromValues(1,1,1,1);this._viewprojection2D_matrix=mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,
u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_color:this._color,u_texture_matrix:this._texture_matrix};this.global_uniforms_containers=[this._uniforms];m.gl=this.gl;this.canvas=b.canvas;this.assets_folder=y.assets_folder||"";this.autoload_assets=void 0!==y.autoload_assets?y.autoload_assets:!0;this.default_texture_settings={wrap:b.REPEAT,minFilter:b.LINEAR_MIPMAP_LINEAR,magFilter:b.LINEAR};this.default_cubemap_settings={minFilter:b.LINEAR_MIPMAP_LINEAR,magFilter:b.LINEAR,
is_cross:1};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:b.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:b.NEAREST,pixel_data:new Uint8Array([255,
255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.createShaders();y.shaders_file&&this.loadShaders(y.shaders_file,null,y.shaders_macros)}function q(c,y){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();c&&this.origin.set(c);y&&this.direction.set(y)}function k(c){this._ctor();c&&this.configure(c)}function r(c){this._ctor();c&&this.configure(c)}function l(c){a.prototype._ctor.call(this,
c);this._ctor();c&&this.configure(c)}function d(c,y){return vec3.dot(c,y)+c[3]}function p(c,y,b){var a=c[3],d=Math.abs(b[0]*c[0]),e=Math.abs(b[1]*c[1]);b=Math.abs(b[2]*c[2]);d=d+e+b;c=vec3.dot(c,y)+a;return c<=-d?w:c<=d?F:E}var b=m.RD={version:0.5};b.ZERO=vec3.fromValues(0,0,0);b.ONE=vec3.fromValues(1,1,1);b.RIGHT=vec3.fromValues(1,0,0);b.LEFT=vec3.fromValues(-1,0,0);b.UP=vec3.fromValues(0,1,0);b.DOWN=vec3.fromValues(0,-1,0);b.FRONT=vec3.fromValues(0,0,-1);b.BACK=vec3.fromValues(0,0,1);b.FRONT2D=
vec2.fromValues(0,1);b.WHITE=vec3.fromValues(1,1,1);b.BLACK=vec3.fromValues(0,0,0);b.IDENTITY=mat4.create();b.ONES4=vec4.fromValues(1,1,1,1);b.CENTER=0;b.TOP_LEFT=1;b.TOP_RIGHT=2;b.BOTTOM_LEFT=3;b.BOTTOM_RIGHT=4;b.TOP_CENTER=5;b.BOTTOM_CENTER=6;b.PRIORITY_BACKGROUND=30;b.PRIORITY_OPAQUE=20;b.PRIORITY_ALPHA=10;b.PRIORITY_HUD=0;b.BLEND_NONE=0;b.BLEND_ALPHA=1;b.BLEND_ADD=2;b.BLEND_MULTIPLY=3;b.NO_BILLBOARD=0;b.BILLBOARD_SPHERIC=1;b.BILLBOARD_PARALLEL_SPHERIC=2;b.BILLBOARD_CYLINDRIC=3;b.BILLBOARD_PARALLEL_CYLINDRIC=
4;b.UNKNOWN=0;b.NUMBER=b.SCALAR=1;b.VEC2=2;b.VEC3=3;b.VEC4=4;b.QUAT=5;b.MAT3=6;b.TRANS10=7;b.MAT4=8;b.TYPES={NUMBER:b.NUMBER,SCALAR:b.NUMBER,VEC2:b.VEC2,VEC3:b.VEC3,VEC4:b.VEC4,QUAT:b.QUAT,MAT3:b.MAT3,TRANS10:b.TRANS10,MAT4:b.MAT4};b.TYPES_SIZE=[0,1,2,3,4,4,9,10,16];b.NO_INTERPOLATION=0;b.LINEAR=1;b.CUBIC=2;var n=b.DEG2RAD=0.0174532925;b.RAD2DEG=57.295779578552306;b.Materials={};b.Images={};b.setup=function(c){c=c||{};if(b.configuration)throw"already called setup";b.configuration=c};var B=0;"undefined"==
typeof extendClass&&(m.extendClass=function(c,b){for(var a in b)c.hasOwnProperty(a)||(c[a]=b[a]);if(b.prototype){var t=Object.getOwnPropertyNames(b.prototype);for(a=0;a<t.length;++a){var d=t[a];c.prototype.hasOwnProperty(d)||(b.prototype.__lookupGetter__(d)?c.prototype.__defineGetter__(d,b.prototype.__lookupGetter__(d)):c.prototype[d]=b.prototype[d],b.prototype.__lookupSetter__(d)&&c.prototype.__defineSetter__(d,b.prototype.__lookupSetter__(d)))}}c.hasOwnProperty("superclass")||Object.defineProperty(c,
"superclass",{get:function(){return b},enumerable:!1})});var x=mat4.create(),C=mat3.create(),u=mat4.create(),v=vec2.create(),s=vec3.create(),z=vec3.create();vec4.create();var A=quat.create();b.SceneNode=a;a.prototype._ctor=function(){this._uid=B++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);quat.identity(this._rotation);this._scale.set(b.ONE);this._local_matrix=
mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.render_priority=b.PRIORITY_OPAQUE;this.blend_mode=b.BLEND_NONE;this.layers=3;this._color=vec4.fromValues(1,1,1,1);this._uniforms={u_color:this._color,u_color_texture:0};this.primitive=GL.TRIANGLES;this.primitives=[];this._instances=this.draw_range=null;this.onRender||(this.onRender=null);this.onShaderUniforms||(this.onShaderUniforms=null);this.mesh=this.shader=null;this.textures={};this.flags={visible:!0,
collides:!0};this.children=[]};a.ctor=a.prototype._ctor;a.prototype.clone=function(c){var b=new this.constructor,a;for(a in this)if("_"!=a[0])if("children"==a){if(c)for(var t=0;t<this.children.length;++t)b.addChild(this.children[t].clone(c))}else t=this[a],void 0!==t&&(null===t?b[a]=null:t.constructor===Object?b[a]=GL.cloneObject(t):t.constructor===Array?b[a]=t.concat():b[a]!==t&&(b[a]=t));return b};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(c){this._scene?
console.error("Cannot change id of a node already in a scene."):this._id=c},enumerable:!0});Object.defineProperty(a.prototype,"uniforms",{get:function(){return this._uniforms},set:function(c){GL.cloneObject(c,this._uniforms);this._uniforms.u_color=this._color},enumerable:!0});Object.defineProperty(a.prototype,"position",{get:function(){return this._position},set:function(c){this._position.set(c);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"x",{get:function(){return this._position[0]},
set:function(c){this._position[0]=c;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"y",{get:function(){return this._position[1]},set:function(c){this._position[1]=c;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"z",{get:function(){return this._position[2]},set:function(c){this._position[2]=c;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rotation},set:function(c){this._rotation.set(c);
this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"scaling",{get:function(){return this._scale},set:function(c){c.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=c:this._scale.set(c);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"transform",{get:function(){return this._transform},set:function(c){this._transform.set(c);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"pivot",{get:function(){return this._pivot},
set:function(c){this._must_update_matrix=!0;c?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(c),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(a.prototype,"color",{get:function(){return this._color},set:function(c){this._color.set(c)},enumerable:!0});Object.defineProperty(a.prototype,"opacity",{get:function(){return this._color[3]},set:function(c){this._color[3]=c},enumerable:!0});Object.defineProperty(a.prototype,"visible",{get:function(){return this.flags.visible},
set:function(c){this.flags.visible=c},enumerable:!0});Object.defineProperty(a.prototype,"texture",{get:function(){return this.textures.color},set:function(c){this.textures.color=c},enumerable:!1});Object.defineProperty(a.prototype,"scene",{get:function(){return this._scene},set:function(c){throw"cannot set scene, you must use addChild in its parent node";},enumerable:!1});Object.defineProperty(a.prototype,"parentNode",{get:function(){return this._parent},set:function(c){throw"Cannot set parentNode of SceneNode";
},enumerable:!1});a.prototype.addChild=function(c,b){function a(c,b){if(c._scene&&c._scene!=b){var y=c._scene._nodes.indexOf(c);-1!=y&&c._scene._nodes.splice(y,1);c.id&&c._scene._nodes_by_id[c.id]==c&&delete c._scene._nodes_by_id[c.id]}if(c._scene=b)b._nodes.push(c),c.id&&b&&(b._nodes_by_id[c.id]=c);if(c.children)for(var y=0,d=c.children.length;y<d;y++){var e=c.children[y];e._scene!=b&&a(e,b)}}if(c._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";c._parent=this;
b&&c.fromMatrix(c._global_matrix);this.children||(this.children=[]);this.children.push(c);this._scene!=c._scene&&a(c,this._scene)};a.prototype.removeChild=function(c,b){function a(c){if(c._scene){c.id&&c._scene._nodes_by_id[c.id]==c&&delete c._scene._nodes_by_id[c.id];var b=c._scene._nodes.indexOf(c);-1!=b&&c._scene._nodes.splice(b,1)}c._scene=null;for(var b=0,y=c.children.length;b<y;b++)a(c.children[b])}if(c._parent!=this)throw"removeChild: Not its children";if(this.children){var t=this.children.indexOf(c);
if(-1==t)throw"removeChild: impossible, should be children";this.children.splice(t,1);c._parent=null;b&&c.fromMatrix(c._global_matrix);a(c)}};a.prototype.removeAllChildren=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])};a.prototype.clear=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-1])};a.prototype.setChildIndex=function(c,b){if(this.children){var a=this.children.indexOf(c);-1!=a&&(this.children.splice(a,
1),this.children.splice(b,0,c))}};a.prototype.getAllChildren=function(c){c=c||[];if(!this.children)return c;for(var b=0,a=this.children.length;b<a;b++){var t=this.children[b];c.push(t);t.getAllChildren(c)}return c};a.prototype.getVisibleChildren=function(c,b){c=c||[];void 0===b&&(b=255);if(!this.children||!1===this.flags.visible)return c;for(var a=0,t=this.children.length;a<t;a++){var d=this.children[a];d.layers&b&&c.push(d);d.getVisibleChildren(c,b)}return c};a.prototype.serialize=function(){var c=
{position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(c.name=this.name);this.primitives&&this.primitives.length&&(c.primitives=this.primitives.concat());this.mesh&&(c.mesh=this.mesh);this.material&&(c.material=this.material);null!=this.submesh&&(c.submesh=this.submesh);this.extra&&(c.extra=this.extra);if(this.onSerialize)this.onSerialize(c);
if(this.children)for(var b=0,a=this.children.length;b<a;b++)c.children.push(this.children[b].serialize());return c};a.prototype.configure=function(c){var y=null,a;for(a in c){switch(a){case "children":continue;case "uniforms":for(var t in c.uniforms)this.uniforms[t]=c.uniforms[t];continue;case "texture":this[a]=c[a];continue;case "flags":for(t in c.flags)this.flags[t]=c.flags[t];continue;case "scale":case "scaling":this.scale(c[a]);continue;case "tiling":isNumber(c[a])?this.setTextureTiling(c[a],
c[a]):this.setTextureTiling(c[a][0],c[a][1],c[a][2],c[a][3]);continue;case "mesh":case "primitives":case "material":case "ref":case "draw_range":case "submesh":this[a]=c[a];continue;case "parent":y=c[a]}var d=this[a];void 0!==d&&(d&&d.constructor===Float32Array?d.set(c[a]):this[a]=c[a])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(c.children)for(this.removeAllChildren(),a=0;a<c.children.length;++a)t=new b.SceneNode,t.configure(c.children[a]),this.addChild(t);y&&(this.parentNode?console.error("This node already has a parent"):
y.addChild(this))};a.prototype.setMesh=function(c){c?"string"==typeof c?this.mesh=c:this._mesh=c:this.mesh=null};a.prototype.setTexture=function(c,b){b?"string"==typeof b&&(this.textures[c]=b):this.textures[c]=null};a.prototype.resetTransform=function(){this._position.set(b.ZERO);quat.identity(this._rotation);this._scale.set(b.ONE);this._must_update_matrix=!0};a.prototype.translate=function(c){vec3.add(this._position,this._position,c);this._must_update_matrix=!0};a.prototype.rotate=function(c,b,a){quat.setAxisAngle(A,
b,c);a?quat.multiply(this._rotation,A,this._rotation):quat.multiply(this._rotation,this._rotation,A);this._must_update_matrix=!0};a.prototype.rotateQuat=function(c,b){b?quat.multiply(this._rotation,c,this._rotation):quat.multiply(this._rotation,this._rotation,c);this._must_update_matrix=!0};a.prototype.scale=function(c){c.constructor===Number?(s[0]=s[1]=s[2]=c,vec3.mul(this._scale,this._scale,s)):vec3.mul(this._scale,this._scale,c);this._must_update_matrix=!0};a.prototype.setPivot=function(c){this.pivot=
c};a.prototype.setTextureTiling=function(c,b,a,t){this.texture_matrix||(this.texture_matrix=mat3.create(),this._uniforms.u_texture_matrix=this.texture_matrix);a=a||0;t=t||0;this.shader||(this.shader="texture_transform");mat3.identity(this.texture_matrix);mat3.translate(this.texture_matrix,this.texture_matrix,[a,t]);mat3.scale(this.texture_matrix,this.texture_matrix,[c,b])};a.prototype.getLocalMatrix=function(c){this._must_update_matrix&&this.updateLocalMatrix();return c?(c.set(this._global_matrix),
c):this._local_matrix};a.prototype.getGlobalMatrix=function(c){this.updateGlobalMatrix();return c?(c.set(this._global_matrix),c):this._global_matrix};a.prototype.getGlobalRotation=function(c){c=c||vec4.create();quat.identity(c);for(var b=this,a=this._scene?this._scene._root:null;b!=a;)quat.multiply(c,b._rotation,c),b=b._parent;return c};a.prototype.updateLocalMatrix=function(){var c=this._local_matrix;this._must_update_matrix=!1;mat4.identity(c);this.flags.no_transform||(this.flags.pivot&&this._pivot&&
(c[12]=this._pivot[0],c[13]=this._pivot[1],c[14]=this._pivot[2]),mat4.translate(c,c,this._position),mat4.fromQuat(u,this._rotation),mat4.multiply(c,c,u),mat4.scale(c,c,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(c,c,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))};a.prototype.updateGlobalMatrix=function(c,b){var a=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?(a=c?this._parent._global_matrix:
this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,b)};a.prototype.updateMatrices=function(c){this.updateLocalMatrix();this.updateGlobalMatrix(c)};a.prototype.fromMatrix=function(c,y){if(y&&this._parent&&this._parent._transform){mat4.copy(this._global_matrix,c);var a=this._parent.getGlobalMatrix();
mat4.invert(a,a);c=mat4.multiply(this._local_matrix,a,c)}a=mat4.clone(c);mat4.multiplyVec3(this._position,a,[0,0,0]);var t=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(t,a,b.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(t,a,b.UP));this._scale[2]=vec3.length(mat4.rotateVec3(t,a,b.BACK));a=mat3.fromMat4(C,a);quat.fromMat3AndQuat(this._rotation,a);c!=this._local_matrix&&mat4.copy(this._local_matrix,c);this._must_update_matrix=!1};a.prototype.getLocalPoint=function(c,b){b=b||vec3.create();
this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,c,this._local_matrix)};a.prototype.getLocalVector=function(c,b){b=b||vec3.create();return vec3.transformQuat(b,c,this._rotation)};a.prototype.getGlobalPosition=function(c,a){c=c||vec3.create();if(a)return vec3.transformMat4(c,b.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return c.set(this._position),c;var d=this.getGlobalMatrix();return vec3.transformMat4(c,b.ZERO,d)};a.prototype.getGlobalPoint=
function(c,b){b=b||vec3.create();var a=this.getGlobalMatrix();return vec3.transformMat4(b,c,a)};a.prototype.localToGlobal=a.prototype.getGlobalPoint;a.prototype.globalToLocal=function(c,b){b=b||vec3.create();var a=this.getGlobalMatrix();mat4.invert(u,a);return vec3.transformMat4(b,c,u)};a.prototype.getGlobalVector=function(c,b){b=b||vec3.create();var a=this.getGlobalRotation(A);return vec3.transformQuat(b,c,a)};a.prototype.getDistanceTo=function(c){var b=this.getGlobalMatrix();return vec3.distance(c,
b.subarray(12,15))};a.prototype.findNode=function(c){for(var b=0,a=this.children.length;b<a;b++){var t=this.children[b];if(t.id==c||(t=t.findNode(c)))return t}return null};a.prototype.findNodeByName=function(c){if(null==c)return null;for(var b=0,a=this.children.length;b<a;b++){var t=this.children[b];if(t.name==c||(t=t.findNodeByName(c)))return t}return null};a.prototype.findNodesByFilter=function(c,b,a){void 0===b&&(b=255);a=a||[];for(var t=0,d=this.children.length;t<d;t++){var e=this.children[t];
e.layer&b&&(c&&!c(e)||a.push(e),e.findNodesByFilter(c,b,a))}return a};a.prototype.propagate=function(c,b){for(var a=0,t=this.children.length;a<t;a++){var d=this.children[a];d&&(d[c]&&d[c].apply(d,b),d.children&&d.children.length&&d.propagate(c,b))}};a.prototype.loadTextConfig=function(c,a){GL.request(c,null,function(c){c=b.parseTextConfig(c);a&&a(c)},alert)};a.prototype.destroy=function(c){!this.scene||c?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)};a.prototype.updateBoundingBox=
function(c){var b=this._global_matrix,a=gl.meshes[this.mesh],d=null;a&&(d=a.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),d=BBox.transformMat4(this.bounding_box,d,b));if(c||!this.children||0==this.children.length)return d;for(c=0;c<this.children.length;++c)if(b=this.children[c].updateBoundingBox())d||(d=this.bounding_box=BBox.create()),BBox.merge(d,d,b);return d};a.prototype.testRay=function(){var c=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();
mat4.create();return function(b,a,d,e,n,l){d=void 0===d?Number.MAX_VALUE:d;void 0===e&&(e=255);a=a||vec3.create();void 0!==g._ray_tested_objects&&g._ray_tested_objects++;var h=null,f=null;this.layers&e&&!this.flags.ignore_collisions&&this.flags.visible&&this.mesh&&(f=this.testRayWithMesh(b,c,d,e,n,l));f&&(l=vec3.distance(b.origin,c),null==d||l<d)&&(d=l,a.set(c),h=this);if(!this.children||!this.children.length)return h;for(var f=vec3.create(),k=0;k<this.children.length;++k){var p=this.children[k].testRay(b,
f,d,e,n);p&&(l=vec3.distance(b.origin,f),l<d&&(d=l,a.set(f),h=p))}return h}}();a.prototype.testRayWithMesh=function(){var c=vec3.create(),b=vec3.create(),d=vec3.create(),t=mat4.create();return function(e,n,l,h,f,k){if(!this.mesh)return!1;var p=gl.meshes[this.mesh];if(!p||!1===p.ready)return!1;var x=null==this.submesh?-1:this.submesh,g=this._global_matrix;mat4.invert(t,g);vec3.transformMat4(c,e.origin,t);vec3.add(d,e.origin,e.direction);vec3.transformMat4(d,d,t);vec3.sub(b,d,c);vec3.normalize(b,b);
if(this.primitives&&k)for(k=0;k<this.primitives.length;++k)a.testRayMesh(e,c,b,p,this.primitives[k].index,n,l,h,f,!0);else return a.testRayMesh(e,c,b,g,p,x,n,l,h,f,this.flags.two_sided)}}();a.testRayMesh=function(c,b,a,d,e,n,l,h,f,k,p){h=null==h?Number.MAX_VALUE:h;var x=null;f=null;-1==n?(x=e.getBoundingBox(),f=e):(f=e.info.groups[n],x=f.bounding,x||(e.computeGroupsBoundingBoxes(),x=f.bounding));if(!x)return!1;h||(h=1E7);if(!geo.testRayBBox(b,a,x,null,s))return!1;vec3.transformMat4(l,s,d);n=vec3.distance(c.origin,
l);if(n>h)return!1;if(!k)return!0;f._octree||(f._octree=f==e?new GL.Octree(e):new GL.Octree(e,f.start,f.length));b=f._octree.testRay(b,a,0,h,p);if(!b)return!1;l.set(b.hit);vec3.transformMat4(l,l,d);n=vec3.distance(c.origin,l);return n>h?!1:!0};a.prototype.setRangeFromSubmesh=function(c){if(void 0!==c&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(c.constructor===String){for(var a=0;a<b.info.groups.length;++a)if(b.info.groups[a].name==c){c=a;break}if(a===b.info.groups.length)return!1}if(c=
b.info.groups[c])this.draw_range[0]=c.start,this.draw_range[1]=c.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null};a.prototype.findNodesInSphere=function(c,b,a,d){void 0===a&&(a=255);d=d||[];for(var e=0;e<this.children.length;++e){var n=this.children[e];n.layers&a&&(n.getGlobalPosition(s,!0),vec3.distance(s,c)<=b&&d.push(n));n.children.length&&n.findNodesInSphere(c,b,a,d)}return d};b.Camera=f;f.PERSPECTIVE=1;f.ORTHOGRAPHIC=2;f.prototype.configure=
function(c){null!=c.type&&(this.type=c.type);c.position&&this._position.set(c.position);c.target&&this._target.set(c.target);c.up&&this._up.set(c.up);c.near&&(this.near=c.near);c.far&&(this.far=c.far);c.fov&&(this.fov=c.fov);c.aspect&&(this.aspect=c.aspect)};f.prototype.serialize=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};
Object.defineProperty(f.prototype,"position",{get:function(){return this._position},set:function(c){this._position.set(c);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"target",{get:function(){return this._target},set:function(c){this._target.set(c);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"up",{get:function(){return this._up},set:function(c){this._up.set(c);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,
"fov",{get:function(){return this._fov},set:function(c){this._fov=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"aspect",{get:function(){return this._aspect},set:function(c){this._aspect=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(c){this._frustum_size=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"near",{get:function(){return this._near},
set:function(c){this._near=this.uniforms.u_camera_planes[0]=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"far",{get:function(){return this._far},set:function(c){this._far=this.uniforms.u_camera_planes[1]=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(c){this._view_matrix.set(c);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},
enumerable:!1});Object.defineProperty(f.prototype,"projection_matrix",{get:function(){return this._projection_matrix},set:function(c){this._projection_matrix.set(c);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(f.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(c){this._viewprojection_matrix.set(c)},enumerable:!1});f.prototype.perspective=function(c,b,a,d){this.type=f.PERSPECTIVE;
this._fov=c;this._aspect=b;this._near=a;this._far=d;this._must_update_matrix=!0};f.prototype.orthographic=function(c,b,a,d){this.type=f.ORTHOGRAPHIC;this._frustum_size=c;1<arguments.lenth&&(this._near=b,this._far=a,this._aspect=d||1);this._must_update_matrix=!0};f.prototype.lookAt=function(c,b,a){vec3.copy(this._position,c);vec3.copy(this._target,b);vec3.copy(this._up,a);this._must_update_matrix=!0};f.prototype.updateMatrices=function(c){if(this._autoupdate_matrices||c)if(this.type==f.ORTHOGRAPHIC?
this.frustum_size.constructor===Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,
this._fov*n,this._aspect,this._near,this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up),this.view_texel_grid&&this.type==f.ORTHOGRAPHIC){c=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var a=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=
Math.floor(this._view_matrix[12]/c)*c;this._view_matrix[13]=Math.floor(this._view_matrix[13]/a)*a}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,b.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,b.UP);mat4.rotateVec3(this._front,this._model_matrix,b.FRONT);
this.distance=vec3.distance(this._position,this._target);this.uniforms.u_camera_planes[0]=this._near;this.uniforms.u_camera_planes[1]=this._far};f.prototype.getModel=function(c){c=c||mat4.create();mat4.invert(this._model_matrix,this._view_matrix);mat4.copy(c,this._model_matrix);return c};f.prototype.updateVectors=function(c){var a=vec3.subtract(s,this._target,this._position),a=vec3.length(a);mat4.multiplyVec3(this._position,c,b.ZERO);mat4.multiplyVec3(this._target,c,[0,0,-a]);mat4.rotateVec3(this._up,
c,b.UP)};f.prototype.getLocalVector=function(c,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,c)};f.prototype.getLocalPoint=function(c,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),c,this._model_matrix)};f.prototype.getFront=function(c){c=c||vec3.create();vec3.subtract(c,this._target,this._position);vec3.normalize(c,c);return c};f.prototype.move=function(c,b){void 0!==b&&(vec3.scale(s,c,
b),c=s);vec3.add(this._target,this._target,c);vec3.add(this._position,this._position,c);this._must_update_matrix=!0};f.prototype.moveLocal=function(c,b){this._must_update_matrix&&this.updateMatrices();var a=mat4.rotateVec3(s,this._model_matrix,c);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};f.prototype.rotate=function(c,b){var a=quat.setAxisAngle(A,b,c),d=vec3.subtract(s,this._target,this._position);vec3.transformQuat(d,
d,a);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};f.prototype.rotateLocal=function(c,b){this._must_update_matrix&&this.updateMatrices();var a=mat4.rotateVec3(z,this._model_matrix,b),a=quat.setAxisAngle(A,a,c),d=vec3.subtract(s,this._target,this._position);vec3.transformQuat(d,d,a);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};f.prototype.orbit=function(c,b,a,d){if(!b)throw"RD: orbit axis missing";a=a||this._target;d&&(this._must_update_matrix&&this.updateMatrices(),
b=mat4.rotateVec3(z,this._model_matrix,b));c=quat.setAxisAngle(A,b,c);b=vec3.subtract(s,this._position,this._target);vec3.transformQuat(b,b,c);vec3.add(this._position,a,b);this._must_update_matrix=!0};f.prototype.orbitDistanceFactor=function(c,b){b=b||this._target;var a=vec3.subtract(s,this._position,b);vec3.scale(a,a,c);vec3.add(this._position,b,a);this._must_update_matrix=!0};f.prototype.project=function(c,b,a){a=a||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();
mat4.projectVec3(a,this._viewprojection_matrix,c);a[0]=a[0]*b[2]+b[0];a[1]=a[1]*b[3]+b[1];return a};f.prototype.unproject=function(c,b,a){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(a||vec3.create(),c,this._viewprojection_matrix,b)};f.prototype.getRay=function(c,a,d,e){if(void 0===c||void 0===a)throw"RD.Camera.getRay requires x and y parameters";d=d||gl.viewport_data;e||(e=new b.Ray);this._must_update_matrix&&this.updateMatrices();var n=e.origin;vec3.set(n,
c,a,0);this.type==b.Camera.ORTHOGRAPHIC?vec3.unproject(n,n,this._viewprojection_matrix,d):vec3.copy(n,this.position);var l=e.direction;vec3.set(l,c,a,1);vec3.unproject(l,l,this._viewprojection_matrix,d);vec3.sub(l,l,n);vec3.normalize(l,l);return e};f.prototype.getRayPlaneCollision=function(c,b,a,d,e,n){e=e||vec3.create();c=this.getRay(c,b,n);return geo.testRayPlane(c.origin,c.direction,a,d,e)?e:null};f.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};f.prototype.applyController=
function(c,a,d){d=d||10;c&&(gl.keys[f.controller_keys.forward]?this.moveLocal(vec3.scale(s,b.FRONT,c*d)):gl.keys[f.controller_keys.back]&&this.moveLocal(vec3.scale(s,b.BACK,c*d)),gl.keys[f.controller_keys.left]?this.moveLocal(vec3.scale(s,b.LEFT,c*d)):gl.keys[f.controller_keys.right]&&this.moveLocal(vec3.scale(s,b.RIGHT,c*d)));a&&(a.deltax&&this.rotate(-0.005*a.deltax,b.UP),a.deltay&&this.rotateLocal(-0.005*a.deltay,b.RIGHT))};f.prototype.lerp=function(c,b){vec3.lerp(this._position,this._position,
c._position,b);vec3.lerp(this._target,this._target,c._target,b);vec3.lerp(this._up,this._up,c._up,b);this._fov=this._fov*(1-b)+c._fov*b;this._near=this._near*(1-b)+c._near*b;this._far=this._far*(1-b)+c._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+c._frustum_sizer*b);this._must_update_matrix=!0};f.prototype.orientMatrixToCamera=function(c){c.set(this._right,0);c.set(this._top,4);c.set(this._front,8)};f.prototype.extractPlanes=function(){function c(c){var b=
a.subarray(c,c+3),b=vec3.length(b);0!==!b&&(b=1/b,a[c]*=b,a[c+1]*=b,a[c+2]*=b,a[c+3]*=b)}var b=this._viewprojection_matrix,a=this._planes_data||new Float32Array(24);a.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);c(0);a.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);c(4);a.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);c(8);a.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);c(12);a.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);c(16);a.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],
b[15]+b[14]],20);c(20);this._planes_data=a;this._frustrum_planes||(this._frustrum_planes=[a.subarray(0,4),a.subarray(4,8),a.subarray(8,12),a.subarray(12,16),a.subarray(16,20),a.subarray(20,24)])};var E=b.CLIP_INSIDE=0,w=b.CLIP_OUTSIDE=1,F=b.CLIP_OVERLAP=2;f.prototype.testMesh=function(){if(m.BBox){var c=BBox.create(),b=c.subarray(0,3),a=c.subarray(3,6);return function(d,e){var n=d.bounding;if(!n)return E;BBox.transformMat4(c,n,e);return this.testBox(b,a)}}}();f.prototype.testBox=function(c,b){this._frustrum_planes||
this.extractPlanes();var a=this._frustrum_planes,d=0,e=0,d=p(a[0],c,b);if(d==w)return w;e+=d;d=p(a[1],c,b);if(d==w)return w;e+=d;d=p(a[2],c,b);if(d==w)return w;e+=d;d=p(a[3],c,b);if(d==w)return w;e+=d;d=p(a[4],c,b);if(d==w)return w;e+=d;d=p(a[5],c,b);return d==w?w:0==e+d?E:F};f.prototype.testSphere=function(c,b){this._frustrum_planes||this.extractPlanes();var a=this._frustrum_planes,e,n=!1;e=d(a[0],c);if(e<-b)return w;e>=-b&&e<=b&&(n=!0);e=d(a[1],c);if(e<-b)return w;e>=-b&&e<=b&&(n=!0);e=d(a[2],c);
if(e<-b)return w;e>=-b&&e<=b&&(n=!0);e=d(a[3],c);if(e<-b)return w;e>=-b&&e<=b&&(n=!0);e=d(a[4],c);if(e<-b)return w;e>=-b&&e<=b&&(n=!0);e=d(a[5],c);if(e<-b)return w;e>=-b&&e<=b&&(n=!0);return n?F:E};b.Scene=g;g.prototype.clear=function(){this._root=new b.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};g.prototype.getNodeById=function(c){return this._nodes_by_id[c]};g.prototype.findNodesInBBox=function(c,b,a){void 0===b&&(b=255);a=a||[];for(var d=0;d<this.nodes.length;++d){var e=
this.nodes[d];e.bounding_box&&e.layers&b&&geo.testBBoxBBox(e.bounding_box,c)&&a.push(e)}return a};g.prototype.update=function(c){this.time+=c;this._root.propagate("update",[c]);this.destroyPendingNodes()};g.prototype.destroyPendingNodes=function(c){if(this._to_destroy.length)for(c=null;c=this._to_destroy.pop();)c._parent&&c._parent.removeChild(c)};Object.defineProperty(g.prototype,"root",{get:function(){return this._root},set:function(c){throw"Cannot set root of scene";},enumerable:!1});g.prototype.testRay=
function(c,a,d,e,n){b.Scene._ray_tested_objects=0;a||(a=s);return this.root.testRay(c,a,d,void 0===e?255:e,n)};g.prototype.fromJSON=function(c){this.root.clear();this.root.configure(c)};g.prototype.toJSON=function(c){function b(d,e){if(c){if(!c(d,e))return!1}else{if(!d.flags.no_transform){e.position=typedArrayToArray(d.position);if(0!=d.rotation[0]||0!=d.rotation[1]||0!=d.rotation[2]||1!=d.rotation[3])e.rotation=typedArrayToArray(d.rotation);if(1!=d.scaling[0]||1!=d.scaling[1]||1!=d.scaling[2])e.scaling=
typedArrayToArray(d.scaling)}d.id&&(e.id=d.id);d.ref=e.ref=a++;d.mesh&&(e.mesh=d.mesh);null!=d.submesh&&(e.submesh=d.submesh);d.draw_range&&(e.draw_range=d.draw_range.concat());d.material&&(e.material=d.material);d.shader&&(e.shader=d.shader);if(1!=d.color[0]||1!=d.color[1]||1!=d.color[2]||1!=d.color[3])e.color=typedArrayToArray(d.color);0<Object.values(d.textures).filter(function(c){return c})&&(e.shader=d.shader);d.extra&&(e.extra=d.extra);e.layers=d.layers;e.flags=d.flags}if(!d.children.length)return!0;
for(var n=[],l=0;l<d.children.length;++l){var h={};b(d.children[l],h)&&n.push(h)}n.length&&(e.children=n);return!0}c&&c.constructor!==Function&&(c=null);var a=0,d={};b(this.root,d);return d};e.default_shader_name="texture";Object.defineProperty(e.prototype,"color",{set:function(c){this._color.set(c)},get:function(){return this._color},enumerable:!0});Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color[3]},set:function(c){this._color[3]=c},enumerable:!0});Object.defineProperty(e.prototype,
"albedo",{set:function(c){this._color.set(c)},get:function(){return this._color},enumerable:!1});e.prototype.configure=function(c){for(var b in c)this[b]=c[b]};e.prototype.serialize=function(){var c={flags:this.flags,textures:this.textures};c.color=typedArrayToArray(this._color);this.name&&(c.name=this.name);this.alphaMode&&(c.alphaMode=this.alphaMode);0.5!=this.alphaCutoff&&(c.alphaCutoff=this.alphaCutoff);this.model&&(c.model=this.model,c.metallicFactor=this.metallicFactor,c.roughnessFactor=this.roughnessFactor,
this.emissive&&(c.emissive=typedArrayToArray(this.emissive)));return c};e.prototype.render=function(c,a,d,e,n){var l=gl.shaders[this.shader_name||c.default_shader_name||b.Material.default_shader_name];l||(l=this.textures.color||this.textures.albedo?c._texture_shader:c._flat_shader);var h=0,f=null,k;for(k in this.textures){var p=this.textures[k];if(p){p.constructor===Object&&(p=p.texture);var x="u_"+k+"_texture";if(!l||l.samplers[x])f=gl.textures[p],f||(c.autoload_assets&&-1!=p.indexOf(".")&&c.loadTexture(p,
c.default_texture_settings),f=gl.textures.white),this.uniforms[x]=f.bind(h++)}}c.enableItemFlags(this);c._uniforms.u_model.set(a);l.uniforms(c._uniforms);l.uniforms(this.uniforms);a=null;null!=n&&d.info&&d.info.groups&&d.info.groups[n]&&(a=d.info.groups[n]);a?l.drawRange(d,this.primitive,a.start,a.length,e):l.draw(d,this.primitive,e);c.disableItemFlags(this);c.draw_calls+=1};b.Material=e;b.Renderer=h;Object.defineProperty(h.prototype,"color",{set:function(c){this._color.set(c)},get:function(){return this._color},
enumerable:!0});h.prototype.setDataFolder=function(c){c?(this.assets_folder=c,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};h.prototype.clear=function(c){c?this.gl.clearColor(c[0],c[1],c[2],3<=c.length?c[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};h._sort_by_dist_func=function(c,b){return b._distance-c._distance};h._sort_by_priority_func=function(c,b){return b.render_priority-c.render_priority};h._sort_by_priority_and_dist_func=
function(c,b){var a=b.render_priority-c.render_priority;return 0!=a?a:b._distance-c._distance};h.prototype.render=function(c,a,d,e){void 0===e&&(e=255);if(!c)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";a=a||c.camera;if(!a)throw"Renderer.render: camera not provided";m.gl=this.gl;this._nodes.length=0;d||c._root.getVisibleChildren(this._nodes,e);d=d||this._nodes;this.enableCamera(a);this.enable2DView();
this._state=[];this._meshes_missing=0;this._current_scene=c;this._uniforms.u_time=c.time;this.sort_by_distance&&d.forEach(function(c){c._distance=c.getDistanceTo(a._position)});var n=this;d=d.filter(function(c){return!c.mustRender||!1!=c.mustRender(n,a)});this.sort_by_distance&&this.sort_by_priority?d.sort(b.Renderer._sort_by_priority_and_dist_func):this.sort_by_priority?d.sort(b.Renderer._sort_by_priority_func):this.sort_by_distance&&d.sort(b.Renderer._sort_by_dist_func);if(this.onPreRender)this.onPreRender(a);
c._root.preRender&&c._root.preRender(this,a);if(this.pipeline)this.pipeline.render(d,a,c);else{for(var l=0;l<d.length;++l){var h=d[l];h.updateGlobalMatrix(!0);if(this.onPreRenderNode)this.onPreRenderNode(h,a);h.preRender&&h.preRender(this,a)}for(l=0;l<d.length;++l)h=d[l],h.flags.was_rendered=!1,!1!==h.flags.visible&&h.layers&e&&(!this.mustRenderNode||!1!==this.mustRenderNode(h,a))&&(h.flags.was_rendered=!0,this.setModelMatrix(h._global_matrix),h.render?h.render(this,a):this.renderNode(h,a));c._root.postRender&&
c._root.postRender(this,a);for(l=0;l<d.length;++l)if(h=d[l],h.postRender&&h.postRender(this,a),this.onPostRenderNode)this.onPostRenderNode(h,a)}if(this.onPostRender)this.onPostRender(a);c.frame++;this.frame++;this._current_scene=null};h.prototype.enableCamera=function(c){this._camera=c;c.updateMatrices();c.extractPlanes();this._view_matrix.set(c._view_matrix);this._projection_matrix.set(c._projection_matrix);this._viewprojection_matrix.set(c._viewprojection_matrix);this._uniforms.u_camera_position=
c.position};h.prototype.enable2DView=function(){mat4.ortho(this._viewprojection2D_matrix,0,gl.viewport_data[2],0,gl.viewport_data[3],-1,1)};h.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};h.prototype.restoreState=function(){var c=this.state.pop(),b=this.camera=c.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;
this._nodes=c.nodes};h.prototype.setModelMatrix=function(c){this._model_matrix.set(c);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,c)};h.prototype.setGlobalUniforms=function(c){for(var b in c)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(c[b]):this._uniforms[b]=c[b]};var D={u_model:null};h.prototype.renderNode=function(c,a){var d=null;c._mesh?d=c._mesh:c.mesh&&(d=gl.meshes[c.mesh],d||(this._meshes_missing++,this.autoload_assets&&-1!=c.mesh.indexOf(".")&&this.loadMesh(c.mesh)));
if(c.primitives&&c.primitives.length){if(d)for(var e=0;e<c.primitives.length;++e){var n=c.primitives[e];(n=this.overwrite_material||b.Materials[n.material])&&this.renderMeshWithMaterial(c._global_matrix,d,n,"triangles",e)}}else{if(d&&(c.material||this.overwrite_material)&&(n=this.overwrite_material||b.Materials[c.material])){if(n.render){this.renderMeshWithMaterial(c._global_matrix,d,n,c.indices,c.submesh);return}c.color=n.color}if(d){n=!1;c._instances&&(1<gl.webgl_version||gl.extensions.ANGLE_instanced_arrays)&&
(n=!0);var l=null,h=c.shader;this.on_getShader?l=this.on_getShader(c,a):(!l&&c.shader&&(l=gl.shaders[h]),this.shader_overwrite&&(l=gl.shaders[this.shader_overwrite]));l||(l=c.textures.color?this._texture_shader:this._flat_shader);n&&!l.attributes.u_model&&(n=!1);var h=0,f=null;for(e in c.textures){var k=c.textures[e];if(k){k.constructor===Object&&(k=k.texture);var p="u_"+e+"_texture";if(!l||l.samplers[p])f=gl.textures[k],f||(this.autoload_assets&&-1!=k.indexOf(".")&&this.loadTexture(k,this.default_texture_settings),
f=gl.textures.white),c.flags.pixelated?(f.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST)):!1===c.flags.pixelated&&(f.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)),c._uniforms[p]=f.bind(h++)}}this.ignore_flags||this.enableItemFlags(c);if(c.onRender)c.onRender(this,a,l);for(e=0;e<this.global_uniforms_containers.length;++e)l.uniforms(this.global_uniforms_containers[e]);
this.skip_node_uniforms||l.uniforms(c._uniforms);if(c.onShaderUniforms)c.onShaderUniforms(this,l);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,l,c);e=null;null!=c.submesh&&d.info&&d.info.groups&&d.info.groups[c.submesh]&&(e=d.info.groups[c.submesh]);n?(D.u_model=c._instances,e?l.drawInstanced(d,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices,D,e.start,e.length):c.draw_range?l.drawInstanced(d,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices,D,c.draw_range[0],c.draw_range[1]):
l.drawInstanced(d,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices,D)):e?l.drawRange(d,void 0===c.primitive?gl.TRIANGLES:c.primitive,e.start,e.length,c.indices):c.draw_range?l.drawRange(d,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.draw_range[0],c.draw_range[1],c.indices):l.draw(d,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices);this.ignore_flags||this.disableItemFlags(c);this.draw_calls+=1}else if(c.onRender)c.onRender(this,a)}};h.prototype.renderMesh=function(c,a,d,e,n,l,h,f){a&&
(e&&this._uniforms.u_color.set(e),c||(c=b.IDENTITY),this._uniforms.u_model.set(c),n||(n=d?gl.shaders.texture:gl.shaders.flat),d&&(this._uniforms.u_texture=d.bind(0)),n.uniforms(this._uniforms),n.draw(a,void 0===l?gl.TRIANGLES:l,h),this.draw_calls+=1)};h.prototype.renderMeshWithMaterial=function(c,b,a,d,e){a.render&&a.render(this,c,b,d,e)};h.prototype.renderBounding=function(c,b){if(c){var a=this._uniforms.u_model,d=c._bounding,e=d.subarray(3,6);mat4.translate(a,b,d.subarray(0,3));mat4.scale(a,a,[2*
e[0],2*e[1],2*e[2]]);this.renderMesh(a,gl.meshes.cube,null,[1,1,0,1],null,gl.LINES,"wireframe")}};h.prototype.enableItemFlags=function(c){var a=c.flags.flip_normals;this.reverse_normals&&(a=!a);gl.frontFace(a?gl.CW:gl.CCW);gl[!1===c.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST);!1===c.flags.depth_write&&gl.depthMask(!1);gl[!0===c.flags.two_sided?"disable":"enable"](gl.CULL_FACE);if(c.blend_mode!==b.BLEND_NONE)switch(gl.enable(gl.BLEND),c.blend_mode){case b.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,
gl.ONE_MINUS_SRC_ALPHA);break;case b.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case b.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND);"BLEND"==c.alphaMode&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};h.prototype.disableItemFlags=function(c){c.flags.flip_normals&&gl.frontFace(gl.CCW);!1===c.flags.depth_test&&gl.enable(gl.DEPTH_TEST);c.blend_mode!==b.BLEND_NONE&&gl.disable(gl.BLEND);c.flags.two_sided&&gl.disable(gl.CULL_FACE);
!1===c.flags.depth_write&&gl.depthMask(!0);"BLEND"==c.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};h.prototype.setPointSize=function(c){this.point_size=c;gl.shaders.point.uniforms({u_pointSize:this.point_size})};b.Renderer.prototype.renderPoints=function(c,a,d,e,n,l,h){if(!c||c.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";n||(n=this.shaders._points,n||(n=this.shaders._points=new GL.Shader(b.points_vs_shader,b.points_fs_shader),n.uniforms({u_texture:0,u_atlas:1,
u_pointSize:1})));l=l||1;var f=1024;e=e||c.length/3;var k=null,p=null,x=this._points_mesh;e>c.length/3&&(e=c.length/3);!x||c.length>3*f?(e>f&&(f=GL.Texture.nextPOT(e)),k=new Float32Array(3*f),p=new Float32Array(4*f),x=this._points_mesh=GL.Mesh.load({vertices:k,extra4:p})):(k=this._points_mesh.getBuffer("vertices").data,p=this._points_mesh.getBuffer("extra4").data);k.set(k.length>c.length?c:c.subarray(0,k.length));a?p.set(p.length>a.length?a:a.subarray(0,p.length)):p.fill&&p.fill(0);x.upload(GL.DYNAMIC_STREAM);
n.setUniform("u_color",this._color);n.setUniform("u_pointSize",l);n.setUniform("u_camera_perspective",d._projection_matrix[5]);n.setUniform("u_viewport",gl.viewport_data);n.setUniform("u_viewprojection",d._viewprojection_matrix);n.drawRange(x,void 0!==h?h:GL.POINTS,0,e);return x};b.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = a_vertex;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
b.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\n\nvoid main() {\n\tgl_FragColor = u_color;\n}\n";h.prototype.loadMesh=function(c,b){if(!c)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[c]&&!this.assets_not_found[c]){var a=this.meshes[c];if(a)return b&&b(a),a;var d=this,a=c;-1==a.indexOf("://")&&(a=this.assets_folder+c);a=GL.Mesh.fromURL(a,function(a){a?d.meshes[c]=a:(d.assets_not_found[c]=!0,delete d.meshes[c]);d.num_assets_loading--;delete d.assets_loading[c];
b&&b(a,c)});this.assets_loading[c]=a;this.num_assets_loading++;return this.meshes[c]=a}};h.prototype.loadTexture=function(c,b,a){function d(b){l.debug&&console.log(" + texture loaded: "+c);b?l.textures[e]=b:l.assets_not_found[c]=!0;a&&a(b,e);l.num_assets_loading--;delete l.assets_loading[c];if(l.on_texture_load)l.on_texture_load(b,e)}if(!c)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[c]&&!this.assets_not_found[c]){var e=c;b&&(b.name&&(e=b.name),b.preview&&(e=
b.preview));var n=this.textures[e];if(n&&!n.is_preview)return a&&a(n),n;var l=this,n=c;-1==n.indexOf("://")&&(n=this.assets_folder+c);var h=null,h=-1!=c.indexOf("CUBEMAP")?GL.Texture.cubemapFromURL(n,this.default_cubemap_settings,d):GL.Texture.fromURL(n,b,d);b&&b.preview&&(h.is_preview=!0);this.assets_loading[c]=h;this.num_assets_loading++;return this.textures[e]=h}};h.prototype.loadTextureAtlas=function(c,b,a){"string"==typeof c&&(c=JSON.parse(c));var d=this;-1==b.indexOf("://")&&(b=this.assets_folder+
b);GL.Texture.fromURL(b,null,function(b){var e=c.files;d.textures[":atlas"]=b;for(var n in e)if(!d.textures[n]||d.textures[n].is_preview){var l=e[n],h=new GL.Texture(c.size,c.size,{wrap:gl.REPEAT,filter:gl.LINEAR});h.drawTo(function(){b.gl.drawTexture(b,0,0,c.size,c.size,l.x,l.y,l.width||c.size,l.height||c.size)});h.is_preview=!0;d.textures[n]=h}a&&a(e)})};h.prototype.loadShaders=function(b,a,d){var e=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);b+="?nocache="+Math.random();this.loading_shaders=
!0;GL.loadFileAtlas(b,function(b){e.compileShadersFromAtlas(b,d);e.loading_shaders=!1;a&&a(b)})};h.prototype.compileShadersFromAtlas=function(b,a){var d=b.shaders;if(d){this.shader_files=b;for(var e in b)b[e]=GL.Shader.expandImports(b[e],b);d=d.split("\n");for(e=0;e<d.length;++e){var n=d[e].trim().split(" "),l=n[0].trim();if("//"!=l.substr(0,2)){var h=b[n[1]],f=b[n[2]],k=null,p={};if(3<n.length)for(var x=3;x<n.length;++x)if("#"==n[x][0])p[n[x].substr(1)]=!0;else{k=n.slice(x).join(" ");break}if(!p.WEBGL1||
1==gl.webgl_version)if(!p.WEBGL2||2==gl.webgl_version){n[1]&&"@"==n[1][0]&&(p=n[1].substr(1)+"_VERTEX_SHADER",GL.Shader[p]&&(h=GL.Shader[p]));n[2]&&"@"==n[2][0]&&(p=n[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[p]&&(f=GL.Shader[p]));if(k)try{k=JSON.parse(k)}catch(g){console.error("Error in shader macros: ",l,k,g)}if(k&&a){var p={},q;for(q in k)p[q]=k[q];for(q in a)p[q]=a[q];k=p}else a&&(k=a);try{h&&f?this.shaders[l]?this.shaders[l].updateShader(h,f,k):this.shaders[l]=new GL.Shader(h,f,k):console.warn("Shader subfile not found: ",
n[1],n[2])}catch(B){GL.Shader.dumpErrorToConsole(B,h,f)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};h.prototype.setShadersFromFile=function(b){b=GL.processFileAtlas(b);this.compileShadersFromAtlas(b)};h.cubemap_info=[{front:[1,0,0],up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];h.prototype.renderToCubemap=function(c,a,d,e,n,l,f){var k=h.cubemap_camera;
k||(h.cubemap_camera=k=new b.Camera);k.perspective(90,1,l||0.1,f||1E3);var p=vec3.create(),x=this;c.drawTo(function(b,c){var l=h.cubemap_info[c];vec3.add(p,d,l.front);k.lookAt(d,p,l.up);x.clear();x.render(a,k,e,n)});return c};h.prototype.drawSphere3D=function(b,a,d){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var e=gl.shaders.flat;e.setUniform("u_color",d);e.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(u);mat4.translate(u,u,b);mat4.scale(u,u,[a,a,a]);
e.setUniform("u_model",u);e.draw(gl.meshes.sphere);this.draw_calls+=1};h.prototype.drawCircle2D=function(b,a,d,e,n){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:0.02,slices:64}));var l=gl.shaders.flat;l.setUniform("u_color",e);l.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(u);mat4.translate(u,u,[b,a,0]);mat4.scale(u,u,[2*d,2*d,2*d]);l.setUniform("u_model",u);l.draw(gl.meshes[n?
"circle":"ring"]);this.draw_calls+=1};h.prototype.drawLine2D=function(c,a,d,e,n,l,h){var f=gl.meshes.plane;h=h||gl.shaders.flat;h.setUniform("u_color",l);h.setUniform("u_viewprojection",this._viewprojection2D_matrix);var k=d-c,p=e-a;l=Math.atan2(k,p);k=Math.sqrt(k*k+p*p);n/=2;mat4.identity(u);mat4.translate(u,u,[0.5*(c+d),0.5*(a+e),0]);mat4.rotate(u,u,l,b.FRONT);c=n;mat4.scale(u,u,[c,k,c]);h.setUniform("u_model",u);h.draw(f);this.draw_calls+=1};b.sortByDistance=function(b,a){b.forEach(function(b){b._distance=
b.getDistanceTo(a)});b.sort(function(b,c){return c._distance-b._distance})};b.noBlending=function(c){return c.blend_mode===b.BLEND_NONE};b.generateTextureAtlas=function(b,a,d,e,n){a=a||1024;d=d||1024;e=e||64;var l=0,h;for(h in b)l++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var l=new GL.Texture(a,d),k={width:a,height:d,size:e,files:{}},f=0,p=0,x={};l.drawTo(function(){for(var l in b)if(":"!=l[0]&&"white"!=l&&"black"!=l&&"notfound"!=l){var h=b[l];if(!h.is_preview&&h.texture_type==
gl.TEXTURE_2D){if(n){var q=h.toBase64().hashCode();if(x[q]){k.files[l]=k.files[x[q]];continue}x[q]=l}k.files[l]={x:f,y:p};h.renderQuad(f,p,e,e);f+=e;if(f==a&&(f=0,p+=e,p==d)){console.warn("Atlas too small, some textures wont be stored.");break}}}});l.info=k;console.log(k);return l};h.prototype.computeResourcesLoaded=function(b){var a=0,d;for(d in b){var e=b[d],n=this.textures[e];n&&!1===n.ready||(e=this.meshes[e])&&!1===e.ready||(n||e)&&a++}return a};Object.defineProperty(h.prototype,"meshes",{get:function(){return this.gl.meshes},
set:function(b){},enumerable:!0});Object.defineProperty(h.prototype,"textures",{get:function(){return this.gl.textures},set:function(b){},enumerable:!0});Object.defineProperty(h.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(b){},enumerable:!0});h.prototype.addMesh=function(b,a){a.gl!=this.gl&&(a=a.cloneShared(this.gl));this.gl.meshes[b]=a};b.Renderer=h;b.Ray=q;q.prototype.testPlane=function(b,a){return geo.testRayPlane(this.origin,this.direction,b,a,this.collision_point)};
q.prototype.testSphere=function(b,a,d){return geo.testRaySphere(this.origin,this.direction,b,a,this.collision_point,d)};q.prototype.closestPointOnRay=function(b,a,d){d=d||vec3.create();var e=vec3.create();vec3.add(e,this.origin,this.direction);var n=vec3.create();vec3.add(n,b,a);geo.closestPointBetweenLines(this.origin,e,b,n,null,d);return d};b.Factory=function(c,a,d){c=b.Factory.templates[c];var e=new b.SceneNode;c&&e.configure(c);a&&(a.constructor===b.Scene?a.root:a).addChild(e);d&&e.configure(d);
return e};b.Factory.templates={grid:{mesh:"grid",primitive:1,color:[0.5,0.5,0.5,0.5],blend_mode:b.BLEND_ALPHA},mesh:{shader:"phong"},sphere:{mesh:"sphere",shader:"phong"},floor:{mesh:"planeXZ",scaling:10,shader:"phong"}};k.prototype._ctor=function(){a.prototype._ctor.call(this);this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};
k.prototype.updateVertices=function(b){b&&(this.vertices=b);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};k.prototype.updateNormals=function(b){b&&(this.normals=b);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=
new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};k.prototype.updateCoords=function(b){b&&(this.coords=b);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,
2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};k.prototype.updateIndices=function(b){b&&(this.indices=b);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);
this._total_indices=b.length};k.prototype.render=function(b,a){if(this._total){var d=b.shaders[this.shader||"flat"];if(d){b.setModelMatrix(this._global_matrix);var e=this._mesh,n=this._total_indices?this._total_indices:this._total/3;b.enableItemFlags(this);d.uniforms(b._uniforms).uniforms(this._uniforms).drawRange(e,void 0===this.primitive?GL.TRIANGLES:this.primitive,0,n,this._total_indices?"triangles":null);b.disableItemFlags(this)}}};extendClass(k,a);b.DynamicMeshNode=k;r.prototype._ctor=function(){a.prototype._ctor.call(this);
this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=b.TOP_LEFT;this.blend_mode=b.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};Object.defineProperty(r.prototype,"angle",{get:function(){return this._angle},set:function(c){this._angle=c;quat.setAxisAngle(this._rotation,
b.FRONT,this._angle*n);this._must_update_matrix=!0},enumerable:!0});r.prototype.setSize=function(b,a){this.size[0]=b;this.size[1]=a};r.createFrames=function(b,a,d){d=d||{};var e;b.constructor!=Number?(num_columns=b[0],e=b[1]):e=num_columns=b;var n=b=0,l=1/num_columns,h=1/e;e*=num_columns;if(!a){a=[];for(var f=0;f<e;++f)a.push(String(f))}for(f=0;f<a.length&&!(d[a[f]]={pos:[b,n],size:[l,h],normalized:!0},b+=l,1<=b&&(b=0,n+=h),1<=n);++f);return d};r.prototype.createFrames=function(b,a){r.createFrames(b,
a,this.frames)};r.prototype.addFrame=function(b,a,d,e,n,l){this.frames[b]={pos:vec2.fromValues(a,d),size:vec2.fromValues(e,n),normalized:!!l}};r.prototype.updateTextureMatrix=function(b){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var a=b.textures[this.texture];if(!a&&b.autoload_assets){var d=this;-1!=this.texture.indexOf(".")&&b.loadTexture(this.texture,b.default_texture_settings,function(b){b&&0==d.size[0]&&0==d.size[0]&&d.setSize(b.width,b.height)});a=gl.textures.white}if(!a)return!1;
b=this.texture_matrix;var e=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!e)return!1;if(!e)return this.flags.flipX&&(v[0]=this.flags.flipX?1:0,v[1]=0,mat3.translate(b,b,v),v[0]=this.flags.flipX?-1:1,v[1]=1,mat3.scale(b,b,v)),!0;if(e.normalized)v[0]=this.flags.flipX?e.pos[0]+e.size[0]:e.pos[0],v[1]=1-e.pos[1]-e.size[1],mat3.translate(b,b,v),v[0]=e.size[0]*(this.flags.flipX?-1:1),v[1]=e.size[1];else{var n=a.height;v[0]=(this.flags.flipX?e.pos[0]+e.size[0]:e.pos[0])/a.width;v[1]=
(n-e.pos[1]-e.size[1])/n;mat3.translate(b,b,v);v[0]=e.size[0]*(this.flags.flipX?-1:1)/a.width;v[1]=e.size[1]/a.height}mat3.scale(b,b,v);return!0};r.prototype.render=function(a,d){if(this.texture&&this.updateTextureMatrix(a)){var e=a.textures[this.texture];if(e){this.flags.pixelated&&(e.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));
this.billboard_mode&&b.orientNodeToCamera(this.billboard_mode,this,d,a);0==this.size[0]&&!1!==e.ready&&(this.size[0]=e.width);0==this.size[1]&&!1!==e.ready&&(this.size[1]=e.height);var e=this.size,n=0,l=0;u.set(this._global_matrix);var h=!1;this.current_frame&&this.current_frame.size&&(e=this.current_frame.size,h=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case b.TOP_LEFT:n=0.5;l=-0.5;break;case b.TOP_CENTER:l=-0.5;break;case b.TOP_RIGHT:n=-0.5;break;case b.BOTTOM_LEFT:l=
n=0.5;break;case b.BOTTOM_CENTER:l=0.5;break;case b.BOTTOM_RIGHT:n=-0.5,l=0.5}mat4.translate(u,u,[n*this.size[0],l*this.size[1],0])}h?mat4.scale(u,u,[this.size[0]*e[0],this.size[1]*e[1],1]):mat4.scale(u,u,[this.size[0],this.size[1],1]);a.setModelMatrix(u);a.renderNode(this,a,d)}}};extendClass(r,a);b.Sprite=r;l.prototype._ctor=function(){this.mesh="cube";this.shader="skybox";this.scaling=[10,10,10];this.flags.depth_test=!1;this.flags.two_sided=!0};l.prototype.render=function(b,a){this.position=a.position;
this.updateGlobalMatrix(!0);b.setModelMatrix(this._global_matrix);b.renderNode(this,a)};extendClass(l,a);b.Skybox=l;b.parseTextConfig=function(b){function a(b,c){for(var e=d.shift();e;)if(0==e.trim().length)e=d.shift();else{for(var n=0;"\t"==e[n]&&n<e.length;)n++;if(n<c)break;var l={children:[]};try{var h=e.trim();-1!=h.indexOf(":")&&(h="{"+h+"}");var f=new Function("return "+h);l.data=f()}catch(k){console.error(k)}n>=c&&(b&&b.children.push(l),e=a(l,n+1))}return e}var d=b.split("\n");b={data:"",children:[]};
a(b,0);return b};h.prototype.createShaders=function(){var a=this._vertex_shader="\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tattribute vec3 a_normal;\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec3 v_pos;\n\t\t\t\tvarying vec3 v_normal;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\t#ifdef INSTANCING\n\t\t\t\t\tattribute mat4 u_model;\n\t\t\t\t#else\n\t\t\t\t\tuniform mat4 u_model;\n\t\t\t\t#endif\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tvoid main() {\n\t\t\t\t\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos , 1.0 );\n\t\t\t\t\tgl_PointSize = 2.0;\n\t\t\t\t}\t\t\t\t",
d="\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,d);gl.shaders.flat_instancing=this._flat_instancing_shader=new GL.Shader(a,d,{INSTANCING:""});this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t",
"\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=this._color_shader;d="\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\t\tuniform sampler2D u_color_texture;\t\tuniform float u_global_alpha_clip;\t\tvoid main() {\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\t\t}\t";gl.shaders.texture=this._texture_shader=
new GL.Shader(a,d);gl.shaders.texture_instancing=this._texture_instancing_shader=new GL.Shader(a,d,{INSTANCING:""});this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_mvp;\n\t\tuniform mat3 u_texture_matrix;\n\t\tvoid main() {\n\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform float u_global_alpha_clip;\n\t\tuniform sampler2D u_color_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\t");gl.shaders.texture_transform=this._texture_transform_shader;this._phong_uniforms={u_ambient:vec3.create(),u_light_vector:vec3.fromValues(0.5442,0.6385,0.544),
u_light_color:b.WHITE};d=this._fragment_shader="\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec3 u_ambient;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_vector;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef TEXTURED\n\t\t\t\tuniform sampler2D u_color_texture;\n\t\t\t#endif\n\t\t\t#ifdef UNIFORMS\n\t\t\t\tUNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef TEXTURED\n\t\t\t\t\tcolor *= texture2D( u_color_texture, v_coord );\n\t\t\t\t#endif\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(u_light_vector,N));\n\t\t\t\t#ifdef EXTRA\n\t\t\t\t\tEXTRA\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color * (vec4(u_ambient,1.0) + NdotL * vec4(u_light_color,1.0));\n\t\t\t}\t";
gl.shaders.phong=this._phong_shader=new GL.Shader(a,d);this._phong_shader._uniforms=this._phong_uniforms;this._phong_shader.uniforms(this._phong_uniforms);gl.shaders.phong_instancing=this._phong_instancing_shader=new GL.Shader(a,d,{INSTANCING:""});this._phong_instancing_shader._uniforms=this._phong_uniforms;this._phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.textured_phong=this._textured_phong_shader=new GL.Shader(a,d,{TEXTURED:""});this._textured_phong_shader.uniforms(this._phong_uniforms);
gl.shaders.textured_phong_instancing=this._textured_phong_instancing_shader=new GL.Shader(a,d,{INSTANCING:"",TEXTURED:""});this._textured_phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.normal=this._normal_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4( normalize(v_normal),1.0);\n\t\t\t}\t");gl.shaders.uvs=this._uvs_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(v_coord,0.0,1.0);\n\t\t\t}\t")};
b.orientNodeToCamera=function(a,d,e,n){if(a){if(a==b.BILLBOARD_CYLINDRIC||a==b.BILLBOARD_PARALLEL_CYLINDRIC){var l=null;a==b.BILLBOARD_CYLINDRIC?(l=d.getGlobalPosition(z),vec3.sub(s,e._position,l),v[0]=s[0],v[1]=s[2]):(v[0]=e._front[0],v[1]=e._front[2]);a=vec2.computeSignedAngle(v,b.FRONT2D);isNaN(a)||(mat4.rotateY(u,x,-a),d._global_matrix.set(u),mat4.setTranslation(d._global_matrix,d._position),mat4.scale(d._global_matrix,d._global_matrix,d._scale))}else a==b.BILLBOARD_PARALLEL_SPHERIC?(d._global_matrix.set(e._model_matrix),
mat4.setTranslation(d._global_matrix,d._position)):(mat4.lookAt(d._global_matrix,d._position,e.position,b.UP),mat4.invert(d._global_matrix,d._global_matrix)),mat4.scale(d._global_matrix,d._global_matrix,d._scale);n.setModelMatrix(d._global_matrix)}};b.readPixels=function(b,a){var d=new Image;d.src=b;d.onload=function(){var b=document.createElement("canvas");b.width=this.width;b.height=this.height;var c=b.getContext("2d");c.drawImage(this,0,0);b=c.getImageData(0,0,b.width,b.height);a(b,this)}};"undefined"==
typeof GL&&(mat4.rotateVec3=function(b,a,d){var e=d[0],n=d[1];d=d[2];b[0]=a[0]*e+a[4]*n+a[8]*d;b[1]=a[1]*e+a[5]*n+a[9]*d;b[2]=a[2]*e+a[6]*n+a[10]*d;return b},mat4.projectVec3=function(b,a,d){var e=d[0],n=d[1];d=d[2];var l=a[1]*e+a[5]*n+a[9]*d+a[13],h=a[2]*e+a[6]*n+a[10]*d+a[14],f=a[3]*e+a[7]*n+a[11]*d+a[15];b[0]=((a[0]*e+a[4]*n+a[8]*d+a[12])/f+1)/2;b[1]=(l/f+1)/2;b[2]=(h/f+1)/2;return b})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(m){function a(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);
this._meshes={};this._last_point_id=this._accumulated_time=0}function f(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.velocity_variation=
this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function g(){this._ctor()}function e(a){this._ctor();a&&this.configure(a)}extendClass(a,
RD.SceneNode);RD.PointCloud=a;a.prototype.render=function(e,f){if(0!=this.points.length){this.updateVertices();var k=this._meshes[e.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,e.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);k=gl.shaders[this.shader];
k||(k=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(a._vertex_shader,a._pixel_shader));this.draw_range[1]=this.points.length;k=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;0<this.num_textures?(this._uniforms.u_texture_info[0]=1/this.num_textures,this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures):this._uniforms.u_texture_info[0]=0;this.ignore_transform&&(mat4.identity(e._model_matrix),e._mvp_matrix.set(e._viewprojection_matrix));
e.renderNode(this,e,f)}};a.prototype.updateVertices=function(a){if(a=this.points.length)for(var e=this._vertices,f=this._extra,g=0,l=this.num_textures*this.num_textures,d=0;d<a;d++){var p=this.points[d];e.set(p.pos?p.pos:p,g);f[g]=1;f[g+1]=1;1<l&&(f[g+2]=p.tex);g+=3}};a._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
a._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(f,RD.SceneNode);RD.ParticlesEmissor=f;f.prototype.update=function(a){var e=this.particles.length,f=this.particles_damping,g=this.particles_acceleration,l=vec3.length(g);if(e){for(var d=[],p=0;p<e;p++){var b=this.particles[p];vec3.scaleAndAdd(b.pos,b.pos,b.vel,a);l&&vec3.scaleAndAdd(b.vel,b.vel,g,a);f&&vec3.scaleAndAdd(b.vel,b.vel,b.vel,-a*f);b.ttl-=a;0<b.ttl&&d.push(b)}this.particles=d}e=this.getGlobalPosition();f=this.emissor_direction;g=this.particles_life;l=this.num_textures*this.num_textures;
d=this.velocity_variation;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),p=0;p<a&&!(this.particles.length>=this.max_particles);p++)f=vec3.clone(f),f[0]+=0.5*Math.random()*d,f[2]+=0.5*Math.random()*d,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*l)/l,pos:vec3.clone(e),vel:f,ttl:g})};f.prototype.render=function(a,e){if(0!=this.particles.length){this.updateVertices();
var k=this._meshes[a.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);k=gl.shaders[this.shader];k||(k=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(f._vertex_shader,f._pixel_shader));
this.draw_range[1]=this.particles.length;k=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,
e)}};f.prototype.updateVertices=function(a){if(a=this.particles.length)for(var e=this._vertices,f=this._extra,g=0,l=this.particles_life,d=this.num_textures*this.num_textures,p=0;p<a;p++){var b=this.particles[p];e.set(b.pos,g);f[g]=1;f[g+1]=b.ttl/l;1<d&&(f[g+2]=b.tex);g+=3}};f._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
f._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(g,RD.SceneNode);RD.Billboard=g;g.SPHERIC=1;g.PARALLEL_SPHERIC=2;g.CYLINDRIC=3;g.PARALLEL_CYLINDRIC=4;g.prototype._ctor=function(){this.billboard_mode=g.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};g.prototype.render=function(a,e){!1!==this.flags.visible&&(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,e,a),a.renderNode(this,a,e))};e.prototype._ctor=function(){RD.SceneNode.prototype._ctor.call(this);this.size=1;this._atlas_size=vec2.fromValues(1,
1);this.max_sprites=1024;this.positions=new Float32Array(3*this.max_sprites);this.sprite_info=new Float32Array(4*this.max_sprites);this.index=0;this.shader=null;this.use_points=!1;this.mode=e.CYLINDRICAL;this.must_update_buffers=!0};RD.SpritesBatch=e;e.XY=0;e.XZ=1;e.CYLINDRICAL=2;e.SPHERICAL=3;e.FLAT=4;Object.defineProperty(e.prototype,"atlas_size",{get:function(){return this._atlas_size},set:function(a){this._atlas_size.set(a)}});e.prototype.clear=function(){this.index=0};e.prototype.add=function(a,
e,f,g,l){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var d=this.index;this.index+=1;this.positions.set(a,3*d);2==a.length&&(this.positions[3*d+2]=0);a=4*d;this.sprite_info[a]=e||0;this.sprite_info[a+1]=f?1:0;this.sprite_info[a+2]=null==g?1:g;this.sprite_info[a+3]=l||0;this.must_update_buffers=!0}};e.prototype.addData=function(a,e){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var f=this.index;this.index+=
1;this.positions.set(a,3*f);this.sprite_info.set(e,4*f);this.must_update_buffers=!0}};e.prototype.render=function(a,e){if(this.texture){var f=a.textures[this.texture];f&&this.flags.pixelated&&(f.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.renderSprites(f,e,this.size,this.atlas_size,this.color,this.mode)}};e.prototype.renderSprites=
function(a,f,k,g,l,d){if(this.index){var p=gl.shaders[this.shader];p||(p=gl.shaders[this.use_points?"point_sprites":"quad_sprites"]);p||(p=this.use_points?gl.shaders.point_sprites=new GL.Shader(e.point_sprites_vertex_shader,e.point_sprites_fragment_shader):gl.shaders.quad_sprites=new GL.Shader(e.quad_sprites_vertex_shader,e.quad_sprites_fragment_shader));d=d||0;if(this.use_points)p.uniforms(GFX.scene_renderer._uniforms),p.setUniform("u_pointSize",k),p.setUniform("u_atlas",g),p.setUniform("u_texture",
a.bind(0)),RD.renderPoints(this.positions,this.sprite_info,f,this.index,p);else{if(!this.vertex_buffer_data){this.vertex_buffer_data=new Float32Array(12*this.max_sprites);this.extra4_buffer_data=new Float32Array(16*this.max_sprites);for(var b=new Int8Array(8*this.max_sprites),n=new Int8Array([-1,1,1,1,-1,-1,1,-1]),B=0;B<b.length;B+=8)b.set(n,B);for(var n=new Int16Array([0,2,1,1,2,3]),x=new Uint16Array(6*this.max_sprites),B=0;B<x.length;++B)x[B]=n[B%6]+4*Math.floor(B/6);this.vertex_buffer=new GL.Buffer(gl.ARRAY_BUFFER,
this.vertex_buffer_data,3,gl.DYNAMIC_DRAW);this.extra4_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this.extra4_buffer_data,4,gl.DYNAMIC_DRAW);this.extra2_buffer=new GL.Buffer(gl.ARRAY_BUFFER,b,2,gl.STATIC_DRAW);this.indices_buffer=new GL.Buffer(gl.ELEMENT_ARRAY_BUFFER,x,1,gl.STATIC_DRAW)}if(this.must_update_buffers){b=this.vertex_buffer_data;n=this.extra4_buffer_data;x=Math.min(this.index,this.positions.length/3);for(B=0;B<x;++B){var C=3*B,u=this.positions.subarray(C,C+3);b.set(u,4*C);b.set(u,4*C+3);b.set(u,
4*C+6);b.set(u,4*C+9);C=4*B;u=this.sprite_info.subarray(C,C+4);n.set(u,4*C);n.set(u,4*C+4);n.set(u,4*C+8);n.set(u,4*C+12)}this.vertex_buffer.uploadRange(0,48*this.index);this.extra4_buffer.uploadRange(0,64*this.index);this.must_update_buffers=!1}B=a.width/g[0]/(a.height/g[1]);b=RD.UP;n=RD.RIGHT;switch(d){case RD.SpritesBatch.SPHERICAL:b=f.getLocalVector(RD.UP);case RD.SpritesBatch.CYLINDRICAL:n=f.getLocalVector(RD.RIGHT);break;case RD.SpritesBatch.FLAT:b=f.getLocalVector(RD.FRONT);n=f.getLocalVector(RD.RIGHT);
break;case RD.SpritesBatch.XZ:b=RD.FRONT}p.bind();p.setUniform("u_model",RD.IDENTITY);p.setUniform("u_viewprojection",f._viewprojection_matrix);p.setUniform("u_color",l||RD.ONES4);p.setUniform("u_size",[k,k/B]);p.setUniform("u_top",b);p.setUniform("u_right",n);p.setUniform("u_atlas",g);p.setUniform("u_texture",a.bind(0));p.setUniform("u_itexsize",[1/a.width,1/a.height]);p.setUniform("u_viewport",gl.viewport_data);a=p.attributes.a_vertex;f=p.attributes.a_extra4;p=p.attributes.a_extra2;this.vertex_buffer.bind(a);
this.extra4_buffer.bind(f);this.extra2_buffer.bind(p);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer.buffer);gl.drawElements(gl.TRIANGLES,6*this.index,gl.UNSIGNED_SHORT,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.vertex_buffer.unbind(a);this.extra4_buffer.unbind(f);this.extra2_buffer.unbind(p)}}};extendClass(e,RD.SceneNode);e.quad_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4; //frame,flipx,scale,extranum\nattribute vec2 a_extra2;//expanse direction\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec2 u_size;\nuniform vec3 u_top;\nuniform vec3 u_right;\nuniform vec4 u_color;\nuniform vec2 u_atlas;\nuniform vec2 u_itexsize;\n\nvoid main() {\n\tvec3 vertex = a_vertex + a_extra4.z * u_size.y * u_top * a_extra2.y + a_extra4.z * u_size.x * u_right * a_extra2.x;\n\tvec2 uv = a_extra2;\n\tif( a_extra4.y != 0.0) //flip X\n\t\tuv.x *= -1.0;\n\tuv.x *= 1.0 - u_itexsize.x;\n\tuv.y *= -1.0;\n\tuv = uv * 0.5 + vec2(0.5);\n\t\n\tvec2 i_atlas = vec2(1.0) / u_atlas; \n\tfloat frame = a_extra4.x;\n\tfloat frame_x = mod( frame, u_atlas.x );\n\tfloat frame_y = floor( frame * i_atlas.x );\n\tuv.x = (uv.x + frame_x) * i_atlas.x;\n\tuv.y += frame_y;\n\tuv.y = 1.0 - uv.y * i_atlas.y;\n\tv_uv = uv;\n\tv_pos = (u_model * vec4(vertex,1.0)).xyz;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\t//gl_Position.x = floor(gl_Position.x * u_viewport.z * 1.0) / (u_viewport.z * 1.0);\n\t//gl_Position.y = floor(gl_Position.y * u_viewport.w * 1.0) / (u_viewport.w * 1.0);\n}\n\n";
e.quad_sprites_fragment_shader="\nprecision highp float;\nprecision mediump int;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n\tvec4 color = texture2D( u_texture, v_uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tcolor *= u_color;\n\tgl_FragColor = color;\n}\n";e.point_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_mvp;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tvec3 vertex = a_vertex;\t\n\tv_pos = vertex;\n\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_mvp * vec4(vertex,1.0);\n\tgl_Position.x = floor(gl_Position.x * u_viewport.z) / u_viewport.z;\n\tgl_Position.y = floor(gl_Position.y * u_viewport.w) / u_viewport.w;\n\tgl_PointSize = computePointSize( u_pointSize * u_extra4.z, gl_Position.w );\n}\n";
e.point_sprites_fragment_shader="\nprecision highp float;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4; //id,flip,scale,extra\nuniform float u_atlas;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\tfloat i_atlas = 1.0 / u_atlas;\n\tfloat frame = v_extra4.x;\n\tfloat x = frame * i_atlas;\n\tfloat y = floor(x);\n\tx = (x - y);\n\ty = y / u_atlas;\n\tif( v_extra4.y > 0.0 ) //must flip in x\n\t\tx -= gl_PointCoord.x * i_atlas - i_atlas;\n\telse\n\t\tx += gl_PointCoord.x * i_atlas;\n\t\n\tvec2 uv = vec2( x, 1.0 - (y + gl_PointCoord.y / u_atlas) );\n\tvec4 color = texture2D( u_texture, uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tgl_FragColor = color;\n}\n"})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
(function(m){function a(b){this._ctor();b&&this.configure(b);this.render_priority=0;this.targets=null;this.size=150;this.mode=a.DEFAULT;this.coordinates=a.WORLD_SPACE;this.layers=255;this.grid_size=0;this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();b={x:a.XAXIS_COLOR,y:a.YAXIS_COLOR,z:a.ZAXIS_COLOR};var d="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");this.actions={};for(var e in d){var l=
d[e],f={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:0.15,visible:!1,flag:a[l.toUpperCase()]};0==l.indexOf("move")&&(f.move=!0);0==l.indexOf("rotate")&&(f.rotate=!0);0==l.indexOf("scale")&&(f.scale=!0);f.color=b[l[l.length-1]];if(f.move||f.rotate)f.cursor="crosshair";this.actions[l]=f}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=vec3.fromValues(0,1,0);this.actions.scalez.axis=
this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=0.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=0.1;this.actions.drag.cursor=
"move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1}a.MOVEX=1;a.MOVEY=2;a.MOVEZ=4;a.MOVEXY=8;a.MOVEXZ=16;a.MOVEYZ=32;a.ROTATEX=64;a.ROTATEY=128;a.ROTATEZ=256;a.SCALEX=512;a.SCALEY=1024;a.SCALEZ=2048;a.SCALEXY=4096;a.SCALEYZ=8192;a.SCALEXZ=16384;a.SCALE=32768;a.DRAG=65536;
a.ROTATE=131072;a.ROTATEFRONT=262144;a.MOVEAXIS=a.MOVEX|a.MOVEY|a.MOVEZ;a.MOVEPLANAR=a.MOVEXY|a.MOVEXZ|a.MOVEYZ;a.MOVEALL=a.DRAG|a.MOVEAXIS|a.MOVEPLANAR;a.PLANAR=a.MOVEX|a.MOVEZ|a.MOVEXZ|a.ROTATEY|a.SCALE;a.ROTATEALL=a.ROTATEX|a.ROTATEY|a.ROTATEZ|a.ROTATEFRONT;a.SCALEALL=a.SCALE|a.SCALEX|a.SCALEY|a.SCALEZ|a.SCALEXY|a.SCALEYZ|a.SCALEXZ;a.MOVEROTATESCALE=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALE;a.ALL=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALEALL;a.DEFAULT=a.PLANAR;a.OBJECT_SPACE=1;a.WORLD_SPACE=
2;m=mat4.create();var f=mat4.create(),g=mat4.create();mat4.create();mat4.create();mat4.create();var e=mat4.create(),h=mat4.create();mat4.create();var q=vec3.create(),k=vec3.create(),r=vec3.create(),l=vec4.create();vec4.create();mat4.translate(m,m,[1.1,0,0]);mat4.rotate(m,m,90*DEG2RAD,[0,0,-1]);mat4.translate(f,f,[0,1.1,0]);mat4.translate(g,g,[0,0,1.1]);mat4.rotate(g,g,90*DEG2RAD,[1,0,0]);m=mat4.create();mat4.scale(m,m,[-1,-1,-1]);a.full_viewport=null;var d=mat4.create(),p=mat4.create();a.XAXIS_COLOR=
[0.901,0.247,0.349,1];a.YAXIS_COLOR=[0.55,0.81,0.11,1];a.ZAXIS_COLOR=[0.23,0.57,0.93,1];a.XYAXIS_COLOR=[0.9,0.7,0.23,0.75];a.XZAXIS_COLOR=[0.6,0.4,0.7,0.75];a.YZAXIS_COLOR=[0.39,0.69,0.52,0.75];a.SPHERE_COLOR=[0.8,0.8,0.8,0.4];a.RING_COLOR=[0.5,0.5,0.5,1];a.INNERSPHERE_COLOR=[0.6,0.6,0.6,1];a.SELECTED_COLOR=[1,1,1,1];a.NOAXIS_COLOR=[0.901,0.247,0.749,1];a.STATIC_SPHERE_COLOR=[0.1,0.1,0.1,0.3];a.prototype.isTarget=function(b){return-1!=this.targets.indexOf(b)};a.prototype.setTargets=function(b,a){if(b&&
b.constructor!==Array)throw"nodes must be an Array";b&&0!=b.length?(a&&this.targets&&(b=this.targets.concat(b)),this.targets=b=b.filter(function(a,d){return b.indexOf(a)===d}),this.resetTransform(),this.position=this.computeCenter(this.targets)):a||(this.targets=null)};a.prototype.computeCenter=function(b){if((b=b||this.targets)&&b.length){for(var a=null,d=0;d<b.length;++d){var e=b[d];e.layers&this.layers&&(e=e.getGlobalPosition(),a?vec3.add(a,a,e):a=e)}if(!a)return[0,0,0];vec3.scale(a,a,1/b.length);
return a}};a.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?this.transform=this.targets[0].transform:this.position=this.computeCenter(this.targets)))};a.prototype.updateTargets=function(){if(this.targets)for(var b=this.getGlobalMatrix(mat4.create()),a=0;a<this.targets.length;++a){var d=this.targets[a];d.layers&this.layers&&d.fromMatrix(b,!0)}};a.prototype.saveTargetTransforms=
function(){if(this.targets){this.target_tranforms=[];for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(this.target_tranforms[b]=new Float32Array(a.transform))}}};a.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(a.transform=this.target_tranforms[b])}};a.prototype.removeTargetsFromScene=function(){if(this.targets){for(var b=
0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&a.parentNode&&a.parentNode.removeChild(a)}this.targets=null}};a.prototype.getTargetBaseNodes=function(){function b(a){return-1!=d.indexOf(a)?!0:a.parentNode?b(a.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var a=[],d=this.targets,e=0;e<d.length;++e){var l=d[e];l.layers&this.layers&&(b(l.parentNode)||a.push(l))}return a};a.prototype.applyTransformToTarget=function(b){var a=this.getGlobalMatrix(mat4.create()),
d=mat4.invert(mat4.create(),a),e=mat4.create(),l=this.getTargetBaseNodes();if(l){for(var f=0;f<l.length;++f){var h=l[f];h.getGlobalMatrix(e);mat4.multiply(e,d,e);mat4.multiply(e,b,e);mat4.multiply(e,a,e);h.fromMatrix(e,!0);h.position=this.applySnap(h.position);if(this.grid_size){var p=quat.toEuler(vec3.create(),h.rotation);p[0]=15*Math.round(p[0]*RAD2DEG/15)*DEG2RAD;p[1]=15*Math.round(p[1]*RAD2DEG/15)*DEG2RAD;p[2]=15*Math.round(p[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(h.rotation,p)}}mat4.multiply(e,
a,b);this.fromMatrix(e);this.scaling=[1,1,1];this.updateGizmo()}};a.prototype.applyTranslation=function(b){var a=mat4.create();mat4.translate(a,a,b);this.applyTransformToTarget(a)};a.prototype.applyRotation=function(b,a){var d=mat4.create();mat4.rotate(d,d,b,a);this.applyTransformToTarget(d)};a.prototype.applyScale=function(b){b.constructor===Number&&(b=[b,b,b]);var a=mat4.create();mat4.scale(a,a,b);this.applyTransformToTarget(a)};a.prototype.applySnap=function(b){if(!this.grid_size)return b;b[0]=
Math.round(b[0]/this.grid_size)*this.grid_size;b[1]=Math.round(b[1]/this.grid_size)*this.grid_size;b[2]=Math.round(b[2]/this.grid_size)*this.grid_size;return b};a.prototype.setColor=function(b){if(this.targets)for(var a=0;a<this.targets.length;++a){var d=this.targets[a];d.layers&this.layers&&(d.color=b)}};a.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var b=[],a=0;a<this.targets.length;++a){var d=this.targets[a];
if(d.layers&this.layers){var e=d.clone(!0);d.parentNode.addChild(e);b.push(d)}}return this.targets=b}};a.prototype.onMouse=function(b){if(this._camera&&this.targets&&!1!==this.visible){var a=this._camera,d=a.getFront(),e=[b.canvasx,b.canvasy],l=a.getRay(e[0],e[1]),f=this.position,h=vec3.sub(vec3.create(),f,a.position);vec3.normalize(h,h);var p=this._selected_action,k=this.actions[p],g=this._global_matrix;a.project(f,null,this.center_2D);if("mousedown"==b.type){if(this.click_2D[0]=this.click_2D2[0]=
e[0],this.click_2D[1]=this.click_2D2[0]=e[1],b.is_touch&&this.testMouseOver(b),p=this._selected_action=this._hover_action,k=this.actions[p]){if(k.move&&k.axis){var q=vec3.clone(k.axis);mat4.rotateVec3(q,g,q);vec3.normalize(q,q);this._last=l.closestPointOnRay(f,q);b.shiftKey&&this.cloneTargets()}else k.move&&k.normal&&(l.testPlane(f,k.normal)&&(this.click_pos=l.collision_point),b.shiftKey&&this.cloneTargets());"drag"==p&&(l.testPlane(f,d),this._last=l.collision_point,b.shiftKey&&this.cloneTargets());
"rotatefront"==p?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,0.5*this.size),this.click_2D2.set(this.click_2D)):k.rotate&&(k.axis?(b=mat4.rotateVec3(vec3.create(),g,k.axis),l.testPlane(f,b)&&(vec3.sub(this.click_pos,l.collision_point,f),vec3.normalize(this.click_pos,this.click_pos),f=vec3.scaleAndAdd(vec3.create(),f,this.click_pos,this.current_size),
this.current_2D=this.click_2D=a.project(f))):l.testSphere(f,this.current_size)&&(this._last=l.collision_point,vec3.sub(this.click_pos,l.collision_point,f),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),h,this.click_pos)));this.click_model.set(g);this.click_transform.set(this.transform);this.click_dist=vec3.distance(this.click_2D,this.center_2D);this.saveTargetTransforms()}}else if("mousemove"==b.type)if(b.dragging&&this._selected_action){if("rotatefront"==
p)return f=vec2.sub(vec3.create(),e,this.center_2D),vec2.normalize(f,f),k=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,f,0.5*this.size),f=Math.atan2(f[0],f[1]),k=Math.atan2(k[0],k[1]),f-=k,b.shiftKey&&(f=2*Math.PI*Math.ceil(36*f/(2*Math.PI))/36),f&&(this.restoreTargetTransforms(),this.applyRotation(f,h)),!0;if(k.rotate)return k.axis?(b=mat4.rotateVec3(vec3.create(),g,k.axis),l.testPlane(f,b)&&(p=vec3.sub(vec3.create(),l.collision_point,f),vec3.normalize(p,p),f=vec3.scaleAndAdd(vec3.create(),
f,p,this.current_size),this.current_2D=a.project(f),a=Math.clamp(vec3.dot(p,this.click_pos),-1,1),f=Math.acos(a),p=vec3.cross(vec3.create(),p,this.click_pos),vec3.normalize(p,p),a=vec3.dot(b,p),0<a&&(f*=-1),this.restoreTargetTransforms(),this.applyRotation(f,k.axis))):(q=vec3.cross(vec3.create(),h,this.click_pos),f=0.01*(vec2.dist(this.center_2D,e)-this.click_dist),k=vec2.sub(vec2.create(),this.center_2D,e),b=vec2.sub(vec2.create(),this.center_2D,this.click_2D),0>vec2.dot(k,b)&&(f=-f),console.log(f),
this.restoreTargetTransforms(),this.applyRotation(f,q),this.click_axis=q),!0;h=null;if(k.move&&k.normal)l.testPlane(f,k.normal)&&(k=l.collision_point,this.applySnap(k),h=vec3.sub(vec3.create(),k,this.click_pos),this.click_pos=k);else if(k.move||k.scale){if("scale"==p||k.scale&&b.ctrlKey)return k=1+0.01*(e[1]-this.click_2D[1]),this.applyScale(k),this.click_2D[0]=e[0],this.click_2D[1]=e[1],!0;if("scalexy"==p||"scalexz"==p||"scaleyz"==p){k=1+0.01*(e[1]-this.click_2D[1]);switch(p){case "scalexy":this.applyScale([k,
k,1]);break;case "scaleyz":this.applyScale([1,k,k]);break;case "scalexz":this.applyScale([k,1,k])}this.click_2D[0]=e[0];this.click_2D[1]=e[1];return!0}q=vec3.clone(k.axis);mat4.rotateVec3(q,g,q);vec3.normalize(q,q);b=l.closestPointOnRay(f,q);if(k.scale)return k=vec2.distance(e,this.center_2D),b=k/this.click_dist,"scalex"==p?this.applyScale([b,1,1]):"scaley"==p?this.applyScale([1,b,1]):"scalez"==p&&this.applyScale([1,1,b]),this.click_dist=k,!0;this.applySnap(b);h=vec3.sub(vec3.create(),b,this._last);
this._last=b}"drag"==p&&(l.testPlane(f,this._camera.getFront()),b=l.collision_point,this.applySnap(b),h=vec3.sub(vec3.create(),b,this._last),this._last=b);if(h)return this.applyTranslation(h),!0}else this.testMouseOver(b);else if("mouseup"==b.type){if(this.saveTargetTransforms(),this._selected_action)return this._selected_action=null,this.render(this._last_renderer,this._last_camera),this.testMouseOver(b),this.updateGizmo(),!0}else if("wheel"==b.type){if("scale"==this._selected_action)return k=1+
2E-4*b.wheel,this.applyScale(k),!0;if("drag"==this._selected_action)return h=vec3.sub(vec3.create(),f,a.position),k=1+2E-4*b.wheel,vec3.scaleAndAdd(h,a.position,h,k),vec3.sub(h,h,f),this.applyTranslation(h),this._last=f,!0}return!1}};a.prototype.testMouseOver=function(b){this._hover_action=null;var d=[b.canvasx,b.canvasy],e=1E5;b=null;for(var l in this.actions){var f=this.actions[l];if(f.visible){var h=vec2.distance(f.pos2D,d);h<f.radius*this.size&&h<e&&(e=h,b=l)}}b||(l=vec2.distance(this.center_2D,
d),this.actions.rotatefront.visible&&10>Math.abs(l-0.5*this.size)?b="rotatefront":this.mode&a.ROTATE&&l<0.5*this.size&&(b="rotate"));return this._hover_action=b};a.prototype.cancel=function(){this._selected_action&&(this._selected_action=null,this.restoreTargetTransforms())};a.prototype.render=function(b,f){this._last_renderer=b;this._last_camera=f;for(var p in this.actions)this.actions[p].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.circle=GL.Mesh.circle({radius:1}),
gl.meshes.cylinder=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:0.1,height:0.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:0.5*Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}));p=gl.meshes.torus;var g=f.getFront(),m=f.getLocalVector(RD.UP);f.getLocalVector(RD.RIGHT);
var u=this._position;l.set(u);l[3]=1;var v=f._projection_matrix[5];this.updateMatrices();e.set(this._global_matrix);var s=vec3.sub(vec3.create(),u,f.position);vec3.normalize(s,s);this._camera=f;this._unitary_model=e;var z=this._hover_action,A=this._selected_action;A&&(z=A);var E=A?this.actions[A]:null,w=this.mode;mat4.rotateVec3(k,e,RD.RIGHT);mat4.rotateVec3(r,e,RD.UP);mat4.rotateVec3(q,e,RD.FRONT);vec3.normalize(k,k);vec3.normalize(r,r);vec3.normalize(q,q);mat4.fromTranslationFrontTop(h,u,g,m);vec4.transformMat4(l,
l,f._viewprojection_matrix);this.current_size=m=gl.canvas.width/gl.canvas.height*this.size*l[3]/(gl.canvas.width*v);mat4.scale(e,e,[m,m,m]);mat4.scale(h,h,[m,m,m]);var m=vec3.dot(s,k),v=vec3.dot(s,r),F=vec3.dot(s,q),D=vec3.dot(g,RD.RIGHT),c=vec3.dot(g,RD.UP),y=vec3.dot(g,RD.FRONT);this._camera.project(u,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);s=gl.shaders[this.shader];
s.uniforms(b._uniforms);s.uniforms(f.uniforms);s.uniforms(this.uniforms);if("movex"==A)mat4.rotateZ(d,e,-Math.PI/2),this.drawAxis(d,a.XAXIS_COLOR);else if("movey"==A)this.drawAxis(e,a.YAXIS_COLOR);else if("movez"==A)mat4.rotateX(d,e,-Math.PI/2),this.drawAxis(d,a.ZAXIS_COLOR);else if("drag"==A)b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0);else if(E&&E.normal)d.set(e),"movexz"==A?mat4.rotateX(d,e,Math.PI/2):"moveyz"==A&&mat4.rotateY(d,e,Math.PI/2),mat4.scale(d,d,[100,100,100]),
s.setUniform("u_model",d),s.setUniform("u_color",[0.1,0.1,0.1,0.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),s.draw(gl.meshes.plane),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==A)mat4.rotateX(d,h,Math.PI/2),s.setUniform("u_model",d),s.draw(p),b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0),b.drawLine2D(this.click_2D[0],
this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR),b.drawLine2D(this.click_2D2[0],this.click_2D2[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR);else{if("rotate"==A){this.click_axis&&(mat4.fromTranslationFrontTop(d,u,g,this.click_axis),mat4.scale(d,d,[this.current_size,this.current_size,this.current_size]),this.drawAxis(d,a.NOAXIS_COLOR));this.drawRotateSphere(e,a.SPHERE_COLOR);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.NOAXIS_COLOR,!0);return}if(E&&E.rotate){g=
E.color||a.XAXIS_COLOR;"rotatex"==A?mat4.rotateZ(d,e,Math.PI/2):"rotatey"==A?mat4.rotateY(d,e,Math.PI/2):"rotatez"==A&&mat4.rotateX(d,e,Math.PI/2);s.setUniform("u_model",d);s.setUniform("u_color",g);s.draw(p);b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g,!0);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g,!0);b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g);b.drawCircle2D(this.current_2D[0],this.current_2D[1],2,g,!0);b.drawLine2D(this.current_2D[0],
this.current_2D[1],this.center_2D[0],this.center_2D[1],4,g);return}}"scale"==A?(b.drawCircle2D(this.center_2D[0],this.click_2D[1],2,a.INNERSPHERE_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.INNERSPHERE_COLOR,!0),b.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.INNERSPHERE_COLOR)):(this.drawRotateSphere(e,a.STATIC_SPHERE_COLOR),w&a.ROTATE&&"rotate"==z&&this.drawRotateSphere(e,a.SPHERE_COLOR),w&a.ROTATEFRONT&&(mat4.rotateX(d,h,Math.PI/2),s.setUniform("u_model",
d),s.setUniform("u_color","rotatefront"==z?a.SELECTED_COLOR:a.RING_COLOR),s.draw(p),this.actions.rotatefront.visible=!0),0.1<Math.abs(m)&&w&a.ROTATEX&&(mat4.rotateZ(d,e,Math.PI/2),0>y&&mat4.rotateX(d,d,Math.PI),0>c&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatex"==z?a.SELECTED_COLOR:a.XAXIS_COLOR,"rotatex")),0.1<Math.abs(v)&&w&a.ROTATEY&&(d.set(e),0<D&&0>y?mat4.rotateY(d,d,-Math.PI/2):0>D&&0>y?mat4.rotateY(d,d,Math.PI):0>D&&0<y&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatey"==z?
a.SELECTED_COLOR:a.YAXIS_COLOR,"rotatey")),0.1<Math.abs(F)&&w&a.ROTATEZ&&(d.set(e),mat4.rotateX(d,d,Math.PI/2),0<D&&0>c?mat4.rotateY(d,d,-Math.PI/2):0>D&&0>c?mat4.rotateY(d,d,Math.PI):0>D&&0<c&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatez"==z?a.SELECTED_COLOR:a.ZAXIS_COLOR,"rotatez")),0.95>Math.abs(m)&&(mat4.rotateZ(d,e,0>D?-Math.PI/2:Math.PI/2),w&a.MOVEX&&this.drawArrow(d,"movex"==z?a.SELECTED_COLOR:a.XAXIS_COLOR,"movex"),w&a.SCALEX&&this.drawScale(d,"scalex"==z?a.SELECTED_COLOR:a.XAXIS_COLOR,
"scalex")),0.95>Math.abs(v)&&(0<c?mat4.rotateZ(d,e,Math.PI):d.set(e),w&a.MOVEY&&this.drawArrow(d,"movey"==z?a.SELECTED_COLOR:a.YAXIS_COLOR,"movey"),w&a.SCALEY&&this.drawScale(d,"scaley"==z?a.SELECTED_COLOR:a.YAXIS_COLOR,"scaley")),0.95>Math.abs(F)&&(mat4.rotateX(d,e,0>y?-Math.PI/2:Math.PI/2),w&a.MOVEZ&&this.drawArrow(d,"movez"==z?a.SELECTED_COLOR:a.ZAXIS_COLOR,"movez"),w&a.SCALEZ&&this.drawScale(d,"scalez"==z?a.SELECTED_COLOR:a.ZAXIS_COLOR,"scalez")),0.2<Math.abs(F)&&(w&a.MOVEXY||w&a.SCALEXY)&&(mat4.translate(d,
e,[0.45*(0>m?1:-1),0.45*(0>v?1:-1),0]),w&a.MOVEXY?this.drawFlat(d,"movexy"==z?a.SELECTED_COLOR:a.XYAXIS_COLOR,"movexy"):this.drawFlat(d,"scalexy"==z?a.SELECTED_COLOR:a.XYAXIS_COLOR,"scalexy","circle")),0.2<Math.abs(v)&&(w&a.MOVEXZ||w&a.SCALEXZ)&&(mat4.rotateX(d,e,Math.PI/2),mat4.translate(d,d,[0.45*(0>m?1:-1),0.45*(0>F?-1:1),0]),w&a.MOVEXZ?this.drawFlat(d,"movexz"==z?a.SELECTED_COLOR:a.XZAXIS_COLOR,"movexz"):this.drawFlat(d,"scalexz"==z?a.SELECTED_COLOR:a.XZAXIS_COLOR,"scalexz","circle")),0.2<Math.abs(m)&&
(w&a.MOVEYZ||w&a.SCALEYZ)&&(mat4.rotateY(d,e,Math.PI/2),mat4.translate(d,d,[0.45*(0>F?1:-1),0.45*(0>v?1:-1),0]),w&a.MOVEYZ?this.drawFlat(d,"moveyz"==z?a.SELECTED_COLOR:a.YZAXIS_COLOR,"moveyz"):this.drawFlat(d,"scaleyz"==z?a.SELECTED_COLOR:a.YZAXIS_COLOR,"scaleyz","circle")),w&a.DRAG&&this.drawInnerSphere(e,"drag"),w&a.SCALE&&this.drawInnerSphere(e,"scale"),gl.enable(gl.DEPTH_TEST))}}};a.prototype.drawArrow=function(b,d,e){var l=gl.shaders[this.shader],f=gl.meshes.cone,h=gl.meshes.cylinder,k=this._hover_action;
mat4.translate(p,b,[0,1.1,0]);l.setUniform("u_model",p);l.setUniform("u_color",k==e?a.SELECTED_COLOR:d);l.draw(f);this.mode==a.MOVEALL?(mat4.translate(p,p,[0,-0.4,0]),mat4.scale(p,p,[1,1,1])):(mat4.translate(p,p,[0,-0.15,0]),mat4.scale(p,p,[1,0.5,1]));l.setUniform("u_model",p);l.draw(h);this.toScreen(p,e,[0,0.6,0])};a.prototype.drawAxis=function(b,a){var d=gl.shaders[this.shader],e=gl.meshes.sphere;mat4.scale(p,b,[0.01,100,0.01]);d.setUniform("u_model",p);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);
gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);d.setUniform("u_color",[a[0],a[1],a[2],0.2]);gl.depthFunc(gl.GREATER);d.draw(e);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);d.setUniform("u_color",a);d.draw(e);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(b)};a.prototype.drawFlat=function(b,a,e,l){l=gl.meshes[l||"plane"];var f=gl.shaders[this.shader];mat4.scale(d,b,[0.25,0.25,0.25]);f.setUniform("u_color",a);f.setUniform("u_model",d);gl.enable(gl.BLEND);f.draw(l);
gl.disable(gl.BLEND);this.toScreen(d,e)};a.prototype.drawRotator=function(b,a,e){var l=gl.meshes.quartertorus,f=gl.shaders[this.shader];mat4.scale(d,b,[0.9,0.9,0.9]);f.setUniform("u_color",a);f.setUniform("u_model",d);f.draw(l);this.toScreen(d,e,[-0.75,0,0.75])};a.prototype.drawScale=function(b,e,l){var f=gl.meshes.cylinder,h=gl.meshes.sphere,p=gl.shaders[this.shader];p.setUniform("u_color",e);this.mode==a.SCALEALL?(mat4.translate(d,b,[0,0.5,0]),mat4.scale(d,d,[1,1,1])):(mat4.translate(d,b,[0,0.25,
0]),mat4.scale(d,d,[1,0.5,1]));p.setUniform("u_model",d);p.draw(f);mat4.translate(d,b,[0,0.4,0]);this.mode==a.SCALEALL?mat4.scale(d,d,[0.1,0.1,0.1]):mat4.scale(d,d,[0.1,0.2,0.1]);p.setUniform("u_model",d);p.draw(h);this.toScreen(d,l)};a.prototype.drawRotateSphere=function(b,a){var e=gl.shaders[this.shader],l=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(d,b,[0.9,0.9,0.9]);e.setUniform("u_model",d);e.setUniform("u_color",a);e.draw(l);gl.disable(gl.BLEND)};
a.prototype.drawInnerSphere=function(b,e){var l=gl.shaders[this.shader],f=gl.meshes.sphere,h=this._hover_action;mat4.scale(d,b,[0.1,0.1,0.1]);l.setUniform("u_model",d);l.setUniform("u_color",h==e?a.SELECTED_COLOR:a.INNERSPHERE_COLOR);l.draw(f);"drag"==e&&(mat4.scale(d,b,[0.07,0.07,0.07]),l.setUniform("u_model",d),l.setUniform("u_color",h==e?a.INNERSPHERE_COLOR:[0,0,0,1]),l.draw(f));e&&this.toScreen(d,e)};a.prototype.renderOutline=function(b,d,e,l){if((l=l||this.targets)&&l.length){var f=this.layers;
l=l.filter(function(b){return b.layers&f});var h=gl.viewport_data[2],p=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==h&&this._selection_buffer.height==p||(this._selection_buffer=new GL.Texture(h,p,{magFilter:gl.NEAREST}));a.outline_material||(a.outline_material=new RD.Material({shader_name:"flat"}));var k=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);b.shader_overwrite=k;var a=b.onNodeShaderUniforms;
b.onNodeShaderUniforms=function(b,a){a.setUniform("u_color",[1,1,1,1])};var f=b.pipeline;b.pipeline=null;b.overwrite_material=RD.Gizmo.outline_material;b.render(d,e,l);b.shader_overwrite=null;b.onNodeShaderUniforms=a;b.pipeline=f;b.overwrite_material=null});var g=gl.shaders.outline;g||(g=gl.shaders.outline=GL.Shader.createFX("\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n"));gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(g,{u_color:[1,1,1,1],u_res:[1/h,1/p]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};a.prototype.renderCameraGizmo=function(b,a){this.drawInnerSphere};a.prototype.toScreen=function(b,d,e){d=this.actions[d];mat4.multiplyVec3(d.pos,b,e||[0,0,0]);this._camera.project(d.pos,a.full_viewport,d.pos2D);d.visible=!0};extendClass(a,RD.SceneNode);RD.Gizmo=a})(this);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,prefabs:{},texture_options:{format:GL.RGBA,magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT},load:function(m,a,f,g){function e(b){function a(d){var l=this.buffer;l.data=d;l.dataview=new Uint8Array(d);b.length?
e(b):h()}var d=b.pop(),l=r+"/"+d.uri;console.log(" - loading "+d.uri+" ...");"data:"==d.uri.substr(0,5)?(l=_base64ToArrayBuffer(d.uri.substr(37)),a.call({buffer:d},l)):fetch(l).then(function(b){return b.arrayBuffer()}).then(a.bind({buffer:d}))}function h(){console.log("parsing gltf ...");q.filename=k;q.folder=r;q.url=m;var b=RD.GLTF.parse(q);RD.GLTF.prefabs[m]=b.serialize();a&&a(b)}var q=null,k="",r="";if(m.constructor===String){r=m.split("/");k=r.pop();f=f||k.split(".").pop().toLowerCase();r=r.join("/");
console.log("loading gltf json...");var l=new XMLHttpRequest;l.onload=function(){var b=l.response;"gltf"==f?(q=b,console.log("loading gltf binaries..."),e(q.buffers.concat())):"glb"==f&&(q=RD.GLTF.parseGLB(b))&&h()};l.onerror=function(){console.error("Network Error");a&&a(null)};g&&(l.onprogress=function(b){g(m,b.loaded,b.total)});l.responseType="gltf"==f?"json":"arraybuffer";l.open("GET",m);l.send()}else{var d=m;console.log(d);m=k=d.main;var p=d[k];if("glb"==p.extension)(q=RD.GLTF.parseGLB(p.data))&&
h();else{q=p.data;for(p=0;p<q.buffers.length;++p){var b=q.buffers[p];"data:"==b.uri.substr(0,5)?b.data=_base64ToArrayBuffer(b.uri.substr(37)):b.data=d[b.uri].data;b.dataview=new Uint8Array(b.data)}h()}}},parseGLB:function(m){var a=new Uint8Array(m),f=new DataView(m);if(1179937895!=f.getUint32(0,!0))return console.error("incorrect gltf header"),null;var g=f.getUint32(4,!0);console.log("GLTF Version: "+g);f.getUint32(8,!0);for(var g=12,e=null,h=0;g<a.length;){var q=f.getUint32(g,!0),k=f.getUint32(g+
4,!0),r=m.slice(g+8,g+8+q),g=g+(8+q);if(k==RD.GLTF.JSON_CHUNK){if(!("TextDecoder"in window))throw"Sorry, this browser does not support TextDecoder...";e=(new TextDecoder("utf-8")).decode(r);e=JSON.parse(e)}else k==RD.GLTF.BINARY_CHUNK?(q=e.buffers[h],q.data=r,q.dataview=new Uint8Array(r),m.byteLength!=q.byteLength&&console.warn("gltf binary doesnt match json size hint"),h++):console.warn("gltf unknown chunk type: ","0x"+k.toString(16))}return e},parse:function(m){console.log(m);var a=null,f={};1<
m.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var g=m.scenes[m.scene].nodes;this.gltf_materials={};a=null;1<g.length&&(a=new RD.SceneNode,a.name="root");for(var e=0;e<g.length;++e)if(!g[e].node){var h=RD.GLTF.parseNode(null,e,m);a||(a=h);1<g.length&&a.addChild(h);h.id=m.url.replace(/\//gi,"_")+"::node_"+e;f[h.id]=f[e]=h}if(m.animations&&m.animations.length)if(RD.Animation)for(a.animations=[],e=0;e<m.animations.length;++e){if(g=this.parseAnimation(e,
m,f))RD.Animations[g.name]=g,a.animations.push(g)}else console.error("you must include rendeer-animation.js to allow animations");a.materials=this.gltf_materials;return a},parseNode:function(m,a,f){var g=f.nodes[a];m=m||new RD.SceneNode;for(var e in g){var h=g[e];switch(e){case "name":m.name=h;break;case "translation":m.position=h;break;case "rotation":m.rotation=h;break;case "scale":m.scaling=h;var q=0;0>m.scaling[0]&&q++;0>m.scaling[1]&&q++;0>m.scaling[2]&&q++;1==q%2&&(m.flags.frontFace=GL.CW);
break;case "matrix":m.fromMatrix(h);break;case "mesh":if(h=RD.GLTF.parseMesh(h,f))for(m.mesh=h.name,m.primitives=[],q=0;q<h.info.groups.length;++q){var k=h.info.groups[q],r=null;null!=k.material&&(r=this.parseMaterial(k.material,f));m.primitives.push({index:q,material:r?r.name:null,mode:k.mode})}break;case "skin":m.skin=this.parseSkin(h,f);break;case "children":if(h.length)for(q=0;q<h.length;++q)k=RD.GLTF.parseNode(null,h[q],f),m.addChild(k);break;case "extras":break;default:console.log("gltf node info ignored:",
e,g[e])}}g.name||(g.name=m.name="node_"+a);return m},parseMesh:function(m,a){for(var f=a.meshes[m],g=gl.meshes,e=[],h=[],q=0,k=0;k<f.primitives.length;++k){var r=this.parsePrimitive(f,k,a);r.start=q;q+=r.length;h.push(r);var l={vertexBuffers:{},indexBuffers:{}},d;for(d in r.buffers)"indices"==d||"triangles"==d?l.indexBuffers[d]={data:r.buffers[d]}:l.vertexBuffers[d]={data:r.buffers[d]};e.push({mesh:l})}q=null;1<e.length?q=GL.Mesh.mergeMeshes(e):(k=e[0].mesh,q=new GL.Mesh(k.vertexBuffers,k.indexBuffers),
q.info&&k.info&&(q.info=k.info));for(k=0;k<f.primitives.length;++k)(e=q.info.groups[k])||(q.info.groups[k]=e={}),r=f.primitives[k],e.material=r.material,e.mode=null!=r.mode?r.mode:4,e.start=h[k].start,e.length=h[k].length;q.name=f.name||"mesh_"+m;q.updateBoundingBox();q.computeGroupsBoundingBoxes();return g[q.name]=q},parsePrimitive:function(m,a,f){var g={buffers:{}},e=g.buffers;m=m.primitives[a];if(m.extensions)throw"mesh data is compressed, this importer does not support it yet";null==!m.attributes.POSITION?
console.warn("gltf mesh without positions"):e.vertices=this.parseAccessor(m.attributes.POSITION,f);null!=m.attributes.NORMAL&&(e.normals=this.parseAccessor(m.attributes.NORMAL,f));null!=m.attributes.COLOR_0&&(e.colors=this.parseAccessor(m.attributes.COLOR_0,f));null!=m.attributes.TEXCOORD_0&&(e.coords=this.parseAccessor(m.attributes.TEXCOORD_0,f,this.flip_uv));null!=m.attributes.TEXCOORD_1&&(e.coords1=this.parseAccessor(m.attributes.TEXCOORD_1,f,this.flip_uv));null!=m.attributes.WEIGHTS_0&&(e.weights=
this.parseAccessor(m.attributes.WEIGHTS_0,f));null!=m.attributes.JOINTS_0&&(e.bones=this.parseAccessor(m.attributes.JOINTS_0,f));null!=m.indices&&(e.triangles=this.parseAccessor(m.indices,f));g.mode=m.mode;g.material=m.material;g.start=0;g.length=e.triangles?e.triangles.length:e.vertices.length/3;return g},parseAccessor:function(m,a,f){var g=a.accessors[m];if(!g)return console.warn("gltf accessor not found"),null;m=this.numComponents[g.type];if(!m)return console.warn("gltf accessor of unknown type:",
g.type),null;var e=g.count*m;switch(g.componentType){case RD.GLTF.FLOAT:databuffer=new Float32Array(e);break;case RD.GLTF.UNSIGNED_INT:databuffer=new Uint32Array(e);break;case RD.GLTF.SHORT:databuffer=new Int16Array(e);break;case RD.GLTF.UNSIGNED_SHORT:databuffer=new Uint16Array(e);break;case RD.GLTF.BYTE:databuffer=new Int8Array(e);break;case RD.GLTF.UNSIGNED_BYTE:databuffer=new Uint8Array(e);break;default:console.warn("gltf accessor of unsupported type: ",g.componentType),databuffer=new Float32Array(e)}e=
a.bufferViews[g.bufferView];if(!e)return console.warn("gltf bufferView not found"),null;var h=a.buffers[e.buffer];if(!h||!h.data)return console.warn("gltf buffer not found or data not loaded"),null;if(e.byteStride&&e.byteStride!=m*databuffer.BYTES_PER_ELEMENT)return console.warn("gltf buffer data is not tightly packed, not supported"),null;a=new Uint8Array(databuffer.buffer);null==e.byteOffset&&(e.byteOffset=0);g=e.byteOffset+(g.byteOffset||0);g=h.dataview.subarray(g,g+a.length);a.set(g);if(f)for(f=
1;f<databuffer.length;f+=m)databuffer[f]=1-databuffer[f];return databuffer},parseMaterial:function(m,a){var f=a.materials[m];if(!f)return console.warn("gltf material not found"),null;var g=RD.Materials[f.name];if(g)return g;g=new RD.Material;g.name=f.name;null!=f.alphaMode&&(g.alphaMode=f.alphaMode);g.alphaCutoff=null!=f.alphaCutoff?f.alphaCutoff:0.5;null!=f.doubleSided&&(g.flags.two_sided=f.doubleSided);g.normalmapFactor=1;if(f.pbrMetallicRoughness){g.model="pbrMetallicRoughness";g.color.set([1,
1,1]);g.opacity=1;g.metallicFactor=1;g.roughnessFactor=1;null!=f.pbrMetallicRoughness.baseColorFactor&&(g.color=f.pbrMetallicRoughness.baseColorFactor);if(f.pbrMetallicRoughness.baseColorTexture&&(g.textures.albedo=this.parseTexture(f.pbrMetallicRoughness.baseColorTexture,a),"MASK"==g.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic)){var e=gl.textures[g.textures.albedo.texture];e&&(e.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,
8))}null!=f.pbrMetallicRoughness.metallicFactor&&(g.metallicFactor=f.pbrMetallicRoughness.metallicFactor);null!=f.pbrMetallicRoughness.roughnessFactor&&(g.roughnessFactor=f.pbrMetallicRoughness.roughnessFactor);f.pbrMetallicRoughness.metallicRoughnessTexture&&(g.textures.metallicRoughness=this.parseTexture(f.pbrMetallicRoughness.metallicRoughnessTexture,a))}f.occlusionTexture&&(g.textures.occlusion=this.parseTexture(f.occlusionTexture,a));f.normalTexture&&(g.textures.normal=this.parseTexture(f.normalTexture,
a));f.emissiveTexture&&(g.textures.emissive=this.parseTexture(f.emissiveTexture,a));f.emissiveFactor&&(g.emissive=f.emissiveFactor);RD.Materials[g.name]=g;return this.gltf_materials[g.name]=g},parseTexture:function(m,a){var f=a.textures[m.index];if(!f)return console.warn("gltf texture not found"),null;var g=a.images[f.source],e="",h=null;g.uri?(h=g.uri,h.split(".").pop()):(h=a.url.replace(/[\/\.\:]/gi,"_")+"_image_"+m.index,e=g.mimeType?g.mimeType.split("/").pop():"png",h+="."+e);var q={};if(!gl.textures[h])if(g.uri){var k=
g.uri;if("data:"==k.substr(0,5)){var r=g.uri.indexOf(","),l=g.uri.substr(5,r),e=l.split("/").pop().toLowerCase(),h=a.folder+"/"+k+"image_"+m.index+"."+e,e=_base64ToArrayBuffer(g.uri.substr(r+1)),g=URL.createObjectURL(new Blob([e],{type:l})),g=GL.Texture.fromURL(g,this.texture_options);g.name=h;gl.textures[h]=g}else q.texture=a.folder+"/"+k}else null!=g.bufferView&&(l=a.bufferViews[g.bufferView],null==l.byteOffset&&(l.byteOffset=0),e=a.buffers[l.buffer].data.slice(l.byteOffset,l.byteOffset+l.byteLength),
g=URL.createObjectURL(new Blob([e],{type:g.mimeType})),g=GL.Texture.fromURL(g,this.texture_options),g.name=h,gl.textures[h]=g);q.texture||(q.texture=h);null!=f.sampler&&(f=a.samplers[f.sampler],null!=f.magFilter&&(q.magFilter=f.magFilter),null!=f.minFilter&&(q.minFilter=f.minFilter));m.texCoord&&(q.uv_channel=m.texCoord);return q},parseSkin:function(m,a){var f=a.skins[m],g={};g.skeleton_root=a.nodes[f.skeleton].name;g.bindMatrices=this.splitBuffer(this.parseAccessor(f.inverseBindMatrices,a),16);g.joints=
[];for(var e=0;e<f.joints.length;++e)g.joints.push(a.nodes[f.joints[e]].id);return g},splitBuffer:function(m,a){for(var f=m.length,g=[],e=0;e<f;e+=a)g.push(new m.constructor(m.subarray(e,e+a)));return g},parseAnimation:function(m,a,f){f=a.animations[m];var g=new RD.Animation;g.name=f.name||"anim_"+m;for(var e=m=0;e<f.channels.length;++e){var h=new RD.Animation.Track,q=f.channels[e],k=f.samplers[q.sampler];h.target_node=a.nodes[q.target.node].name;h.target_property=q.target.path.toLowerCase();if(q=
this.rename_animation_properties[h.target_property])h.target_property=q;var q=this.parseAccessor(k.input,a),r=this.parseAccessor(k.output,a),l=a.accessors[k.output].type,k=RD.TYPES[l];k==RD.VEC4&&"rotation"==h.target_property&&(k=RD.QUAT);h.type=k;var d=RD.TYPES_SIZE[k];if(d){for(var l=r.length/d,p=new Float32Array((1+d)*l),b=0;b<l;++b){p[b*(1+d)]=q[b];var n=r.subarray(b,b+d);k==RD.QUAT&&quat.identity(n,n);p.set(n,b*(1+d)+1)}h.data=p;h.packed_data=!0;m=Math.max(m,q[q.length-1]);g.addTrack(h)}else console.warn("gltf unknown type:",
l)}g.duration=m;return g},loadFromFiles:function(m,a){function f(d){var b=d.target.result,l=this.extension;if("gltf"==l)b=JSON.parse(b),g.main=this.filename;else if("glb"==l)g.main=this.filename;else if("bin"==l)q.push(this.filename);else if("jpeg"==l||"jpg"==l||"png"==l)d=URL.createObjectURL(new Blob([b],{type:d.target.mimeType})),l=GL.Texture.fromURL(d,{wrap:gl.REPEAT,extension:l}),l.name=this.filename,gl.textures[l.name]=l;g[this.filename]={filename:this.filename,data:b,extension:this.extension};
e--;0==e&&(g.binaries=q,h.load(g,function(b){a&&a(b)}))}for(var g={},e=m.length,h=this,q=[],k=0;k<m.length;++k){var r=m[k],l=new FileReader,d=r.name.split("."),d=d[d.length-1].toLowerCase();l.onload=f;l.filename=r.name;l.extension=d;"gltf"==d?l.readAsText(r):l.readAsArrayBuffer(r)}}};function _base64ToArrayBuffer(m){m=window.atob(m);for(var a=m.length,f=new Uint8Array(a),g=0;g<a;g++)f[g]=m.charCodeAt(g);return f.buffer}
(function(m){function a(e){this.renderer=e;e.pipeline=this;this.mode=a.FORWARD;this.fbo=null;this.bgcolor=vec4.fromValues(0.1,0.1,0.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.quality=this.resolution_factor=this.emissive_factor=this.exposure=this.environment_factor=1;this.test_visibility=!0;this.single_pass=!1;this.use_rendertexture=!0;this.fx=null;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,
u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec3.fromValues(0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),u_normalFactor:1,u_metallicRough:!1,u_reflectance:0.1,u_maps_info:new Int8Array(8),
u_clearCoat:0,u_clearCoatRoughness:0.5,u_isAnisotropic:!1,u_anisotropy:0.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.final_fbo=this.final_texture=null;this.render_calls=[];this.num_render_calls=0;this.compiled_shaders=new Map}function f(){this.name="";this.id=-1;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;
this.node=this.material=null;this._render_priority=0}var g=m.RD;a.FORWARD=1;a.DEFERRED=2;a.MACROS={UVS2:1,COLOR:2};a.maps="albedo metallicRoughness occlusion normal emissive opacity displacement".split(" ");a.prototype.render=function(e,f,g,k){this.fillGlobalUniforms(g);this.mode==a.FORWARD?this.renderForward(e,f,k):this.mode==a.DEFERRED&&this.renderDeferred(e,f);this.getBRDFIntegratorTexture()};a.prototype.fillGlobalUniforms=function(a){(a=this.getBRDFIntegratorTexture())&&a.bind(0);this.environment_texture?
(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_exposure=this.exposure;this.global_uniforms.u_background_color=
this.bgcolor.subarray(0,3)};a.prototype.renderForward=function(e,f,g){var k=Math.floor(gl.viewport_data[2]*this.resolution_factor),m=Math.floor(gl.viewport_data[3]*this.resolution_factor);this.use_rendertexture&&!g&&(this.final_texture&&this.final_texture.width==k&&this.final_texture.height==m||(this.final_texture=new GL.Texture(k,m,{format:gl.RGBA,type:gl.HIGH_PRECISION_FORMAT}),this.final_fbo?this.final_fbo.setTextures([this.final_texture]):this.final_fbo=new GL.FBO([this.final_texture])),this.final_fbo.bind(0));
gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this.environment_texture&&this.render_skybox&&this.renderSkybox(f);if(this.onRenderOpaque)this.onRenderOpaque(this,renderer,f);this.resetRenderCallsPool();for(k=0;k<e.length;++k)this.getNodeRenderCalls(e[k],f);e=this.render_calls.slice(0,this.num_render_calls);for(k=0;k<e.length;++k)e[k].computeRenderPriority(f._position);e=e.sort(a.rc_sort_function);for(k=0;k<e.length;++k)m=
e[k],this.renderMeshWithMaterial(m.model,m.mesh,m.material,m.index_buffer_name,m.group_index,m.node.extra_uniforms,m.reverse_faces);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,f);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,f);this.use_rendertexture&&!g&&this.renderFinalBuffer()};a.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.final_texture,this.final_texture);this.fx_uniforms.u_viewportSize[0]=
this.final_texture.width;this.fx_uniforms.u_viewportSize[1]=this.final_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.final_texture.width;this.fx_uniforms.u_iViewportSize[1]=1/this.final_texture.height;this.final_texture.toViewport(gl.shaders.tonemapper,this.fx_uniforms)};a.prototype.getNodeRenderCalls=function(e,f){var q=null;if(e._mesh)q=e._mesh;else if(e.mesh&&(q=gl.meshes[e.mesh],!q))return;e.updateGlobalMatrix(!0);if(q&&!1!==e.flags.visible){if(this.test_visibility){a.temp_bbox||(a.temp_bbox=
BBox.create(),a.aabb_center=BBox.getCenter(a.temp_bbox),a.aabb_halfsize=BBox.getHalfsize(a.temp_bbox));BBox.transformMat4(a.temp_bbox,q.getBoundingBox(),e._global_matrix);if(f.testBox(a.aabb_center,a.aabb_halfsize)==g.CLIP_OUTSIDE)return;e._last_rendered_frame=this.renderer.frame}if(e.primitives&&e.primitives.length)for(var k=0;k<e.primitives.length;++k){var m=g.Materials[e.primitives[k].material];if(m){var l=this.getRenderCallFromPool();l.material=m;l.model=e._global_matrix;l.mesh=q;l.group_index=
k;l.node=e;l.reverse_faces=e.flags.frontFace==GL.CW}}else e.material&&(m=g.Materials[e.material])&&(l=this.getRenderCallFromPool(),l.material=m,l.model=e._global_matrix,l.mesh=q,l.group_index=-1,l.node=e)}};a.rc_sort_function=function(a,f){return f._render_priority-a._render_priority};a.prototype.getPBRShader=function(e){var f=this.compiled_shaders.get(e);if(f)return f;if(!this.renderer.shader_files)return null;var f=this.renderer.shader_files["default.vs"],g=this.renderer.shader_files["pbr.fs"],
k=null;if(e){var k={},m;for(m in a.MACROS)e&a.MACROS[m]&&(k[m]="")}f=new GL.Shader(f,g,k);this.compiled_shaders.set(e,f);return f};a.prototype.renderMeshWithMaterial=function(e,f,q,k,m,l,d){var p=this.renderer,b=null;if(!("BLEND"==q.alphaMode&&0>=q.color[3])){var n=this.material_uniforms,B=this.sampler_uniforms;n.u_albedo=q.color.subarray(0,3);n.u_emissive.set(q.emissive||g.ZERO);1!=this.emissive_factor&&vec3.scale(n.u_emissive,n.u_emissive,this.emissive_factor);b=0;this.overwrite_shader_name?b=gl.shaders[this.overwrite_shader_name]:
"pbrMetallicRoughness"==q.model&&this.quality?(shader_name="pbr",n.u_metalness=q.metallicFactor,n.u_roughness=q.roughnessFactor,n.u_metallicRough=Boolean(q.textures.metallicRoughness),f.vertexBuffers.coords1&&(b|=a.MACROS.UVS2),f.vertexBuffers.colors&&(b|=a.MACROS.COLOR),b=this.getPBRShader(b)):b=gl.shaders[f.vertexBuffers.coords1?"nopbr_uv2":"nopbr"];if(b){n.u_alpha=q.opacity;n.u_alpha_cutoff=-1;n.u_normalFactor=null!=q.normalmapFactor?q.normalmapFactor:1;for(var x=2,C=n.u_maps_info,u=0;u<a.maps.length;++u){var v=
a.maps[u];C[u]=-1;var s=q.textures[v];if(s){var z=null;s.constructor===Object?z=s.texture:s.constructor===String&&(z=s,s=null);if(z&&(v="u_"+v+"_texture",!b||b.samplers[v])){var A=gl.textures[z];A||(p.autoload_assets&&-1!=z.indexOf(".")&&p.loadTexture(z,p.default_texture_settings),A=gl.textures.white);B[v]=A.bind(x++);C[u]=s&&1==s.uv_channel?1:0}}}p.enableItemFlags(q);d&&gl.frontFace(GL.CW);"BLEND"==q.alphaMode?(gl.enable(gl.BLEND),q.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,
gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1)):"MASK"==q.alphaMode?n.u_alpha_cutoff=q.alphaCutoff:gl.disable(gl.BLEND);p._uniforms.u_model.set(e);b.uniforms(p._uniforms);b.uniforms(this.global_uniforms);b.uniforms(n);b.uniforms(B);l&&b.uniforms(l);e=null;null!=m&&f.info&&f.info.groups&&f.info.groups[m]&&(e=f.info.groups[m]);q.flags.preAlpha&&(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),e?b.drawRange(f,q.primitive,e.start,e.length,k):b.draw(f,q.primitive,k),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL));
e?b.drawRange(f,q.primitive,e.start,e.length,k):b.draw(f,q.primitive,k);p.disableItemFlags(q);d&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};a.prototype.renderDeferred=function(a,f){};a.prototype.prepareBuffers=function(a){};a.prototype.renderToGBuffers=function(a,f){};a.prototype.renderFinalPass=function(a,f){};a.prototype.applyPostFX=function(){};a.prototype.getRenderCallFromPool=function(){if(this.num_render_calls<this.render_calls.length){var a=this.render_calls[this.num_render_calls];
this.num_render_calls++;return a}a=new g.RenderCall;a.id=this.num_render_calls;this.render_calls.push(a);this.num_render_calls++;return a};a.prototype.resetRenderCallsPool=function(){this.num_render_calls=0};a.prototype.renderSkybox=function(a){var f=gl.meshes.cube,g=gl.shaders[this.overwrite_shader_name||"skybox"];if(g){var k=this.skybox_texture||this.environment_texture;if(k){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var m=this.renderer._model_matrix;mat4.identity(m);
mat4.translate(m,m,a.position);mat4.scale(m,m,[10,10,10]);this.renderer.setModelMatrix(m);g.uniforms(this.renderer._uniforms);g.uniforms({u_color_texture:k.bind(0),u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD,u_camera_position:a.position});g.draw(f,GL.TRIANGLES)}}};a.prototype.loadEnvironment=function(a,f,g){var k=this,m=gl.textures[a];m?(g?k.skybox_texture=m:(m.shs&&(k.environment_sh_coeffs=m.shs),k.environment_texture=m),f&&f(m)):HDRE.load(a,
function(l){var d=l.toTexture(!0);d&&(gl.textures[a]=d,g?k.skybox_texture=d:(d.shs=l.shs?l.shs:null,k.environment_texture=d,d.shs&&(k.environment_sh_coeffs=d.shs)));f&&f(d)})};a.prototype.captureEnvironment=function(a,f,g){g=g||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(g,g,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));var k=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,
a,f);this.use_rendertexture=k;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);this.environment_texture||(this.environment_texture=new GL.Texture(g,g,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};a.prototype.getBRDFIntegratorTexture=function(a){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var f=
gl.shaders.brdf_integrator;if(f){var g=gl.textures.brdf_integrator=new GL.Texture(128,128,{type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});if(a)return fetch(a).then(function(a){return a.arrayBuffer()}).then(function(a){g.uploadData(new Float32Array(a),{no_flip:!0})}),g;var k=gl.textures.hammersley_sample_texture;k||(k=this.createHammersleySampleTexture());g.drawTo(function(a){k&&k.bind(0);f.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return g}};
a.prototype.createHammersleySampleTexture=function(a){a=a||8192;for(var f=3*a,g=new Float32Array(f),k=0;k<f;k+=3){var m=2*Math.radical_inverse(k)*Math.PI;g[k]=Math.cos(m);g[k+1]=Math.sin(m);g[k+2]=0}a=new GL.Texture(a,1,{pixel_data:g,type:GL.FLOAT,format:GL.RGB});return gl.textures.hammersley_sample_texture=a};a.prototype.setClippingPlane=function(a,f){a?this.global_uniforms.u_clipping_plane.set([f[0],f[1],f[2],vec3.dot(a,f)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};Math.radical_inverse=
function(a){for(var f=0,g=0.5;a;g*=0.5,a>>=1)a&1&&(f+=g);return f};f.prototype.computeRenderPriority=function(a){this.name=this.node.name;var f=this.mesh.getBoundingBox();f&&(this._render_priority=0.001*vec3.distance(a,f),"BLEND"==this.material.alphaMode&&(this._render_priority-=100))};g.PBRPipeline=a;g.RenderCall=f})(this);
(function(m){function a(){this.intensity=1;this._color=vec3.fromValues(0.9,0.9,0.9);this._position=vec3.fromValues(10,20,5);this._target=vec3.create();this._vector=vec3.create();this.camera=new RD.Camera;this._castShadows=!1;this.shadowmap={texture:null,resolution:2048,bias:5E-6,uniforms:{u_shadowmap_matrix:this.camera._viewprojection_matrix,u_shadowmap_texture:4,u_shadowbias:1E-5}};this.uniforms={u_light_position:this._position,u_light_color:vec3.create(),u_light_vector:this._vector};this.flags=
{skip_shadows:!1}}Object.defineProperty(a.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});Object.defineProperty(a.prototype,"castShadows",{set:function(a){a?this.enableShadows():this.disableShadows()},get:function(){return this._castShadows},enumerable:!0});a.DEFAULT_SHADOWMAP_RESOLUTION=2048;a.prototype.updateData=function(){vec3.sub(this._vector,this._target,this._position);vec3.normalize(this._vector,this._vector)};a.prototype.setUniforms=
function(a){this.shadowmap.uniforms.u_shadowbias=this.shadowmap.bias;this.uniforms.u_light_color.set(this._color);vec3.scale(this.uniforms.u_light_color,this.uniforms.u_light_color,this.intensity);if(a.constructor===GL.Shader)a.uniforms(this.uniforms),this._castShadows&&(a.uniforms(this.shadowmap.uniforms),this.shadowmap.texture.bind(this.shadowmap.uniforms.u_shadowmap_texture));else{for(var g in this.uniforms)a[g]=this.uniforms[g];if(this._castShadows)for(g in this.shadowmap.uniforms)a[g]=this.shadowmap.uniforms[g]}};
a.prototype.lookAt=function(a,g,e){this._position.set(a);this._target.set(g);this.camera.lookAt(a,g,e);this.updateData()};a.prototype.setView=function(a,g,e){this.camera.orthographic(a,g,e,1);this.updateData()};a.prototype.followCamera=function(a,g){var e=g||5,h=vec3.scaleAndAdd(vec3.create(),a.target,this._vector,-g);this.lookAt(h,a.target,a.up);this.camera.orthographic(e,0.01,3*e,1);this.camera.updateMatrices()};a.prototype.enableShadows=function(){this._castShadows=!0;var f=this.shadowmap.resolution||
a.DEFAULT_SHADOWMAP_RESOLUTION;this.shadowmap.texture&&this.shadowmap.texture.width==f||(this.shadowmap.texture=new GL.Texture(f,f,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadowmap.fbo=new GL.FBO(null,this.shadowmap.texture))};a.prototype.disableShadows=function(){this._castShadows=!1;this.shadowmap.texture=null;this.shadowmap.fbo=null};a.prototype.generateShadowmap=function(a,g,e){if(this.castShadows){if(!this.shadowmap.fbo)throw"no shadowmap fbo";a.generating_shadowmap=
!0;this.shadowmap.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);a.shader_overwrite="flat";if(g.constructor===Array)for(var h=0;h<g.length;++h)a.render(g[h],this.camera,null,e||255);else a.render(g,this.camera,null,e||255);a.shader_overwrite=null;this.shadowmap.fbo.unbind();a.generating_shadowmap=!1;this.shadowmap.texture.bind(4)}};a.prototype.renderNode=function(a,g){gl.meshes.cylinder_light||(gl.meshes.cylinder_light=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone_light=GL.Mesh.cone({radius:0.1,
height:0.25}))};RD.Light=a})(this);
(function(m){function a(){this.name="";this.tracks=[];this.duration=2}function f(){this.target_property=this.target_node="";this.type=k.SCALAR;this.data=[];this.packed_data=!1}function g(a,d,e){return a*(1-e)+d*e}function e(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function h(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.children=new Int8Array(16)}function q(){this.skeleton=new e;this.num_keyframes=this.num_animated_bones=
this.samples_per_second=this.duration=0;this.bones_map=new Uint8Array(64);this.keyframes=null}var k=m.RD;k.Animations={};a.prototype.addTrack=function(a){this.tracks.push(a)};a.prototype.applyAnimation=function(a,d,e){for(var b=0;b<this.tracks.length;++b)this.tracks[b].applyTrack(a,d,e)};k.Animation=a;a.Track=f;f.prototype.addKeyframe=function(a,d,e){1<k.TYPES_SIZE[this.type]&&(d=new Float32Array(d));for(var b=0;b<this.data.length;++b)if(!(this.data[b][0]<a))return this.data[b][0]!=a||e?this.data.splice(b,
0,[a,d]):this.data[b][1]=d,b;this.data.push([a,d]);return this.data.length-1};f.prototype.getKeyframe=function(a){if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),null;var d=k.TYPES_SIZE[this.type];return this.packed_data?(a*=1+d,a>this.data.length-d?null:[this.data[a],this.data.subarray(a+1,a+d+1)]):this.data[a]};f.prototype.findTimeIndex=function(a){var d=this.data;if(!d||0==d.length)return-1;var e=k.TYPES_SIZE[this.type];if(this.packed_data){var e=e+1,b=d.length/
e,f=0,g=0,h=b;if(0==b)return-1;if(1==b)return 0;if(d[(h-1)*e]<a)return h-1;for(;h>=f;){g=0.5*(h+f)|0;b=d[g*e];if(b==a)break;if(f==h-1)return f;b<a?f=g:h=g}return g}b=d.length;g=f=0;h=b;if(0==b)return-1;if(1==b)return 0;if(d[h-1][0]<a)return h-1;for(;h>=f;){g=0.5*(h+f)|0;b=d[g][0];if(b==a)break;if(f==h-1)return f;b<a?f=g:h=g}return g};f.prototype.getSample=function(a,d,e){return this.data&&0!==this.data.length?this.packed_data?this.getSamplePacked(a,d,e):this.getSampleUnpacked(a,d,e):void 0};f.prototype.getSampleUnpacked=
function(a,d,e){var b=k.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-1][0]);var f=this.findTimeIndex(a);-1===f&&(f=0);var g=f,h=f+1,m=this.data,b=k.TYPES_SIZE[this.type];if(!d||1==m.length||h==m.length||0==g&&this.data[0][0]>a)return this.data[f][1];g=m[g];h=m[h];a=(h[0]-a)/(h[0]-g[0]);1<b&&(e=e||this._result,e&&e.length==b||(e=this._result=new Float32Array(b)));if(d===k.LINEAR)return 1==b?g[1]*a+h[1]*(1-a):k.interpolateLinear(g[1],h[1],a,e,this.type,b,this);if(d===k.CUBIC){d=
0<f?m[f-1]:g;f=f<m.length-2?m[f+2]:h;if(1===b)return k.EvaluateHermiteSpline(g[1],h[1],d[1],f[1],1-a);e=k.EvaluateHermiteSplineVector(g[1],h[1],d[1],f[1],1-a,e);this.type==k.QUAT?(quat.slerp(e,h[1],g[1],a),quat.normalize(e,e)):this.type==k.TRANS10&&(b=e.subarray(3,7),g=g[1].subarray(3,7),h=h[1].subarray(3,7),quat.slerp(b,h,g,a),quat.normalize(b,b));return e}return null};f.prototype.getSamplePacked=function(a,d,e){if(!this.data.length)return null;var b=k.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-
b-1]);var f=this.findTimeIndex(a);-1==f&&(f=0);var g=b+1,h=f,m=f+1,q=this.data,r=q.length/g;if(!d||1==r||m==r||0==h&&this.data[0]>a)return this.getKeyframe(f)[1];1<b&&(e=e||this._result,e&&e.length==b||(e=this._result=new Float32Array(b)));var s=q.subarray(h*g,(h+1)*g),h=q.subarray(m*g,(m+1)*g);a=(h[0]-a)/(h[0]-s[0]);if(d===k.LINEAR){if(1==b)return s[1]*a+h[1]*(1-a);g=s.subarray(1,b+1);h=h.subarray(1,b+1);return k.interpolateLinear(g,h,a,e,this.type,b,this)}if(d===k.CUBIC){if(0===b)return s[1];d=
0<f?q.subarray((f-1)*g,f*g):s;m=m<r-1?q.subarray((m+1)*g,(m+2)*g):h;if(1===b)return k.EvaluateHermiteSpline(s[1],h[1],d[1],m[1],1-a);b=s.subarray(1,g);h=h.subarray(1,g);e=k.EvaluateHermiteSplineVector(b,h,d.subarray(1,g),m.subarray(1,g),1-a,e);this.type==k.QUAT?(quat.slerp(e,h,b,a),quat.normalize(e,e)):this.type==k.TRANS10&&(g=e.subarray(3,7),b=b.subarray(3,7),h=h.subarray(3,7),quat.slerp(g,h,b,a),quat.normalize(g,g));return e}return null};f.prototype.applyTrack=function(a,d,e){d=this.getSample(d,
e);e=null;(e=a.name==this.target_node?a:a.findNodeByName(this.target_node))&&(e[this.target_property]=d);return d};k.interpolateLinear=function(a,d,e,b,f,g,h){if(1==g)return a*e+d*(1-e);b=b||h._result;b&&b.length==g||(b=h._result=new Float32Array(g));switch(f){case k.QUAT:quat.slerp(b,d,a,e);quat.normalize(b,b);break;case k.TRANS10:for(f=0;3>f;f++)b[f]=a[f]*e+d[f]*(1-e);for(f=7;10>f;f++)b[f]=a[f]*e+d[f]*(1-e);a=a.subarray(3,7);d=d.subarray(3,7);g=b.subarray(3,7);quat.slerp(g,d,a,e);quat.normalize(g,
g);break;default:for(f=0;f<g;f++)b[f]=a[f]*e+d[f]*(1-e)}return b};k.EvaluateHermiteSpline=function(a,d,e,b,f){var g=f*f,h=g*f;return(2*h-3*g+1)*a+(-2*h+3*g)*d+(h-2*g+f)*(d-e)+(h-g)*(b-a)};k.EvaluateHermiteSplineVector=function(a,d,e,b,f,g){g=g||new Float32Array(g.length);var h=f*f,k=h*f,m=2*k-3*h+1,q=-2*k+3*h;f=k-2*h+f;for(var h=k-h,k=0,s=g.length;k<s;++k)g[k]=m*a[k]+q*d[k]+f*(d[k]-e[k])+h*(b[k]-a[k]);return g};Math.lerp||(Math.lerp=g);k.Skeleton=e;h.prototype.serialize=function(){return{name:this.name,
model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};h.prototype.configure=function(a){this.name=a.name;this.model.set(a.model);this.parent=a.parent;this.layer=a.layer;this.num_children=0;a.children&&(this.children.set(a.children),this.num_children=a.children.constructor===Array?a.children.length:a.num_children)};h.prototype.copyFrom=h.prototype.configure;e.Bone=h;e.prototype.applyTransformToBones=
function(a,d){var e=this.getBone(a);e&&mat4.multiply(e.model,e.model,d)};e.prototype.getBone=function(a){return this.bones[this.bones_by_name.get(a)]};e.identity=mat4.create();e.prototype.getBoneMatrix=function(a,d){void 0===d&&(d=!0);var f=this.bones_by_name.get(a);return void 0===f?e.identity:d?this.bones[f].model:this.global_bone_matrices[f]};e.temp_mat4=mat4.create();e.temp_mat43=e.temp_mat4.subarray(0,12);e.prototype.computeFinalBoneMatrices=function(a,d,f){if(!this.bones.length||!d||!d.bones)return a||
[];this.updateGlobalMatrices();var b=f?12*d.bones.length:16*d.bones.length;a&&a.length==b||(a=new Float32Array(b));if(f){var g=e.temp_mat4,g=e.temp_mat43;for(f=0;f<d.bones.length;++f)b=d.bones[f],mat4.multiply(temp_mat4,this.getBoneMatrix(b[0],!1),b[1]),mat4.transpose(temp_mat4,temp_mat4),a.set(g,12*f)}else for(f=0;f<d.bones.length;++f)b=d.bones[f],g=a.subarray(16*f,16*f+16),mat4.multiply(g,this.getBoneMatrix(b[0],!1),b[1]);return a};e.prototype.computeFinalBoneMatricesAsArray=function(a,d,e){if(!this.bones.length||
!d||!d.bones)return a||[];this.updateGlobalMatrices();a=a||[];a.length=d.bones.length;for(var b=0;b<d.bones.length;++b){var f=d.bones[b];a[b]||(a[b]=mat4.create());var g=a[b];mat4.multiply(g,this.getBoneMatrix(f[0],!1),f[1]);d.bind_matrix&&mat4.multiply(g,g,d.bind_matrix);e&&mat4.multiply(g,e,g)}return a};e.prototype.updateGlobalMatrices=function(){var a=this.bones;if(a.length){var d=this.bones.length;this.global_bone_matrices[0].set(a[0].model);for(var e=1;e<d;++e){var b=a[e];mat4.multiply(this.global_bone_matrices[e],
this.global_bone_matrices[b.parent],b.model)}}};e.prototype.assignLayer=function(a,d){};e.prototype.getVertices=function(){if(!this.bones.length)return null;var a=6*(this.bones.length-1);this._vertices&&this._vertices.length==a||(this._vertices=new Float32Array(a));for(var a=this._vertices,d=0;d<this.bones.length-1;++d){var e=this.global_bone_matrices[this.bones[d+1].parent],b=this.global_bone_matrices[d+1],f=a.subarray(6*d,6*d+3),g=a.subarray(6*d+3,6*d+6);mat4.getTranslation(f,b);mat4.getTranslation(g,
e)}return a};e.prototype.resizeBones=function(a){if(this.bones.length!=a)if(this.bones.length>a)this.bones.length=a,this.global_bone_matrices.length=a;else{var d=this.bones.length;for(this.bones.length=a;d<a;++d)this.bones[d]=new h,this.global_bone_matrices[d]=mat4.create()}};e.prototype.copyFrom=function(a){this.resizeBones(a.bones.length);for(var d=0;d<a.bones.length;++d)this.bones[d].copyFrom(a.bones[d]),this.global_bone_matrices[d].set(a.global_bone_matrices[d]);this.bones_by_name=new Map(a.bones_by_name)};
e.prototype.serialize=function(){for(var a={bones:[],bone_names:{}},d=0;d<this.bones.length;++d)a.bones.push(this.bones[d].serialize());return a};e.prototype.configure=function(a){this.resizeBones(a.bones.length);a.bones_by_name?this.bones_by_name=new Map(a.bones_by_name):this.bones_by_name.clear();for(var d=0;d<a.bones.length;++d)this.bones[d].copyFrom(a.bones[d]),a.global_bone_matrices?this.global_bone_matrices[d].set(a.global_bone_matrices[d]):this.bones_by_name[this.bones[d].name]=d};var r=vec3.create();
e.blend=function(a,d,f,b,g,h){if(a.bones.length!=d.bones.length)console.error("skeleton must contain the same number of bones");else{f=Math.clamp(f,0,1);if(255==g){if(0==f){if(b==a)return;b.copyFrom(a);return}if(1==f){b.copyFrom(d);return}}if(b!=a){b.bones.length=a.bones.length;for(g=0;g<b.bones.length;++g)(d=b.bones[g])||(d=new e.Bone),d.copyFrom(a.bones[g]);b.bones_by_name=new Map(a.bones_by_name)}for(g=0;g<b.bones.length;++g){for(var k=b.bones[g],m=a.bones[g],q=d.bones[g],v=0;16>v;++v)k.model[v]=
Math.lerp(m.model[v],q.model[v],f);if(!h)for(k=k.model,v=0;3>v;++v)r[0]=k[0+v],r[1]=k[4+v],r[2]=k[8+v],vec3.normalize(r,r),k[0+v]=r[0],k[4+v]=r[1],k[8+v]=r[2]}}};e.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
k.SkeletalAnimation=q;q.prototype.load=function(a,d){var e=this;return HttpRequest(a,null,function(a){e.fromData(a);d&&d(e)})};q.prototype.assignTime=function(a,d,e,b){if(this.duration){d||void 0===d?(a%=this.duration,0>a&&(a=this.duration+a)):a=Math.clamp(a,0,this.duration-1/this.samples_per_second);void 0===e&&(e=!0);a*=this.samples_per_second;var f=Math.floor(a),h=(f+1)%this.num_keyframes,f=f%this.num_keyframes;a-=Math.floor(a);d=this.num_animated_bones;b=16*d;for(var f=f*b,h=h*b,k=this.skeleton,
m=this.keyframes,q=this.bones_map,r=0;r<d;++r){var s=k.bones[q[r]];b=16*r;if(e)for(var z=0;16>z;++z)s.model[z]=g(m[f+b+z],m[h+b+z],a);else s.model.set(m.subarray(f+b,f+b+16))}}};q.prototype.resize=function(a,d){this.num_keyframes=a;this.num_animated_bones=d;this.keyframes=new Float32Array(a*d*16)};q.prototype.fromData=function(a){a=a.split("\n");var d=a[0].split(",");this.duration=Number(d[0]);this.samples_per_second=Number(d[1]);this.num_keyframes=Number(d[2]);this.skeleton.resizeBones(Number(d[3]));
for(var d=0,e=1;e<a.length;++e){var b=a[e],f=b[0],b=b.substr(1).split(",");if("B"==f){var g=Number(b[0]),h=this.skeleton.bones[g];h.name=b[1];h.parent=Number(b[2]);for(f=0;16>f;++f)h.model[f]=Number(b[3+f]);-1!=h.parent&&(b=this.skeleton.bones[h.parent],16<=b.num_children?console.warn("too many child bones, max is 16"):b.children[b.num_children++]=g);this.skeleton.bones_by_name.set(h.name,g)}else if("@"==f){this.num_animated_bones=Number(b[0]);for(f=0;f<this.num_animated_bones;++f)this.bones_map[f]=
Number(b[f+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==f){g=d*this.num_animated_bones*16;f=0;for(h=16*this.num_animated_bones;f<h;++f)this.keyframes[g+f]=Number(b[f+1]);d++}else break}this.assignTime(0,!1,!1)};q.prototype.toData=function(){console.error("no toData in Skeletal Animation");return""}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
