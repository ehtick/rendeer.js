'use strict';(function(n){function a(d){if(this.constructor!==b.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();d&&this.configure(d)}function f(d){this.type=b.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=0.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=
mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();this.uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection_matrix:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(0.1,1E3)};d&&this.configure(d);this.updateMatrices()}function l(){this._root=new b.SceneNode;
this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}function h(d){this._color=vec4.fromValues(1,1,1,1);this.shader_name=null;this.uniforms={u_color:this._color};this.textures={};this.primitive=GL.TRIANGLES;this.blend_mode=b.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};d&&this.configure(d)}function e(d,b){b=b||{};var a=this.gl=this.context=d;if(!a||!a.enable)throw"litegl GL context not found.";d!=
n.gl&&a.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this.layers_affect_children=this.reverse_normals=this.sort_by_distance=!1;this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._texture_matrix=mat3.create();this._color=vec4.fromValues(1,1,1,1);this._viewprojection2D_matrix=mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,
u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_color:this._color,u_texture_matrix:this._texture_matrix};this.global_uniforms_containers=[this._uniforms];n.gl=this.gl;this.canvas=a.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:a.REPEAT,minFilter:a.LINEAR_MIPMAP_LINEAR,magFilter:a.LINEAR};this.default_cubemap_settings={minFilter:a.LINEAR_MIPMAP_LINEAR,
magFilter:a.LINEAR,is_cross:1};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:a.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:a.NEAREST,pixel_data:new Uint8Array([255,
255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.createShaders();b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}function q(d,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();d&&this.origin.set(d);b&&this.direction.set(b)}function k(d){this._ctor();d&&this.configure(d)}function r(d){this._ctor();d&&this.configure(d)}function g(d){a.prototype._ctor.call(this,
d);this._ctor();d&&this.configure(d)}function c(d,b){return vec3.dot(d,b)+d[3]}function p(d,b,a){var c=d[3],g=Math.abs(a[0]*d[0]),e=Math.abs(a[1]*d[1]);a=Math.abs(a[2]*d[2]);g=g+e+a;d=vec3.dot(d,b)+c;return d<=-g?t:d<=g?E:B}var b=n.RD={version:0.5};b.ZERO=vec3.fromValues(0,0,0);b.ONE=vec3.fromValues(1,1,1);b.RIGHT=vec3.fromValues(1,0,0);b.LEFT=vec3.fromValues(-1,0,0);b.UP=vec3.fromValues(0,1,0);b.DOWN=vec3.fromValues(0,-1,0);b.FRONT=vec3.fromValues(0,0,-1);b.BACK=vec3.fromValues(0,0,1);b.FRONT2D=
vec2.fromValues(0,1);b.WHITE=vec3.fromValues(1,1,1);b.BLACK=vec3.fromValues(0,0,0);b.IDENTITY=mat4.create();b.ONES4=vec4.fromValues(1,1,1,1);b.CENTER=0;b.TOP_LEFT=1;b.TOP_RIGHT=2;b.BOTTOM_LEFT=3;b.BOTTOM_RIGHT=4;b.TOP_CENTER=5;b.BOTTOM_CENTER=6;b.PRIORITY_BACKGROUND=30;b.PRIORITY_OPAQUE=20;b.PRIORITY_ALPHA=10;b.PRIORITY_HUD=0;b.BLEND_NONE=0;b.BLEND_ALPHA=1;b.BLEND_ADD=2;b.BLEND_MULTIPLY=3;b.NO_BILLBOARD=0;b.BILLBOARD_SPHERIC=1;b.BILLBOARD_PARALLEL_SPHERIC=2;b.BILLBOARD_CYLINDRIC=3;b.BILLBOARD_PARALLEL_CYLINDRIC=
4;b.UNKNOWN=0;b.NUMBER=b.SCALAR=1;b.VEC2=2;b.VEC3=3;b.VEC4=4;b.QUAT=5;b.MAT3=6;b.TRANS10=7;b.MAT4=8;b.TYPES={NUMBER:b.NUMBER,SCALAR:b.NUMBER,VEC2:b.VEC2,VEC3:b.VEC3,VEC4:b.VEC4,QUAT:b.QUAT,MAT3:b.MAT3,TRANS10:b.TRANS10,MAT4:b.MAT4};b.TYPES_SIZE=[0,1,2,3,4,4,9,10,16];b.NO_INTERPOLATION=0;b.LINEAR=1;b.CUBIC=2;var m=b.DEG2RAD=0.0174532925;b.RAD2DEG=57.295779578552306;b.Materials={};b.Images={};b.setup=function(d){d=d||{};if(b.configuration)throw"already called setup";b.configuration=d};var A=0;"undefined"==
typeof extendClass&&(n.extendClass=function(d,b){for(var a in b)d.hasOwnProperty(a)||(d[a]=b[a]);if(b.prototype){var g=Object.getOwnPropertyNames(b.prototype);for(a=0;a<g.length;++a){var c=g[a];d.prototype.hasOwnProperty(c)||(b.prototype.__lookupGetter__(c)?d.prototype.__defineGetter__(c,b.prototype.__lookupGetter__(c)):d.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&d.prototype.__defineSetter__(c,b.prototype.__lookupSetter__(c)))}}d.hasOwnProperty("superclass")||Object.defineProperty(d,
"superclass",{get:function(){return b},enumerable:!1})});var u=mat4.create(),w=mat3.create(),v=mat4.create(),x=vec2.create(),s=vec3.create(),y=vec3.create();vec4.create();var z=quat.create();b.SceneNode=a;a.prototype._ctor=function(){this._uid=A++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);quat.identity(this._rotation);this._scale.set(b.ONE);this._local_matrix=
mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.render_priority=b.PRIORITY_OPAQUE;this.layers=3;this._instances=this.draw_range=null;this.primitive=GL.TRIANGLES;this.primitives=[];this.mesh=null;this.textures={};this.shader=null;this.blend_mode=b.BLEND_NONE;this._color=vec4.fromValues(1,1,1,1);this.material=null;this.onRender||(this.onRender=null);this.onShaderUniforms||(this.onShaderUniforms=null);this.flags={visible:!0,collides:!0};this.children=
[];this._uniforms={u_color:this._color,u_color_texture:0}};a.ctor=a.prototype._ctor;a.prototype.clone=function(d){var b=new this.constructor,a;for(a in this)if("_"!=a[0])if("children"==a){if(d)for(var c=0;c<this.children.length;++c)b.addChild(this.children[c].clone(d))}else c=this[a],void 0!==c&&(null===c?b[a]=null:c.constructor===Object?b[a]=GL.cloneObject(c):c.constructor===Array?b[a]=c.concat():b[a]!==c&&(b[a]=c));return b};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},
set:function(d){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=d},enumerable:!0});Object.defineProperty(a.prototype,"uniforms",{get:function(){return this._uniforms},set:function(d){GL.cloneObject(d,this._uniforms);this._uniforms.u_color=this._color},enumerable:!0});Object.defineProperty(a.prototype,"position",{get:function(){return this._position},set:function(d){this._position.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,
"x",{get:function(){return this._position[0]},set:function(d){this._position[0]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"y",{get:function(){return this._position[1]},set:function(d){this._position[1]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"z",{get:function(){return this._position[2]},set:function(d){this._position[2]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rotation},
set:function(d){this._rotation.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"scaling",{get:function(){return this._scale},set:function(d){d.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=d:this._scale.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"transform",{get:function(){return this._transform},set:function(d){this._transform.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,
"matrix",{get:function(){return this._model_matrix},set:function(d){this.fromMatrix(d)},enumerable:!1});Object.defineProperty(a.prototype,"pivot",{get:function(){return this._pivot},set:function(d){this._must_update_matrix=!0;d?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(d),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(a.prototype,"color",{get:function(){return this._color},set:function(d){this._color.set(d)},enumerable:!0});Object.defineProperty(a.prototype,
"opacity",{get:function(){return this._color[3]},set:function(d){this._color[3]=d},enumerable:!0});Object.defineProperty(a.prototype,"visible",{get:function(){return this.flags.visible},set:function(d){this.flags.visible=d},enumerable:!0});Object.defineProperty(a.prototype,"texture",{get:function(){return this.textures.color},set:function(d){this.textures.color=d},enumerable:!1});Object.defineProperty(a.prototype,"scene",{get:function(){return this._scene},set:function(d){throw"cannot set scene, you must use addChild in its parent node";
},enumerable:!1});Object.defineProperty(a.prototype,"parentNode",{get:function(){return this._parent},set:function(d){throw"Cannot set parentNode of SceneNode";},enumerable:!1});a.prototype.addChild=function(d,b){function a(d,b){if(d._scene&&d._scene!=b){var C=d._scene._nodes.indexOf(d);-1!=C&&d._scene._nodes.splice(C,1);d.id&&d._scene._nodes_by_id[d.id]==d&&delete d._scene._nodes_by_id[d.id]}if(d._scene=b)b._nodes.push(d),d.id&&b&&(b._nodes_by_id[d.id]=d);if(d.children)for(var C=0,c=d.children.length;C<
c;C++){var g=d.children[C];g._scene!=b&&a(g,b)}}if(d._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";d._parent=this;b&&d.fromMatrix(d._global_matrix);this.children||(this.children=[]);this.children.push(d);this._scene!=d._scene&&a(d,this._scene)};a.prototype.removeChild=function(d,b){function a(d){if(d._scene){d.id&&d._scene._nodes_by_id[d.id]==d&&delete d._scene._nodes_by_id[d.id];var b=d._scene._nodes.indexOf(d);-1!=b&&d._scene._nodes.splice(b,1)}d._scene=null;
for(var b=0,C=d.children.length;b<C;b++)a(d.children[b])}if(d._parent!=this)throw"removeChild: Not its children";if(this.children){var c=this.children.indexOf(d);if(-1==c)throw"removeChild: impossible, should be children";this.children.splice(c,1);d._parent=null;b&&d.fromMatrix(d._global_matrix);a(d)}};a.prototype.removeAllChildren=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])};a.prototype.clear=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-
1])};a.prototype.setChildIndex=function(d,b){if(this.children){var a=this.children.indexOf(d);-1!=a&&(this.children.splice(a,1),this.children.splice(b,0,d))}};a.prototype.getAllChildren=function(d){d=d||[];if(!this.children)return d;for(var b=0,a=this.children.length;b<a;b++){var c=this.children[b];d.push(c);c.getAllChildren(d)}return d};a.prototype.getVisibleChildren=function(d,b,a){d=d||[];void 0===b&&(b=65535);if(!this.children||!1===this.flags.visible)return d;for(var c=0,g=this.children.length;c<
g;c++){var e=this.children[c],m=e.layers&b;if(!a||m)m&&d.push(e),e.getVisibleChildren(d,b)}return d};a.prototype.serialize=function(){var d={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(d.name=this.name);this.primitives&&this.primitives.length&&(d.primitives=this.primitives.concat());this.mesh&&(d.mesh=this.mesh);this.material&&
(d.material=this.material);null!=this.submesh&&(d.submesh=this.submesh);this.flags&&(d.flags=JSON.parse(JSON.stringify(this.flags)));this.extra&&(d.extra=this.extra);this.animation&&(d.animation=this.animation);if(this.onSerialize)this.onSerialize(d);if(this.children)for(var b=0,a=this.children.length;b<a;b++)d.children.push(this.children[b].serialize());return d};a.prototype.configure=function(d){var C=null,a;for(a in d){switch(a){case "children":continue;case "uniforms":for(var c in d.uniforms)this.uniforms[c]=
d.uniforms[c];continue;case "texture":this[a]=d[a];continue;case "flags":for(c in d.flags)this.flags[c]=d.flags[c];continue;case "scale":case "scaling":this.scale(d[a]);continue;case "tiling":isNumber(d[a])?this.setTextureTiling(d[a],d[a]):this.setTextureTiling(d[a][0],d[a][1],d[a][2],d[a][3]);continue;case "name":case "mesh":case "primitives":case "material":case "ref":case "draw_range":case "submesh":case "animation":this[a]=d[a];continue;case "parent":C=d[a]}var g=this[a];void 0!==g&&(g&&g.constructor===
Float32Array?g.set(d[a]):this[a]=d[a])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(d.children)for(this.removeAllChildren(),a=0;a<d.children.length;++a)c=new b.SceneNode,c.configure(d.children[a]),this.addChild(c);C&&(this.parentNode?console.error("This node already has a parent"):C.addChild(this))};a.prototype.setMesh=function(d){d?"string"==typeof d?this.mesh=d:this._mesh=d:this.mesh=null};a.prototype.setTexture=function(d,b){b?"string"==typeof b&&(this.textures[d]=b):this.textures[d]=
null};a.prototype.resetTransform=function(){this._position.set(b.ZERO);quat.identity(this._rotation);this._scale.set(b.ONE);this._must_update_matrix=!0};a.prototype.translate=function(d,b){b?this.getLocalVector(d,s):s.set(d);vec3.add(this._position,this._position,s);this._must_update_matrix=!0};a.prototype.move=a.prototype.translate;a.prototype.moveLocal=function(d){this.translate(d,!0)};a.prototype.rotate=function(d,b,a){quat.setAxisAngle(z,b,d);a?quat.multiply(this._rotation,z,this._rotation):quat.multiply(this._rotation,
this._rotation,z);this._must_update_matrix=!0};a.prototype.setRotationFromEuler=function(d){quat.fromEuler(this._rotation,d);this._must_update_matrix=!0};a.prototype.rotateQuat=function(d,b){b?quat.multiply(this._rotation,d,this._rotation):quat.multiply(this._rotation,this._rotation,d);this._must_update_matrix=!0};a.prototype.scale=function(d){d.constructor===Number?(s[0]=s[1]=s[2]=d,vec3.mul(this._scale,this._scale,s)):vec3.mul(this._scale,this._scale,d);this._must_update_matrix=!0};a.prototype.lookAt=
function(d,b,a,c){this.position=d;this.orientTo(b,c,a)};a.prototype.orientTo=function(d,a,c,g){var e=this.getGlobalPosition(),m=vec3.create();g?m.set(d):vec3.sub(m,e,d);c=c||b.UP;vec3.normalize(m,m);a&&vec3.scale(m,m,-1);d=mat3.create();c=vec3.cross(vec3.create(),c,m);vec3.normalize(c,c);a=vec3.cross(vec3.create(),m,c);vec3.normalize(a,a);mat3.setColumn(d,c,0);mat3.setColumn(d,a,1);mat3.setColumn(d,m,2);quat.fromMat3(this._rotation,d);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=
!0};a.prototype.setPivot=function(d){this.pivot=d};a.prototype.setTextureTiling=function(d,b,a,c){this.texture_matrix||(this.texture_matrix=mat3.create(),this._uniforms.u_texture_matrix=this.texture_matrix);a=a||0;c=c||0;this.shader||(this.shader="texture_transform");mat3.identity(this.texture_matrix);mat3.translate(this.texture_matrix,this.texture_matrix,[a,c]);mat3.scale(this.texture_matrix,this.texture_matrix,[d,b])};a.prototype.getLocalMatrix=function(d){this._must_update_matrix&&this.updateLocalMatrix();
return d?(d.set(this._global_matrix),d):this._local_matrix};a.prototype.getGlobalMatrix=function(d){this.updateGlobalMatrix();return d?(d.set(this._global_matrix),d):this._global_matrix};a.prototype.getGlobalRotation=function(d){d=d||vec4.create();quat.identity(d);for(var b=this,a=this._scene?this._scene._root:null;b!=a;)quat.multiply(d,b._rotation,d),b=b._parent;return d};a.prototype.updateLocalMatrix=function(){var d=this._local_matrix;this._must_update_matrix=!1;mat4.identity(d);this.flags.no_transform||
(this.flags.pivot&&this._pivot&&(d[12]=this._pivot[0],d[13]=this._pivot[1],d[14]=this._pivot[2]),mat4.translate(d,d,this._position),mat4.fromQuat(v,this._rotation),mat4.multiply(d,d,v),mat4.scale(d,d,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(d,d,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))};a.prototype.updateGlobalMatrix=function(d,b){var a=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?
(a=d?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,b)};a.prototype.updateMatrices=function(d){this.updateLocalMatrix();this.updateGlobalMatrix(d)};a.prototype.fromMatrix=function(d,a){if(a&&this._parent&&this._parent._transform){mat4.copy(this._global_matrix,
d);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);d=mat4.multiply(this._local_matrix,c,d)}c=mat4.clone(d);mat4.multiplyVec3(this._position,c,[0,0,0]);var g=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(g,c,b.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(g,c,b.UP));this._scale[2]=vec3.length(mat4.rotateVec3(g,c,b.BACK));c=mat3.fromMat4(w,c);quat.fromMat3AndQuat(this._rotation,c);d!=this._local_matrix&&mat4.copy(this._local_matrix,d);this._must_update_matrix=!1};a.prototype.getLocalPoint=
function(d,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,d,this._local_matrix)};a.prototype.getLocalVector=function(d,b){b=b||vec3.create();return vec3.transformQuat(b,d,this._rotation)};a.prototype.getGlobalPosition=function(d,a){d=d||vec3.create();if(a)return vec3.transformMat4(d,b.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return d.set(this._position),d;var c=this.getGlobalMatrix();return vec3.transformMat4(d,b.ZERO,
c)};a.prototype.getGlobalPoint=function(d,b){b=b||vec3.create();var a=this.getGlobalMatrix();return vec3.transformMat4(b,d,a)};a.prototype.localToGlobal=a.prototype.getGlobalPoint;a.prototype.globalToLocal=function(d,b){b=b||vec3.create();var a=this.getGlobalMatrix();mat4.invert(v,a);return vec3.transformMat4(b,d,v)};a.prototype.getGlobalVector=function(d,b){b=b||vec3.create();var a=this.getGlobalRotation(z);return vec3.transformQuat(b,d,a)};a.prototype.getDistanceTo=function(d){var b=this.getGlobalMatrix();
return vec3.distance(d,b.subarray(12,15))};a.prototype.findNode=function(d){for(var b=0,a=this.children.length;b<a;b++){var c=this.children[b];if(c.id==d||(c=c.findNode(d)))return c}return null};a.prototype.findNodeByName=function(d){if(null==d)return null;for(var b=0,a=this.children.length;b<a;b++){var c=this.children[b];if(c.name==d||(c=c.findNodeByName(d)))return c}return null};a.prototype.findNodesByFilter=function(d,b,a){void 0===b&&(b=65535);a=a||[];for(var c=0,g=this.children.length;c<g;c++){var e=
this.children[c];e.layers&b&&(d&&!d(e)||a.push(e),e.findNodesByFilter(d,b,a))}return a};a.prototype.propagate=function(d,b){for(var a=0,c=this.children.length;a<c;a++){var g=this.children[a];g&&(g[d]&&g[d].apply(g,b),g.children&&g.children.length&&g.propagate(d,b))}};a.prototype.loadTextConfig=function(d,a){GL.request(d,null,function(d){d=b.parseTextConfig(d);a&&a(d)},alert)};a.prototype.destroy=function(d){!this.scene||d?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)};
a.prototype.updateBoundingBox=function(d){var b=this._global_matrix,a=gl.meshes[this.mesh],c=null;a&&(c=a.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),c=BBox.transformMat4(this.bounding_box,c,b));if(d||!this.children||0==this.children.length)return c;for(d=0;d<this.children.length;++d)if(b=this.children[d].updateBoundingBox())c||(c=this.bounding_box=BBox.create()),BBox.merge(c,c,b);return c};a.prototype.testRay=function(){var d=vec3.create();vec3.create();vec3.create();vec3.create();
vec3.create();mat4.create();mat4.create();return function(b,a,c,g,e,m){c=void 0===c?Number.MAX_VALUE:c;void 0===g&&(g=65535);a=a||vec3.create();void 0!==l._ray_tested_objects&&l._ray_tested_objects++;var k=null,p=null;if(!1===this.flags.visible)return null;this.layers&g&&!this.flags.ignore_collisions&&this.mesh&&(p=this.testRayWithMesh(b,d,c,g,e,m));p&&(m=vec3.distance(b.origin,d),null==c||m<c)&&(c=m,a.set(d),k=this);if(!this.children||!this.children.length)return k;for(var p=vec3.create(),h=0;h<
this.children.length;++h){var f=this.children[h].testRay(b,p,c,g,e);f&&(m=vec3.distance(b.origin,p),m<c&&(c=m,a.set(p),k=f))}return k}}();a.prototype.testRayWithMesh=function(){var d=vec3.create(),a=vec3.create(),c=vec3.create(),g=mat4.create();return function(e,m,k,p,h,f){if(!this.mesh)return!1;var u=gl.meshes[this.mesh];if(!u||!1===u.ready)return!1;var q=null==this.submesh?-1:this.submesh,A=this._global_matrix;mat4.invert(g,A);vec3.transformMat4(d,e.origin,g);vec3.add(c,e.origin,e.direction);vec3.transformMat4(c,
c,g);vec3.sub(a,c,d);vec3.normalize(a,a);if(this.primitives&&f)for(f=0;f<this.primitives.length;++f)b.testRayMesh(e,d,a,u,this.primitives[f].index,m,k,p,h,!0);else return b.testRayMesh(e,d,a,A,u,q,m,k,p,h,this.flags.two_sided)}}();a.prototype.setRangeFromSubmesh=function(d){if(void 0!==d&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(d.constructor===String){for(var a=0;a<b.info.groups.length;++a)if(b.info.groups[a].name==d){d=a;break}if(a===b.info.groups.length)return!1}if(d=
b.info.groups[d])this.draw_range[0]=d.start,this.draw_range[1]=d.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null};a.prototype.findNodesInSphere=function(d,b,a,c){void 0===a&&(a=65535);c=c||[];for(var g=0;g<this.children.length;++g){var e=this.children[g];e.layers&a&&(e.getGlobalPosition(s,!0),vec3.distance(s,d)<=b&&c.push(e));e.children.length&&e.findNodesInSphere(d,b,a,c)}return c};b.Camera=f;f.PERSPECTIVE=1;f.ORTHOGRAPHIC=2;f.prototype.configure=
function(d){null!=d.type&&(this.type=d.type);d.position&&this._position.set(d.position);d.target&&this._target.set(d.target);d.up&&this._up.set(d.up);d.near&&(this.near=d.near);d.far&&(this.far=d.far);d.fov&&(this.fov=d.fov);d.aspect&&(this.aspect=d.aspect)};f.prototype.serialize=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};
Object.defineProperty(f.prototype,"position",{get:function(){return this._position},set:function(d){this._position.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"target",{get:function(){return this._target},set:function(d){this._target.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"up",{get:function(){return this._up},set:function(d){this._up.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,
"fov",{get:function(){return this._fov},set:function(d){this._fov=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"aspect",{get:function(){return this._aspect},set:function(d){this._aspect=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(d){this._frustum_size=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"near",{get:function(){return this._near},
set:function(d){this._near=this.uniforms.u_camera_planes[0]=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"far",{get:function(){return this._far},set:function(d){this._far=this.uniforms.u_camera_planes[1]=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(d){this._view_matrix.set(d);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},
enumerable:!1});Object.defineProperty(f.prototype,"projection_matrix",{get:function(){return this._projection_matrix},set:function(d){this._projection_matrix.set(d);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(f.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(d){this._viewprojection_matrix.set(d)},enumerable:!1});f.prototype.perspective=function(d,b,a,c){this.type=f.PERSPECTIVE;
this._fov=d;this._aspect=b;this._near=a;this._far=c;this._must_update_matrix=!0};f.prototype.orthographic=function(d,b,a,c){this.type=f.ORTHOGRAPHIC;this._frustum_size=d;1<arguments.lenth&&(this._near=b,this._far=a,this._aspect=c||1);this._must_update_matrix=!0};f.prototype.lookAt=function(d,b,a){vec3.copy(this._position,d);vec3.copy(this._target,b);vec3.copy(this._up,a);this._must_update_matrix=!0};f.prototype.updateMatrices=function(d){if(this._autoupdate_matrices||d)if(this.type==f.ORTHOGRAPHIC?
this.frustum_size.constructor===Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,
this._fov*m,this._aspect,this._near,this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up),this.view_texel_grid&&this.type==f.ORTHOGRAPHIC){d=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var a=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=
Math.floor(this._view_matrix[12]/d)*d;this._view_matrix[13]=Math.floor(this._view_matrix[13]/a)*a}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,b.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,b.UP);mat4.rotateVec3(this._front,this._model_matrix,b.FRONT);
this.distance=vec3.distance(this._position,this._target);this.uniforms.u_camera_planes[0]=this._near;this.uniforms.u_camera_planes[1]=this._far};f.prototype.getModel=function(d){d=d||mat4.create();mat4.invert(this._model_matrix,this._view_matrix);mat4.copy(d,this._model_matrix);return d};f.prototype.updateVectors=function(d){var a=vec3.subtract(s,this._target,this._position),a=vec3.length(a);mat4.multiplyVec3(this._position,d,b.ZERO);mat4.multiplyVec3(this._target,d,[0,0,-a]);mat4.rotateVec3(this._up,
d,b.UP)};f.prototype.getLocalVector=function(d,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,d)};f.prototype.getLocalPoint=function(d,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),d,this._model_matrix)};f.prototype.localToGlobal=f.prototype.getLocalPoint;f.prototype.getFront=function(d){d=d||vec3.create();vec3.subtract(d,this._target,this._position);vec3.normalize(d,d);return d};f.prototype.move=
function(d,b){void 0!==b&&(vec3.scale(s,d,b),d=s);vec3.add(this._target,this._target,d);vec3.add(this._position,this._position,d);this._must_update_matrix=!0};f.prototype.moveLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();var a=mat4.rotateVec3(s,this._model_matrix,d);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};f.prototype.rotate=function(d,b){var a=quat.setAxisAngle(z,b,d),c=vec3.subtract(s,
this._target,this._position);vec3.transformQuat(c,c,a);vec3.add(this._target,this._position,c);this._must_update_matrix=!0};f.prototype.rotateLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();var a=mat4.rotateVec3(y,this._model_matrix,b),a=quat.setAxisAngle(z,a,d),c=vec3.subtract(s,this._target,this._position);vec3.transformQuat(c,c,a);vec3.add(this._target,this._position,c);this._must_update_matrix=!0};f.prototype.orbit=function(d,b,a,c){if(!b)throw"RD: orbit axis missing";a=a||
this._target;c&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(y,this._model_matrix,b));d=quat.setAxisAngle(z,b,d);b=vec3.subtract(s,this._position,this._target);vec3.transformQuat(b,b,d);vec3.add(this._position,a,b);this._must_update_matrix=!0};f.prototype.orbitDistanceFactor=function(d,b){b=b||this._target;var a=vec3.subtract(s,this._position,b);vec3.scale(a,a,d);vec3.add(this._position,b,a);this._must_update_matrix=!0};f.prototype.project=function(d,b,a){a=a||vec3.create();
b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(a,this._viewprojection_matrix,d);a[0]=a[0]*b[2]+b[0];a[1]=a[1]*b[3]+b[1];return a};f.prototype.computeProjectedRadius=function(d,a,c,g){c=c||gl.viewport_data;if(g)return g=vec4.create(),g.set(d),g[3]=1,d=vec4.transformMat4(g,g,this._viewprojection_matrix),Math.max(1,c[3]*this._projection_matrix[5]*a/d[3]);if(this.type==b.Camera.ORTHOGRAPHIC)return a/(this._frustum_size.constructor===Number?this._frustum_size:1)*
c[3]/2;d=vec3.distance(d,this.position);return 0==d?0:1/Math.tan(this.fov/2*Math.PI/180)*a/Math.sqrt(d*d-a*a)*(c[3]/2)};f.prototype.unproject=function(d,b,a){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(a||vec3.create(),d,this._viewprojection_matrix,b)};f.prototype.getRay=function(d,a,c,g){if(void 0===d||void 0===a)throw"RD.Camera.getRay requires x and y parameters";c=c||gl.viewport_data;g||(g=new b.Ray);this._must_update_matrix&&this.updateMatrices();
var e=g.origin;vec3.set(e,d,a,0);this.type==b.Camera.ORTHOGRAPHIC?vec3.unproject(e,e,this._viewprojection_matrix,c):vec3.copy(e,this.position);var m=g.direction;vec3.set(m,d,a,1);vec3.unproject(m,m,this._viewprojection_matrix,c);vec3.sub(m,m,e);vec3.normalize(m,m);return g};f.prototype.getRayPlaneCollision=function(d,b,a,c,g,e){g=g||vec3.create();d=this.getRay(d,b,e);return geo.testRayPlane(d.origin,d.direction,a,c,g)?g:null};f.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};
f.prototype.applyController=function(d,a,c,g){c=c||10;if(d){var e=vec3.create();if(gl.keys[f.controller_keys.forward]||g&&gl.keys.W)e[2]=-1;else if(gl.keys[f.controller_keys.back]||g&&gl.keys.S)e[2]=1;if(gl.keys[f.controller_keys.left]||g&&gl.keys.A)e[0]=-1;else if(gl.keys[f.controller_keys.right]||g&&gl.keys.D)e[0]=1;vec3.sqrLen(e)&&this.moveLocal(e,d*c)}a&&(a.deltax&&this.rotate(-0.005*a.deltax,b.UP),a.deltay&&this.rotateLocal(-0.005*a.deltay,b.RIGHT))};f.prototype.lerp=function(d,b){vec3.lerp(this._position,
this._position,d._position,b);vec3.lerp(this._target,this._target,d._target,b);vec3.lerp(this._up,this._up,d._up,b);this._fov=this._fov*(1-b)+d._fov*b;this._near=this._near*(1-b)+d._near*b;this._far=this._far*(1-b)+d._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+d._frustum_sizer*b);this._must_update_matrix=!0};f.prototype.orientMatrixToCamera=function(d){d.set(this._right,0);d.set(this._top,4);d.set(this._front,8)};f.prototype.extractPlanes=function(){function d(d){var b=
a.subarray(d,d+3),b=vec3.length(b);0!==!b&&(b=1/b,a[d]*=b,a[d+1]*=b,a[d+2]*=b,a[d+3]*=b)}var b=this._viewprojection_matrix,a=this._planes_data||new Float32Array(24);a.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);d(0);a.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);d(4);a.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);d(8);a.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);d(12);a.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);d(16);a.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],
b[15]+b[14]],20);d(20);this._planes_data=a;this._frustrum_planes||(this._frustrum_planes=[a.subarray(0,4),a.subarray(4,8),a.subarray(8,12),a.subarray(12,16),a.subarray(16,20),a.subarray(20,24)])};var B=b.CLIP_INSIDE=0,t=b.CLIP_OUTSIDE=1,E=b.CLIP_OVERLAP=2;f.prototype.testMesh=function(){if(n.BBox){var d=BBox.create(),b=d.subarray(0,3),a=d.subarray(3,6);return function(c,g){var e=c.bounding;if(!e)return B;BBox.transformMat4(d,e,g);return this.testBox(b,a)}}}();f.prototype.testBox=function(d,b){this._frustrum_planes||
this.extractPlanes();var a=this._frustrum_planes,c=0,g=0,c=p(a[0],d,b);if(c==t)return t;g+=c;c=p(a[1],d,b);if(c==t)return t;g+=c;c=p(a[2],d,b);if(c==t)return t;g+=c;c=p(a[3],d,b);if(c==t)return t;g+=c;c=p(a[4],d,b);if(c==t)return t;g+=c;c=p(a[5],d,b);return c==t?t:0==g+c?B:E};f.prototype.testSphere=function(d,b){this._frustrum_planes||this.extractPlanes();var a=this._frustrum_planes,g,e=!1;g=c(a[0],d);if(g<-b)return t;g>=-b&&g<=b&&(e=!0);g=c(a[1],d);if(g<-b)return t;g>=-b&&g<=b&&(e=!0);g=c(a[2],d);
if(g<-b)return t;g>=-b&&g<=b&&(e=!0);g=c(a[3],d);if(g<-b)return t;g>=-b&&g<=b&&(e=!0);g=c(a[4],d);if(g<-b)return t;g>=-b&&g<=b&&(e=!0);g=c(a[5],d);if(g<-b)return t;g>=-b&&g<=b&&(e=!0);return e?E:B};b.Scene=l;l.prototype.clear=function(){this._root=new b.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};l.prototype.getNodeById=function(d){return this._nodes_by_id[d]};l.prototype.findNodesInBBox=function(d,b,a){void 0===b&&(b=65535);a=a||[];for(var c=0;c<this.nodes.length;++c){var g=
this.nodes[c];g.bounding_box&&g.layers&b&&geo.testBBoxBBox(g.bounding_box,d)&&a.push(g)}return a};l.prototype.update=function(d){this.time+=d;this._root.propagate("update",[d]);this.destroyPendingNodes()};l.prototype.destroyPendingNodes=function(d){if(this._to_destroy.length)for(d=null;d=this._to_destroy.pop();)d._parent&&d._parent.removeChild(d)};Object.defineProperty(l.prototype,"root",{get:function(){return this._root},set:function(d){throw"Cannot set root of scene";},enumerable:!1});l.prototype.testRay=
function(d,a,c,g,e){b.Scene._ray_tested_objects=0;a||(a=d.collision_point);void 0===e&&(e=!0);return this.root.testRay(d,a,c,void 0===g?65535:g,e)};b.testRayWithNodes=function(d,a,c,g,e,m,k){b.testRayWithNodes.coll_node=null;g=null==g?Number.MAX_VALUE:g;e=void 0===e?65535:e;b.Scene._ray_tested_objects=0;c||(c=d.collision_point);for(var p=vec3.create(),h=null,f=0;f<a.length;++f){var u=a[f],q=u.testRay(d,p,g,e,m);if(q){var A=vec3.distance(d.origin,p);A<g&&(g=A,c.set(p),b.testRayWithNodes.coll_node=
q,h=k?q:u)}}return h};b.last_hit_test=null;b.testRayMesh=function(d,a,c,g,e,m,k,p,h,f,u){p=null==p?Number.MAX_VALUE:p;var q=null;h=null;-1==m?(q=e.getBoundingBox(),h=e):(h=e.info.groups[m],q=h.bounding,q||(e.computeGroupsBoundingBoxes(),q=h.bounding));if(!q)return!1;p||(p=1E7);if(!geo.testRayBBox(a,c,q,null,s))return!1;vec3.transformMat4(k,s,g);m=vec3.distance(d.origin,k);if(m>p)return!1;if(!f)return!0;h._octree||(h._octree=h==e?new GL.Octree(e):new GL.Octree(e,h.start,h.length));a=h._octree.testRay(a,
c,0,p,u);if(!a)return!1;b.last_hit_test=a;k.set(a.hit);vec3.transformMat4(k,k,g);m=vec3.distance(d.origin,k);return m>p?!1:!0};l.prototype.fromJSON=function(d){this.root.clear();this.root.configure(d)};l.prototype.toJSON=function(d){function b(c,g){if(d){if(!d(c,g))return!1}else{if(!c.flags.no_transform){g.position=typedArrayToArray(c.position);if(0!=c.rotation[0]||0!=c.rotation[1]||0!=c.rotation[2]||1!=c.rotation[3])g.rotation=typedArrayToArray(c.rotation);if(1!=c.scaling[0]||1!=c.scaling[1]||1!=
c.scaling[2])g.scaling=typedArrayToArray(c.scaling)}c.id&&(g.id=c.id);c.ref=g.ref=a++;c.mesh&&(g.mesh=c.mesh);null!=c.submesh&&(g.submesh=c.submesh);c.draw_range&&(g.draw_range=c.draw_range.concat());c.material&&(g.material=c.material);c.shader&&(g.shader=c.shader);if(1!=c.color[0]||1!=c.color[1]||1!=c.color[2]||1!=c.color[3])g.color=typedArrayToArray(c.color);0<Object.values(c.textures).filter(function(d){return d})&&(g.shader=c.shader);c.extra&&(g.extra=c.extra);g.layers=c.layers;g.flags=c.flags}if(!c.children.length)return!0;
for(var e=[],m=0;m<c.children.length;++m){var k={};b(c.children[m],k)&&e.push(k)}e.length&&(g.children=e);return!0}d&&d.constructor!==Function&&(d=null);var a=0,c={};b(this.root,c);return c};h.default_shader_name="texture";Object.defineProperty(h.prototype,"color",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!0});Object.defineProperty(h.prototype,"opacity",{get:function(){return this._color[3]},set:function(d){this._color[3]=d},enumerable:!0});Object.defineProperty(h.prototype,
"albedo",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!1});h.prototype.configure=function(d){for(var b in d)this[b]=d[b]};h.prototype.serialize=function(){var d={flags:this.flags,textures:this.textures};d.color=typedArrayToArray(this._color);this.name&&(d.name=this.name);this.alphaMode&&(d.alphaMode=this.alphaMode);0.5!=this.alphaCutoff&&(d.alphaCutoff=this.alphaCutoff);this.uv_transform&&(d.uv_transform=this.uv_transform);this.normalFactor&&(d.normalFactor=this.normalFactor);
this.displacementFactor&&(d.displacementFactor=this.displacementFactor);this.model&&(d.model=this.model,d.metallicFactor=this.metallicFactor,d.roughnessFactor=this.roughnessFactor,this.emissive&&(d.emissive=typedArrayToArray(this.emissive)));return d};h.prototype.render=function(d,a,c,g,e){var m=this.shader_name;m||(m="pbrMetallicRoughness"==this.model?"texture_albedo":d.default_shader_name||b.Material.default_shader_name);(m=gl.shaders[m])||(m=this.textures.color||this.textures.albedo?d._texture_shader:
d._flat_shader);var k=0,p=null,h;for(h in this.textures){var f=this.textures[h];if(f){f.constructor===Object&&(f=f.texture);var q="u_"+h+"_texture";if(!m||m.samplers[q])p=gl.textures[f],p||(d.autoload_assets&&-1!=f.indexOf(".")&&d.loadTexture(f,d.default_texture_settings),p=gl.textures.white),this.uniforms[q]=p.bind(k++)}}d.enableItemFlags(this);d._uniforms.u_model.set(a);m.uniforms(d._uniforms);m.uniforms(this.uniforms);a=null;null!=e&&c.info&&c.info.groups&&c.info.groups[e]&&(a=c.info.groups[e]);
a?m.drawRange(c,this.primitive,a.start,a.length,g):m.draw(c,this.primitive,g);d.disableItemFlags(this);d.draw_calls+=1};b.Material=h;b.Renderer=e;Object.defineProperty(e.prototype,"color",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!0});e.prototype.setDataFolder=function(d){d?(this.assets_folder=d,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};e.prototype.clear=function(d){d?this.gl.clearColor(d[0],d[1],d[2],3<=d.length?
d[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};e._sort_by_dist_func=function(d,b){return b._distance-d._distance};e._sort_by_priority_func=function(d,b){return b.render_priority-d.render_priority};e._sort_by_priority_and_dist_func=function(d,b){var a=b.render_priority-d.render_priority;return 0!=a?a:b._distance-d._distance};e.prototype.render=function(d,a,c,g,e,m){null==g&&(g=65535);if(!d)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=
null,"Cannot render an scene while rendering an scene";a=a||d.camera;if(!a)throw"Renderer.render: camera not provided";n.gl=this.gl;this._nodes.length=0;c||d._root.getVisibleChildren(this._nodes,g,this.layers_affect_children);c=c||this._nodes;this.enableCamera(a);this.enable2DView();this._state=[];this._meshes_missing=0;this._current_scene=d;this._uniforms.u_time=d.time;this.sort_by_distance&&c.forEach(function(d){d._distance=d.getDistanceTo(a._position)});var k=this;c=c.filter(function(d){return!d.mustRender||
!1!=d.mustRender(k,a)});this.sort_by_distance&&this.sort_by_priority?c.sort(b.Renderer._sort_by_priority_and_dist_func):this.sort_by_priority?c.sort(b.Renderer._sort_by_priority_func):this.sort_by_distance&&c.sort(b.Renderer._sort_by_dist_func);if(this.onPreRender)this.onPreRender(a);d._root.preRender&&d._root.preRender(this,a);if(e=e||this.pipeline)e.render(this,c,a,d,m);else{for(e=0;e<c.length;++e){m=c[e];m.updateGlobalMatrix(!0);if(this.onPreRenderNode)this.onPreRenderNode(m,a);m.preRender&&m.preRender(this,
a)}for(e=0;e<c.length;++e)m=c[e],m.flags.was_rendered=!1,!1!==m.flags.visible&&m.layers&g&&(!this.mustRenderNode||!1!==this.mustRenderNode(m,a))&&(m.flags.was_rendered=!0,this.setModelMatrix(m._global_matrix),m.render?m.render(this,a):this.renderNode(m,a));d._root.postRender&&d._root.postRender(this,a);for(e=0;e<c.length;++e)if(m=c[e],m.postRender&&m.postRender(this,a),this.onPostRenderNode)this.onPostRenderNode(m,a)}if(this.onPostRender)this.onPostRender(a);d.frame++;this.frame++;this._current_scene=
null};e.prototype.enableCamera=function(d){this._camera=d;d.updateMatrices();d.extractPlanes();this._view_matrix.set(d._view_matrix);this._projection_matrix.set(d._projection_matrix);this._viewprojection_matrix.set(d._viewprojection_matrix);this._uniforms.u_camera_position=d.position};e.prototype.enable2DView=function(){mat4.ortho(this._viewprojection2D_matrix,0,gl.viewport_data[2],0,gl.viewport_data[3],-1,1)};e.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};
e.prototype.restoreState=function(){var d=this.state.pop(),b=this.camera=d.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=d.nodes};e.prototype.setModelMatrix=function(d){this._model_matrix.set(d);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,d)};e.prototype.setGlobalUniforms=function(d){for(var b in d)this._uniforms[b]&&this._uniforms[b].set?
this._uniforms[b].set(d[b]):this._uniforms[b]=d[b]};var D={u_model:null};e.prototype.renderNode=function(d,a){var c=null;d._mesh?c=d._mesh:d.mesh&&(c=gl.meshes[d.mesh],c||(this._meshes_missing++,this.autoload_assets&&-1!=d.mesh.indexOf(".")&&this.loadMesh(d.mesh)));if(d.primitives&&d.primitives.length){if(c)for(var g=0;g<d.primitives.length;++g){var e=d.primitives[g];(e=this.overwrite_material||b.Materials[e.material])&&this.renderMeshWithMaterial(d._global_matrix,c,e,"triangles",g)}}else{if(c&&(d.material||
this.overwrite_material)&&(e=this.overwrite_material||b.Materials[d.material])){if(e.render){this.renderMeshWithMaterial(d._global_matrix,c,e,d.indices,d.submesh);return}d.color=e.color}if(c){e=!1;d._instances&&(1<gl.webgl_version||gl.extensions.ANGLE_instanced_arrays)&&(e=!0);var m=null,k=d.shader;this.on_getShader?m=this.on_getShader(d,a):(!m&&d.shader&&(m=gl.shaders[k]),this.shader_overwrite&&(m=gl.shaders[this.shader_overwrite]));m||(m=d.textures.color?this._texture_shader:this._flat_shader);
e&&!m.attributes.u_model&&(e=!1);var k=0,p=null;for(g in d.textures){var h=d.textures[g];if(h){h.constructor===Object&&(h=h.texture);var f="u_"+g+"_texture";if(!m||m.samplers[f])p=gl.textures[h],p||(this.autoload_assets&&-1!=h.indexOf(".")&&this.loadTexture(h,this.default_texture_settings),p=gl.textures.white),d.flags.pixelated?(p.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST)):!1===d.flags.pixelated&&(p.bind(0),
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)),d._uniforms[f]=p.bind(k++)}}this.ignore_flags||this.enableItemFlags(d);if(d.onRender)d.onRender(this,a,m);for(g=0;g<this.global_uniforms_containers.length;++g)m.uniforms(this.global_uniforms_containers[g]);this.skip_node_uniforms||m.uniforms(d._uniforms);if(d.onShaderUniforms)d.onShaderUniforms(this,m);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,
m,d);g=null;null!=d.submesh&&c.info&&c.info.groups&&c.info.groups[d.submesh]&&(g=c.info.groups[d.submesh]);e?(D.u_model=d._instances,g?m.drawInstanced(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.indices,D,g.start,g.length):d.draw_range?m.drawInstanced(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.indices,D,d.draw_range[0],d.draw_range[1]):m.drawInstanced(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.indices,D)):g?m.drawRange(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,g.start,g.length,
d.indices):d.draw_range?m.drawRange(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.draw_range[0],d.draw_range[1],d.indices):m.draw(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.indices);this.ignore_flags||this.disableItemFlags(d);this.draw_calls+=1}else if(d.onRender)d.onRender(this,a)}};e.prototype.renderMesh=function(d,a,c,g,e,m,k,p){a&&(g&&this._uniforms.u_color.set(g),d||(d=b.IDENTITY),this._uniforms.u_model.set(d),e||(e=c?gl.shaders.texture:gl.shaders.flat),c&&(this._uniforms.u_texture=
c.bind(0)),e.uniforms(this._uniforms),e.draw(a,void 0===m?gl.TRIANGLES:m,k),this.draw_calls+=1)};e.prototype.renderMeshWithMaterial=function(d,b,a,c,g){a.render&&a.render(this,d,b,c,g)};e.prototype.renderBounding=function(d,a){if(d){a=a||b.IDENTITY;var c=this._uniforms.u_model,g=null,g=d.constructor===GL.Mesh?d._bounding:d,e=g.subarray(3,6);mat4.translate(c,a,g.subarray(0,3));mat4.scale(c,c,[2*e[0],2*e[1],2*e[2]]);this.renderMesh(c,gl.meshes.cube,null,[1,1,0,1],null,gl.LINES,"wireframe")}};e.prototype.enableItemFlags=
function(d){var a=d.flags.flip_normals;this.reverse_normals&&(a=!a);gl.frontFace(a?gl.CW:gl.CCW);gl[!1===d.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST);!1===d.flags.depth_write&&gl.depthMask(!1);gl[!0===d.flags.two_sided?"disable":"enable"](gl.CULL_FACE);if(d.blend_mode!==b.BLEND_NONE)switch(gl.enable(gl.BLEND),d.blend_mode){case b.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case b.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case b.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,
gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND);"BLEND"==d.alphaMode&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};e.prototype.disableItemFlags=function(d){d.flags.flip_normals&&gl.frontFace(gl.CCW);!1===d.flags.depth_test&&gl.enable(gl.DEPTH_TEST);d.blend_mode!==b.BLEND_NONE&&gl.disable(gl.BLEND);d.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===d.flags.depth_write&&gl.depthMask(!0);"BLEND"==d.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};e.prototype.setPointSize=
function(d){this.point_size=d;gl.shaders.point.uniforms({u_pointSize:this.point_size})};b.Renderer.prototype.renderPoints=function(d,a,c,g,e,m,k,p){if(!d||d.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";e||(p?(e=this.shaders._points_textured,e||(e=this.shaders._points_textured=new GL.Shader(b.points_vs_shader,b.points_fs_shader,{TEXTURED:""}),e.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(e=this.shaders._points,e||(e=this.shaders._points=new GL.Shader(b.points_vs_shader,
b.points_fs_shader),e.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));m=m||1;var h=1024;g=g||d.length/3;var f=null,q=null,u=this._points_mesh;g>d.length/3&&(g=d.length/3);!u||d.length>3*h?(g>h&&(h=GL.Texture.nextPOT(g)),f=new Float32Array(3*h),q=new Float32Array(4*h),u=this._points_mesh=GL.Mesh.load({vertices:f,extra4:q})):(f=this._points_mesh.getBuffer("vertices").data,q=this._points_mesh.getBuffer("extra4").data);f.set(f.length>d.length?d:d.subarray(0,f.length));a?q.set(q.length>a.length?a:a.subarray(0,
q.length)):q.fill&&q.fill(0);u.upload(GL.DYNAMIC_STREAM);e.setUniform("u_color",this._color);e.setUniform("u_pointSize",m);e.setUniform("u_camera_perspective",c._projection_matrix[5]);e.setUniform("u_viewport",gl.viewport_data);e.setUniform("u_viewprojection",c._viewprojection_matrix);p&&e.setUniform("u_texture",p.bind(0));e.drawRange(u,void 0!==k?k:GL.POINTS,0,g);return u};b.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = a_vertex;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
b.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
e.prototype.renderLines=function(d,a,c,g){if(!d||d.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var e=this.shaders._lines;e||(e=this.shaders._lines=new GL.Shader(b.lines_vs_shader,this._flat_fragment_shader));var m=this._camera,k=1024,p=d.length/3,h=c?2*p:4*p,f=null,q=null,u=null,k=this._lines_mesh;!k||3*h>k.getBuffer("vertices").data.length?(k=GL.Texture.nextPOT(h),f=new Float32Array(3*k),q=new Float32Array(3*k),u=new Float32Array(2*k),indices_data=new Uint16Array(3*
k),k=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:f,normals:q,extra2:u})):(f=this._lines_mesh.getBuffer("vertices").data,q=this._lines_mesh.getBuffer("normals").data,u=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data);var h=vec2.fromValues(-1,-1),A=vec2.fromValues(1,-1),l=vec2.fromValues(-1,1),r=vec2.fromValues(1,1),n=vec3.create();if(c)throw"strip lines not supported yet";c=Math.floor(p/2);for(var w=0;w<c;++w){var v=2*w,s=
d.subarray(3*v,3*v+3),v=d.subarray(3*v+3,3*v+6);vec3.sub(n,v,s);f.set(s,12*w);f.set(s,12*w+3);f.set(v,12*w+6);f.set(v,12*w+9);q.set(n,12*w);q.set(n,12*w+3);q.set(n,12*w+6);q.set(n,12*w+9);u.set(h,8*w);u.set(A,8*w+2);u.set(l,8*w+4);u.set(r,8*w+6);indices_data.set([4*w+0,4*w+2,4*w+1,4*w+1,4*w+2,4*w+3],6*w)}k.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);e.setUniform("u_model",g||b.IDENTITY);e.setUniform("u_color",this._color);e.setUniform("u_camera_front",m._front);e.setUniform("u_camera_position",
m.eye);e.setUniform("u_lineWidth",0.5*a);e.setUniform("u_camera_perspective",m._projection_matrix[5]);e.setUniform("u_viewport",gl.viewport_data);e.setUniform("u_viewprojection",m._viewprojection_matrix);e.drawRange(k,gl.TRIANGLES,0,6*p);return k};b.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
e.prototype.loadMesh=function(d,b,a){if(!d)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[d]&&!this.assets_not_found[d]){var c=this.meshes[d];if(c)return b&&b(c),c;var g=this,c=d;-1!=c.indexOf("://")||a||(c=this.assets_folder+d);a=GL.Mesh.fromURL(c,function(a){a?g.meshes[d]=a:(g.assets_not_found[d]=!0,delete g.meshes[d]);g.num_assets_loading--;delete g.assets_loading[d];b&&b(a,d)});this.assets_loading[d]=a;this.num_assets_loading++;return this.meshes[d]=a}};e.prototype.loadTexture=
function(d,b,a,c){function g(b){k.debug&&console.log(" + texture loaded: "+d);b?k.textures[e]=b:k.assets_not_found[d]=!0;a&&a(b,e);k.num_assets_loading--;delete k.assets_loading[d];if(k.on_texture_load)k.on_texture_load(b,e)}if(!d)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[d]&&!this.assets_not_found[d]){var e=d;b&&(b.name&&(e=b.name),b.preview&&(e=b.preview));var m=this.textures[e];if(m&&!m.is_preview)return a&&a(m),m;var k=this,m=d;-1!=m.indexOf("://")||c||
(m=this.assets_folder+d);var p=null;-1!=d.indexOf("CUBEMAP")?p=GL.Texture.cubemapFromURL(m,this.default_cubemap_settings,g):this.credentials?(this.credentials.headers?this.credentials.headers["Content-Type"]="application/octet-stream":this.credentials.headers={"Content-Type":"application/octet-stream"},p=new GL.Texture(1,1,b),fetch(m,this.credentials).then(function(d){if(!d.ok)throw Error("HTTP "+d.status+":"+d.statusText);return d.arrayBuffer()}).then(function(d){var a=URL.createObjectURL(new Blob([d]));
b.texture=p;p=GL.Texture.fromURL(a,b,g);b.texture=null;setTimeout(function(){URL.revokeObjectURL(a)},6E4)})):p=GL.Texture.fromURL(m,b,g);b&&b.preview&&(p.is_preview=!0);this.assets_loading[d]=p;this.num_assets_loading++;return this.textures[e]=p}};e.prototype.loadTextureAtlas=function(d,b,a){"string"==typeof d&&(d=JSON.parse(d));var c=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(b){var g=d.files;c.textures[":atlas"]=b;for(var e in g)if(!c.textures[e]||c.textures[e].is_preview){var m=
g[e],k=new GL.Texture(d.size,d.size,{wrap:gl.REPEAT,filter:gl.LINEAR});k.drawTo(function(){b.gl.drawTexture(b,0,0,d.size,d.size,m.x,m.y,m.width||d.size,m.height||d.size)});k.is_preview=!0;c.textures[e]=k}a&&a(g)})};e.prototype.loadShaders=function(d,b,a,c){var g=this;-1!=d.indexOf("://")||c||(d=this.assets_folder+d);d+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(d,function(d){g.compileShadersFromAtlas(d,a);g.loading_shaders=!1;b&&b(d)})};e.prototype.reloadShaders=function(d){};
e.prototype.compileShadersFromAtlasCode=function(d,b){var a=GL.processFileAtlas(d);this.compileShadersFromAtlas(a,b)};e.prototype.compileShadersFromAtlas=function(d,b){var a=d.shaders;if(a){this.shader_files=d;for(var c in d)d[c]=GL.Shader.expandImports(d[c],d);a=a.split("\n");for(c=0;c<a.length;++c){var g=a[c].trim().split(" "),e=g[0].trim();if("//"!=e.substr(0,2)){var m=d[g[1]],k=d[g[2]],p=null,h={};if(3<g.length)for(var f=3;f<g.length;++f)if("#"==g[f][0])h[g[f].substr(1)]=!0;else{p=g.slice(f).join(" ");
break}if(!h.WEBGL1||1==gl.webgl_version)if(!h.WEBGL2||2==gl.webgl_version){g[1]&&"@"==g[1][0]&&(h=g[1].substr(1)+"_VERTEX_SHADER",GL.Shader[h]&&(m=GL.Shader[h]));g[2]&&"@"==g[2][0]&&(h=g[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[h]&&(k=GL.Shader[h]));if(p)try{p=JSON.parse(p)}catch(q){console.error("Error in shader macros: ",e,p,q)}if(p&&b){var h={},u;for(u in p)h[u]=p[u];for(u in b)h[u]=b[u];p=h}else b&&(p=b);try{m&&k?this.shaders[e]?this.shaders[e].updateShader(m,k,p):this.shaders[e]=new GL.Shader(m,
k,p):console.warn("Shader subfile not found: ",g[1],g[2])}catch(A){GL.Shader.dumpErrorToConsole(A,m,k)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};e.prototype.setShadersFromFile=function(b){b=GL.processFileAtlas(b);this.compileShadersFromAtlas(b)};e.cubemap_info=[{front:[1,0,0],up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];e.prototype.renderToCubemap=
function(d,a,c,g,m,k,p){var h=e.cubemap_camera;h||(e.cubemap_camera=h=new b.Camera);h.perspective(90,1,k||0.1,p||1E3);var f=vec3.create(),q=this;d.drawTo(function(b,d){var k=e.cubemap_info[d];vec3.add(f,c,k.front);h.lookAt(c,f,k.up);q.clear();q.render(a,h,g,m)});return d};e.prototype.drawSphere3D=function(b,a,c){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var g=gl.shaders.flat;g.setUniform("u_color",c);g.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(v);
mat4.translate(v,v,b);mat4.scale(v,v,[a,a,a]);g.setUniform("u_model",v);g.draw(gl.meshes.sphere);this.draw_calls+=1};e.prototype.drawCircle2D=function(b,a,c,g,e){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:0.02,slices:64}));var m=gl.shaders.flat;m.setUniform("u_color",g);m.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(v);mat4.translate(v,v,[b,a,0]);mat4.scale(v,v,[2*c,2*c,2*
c]);m.setUniform("u_model",v);m.draw(gl.meshes[e?"circle":"ring"]);this.draw_calls+=1};e.prototype.drawLine2D=function(d,a,c,g,e,m,k){var p=gl.meshes.plane;k=k||gl.shaders.flat;k.setUniform("u_color",m);k.setUniform("u_viewprojection",this._viewprojection2D_matrix);var h=c-d,f=g-a;m=Math.atan2(h,f);h=Math.sqrt(h*h+f*f);e/=2;mat4.identity(v);mat4.translate(v,v,[0.5*(d+c),0.5*(a+g),0]);mat4.rotate(v,v,m,b.FRONT);d=e;mat4.scale(v,v,[d,h,d]);k.setUniform("u_model",v);k.draw(p);this.draw_calls+=1};b.sortByDistance=
function(b,a){b.forEach(function(b){b._distance=b.getDistanceTo(a)});b.sort(function(b,d){return d._distance-b._distance})};b.noBlending=function(d){return d.blend_mode===b.BLEND_NONE};b.generateTextureAtlas=function(b,a,c,g,e){a=a||1024;c=c||1024;g=g||64;var m=0,k;for(k in b)m++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var m=new GL.Texture(a,c),p={width:a,height:c,size:g,files:{}},h=0,f=0,q={};m.drawTo(function(){for(var m in b)if(":"!=m[0]&&"white"!=m&&"black"!=m&&
"notfound"!=m){var k=b[m];if(!k.is_preview&&k.texture_type==gl.TEXTURE_2D){if(e){var u=k.toBase64().hashCode();if(q[u]){p.files[m]=p.files[q[u]];continue}q[u]=m}p.files[m]={x:h,y:f};k.renderQuad(h,f,g,g);h+=g;if(h==a&&(h=0,f+=g,f==c)){console.warn("Atlas too small, some textures wont be stored.");break}}}});m.info=p;console.log(p);return m};e.prototype.computeResourcesLoaded=function(b){var a=0,c;for(c in b){var g=b[c],e=this.textures[g];e&&!1===e.ready||(g=this.meshes[g])&&!1===g.ready||(e||g)&&
a++}return a};Object.defineProperty(e.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(b){},enumerable:!0});Object.defineProperty(e.prototype,"textures",{get:function(){return this.gl.textures},set:function(b){},enumerable:!0});Object.defineProperty(e.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(b){},enumerable:!0});e.prototype.addMesh=function(b,a){a.gl!=this.gl&&(a=a.cloneShared(this.gl));this.gl.meshes[b]=a};b.Renderer=e;b.Ray=q;q.prototype.testPlane=
function(b,a){return geo.testRayPlane(this.origin,this.direction,b,a,this.collision_point)};q.prototype.testSphere=function(b,a,c){return geo.testRaySphere(this.origin,this.direction,b,a,this.collision_point,c)};q.prototype.closestPointOnRay=function(b,a,c){c=c||vec3.create();var g=vec3.create();vec3.add(g,this.origin,this.direction);var e=vec3.create();vec3.add(e,b,a);geo.closestPointBetweenLines(this.origin,g,b,e,null,c);return c};b.Factory=function(d,a,c){d=b.Factory.templates[d];var g=new b.SceneNode;
d&&g.configure(d);a&&(a.constructor===b.Scene?a.root:a).addChild(g);c&&g.configure(c);return g};b.Factory.templates={grid:{mesh:"grid",primitive:1,color:[0.5,0.5,0.5,0.5],blend_mode:b.BLEND_ALPHA},mesh:{shader:"phong"},sphere:{mesh:"sphere",shader:"phong"},floor:{mesh:"planeXZ",scaling:10,shader:"phong"}};k.prototype._ctor=function(){a.prototype._ctor.call(this);this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=
this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};k.prototype.updateVertices=function(b){b&&(this.vertices=b);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};k.prototype.updateNormals=function(b){b&&
(this.normals=b);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};k.prototype.updateCoords=function(b){b&&(this.coords=b);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*
this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};k.prototype.updateIndices=function(b){b&&(this.indices=b);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,
GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=b.length};k.prototype.render=function(b,a){if(this._total){var c=b.shaders[this.shader||"flat"];if(c){b.setModelMatrix(this._global_matrix);var g=this._mesh,e=this._total_indices?this._total_indices:this._total/3;b.enableItemFlags(this);c.uniforms(b._uniforms).uniforms(this._uniforms).drawRange(g,void 0===this.primitive?GL.TRIANGLES:this.primitive,0,e,this._total_indices?
"triangles":null);b.disableItemFlags(this)}}};extendClass(k,a);b.DynamicMeshNode=k;r.prototype._ctor=function(){a.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=b.TOP_LEFT;this.blend_mode=b.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};
Object.defineProperty(r.prototype,"angle",{get:function(){return this._angle},set:function(d){this._angle=d;quat.setAxisAngle(this._rotation,b.FRONT,this._angle*m);this._must_update_matrix=!0},enumerable:!0});r.prototype.setSize=function(b,a){this.size[0]=b;this.size[1]=a};r.createFrames=function(b,a,c){c=c||{};var g;b.constructor!=Number?(num_columns=b[0],g=b[1]):g=num_columns=b;var e=b=0,m=1/num_columns,k=1/g;g*=num_columns;if(!a){a=[];for(var p=0;p<g;++p)a.push(String(p))}for(p=0;p<a.length&&!(c[a[p]]=
{pos:[b,e],size:[m,k],normalized:!0},b+=m,1<=b&&(b=0,e+=k),1<=e);++p);return c};r.prototype.createFrames=function(b,a){r.createFrames(b,a,this.frames)};r.prototype.addFrame=function(b,a,c,g,e,m){this.frames[b]={pos:vec2.fromValues(a,c),size:vec2.fromValues(g,e),normalized:!!m}};r.prototype.updateTextureMatrix=function(b){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var a=b.textures[this.texture];if(!a&&b.autoload_assets){var c=this;-1!=this.texture.indexOf(".")&&b.loadTexture(this.texture,
b.default_texture_settings,function(b){b&&0==c.size[0]&&0==c.size[0]&&c.setSize(b.width,b.height)});a=gl.textures.white}if(!a)return!1;b=this.texture_matrix;var g=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!g)return!1;if(!g)return this.flags.flipX&&(x[0]=this.flags.flipX?1:0,x[1]=0,mat3.translate(b,b,x),x[0]=this.flags.flipX?-1:1,x[1]=1,mat3.scale(b,b,x)),!0;if(g.normalized)x[0]=this.flags.flipX?g.pos[0]+g.size[0]:g.pos[0],x[1]=1-g.pos[1]-g.size[1],mat3.translate(b,b,x),x[0]=
g.size[0]*(this.flags.flipX?-1:1),x[1]=g.size[1];else{var e=a.height;x[0]=(this.flags.flipX?g.pos[0]+g.size[0]:g.pos[0])/a.width;x[1]=(e-g.pos[1]-g.size[1])/e;mat3.translate(b,b,x);x[0]=g.size[0]*(this.flags.flipX?-1:1)/a.width;x[1]=g.size[1]/a.height}mat3.scale(b,b,x);return!0};r.prototype.render=function(a,c){if(this.texture&&this.updateTextureMatrix(a)){var g=a.textures[this.texture];if(g){this.flags.pixelated&&(g.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?
gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.billboard_mode&&b.orientNodeToCamera(this.billboard_mode,this,c,a);0==this.size[0]&&!1!==g.ready&&(this.size[0]=g.width);0==this.size[1]&&!1!==g.ready&&(this.size[1]=g.height);var e=this.size,m=0,k=0;v.set(this._global_matrix);var p=!1;this.current_frame&&this.current_frame.size&&(e=this.current_frame.size,p=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case b.TOP_LEFT:m=
0.5;k=-0.5;break;case b.TOP_CENTER:k=-0.5;break;case b.TOP_RIGHT:m=-0.5;break;case b.BOTTOM_LEFT:k=m=0.5;break;case b.BOTTOM_CENTER:k=0.5;break;case b.BOTTOM_RIGHT:m=-0.5,k=0.5}mat4.translate(v,v,[m*g.width*e[0],k*g.height*e[1],0])}p?mat4.scale(v,v,[g.width*e[0],g.height*e[1],1]):mat4.scale(v,v,[this.size[0],this.size[1],1]);a.setModelMatrix(v);a.renderNode(this,a,c)}}};extendClass(r,a);b.Sprite=r;g.prototype._ctor=function(){this.mesh="cube";this.shader="skybox";this.scaling=[10,10,10];this.flags.depth_test=
!1;this.flags.two_sided=!0};g.prototype.render=function(b,a){this.position=a.position;this.updateGlobalMatrix(!0);b.setModelMatrix(this._global_matrix);b.renderNode(this,a)};extendClass(g,a);b.Skybox=g;b.parseTextConfig=function(b){function a(b,d){for(var g=c.shift();g;)if(0==g.trim().length)g=c.shift();else{for(var e=0;"\t"==g[e]&&e<g.length;)e++;if(e<d)break;var m={children:[]};try{var k=g.trim();-1!=k.indexOf(":")&&(k="{"+k+"}");var p=new Function("return "+k);m.data=p()}catch(h){console.error(h)}e>=
d&&(b&&b.children.push(m),g=a(m,e+1))}return g}var c=b.split("\n");b={data:"",children:[]};a(b,0);return b};e.prototype.createShaders=function(){var a="",c="";b.Skeleton&&(a="\n\t\t#ifdef SKINNING\n\t\t\t"+b.Skeleton.shader_code+"\n\t\t#endif\n\t\t",c="\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t");a=this._vertex_shader="\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tattribute vec3 a_normal;\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec3 v_pos;\n\t\t\t\tvarying vec3 v_normal;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\t"+
a+"\n\t\t\t\t#ifdef INSTANCING\n\t\t\t\t\tattribute mat4 u_model;\n\t\t\t\t#else\n\t\t\t\t\tuniform mat4 u_model;\n\t\t\t\t#endif\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tvoid main() {\n\t\t\t\t\tv_pos = a_vertex;\n\t\t\t\t\tv_normal = a_normal;\n\t\t\t\t\t"+c+"\n\t\t\t\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t\t\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t\t\tgl_PointSize = 2.0;\n\t\t\t\t}\t\t\t\t";
c=this._flat_fragment_shader="\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,c);gl.shaders.flat_instancing=this._flat_instancing_shader=new GL.Shader(a,c,{INSTANCING:""});gl.shaders.flat_skinning=this._flat_skinning_shader=new GL.Shader(a,c,{SKINNING:""});this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t",
"\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=this._color_shader;c="\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\t\t}\t";
gl.shaders.texture=this._texture_shader=new GL.Shader(a,c);gl.shaders.texture_albedo=this._texture_albedo_shader=new GL.Shader(a,c,{ALBEDO:""});gl.shaders.texture_instancing=this._texture_instancing_shader=new GL.Shader(a,c,{INSTANCING:""});gl.shaders.texture_albedo_instancing=this._texture_albedo_instancing_shader=new GL.Shader(a,c,{ALBEDO:"",INSTANCING:""});b.Skeleton&&(gl.shaders.texture_skinning=this._texture_skinning_shader=new GL.Shader(a,c,{SKINNING:""}));this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_mvp;\n\t\tuniform mat3 u_texture_matrix;\n\t\tvoid main() {\n\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform float u_global_alpha_clip;\n\t\tuniform sampler2D u_color_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\t");gl.shaders.texture_transform=this._texture_transform_shader;this._phong_uniforms={u_ambient:vec3.create(),u_light_vector:vec3.fromValues(0.5442,0.6385,0.544),
u_light_color:b.WHITE};c=this._fragment_shader="\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec3 u_ambient;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_vector;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef TEXTURED\n\t\t\t\tuniform sampler2D u_color_texture;\n\t\t\t#endif\n\t\t\t#ifdef UNIFORMS\n\t\t\t\tUNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef TEXTURED\n\t\t\t\t\tcolor *= texture2D( u_color_texture, v_coord );\n\t\t\t\t#endif\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(u_light_vector,N));\n\t\t\t\t#ifdef EXTRA\n\t\t\t\t\tEXTRA\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color * (vec4(u_ambient,1.0) + NdotL * vec4(u_light_color,1.0));\n\t\t\t}\t";
gl.shaders.phong=this._phong_shader=new GL.Shader(a,c);this._phong_shader._uniforms=this._phong_uniforms;this._phong_shader.uniforms(this._phong_uniforms);gl.shaders.phong_instancing=this._phong_instancing_shader=new GL.Shader(a,c,{INSTANCING:""});this._phong_instancing_shader._uniforms=this._phong_uniforms;this._phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.textured_phong=this._textured_phong_shader=new GL.Shader(a,c,{TEXTURED:""});this._textured_phong_shader.uniforms(this._phong_uniforms);
gl.shaders.textured_phong_instancing=this._textured_phong_instancing_shader=new GL.Shader(a,c,{INSTANCING:"",TEXTURED:""});this._textured_phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.normal=this._normal_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4( normalize(v_normal),1.0);\n\t\t\t}\t");gl.shaders.uvs=this._uvs_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(v_coord,0.0,1.0);\n\t\t\t}\t")};
b.orientNodeToCamera=function(a,c,g,e){if(a){if(a==b.BILLBOARD_CYLINDRIC||a==b.BILLBOARD_PARALLEL_CYLINDRIC){var m=null;a==b.BILLBOARD_CYLINDRIC?(m=c.getGlobalPosition(y),vec3.sub(s,g._position,m),x[0]=s[0],x[1]=s[2]):(x[0]=g._front[0],x[1]=g._front[2]);a=vec2.computeSignedAngle(x,b.FRONT2D);isNaN(a)||(mat4.rotateY(v,u,-a),c._global_matrix.set(v),mat4.setTranslation(c._global_matrix,c._position),mat4.scale(c._global_matrix,c._global_matrix,c._scale))}else a==b.BILLBOARD_PARALLEL_SPHERIC?(c._global_matrix.set(g._model_matrix),
mat4.setTranslation(c._global_matrix,c._position)):(mat4.lookAt(c._global_matrix,c._position,g.position,b.UP),mat4.invert(c._global_matrix,c._global_matrix)),mat4.scale(c._global_matrix,c._global_matrix,c._scale);e.setModelMatrix(c._global_matrix)}};b.readPixels=function(b,a){var c=new Image;c.src=b;c.onload=function(){var b=document.createElement("canvas");b.width=this.width;b.height=this.height;var d=b.getContext("2d");d.drawImage(this,0,0);b=d.getImageData(0,0,b.width,b.height);a(b,this)}};"undefined"==
typeof GL&&(mat4.rotateVec3=function(b,a,c){var g=c[0],e=c[1];c=c[2];b[0]=a[0]*g+a[4]*e+a[8]*c;b[1]=a[1]*g+a[5]*e+a[9]*c;b[2]=a[2]*g+a[6]*e+a[10]*c;return b},mat4.projectVec3=function(b,a,c){var g=c[0],e=c[1];c=c[2];var m=a[1]*g+a[5]*e+a[9]*c+a[13],k=a[2]*g+a[6]*e+a[10]*c+a[14],p=a[3]*g+a[7]*e+a[11]*c+a[15];b[0]=((a[0]*g+a[4]*e+a[8]*c+a[12])/p+1)/2;b[1]=(m/p+1)/2;b[2]=(k/p+1)/2;return b})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(n){function a(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);
this._meshes={};this._last_point_id=this._accumulated_time=0}function f(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.velocity_variation=
this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function l(){this._ctor()}function h(a){this._ctor();a&&this.configure(a)}extendClass(a,
RD.SceneNode);RD.PointCloud=a;a.prototype.render=function(e,h){if(0!=this.points.length){this.updateVertices();var k=this._meshes[e.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,e.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);k=gl.shaders[this.shader];
k||(k=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(a._vertex_shader,a._pixel_shader));this.draw_range[1]=this.points.length;k=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;0<this.num_textures?(this._uniforms.u_texture_info[0]=1/this.num_textures,this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures):this._uniforms.u_texture_info[0]=0;this.ignore_transform&&(mat4.identity(e._model_matrix),e._mvp_matrix.set(e._viewprojection_matrix));
e.renderNode(this,e,h)}};a.prototype.updateVertices=function(a){if(a=this.points.length)for(var h=this._vertices,k=this._extra,f=0,g=this.num_textures*this.num_textures,c=0;c<a;c++){var p=this.points[c];h.set(p.pos?p.pos:p,f);k[f]=1;k[f+1]=1;1<g&&(k[f+2]=p.tex);f+=3}};a._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
a._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(f,RD.SceneNode);RD.ParticlesEmissor=f;f.prototype.update=function(a){var h=this.particles.length,k=this.particles_damping,f=this.particles_acceleration,g=vec3.length(f);if(h){for(var c=[],p=0;p<h;p++){var b=this.particles[p];vec3.scaleAndAdd(b.pos,b.pos,b.vel,a);g&&vec3.scaleAndAdd(b.vel,b.vel,f,a);k&&vec3.scaleAndAdd(b.vel,b.vel,b.vel,-a*k);b.ttl-=a;0<b.ttl&&c.push(b)}this.particles=c}h=this.getGlobalPosition();k=this.emissor_direction;f=this.particles_life;g=this.num_textures*this.num_textures;
c=this.velocity_variation;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),p=0;p<a&&!(this.particles.length>=this.max_particles);p++)k=vec3.clone(k),k[0]+=0.5*Math.random()*c,k[2]+=0.5*Math.random()*c,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*g)/g,pos:vec3.clone(h),vel:k,ttl:f})};f.prototype.render=function(a,h){if(0!=this.particles.length){this.updateVertices();
var k=this._meshes[a.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);k=gl.shaders[this.shader];k||(k=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(f._vertex_shader,f._pixel_shader));
this.draw_range[1]=this.particles.length;k=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,
h)}};f.prototype.updateVertices=function(a){if(a=this.particles.length)for(var h=this._vertices,k=this._extra,f=0,g=this.particles_life,c=this.num_textures*this.num_textures,p=0;p<a;p++){var b=this.particles[p];h.set(b.pos,f);k[f]=1;k[f+1]=b.ttl/g;1<c&&(k[f+2]=b.tex);f+=3}};f._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
f._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(l,RD.SceneNode);RD.Billboard=l;l.SPHERIC=1;l.PARALLEL_SPHERIC=2;l.CYLINDRIC=3;l.PARALLEL_CYLINDRIC=4;l.prototype._ctor=function(){this.billboard_mode=l.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};l.prototype.render=function(a,h){!1!==this.flags.visible&&(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,h,a),a.renderNode(this,a,h))};h.prototype._ctor=function(){RD.SceneNode.prototype._ctor.call(this);this.size=1;this._atlas_size=vec2.fromValues(1,
1);this.max_sprites=1024;this.positions=new Float32Array(3*this.max_sprites);this.sprite_info=new Float32Array(4*this.max_sprites);this.index=0;this.shader=null;this.use_points=!1;this.mode=h.CYLINDRICAL;this.must_update_buffers=!0};RD.SpritesBatch=h;h.XY=0;h.XZ=1;h.CYLINDRICAL=2;h.SPHERICAL=3;h.FLAT=4;Object.defineProperty(h.prototype,"atlas_size",{get:function(){return this._atlas_size},set:function(a){this._atlas_size.set(a)}});h.prototype.clear=function(){this.index=0};h.prototype.add=function(a,
h,k,f,g){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var c=this.index;this.index+=1;this.positions.set(a,3*c);2==a.length&&(this.positions[3*c+2]=0);a=4*c;this.sprite_info[a]=h||0;this.sprite_info[a+1]=k?1:0;this.sprite_info[a+2]=null==f?1:f;this.sprite_info[a+3]=g||0;this.must_update_buffers=!0}};h.prototype.addData=function(a,h){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var k=this.index;this.index+=
1;this.positions.set(a,3*k);this.sprite_info.set(h,4*k);this.must_update_buffers=!0}};h.prototype.render=function(a,h){if(this.texture){var k=a.textures[this.texture];k&&this.flags.pixelated&&(k.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.renderSprites(k,h,this.size,this.atlas_size,this.color,this.mode)}};h.prototype.renderSprites=
function(a,f,k,l,g,c){if(this.index){var p=gl.shaders[this.shader];p||(p=gl.shaders[this.use_points?"point_sprites":"quad_sprites"]);p||(p=this.use_points?gl.shaders.point_sprites=new GL.Shader(h.point_sprites_vertex_shader,h.point_sprites_fragment_shader):gl.shaders.quad_sprites=new GL.Shader(h.quad_sprites_vertex_shader,h.quad_sprites_fragment_shader));c=c||0;if(this.use_points)p.uniforms(GFX.scene_renderer._uniforms),p.setUniform("u_pointSize",k),p.setUniform("u_atlas",l),p.setUniform("u_texture",
a.bind(0)),RD.renderPoints(this.positions,this.sprite_info,f,this.index,p);else{if(!this.vertex_buffer_data){this.vertex_buffer_data=new Float32Array(12*this.max_sprites);this.extra4_buffer_data=new Float32Array(16*this.max_sprites);for(var b=new Int8Array(8*this.max_sprites),m=new Int8Array([-1,1,1,1,-1,-1,1,-1]),A=0;A<b.length;A+=8)b.set(m,A);for(var m=new Int16Array([0,2,1,1,2,3]),u=new Uint16Array(6*this.max_sprites),A=0;A<u.length;++A)u[A]=m[A%6]+4*Math.floor(A/6);this.vertex_buffer=new GL.Buffer(gl.ARRAY_BUFFER,
this.vertex_buffer_data,3,gl.DYNAMIC_DRAW);this.extra4_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this.extra4_buffer_data,4,gl.DYNAMIC_DRAW);this.extra2_buffer=new GL.Buffer(gl.ARRAY_BUFFER,b,2,gl.STATIC_DRAW);this.indices_buffer=new GL.Buffer(gl.ELEMENT_ARRAY_BUFFER,u,1,gl.STATIC_DRAW)}if(this.must_update_buffers){b=this.vertex_buffer_data;m=this.extra4_buffer_data;u=Math.min(this.index,this.positions.length/3);for(A=0;A<u;++A){var w=3*A,n=this.positions.subarray(w,w+3);b.set(n,4*w);b.set(n,4*w+3);b.set(n,
4*w+6);b.set(n,4*w+9);w=4*A;n=this.sprite_info.subarray(w,w+4);m.set(n,4*w);m.set(n,4*w+4);m.set(n,4*w+8);m.set(n,4*w+12)}this.vertex_buffer.uploadRange(0,48*this.index);this.extra4_buffer.uploadRange(0,64*this.index);this.must_update_buffers=!1}A=a.width/l[0]/(a.height/l[1]);b=RD.UP;m=RD.RIGHT;switch(c){case RD.SpritesBatch.SPHERICAL:b=f.getLocalVector(RD.UP);case RD.SpritesBatch.CYLINDRICAL:m=f.getLocalVector(RD.RIGHT);break;case RD.SpritesBatch.FLAT:b=f.getLocalVector(RD.FRONT);m=f.getLocalVector(RD.RIGHT);
break;case RD.SpritesBatch.XZ:b=RD.FRONT}p.bind();p.setUniform("u_model",RD.IDENTITY);p.setUniform("u_viewprojection",f._viewprojection_matrix);p.setUniform("u_color",g||RD.ONES4);p.setUniform("u_size",[k,k/A]);p.setUniform("u_top",b);p.setUniform("u_right",m);p.setUniform("u_atlas",l);p.setUniform("u_texture",a.bind(0));p.setUniform("u_itexsize",[1/a.width,1/a.height]);p.setUniform("u_viewport",gl.viewport_data);a=p.attributes.a_vertex;f=p.attributes.a_extra4;p=p.attributes.a_extra2;this.vertex_buffer.bind(a);
this.extra4_buffer.bind(f);this.extra2_buffer.bind(p);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer.buffer);gl.drawElements(gl.TRIANGLES,6*this.index,gl.UNSIGNED_SHORT,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.vertex_buffer.unbind(a);this.extra4_buffer.unbind(f);this.extra2_buffer.unbind(p)}}};extendClass(h,RD.SceneNode);h.quad_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4; //frame,flipx,scale,extranum\nattribute vec2 a_extra2;//expanse direction\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec2 u_size;\nuniform vec3 u_top;\nuniform vec3 u_right;\nuniform vec4 u_color;\nuniform vec2 u_atlas;\nuniform vec2 u_itexsize;\n\nvoid main() {\n\tvec3 vertex = a_vertex + a_extra4.z * u_size.y * u_top * a_extra2.y + a_extra4.z * u_size.x * u_right * a_extra2.x;\n\tvec2 uv = a_extra2;\n\tif( a_extra4.y != 0.0) //flip X\n\t\tuv.x *= -1.0;\n\tuv.x *= 1.0 - u_itexsize.x;\n\tuv.y *= -1.0;\n\tuv = uv * 0.5 + vec2(0.5);\n\t\n\tvec2 i_atlas = vec2(1.0) / u_atlas; \n\tfloat frame = a_extra4.x;\n\tfloat frame_x = mod( frame, u_atlas.x );\n\tfloat frame_y = floor( frame * i_atlas.x );\n\tuv.x = (uv.x + frame_x) * i_atlas.x;\n\tuv.y += frame_y;\n\tuv.y = 1.0 - uv.y * i_atlas.y;\n\tv_uv = uv;\n\tv_pos = (u_model * vec4(vertex,1.0)).xyz;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\t//gl_Position.x = floor(gl_Position.x * u_viewport.z * 1.0) / (u_viewport.z * 1.0);\n\t//gl_Position.y = floor(gl_Position.y * u_viewport.w * 1.0) / (u_viewport.w * 1.0);\n}\n\n";
h.quad_sprites_fragment_shader="\nprecision highp float;\nprecision mediump int;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n\tvec4 color = texture2D( u_texture, v_uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tcolor *= u_color;\n\tgl_FragColor = color;\n}\n";h.point_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_mvp;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tvec3 vertex = a_vertex;\t\n\tv_pos = vertex;\n\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_mvp * vec4(vertex,1.0);\n\tgl_Position.x = floor(gl_Position.x * u_viewport.z) / u_viewport.z;\n\tgl_Position.y = floor(gl_Position.y * u_viewport.w) / u_viewport.w;\n\tgl_PointSize = computePointSize( u_pointSize * u_extra4.z, gl_Position.w );\n}\n";
h.point_sprites_fragment_shader="\nprecision highp float;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4; //id,flip,scale,extra\nuniform float u_atlas;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\tfloat i_atlas = 1.0 / u_atlas;\n\tfloat frame = v_extra4.x;\n\tfloat x = frame * i_atlas;\n\tfloat y = floor(x);\n\tx = (x - y);\n\ty = y / u_atlas;\n\tif( v_extra4.y > 0.0 ) //must flip in x\n\t\tx -= gl_PointCoord.x * i_atlas - i_atlas;\n\telse\n\t\tx += gl_PointCoord.x * i_atlas;\n\t\n\tvec2 uv = vec2( x, 1.0 - (y + gl_PointCoord.y / u_atlas) );\n\tvec4 color = texture2D( u_texture, uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tgl_FragColor = color;\n}\n"})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
(function(n){function a(b){this._ctor();b&&this.configure(b);this.render_priority=0;this.targets=null;this.size=150;this.mode=a.DEFAULT;this.coordinates=a.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();b={x:a.XAXIS_COLOR,y:a.YAXIS_COLOR,z:a.ZAXIS_COLOR};var c="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");this.actions=
{};for(var g in c){var e=c[g],k={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:0.15,visible:!1,flag:a[e.toUpperCase()]};0==e.indexOf("move")&&(k.move=!0);0==e.indexOf("rotate")&&(k.rotate=!0);0==e.indexOf("scale")&&(k.scale=!0);k.color=b[e[e.length-1]];if(k.move||k.rotate)k.cursor="crosshair";this.actions[e]=k}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=vec3.fromValues(0,
1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=0.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
0.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1}a.MOVEX=1;a.MOVEY=2;a.MOVEZ=4;a.MOVEXY=8;a.MOVEXZ=16;a.MOVEYZ=32;a.ROTATEX=64;a.ROTATEY=128;a.ROTATEZ=256;a.SCALEX=512;a.SCALEY=1024;a.SCALEZ=2048;a.SCALEXY=4096;a.SCALEYZ=8192;a.SCALEXZ=
16384;a.SCALE=32768;a.DRAG=65536;a.ROTATE=131072;a.ROTATEFRONT=262144;a.MOVEAXIS=a.MOVEX|a.MOVEY|a.MOVEZ;a.MOVEPLANAR=a.MOVEXY|a.MOVEXZ|a.MOVEYZ;a.MOVEALL=a.DRAG|a.MOVEAXIS|a.MOVEPLANAR;a.PLANAR=a.MOVEX|a.MOVEZ|a.MOVEXZ|a.ROTATEY|a.SCALE;a.ROTATEALL=a.ROTATEX|a.ROTATEY|a.ROTATEZ|a.ROTATEFRONT;a.SCALEALL=a.SCALE|a.SCALEX|a.SCALEY|a.SCALEZ|a.SCALEXY|a.SCALEYZ|a.SCALEXZ;a.MOVEROTATESCALE=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALE;a.ALL=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALEALL;a.DEFAULT=a.PLANAR;
a.OBJECT_SPACE=1;a.WORLD_SPACE=2;n=mat4.create();var f=mat4.create(),l=mat4.create();mat4.create();mat4.create();mat4.create();var h=mat4.create(),e=mat4.create();mat4.create();var q=vec3.create(),k=vec3.create(),r=vec3.create(),g=vec4.create();vec4.create();mat4.translate(n,n,[1.1,0,0]);mat4.rotate(n,n,90*DEG2RAD,[0,0,-1]);mat4.translate(f,f,[0,1.1,0]);mat4.translate(l,l,[0,0,1.1]);mat4.rotate(l,l,90*DEG2RAD,[1,0,0]);n=mat4.create();mat4.scale(n,n,[-1,-1,-1]);a.full_viewport=null;var c=mat4.create(),
p=mat4.create();a.XAXIS_COLOR=[0.901,0.247,0.349,1];a.YAXIS_COLOR=[0.55,0.81,0.11,1];a.ZAXIS_COLOR=[0.23,0.57,0.93,1];a.XYAXIS_COLOR=[0.9,0.7,0.23,0.75];a.XZAXIS_COLOR=[0.6,0.4,0.7,0.75];a.YZAXIS_COLOR=[0.39,0.69,0.52,0.75];a.SPHERE_COLOR=[0.8,0.8,0.8,0.4];a.RING_COLOR=[0.5,0.5,0.5,1];a.INNERSPHERE_COLOR=[0.6,0.6,0.6,1];a.SELECTED_COLOR=[1,1,1,1];a.NOAXIS_COLOR=[0.901,0.247,0.749,1];a.STATIC_SPHERE_COLOR=[0.1,0.1,0.1,0.3];a.prototype.isTarget=function(b){return-1!=this.targets.indexOf(b)};a.prototype.setTargets=
function(b,a){if(b&&b.constructor!==Array)throw"nodes must be an Array";b&&0!=b.length?(a&&this.targets&&(b=this.targets.concat(b)),this.targets=b=b.filter(function(a,c){return b.indexOf(a)===c}),this.resetTransform(),this.position=this.computeCenter(this.targets)):a||(this.targets=null)};a.prototype.computeCenter=function(b){if((b=b||this.targets)&&b.length){for(var a=null,c=0;c<b.length;++c){var g=b[c];g.layers&this.layers&&(g=g.getGlobalPosition(),a?vec3.add(a,a,g):a=g)}if(!a)return[0,0,0];vec3.scale(a,
a,1/b.length);return a}};a.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?this.transform=this.targets[0].transform:this.position=this.computeCenter(this.targets)))};a.prototype.updateTargets=function(){if(this.targets)for(var b=this.getGlobalMatrix(mat4.create()),a=0;a<this.targets.length;++a){var c=this.targets[a];c.layers&this.layers&&c.fromMatrix(b,
!0)}};a.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(this.target_tranforms[b]=new Float32Array(a.transform))}}};a.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(a.transform=this.target_tranforms[b])}};a.prototype.removeTargetsFromScene=
function(){if(this.targets){for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&a.parentNode&&a.parentNode.removeChild(a)}this.targets=null}};a.prototype.getTargetBaseNodes=function(){function b(a){return-1!=c.indexOf(a)?!0:a.parentNode?b(a.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var a=[],c=this.targets,g=0;g<c.length;++g){var e=c[g];e.layers&this.layers&&(b(e.parentNode)||a.push(e))}return a};a.prototype.applyTransformToTarget=function(b){var a=
this.getGlobalMatrix(mat4.create()),c=mat4.invert(mat4.create(),a),g=mat4.create(),e=this.getTargetBaseNodes();if(e){for(var k=[1,1,1],p=0;p<e.length;++p){var h=e[p];k[0]=0<=h.scaling[0]?1:-1;k[1]=0<=h.scaling[1]?1:-1;k[2]=0<=h.scaling[2]?1:-1;h.getGlobalMatrix(g);mat4.multiply(g,c,g);mat4.multiply(g,b,g);mat4.multiply(g,a,g);h.fromMatrix(g,!0);vec3.mul(h._scale,h._scale,k);h.position=this.applySnap(h.position);if(this.grid_size){var f=quat.toEuler(vec3.create(),h.rotation);f[0]=15*Math.round(f[0]*
RAD2DEG/15)*DEG2RAD;f[1]=15*Math.round(f[1]*RAD2DEG/15)*DEG2RAD;f[2]=15*Math.round(f[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(h.rotation,f)}}mat4.multiply(g,a,b);this.fromMatrix(g);this.scaling=[1,1,1];this.updateGizmo()}};a.prototype.applyTranslation=function(b){var a=mat4.create();mat4.translate(a,a,b);this.applyTransformToTarget(a)};a.prototype.applyRotation=function(b,a,c){var g=mat4.create();if(c){var e=mat4.create();mat4.setTranslation(e,c);mat4.mul(g,g,e);mat4.rotate(g,g,b,a);mat4.setTranslation(e,
[-c[0],-c[1],-c[2]]);mat4.mul(g,g,e)}else mat4.rotate(g,g,b,a);this.applyTransformToTarget(g)};a.prototype.applyScale=function(b){b.constructor===Number&&(b=[b,b,b]);var a=mat4.create();mat4.scale(a,a,b);this.applyTransformToTarget(a)};a.prototype.applySnap=function(b){if(!this.grid_size)return b;b[0]=Math.round(b[0]/this.grid_size)*this.grid_size;b[1]=Math.round(b[1]/this.grid_size)*this.grid_size;b[2]=Math.round(b[2]/this.grid_size)*this.grid_size;return b};a.prototype.setColor=function(b){if(this.targets)for(var a=
0;a<this.targets.length;++a){var c=this.targets[a];c.layers&this.layers&&(c.color=b)}};a.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var b=[],a=0;a<this.targets.length;++a){var c=this.targets[a];if(c.layers&this.layers){var g=c.clone(!0);c.parentNode.addChild(g);b.push(c)}}return this.targets=b}};a.prototype.onMouse=function(b){if(this._camera&&this.targets&&!1!==this.visible){var a=this._camera,c=a.getFront(),
g=[b.canvasx,b.canvasy],e=a.getRay(g[0],g[1]),k=this.position,p=vec3.sub(vec3.create(),k,a.position);vec3.normalize(p,p);var h=this._selected_action,f=this.actions[h],q=this._global_matrix;a.project(k,null,this.center_2D);if("mousedown"==b.type){if(this.click_2D[0]=this.click_2D2[0]=g[0],this.click_2D[1]=this.click_2D2[0]=g[1],b.is_touch&&this.testMouseOver(b),h=this._selected_action=this._hover_action,f=this.actions[h]){if(f.move&&f.axis){var l=vec3.clone(f.axis);mat4.rotateVec3(l,q,l);vec3.normalize(l,
l);this._last=e.closestPointOnRay(k,l);b.shiftKey&&this.cloneTargets()}else f.move&&f.normal&&(e.testPlane(k,f.normal)&&(this.click_pos=e.collision_point),b.shiftKey&&this.cloneTargets());"drag"==h&&(e.testPlane(k,c),this._last=e.collision_point,b.shiftKey&&this.cloneTargets());"rotatefront"==h?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,0.5*this.size),
this.click_2D2.set(this.click_2D)):f.rotate&&(f.axis?(b=mat4.rotateVec3(vec3.create(),q,f.axis),e.testPlane(k,b)&&(vec3.sub(this.click_pos,e.collision_point,k),vec3.normalize(this.click_pos,this.click_pos),k=vec3.scaleAndAdd(vec3.create(),k,this.click_pos,this.current_size),this.current_2D=this.click_2D=a.project(k))):e.testSphere(k,this.current_size)&&(this._last=e.collision_point,vec3.sub(this.click_pos,e.collision_point,k),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||
vec3.create(),p,this.click_pos)));this.click_model.set(q);this.click_transform.set(this.transform);this.click_dist=vec3.distance(this.click_2D,this.center_2D);this.saveTargetTransforms()}}else if("mousemove"==b.type)if(b.dragging&&this._selected_action){if("rotatefront"==h)return k=vec2.sub(vec3.create(),g,this.center_2D),vec2.normalize(k,k),f=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,k,0.5*this.size),k=Math.atan2(k[0],k[1]),f=Math.atan2(f[0],f[1]),k-=f,b.shiftKey&&(k=2*Math.PI*
Math.ceil(36*k/(2*Math.PI))/36),k&&(this.restoreTargetTransforms(),this.applyRotation(k,p)),!0;if(f.rotate)return f.axis?(b=mat4.rotateVec3(vec3.create(),q,f.axis),e.testPlane(k,b)&&(h=vec3.sub(vec3.create(),e.collision_point,k),vec3.normalize(h,h),k=vec3.scaleAndAdd(vec3.create(),k,h,this.current_size),this.current_2D=a.project(k),a=Math.clamp(vec3.dot(h,this.click_pos),-1,1),k=Math.acos(a),h=vec3.cross(vec3.create(),h,this.click_pos),vec3.normalize(h,h),a=vec3.dot(b,h),0<a&&(k*=-1),this.restoreTargetTransforms(),
this.applyRotation(k,f.axis))):(l=vec3.cross(vec3.create(),p,this.click_pos),k=0.01*(vec2.dist(this.center_2D,g)-this.click_dist),f=vec2.sub(vec2.create(),this.center_2D,g),b=vec2.sub(vec2.create(),this.center_2D,this.click_2D),0>vec2.dot(f,b)&&(k=-k),console.log(k),this.restoreTargetTransforms(),this.applyRotation(k,l),this.click_axis=l),!0;p=null;if(f.move&&f.normal)e.testPlane(k,f.normal)&&(f=e.collision_point,this.applySnap(f),p=vec3.sub(vec3.create(),f,this.click_pos),this.click_pos=f);else if(f.move||
f.scale){if("scale"==h||f.scale&&b.ctrlKey)return f=1+0.01*(g[1]-this.click_2D[1]),this.applyScale(f),this.click_2D[0]=g[0],this.click_2D[1]=g[1],!0;if("scalexy"==h||"scalexz"==h||"scaleyz"==h){f=1+0.01*(g[1]-this.click_2D[1]);switch(h){case "scalexy":this.applyScale([f,f,1]);break;case "scaleyz":this.applyScale([1,f,f]);break;case "scalexz":this.applyScale([f,1,f])}this.click_2D[0]=g[0];this.click_2D[1]=g[1];return!0}l=vec3.clone(f.axis);mat4.rotateVec3(l,q,l);vec3.normalize(l,l);b=e.closestPointOnRay(k,
l);if(f.scale)return f=vec2.distance(g,this.center_2D),b=f/this.click_dist,"scalex"==h?this.applyScale([b,1,1]):"scaley"==h?this.applyScale([1,b,1]):"scalez"==h&&this.applyScale([1,1,b]),this.click_dist=f,!0;this.applySnap(b);p=vec3.sub(vec3.create(),b,this._last);this._last=b}"drag"==h&&(e.testPlane(k,this._camera.getFront()),b=e.collision_point,this.applySnap(b),p=vec3.sub(vec3.create(),b,this._last),this._last=b);if(p)return this.applyTranslation(p),!0}else this.testMouseOver(b);else if("mouseup"==
b.type){if(this.saveTargetTransforms(),this._selected_action)return this._selected_action=null,this.render(this._last_renderer,this._last_camera),this.testMouseOver(b),this.updateGizmo(),!0}else if("wheel"==b.type){if("scale"==this._selected_action)return f=1+2E-4*b.wheel,this.applyScale(f),!0;if("drag"==this._selected_action)return p=vec3.sub(vec3.create(),k,a.position),f=1+2E-4*b.wheel,vec3.scaleAndAdd(p,a.position,p,f),vec3.sub(p,p,k),this.applyTranslation(p),this._last=k,!0}return!1}};a.prototype.testMouseOver=
function(b){this._hover_action=null;var c=[b.canvasx,b.canvasy],g=1E5;b=null;for(var e in this.actions){var k=this.actions[e];if(k.visible){var p=vec2.distance(k.pos2D,c);p<k.radius*this.size&&p<g&&(g=p,b=e)}}b||(e=vec2.distance(this.center_2D,c),this.actions.rotatefront.visible&&10>Math.abs(e-0.5*this.size)?b="rotatefront":this.mode&a.ROTATE&&e<0.5*this.size&&(b="rotate"));return this._hover_action=b};a.prototype.cancel=function(){this._selected_action&&(this._selected_action=null,this.restoreTargetTransforms())};
a.prototype.render=function(b,m){this._last_renderer=b;this._last_camera=m;for(var p in this.actions)this.actions[p].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:0.1,height:0.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:0.5*
Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}));p=gl.meshes.torus;var f=m.getFront(),l=m.getLocalVector(RD.UP);m.getLocalVector(RD.RIGHT);var n=this._position;g.set(n);g[3]=1;var x=m._projection_matrix[5];this.updateMatrices();h.set(this._global_matrix);var s=vec3.sub(vec3.create(),n,m.position);vec3.normalize(s,s);this._camera=m;this._unitary_model=h;var y=this._hover_action,
z=this._selected_action;z&&(y=z);var B=z?this.actions[z]:null,t=this.mode;mat4.rotateVec3(k,h,RD.RIGHT);mat4.rotateVec3(r,h,RD.UP);mat4.rotateVec3(q,h,RD.FRONT);vec3.normalize(k,k);vec3.normalize(r,r);vec3.normalize(q,q);mat4.fromTranslationFrontTop(e,n,f,l);vec4.transformMat4(g,g,m._viewprojection_matrix);this.current_size=l=gl.canvas.width/gl.canvas.height*this.size*g[3]/(gl.canvas.width*x);mat4.scale(h,h,[l,l,l]);mat4.scale(e,e,[l,l,l]);var l=vec3.dot(s,k),x=vec3.dot(s,r),E=vec3.dot(s,q),D=vec3.dot(f,
RD.RIGHT),d=vec3.dot(f,RD.UP),C=vec3.dot(f,RD.FRONT);this._camera.project(n,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);s=gl.shaders[this.shader];s.uniforms(b._uniforms);s.uniforms(m.uniforms);s.uniforms(this.uniforms);if("movex"==z)mat4.rotateZ(c,h,-Math.PI/2),this.drawAxis(c,a.XAXIS_COLOR);else if("movey"==z)this.drawAxis(h,a.YAXIS_COLOR);else if("movez"==z)mat4.rotateX(c,
h,-Math.PI/2),this.drawAxis(c,a.ZAXIS_COLOR);else if("drag"==z)b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0);else if(B&&B.normal&&this.render_move_plane)c.set(h),"movexz"==z?mat4.rotateX(c,c,Math.PI/2):"moveyz"==z&&mat4.rotateY(c,c,Math.PI/2),mat4.scale(c,c,[100,100,100]),s.setUniform("u_model",c),s.setUniform("u_color",[0.1,0.1,0.1,0.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),s.draw(gl.meshes.plane),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==
z)mat4.rotateX(c,e,Math.PI/2),s.setUniform("u_model",c),s.draw(p),b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0),b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR),b.drawLine2D(this.click_2D2[0],this.click_2D2[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR);else{if("rotate"==z){this.click_axis&&
(mat4.fromTranslationFrontTop(c,n,f,this.click_axis),mat4.scale(c,c,[this.current_size,this.current_size,this.current_size]),this.drawAxis(c,a.NOAXIS_COLOR));this.drawRotateSphere(h,a.SPHERE_COLOR);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.NOAXIS_COLOR,!0);return}if(B&&B.rotate){f=B.color||a.XAXIS_COLOR;"rotatex"==z?mat4.rotateZ(c,h,Math.PI/2):"rotatey"==z?mat4.rotateY(c,h,Math.PI/2):"rotatez"==z&&mat4.rotateX(c,h,Math.PI/2);s.setUniform("u_model",c);s.setUniform("u_color",f);s.draw(p);
b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,f,!0);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,f,!0);b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,f);b.drawCircle2D(this.current_2D[0],this.current_2D[1],2,f,!0);b.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,f);return}}"scale"==z?(b.drawCircle2D(this.center_2D[0],this.click_2D[1],2,a.INNERSPHERE_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],
2,a.INNERSPHERE_COLOR,!0),b.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.INNERSPHERE_COLOR)):(this.drawRotateSphere(h,a.STATIC_SPHERE_COLOR),t&a.ROTATE&&"rotate"==y&&this.drawRotateSphere(h,a.SPHERE_COLOR),t&a.ROTATEFRONT&&(mat4.rotateX(c,e,Math.PI/2),s.setUniform("u_model",c),s.setUniform("u_color","rotatefront"==y?a.SELECTED_COLOR:a.RING_COLOR),s.draw(p),this.actions.rotatefront.visible=!0),0.1<Math.abs(l)&&t&a.ROTATEX&&(mat4.rotateZ(c,h,Math.PI/2),0>C&&
mat4.rotateX(c,c,Math.PI),0>d&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatex"==y?a.SELECTED_COLOR:a.XAXIS_COLOR,"rotatex")),0.1<Math.abs(x)&&t&a.ROTATEY&&(c.set(h),0<D&&0>C?mat4.rotateY(c,c,-Math.PI/2):0>D&&0>C?mat4.rotateY(c,c,Math.PI):0>D&&0<C&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatey"==y?a.SELECTED_COLOR:a.YAXIS_COLOR,"rotatey")),0.1<Math.abs(E)&&t&a.ROTATEZ&&(c.set(h),mat4.rotateX(c,c,Math.PI/2),0<D&&0>d?mat4.rotateY(c,c,-Math.PI/2):0>D&&0>d?mat4.rotateY(c,c,Math.PI):
0>D&&0<d&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatez"==y?a.SELECTED_COLOR:a.ZAXIS_COLOR,"rotatez")),0.95>Math.abs(l)&&(mat4.rotateZ(c,h,0>D?-Math.PI/2:Math.PI/2),t&a.MOVEX&&this.drawArrow(c,"movex"==y?a.SELECTED_COLOR:a.XAXIS_COLOR,"movex"),t&a.SCALEX&&this.drawScale(c,"scalex"==y?a.SELECTED_COLOR:a.XAXIS_COLOR,"scalex")),0.95>Math.abs(x)&&(0<d?mat4.rotateZ(c,h,Math.PI):c.set(h),t&a.MOVEY&&this.drawArrow(c,"movey"==y?a.SELECTED_COLOR:a.YAXIS_COLOR,"movey"),t&a.SCALEY&&this.drawScale(c,
"scaley"==y?a.SELECTED_COLOR:a.YAXIS_COLOR,"scaley")),0.95>Math.abs(E)&&(mat4.rotateX(c,h,0>C?-Math.PI/2:Math.PI/2),t&a.MOVEZ&&this.drawArrow(c,"movez"==y?a.SELECTED_COLOR:a.ZAXIS_COLOR,"movez"),t&a.SCALEZ&&this.drawScale(c,"scalez"==y?a.SELECTED_COLOR:a.ZAXIS_COLOR,"scalez")),0.2<Math.abs(E)&&(t&a.MOVEXY||t&a.SCALEXY)&&(mat4.translate(c,h,[0.45*(0>l?1:-1),0.45*(0>x?1:-1),0]),t&a.MOVEXY?this.drawFlat(c,"movexy"==y?a.SELECTED_COLOR:a.XYAXIS_COLOR,"movexy"):this.drawFlat(c,"scalexy"==y?a.SELECTED_COLOR:
a.XYAXIS_COLOR,"scalexy","circle")),0.2<Math.abs(x)&&(t&a.MOVEXZ||t&a.SCALEXZ)&&(mat4.rotateX(c,h,Math.PI/2),mat4.translate(c,c,[0.45*(0>l?1:-1),0.45*(0>E?-1:1),0]),t&a.MOVEXZ?this.drawFlat(c,"movexz"==y?a.SELECTED_COLOR:a.XZAXIS_COLOR,"movexz"):this.drawFlat(c,"scalexz"==y?a.SELECTED_COLOR:a.XZAXIS_COLOR,"scalexz","circle")),0.2<Math.abs(l)&&(t&a.MOVEYZ||t&a.SCALEYZ)&&(mat4.rotateY(c,h,Math.PI/2),mat4.translate(c,c,[0.45*(0>E?1:-1),0.45*(0>x?1:-1),0]),t&a.MOVEYZ?this.drawFlat(c,"moveyz"==y?a.SELECTED_COLOR:
a.YZAXIS_COLOR,"moveyz"):this.drawFlat(c,"scaleyz"==y?a.SELECTED_COLOR:a.YZAXIS_COLOR,"scaleyz","circle")),t&a.DRAG&&this.drawInnerSphere(h,"drag"),t&a.SCALE&&this.drawInnerSphere(h,"scale"),gl.enable(gl.DEPTH_TEST))}}};a.prototype.drawArrow=function(b,c,g){var e=gl.shaders[this.shader],k=gl.meshes.cone,f=gl.meshes.cylinder,h=this._hover_action;mat4.translate(p,b,[0,1.1,0]);e.setUniform("u_model",p);e.setUniform("u_color",h==g?a.SELECTED_COLOR:c);e.draw(k);this.mode==a.MOVEALL?(mat4.translate(p,p,
[0,-0.4,0]),mat4.scale(p,p,[1,1,1])):(mat4.translate(p,p,[0,-0.15,0]),mat4.scale(p,p,[1,0.5,1]));e.setUniform("u_model",p);e.draw(f);this.toScreen(p,g,[0,0.6,0])};a.prototype.drawAxis=function(a,c){var g=gl.shaders[this.shader],e=gl.meshes.sphere;mat4.scale(p,a,[0.01,100,0.01]);g.setUniform("u_model",p);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);g.setUniform("u_color",[c[0],c[1],c[2],0.2]);gl.depthFunc(gl.GREATER);g.draw(e);gl.depthFunc(gl.LESS);
gl.disable(gl.BLEND);g.setUniform("u_color",c);g.draw(e);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(a)};a.prototype.drawFlat=function(a,g,e,k){k=gl.meshes[k||"plane"];var f=gl.shaders[this.shader];mat4.scale(c,a,[0.25,0.25,0.25]);f.setUniform("u_color",g);f.setUniform("u_model",c);gl.enable(gl.BLEND);f.draw(k);gl.disable(gl.BLEND);this.toScreen(c,e)};a.prototype.drawRotator=function(a,g,e){var k=gl.meshes.quartertorus,f=gl.shaders[this.shader];mat4.scale(c,a,[0.9,0.9,0.9]);f.setUniform("u_color",
g);f.setUniform("u_model",c);f.draw(k);this.toScreen(c,e,[-0.75,0,0.75])};a.prototype.drawScale=function(b,g,e){var k=gl.meshes.cylinder,f=gl.meshes.sphere,p=gl.shaders[this.shader];p.setUniform("u_color",g);this.mode==a.SCALEALL?(mat4.translate(c,b,[0,0.5,0]),mat4.scale(c,c,[1,1,1])):(mat4.translate(c,b,[0,0.25,0]),mat4.scale(c,c,[1,0.5,1]));p.setUniform("u_model",c);p.draw(k);mat4.translate(c,b,[0,0.4,0]);this.mode==a.SCALEALL?mat4.scale(c,c,[0.1,0.1,0.1]):mat4.scale(c,c,[0.1,0.2,0.1]);p.setUniform("u_model",
c);p.draw(f);this.toScreen(c,e)};a.prototype.drawRotateSphere=function(a,g){var e=gl.shaders[this.shader],k=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(c,a,[0.9,0.9,0.9]);e.setUniform("u_model",c);e.setUniform("u_color",g);e.draw(k);gl.disable(gl.BLEND)};a.prototype.drawInnerSphere=function(b,g){var e=gl.shaders[this.shader],k=gl.meshes.sphere,f=this._hover_action;mat4.scale(c,b,[0.1,0.1,0.1]);e.setUniform("u_model",c);e.setUniform("u_color",f==
g?a.SELECTED_COLOR:a.INNERSPHERE_COLOR);e.draw(k);"drag"==g&&(mat4.scale(c,b,[0.07,0.07,0.07]),e.setUniform("u_model",c),e.setUniform("u_color",f==g?a.INNERSPHERE_COLOR:[0,0,0,1]),e.draw(k));g&&this.toScreen(c,g)};a.prototype.renderOutline=function(b,c,g,e){if((e=e||this.targets)&&e.length){var k=this.layers;e=e.filter(function(a){return a.layers&k});var f=gl.viewport_data[2],p=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==f&&this._selection_buffer.height==p||(this._selection_buffer=
new GL.Texture(f,p,{magFilter:gl.NEAREST}));a.outline_material||(a.outline_material=new RD.Material({shader_name:"flat"}));var h=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);b.shader_overwrite=h;var a=b.onNodeShaderUniforms;b.onNodeShaderUniforms=function(a,b){b.setUniform("u_color",[1,1,1,1])};var k=b.pipeline;b.pipeline=null;b.overwrite_material=RD.Gizmo.outline_material;b.render(c,g,e);b.shader_overwrite=null;b.onNodeShaderUniforms=
a;b.pipeline=k;b.overwrite_material=null});var q=gl.shaders.outline;q||(q=gl.shaders.outline=GL.Shader.createFX("\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n"));gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(q,{u_color:[1,1,1,1],u_res:[1/f,1/p]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};a.prototype.renderCameraGizmo=function(a,c){this.drawInnerSphere};a.prototype.toScreen=function(b,c,g){c=this.actions[c];mat4.multiplyVec3(c.pos,b,g||[0,0,0]);this._camera.project(c.pos,a.full_viewport,c.pos2D);c.visible=!0};extendClass(a,RD.SceneNode);RD.Gizmo=a})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,overwrite_materials:!0,rename_assets:!1,prefabs:{},texture_options:{format:GL.RGBA,
magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT},load:function(n,a,f,l){function h(a){function b(c){var g=this.buffer;g.data=c;g.dataview=new Uint8Array(c);a.length?h(a):e()}var c=a.pop(),g=r+"/"+c.uri;"blob:"==c.uri.substr(0,5)&&(g=c.uri);console.log(" - loading "+c.uri+" ...");"data:"==c.uri.substr(0,5)?(g=_base64ToArrayBuffer(c.uri.substr(37)),b.call({buffer:c},g)):fetch(g).then(function(a){return a.arrayBuffer()}).then(b.bind({buffer:c}))}function e(){console.log("parsing gltf ...");
q.filename=k;q.folder=r;q.url=n;var b=RD.GLTF.parse(q);RD.GLTF.prefabs[n]=b.serialize();a&&a(b)}var q=null,k="",r="";if(n.constructor===String){r=n.split("/");k=r.pop();f=f||k.split(".").pop().toLowerCase();r=r.join("/");console.log("loading gltf json...");var g=new XMLHttpRequest;g.onload=function(){if(200!=this.status)console.error("GLTF not found",n),a&&a(null);else{var b=g.response;"gltf"==f?(q=b,console.log("loading gltf binaries..."),h(q.buffers.concat())):"glb"==f&&(q=RD.GLTF.parseGLB(b))&&
e()}};g.onerror=function(){console.error("Network Error");a&&a(null)};l&&(g.onprogress=function(a){l(n,a.loaded,a.total)});g.responseType="gltf"==f?"json":"arraybuffer";g.open("GET",n);g.send()}else{var c=n;console.log(c);n=k=c.main;var p=c[k];if("glb"==p.extension)(q=RD.GLTF.parseGLB(p.data))&&e();else{q=p.data;for(p=0;p<q.buffers.length;++p){var b=q.buffers[p];"data:"==b.uri.substr(0,5)?b.data=_base64ToArrayBuffer(b.uri.substr(37)):b.data=c[b.uri].data;b.dataview=new Uint8Array(b.data)}e()}}},parseGLB:function(n){var a=
new Uint8Array(n),f=new DataView(n);if(1179937895!=f.getUint32(0,!0))return console.error("incorrect gltf header"),null;var l=f.getUint32(4,!0);console.log("GLTF Version: "+l);f.getUint32(8,!0);for(var l=12,h=null,e=0;l<a.length;){var q=f.getUint32(l,!0),k=f.getUint32(l+4,!0),r=n.slice(l+8,l+8+q),l=l+(8+q);if(k==RD.GLTF.JSON_CHUNK){if(!("TextDecoder"in window))throw"Sorry, this browser does not support TextDecoder...";h=(new TextDecoder("utf-8")).decode(r);h=JSON.parse(h)}else k==RD.GLTF.BINARY_CHUNK?
(q=h.buffers[e],q.data=r,q.dataview=new Uint8Array(r),n.byteLength!=q.byteLength&&console.warn("gltf binary doesnt match json size hint"),e++):console.warn("gltf unknown chunk type: ","0x"+k.toString(16))}return h},parse:function(n,a){console.log(n);n.url||(n.url=a||"scene.glb");var f=null,l={};1<n.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var h=n.scenes[n.scene].nodes;this.gltf_materials={};if(n.skins)for(var e=0;e<n.skins.length;++e)for(var f=
n.skins[e],q=0;q<f.joints.length;++q)n.nodes[f.joints[q]]._is_joint=!0;f=null;1<h.length&&(f=new RD.SceneNode,f.name="root");for(e=0;e<h.length;++e){var k=q=h[e];null!=q.node&&(k=q.node);q=RD.GLTF.parseNode(null,k,n);f||(f=q);1<h.length&&f.addChild(q);q.id=n.url.replace(/\//gi,"_")+"::node_"+e;l[q.id]=l[e]=q}if(n.animations&&n.animations.length)if(RD.Animation)for(f.animations=[],e=0;e<n.animations.length;++e)h=this.parseAnimation(e,n,l),h.id=n.filename+"::"+h.name,h&&(RD.Animations[h.id]=h,f.animations.push(h));
else console.error("you must include rendeer-animation.js to allow animations");f.materials=this.gltf_materials;return f},parseNode:function(n,a,f){var l=f.nodes[a];n=n||new RD.SceneNode;for(var h in l){var e=l[h];switch(h){case "name":n.name=e;break;case "translation":n.position=e;break;case "rotation":n.rotation=e;break;case "scale":n.scaling=e;var q=0;0>n.scaling[0]&&q++;0>n.scaling[1]&&q++;0>n.scaling[2]&&q++;1==q%2&&(n.flags.frontFace=GL.CW);break;case "matrix":n.fromMatrix(e);0>mat4.determinant(e)&&
(n.flags.frontFace=GL.CW);break;case "mesh":if(e=RD.GLTF.parseMesh(e,f))for(n.mesh=e.name,n.primitives=[],q=0;q<e.info.groups.length;++q){var k=e.info.groups[q],r=null;null!=k.material&&(r=this.parseMaterial(k.material,f));n.primitives.push({index:q,material:r?r.name:null,mode:k.mode})}break;case "skin":n.skin=this.parseSkin(e,f);break;case "children":if(e.length)for(q=0;q<e.length;++q)k=RD.GLTF.parseNode(null,e[q],f),n.addChild(k);break;case "extras":break;default:"_"!=h[0]&&console.log("gltf node info ignored:",
h,l[h])}}l.name||(l.name=n.name="node_"+a);l._is_joint&&(n.is_joint=!0);return n},parseMesh:function(n,a){for(var f=a.meshes[n],l=gl.meshes,h=[],e=[],q=0,k=0;k<f.primitives.length;++k){var r=this.parsePrimitive(f,k,a);if(r){r.start=q;q+=r.length;e.push(r);var g={vertexBuffers:{},indexBuffers:{}},c;for(c in r.buffers)"indices"==c||"triangles"==c?g.indexBuffers[c]={data:r.buffers[c]}:g.vertexBuffers[c]={data:r.buffers[c]};h.push({mesh:g})}}q=null;1<h.length?q=GL.Mesh.mergeMeshes(h):1==h.length&&(k=
h[0].mesh,q=new GL.Mesh(k.vertexBuffers,k.indexBuffers),q.info&&k.info&&(q.info=k.info));if(!q)return null;for(k=0;k<f.primitives.length;++k)(h=q.info.groups[k])||(q.info.groups[k]=h={}),r=f.primitives[k],h.material=r.material,h.mode=null!=r.mode?r.mode:4,h.start=e[k].start,h.length=e[k].length;q.name=f.name;if(q.name||this.rename_assets)q.name=a.filename+"::mesh_"+(f.name||n);q.updateBoundingBox();q.computeGroupsBoundingBoxes();return l[q.name]=q},parsePrimitive:function(n,a,f){var l={buffers:{}},
h=l.buffers;n=n.primitives[a];if(n.extensions)if(n.extensions.KHR_draco_mesh_compression){if("undefined"==typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";h=l.buffers=this.decompressDraco(n,f)}else throw"mesh data is compressed, this importer does not support it yet";else{null==!n.attributes.POSITION&&console.warn("gltf mesh without positions");for(var e in this.buffer_names){a=this.buffer_names[e];var q="coords"==a||"coords1"==a,k=n.attributes[e];
null!=k&&(q=this.parseAccessor(k,f,q))&&(h[a]=q)}null!=n.indices&&(h.triangles=this.parseAccessor(n.indices,f))}if(!h.vertices)return console.error("primitive without vertices"),null;l.mode=n.mode;l.material=n.material;l.start=0;l.length=h.triangles?h.triangles.length:h.vertices.length/3;return l},installDracoModule:function(n){var a=this.draco_data_types={},f=this;this.decoderModule?n&&n(this.decoderModule):"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(l){var h=f.decoderModule=
l;a[h.DT_INT8]=Int8Array;a[h.DT_UINT8]=Uint8Array;a[h.DT_INT16]=Int16Array;a[h.DT_UINT16]=Uint16Array;a[h.DT_INT32]=Int32Array;a[h.DT_UINT32]=Uint32Array;a[h.DT_FLOAT32]=Float32Array;n&&n(l)}):console.error("Draco3D not installed")},decompressDraco:function(n,a){this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,n,a)},decodePrimitive:function(n,a,f){console.log(a);var l={};a=f.buffers[f.bufferViews[a.extensions.KHR_draco_mesh_compression.bufferView].buffer];
var h=a.dataview.buffer;f=this.decoderModule;a=new f.DecoderBuffer;a.Init(new Int8Array(h),h.byteLength);if(n.GetEncodedGeometryType(a)==f.TRIANGULAR_MESH){var e=new f.Mesh,h=n.DecodeBufferToMesh(a,e);if(!h.ok()||0===e.ptr)throw Error("GLTF Draco: Decoding failed: "+h.error_msg());e.num_points();for(var q in this.buffer_names){var h=this.buffer_names[q],k=q;"COLOR_0"==k?k="COLOR":"TEXCOORD_0"==k&&(k="TEX_COORD");if(k=this.decodeBuffer(e,f[k],"coords"==h||"coords1"==h,n))l[h]=k.data}q=3*e.num_faces();
h=4*q;k=f._malloc(h);n.GetTrianglesUInt32Array(e,h,k);l.triangles=(new Uint32Array(f.HEAPF32.buffer,k,q)).slice();f._free(k)}f.destroy(a);f.destroy(e);return l},decodeBuffer:function(n,a,f,l){if(null==a)return null;var h=this.decoderModule;a=l.GetAttributeId(n,a);if(-1==a)return null;var e=l.GetAttribute(n,a);a=e.data_type();var q=e.num_components(),k=n.num_points();e.size();var r=k*q,g=this.draco_data_types[a],h=new h.DracoFloat32Array;l.GetAttributeFloatForAllPoints(n,e,h);n=new g(r);for(l=0;l<
n.length;++l)n[l]=h.GetValue(l);if(f)for(l=1;l<n.length;l+=q)n[l]=1-n[l];return{num_points:k,num_comps:q,data_type:a,data:n}},parseAccessor:function(n,a,f,l,h){h=a.accessors[n];if(!h)return console.warn("gltf accessor not found"),null;n=this.numComponents[h.type];if(!n)return console.warn("gltf accessor of unknown type:",h.type),null;var e=h.count*n;switch(h.componentType){case RD.GLTF.FLOAT:databuffer=new Float32Array(e);break;case RD.GLTF.UNSIGNED_INT:databuffer=new Uint32Array(e);break;case RD.GLTF.SHORT:databuffer=
new Int16Array(e);break;case RD.GLTF.UNSIGNED_SHORT:databuffer=new Uint16Array(e);break;case RD.GLTF.BYTE:databuffer=new Int8Array(e);break;case RD.GLTF.UNSIGNED_BYTE:databuffer=new Uint8Array(e);break;default:console.warn("gltf accessor of unsupported type: ",h.componentType),databuffer=new Float32Array(e)}null==l&&(l=a.bufferViews[h.bufferView]);if(!l)return console.warn("gltf bufferView not found"),null;e=a.buffers[l.buffer];if(!e||!e.data)return console.warn("gltf buffer not found or data not loaded"),
null;if(l.byteStride&&l.byteStride!=n*databuffer.BYTES_PER_ELEMENT)return console.warn("gltf buffer data is not tightly packed, not supported"),null;a=new Uint8Array(databuffer.buffer);null==l.byteOffset&&(l.byteOffset=0);l=l.byteOffset+(h.byteOffset||0);l=e.dataview.subarray(l,l+a.length);a.set(l);if(f)for(f=1;f<databuffer.length;f+=n)databuffer[f]=1-databuffer[f];return databuffer},parseMaterial:function(n,a){var f=a.materials[n];if(!f)return console.warn("gltf material not found"),null;var l=f.name;
if(!l||this.rename_assets)l=a.filename+"::mat_"+(f.name||n);var h=RD.Materials[l];if(h&&(!this.overwrite_materials||h.from_filename==a.filename))return h;h=new RD.Material;h.name=l;h.from_filename=a.filename;null!=f.alphaMode&&(h.alphaMode=f.alphaMode);h.alphaCutoff=null!=f.alphaCutoff?f.alphaCutoff:0.5;null!=f.doubleSided&&(h.flags.two_sided=f.doubleSided);h.normalmapFactor=1;f.pbrMetallicRoughness&&(h.model="pbrMetallicRoughness",h.color.set([1,1,1]),h.opacity=1,h.metallicFactor=1,h.roughnessFactor=
1,null!=f.pbrMetallicRoughness.baseColorFactor&&(h.color=f.pbrMetallicRoughness.baseColorFactor),f.pbrMetallicRoughness.baseColorTexture&&(h.textures.albedo=this.parseTexture(f.pbrMetallicRoughness.baseColorTexture,a),"MASK"==h.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic&&(l=gl.textures[h.textures.albedo.texture]))&&(l.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8)),null!=f.pbrMetallicRoughness.metallicFactor&&(h.metallicFactor=
f.pbrMetallicRoughness.metallicFactor),null!=f.pbrMetallicRoughness.roughnessFactor&&(h.roughnessFactor=f.pbrMetallicRoughness.roughnessFactor),f.pbrMetallicRoughness.metallicRoughnessTexture&&(h.textures.metallicRoughness=this.parseTexture(f.pbrMetallicRoughness.metallicRoughnessTexture,a)));f.occlusionTexture&&(h.textures.occlusion=this.parseTexture(f.occlusionTexture,a));f.normalTexture&&(h.textures.normal=this.parseTexture(f.normalTexture,a));f.emissiveTexture&&(h.textures.emissive=this.parseTexture(f.emissiveTexture,
a));f.emissiveFactor&&(h.emissive=f.emissiveFactor);RD.Materials[h.name]=h;return this.gltf_materials[h.name]=h},parseTexture:function(n,a){var f=a.textures[n.index];if(!f)return console.warn("gltf texture not found"),null;var l=a.images[f.source],h="",e=null;l.uri?(e=l.uri,e.split(".").pop()):(e=a.url.replace(/[\/\.\:]/gi,"_")+"_image_"+n.index,h=l.mimeType?l.mimeType.split("/").pop():"png",e+="."+h);var q={};if(!gl.textures[e])if(l.uri){var k=l.uri;if("data:"==k.substr(0,5)){var r=l.uri.indexOf(","),
g=l.uri.substr(5,r),h=g.split("/").pop().toLowerCase(),e=a.folder+"/"+k+"image_"+n.index+"."+h,h=_base64ToArrayBuffer(l.uri.substr(r+1)),l=URL.createObjectURL(new Blob([h],{type:g})),l=GL.Texture.fromURL(l,this.texture_options);l.name=e;gl.textures[e]=l}else"blob:"==k.substr(0,5)?q.texture=k:q.texture=a.folder+"/"+k}else null!=l.bufferView&&(g=a.bufferViews[l.bufferView],null==g.byteOffset&&(g.byteOffset=0),h=a.buffers[g.buffer].data.slice(g.byteOffset,g.byteOffset+g.byteLength),l=URL.createObjectURL(new Blob([h],
{type:l.mimeType})),l=GL.Texture.fromURL(l,this.texture_options),l.name=e,gl.textures[e]=l);q.texture||(q.texture=e);null!=f.sampler&&(f=a.samplers[f.sampler],null!=f.magFilter&&(q.magFilter=f.magFilter),null!=f.minFilter&&(q.minFilter=f.minFilter));n.texCoord&&(q.uv_channel=n.texCoord);return q},parseSkin:function(n,a){var f=a.skins[n],l={};null!=f.skeleton&&(l.skeleton_root=a.nodes[f.skeleton].name);l.bindMatrices=this.splitBuffer(this.parseAccessor(f.inverseBindMatrices,a),16);l.joints=[];for(var h=
0;h<f.joints.length;++h)l.joints.push(a.nodes[f.joints[h]].id);return l},splitBuffer:function(n,a){for(var f=n.length,l=[],h=0;h<f;h+=a)l.push(new n.constructor(n.subarray(h,h+a)));return l},parseAnimation:function(n,a,f){f=a.animations[n];var l=new RD.Animation;l.name=f.name||"anim_"+n;for(var h=n=0;h<f.channels.length;++h){var e=new RD.Animation.Track,q=f.channels[h],k=f.samplers[q.sampler];e.target_node=a.nodes[q.target.node].name;e.target_property=q.target.path.toLowerCase();if(q=this.rename_animation_properties[e.target_property])e.target_property=
q;var q=this.parseAccessor(k.input,a),r=this.parseAccessor(k.output,a),g=a.accessors[k.output].type,k=RD.TYPES[g];k==RD.VEC4&&"rotation"==e.target_property&&(k=RD.QUAT);e.type=k;if(k=RD.TYPES_SIZE[k]){for(var g=r.length/k,c=new Float32Array((1+k)*g),p=0;p<g;++p){c[p*(1+k)]=q[p];var b=r.subarray(p*k,p*k+k);c.set(b,p*(1+k)+1)}e.data=c;e.packed_data=!0;n=Math.max(n,q[q.length-1]);l.addTrack(e)}else console.warn("gltf unknown type:",g)}l.duration=n;return l},loadFromFiles:function(n,a){function f(c){var b=
c.target.result,g=this.extension;if("gltf"==g)b=JSON.parse(b),l.main=this.filename;else if("glb"==g)l.main=this.filename;else if("bin"==g)q.push(this.filename);else if("jpeg"==g||"jpg"==g||"png"==g)c=URL.createObjectURL(new Blob([b],{type:c.target.mimeType})),g=GL.Texture.fromURL(c,{wrap:gl.REPEAT,extension:g}),g.name=this.filename,gl.textures[g.name]=g;l[this.filename]={filename:this.filename,data:b,extension:this.extension};h--;0==h&&(l.binaries=q,e.load(l,function(b){a&&a(b)}))}for(var l={},h=
n.length,e=this,q=[],k=0;k<n.length;++k){var r=n[k],g=new FileReader,c=r.name.split("."),c=c[c.length-1].toLowerCase();g.onload=f;g.filename=r.name;g.extension=c;"gltf"==c?g.readAsText(r):g.readAsArrayBuffer(r)}},removeRootPathFromTextures:function(n,a){if(a)for(var f in n){var l=n[f],h;for(h in l.textures){var e=l.textures[h];e&&(e.constructor===String&&0==e.indexOf(ROOM.root_path)&&-1!=e.texture.indexOf("/")?e.substr(ROOM.root_path.length):e.texture&&0==e.texture.indexOf(ROOM.root_path)&&-1!=e.texture.indexOf("/")&&
(e.texture=e.texture.substr(ROOM.root_path.length)))}}}};RD.SceneNode.prototype.loadGLTF=function(n,a){function f(e){l.addChild(e);a&&a(l)}var l=this;if(RD.GLTF.prefabs[n]){var h=new RD.SceneNode;h.configure(RD.GLTF.prefabs[n]);f(h)}else RD.GLTF.load(n,f)};function _base64ToArrayBuffer(n){n=window.atob(n);for(var a=n.length,f=new Uint8Array(a),l=0;l<a;l++)f[l]=n.charCodeAt(l);return f.buffer}"undefined"!=typeof DracoDecoderModule&&RD.GLTF.installDracoModule(RD.GLTF.onReady);
(function(n){function a(e){this.renderer=e;this.mode=a.FORWARD;this.visible_layers=65535;this.bgcolor=vec4.fromValues(0.1,0.1,0.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.emissive_factor=this.occlusion_factor=this.exposure=this.environment_factor=1;this.postfx_shader_name=null;this.brightness=this.contrast=1;this.gamma=2.2;this.parallax_reflection=!1;this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=
mat4.create();this.texture_matrix=mat3.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.single_pass=!1;this.allow_instancing=!0;this.debug_instancing=!1;this.use_rendertexture=!0;this.alpha_composite_target_texture=this.fx=null;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_gamma:this.gamma,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,
this.environment_factor],u_use_environment_texture:!1,u_viewport:gl.viewport_data,u_camera_perspective:1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec4.fromValues(0,0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),u_normalFactor:1,u_metallicRough:!1,u_reflectance:0.1,u_texture_matrix:this.texture_matrix,u_displacement_factor:0,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:0.5,
u_isAnisotropic:!1,u_anisotropy:0.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this._instancing_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.final_fbo=this.final_texture=null;this.render_calls=[];this.render_calls_pool=[];this.rendered_render_calls=this.used_render_calls=0;this.current_camera=null;this.overlay_rcs=[];this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);
this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new l.Material;this.onRenderBackground=null}function f(){this.name="";this.id=-1;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=null;this.reverse_faces=!1;this.node=this._instancing=null;this._render_priority=0}var l=n.RD;a.FORWARD=1;a.DEFERRED=2;a.MACROS={UVS2:1,COLOR:2,POINTS:4,INSTANCING:8,PARALLAX_REFLECTION:16};a.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");
a.prototype.render=function(e,f,k,h,g,c){this.renderer=e;this.current_camera=k;this.mode==a.FORWARD?this.renderForward(f,k,g,c):this.mode==a.DEFERRED&&this.renderDeferred(f,k,c);this.getBRDFIntegratorTexture()};a.prototype.fillGlobalUniforms=function(a){var f=this.getBRDFIntegratorTexture();f&&f.bind(0);this.environment_texture?(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=
!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3);this.global_uniforms.u_camera_perspective=a._projection_matrix[5];this.global_uniforms.u_tonemapper=0;this.quality?(this.global_uniforms.u_exposure=
this.exposure,this.global_uniforms.u_gamma=this.gamma):(this.global_uniforms.u_exposure=Math.pow(this.exposure,1/2.2),this.global_uniforms.u_gamma=1)};a.prototype.renderForward=function(a,f,k,h){var g=Math.floor(gl.viewport_data[2]*this.resolution_factor),c=Math.floor(gl.viewport_data[3]*this.resolution_factor),g=Math.min(g,this.max_texture_size),c=Math.min(c,this.max_texture_size);this.use_rendertexture&&!k&&(this.frame_texture&&this.frame_texture.width==g&&this.frame_texture.height==c||(this.frame_texture=
new GL.Texture(g,c,{format:gl.RGBA,type:gl.HIGH_PRECISION_FORMAT}),this.final_fbo?this.final_fbo.setTextures([this.frame_texture]):this.final_fbo=new GL.FBO([this.frame_texture],null,!0),this.frame_texture.name=":frame_texture",gl.textures[this.frame_texture.name]=this.frame_texture,this.final_texture=new GL.Texture(g,c,{format:gl.RGB}),this.final_texture.name=":final_frame_texture",gl.textures[this.final_texture.name]=this.final_texture),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],
this.bgcolor[2],this.bgcolor[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);if(this.onRenderBackground)this.onRenderBackground(f,this);else this.renderSkybox(f);LEvent.trigger(this,"renderSkybox",this);this.fillGlobalUniforms(f);if(this.onRenderOpaque)this.onRenderOpaque(this,this.renderer,f);LEvent.trigger(this,"renderOpaque",this);this.renderNodes(a,f,h);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,f);LEvent.trigger(this,
"renderAlpha",this);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,f);LEvent.trigger(this,"renderGizmos",this);this.use_rendertexture&&!k&&this.renderFinalBuffer();if(this.overlay_rcs.length)for(a=this.overlay_rcs,this.global_uniforms.u_gamma=1,this.global_uniforms.u_exposure=1,gl.clear(gl.DEPTH_BUFFER_BIT),f=0;f<a.length;++f)k=a[f],this.renderMeshWithMaterial(k.model,k.mesh,k.material,k.index_buffer_name,k.group_index,k.node.extra_uniforms,k.reverse_faces)};a.prototype.renderNodes=
function(e,f,k){this.resetRenderCallsPool();for(var h=this.render_calls.length=0;h<e.length;++h)this.getNodeRenderCalls(e[h],f,k);e=this.render_calls;for(h=0;h<e.length;++h)e[h].computeRenderPriority(f._position);e=e.sort(a.rc_sort_function);this.allow_instancing&&gl.extensions.ANGLE_instanced_arrays&&(e=this.groupRenderCallsForInstancing(e));f=(this.alpha_composite_callback||this.alpha_composite_target_texture)&&GL.FBO.current;k=!0;for(var g=this.overlay_rcs,h=g.length=0;h<e.length;++h){var c=e[h];
if(c.material.overlay)g.push(c);else{k&&f&&"BLEND"==c.material.alphaMode&&(k=!1,this.alpha_composite_target_texture&&GL.FBO.current.color_textures[0].copyTo(this.alpha_composite_target_texture),this.alpha_composite_callback&&this.alpha_composite_callback(GL.FBO.current,this.alpha_composite_target_texture));var p=c.model;c._instancing&&c._instancing.length&&(p=GL.linearizeArray(c._instancing,Float32Array));this.renderMeshWithMaterial(p,c.mesh,c.material,c.index_buffer_name,c.group_index,c.node.extra_uniforms,
c.reverse_faces)}}};a.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.frame_texture,this.frame_texture);this.fx_uniforms.u_viewportSize[0]=this.frame_texture.width;this.fx_uniforms.u_viewportSize[1]=this.frame_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.frame_texture.width;this.fx_uniforms.u_iViewportSize[1]=1/this.frame_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=
this.brightness;this.fx_uniforms.u_gamma=this.gamma;this.frame_texture.copyTo(this.final_texture,gl.shaders.tonemapper,this.fx_uniforms);var a=null;this.postfx_shader_name&&(a=gl.shaders[this.postfx_shader_name]);this.final_texture.toViewport(a)};a.prototype.getNodeRenderCalls=function(e,f,k){var h=null;if(e._mesh)h=e._mesh;else if(e.mesh&&(h=gl.meshes[e.mesh],!h))return;void 0===k&&(k=65535);e.updateGlobalMatrix(!0);if(h&&!1!==e.flags.visible&&e.layers&k){if(this.test_visibility){a.temp_bbox||(a.temp_bbox=
BBox.create(),a.aabb_center=BBox.getCenter(a.temp_bbox),a.aabb_halfsize=BBox.getHalfsize(a.temp_bbox));BBox.transformMat4(a.temp_bbox,h.getBoundingBox(),e._global_matrix);if(f.testBox(a.aabb_center,a.aabb_halfsize)==l.CLIP_OUTSIDE)return;e._last_rendered_frame=this.renderer.frame}if(e.primitives&&e.primitives.length)for(f=0;f<e.primitives.length;++f){var g=e.primitives[f];k=null;if(k=g.material?l.Materials[g.material]:this.default_material)g=this.getRenderCallFromPool(),g.material=k,g.model=e._global_matrix,
g.mesh=h,g.group_index=f,g.node=e,g._render_priority=k.render_priority||0,g._instancing=null,g.reverse_faces=e.flags.frontFace==GL.CW,this.render_calls.push(g)}else e.material&&(k=l.Materials[e.material])&&(g=this.getRenderCallFromPool(),g.material=k,g.model=e._global_matrix,g.mesh=h,g.group_index=-1,g.node=e,g._instancing=null,g._render_priority=k.render_priority||0,g.reverse_faces=e.flags.frontFace==GL.CW,this.render_calls.push(g))}};a.prototype.groupRenderCallsForInstancing=function(a){for(var f=
{},k=0,h=0;h<a.length;++h){var g=a[h],c=null,c=g._instancing?k++:g.mesh.name+":"+g.group_index+"/"+g.material.name+(g.reverse_faces?"[R]":"");f[c]?f[c].push(g):f[c]=[g]}a=[];for(h in f)if(k=f[h],0!=k.length)if(1==k.length)g=k[0],this.debug_instancing||a.push(g);else{g=this.getRenderCallFromPool();g.copyFrom(k[0]);g._instancing=Array(k.length);for(c=0;c<k.length;++c)g._instancing[c]=k[c].model;a.push(g)}return a};a.rc_sort_function=function(a,f){return f._render_priority-a._render_priority};a.prototype.setParallaxReflectionTransform=
function(a){this.parallax_reflection_matrix.set(a);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};a.prototype.resetShadersCache=function(){this.compiled_shaders={}};a.prototype.getShader=function(e,f){var k=this.compiled_shaders[f];k||(k=this.compiled_shaders[f]=new Map);var h=
k.get(e);if(h)return h;if(!this.renderer.shader_files)return null;var h=this.renderer.shader_files["default.vs"],g=this.renderer.shader_files[f],c=null;if(e){var c={},p;for(p in a.MACROS)e&a.MACROS[p]&&(c[p]="")}h=new GL.Shader(h,g,c);k.set(e,h);return h};a.prototype.renderRenderCall=function(a){var f=a.model;a._instancing&&a._instancing.length&&(f=new Float32Array(a._instancing.flat()));this.renderMeshWithMaterial(f,a.mesh,a.material,a.index_buffer_name,a.group_index,a.node.extra_uniforms,a.reverse_faces)};
a.prototype.renderMeshWithMaterial=function(e,f,k,h,g,c,p){var b=this.renderer,m=null;if(!("BLEND"==k.alphaMode&&0>=k.color[3])){var n=this.material_uniforms,u=this.sampler_uniforms,w=e.length/16;n.u_albedo=k.color.subarray(0,3);n.u_emissive.set(k.emissive||l.ZERO);n.u_emissive[3]=k.emissive_clamp_to_edge?1:0;1!=this.emissive_factor&&vec3.scale(n.u_emissive,n.u_emissive,this.emissive_factor);m=0;f.vertexBuffers.coords1&&(m|=a.MACROS.UVS2);f.vertexBuffers.colors&&(m|=a.MACROS.COLOR);this.parallax_reflection&&
(m|=a.MACROS.PARALLAX_REFLECTION);k.primitive==GL.POINTS&&(m|=a.MACROS.POINTS);1<w&&(m|=a.MACROS.INSTANCING);this.overwrite_shader_name?m=gl.shaders[this.overwrite_shader_name]:k.overlay?m=this.getShader(m,"overlay.fs"):"pbrMetallicRoughness"==k.model&&this.quality?(n.u_metalness=k.metallicFactor,n.u_roughness=k.roughnessFactor,n.u_metallicRough=Boolean(k.textures.metallicRoughness),m=this.getShader(m,"pbr.fs")):m="custom"==k.model&&k.shader_name?this.getShader(m,k.shader_name):this.getShader(m,"nopbr.fs");
if(m){n.u_alpha=k.opacity;n.u_alpha_cutoff=-1;n.u_normalFactor=null!=k.normalmapFactor?k.normalmapFactor:1;n.u_displacement_factor=null!=k.displacementFactor?k.displacementFactor:1;k.uv_transform?this.texture_matrix.set(k.uv_transform):mat3.identity(this.texture_matrix);for(var v=2,x=n.u_maps_info,s=0;s<a.maps.length;++s){var y=a.maps[s];x[s]=-1;var z=k.textures[y];if(z){var B=null;z.constructor===Object?B=z.texture:z.constructor===String&&(B=z,z=null);if(B&&(y="u_"+y+"_texture",!m||m.samplers[y])){var t=
gl.textures[B];t||(b.autoload_assets&&-1!=B.indexOf(".")&&b.loadTexture(B,b.default_texture_settings),t=gl.textures.white);B=16>this.max_textures?v++:s+2;u[y]=t.bind(B);x[s]=z&&null!=z.uv_channel?Math.clamp(z.uv_channel,0,3):0}}}p||gl.frontFace(GL.CCW);b.enableItemFlags(k);p&&gl.frontFace(GL.CW);"BLEND"==k.alphaMode?(gl.enable(gl.BLEND),k.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1)):"MASK"==k.alphaMode?n.u_alpha_cutoff=k.alphaCutoff:
gl.disable(gl.BLEND);1==w&&b._uniforms.u_model.set(e);m.uniforms(b._uniforms);m.uniforms(this.global_uniforms);m.uniforms(n);m.uniforms(u);c&&m.uniforms(c);k.primitive==GL.POINTS&&m.setUniform("u_pointSize",k.point_size||-1);c=null;null!=g&&f.info&&f.info.groups&&f.info.groups[g]&&(c=f.info.groups[g]);g=this._instancing_uniforms;g.u_model=e;k.flags.preAlpha&&(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),1<w?m.drawInstanced(f,void 0===k.primitive?gl.TRIANGLES:k.primitive,h,g):c?m.drawRange(f,k.primitive,
c.start,c.length,h):m.draw(f,k.primitive,h),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL),this.rendered_render_calls++);1<w?c?m.drawInstanced(f,void 0===k.primitive?gl.TRIANGLES:k.primitive,h,g,c.start,c.length):m.drawInstanced(f,void 0===k.primitive?gl.TRIANGLES:k.primitive,h,g):c?m.drawRange(f,k.primitive,c.start,c.length,h):m.draw(f,k.primitive,h);this.rendered_render_calls++;b.disableItemFlags(k);p&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};a.prototype.renderDeferred=
function(a,f){};a.prototype.prepareBuffers=function(a){};a.prototype.renderToGBuffers=function(a,f){};a.prototype.renderFinalPass=function(a,f){};a.prototype.applyPostFX=function(){};a.prototype.getRenderCallFromPool=function(){if(this.used_render_calls<this.render_calls_pool.length){var a=this.render_calls_pool[this.used_render_calls];this.used_render_calls++;return a}a=new l.RenderCall;a.id=this.used_render_calls;this.render_calls_pool.push(a);this.used_render_calls++;return a};a.prototype.resetRenderCallsPool=
function(){this.used_render_calls=0};a.prototype.renderSkybox=function(a){if((!this.onRenderSkybox||!this.onRenderSkybox(this,a))&&this.environment_texture&&this.render_skybox){var f=gl.meshes.cube,k=gl.shaders[this.overwrite_shader_name||"skybox"];if(k){var h=this.skybox_texture||this.environment_texture;if(h){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var g=this.renderer._model_matrix;mat4.identity(g);mat4.translate(g,g,a.position);mat4.scale(g,g,[10,10,10]);this.renderer.setModelMatrix(g);
k.uniforms(this.renderer._uniforms);k.uniforms({u_color_texture:h.bind(0),u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD,u_camera_position:a.position});k.draw(f,GL.TRIANGLES)}}}};a.prototype.loadEnvironment=function(a,f,k){var h=this,g=gl.textures[a];g?(k?h.skybox_texture=g:(g.shs&&(h.environment_sh_coeffs=g.shs),h.environment_texture=g),f&&f(g)):HDRE.load(a,function(c){var g=c.toTexture(!0);g&&(gl.textures[a]=g,k?h.skybox_texture=g:(g.shs=c.shs?
c.shs:null,h.environment_texture=g,g.shs&&(h.environment_sh_coeffs=g.shs)));f&&f(g)})};a.prototype.captureEnvironment=function(a,f,k){k=k||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(k,k,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));var h=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,a,f);this.use_rendertexture=h;this.capture_environment_texture.bind(0);
gl.generateMipmap(this.capture_environment_texture.texture_type);this.environment_texture||(this.environment_texture=new GL.Texture(k,k,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};a.prototype.getBRDFIntegratorTexture=function(a){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var f=gl.shaders.brdf_integrator;if(f){var k=gl.textures.brdf_integrator=new GL.Texture(128,
128,{type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});if(a)return fetch(a).then(function(a){return a.arrayBuffer()}).then(function(a){k.uploadData(new Float32Array(a),{no_flip:!0})}),k;var h=gl.textures.hammersley_sample_texture;h||(h=this.createHammersleySampleTexture());k.drawTo(function(a){h&&h.bind(0);f.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return k}};a.prototype.createHammersleySampleTexture=function(a){a=a||8192;for(var f=3*a,k=new Float32Array(f),
h=0;h<f;h+=3){var g=2*Math.radical_inverse(h)*Math.PI;k[h]=Math.cos(g);k[h+1]=Math.sin(g);k[h+2]=0}a=new GL.Texture(a,1,{pixel_data:k,type:GL.FLOAT,format:GL.RGB});return gl.textures.hammersley_sample_texture=a};a.prototype.setClippingPlane=function(a,f){a?this.global_uniforms.u_clipping_plane.set([f[0],f[1],f[2],vec3.dot(a,f)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};Math.radical_inverse=function(a){for(var f=0,k=0.5;a;k*=0.5,a>>=1)a&1&&(f+=k);return f};var h=vec3.create();f.prototype.copyFrom=
function(a){this.name=a.name;this.id=a.id;this.mesh=a.mesh;this.model=a.model;this.index_buffer_name=a.index_buffer_name;this.group_index=a.group_index;this.material=a.material;this.reverse_faces=a.reverse_faces;this.node=a.node;this._instancing=a._instancing;this._render_priority=a._render_priority};f.prototype.computeRenderPriority=function(a){this.name=this.node.name;var f=this.mesh.getBoundingBox();f&&(f=mat4.multiplyVec3(h,this.model,f),this._render_priority=this.material.render_priority||0,
this._render_priority+=0.001*vec3.distance(a,f),"BLEND"==this.material.alphaMode&&(this._render_priority-=100))};l.PBRPipeline=a;l.RenderCall=f})(this);
(function(n){function a(){this.intensity=1;this._color=vec3.fromValues(0.9,0.9,0.9);this._position=vec3.fromValues(10,20,5);this._target=vec3.create();this._vector=vec3.create();this.camera=new RD.Camera;this._castShadows=!1;this.shadowmap={texture:null,resolution:2048,bias:5E-6,uniforms:{u_shadowmap_matrix:this.camera._viewprojection_matrix,u_shadowmap_texture:4,u_shadowbias:1E-5}};this.uniforms={u_light_position:this._position,u_light_color:vec3.create(),u_light_vector:this._vector};this.flags=
{skip_shadows:!1}}Object.defineProperty(a.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});Object.defineProperty(a.prototype,"castShadows",{set:function(a){a?this.enableShadows():this.disableShadows()},get:function(){return this._castShadows},enumerable:!0});a.DEFAULT_SHADOWMAP_RESOLUTION=2048;a.prototype.updateData=function(){vec3.sub(this._vector,this._target,this._position);vec3.normalize(this._vector,this._vector)};a.prototype.setUniforms=
function(a){this.shadowmap.uniforms.u_shadowbias=this.shadowmap.bias;this.uniforms.u_light_color.set(this._color);vec3.scale(this.uniforms.u_light_color,this.uniforms.u_light_color,this.intensity);if(a.constructor===GL.Shader)a.uniforms(this.uniforms),this._castShadows&&(a.uniforms(this.shadowmap.uniforms),this.shadowmap.texture.bind(this.shadowmap.uniforms.u_shadowmap_texture));else{for(var l in this.uniforms)a[l]=this.uniforms[l];if(this._castShadows)for(l in this.shadowmap.uniforms)a[l]=this.shadowmap.uniforms[l]}};
a.prototype.lookAt=function(a,l,h){this._position.set(a);this._target.set(l);this.camera.lookAt(a,l,h);this.updateData()};a.prototype.setView=function(a,l,h){this.camera.orthographic(a,l,h,1);this.updateData()};a.prototype.followCamera=function(a,l){var h=l||5,e=vec3.scaleAndAdd(vec3.create(),a.target,this._vector,-l);this.lookAt(e,a.target,a.up);this.camera.orthographic(h,0.01,3*h,1);this.camera.updateMatrices()};a.prototype.enableShadows=function(){this._castShadows=!0;var f=this.shadowmap.resolution||
a.DEFAULT_SHADOWMAP_RESOLUTION;this.shadowmap.texture&&this.shadowmap.texture.width==f||(this.shadowmap.texture=new GL.Texture(f,f,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadowmap.fbo=new GL.FBO(null,this.shadowmap.texture))};a.prototype.disableShadows=function(){this._castShadows=!1;this.shadowmap.texture=null;this.shadowmap.fbo=null};a.prototype.generateShadowmap=function(a,l,h){if(this.castShadows){if(!this.shadowmap.fbo)throw"no shadowmap fbo";a.generating_shadowmap=
!0;this.shadowmap.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);a.shader_overwrite="flat";if(l.constructor===Array)for(var e=0;e<l.length;++e)a.render(l[e],this.camera,null,h||255);else a.render(l,this.camera,null,h||255);a.shader_overwrite=null;this.shadowmap.fbo.unbind();a.generating_shadowmap=!1;this.shadowmap.texture.bind(4)}};a.prototype.renderNode=function(a,l){gl.meshes.cylinder_light||(gl.meshes.cylinder_light=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone_light=GL.Mesh.cone({radius:0.1,
height:0.25}))};RD.Light=a})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(n){function a(){this.name="";this.tracks=[];this.duration=10}function f(){this.enabled=!0;this.target_property=this.target_node="";this.type=k.SCALAR;this.data=[];this.packed_data=!1;this._target=null}function l(a,c,e){return a*(1-e)+c*e}function h(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function e(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function q(){this.skeleton=
new h;this.duration=0;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this.bones_map=new Uint8Array(64);this.keyframes=null}var k=n.RD=n.RD||{};k.Animations={};a.prototype.addTrack=function(a,c){if(c)for(var e=0;e<this.tracks.length;++e)if(this.tracks[e].target_node==a.target_node){this.tracks.splice(e+1,0,a);return}this.tracks.push(a)};a.prototype.applyAnimation=function(a,c,e){for(var b=0;b<this.tracks.length;++b)this.tracks[b].applyTrack(a,c,e)};a.prototype.serialize=function(){for(var a=
{name:this.name,duration:this.duration,tracks:[]},c=0;c<this.tracks.length;++c)a.tracks.push(this.tracks[c].serialize());return a};a.prototype.configure=function(a){this.name=a.name;this.duration=a.duration;for(var c=this.tracks.length=0;c<a.tracks.length;++c){var e=new k.Animation.Track;e.configure(a.tracks[c]);this.tracks.push(e)}return a};a.prototype.findNearestLeft=function(a){for(var c=0,e=0;e<this.tracks.length;++e){var b=this.tracks[e],k=b.findTimeIndex(a);-1!=k&&(b=b.data[k],b>c&&(c=b))}return c};
a.prototype.findNearestRight=function(a){for(var c=this.duration,e=0;e<this.tracks.length;++e){var b=this.tracks[e],k=b.findTimeIndex(a);-1!=k&&(b=b.data[k+1],null!=b&&b<c&&(c=b))}return c};k.Animation=a;a.Track=f;Object.defineProperty(f.prototype,"value_size",{set:function(a){throw"cannot be set, use type instead";},get:function(){return k.TYPES_SIZE[this.type]}});f.prototype.addKeyframe=function(a,c,e){1<this.value_size&&(c=new Float32Array(c));for(var b=0;b<this.data.length;++b)if(!(this.data[b][0]<
a))return this.data[b][0]!=a||e?this.data.splice(b,0,[a,c]):this.data[b][1]=c,b;this.data.push([a,c]);return this.data.length-1};f.prototype.getKeyframe=function(a){if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),null;var c=k.TYPES_SIZE[this.type];return this.packed_data?(a*=1+c,a>this.data.length-c?null:[this.data[a],this.data.subarray(a+1,a+c+1)]):this.data[a]};f.prototype.findTimeIndex=function(a){var c=this.data;if(!c||0==c.length)return-1;var e=k.TYPES_SIZE[this.type];
if(this.packed_data){var e=e+1,b=c.length/e,f=0,h=0,l=b;if(0==b)return-1;if(1==b)return 0;if(c[(l-1)*e]<a)return l-1;for(;l>=f;){h=0.5*(l+f)|0;b=c[h*e];if(b==a)break;if(f==l-1)return f;b<a?f=h:l=h}return h}b=c.length;h=f=0;l=b;if(0==b)return-1;if(1==b)return 0;if(c[l-1][0]<a)return l-1;for(;l>=f;){h=0.5*(l+f)|0;b=c[h][0];if(b==a)break;if(f==l-1)return f;b<a?f=h:l=h}return h};f.prototype.getSample=function(a,c,e){return this.data&&0!==this.data.length?this.packed_data?this.getSamplePacked(a,c,e):this.getSampleUnpacked(a,
c,e):void 0};f.prototype.getSampleUnpacked=function(a,c,e){var b=k.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-1][0]);var f=this.findTimeIndex(a);-1===f&&(f=0);var h=f,l=f+1,n=this.data,b=k.TYPES_SIZE[this.type];if(!c||0==b||1==n.length||l==n.length||0==h&&this.data[0][0]>a)return this.data[f][1];h=n[h];l=n[l];a=(l[0]-a)/(l[0]-h[0]);1<b&&(e=e||this._result,e&&e.length==b||(e=this._result=new Float32Array(b)));if(c===k.LINEAR)return 1==b?h[1]*a+l[1]*(1-a):k.interpolateLinear(h[1],
l[1],a,e,this.type,b,this);if(c===k.CUBIC){c=0<f?n[f-1]:h;f=f<n.length-2?n[f+2]:l;if(1===b)return k.EvaluateHermiteSpline(h[1],l[1],c[1],f[1],1-a);e=k.EvaluateHermiteSplineVector(h[1],l[1],c[1],f[1],1-a,e);this.type==k.QUAT?(quat.slerp(e,l[1],h[1],a),quat.normalize(e,e)):this.type==k.TRANS10&&(b=e.subarray(3,7),h=h[1].subarray(3,7),l=l[1].subarray(3,7),quat.slerp(b,l,h,a),quat.normalize(b,b));return e}return null};f.prototype.getSamplePacked=function(a,c,e){if(!this.data.length)return null;var b=
k.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-b-1]);var f=this.findTimeIndex(a);-1==f&&(f=0);var h=b+1,l=f,n=f+1,q=this.data,r=q.length/h;if(!c||1==r||n==r||0==l&&this.data[0]>a)return this.getKeyframe(f)[1];1<b&&(e=e||this._result,e&&e.length==b||(e=this._result=new Float32Array(b)));var s=q.subarray(l*h,(l+1)*h),l=q.subarray(n*h,(n+1)*h);a=(l[0]-a)/(l[0]-s[0]);if(c===k.LINEAR){if(1==b)return s[1]*a+l[1]*(1-a);h=s.subarray(1,b+1);l=l.subarray(1,b+1);return k.interpolateLinear(h,
l,a,e,this.type,b,this)}if(c===k.CUBIC){if(0===b)return s[1];c=0<f?q.subarray((f-1)*h,f*h):s;n=n<r-1?q.subarray((n+1)*h,(n+2)*h):l;if(1===b)return k.EvaluateHermiteSpline(s[1],l[1],c[1],n[1],1-a);b=s.subarray(1,h);l=l.subarray(1,h);e=k.EvaluateHermiteSplineVector(b,l,c.subarray(1,h),n.subarray(1,h),1-a,e);this.type==k.QUAT?(quat.slerp(e,l,b,a),quat.normalize(e,e)):this.type==k.TRANS10&&(h=e.subarray(3,7),b=b.subarray(3,7),l=l.subarray(3,7),quat.slerp(h,l,b,a),quat.normalize(h,h));return e}return null};
f.prototype.applyTrack=function(a,c,e){if(a)return c=this.getSample(c,e),a.constructor===k.SceneNode?(e=null,(e=a.name==this.target_node?a:a.findNodeByName(this.target_node))&&(e[this.target_property]=c)):a.constructor===k.Skeleton&&(a=a.getBone(this.target_node))&&this.type==k.MAT4&&a.model.set(c),c};f.prototype.serialize=function(){return{enabled:this.enabled,target_node:this.target_node,target_property:this.target_property,type:this.type,data:this.data.concat(),packed_data:this.packed_data}};f.prototype.configure=
function(a){this.enabled=a.enabled;this.target_node=a.target_node;this.target_property=a.target_property;if(a.property){var c=a.property.indexOf("/");this.target_node=a.property.substr(0,c);this.target_property=a.property.substr(c+1)}null!=a.type&&(this.type=a.type.constructor===String?k.TYPES[a.type.toUpperCase()]||0:a.type);this.data=a.data.concat?a.data.concat():new a.data.constructor(a.data);this.packed_data=a.packed_data?a.packed_data:this.data.constructor!==Array};k.interpolateLinear=function(a,
c,e,b,f,h,l){if(1==h)return a*e+c*(1-e);b=b||l._result;b&&b.length==h||(b=l._result=new Float32Array(h));switch(f){case k.QUAT:quat.slerp(b,c,a,e);quat.normalize(b,b);break;case k.TRANS10:for(f=0;3>f;f++)b[f]=a[f]*e+c[f]*(1-e);for(f=7;10>f;f++)b[f]=a[f]*e+c[f]*(1-e);a=a.subarray(3,7);c=c.subarray(3,7);h=b.subarray(3,7);quat.slerp(h,c,a,e);quat.normalize(h,h);break;default:for(f=0;f<h;f++)b[f]=a[f]*e+c[f]*(1-e)}return b};k.EvaluateHermiteSpline=function(a,c,e,b,f){var h=f*f,k=h*f;return(2*k-3*h+1)*
a+(-2*k+3*h)*c+(k-2*h+f)*(c-e)+(k-h)*(b-a)};k.EvaluateHermiteSplineVector=function(a,c,e,b,f,h){h=h||new Float32Array(h.length);var k=f*f,l=k*f,n=2*l-3*k+1,q=-2*l+3*k;f=l-2*k+f;for(var k=l-k,l=0,r=h.length;l<r;++l)h[l]=n*a[l]+q*c[l]+f*(c[l]-e[l])+k*(b[l]-a[l]);return h};Math.lerp||(Math.lerp=l);k.Skeleton=h;h.Bone=e;e.prototype.serialize=function(){return{name:this.name,model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,
this.num_children)):null}};e.prototype.configure=function(a){this.name=a.name;this.model.set(a.model);this.parent=a.parent;this.layer=a.layer;this.num_children=0;this.index=null!=a.index?a.index:-1;a.children&&(this.children.set(a.children),this.num_children=a.children.constructor===Array?a.children.length:a.num_children)};e.prototype.copyFrom=e.prototype.configure;h.prototype.applyTransformToBones=function(a,c){var e=this.getBone(a);e&&mat4.multiply(e.model,e.model,c)};h.prototype.getBone=function(a){return this.bones[this.bones_by_name.get(a)]};
h.identity=mat4.create();h.prototype.getBoneMatrix=function(a,c){var e=this.bones_by_name.get(a);return void 0===e?h.identity:c?this.global_bone_matrices[e]:this.bones[e].model};h.prototype.importSkeleton=function(a){function c(a){var g=new e;g.name=a.name||a.id;g.model.set(a.model||a.transform);g.index=f.length;f.push(g);b.bones_by_name.set(g.name,g.index);b.global_bone_matrices.push(mat4.create());if(a.children&&a.children.length){g.num_children=a.children.length;for(var h=0;h<a.children.length;++h){var k=
c(a.children[h]);g.children[h]=k.index;k.parent=g.index}}return g}var f=this.bones=[],b=this;c(a);this.updateGlobalMatrices()};h.temp_mat4=mat4.create();h.temp_mat43=h.temp_mat4.subarray(0,12);h.prototype.computeFinalBoneMatrices=function(a,c,e){if(!this.bones.length||!c||!c.bones)return a||[];this.updateGlobalMatrices();var b=e?12*c.bones.length:16*c.bones.length;a&&a.length==b||(a=new Float32Array(b));if(e){var f=h.temp_mat4,f=h.temp_mat43;for(e=0;e<c.bones.length;++e)b=c.bones[e],mat4.multiply(temp_mat4,
this.getBoneMatrix(b[0],!0),b[1]),c.bind_matrix&&mat4.multiply(temp_mat4,temp_mat4,c.bind_matrix),mat4.transpose(temp_mat4,temp_mat4),a.set(f,12*e)}else for(e=0;e<c.bones.length;++e)b=c.bones[e],f=a.subarray(16*e,16*e+16),mat4.multiply(f,this.getBoneMatrix(b[0],!0),b[1]),c.bind_matrix&&mat4.multiply(f,f,c.bind_matrix);return a};h.prototype.computeFinalBoneMatricesAsArray=function(a,c,e){if(!this.bones.length||!c||!c.bones)return a||[];this.updateGlobalMatrices();a=a||[];a.length=c.bones.length;for(var b=
0;b<c.bones.length;++b){var f=c.bones[b];a[b]||(a[b]=mat4.create());var h=a[b];mat4.multiply(h,this.getBoneMatrix(f[0],!0),f[1]);c.bind_matrix&&mat4.multiply(h,h,c.bind_matrix);e&&mat4.multiply(h,e,h)}return a};h.prototype.updateGlobalMatrices=function(){var a=this.bones;if(a.length){var c=this.bones.length;this.global_bone_matrices[0].set(a[0].model);for(var e=1;e<c;++e){var b=a[e];mat4.multiply(this.global_bone_matrices[e],this.global_bone_matrices[b.parent],b.model)}}};h.prototype.assignLayer=
function(a,c){};h.prototype.applyTracksAnimation=function(a,c){for(var e=0;e<a.tracks.length;++e){var b=a.tracks[e],f=this.bones_by_name.get(b.target_node);null!=f&&(f=this.bones[f],"model"!=b.target_property&&"matrix"!=b.target_property||b.getSample(c,k.LINEAR,f.model))}};h.prototype.getVertices=function(a,c){if(!this.bones.length)return null;c||this.updateGlobalMatrices();var e=6*(this.bones.length-1);this._vertices&&this._vertices.length==e||(this._vertices=new Float32Array(e));for(var e=this._vertices,
b=0,f=1;f<this.bones.length;++f){var h=this.global_bone_matrices[this.bones[f].parent],k=this.global_bone_matrices[f],l=e.subarray(b,b+3),n=e.subarray(b+3,b+6);mat4.getTranslation(l,k);mat4.getTranslation(n,h);a&&(vec3.transformMat4(l,l,a),vec3.transformMat4(n,n,a));b+=6}return e};h.prototype.resizeBones=function(a){if(this.bones.length!=a)if(this.bones.length>a)this.bones.length=a,this.global_bone_matrices.length=a;else{var c=this.bones.length;for(this.bones.length=a;c<a;++c)this.bones[c]=new e,
this.global_bone_matrices[c]=mat4.create()}};h.prototype.copyFrom=function(a){this.resizeBones(a.bones.length);for(var c=0;c<a.bones.length;++c)this.bones[c].copyFrom(a.bones[c]),this.global_bone_matrices[c].set(a.global_bone_matrices[c]);this.bones_by_name=new Map(a.bones_by_name)};h.prototype.serialize=function(){for(var a={bones:[],bone_names:{}},c=0;c<this.bones.length;++c)a.bones.push(this.bones[c].serialize());return a};h.prototype.configure=function(a){this.resizeBones(a.bones.length);a.bones_by_name?
this.bones_by_name=new Map(a.bones_by_name):this.bones_by_name.clear();for(var c=0;c<a.bones.length;++c){var e=this.bones[c];e.copyFrom(a.bones[c]);e.index=c;a.global_bone_matrices?this.global_bone_matrices[c].set(a.global_bone_matrices[c]):this.bones_by_name.set(this.bones[c].name,c)}};var r=vec3.create();h.blend=function(a,c,e,b,f,k){if(a.bones.length!=c.bones.length)console.error("skeleton must contain the same number of bones");else{e=Math.clamp(e,0,1);if(255==f){if(0==e){if(b==a)return;b.copyFrom(a);
return}if(1==e){b.copyFrom(c);return}}if(b!=a){b.resizeBones(a.bones.length);for(f=0;f<b.bones.length;++f){var l=b.bones[f];l||(l=b.bones[f]=new h.Bone);l.copyFrom(a.bones[f])}b.bones_by_name=new Map(a.bones_by_name)}for(f=0;f<b.bones.length;++f){for(var n=b.bones[f],q=a.bones[f],x=c.bones[f],l=0;16>l;++l)n.model[l]=Math.lerp(q.model[l],x.model[l],e);if(!k)for(n=n.model,l=0;3>l;++l)r[0]=n[0+l],r[1]=n[4+l],r[2]=n[8+l],vec3.normalize(r,r),n[0+l]=r[0],n[4+l]=r[1],n[8+l]=r[2]}}};h.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
h.vertex_shader_code="\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\t\n\tvarying vec3 v_wPosition;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\t\n\tuniform mat4 u_viewprojection;\n\tuniform mat4 u_model;\n\tuniform mat4 u_normal_matrix;\n\t\n\t"+h.shader_code+"\n\t\n\tvoid main() {\n\t\tv_wPosition = a_vertex;\n\t\tv_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;\n\t\tv_coord = a_coord;\n\t\t\n\t\tcomputeSkinning( v_wPosition, v_wNormal);\n\t\t\n\t\tv_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;\n\t\t\n\t\tgl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );\n\t}\n";
k.SkeletalAnimation=q;q.prototype.load=function(a,c){var e=this;return HttpRequest(a,null,function(a){e.fromData(a);c&&c(e)})};q.prototype.assignTime=function(a,c,e,b){if(this.duration&&this.samples_per_second){c||void 0===c?(a%=this.duration,0>a&&(a=this.duration+a)):a=Math.clamp(a,0,this.duration-1/this.samples_per_second);void 0===e&&(e=!0);a*=this.samples_per_second;var f=Math.floor(a),h=(f+1)%this.num_keyframes,f=f%this.num_keyframes;a-=Math.floor(a);c=this.num_animated_bones;b=16*c;for(var f=
f*b,h=h*b,k=this.skeleton,n=this.keyframes,q=this.bones_map,r=0;r<c;++r){var s=k.bones[q[r]];if(!s)throw"bone not found in skeleton";b=16*r;if(e)for(var y=0;16>y;++y)s.model[y]=l(n[f+b+y],n[h+b+y],a);else s.model.set(n.subarray(f+b,f+b+16))}}};q.prototype.resize=function(a,c){this.num_keyframes=Math.floor(a);this.num_animated_bones=c;this.keyframes=new Float32Array(a*c*16)};q.prototype.assignPoseToKeyframe=function(a,c){if(c>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";
for(var e=c*this.num_animated_bones*16,b=0;b<this.num_animated_bones;++b){var f=a.bones[this.bones_map[b]];null!=f&&this.keyframes.set(f.model,e+16*b)}};q.prototype.fromData=function(a){a=a.split("\n");var c=a[0].split(",");this.duration=Number(c[0]);this.samples_per_second=Number(c[1]);this.num_keyframes=Number(c[2]);this.skeleton.resizeBones(Number(c[3]));for(var c=0,e=1;e<a.length;++e){var b=a[e],f=b[0],b=b.substr(1).split(",");if("B"==f){var h=Number(b[0]),k=this.skeleton.bones[h];if(!k)throw"bone not found in skeleton";
k.name=b[1];k.parent=Number(b[2]);for(f=0;16>f;++f)k.model[f]=Number(b[3+f]);-1!=k.parent&&(b=this.skeleton.bones[k.parent],16<=b.num_children?console.warn("too many child bones, max is 16"):b.children[b.num_children++]=h);this.skeleton.bones_by_name.set(k.name,h)}else if("@"==f){this.num_animated_bones=Number(b[0]);for(f=0;f<this.num_animated_bones;++f)this.bones_map[f]=Number(b[f+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==f){h=c*this.num_animated_bones*16;f=0;for(k=
16*this.num_animated_bones;f<k;++f)this.keyframes[h+f]=Number(b[f+1]);c++}else break}this.assignTime(0,!1,!1)};q.prototype.toData=function(){var a=[];a.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());for(var c=this.skeleton.bones,e=0;e<c.length;++e){var b=c[e];a.push("B"+e+","+b.name+","+b.parent+","+typedArrayToArray(b.model))}c=[];for(e=0;e<this.num_animated_bones;++e)c.push(this.bones_map[e]);a.push("@"+c.length+","+c.join(","));c=1/
this.samples_per_second;for(e=0;e<this.num_keyframes;++e){for(var b=16*e*this.num_animated_bones,b=this.keyframes.subarray(b,b+16*this.num_animated_bones),f=0;f<b.length;++f)1E-6>Math.abs(b[f])&&(b[f]=0);a.push("K"+(e*c).toFixed(3)+","+b.join(","))}return a.join("\n")};q.prototype.fromTracksAnimation=function(a,c,e){this.duration=c.duration;this.samples_per_second=e;this.skeleton.copyFrom(a);for(var b=0,f=0;f<c.tracks.length;++f){var h=a.bones_by_name.get(c.tracks[f].target_node);null!=h&&(this.bones_map[b]=
h,b++)}this.resize(Math.floor(c.duration*e),b);for(f=0;f<this.num_keyframes;++f)this.skeleton.applyTracksAnimation(c,1/e*f),this.assignPoseToKeyframe(this.skeleton,f)};k.SceneNode&&(k.SceneNode.prototype.assignSkeleton=function(a){var c=gl.meshes[this.mesh];c&&(this.bones=a.computeFinalBoneMatrices(this.bones,c),this.uniforms.u_bones=this.bones)},k.SceneNode.prototype.assignAnimation=function(a){this.assignSkeleton(a.skeleton)});k.AnimatedCharacterFromScene=function(a,c){for(var e=[],b=[],f=null,
h=0;h<a.root.children.length;++h){var l=a.root.children[h];l.name&&-1!=l.name.indexOf("_Hips")||"JOINT"==l.type?f=l:l.mesh&&(e.push(l),b.push({mesh:GL.Mesh.load(a.meshes[l.mesh])}))}if(!f)throw"this DAE doesnt contain an animated character";h=l=null;e.length&&(l=null,1<e.length?(h=GL.Mesh.mergeMeshes(b),l=e[0].mesh):(l=e[0].mesh,h=GL.Mesh.fromBinary(a.meshes[l])),h.filename=l,gl.meshes[l]=h,l=a.materials[e[0].material]);e=new k.Skeleton;e.importSkeleton(f);b=a.resources[a.root.animation];f=new k.Animation;
f.configure(b.takes["default"]);b=new k.SkeletalAnimation;b.fromTracksAnimation(e,f,30);b.filename=c;return{mesh:h?h.filename:null,material:l,skeleton:e,skeletal_anim:b,tracks_anim:f}}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
