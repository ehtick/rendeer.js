(function(w){function g(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();a&&this.origin.set(a);b&&this.direction.set(b)}function z(a,b){return vec3.dot(a,b)+a[3]}function n(a,b,e){var k=a[3];e=Math.abs(e[0]*a[0])+Math.abs(e[1]*a[1])+Math.abs(e[2]*a[2]);a=vec3.dot(a,b)+k;return a<=-e?H:a<=e?I:A}var f=w.RD={version:.5};f.ZERO=vec3.fromValues(0,0,0);f.ONE=vec3.fromValues(1,1,1);f.RIGHT=vec3.fromValues(1,0,0);f.LEFT=vec3.fromValues(-1,0,0);f.UP=vec3.fromValues(0,
1,0);f.DOWN=vec3.fromValues(0,-1,0);f.FRONT=vec3.fromValues(0,0,-1);f.BACK=vec3.fromValues(0,0,1);f.FRONT2D=vec2.fromValues(0,1);f.WHITE=vec3.fromValues(1,1,1);f.BLACK=vec3.fromValues(0,0,0);f.IDENTITY=mat4.create();f.ONES4=vec4.fromValues(1,1,1,1);f.TRANS10_IDENTITY=new Float32Array([0,0,0,0,0,0,1,1,1,1]);f.CENTER=0;f.TOP_LEFT=1;f.TOP_RIGHT=2;f.BOTTOM_LEFT=3;f.BOTTOM_RIGHT=4;f.TOP_CENTER=5;f.BOTTOM_CENTER=6;f.PRIORITY_BACKGROUND=30;f.PRIORITY_OPAQUE=20;f.PRIORITY_ALPHA=10;f.PRIORITY_HUD=0;f.BLEND_NONE=
0;f.BLEND_ALPHA=1;f.BLEND_ADD=2;f.BLEND_MULTIPLY=3;f.NO_BILLBOARD=0;f.BILLBOARD_SPHERIC=1;f.BILLBOARD_PARALLEL_SPHERIC=2;f.BILLBOARD_CYLINDRIC=3;f.BILLBOARD_PARALLEL_CYLINDRIC=4;f.UNKNOWN=0;f.NUMBER=f.SCALAR=1;f.VEC2=2;f.VEC3=3;f.VEC4=4;f.QUAT=5;f.MAT3=6;f.TRANS10=7;f.MAT4=8;f.STRING=9;f.TYPES={NUMBER:f.NUMBER,SCALAR:f.NUMBER,VEC2:f.VEC2,VEC3:f.VEC3,VEC4:f.VEC4,QUAT:f.QUAT,MAT3:f.MAT3,TRANS10:f.TRANS10,MAT4:f.MAT4,STRING:f.STRING};f.TYPES_SIZE=[0,1,2,3,4,4,9,10,16,0];f.NO_INTERPOLATION=0;f.LINEAR=
1;f.CUBIC=2;var m=f.DEG2RAD=.0174532925;f.RAD2DEG=57.295779578552306;var r={COLOR:1,COORD1:2,INSTANCING:4,SKINNING:8,MORPHTARGETS:16,POINTS:32,NO_TRIANGLES:64,TEXTURE:128,ALBEDO:256,EMISSIVE:512,OCCLUSION:1024,ALPHA_HASH:2048,UV_TRANSFORM:4096,LIGHTS:8192,SHADOWS:16384,FOG:32768,FLAT_NORMAL:65536,UNLIT:131072,SECOND_BUFFER:262144,FLAT_COLOR:524288},v=vec3.create(),D=vec3.create();f.Materials={};f.Images={};f.setup=function(a){a=a||{};if(f.configuration)throw"already called setup";f.configuration=
a};var E=0;"undefined"==typeof extendClass&&(w.extendClass=function(a,b){for(var e in b)a.hasOwnProperty(e)||(a[e]=b[e]);if(b.prototype){var k=Object.getOwnPropertyNames(b.prototype);for(e=0;e<k.length;++e){var h=k[e];a.prototype.hasOwnProperty(h)||(b.prototype.__lookupGetter__(h)?a.prototype.__defineGetter__(h,b.prototype.__lookupGetter__(h)):a.prototype[h]=b.prototype[h],b.prototype.__lookupSetter__(h)&&a.prototype.__defineSetter__(h,b.prototype.__lookupSetter__(h)))}}a.hasOwnProperty("superclass")||
Object.defineProperty(a,"superclass",{get:function(){return b},enumerable:!1})});mat3.create();var c=mat4.create(),p=mat3.create(),d=mat4.create(),l=vec2.create();v=vec3.create();D=vec3.create();vec4.create();var u=quat.create();class t{set id(a){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=a}get id(){return this._id}get position(){return this._position}set position(a){this._position.set(a);this._must_update_matrix=!0}get x(){return this._position[0]}set x(a){this._position[0]=
a;this._must_update_matrix=!0}get y(){return this._position[1]}set y(a){this._position[1]=a;this._must_update_matrix=!0}get z(){return this._position[2]}set z(a){this._position[2]=a;this._must_update_matrix=!0}get rotation(){return this._rotation}set rotation(a){this._rotation.set(a);this._must_update_matrix=!0}get scaling(){return this._scale}set scaling(a){a.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=a:this._scale.set(a);this._must_update_matrix=!0}get transform(){return this._transform}set transform(a){this._transform.set(a);
quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0}get matrix(){return this._local_matrix}set matrix(a){this.fromMatrix(a)}get pivot(){return this._pivot}set pivot(a){this._must_update_matrix=!0;a?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(a),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)}set color(a){if(this.material){var b=this.getMaterial();b&&(b.color=a)}else console.warn("cannot set color of node without material")}get color(){var a=this.getMaterial();
a&&a.color;console.warn("cannot get color of node without material");return null}get mustUpdate(){return this._must_update_matrix}set mustUpdate(a){a&&(this._must_update_matrix=!0)}get visible(){return this.flags.visible}set visible(a){this.flags.visible=a}get scene(){return this._scene}set scene(a){throw"cannot set scene, you must use addChild in its parent node";}get parentNode(){return this._parent}set parentNode(a){throw"Cannot set parentNode of SceneNode, use addChild on parent";}constructor(a){this._uid=
E++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.layers=3;this.draw_range=this.instances=this.mesh=null;this.submesh=-1;this.primitives=[];this.material=null;this.flags={visible:!0,collides:!0};this.extras={};this._parent=null;this.children=
[];quat.identity(this._rotation);this._scale.set(f.ONE);a&&this.fromJSON(a)}clone(a){var b=new this.constructor,e;for(e in this)if("_"!=e[0])if("children"==e){if(a)for(var k=0;k<this.children.length;++k)b.addChild(this.children[k].clone(a))}else k=this[e],void 0!==k&&(null===k?b[e]=null:k.constructor===Object?b[e]=GL.cloneObject(k):k.constructor===Array?b[e]=k.concat():b[e]!==k&&(b[e]=k));b.position=this.position;b.rotation=this.rotation;b.scaling=this.scaling;return b}toJSON(){var a={position:[this._position[0],
this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(a.name=this.name);this.primitives&&this.primitives.length&&(a.primitives=this.primitives.map(function(k){return Object.assign({},k)}));this.mesh&&(a.mesh=this.mesh);this.material&&(a.material=this.material);null!=this.submesh&&(a.submesh=this.submesh);this.flags&&(a.flags=structuredClone(this.flags));this.extras&&
(a.extras=this.extras);this.animation&&(a.animation=this.animation);if(this.animations){a.animations=[];for(var b=0;b<this.animations.length;++b)a.animations.push(this.animations[b].toJSON())}if(this.skin)for(a.skin={},a.skin.joints=this.skin.joints.concat(),a.skin.skeleton_root=this.skin.skeleton_root,a.skin.bindMatrices=[],b=0;b<this.skin.bindMatrices.length;++b)a.skin.bindMatrices.push(typedArrayToArray(this.skin.bindMatrices[b]));this.skeleton&&(a.skeleton=this.skeleton.toJSON());this.morphs&&
(a.morphs=this.morphs.concat());if(this.onSerialize)this.onSerialize(a);if(this.children){b=0;for(var e=this.children.length;b<e;b++)a.children.push(this.children[b].toJSON())}return a}fromJSON(a){var b=null,e;for(e in a){switch(e){case "children":continue;case "uniforms":for(var k in a.uniforms)this.uniforms[k]=a.uniforms[k];continue;case "flags":for(k in a.flags)this.flags[k]=a.flags[k];continue;case "scale":case "scaling":vec3.copy(this._scale,[1,1,1]);this.scale(a[e]);continue;case "tiling":isNumber(a[e])?
this.setTextureTiling(a[e],a[e]):this.setTextureTiling(a[e][0],a[e][1],a[e][2],a[e][3]);continue;case "skeleton":var h=new f.Skeleton;h.fromJSON(a[e]);this.skeleton=h;continue;case "animations":this.animations=[];for(k=0;k<a.animations.length;++k)h=new f.Animation,h.fromJSON(a.animations[k]),this.animations.push(h);continue;case "primitives":this.primitives=a.primitives.map(function(x){return Object.assign({},x)});continue;case "material":this.material=a[e]&&a[e].constructor===Object?(new P(a[e])).register().name:
a[e];continue;case "morphs":this.morphs=structuredClone(a.morphs);break;case "name":case "mesh":case "ref":case "draw_range":case "submesh":case "skin":case "extra":case "extras":case "animation":this[e]=a[e];continue;case "parent":b=a[e]}h=this[e];void 0!==h&&(h&&h.constructor===Float32Array?h.set(a[e]):this[e]=a[e])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(a.children)for(this.removeAllChildren(),e=0;e<a.children.length;++e)k=new f.SceneNode,k.fromJSON(a.children[e]),this.addChild(k);
b&&(this.parentNode?console.error("This node already has a parent"):b.addChild(this))}setMesh(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null}addChild(a,b){function e(k,h){if(k._scene&&k._scene!=h){var x=k._scene._nodes.indexOf(k);-1!=x&&k._scene._nodes.splice(x,1);k.id&&k._scene._nodes_by_id[k.id]==k&&delete k._scene._nodes_by_id[k.id]}if(k._scene=h)h._nodes.push(k),k.id&&h&&(h._nodes_by_id[k.id]=k);if(k.children){x=0;for(var y=k.children.length;x<y;x++){var C=k.children[x];C._scene!=
h&&e(C,h)}}}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";a._parent=this;b&&a.fromMatrix(a._global_matrix);this.children||(this.children=[]);this.children.push(a);this._scene!=a._scene&&e(a,this._scene);return this}removeChild(a,b){function e(h){if(h._scene){h.id&&h._scene._nodes_by_id[h.id]==h&&delete h._scene._nodes_by_id[h.id];var x=h._scene._nodes.indexOf(h);-1!=x&&h._scene._nodes.splice(x,1)}h._scene=null;x=0;for(var y=h.children.length;x<y;x++)e(h.children[x])}
if(a._parent!=this)throw"removeChild: Not its children";if(!this.children)return this;var k=this.children.indexOf(a);if(-1==k)throw"removeChild: impossible, should be children";this.children.splice(k,1);a._parent=null;b?a.fromMatrix(a._global_matrix):a._global_matrix.set(a._local_matrix);e(a);return this}removeAllChildren(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])}clear(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-
1])}remove(){this._parent&&this._parent.removeChild(this)}destroy(a){!this.scene||a?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)}setChildIndex(a,b){if(this.children){var e=this.children.indexOf(a);-1!=e&&(this.children.splice(e,1),this.children.splice(b,0,a))}}getAllChildren(a){a=a||[];if(!this.children)return a;for(var b=0,e=this.children.length;b<e;b++){var k=this.children[b];a.push(k);k.getAllChildren(a)}return a}getVisibleChildren(a,b,e){a=a||[];null==b&&(b=65535);
if(!this.children||!1===this.flags.visible)return a;for(var k=0,h=this.children.length;k<h;k++){var x=this.children[k];if(!1!==x.flags.visible){var y=x.layers&b;if(!e||y)y&&a.push(x),x.updateGlobalMatrix(!0),x.getVisibleChildren(a,b)}}return a}findNode(a){for(var b=0,e=this.children.length;b<e;b++){var k=this.children[b];if(k.id==a||(k=k.findNode(a)))return k}return null}findNodeByName(a){if(null==a)return null;for(var b=0,e=this.children.length;b<e;b++){var k=this.children[b];if(k.name==a||(k=k.findNodeByName(a)))return k}return null}findNodesByFilter(a,
b,e){null==b&&(b=65535);e=e||[];for(var k=0,h=this.children.length;k<h;k++){var x=this.children[k];x.layers&b&&(a&&!a(x)||e.push(x),x.findNodesByFilter(a,b,e))}return e}propagate(a,b){for(var e=0,k=this.children.length;e<k;e++){var h=this.children[e];h&&(h[a]&&h[a].apply(h,b),h.children&&h.children.length&&h.propagate(a,b))}}resetTransform(){this._position.set(f.ZERO);quat.identity(this._rotation);this._scale.set(f.ONE);this._must_update_matrix=!0}translate(a,b){b?this.getGlobalVector(a,v):v.set(a);
vec3.add(this._position,this._position,v);this._must_update_matrix=!0}moveLocal(a){this.translate(a,!0)}setEulerRotation(a,b,e){a&&3<=a.length?quat.fromEuler(this._rotation,a):quat.fromEuler(this._rotation,[a,b,e]);this._must_update_matrix=!0}getEulerRotation(a){a=a||vec3.create();quat.toEuler(a,this._rotation);return a}rotate(a,b,e){e&&(b=this.getGlobalVector(b,v));quat.setAxisAngle(u,b,a);quat.multiply(this._rotation,u,this._rotation);this._must_update_matrix=!0}rotateQuat(a,b){b?quat.multiply(this._rotation,
a,this._rotation):quat.multiply(this._rotation,this._rotation,a);this._must_update_matrix=!0}scale(a){a.constructor===Number?(v[0]=v[1]=v[2]=a,vec3.mul(this._scale,this._scale,v)):vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0}lookAt(a,b,e,k){this.position=a;this.orientTo(b,k,e)}orientTo(a,b,e,k,h,x){var y=this.getGlobalPosition(),C=vec3.create();k?C.set(a):vec3.sub(C,y,a);h&&(C[1]=0);e=e||f.UP;vec3.normalize(C,C);b&&vec3.scale(C,C,-1);a=mat3.create();e=vec3.cross(vec3.create(),e,
C);vec3.normalize(e,e);b=vec3.cross(vec3.create(),C,e);vec3.normalize(b,b);mat3.setColumn(a,e,0);mat3.setColumn(a,b,1);mat3.setColumn(a,C,2);quat.fromMat3(this._rotation,a);x&&quat.invert(this._rotation,this._rotation);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0;return this}setPivot(a){this.pivot=a}getLocalMatrix(a){this._must_update_matrix&&this.updateLocalMatrix();return a?(a.set(this._global_matrix),a):this._local_matrix}getGlobalMatrix(a,b){this.updateGlobalMatrix(b);
return a?(a.set(this._global_matrix),a):this._global_matrix}getGlobalRotation(a){a=a||vec4.create();quat.identity(a);for(var b=this,e=this._scene?this._scene._root:null;b!=e;)quat.multiply(a,b._rotation,a),b=b._parent;return a}updateLocalMatrix(){var a=this._local_matrix;this._must_update_matrix=!1;mat4.identity(a);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(a[12]=this._pivot[0],a[13]=this._pivot[1],a[14]=this._pivot[2]),mat4.translate(a,a,this._position),mat4.fromQuat(d,this._rotation),
mat4.multiply(a,a,d),mat4.scale(a,a,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(a,a,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))}updateGlobalMatrix(a,b){this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?(a=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);
if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,b)}updateMatrices(a){this.updateLocalMatrix();this.updateGlobalMatrix(a)}fromMatrix(a,b){b&&this._parent&&this._parent._transform&&(mat4.copy(this._global_matrix,a),b=this._parent.getGlobalMatrix(),mat4.invert(b,b),a=mat4.multiply(this._local_matrix,b,a));b=mat4.clone(a);mat4.multiplyVec3(this._position,b,[0,0,0]);var e=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(e,b,f.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(e,
b,f.UP));this._scale[2]=vec3.length(mat4.rotateVec3(e,b,f.BACK));b=mat3.fromMat4(p,b);quat.fromMat3AndQuat(this._rotation,b);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1}getLocalPoint(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,a,this._local_matrix)}getParentVector(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)}getLocalVector(a){console.error("DEPRECATED: SceneNode.prototype.getLocalVector, use getGlobalVector or getParentVector")}getGlobalPosition(a,
b){a=a||vec3.create();if(b)return vec3.transformMat4(a,f.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return a.set(this._position),a;b=this.getGlobalMatrix();return vec3.transformMat4(a,f.ZERO,b)}localToGlobal(a,b,e){b=b||vec3.create();e=this.getGlobalMatrix(null,e);return vec3.transformMat4(b,a,e)}globalToLocal(a,b){b=b||vec3.create();var e=this.getGlobalMatrix();mat4.invert(d,e);return vec3.transformMat4(b,a,d)}globalVectorToLocal(a,b){b=b||vec3.create();var e=this.getGlobalRotation();
quat.invert(e,e);return vec3.transformQuat(b,a,e)}getGlobalVector(a,b){b=b||vec3.create();var e=this.getGlobalRotation(u);return vec3.transformQuat(b,a,e)}getGlobalRotation(a){a=a||quat.create();if(!this._parent||!this._parent._transform)return a.set(this._rotation),a;this._parent.getGlobalRotation(a);quat.multiply(a,a,this._rotation);return a}getDistanceTo(a){var b=this.getGlobalMatrix();return vec3.distance(a,b.subarray(12,15))}updateBoundingBox(a){var b=this._global_matrix,e=gl.meshes[this.mesh],
k=null;e&&(k=e.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),k=BBox.transformMat4(this.bounding_box,k,b));if(a||!this.children||0==this.children.length)return k;for(a=0;a<this.children.length;++a)if(b=this.children[a].updateBoundingBox())k?BBox.merge(k,k,b):(k=this.bounding_box=BBox.create(),k.set(b));return k}updateSkinningBones(a){a=a||this;this.skin&&this.mesh&&f.Renderer.collectBones(a,this.skin,gl.meshes[this.mesh]);if(this.children&&this.children.length)for(var b=0;b<
this.children.length;++b)this.children[b].updateSkinningBones(a)}createMaterial(a){a=new f.Material(a);this.material=a.register().name;return a}replaceMaterial(a,b){for(let k=0;k<this.primitives.length;++k){var e=this.primitives[k];e.material===a&&(e.material=b)}this.material===a&&(this.material=b)}getMaterial(a){a=a||0;return this.material?f.Materials[this.material]:this.primitives&&this.primitives.length>a?f.Materials[this.primitives[a].material]:null}setLayerBit(a,b){a=1<<a;this.layers&=~a;b&&
(this.layers|=a)}isInLayerBit(a){return 0!==(this.layers&1<<a)}setRangeFromSubmesh(a){if(null!=a&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(a.constructor===String){for(var e=0;e<b.info.groups.length;++e)if(b.info.groups[e].name==a){a=e;break}if(e===b.info.groups.length)return!1}if(a=b.info.groups[a])this.draw_range[0]=a.start,this.draw_range[1]=a.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null}findNodesInSphere(a,
b,e,k){null==e&&(e=65535);k=k||[];for(var h=0;h<this.children.length;++h){var x=this.children[h];x.layers&e&&(x.getGlobalPosition(v,!0),vec3.distance(v,a)<=b&&k.push(x));x.children.length&&x.findNodesInSphere(a,b,e,k)}return k}}f.SceneNode=t;t["@position"]={type:"vec3"};t["@scaling"]={type:"vec3"};t["@rotation"]={type:"quat"};t.prototype.testRay=function(){var a=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();mat4.create();return function(b,e,k,h,x,y){k=null==k?
Number.MAX_VALUE:k;null==h&&(h=65535);e=e||vec3.create();void 0!==G._ray_tested_objects&&G._ray_tested_objects++;var C=null,B=null;if(!1===this.flags.visible)return null;this.layers&h&&!1!==this.flags.collides&&this.mesh&&(B=this.testRayWithMesh(b,a,k,h,x,y));B&&(y=vec3.distance(b.origin,a),null==k||y<k)&&(k=y,e.set(a),C=this);if(!this.children||!this.children.length)return C;B=vec3.create();for(var F=0,L=this.children.length;F<L;++F){var J=this.children[F].testRay(b,B,k,h,x);J&&(y=vec3.distance(b.origin,
B),y>k||(k=y,e.set(B),C=J))}return C}}();t.prototype.testRayWithMesh=function(){var a=vec3.create(),b=vec3.create(),e=vec3.create(),k=mat4.create(),h=mat4.create();return function(x,y,C,B,F){if(!this.mesh)return!1;var L=gl.meshes[this.mesh];if(!L||!1===L.ready)return!1;var J=null==this.submesh?-1:this.submesh,Q=this.getGlobalMatrix(k,!0),N=L.getBoundingBox(),S=Math.abs(Q[0]+Q[1]+Q[2]),T=Math.abs(Q[4]+Q[5]+Q[6]),Y=Math.abs(Q[8]+Q[9]+Q[10]),R=vec3.length(N.subarray(3,6))*Math.sqrt(S);if(.001>Math.abs(S-
T)&&.001>Math.abs(S-Y)&&!geo.testRaySphere(x.origin,x.direction,vec3.transformMat4(a,N.subarray(0,3),Q),R,void 0,C))return!1;mat4.invert(h,Q);vec3.transformMat4(a,x.origin,h);vec3.add(e,x.origin,x.direction);vec3.transformMat4(e,e,h);vec3.sub(b,e,a);vec3.normalize(b,b);N=this.flags.two_sided;this.primitives&&this.primitives.length&&(S=f.Materials[this.primitives[0].material])&&(N=S.flags.two_sided);return f.testRayMesh(x,a,b,Q,L,J,y,C,B,F,N)}}();t.prototype.testSphere=function(){return function(a,
b,e,k){null==e&&(e=65535);var h=null;if(!1===this.flags.visible)return null;this.layers&e&&!1!==this.flags.collides&&this.mesh&&(h=this.testSphereWithMesh(a,b,e,k));if(h)return this;if(!this.children||!this.children.length)return null;h=0;for(var x=this.children.length;h<x;++h){var y=this.children[h].testSphere(a,b,e,k);if(y)return y}return null}}();t.prototype.testSphereWithMesh=function(){var a=vec3.create();vec3.create();vec3.create();var b=mat4.create(),e=mat4.create();return function(k,h,x,y){if(!this.mesh)return!1;
var C=gl.meshes[this.mesh];if(!C||!1===C.ready)return!1;var B=null==this.submesh?-1:this.submesh,F=this.getGlobalMatrix(b,!0);mat4.invert(e,F);vec3.transformMat4(a,k,e);k=h/vec3.length(F);h=this.flags.two_sided;if(this.primitives&&this.primitives.length){var L=f.Materials[this.primitives[0].material];L&&(h=L.flags.two_sided)}return f.testSphereMesh(a,k,F,C,B,x,y,h)}}();t.prototype.findNearestPointToMesh=function(){var a=mat4.create(),b=mat4.create(),e=vec3.create();return function(k,h,x,y,C){if(!this.mesh)return!1;
var B=gl.meshes[this.mesh];if(!B||!1===B.ready)return Infinity;C?vec3.copy(e,k):(this.getGlobalMatrix(a),mat4.invert(b,a),vec3.transformMat4(e,k,b));B.octree||(B.octree=new GL.Octree(B));k=B.octree.findNearestPoint(e,x,h,y);if(k===h)return k;C||vec3.transformMat4(x,x,a);return k}}();t.prototype.findNearestPointToNode=function(a,b,e,k){var h=null,x=b;this.mesh&&this.flags.collides&&(x=this.findNearestPointToMesh(a,b,e,k),x<b&&(h={node:this,distance:x}));for(let y=0;y<this.children.length;++y)this.children[y].flags.collides&&
(b=this.findNearestPointToNode(a,x,e,k),b.distance<x&&(h=b));return h};f.findNearestPointToNodes=function(a,b,e,k,h){var x=null,y=vec3.create(),C=vec3.create();k=k||vec3.create();h=h||vec3.create();for(let F=0;F<b.length;++F){var B=b[F];B.mesh&&(e=B.findNearestPointToMesh(a,e,y,C),!x||e<x.distance)&&(vec3.copy(k,y),vec3.copy(h,C),x||={node:B,distance:e,position:k,normal:h},x.node=B,x.distance=e)}return x};class q{static $jscomp$static$init$278635194$0$PERSPECTIVE(){return 1}static $jscomp$static$init$278635194$1$ORTHOGRAPHIC(){return 2}constructor(a){this.type=
f.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._inv_viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=
vec3.create();this._right=vec3.create();this._front=vec3.create();this._uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(.1,1E3)};a&&this.fromJSON(a);this.updateMatrices()}}q.PERSPECTIVE=q.$jscomp$static$init$278635194$0$PERSPECTIVE();q.ORTHOGRAPHIC=q.$jscomp$static$init$278635194$1$ORTHOGRAPHIC();f.Camera=q;q.prototype.fromJSON=
function(a){null!=a.type&&(this.type=a.type);a.position&&this._position.set(a.position);a.target&&this._target.set(a.target);a.up&&this._up.set(a.up);a.near&&(this.near=a.near);a.far&&(this.far=a.far);a.fov&&(this.fov=a.fov);a.aspect&&(this.aspect=a.aspect)};q.prototype.toJSON=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};Object.defineProperty(q.prototype,
"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"fov",{get:function(){return this._fov},
set:function(a){this._fov=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(a){this._frustum_size=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"near",{get:function(){return this._near},set:function(a){this._near=
this._uniforms.u_camera_planes[0]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"far",{get:function(){return this._far},set:function(a){this._far=this._uniforms.u_camera_planes[1]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(q.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(a){this._view_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(q.prototype,
"projection_matrix",{get:function(){return this._projection_matrix},set:function(a){this._projection_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(q.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(a){this._viewprojection_matrix.set(a)},enumerable:!1});q.prototype.perspective=function(a,b,e,k){this.type=q.PERSPECTIVE;this._fov=a;this._aspect=b;this._near=e;
this._far=k;this._must_update_matrix=!0};q.prototype.orthographic=function(a,b,e,k){this.type=q.ORTHOGRAPHIC;this._frustum_size=a;1<arguments.lenth&&(this._near=b,this._far=e,this._aspect=k||1);this._must_update_matrix=!0};q.prototype.lookAt=function(a,b,e){this._position==b&&(b=vec3.clone(b));vec3.copy(this._position,a);vec3.copy(this._target,b);vec3.copy(this._up,e);this._must_update_matrix=!0};q.prototype.updateMatrices=function(a){if(this._autoupdate_matrices||a)if(this.type==q.ORTHOGRAPHIC?this.frustum_size.constructor===
Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*m,this._aspect,this._near,
this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up),this.view_texel_grid&&this.type==q.ORTHOGRAPHIC){a=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var b=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/a)*
a;this._view_matrix[13]=Math.floor(this._view_matrix[13]/b)*b}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);mat4.invert(this._inv_viewprojection_matrix,this._viewprojection_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,f.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,f.UP);mat4.rotateVec3(this._front,
this._model_matrix,f.FRONT);this.distance=vec3.distance(this._position,this._target);this._uniforms.u_camera_planes[0]=this._near;this._uniforms.u_camera_planes[1]=this._far};q.prototype.getModel=function(a){a=a||mat4.create();this._must_update_matrix&&this.updateMatrices();mat4.copy(a,this._model_matrix);return a};q.prototype.updateVectors=function(a){var b=vec3.subtract(v,this._target,this._position);b=vec3.length(b);mat4.multiplyVec3(this._position,a,f.ZERO);mat4.multiplyVec3(this._target,a,[0,
0,-b]);mat4.rotateVec3(this._up,a,f.UP)};q.prototype.getLocalVector=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,a)};q.prototype.localToGlobal=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};q.prototype.getLocalPoint=q.prototype.localToGlobal;q.prototype.globalToLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||
vec3.create(),a,this._view_matrix)};q.prototype.globalVectorToLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._view_matrix,a)};q.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this._target,this._position);vec3.normalize(a,a);return a};q.prototype.move=function(a,b){void 0!==b&&(vec3.scale(v,a,b),a=v);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};q.prototype.moveLocal=
function(a,b){this._must_update_matrix&&this.updateMatrices();a=mat4.rotateVec3(v,this._model_matrix,a);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};q.prototype.rotate=function(a,b){a=quat.setAxisAngle(u,b,a);b=vec3.subtract(v,this._target,this._position);vec3.transformQuat(b,b,a);vec3.add(this._target,this._position,b);this._must_update_matrix=!0};q.prototype.rotateLocal=function(a,b){this._must_update_matrix&&
this.updateMatrices();b=mat4.rotateVec3(D,this._model_matrix,b);a=quat.setAxisAngle(u,b,a);b=vec3.subtract(v,this._target,this._position);vec3.transformQuat(b,b,a);vec3.add(this._target,this._position,b);this._must_update_matrix=!0};q.prototype.orbit=function(a,b,e,k){if(!b)throw"RD: orbit axis missing";e=e||this._target;k&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(D,this._model_matrix,b));a=quat.setAxisAngle(u,b,a);b=vec3.subtract(v,this._position,this._target);vec3.transformQuat(b,
b,a);vec3.add(this._position,e,b);this._must_update_matrix=!0};q.prototype.orbitDistanceFactor=function(a,b){b=b||this._target;var e=vec3.subtract(v,this._position,b);vec3.scale(e,e,a);vec3.add(this._position,b,e);this._must_update_matrix=!0};q.prototype.project=function(a,b,e){e=e||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(e,this._viewprojection_matrix,a);e[0]=e[0]*b[2]+b[0];e[1]=e[1]*b[3]+b[1];return e};q.prototype.computeProjectedRadius=
function(a,b,e,k){e=e||gl.viewport_data;if(k)return k=vec4.create(),k.set(a),k[3]=1,a=vec4.transformMat4(k,k,this._viewprojection_matrix),Math.max(1,e[3]*this._projection_matrix[5]*b/a[3]);if(this.type==f.Camera.ORTHOGRAPHIC)return b/(this._frustum_size.constructor===Number?this._frustum_size:1)*e[3]/2;a=vec3.distance(a,this.position);return 0==a?0:1/Math.tan(this.fov/2*Math.PI/180)*b/Math.sqrt(a*a-b*b)*(e[3]/2)};q.prototype.unproject=function(a,b,e){b=b||gl.viewport_data;this._must_update_matrix&&
this.updateMatrices();return vec3.unproject(e||vec3.create(),a,this._viewprojection_matrix,b)};q.prototype.getRay=function(a,b,e,k){if(void 0===a||void 0===b)throw"RD.Camera.getRay requires x and y parameters";e=e||gl.viewport_data;k||=new f.Ray;this._must_update_matrix&&this.updateMatrices();var h=k.origin;vec3.set(h,a,b,0);this.type==f.Camera.ORTHOGRAPHIC?vec3.unproject(h,h,this._viewprojection_matrix,e):vec3.copy(h,this.position);var x=k.direction;vec3.set(x,a,b,1);vec3.unproject(x,x,this._viewprojection_matrix,
e);vec3.sub(x,x,h);vec3.normalize(x,x);return k};q.prototype.getRayPlaneCollision=function(a,b,e,k,h,x){h=h||vec3.create();a=this.getRay(a,b,x);return geo.testRayPlane(a.origin,a.direction,e,k,h)?h:null};q.prototype.getModelForScreenPixel=function(a,b,e,k,h){h=h||mat4.create();a=this.unproject([a,b,-1]);b=vec3.sub(vec3.create(),a,this._position);vec3.normalize(b,b);vec3.scaleAndAdd(a,a,b,e);vec3.normalize(b,b);mat4.fromTranslationFrontTop(h,a,b,this._up);return h};q.controller_keys={forward:"UP",
back:"DOWN",left:"LEFT",right:"RIGHT"};q.prototype.applyController=function(a,b,e,k){e=e||10;if(a){var h=vec3.create();if(gl.keys[q.controller_keys.forward]||k&&gl.keys.W)h[2]=-1;else if(gl.keys[q.controller_keys.back]||k&&gl.keys.S)h[2]=1;if(gl.keys[q.controller_keys.left]||k&&gl.keys.A)h[0]=-1;else if(gl.keys[q.controller_keys.right]||k&&gl.keys.D)h[0]=1;vec3.sqrLen(h)&&this.moveLocal(h,a*e)}b&&(a=b.deltax||b.movementX,b=b.deltay||b.movementY,a&&this.rotate(-.005*a,f.UP),b&&this.rotateLocal(-.005*
b,f.RIGHT))};q.prototype.lerp=function(a,b){vec3.lerp(this._position,this._position,a._position,b);vec3.lerp(this._target,this._target,a._target,b);vec3.lerp(this._up,this._up,a._up,b);this._fov=this._fov*(1-b)+a._fov*b;this._near=this._near*(1-b)+a._near*b;this._far=this._far*(1-b)+a._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+a._frustum_sizer*b);this._must_update_matrix=!0};q.prototype.orientMatrixToCamera=function(a){a.set(this._right,0);a.set(this._top,
4);a.set(this._front,8)};q.prototype.followNode=function(a,b){var e=a.getGlobalPosition();a=a.localToGlobal([0,0,-1]);this.lookAt(e,a,b||[0,1,0])};q.prototype.extractPlanes=function(){function a(k){var h=e.subarray(k,k+3);h=vec3.length(h);h=1/h;e[k]*=h;e[k+1]*=h;e[k+2]*=h;e[k+3]*=h}var b=this._viewprojection_matrix,e=this._planes_data||new Float32Array(24);e.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);a(0);e.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);e.set([b[3]+b[1],b[7]+b[5],
b[11]+b[9],b[15]+b[13]],8);a(8);e.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);e.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);e.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);a(20);this._planes_data=e;this._frustrum_planes||(this._frustrum_planes=[e.subarray(0,4),e.subarray(4,8),e.subarray(8,12),e.subarray(12,16),e.subarray(16,20),e.subarray(20,24)])};var A=f.CLIP_INSIDE=0,H=f.CLIP_OUTSIDE=1,I=f.CLIP_OVERLAP=2;q.prototype.testMesh=function(){if(w.BBox){var a=BBox.create(),
b=a.subarray(0,3),e=a.subarray(3,6);return function(k,h){k=k.bounding;if(!k)return A;BBox.transformMat4(a,k,h);return this.testBox(b,e)}}}();q.prototype.testBBox=function(a){return this.testBox(a,a.subarray(3,6))};q.prototype.testBox=function(a,b){this._frustrum_planes||this.extractPlanes();var e=this._frustrum_planes,k=0;var h=n(e[0],a,b);if(h==H)return H;k+=h;h=n(e[1],a,b);if(h==H)return H;k+=h;h=n(e[2],a,b);if(h==H)return H;k+=h;h=n(e[3],a,b);if(h==H)return H;k+=h;h=n(e[4],a,b);if(h==H)return H;
k+=h;h=n(e[5],a,b);return h==H?H:0==k+h?A:I};q.prototype.testSphere=function(a,b){this._frustrum_planes||this.extractPlanes();var e=this._frustrum_planes,k=!1;var h=z(e[0],a);if(h<-b)return H;h>=-b&&h<=b&&(k=!0);h=z(e[1],a);if(h<-b)return H;h>=-b&&h<=b&&(k=!0);h=z(e[2],a);if(h<-b)return H;h>=-b&&h<=b&&(k=!0);h=z(e[3],a);if(h<-b)return H;h>=-b&&h<=b&&(k=!0);h=z(e[4],a);if(h<-b)return H;h>=-b&&h<=b&&(k=!0);h=z(e[5],a);if(h<-b)return H;h>=-b&&h<=b&&(k=!0);return k?I:A};q.prototype.projectedSphereSize=
function(a,b){var e=mat4.projectVec3(v,this.viewprojection_matrix,a);a=vec3.scaleAndAdd(D,a,this._right,b);mat4.projectVec3(a,this.viewprojection_matrix,a);return vec2.distance(e,a)};q.prototype.computeAproximateScreenSize=function(a){return this.projectedSphereSize(a,a[12])};class G{constructor(){this._root=new f.SceneNode;this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}}f.Scene=G;G.prototype.clear=function(){this._root=
new f.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};G.prototype.add=function(a){this.root.addChild(a)};G.prototype.remove=function(a){this.root.removeChild(a)};G.prototype.getNodeById=function(a){return this._nodes_by_id[a]};G.prototype.findNodesInBBox=function(a,b,e){null==b&&(b=65535);e=e||[];for(var k=0;k<this.nodes.length;++k){var h=this.nodes[k];h.bounding_box&&h.layers&b&&geo.testBBoxBBox(h.bounding_box,a)&&e.push(h)}return e};G.prototype.update=function(a){this.time+=
a;this._root.propagate("update",[a]);this.destroyPendingNodes()};G.prototype.destroyPendingNodes=function(a){if(this._to_destroy.length)for(;a=this._to_destroy.pop();)a._parent&&a._parent.removeChild(a)};Object.defineProperty(G.prototype,"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});G.prototype.testRay=function(a,b,e,k,h){f.Scene._ray_tested_objects=0;b||(b=a.collision_point);null==h&&(h=!0);return this.root.testRay(a,b,e,null==k?65535:
k,h)};G.prototype.testSphere=function(a,b,e,k){null==k&&(k=!0);return this.root.testSphere(a,b,null==e?65535:e,k)};G.prototype.gatherObjects=function(a,b,e){e=e||[];a.updateGlobalMatrix(!0);if(a.mesh&&b&a.layers&&!a.skeleton){if(a.primitives&&a.primitives.length)for(var k=0;k<a.primitives.length;++k){var h=a.primitives[k];(this.overwrite_material||f.Materials[h.material])&&e.push([a,a._global_matrix,a.mesh,k,a.material])}}else e.push([a,a._global_matrix,a.mesh,-1,a.material]);for(k=0;k<a.children.length;++k)this.gatherObjects(a.children[k],
b,e);return e};f.testRayWithNodes=function(a,b,e,k,h,x,y){f.testRayWithNodes.coll_node=null;k=null==k?Number.MAX_VALUE:k;h=null==h?65535:h;f.Scene._ray_tested_objects=0;e||(e=a.collision_point);f.testRayWithNodes.local_result||(f.testRayWithNodes.local_result=vec3.create());for(var C=f.testRayWithNodes.local_result,B=null,F=0;F<b.length;++F){var L=b[F],J=L.testRay(a,C,k,h,x);if(J){var Q=vec3.distance(a.origin,C);Q>k||(k=Q,e.set(C),f.testRayWithNodes.coll_node=J,B=y?J:L)}}return B};f.last_hit_test=
null;f.testRayMesh=function(a,b,e,k,h,x,y,C,B,F,L){C=null==C?Number.MAX_VALUE:C;-1==x?(B=h.getBoundingBox(),x=h):(x=h.info.groups[x],B=x.bounding,B||(h.computeGroupsBoundingBoxes(),B=x.bounding));if(!B)return!1;C||=1E7;if(!geo.testRayBBox(b,e,B,null,v))return!1;vec3.transformMat4(y,v,k);B=vec3.distance(a.origin,y);if(B>C)return!1;if(!F)return!0;x._octree||(x._octree=x==h?new GL.Octree(h):new GL.Octree(h,x.start,x.length));b=x._octree.testRay(b,e,0,C,L);if(!b)return!1;f.last_hit_test=b;y.set(b.hit);
vec3.transformMat4(y,y,k);B=vec3.distance(a.origin,y);return B>C?!1:!0};f.testSphereMesh=function(a,b,e,k,h,x,y){-1==h?(e=k.getBoundingBox(),h=k):(h=k.info.groups[h],e=h.bounding,e||(k.computeGroupsBoundingBoxes(),e=h.bounding));if(!e||!geo.testSphereBBox(a,b,e))return!1;if(!y)return!0;h._octree||(h._octree=h==k?new GL.Octree(k):new GL.Octree(k,h.start,h.length));return h._octree.testSphere(a,b)?!0:!1};G.prototype.fromJSON=function(a){this.root.clear();this.root.fromJSON(a)};G.prototype.toJSON=function(a){function b(h,
x){if(a){if(!a(h,x))return!1}else{if(!h.flags.no_transform){x.position=typedArrayToArray(h.position);if(0!=h.rotation[0]||0!=h.rotation[1]||0!=h.rotation[2]||1!=h.rotation[3])x.rotation=typedArrayToArray(h.rotation);if(1!=h.scaling[0]||1!=h.scaling[1]||1!=h.scaling[2])x.scaling=typedArrayToArray(h.scaling)}h.id&&(x.id=h.id);h.ref=x.ref=e++;h.mesh&&(x.mesh=h.mesh);null!=h.submesh&&(x.submesh=h.submesh);h.draw_range&&(x.draw_range=h.draw_range.concat());h.material&&(x.material=h.material);h.extra&&
(x.extra=h.extra);x.layers=h.layers;x.flags=h.flags}if(!h.children.length)return!0;for(var y=[],C=0;C<h.children.length;++C){var B={};b(h.children[C],B)&&y.push(B)}y.length&&(x.children=y);return!0}a&&a.constructor!==Function&&(a=null);var e=0,k={};b(this.root,k);return k};var M={u_model:null};class P{static $jscomp$static$init$278635194$2$last_material_id(){return 0}constructor(a){this._color=vec4.fromValues(1,1,1,1);this._emissive=vec3.fromValues(0,0,0);this.shader_name=null;this.uniforms={};this.textures=
{};this.primitive=-1;this.blend_mode=f.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};a&&this.fromJSON(a)}set color(a){this._color.set(a)}get color(){return this._color}set albedo(a){this._color.set(a)}get albedo(){return this._color}set emissive(a){this._emissive.set(a)}get emissive(){return this._emissive}set opacity(a){this._color[3]=a}get opacity(){return this._color[3]}set two_sided(a){this.flags.two_sided=a}get two_sided(){return this.flags.two_sided}register(a){a||=this.name||
f.makeHash(32);this.name=a;f.Materials[this.name]=this;return this}setUVTransform(a,b,e,k,h){this.uv_transform||(this.uv_transform=mat3.create());var x=mat3.identity(this.uv_transform);mat3.translate(x,x,[a,h?1-b:b]);mat3.scale(x,x,[e,k])}fromJSON(a){for(var b in a){var e=a[b];if(e)if("name"===b)this.register(e);else if("material"===b&&e)e.constructor===Object?(e=new f.Material(e),this.register(),e=e.name):e.constructor===f.Material&&(this.register(),e=e.name);else if("texture"===b){this.textures.color=
e;continue}else e.constructor===Object?e=structuredClone(e):e.constructor===Array?e=structuredClone(e):e.constructor===Float32Array&&(e=new Float32Array(e));this[b]=e}}toJSON(){var a={flags:structuredClone(this.flags),textures:structuredClone(this.textures)};a.color=Array.from(this._color);this.name&&(a.name=this.name);this.alphaMode&&(a.alphaMode=this.alphaMode);this.blendMode&&(a.blendMode=this.blendMode);.5!=this.alphaCutoff&&(a.alphaCutoff=this.alphaCutoff);this.uv_transform&&(a.uv_transform=
Array.from(this.uv_transform));this.normalFactor&&(a.normalFactor=this.normalFactor);this.displacementFactor&&(a.displacementFactor=this.displacementFactor);this.backface_color&&(a.backface_color=Array.from(this.backface_color));this.emissive&&(a.emissive=Array.from(this.emissive));this.model&&(a.model=this.model,a.metallicFactor=this.metallicFactor,a.roughnessFactor=this.roughnessFactor);return a}}P.last_material_id=P.$jscomp$static$init$278635194$2$last_material_id();f.Material=P;f.SPOT_LIGHT=1;
f.POINT_LIGHT=2;f.DIRECTIONAL_LIGHT=3;class O extends f.SceneNode{static $jscomp$static$init$278635194$3$DEFAULT_SHADOWMAP_RESOLUTION(){return 2048}constructor(){super();this.intensity=1;this.area=10;this.cast_shadows=!1;this.max_distance=10;this.light_type=f.SPOT_LIGHT;this.cone_start=30;this.cone_end=45;this._shadowmap_index=-1;this._color=vec3.fromValues(.9,.9,.9);this._center=vec3.create();this._front=vec3.create()}set color(a){this._color.set(a)}get color(){return this._color}followCamera(a,
b){var e=b||5;b=vec3.scaleAndAdd(vec3.create(),a.target,this._vector,-b);this.lookAt(b,a.target,a.up);this.camera.orthographic(e,.01,3*e,1);this.camera.updateMatrices()}insideCamera(a){if(this.light_type===f.DIRECTIONAL_LIGHT)return!0;var b=this.getGlobalPosition();return a.testSphere(b,this.max_distance)!==H}overlaps(a){return this.light_type===f.DIRECTIONAL_LIGHT||a.skin||geo.testSphereBBox(this._center,this.max_distance,a.bounding)!==f.CLIP_OUTSIDE}}O.DEFAULT_SHADOWMAP_RESOLUTION=O.$jscomp$static$init$278635194$3$DEFAULT_SHADOWMAP_RESOLUTION();
f.Light=O;class U{constructor(){this.height=this.width=0;this.layers=255;this.textures={};this.fbos={}}}f.View=U;class K{set color(a){this._color.set(a)}get color(){return this._color}set ambient_light(a){this._ambient_light.set(a)}get ambient_light(){return this._ambient_light}set light_vector(a){this._light_vector.set(a)}get light_vector(){return this._light_vector}set light_color(a){this._light_color.set(a)}get light_color(){return this._light_color}set fog_color(a){this._fog_uniforms.u_fog_color.set([a[0],
a[1],a[2]])}get fog_color(){return this._fog_uniforms.u_fog_color.subarray(0,3)}set fog_density(a){this._fog_uniforms.u_fog_color[3]=a}get fog_density(){return this._fog_uniforms.u_fog_color[3]}constructor(a,b){this._color=vec4.fromValues(1,1,1,1);this._ambient_light=vec3.fromValues(.9,.9,.9);this._light_color=vec3.fromValues(.1,.1,.1);this._light_vector=vec3.fromValues(.5442,.6385,.544);this._main_view=new U;this._features={};var e=null;b||a.constructor!==Object||(b=a,a=null);b=b||{};a||(a=document.createElement("canvas"),
a.width=b.width||document.body.offsetWidth,a.height=b.height||document.body.offsetHeight);var k=this.gl=this.context=e=a.constructor===HTMLCanvasElement?GL.create({canvas:a,version:2,alpha:b.alpha}):a;if(!k||!k.enable)throw"litegl GL context not found.";e!=w.gl&&k.makeCurrent();this.assets_folder="";this.use_fog=this.use_flat_normal=this.use_alpha_hash=!1;this.small_objects_ratio_threshold=0;this.layers_affect_children=!1;this.force_update_bones=this.allow_skinning=this.allow_morphtargets=this.allow_instancing=
!0;this.point_size=1;this.disable_cull_face=this.reverse_normals=!1;this._model_matrix=mat4.create();this._mvp_matrix=mat4.create();this._texture_matrix=mat3.create();this.renderables=[];this.renderables_pool=[];this.rendered_renderables=this.used_renderables=0;this.outline_renderables=[];this.morph_textures=new Map;this.lights=[];this._nodes=[];this._uniforms={u_model:this._model_matrix,u_global_alpha_clip:0,u_point_size:this.point_size,u_res:new Float32Array([1,1,1,1])};this._lights_uniforms={u_num_lights:0,
u_light_color:new Float32Array(16),u_light_position:new Float32Array(16),u_light_front:new Float32Array(16),u_light_params:new Float32Array(16)};this._fog_uniforms={u_fog_color:new Float32Array([.5,.5,.5,1])};this.global_uniforms_containers=[this._uniforms];this.outline_color=[1,1,1,1];this._phong_uniforms={u_ambient:this._ambient_light,u_sun_light_vector:this._light_vector,u_sun_light_color:this._light_color};w.gl=this.gl;this.canvas=k.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=
void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:k.REPEAT,minFilter:k.LINEAR_MIPMAP_LINEAR,magFilter:k.LINEAR};this.default_cubemap_settings={minFilter:k.LINEAR_MIPMAP_LINEAR,magFilter:k.LINEAR,is_cross:1};this.default_material=new f.Material;this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=
GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:k.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:k.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.textures.bayer8x8=this._bayer_texture=new GL.Texture(8,8,{format:GL.LUMINANCE,pixel_data:new Uint8Array([0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,
30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21])});this._bayer_texture.setParameter(GL.TEXTURE_MAG_FILTER,k.NEAREST);this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.frame=0;this.stats={draw_calls:0,updated_shadowmaps:0};this.supports_instancing=k.extensions.ANGLE_instanced_arrays||1<k.webgl_version;this.createShaders();this.pipelineShader=new f.UberShader(K.getMasterVertexShader,K.getMasterFragmentShader);b.shaders_file&&this.loadShaders(b.shaders_file,
null,b.shaders_macros);Object.keys(k.constructor).filter(h=>"MAX_"===h.substr(0,4)).forEach(h=>this._features[h]=k.getParameter(k[h]))}}f.Renderer=K;K.prototype.setDataFolder=function(a){a?(this.assets_folder=a,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};K.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],3<=a.length?a[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};K.prototype.destroy=function(){gl.destroy();
f.Materials={}};K.prototype.render=function(a,b,e,k,h,x){null==k&&(k=65535);if(!a)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";b=b||a.camera;if(!b)throw"Renderer.render: camera not provided";w.gl=this.gl;this._nodes.length=0;e||a._root.getVisibleChildren(this._nodes,k,this.layers_affect_children);e=e||this._nodes;for(var y=0;y<e.length;++y)e[y].preRender&&e[y].preRender();y=this.getAllRenderables(e,
k,b);this._state=[];this._meshes_missing=0;this.resetStats();this._current_scene=a;this._uniforms.u_time=a.time;vec3.normalize(this._light_vector,this._light_vector);h=h||this.pipeline;e=y.filter(C=>C.flags&Z||b.testBBox(C.bounding)!==f.CLIP_OUTSIDE);0<this.small_objects_ratio_threshold&&(e=e.filter(C=>C.flags&Z||b.computeAproximateScreenSize(C.bounding)>this.small_objects_ratio_threshold));e=e.sort((C,B)=>C.material.blend_mode-B.material.blend_mode);k=this.lights.filter(C=>C.insideCamera(b)&&(!this.small_objects_ratio_threshold||
b.projectedSphereSize(C._center,C.max_distance)>this.small_objects_ratio_threshold));this.updateShadowmaps(k,y,e);this.enableCamera(b);this._uniforms.u_res[0]=gl.viewport_data[2];this._uniforms.u_res[1]=gl.viewport_data[3];this._uniforms.u_res[2]=1/gl.viewport_data[2];this._uniforms.u_res[3]=1/gl.viewport_data[3];this._uniforms.u_point_size=this.point_size;if(h)h.render(this,e,k,b,a,x);else for(this.allow_instancing&&this.supports_instancing&&(e=this.groupRenderablesForInstancing(e)),this.skybox_texture&&
this.renderSkybox(b,this.skybox_texture),y=0;y<e.length;++y)h=e[y],h.node.flags.was_rendered=!0,this.renderRenderable(h,k);this.outline_renderables.length&&this.renderOutline(this.outline_renderables,b);if(this.onPostRender)this.onPostRender(b);a.frame++;this.frame++;this._current_scene=null};K.prototype.renderRenderable=function(a,b){if(a.material.render)return a.material.render(this,a,b);this.rendering_only_depth||(b=b.filter(R=>R.overlaps(a)));var e=a.mesh,k=a.node,h=a.skin,x=this._camera,y=a.material,
C=a.primitive;if(null==C||-1==C)C=gl.TRIANGLES;var B=!1;if(b.length&&!this.rendering_only_depth)for(var F=this._lights_uniforms.u_num_lights=Math.min(b.length,4),L=0;L<F;++L){var J=b[L];this._lights_uniforms.u_light_color[4*L]=J.color[0]*J.intensity;this._lights_uniforms.u_light_color[4*L+1]=J.color[1]*J.intensity;this._lights_uniforms.u_light_color[4*L+2]=J.color[2]*J.intensity;this._lights_uniforms.u_light_color[4*L+3]=J.light_type;J.light_type!==f.DIRECTIONAL_LIGHT&&(this._lights_uniforms.u_light_position.set(J._center,
4*L),this._lights_uniforms.u_light_position[4*L+3]=J.max_distance);this._lights_uniforms.u_light_front.set(J._front,4*L);this._lights_uniforms.u_light_params[4*L]=Math.cos(J.cone_start*m*.5);this._lights_uniforms.u_light_params[4*L+1]=Math.cos(J.cone_end*m*.5);this._lights_uniforms.u_light_params[4*L+2]=J._shadowmap_index;-1!==J._shadowmap_index&&(J=this.shadows_info.shadows[J._shadowmap_index],this.shadows_info.uniforms.u_shadowmap_rect.set(J.rect,4*L),this.shadows_info.uniforms.u_shadowmap_vps.set(J.vp,
16*L),B|=1)}F=null;J=0;if(this.on_getShader){if(F=this.on_getShader(a.node,x),!F)return}else if(F=this.shader_overwrite||y.shader_name){if(F=gl.shaders[F],!F)return}else h&&(J|=r.SKINNING),a.morphs&&(J|=r.MORPHTARGETS),a.instances&&this.supports_instancing&&(J|=r.INSTANCING),this.rendering_only_depth||(C!==GL.TRIANGLES&&C!==GL.TRIANGLE_STRIP&&C!==GL.TRIANGLE_FAN&&(J|=r.NO_TRIANGLES),!this.use_alpha_hash||0==y.blend_mode&&"BLEND"!==y.alphaMode||(J|=r.ALPHA_HASH),this.use_flat_normal&&(J|=r.FLAT_NORMAL),
this.use_secondary_buffer&&(J|=r.SECOND_BUFFER),this.rendering_flat?J|=r.FLAT_COLOR:(this.use_fog&&(J|=r.FOG),e.vertexBuffers.colors&&(J|=r.COLOR),e.vertexBuffers.coords1&&(J|=r.COORD1),y.textures.color&&(J|=r.TEXTURE),y.textures.albedo&&(J|=r.ALBEDO),y.textures.emissive&&(J|=r.EMISSIVE),y.textures.occlusion&&(y.textures.metallicRoughness&&y.textures.metallicRoughness.texture===y.textures.occlusion.texture||(J|=r.OCCLUSION)),y.uv_transform&&(J|=r.UV_TRANSFORM),"unlit"===y.model&&(J|=r.UNLIT),b.length&&
(J|=r.LIGHTS,B&&(J|=r.SHADOWS)))),F=this.pipelineShader.getShader(J);var Q=!1;a.instances&&this.supports_instancing&&(Q=!0);Q&&!F.attributes.u_model&&(Q=!1);var N=0,S=null;for(L in y.textures){var T=y.textures[L];if(T){T.constructor===Object&&(T=T.texture);var Y="u_"+L+"_texture";if(!F||F.samplers[Y])S=gl.textures[T],S||(this.autoload_assets&&-1!=T.indexOf(".")&&this.loadTexture(T,this.default_texture_settings),S=gl.textures.white),T=N++,y.uniforms[Y]=S.bind(T)}}S||(F.samplers.u_albedo_texture||F.samplers.u_color_texture)&&
gl.textures.white.bind(0);this.enableItemFlags(y);h&&F.uniformInfo.u_bones&&(h.constructor===f.Skeleton?(this.bones=h.computeFinalBoneMatrices(this.bones,e),F.setUniform("u_bones",this.bones)):h._bone_matrices&&F.setUniform("u_bones",h._bone_matrices));this._uniforms.u_global_alpha_clip=null!=y.alphaCutoff&&"MASK"==y.alphaMode?y.alphaCutoff:-1;this._uniforms.u_model.set(a.model);F.uniforms(this._uniforms);b.length&&F.uniforms(this._lights_uniforms);F.uniforms(x._uniforms);J&r.FOG&&F.uniforms(this._fog_uniforms);
F.uniforms(this._phong_uniforms);F.setUniform("u_color",y._color);F.setUniform("u_emissive",y._emissive);y.uv_transform&&F.setUniform("u_uvtransform",y.uv_transform);F.uniforms(y.uniforms);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,F,k);F.hasUniform("u_bayer_texture")&&F.uniforms({u_bayer_texture:this._bayer_texture.bind(N++)});a.morphs&&F.uniforms({u_morph_texture:a.morphs.bind(N++)});B&&(this.shadows_info.texture.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST),this.shadows_info.texture.setParameter(gl.TEXTURE_MIN_FILTER,
gl.NEAREST),this.shadows_info.uniforms.u_shadowmap=this.shadows_info.texture.bind(N++),F.uniforms(this.shadows_info.uniforms));b=null;null!=a.group_index&&e.info&&e.info.groups&&e.info.groups[a.group_index]&&(b=e.info.groups[a.group_index]);if(Q)M.u_model=a.instances,b?F.drawInstanced(e,C,a.index_buffer_name,M,b.start,b.length):k.draw_range?F.drawInstanced(e,C,a.index_buffer_name,M,a.draw_range[0],a.draw_range[1]):F.drawInstanced(e,C,a.index_buffer_name,M);else if(a.instances){for(L=0;L<a.instances.length;L++)F.setUniform("u_model",
a.instances[L]),b?F.drawRange(e,C,b.start,b.length,a.index_buffer_name):a.draw_range?F.drawRange(e,C,a.index_buffer_name,a.draw_range[0],a.draw_range[1]):F.draw(e,C,a.index_buffer_name),this.stats.draw_calls+=1;this.stats.draw_calls--}else b?F.drawRange(e,C,b.start,b.length,a.index_buffer_name):a.draw_range?F.drawRange(e,C,a.index_buffer_name,a.draw_range[0],a.draw_range[1]):F.draw(e,C,a.index_buffer_name);this.disableItemFlags(y);this.stats.draw_calls+=1};K.shader_snippets={testShadowmap:"\n\tuniform vec4 u_shadowmap_rect[4];\n\tuniform mat4 u_shadowmap_vps[4];\n\tuniform sampler2D u_shadowmap;\n\n\tfloat testShadowmap( vec3 pos, vec4 rect, mat4 vp )\n\t{\n\t\tconst float bias = 0.004;\n\t\tvec4 proj = vp * vec4(pos, 1.0);\n\t\tvec2 shadowSample = (proj.xy / proj.w) * vec2(0.5) + vec2(0.5);\n\t\tif(shadowSample.x >= 0.0 && shadowSample.x <= 1.0 && shadowSample.y >= 0.0 && shadowSample.y <= 1.0 )\n\t\t{\n\t\t\tshadowSample = remap( shadowSample, vec2(0.0), vec2(1.0), rect.xy, rect.zw );\n\t\t\t#ifdef WEBGL1\n\t\t\tfloat depth = texture2D( u_shadowmap, shadowSample).x;\n\t\t\t#else\n\t\t\tfloat depth = texture( u_shadowmap, shadowSample).x;\n\t\t\t#endif\n\t\t\tif( depth > 0.0 && depth < 1.0 && depth <= ( ((proj.z-bias) / proj.w) * 0.5 + 0.5) )\n\t\t\t\treturn 0.0;\n\t\t}\n\t\treturn 1.0;\n\t}\n\t",
fog_code:"\n\t\t//float normalized_depth = linearize_depth(gl_FragCoord.z);//(gl_FragCoord.z * gl_FragCoord.w);\n\t\tfloat fog_factor = length( u_camera_position - v_pos ) / u_camera_planes.y;\n\t\tcolor.xyz = mix(color.xyz, u_fog_color.xyz, pow( fog_factor, 1.0 / u_fog_color.w ));\n\t",skinning:"\n\t#ifdef WEBGL1\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\t#else\n\tin vec4 a_bone_indices;\n\tin vec4 a_weights;\n\t#endif\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n\t",
modify_ndotl:"",modify_attenuation:"",modify_prelight_equation:"",modify_light_equation:"",modify_color:"",modify_emissive:"",custom_uniforms:""};K.getMasterVertexShader=function(a){return`#version 300 es
precision highp float;
in vec3 a_vertex;
#ifndef FLAT_NORMAL
	in vec3 a_normal;
#endif
in vec2 a_coord;
#ifdef COORD1
	in vec2 a_coord1;
	out vec2 v_coord1;
#endif
out vec3 v_pos;
out vec3 v_normal;
out vec2 v_coord;
#ifdef COLOR
	in vec4 a_color;
	out vec4 v_color;
#endif

${a&r.SKINNING?K.shader_snippets.skinning:""}

#ifdef MORPHTARGETS
	uniform sampler2D u_morph_texture;
#endif

#ifdef INSTANCING
	in mat4 u_model;
#else
	uniform mat4 u_model;
#endif
uniform mat4 u_viewprojection;
uniform float u_point_size;

#ifdef UV_TRANSFORM
uniform mat3 u_uvtransform;
#endif

void main() {
	v_pos = a_vertex;

	${a&r.MORPHTARGETS?"v_pos += texelFetch(u_morph_texture,ivec2(gl_VertexID,1),0).xyz;":""}
	
	${a&r.SKINNING?"computeSkinning(v_pos,v_normal);":""}

	v_pos = (u_model * vec4(v_pos,1.0)).xyz;
	#ifndef FLAT_NORMAL
	v_normal = a_normal;
	${a&r.MORPHTARGETS?"v_normal += texelFetch(u_morph_texture,ivec2(gl_VertexID,0),0).xyz;":""}
	v_normal = (u_model * vec4(v_normal,0.0)).xyz;
	#endif
	v_coord = a_coord;
	#ifdef UV_TRANSFORM
		v_coord = (u_uvtransform * vec3(v_coord,1.0)).xy;
	#endif

	#ifdef COORD1
		v_coord1 = a_coord1;
	#endif
	#ifdef COLOR
	v_color = a_color;
	#endif
	gl_Position = u_viewprojection * vec4( v_pos, 1.0 );
	gl_PointSize = u_point_size;
}
`};K.getMasterFragmentShader=function(){return`#version 300 es
	
	precision highp float;
	in vec3 v_pos;
	in vec2 v_coord;
	in vec3 v_normal;
	#ifdef COLOR
	in vec4 v_color;
	#endif
	#ifdef COORD1
		in vec2 v_coord1;
	#else
		vec2 v_coord1;
	#endif	

	//material
	uniform vec4 u_color;
	uniform vec3 u_emissive;
	#ifdef TEXTURE
		uniform sampler2D u_color_texture;
	#endif
	#ifdef ALBEDO
		uniform sampler2D u_albedo_texture;
	#endif
	#ifdef EMISSIVE
		uniform sampler2D u_emissive_texture;
	#endif
	#ifdef OCCLUSION
		uniform sampler2D u_occlusion_texture;
	#endif
	uniform float u_global_alpha_clip;

	//globals
	uniform vec3 u_ambient;
	uniform vec3 u_sun_light_vector;
	uniform vec3 u_sun_light_color;

	#ifdef FOG
		uniform vec4 u_fog_color;
	#endif

	vec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }	

	#ifdef LIGHTS
		uniform int u_num_lights;
		uniform vec4 u_light_color[4]; //color, type
		uniform vec4 u_light_position[4]; //pos or vector, max_dist
		uniform vec4 u_light_front[4]; //front, 
		uniform vec4 u_light_params[4]; //cos cone start, cos cone end, shadowmap index, ?
	#endif

	#ifdef SHADOWS
	${K.shader_snippets.testShadowmap}
	#endif

	uniform sampler2D u_bayer_texture;
	float bayer8x8() {
		int x = int(mod(gl_FragCoord.x, 8.0));
		int y = int(mod(gl_FragCoord.y, 8.0));
		return texture( u_bayer_texture, vec2(float(x)/8.0,float(y)/8.0)).x * 4.0;
	}

	uniform vec4 u_res;
	uniform vec3 u_camera_position;
	uniform vec2 u_camera_planes;

	float linearize_depth(float d)
	{
		float z_n = 2.0 * d - 1.0;
		return 2.0 * u_camera_planes.x * u_camera_planes.y / (u_camera_planes.y + u_camera_planes.x - z_n * (u_camera_planes.y - u_camera_planes.x));
	}

	${K.shader_snippets.custom_uniforms}

	out vec4 FragColor;

	void main() {
		vec4 color = u_color;
		#ifdef FLAT_COLOR
			FragColor = color;
			return;
		#endif

		#ifndef COORD1
			v_coord1 = v_coord;
		#endif		
		#ifdef ALBEDO
			color *= texture(u_albedo_texture, v_coord);
		#endif
		#ifdef TEXTURE
			color *= texture(u_color_texture, v_coord);
		#endif
		#ifdef COLOR
			color *= v_color;
		#endif
		if(color.a <= u_global_alpha_clip)
			discard;
		#ifdef ALPHA_HASH
		if(color.a < bayer8x8())
			discard;
		#endif

		#ifdef FLAT_NORMAL
			vec3 A = dFdx(v_pos);
			vec3 B = dFdy(v_pos);
			vec3 N = normalize(cross(A,B));
		#else
			vec3 N = normalize(v_normal);
		#endif

		#ifdef NO_TRIANGLES
			N = normalize(v_pos - u_camera_position);
		#endif

		float NdotL = (dot(N,u_sun_light_vector)*0.5 + 0.5);
		#ifdef UNLIT
			NdotL = 1.0;
		#endif
		vec3 total_light = u_ambient + u_sun_light_color * NdotL;
		#ifdef OCCLUSION
			total_light = texture(u_occlusion_texture, v_coord1).xyz;
		#endif
		#ifdef LIGHTS
		for(int i = 0; i < 4; ++i)
		{
			if(i > u_num_lights)
				break;
			vec3 L = u_light_position[i].xyz - v_pos;
			int light_type = int(u_light_color[i].w);
			float att = 1.0;
			if( light_type == 3 ) //directional
			{
				L = -u_light_front[i].xyz;
			}
			else //spot and point
			{
				float light_dist = length(L);
				if(light_dist > u_light_position[i].w)
					continue;
				L /= light_dist;
				att = max(0.0,(u_light_position[i].w - light_dist) / u_light_position[i].w);
			}
			NdotL = max( 0.0, dot( N, L ) );
			#ifdef UNLIT
				NdotL = 1.0;
			#endif
			${K.shader_snippets.modify_ndotl}
			
			if( light_type == 1 ) //spot
			{
				float cos_angle = dot( u_light_front[i].xyz, -L );
				if(cos_angle < u_light_params[i].y )
					att = 0.0;
				else if (cos_angle < u_light_params[i].x )
					att *= 1.0 - (cos_angle - u_light_params[i].x) / (u_light_params[i].y - u_light_params[i].x);
			}

			${K.shader_snippets.modify_attenuation}

			#ifdef SHADOWS
				if ( u_light_params[i].z != -1.0 && (NdotL*att) > 0.0) //has shadowmap
				{
					att *= testShadowmap( v_pos, u_shadowmap_rect[ i ], u_shadowmap_vps[ i ] );
				}
			#endif

			${K.shader_snippets.modify_prelight_equation}
			vec3 light = u_light_color[i].xyz * att * NdotL;
			${K.shader_snippets.modify_light_equation}
			total_light += light;
		}
		#endif

		color.xyz *= total_light;
		vec3 emissive = u_emissive;
		#ifdef EMISSIVE
			emissive *= texture(u_emissive_texture, v_coord).xyz;
		#endif

		${K.shader_snippets.modify_emissive}
		color.xyz += emissive;

		#ifdef FOG
			${K.shader_snippets.fog_code}
		#endif

		${K.shader_snippets.modify_color}

		FragColor = color;
		#ifdef SECOND_BUFFER
		#endif
	}
	`};K.prototype.clearMorphTargets=function(){this.morph_textures.forEach(a=>a.delete());this.morph_textures.clear()};K.prototype.computeMorphTargets=function(a){if(a.morphs.length){var b=gl.meshes[a.mesh];if(!b.morphs)return null;var e=b.getBuffer("vertices").data.length/3;if(e>this._features.MAX_TEXTURE_SIZE)return null;var k=this.morph_textures.get(b);k||(k=new GL.Texture(e,2,{type:GL.HALF_FLOAT,format:GL.RGBA,filter:GL.NEAREST,wrap:GL.CLAMP_TO_EDGE}),this.morph_textures.set(b,k));var h=GL.Shader.getColoredScreenShader(),
x=0;for(let F=0;F<a.morphs.length;++F){var y=a.morphs[F];if(!(.001>=Math.abs(y.weight)||isNaN(y.weight))){x+=Math.abs(y.weight);y=b.morphs[F].buffers.vertices;var C=b.morphs[F].buffers.normals,B=this.morph_textures.get(y);B||(B=new Float32Array(2*y.length),B.set(y,0),C&&B.set(C,y.length),B=new GL.Texture(e,2,{type:GL.FLOAT,format:GL.RGB,pixel_data:B,filter:GL.NEAREST,wrap:GL.CLAMP_TO_EDGE}),this.morph_textures.set(y,B))}}if(.001>x)return null;k.drawTo(()=>{gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);
gl.disable(GL.DEPTH_TEST);gl.enable(GL.BLEND);gl.blendFunc(GL.SRC_ALPHA,GL.ONE);for(let J=0;J<a.morphs.length;++J){var F=a.morphs[J];if(!(.001>=Math.abs(F.weight))){var L=this.morph_textures.get(b.morphs[J].buffers.vertices);L&&L.toViewport(h,{u_color:[1,1,1,F.weight]})}}});return k}};K.prototype.enableCamera=function(a){this._camera=a;a.updateMatrices();a.extractPlanes()};K.prototype.renderSkybox=function(a,b){var e=this._skybox_shader,k=gl.meshes.cube,h=gl.textures[b];h?(b=this._model_matrix,mat4.identity(b),
gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),mat4.setTranslation(b,a.position),a=.5*a.far+.5*a.near,mat4.scale(b,b,[a,a,a]),this.renderMesh(b,k,h,[1,1,1,1],e)):this.autoload_assets&&-1!=b.indexOf(".")&&this.loadTexture(b,renderer.default_texture_settings)};K.prototype.renderOutline=function(a,b){b=gl.viewport_data[2];var e=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==b&&this._selection_buffer.height==e||(this._selection_buffer=new GL.Texture(b,e,{magFilter:gl.NEAREST}));
K.outline_material||(K.outline_material=new f.Material);gl.disable(gl.SCISSOR_TEST);this._selection_buffer.drawTo(()=>{gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var h=this.onNodeShaderUniforms;this.onNodeShaderUniforms=function(y,C){C.setUniform("u_color",[1,1,1,1])};var x=this.pipeline;this.pipeline=null;this.overwrite_material=f.Renderer.outline_material;this.rendering_flat=!0;for(let y=0;y<a.length;++y)this.renderRenderable(a[y],[]);this.shader_overwrite=null;this.onNodeShaderUniforms=
h;this.rendering_flat=!1;this.pipeline=x;this.overwrite_material=null});var k=gl.shaders.outline;k||=gl.shaders.outline=GL.Shader.createFX("\n\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\t"+(this.outline_diagonals?"\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\t":
"\n\t\t\tvec3 outline = vec3( abs(color.x - colorU.x) + abs(color.x - colorL.x) > 0.0 ? 1.0 : 0.0);\n\t\t\t")+"\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t","uniform vec2 u_res;\n");gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(k,{u_color:this.outline_color,u_res:[1/b,1/e]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)};K.prototype.setGlobalUniforms=function(a){for(var b in a)this._uniforms[b]&&
this._uniforms[b].set?this._uniforms[b].set(a[b]):this._uniforms[b]=a[b]};K.prototype.updateShadowmaps=function(a,b,e){a.forEach(F=>F._shadowmap_index=-1);a=a.filter(F=>F.cast_shadows&&F.light_type!==f.POINT_LIGHT);if(0!=a.length){this.shadows_info||(e=new GL.Texture(2048,2048,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadows_info={num_shadows:0,texture:e,fbo:new GL.FBO(null,e),uniforms:{u_shadowmap:0,u_shadowmap_rect:new Float32Array(16),u_shadowmap_vps:new Float32Array(64)},
shadows:[]});this.shadows_info.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);this.shadow_camera||(this.shadow_camera=new q);var k=this.shadow_camera;this.rendering_only_depth=!0;for(e=0;e<a.length;++e){var h=a[e],x=e%2*1024,y=1024*Math.floor(e/2);gl.viewport(x,y,1024,1024);h.light_type===f.SPOT_LIGHT?k.perspective(h.cone_end,1,.1,h.max_distance):k.orthographic(h.area,.1,h.max_distance,1);k.lookAt(h.getGlobalPosition(),h.localToGlobal([0,0,-1]),[0,1,0]);this.enableCamera(k);gl.enable(gl.DEPTH_TEST);var C=
b.filter(F=>F.instances||F.skin||k.testMesh(F.mesh,F.model)!==f.CLIP_OUTSIDE);C=this.groupRenderablesForInstancing(C);for(var B=0;B<C.length;++B)this.renderRenderable(C[B],[]);h._shadowmap_index=e;(h=this.shadows_info.shadows[e])||(h=this.shadows_info.shadows[e]={rect:vec4.create(),vp:mat4.create()});h.rect.set([x/2048,y/2048,(x+1024)/2048,(y+1024)/2048]);h.vp.set(k._viewprojection_matrix);this.stats.updated_shadowmaps++}this.shadows_info.num_shadows=a.length;this.shadows_info.fbo.unbind();this.shadows_info.texture.setParameter(gl.TEXTURE_MIN_FILTER,
gl.NEAREST);this.shadows_info.texture.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR);this.rendering_only_depth=!1}};K.prototype.renderMesh=function(a,b,e,k,h,x,y,C){b&&(a||(a=f.IDENTITY),this._uniforms.u_model.set(a),h||=this.getMasterShader(e?r.ALBEDO:0),e&&(this._uniforms.u_texture=e.bind(0)),h.uniforms(this._uniforms),h.uniforms(this._camera._uniforms),k&&h.uniforms({u_color:k}),null!=C?(a=b.info.groups[C],h.drawRange(b,null==x?gl.TRIANGLES:x,a.start,a.length,y)):h.draw(b,null==x?gl.TRIANGLES:x,
y),this.stats.draw_calls+=1)};K.prototype.getAllRenderables=function(a,b,e){this.resetRenderablesPool();var k=this.renderables;k.length=0;this.lights.length=0;for(var h=this.outline_renderables.length=0;h<a.length;++h){var x=a[h];x.flags.was_renderer=!1;!1!==x.flags.visible&&x.layers&b&&((x.mesh||x._mesh)&&this.getNodeRenderables(x,e),x.constructor===f.Light&&(x.getGlobalVector(f.FRONT,x._front),x.getGlobalPosition(x._center),this.lights.push(x)))}if(this.onFilterRenderables)this.onFilterRenderables(k);
if(e){for(h=0;h<k.length;++h)k[h].computeRenderPriority(e._position);k=k.sort((y,C)=>C._render_priority-y._render_priority)}return k};K.prototype.resetStats=function(){this.stats.draw_calls=0;this.stats.updated_shadowmaps=0};K.prototype.resetRenderablesPool=function(){this.used_renderables=0};K.prototype.getRenderablesFromPool=function(){if(this.used_renderables<this.renderables_pool.length){var a=this.renderables_pool[this.used_renderables];this.used_renderables++;return a}a=new f.Renderable;a.id=
this.used_renderables;this.renderables_pool.push(a);this.used_renderables++;return a};K.prototype.getNodeRenderables=function(a,b){var e=null;if(a._mesh)e=a._mesh;else if(a.mesh&&(e=gl.meshes[a.mesh],!e)){this.autoload_assets&&-1!=a.mesh.indexOf(".")&&this.loadMesh(a.mesh);return}if(e){var k=a.skeleton||a.skin||null;this.allow_skinning||(k=null);!k||k.bones||k.joints||(k=null);k&&k.bones&&!k.bones.length&&(k=null);k&&k.joints&&!k.joints.length&&(k=null);k&&k.joints&&(!k._bone_matrices||this.force_update_bones)&&
a.updateSkinningBones(a._parent);K.temp_bbox||(K.temp_bbox=BBox.create(),K.aabb_center=BBox.getCenter(K.temp_bbox),K.aabb_halfsize=BBox.getHalfsize(K.temp_bbox));var h=K.temp_bbox;BBox.transformMat4(h,e.getBoundingBox(),a._global_matrix);if(!k&&b&&!a._instances){if(b.testBox(K.aabb_center,K.aabb_halfsize)==f.CLIP_OUTSIDE)return;a._last_rendered_frame=this.frame}b=null;a.morphs&&this.allow_morphtargets&&(b=this.computeMorphTargets(a));if(a.primitives&&a.primitives.length)for(var x=0;x<a.primitives.length;++x){var y=
a.primitives[x],C;if(C=y.material?f.Materials[y.material]:this.default_material){var B=this.getRenderablesFromPool();B.material=C;B.model=a._global_matrix;B.mesh=e;B.group_index=x;B.node=a;B.draw_range=null;B._render_priority=C.render_priority||0;B.instances=a._instances;B.flags=B.instances||k||b?Z:0;B.reverse_faces=a.flags.frontFace==GL.CW;B.skin=k;B.index_buffer_name="triangles";B.primitive=null!=y.mode?y.mode:C.primitive;B.bounding.set(h);B.morphs=b;this.renderables.push(B);0==x&&a.flags.outline&&
(y=this.getRenderablesFromPool(),y.copyFrom(B),y.group_index=-1,this.outline_renderables.push(y))}}else a.material&&(C=f.Materials[a.material])&&(B=this.getRenderablesFromPool(),B.material=C,B.model=a._global_matrix,B.mesh=e,B.group_index=a.submesh,B.node=a,B.instances=a._instances,B.skin=k,B.draw_range=a.draw_range,B.primitive=null!=a.primitive?a.primitive:C.primitive,B._render_priority=C.render_priority||0,B.reverse_faces=a.flags.frontFace==GL.CW,B.bounding.set(h),B.index_buffer_name=a.indices_name||
"triangles",B.morphs=b,B.flags=B.instances||k||b?Z:0,this.renderables.push(B),a.flags.outline&&(y=this.getRenderablesFromPool(),y.copyFrom(B),y.group_index=-1,this.outline_renderables.push(y)))}};K._last_mesh_id=0;K.prototype.groupRenderablesForInstancing=function(a){for(var b=new Map,e=0,k=0;k<a.length;++k){var h=a[k];h.mesh.name||(h.mesh.name="##M"+K._last_mesh_id++);var x=h.instances||h.skin||h.draw_range?e++:h.mesh.name+":"+h.group_index+"/"+h.primitive+"/"+h.material.name+(h.reverse_faces?"[R]":
"");b.has(x)?b.get(x).push(h):b.set(x,[h])}a=[];h=b.values();for(var y of h)if(0!=y.length)if(1==y.length)h=y[0],this.debug_instancing||a.push(h);else{h=this.getRenderablesFromPool();h.copyFrom(y[0]);h.instances=Array(y.length);for(b=0;b<y.length;++b)e=y[b],b&&BBox.merge(h.bounding,h.bounding,e.bounding),h.instances[b]=e.model;a.push(h)}return a};K.prototype.renderBounding=function(a,b,e){if(a){b=b||f.IDENTITY;var k=this._uniforms.u_model;a=a.constructor===GL.Mesh?a._bounding:a;e=e||[1,1,0,1];var h=
a.subarray(3,6);mat4.translate(k,b,a.subarray(0,3));mat4.scale(k,k,[2*h[0],2*h[1],2*h[2]]);this.renderMesh(k,gl.meshes.cube,null,e,null,gl.LINES,"wireframe")}};K.prototype.enableItemFlags=function(a){var b=a.flags.flip_normals;this.reverse_normals&&(b=!b);gl.frontFace(b?gl.CW:gl.CCW);!1===a.flags.depth_test?gl.disable(gl.DEPTH_TEST):gl.enable(gl.DEPTH_TEST);!1===a.flags.depth_write&&gl.depthMask(!1);!0===a.flags.two_sided||this.disable_cull_face?gl.disable(gl.CULL_FACE):gl.enable(gl.CULL_FACE);if(this.rendering_only_depth||
a.blend_mode===f.BLEND_NONE||this.use_alpha_hash)gl.disable(gl.BLEND);else switch(gl.enable(gl.BLEND),a.blend_mode){case f.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case f.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case f.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}this.rendering_only_depth||this.use_alpha_hash||"BLEND"!==a.alphaMode||(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};K.prototype.disableItemFlags=
function(a){a.flags.flip_normals&&gl.frontFace(gl.CCW);!1===a.flags.depth_test&&gl.enable(gl.DEPTH_TEST);a.blend_mode!==f.BLEND_NONE&&gl.disable(gl.BLEND);a.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===a.flags.depth_write&&gl.depthMask(!0);"BLEND"==a.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};K.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};K.collectBones=function(a,b,e){function k(Q,N,S){if(!N||!Q)return S;if(Q==N)return mat4.mul(S,
Q.getGlobalMatrix(),S),S;mat4.mul(S,Q.matrix,S);return k(Q._parent,N,S)}if(e&&e.bones){var h=e.bones.length;b._bone_matrices||(b._bone_matrices=new Float32Array(16*h));h=b._bone_matrices;mat4.create();var x=null;b.skeleton_root&&(x=a.findNodeByName(b.skeleton_root));x||=a;b=mat4.create();for(var y=mat4.invert(mat4.create(),a.getGlobalMatrix()),C=0;C<e.bones.length;++C){var B=e.bones[C],F=h.subarray(16*C,16*C+16),L=B[0],J=null;L&&(J=a.findNodeByName(L));J?(mat4.identity(b),k(J,x,b),y&&mat4.multiply(b,
y,b),mat4.multiply(F,b,B[1]),e.bind_matrix&&mat4.multiply(F,F,e.bind_matrix)):mat4.identity(F)}return h}};f.Renderer.prototype.renderPoints=function(a,b,e,k,h,x,y,C,B){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";h||(y==GL.LINES||y==GL.LINE_LOOP?h=this.shaders.flat:C?(h=this.shaders._points_textured,h||(h=this.shaders._points_textured=new GL.Shader(f.points_vs_shader,f.points_fs_shader,{TEXTURED:""}),h.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(h=this.shaders[b?
"_points_color":"_points"],h||(h=b?this.shaders._points_color=new GL.Shader(f.points_vs_shader,f.points_fs_shader,{COLORED:""}):this.shaders._points=new GL.Shader(f.points_vs_shader,f.points_fs_shader),h.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));x=x||1;var F=1024;k=k||a.length/3;var L=this._points_mesh;k>a.length/3&&(k=a.length/3);if(!L||a.length>3*F){k>F&&(F=GL.Texture.nextPOT(k));var J=new Float32Array(3*F);F=new Float32Array(4*F);L=this._points_mesh=GL.Mesh.load({vertices:J,extra4:F})}else J=
this._points_mesh.getBuffer("vertices").data,F=this._points_mesh.getBuffer("extra4").data;J.set(J.length>a.length?a:a.subarray(0,J.length));b?F.set(F.length>b.length?b:b.subarray(0,F.length)):F.fill&&F.fill(0);L.upload(GL.DYNAMIC_STREAM);h.setUniform("u_color",this._color);h.setUniform("u_pointSize",x);h.setUniform("u_camera_perspective",e._projection_matrix[5]);h.setUniform("u_model",B||f.IDENTITY);h.setUniform("u_viewport",gl.viewport_data);h.setUniform("u_viewprojection",e._viewprojection_matrix);
C&&h.setUniform("u_texture",C.bind(0));h.drawRange(L,null!=y?y:GL.POINTS,0,k);return L};f.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
f.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvarying vec4 v_extra4;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef COLORED\n\t\tcolor *= v_extra4;\n\t#endif\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
K.prototype.renderLines=function(a,b,e){this.renderPoints(a,null,null,null,null,null,gl.LINES,null,e)};K.prototype.render3DLines=function(a,b,e,k){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var h=this.shaders._lines;h||=this.shaders._lines=new GL.Shader(f.lines_vs_shader,this._flat_fragment_shader);var x=this._camera,y=a.length/3,C=e?2*y:4*y;var B=this._lines_mesh;if(!B||3*C>B.getBuffer("vertices").data.length){B=GL.Texture.nextPOT(C);C=new Float32Array(3*
B);var F=new Float32Array(3*B);var L=new Float32Array(2*B);indices_data=new Uint16Array(3*B);B=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:C,normals:F,extra2:L})}else C=this._lines_mesh.getBuffer("vertices").data,F=this._lines_mesh.getBuffer("normals").data,L=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data;var J=vec2.fromValues(-1,-1),Q=vec2.fromValues(1,-1),N=vec2.fromValues(-1,1),S=vec2.fromValues(1,1),T=vec3.create();if(e)throw"strip lines not supported yet";
for(var Y=Math.floor(y/2),R=0;R<Y;++R){var V=2*R,aa=a.subarray(3*V,3*V+3);V=a.subarray(3*V+3,3*V+6);vec3.sub(T,V,aa);C.set(aa,12*R);C.set(aa,12*R+3);C.set(V,12*R+6);C.set(V,12*R+9);F.set(T,12*R);F.set(T,12*R+3);F.set(T,12*R+6);F.set(T,12*R+9);L.set(J,8*R);L.set(Q,8*R+2);L.set(N,8*R+4);L.set(S,8*R+6);indices_data.set([4*R,4*R+2,4*R+1,4*R+1,4*R+2,4*R+3],6*R)}B.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);h.setUniform("u_model",k||f.IDENTITY);h.setUniform("u_color",this._color);h.setUniform("u_camera_front",
x._front);h.setUniform("u_camera_position",x.eye);h.setUniform("u_lineWidth",.5*b);h.setUniform("u_camera_perspective",x._projection_matrix[5]);h.setUniform("u_viewport",gl.viewport_data);h.setUniform("u_viewprojection",x._viewprojection_matrix);h.drawRange(B,gl.TRIANGLES,0,y*(e?6:3));return B};f.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
f.Renderer.prototype.drawImage=function(a,b,e,k,h,x,y,C,B){a.constructor===String&&(a=this.loadTexture(a));if(a){if(null==k||null==h)x=b,y=e,k=C=a.width,h=B=a.height;else if(null==x||null==y||null==C||null==B)x=b,y=e,C=k,B=h,e=b=0,k=a.width,h=a.height;var F=this.shaders._textured_quad;F||=this.shaders._textured_quad=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_rect;\n\t\tuniform vec4 u_src_rect;\n\t\tuniform vec4 u_viewport;\n\t\tfloat remap(in float value, in float low1, in float high1, in float low2, in float high2 ) { float range1 = high1 - low1; float range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n\t\t\n\t\tvoid main() {\n\t\t\tv_coord = a_coord;\n\t\t\tvec4 pos = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\tpos.x = remap(pos.x, -1.0, 1.0, u_rect.x, u_rect.x + u_rect.z );\n\t\t\tpos.x = remap(pos.x, 0.0, u_viewport.z, -1.0, 1.0 );\n\t\t\tpos.y = remap(pos.y, -1.0, 1.0, u_rect.y, u_rect.y + u_rect.w );\n\t\t\tpos.y = remap(pos.y, 0.0, u_viewport.w, 1.0, -1.0 );\n\t\t\tv_coord.x = remap( v_coord.x, 0.0, 1.0, u_src_rect.x, u_src_rect.x + u_src_rect.z );\n\t\t\tv_coord.y = remap( v_coord.y, 1.0, 0.0, u_src_rect.y, u_src_rect.y + u_src_rect.w );\n\t\t\tgl_Position = pos;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform sampler2D u_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D( u_texture, v_coord );\n\t\t\tif(color.a == 0.0) discard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t");var L=GL.Mesh.getScreenQuad();F.bind();F.setUniform("u_color",this._color);F.setUniform("u_rect",[x,y,C,B]);F.setUniform("u_src_rect",[b/a.width,e/a.height,k/a.width,h/a.height]);F.setUniform("u_viewport",gl.viewport_data);
F.setUniform("u_texture",a.bind(0));gl.disable(GL.DEPTH_TEST);gl.disable(GL.CULL_FACE);F.draw(L,GL.TRIANGLES)}};K.prototype.getAssetFullPath=function(a,b){if(-1==a.indexOf("://")&&!b&&this.assets_folder){if(this.onGetAssetsFolder)return this.onGetAssetFolder(a);b="/"==this.assets_folder.substr(-1);var e="/"==a[0];return b!=e?this.assets_folder+a:b&&e?this.assets_folder+a.substr(1):this.assets_folder+"/"+a}return a};K.prototype.loadMesh=function(a,b,e){if(!a)return console.error("loadMesh: Cannot load null name");
if(!this.assets_loading[a]&&!this.assets_not_found[a]){var k=this.meshes[a];if(k)return b&&b(k),k;var h=this;e=this.getAssetFullPath(a,e);e=GL.Mesh.fromURL(e,function(x){x?h.meshes[a]=x:(h.assets_not_found[a]=!0,delete h.meshes[a]);h.num_assets_loading--;delete h.assets_loading[a];b&&b(x,a)});this.assets_loading[a]=e;this.num_assets_loading++;return this.meshes[a]=e}};K.prototype.loadTexture=function(a,b,e,k){function h(F){C.debug&&console.log(" + texture loaded: "+a);F?C.textures[x]=F:C.assets_not_found[a]=
!0;e&&e(F,x);C.num_assets_loading--;delete C.assets_loading[a];if(C.on_texture_load)C.on_texture_load(F,x)}if(!a)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var x=a;b&&(b.name&&(x=b.name),b.preview&&(x=b.preview));var y=this.textures[x];if(y&&!y.is_preview)return e&&e(y),y;var C=this;k=this.getAssetFullPath(a,k);var B=null;-1!=a.indexOf("CUBEMAP")?B=GL.Texture.cubemapFromURL(k,this.default_cubemap_settings,h):this.credentials?(this.credentials.headers?
this.credentials.headers["Content-Type"]="application/octet-stream":this.credentials.headers={"Content-Type":"application/octet-stream"},B=new GL.Texture(1,1,b),fetch(k,this.credentials).then(function(F){if(!F.ok)throw Error("HTTP "+F.status+":"+F.statusText);return F.arrayBuffer()}).then(function(F){var L=URL.createObjectURL(new Blob([F]));b.texture=B;B=GL.Texture.fromURL(L,b,h);b.texture=null;setTimeout(function(){URL.revokeObjectURL(L)},6E4)})):B=GL.Texture.fromURL(k,b,h);b&&b.preview&&(B.is_preview=
!0);this.assets_loading[a]=B;this.num_assets_loading++;return this.textures[x]=B}};K.prototype.createShaders=function(){var a=this._vertex_shader="\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec3 v_pos;\n\t\tvarying vec3 v_normal;\n\t\tvarying vec2 v_coord;\n\t\t#ifdef COLOR\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t\tvoid main() {\n\t\t\tv_pos = a_vertex;\n\t\t\tv_normal = a_normal;\n\t\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t\tv_coord = a_coord;\n\t\t\t#ifdef COLOR\n\t\t\tv_color = a_color;\n\t\t\t#endif\n\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\tgl_PointSize = 2.0;\n\t\t}\n\t",
b=this._flat_fragment_shader="\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\t#ifdef COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t\t#endif\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color = u_color;\n\t\t\t\t\t#ifdef COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t\t#endif\n\t\t\t\t  gl_FragColor = color;\n\t\t\t\t}\n\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,b);gl.shaders.flat_color=this._flat_instancing_shader=new GL.Shader(a,b,{COLOR:""});this._point_shader=new GL.Shader("\n\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tuniform mat4 u_model;\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tuniform float u_pointSize;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\t\tvec3 vertex = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\t}\n\t\t\t\t",
"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\n\t\t\t\t     discard;\n\t\t\t\t  gl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t\tuniform vec4 u_color;\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t\tvoid main() {\n\t\t\tv_color = a_color * u_color;\n\t\t\tvec3 vertex = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec4 v_color;\n\t\tvoid main() {\n\t\t  gl_FragColor = v_color;\n\t\t}\n\t");gl.shaders.color=this._color_shader;gl.shaders.texture=this._texture_shader=new GL.Shader(a,"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\t#ifdef COLOR\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\t#ifdef COLOR\n\t\t\t\tcolor *= v_color;\n\t\t\t#endif\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");
gl.shaders.skybox=this._skybox_shader=new GL.Shader("\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\tvarying vec3 v_pos;\n\tvarying vec3 v_wPos;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\t\n\tvoid main() {\n\t\tv_coord = a_coord;\n\t\tvec3 vertex = a_vertex;\t\n\t\tv_pos = vertex;\n\t\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\t\tv_wNormal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\tgl_Position = u_viewprojection * vec4(v_wPos,1.0);\n\t}\n\t",
"\n\tprecision highp float;\n\tvarying vec3 v_pos;\n\tvarying vec3 v_wPos;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\t\n\tuniform vec4 u_color;\n\tuniform samplerCube u_color_texture;\n\tuniform vec3 u_camera_position;\n\t\n\tvoid main() {\n\t  vec3 L = normalize(vec3(1.,1.,-1.));\n\t  vec3 N = normalize( v_wNormal );\n\t\tvec3 E = normalize( v_wPos - u_camera_position );\n\t  vec4 color = u_color;\n\t  color.xyz = textureCube( u_color_texture, -E * vec3(1.0,-1.0,1.0) ).xyz;\n\t  gl_FragColor = color;\n\t}\n\t")};
K.prototype.loadTextureAtlas=function(a,b,e){"string"==typeof a&&(a=JSON.parse(a));var k=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(h){var x=a.files;k.textures[":atlas"]=h;for(var y in x)if(!k.textures[y]||k.textures[y].is_preview){var C=x[y],B=new GL.Texture(a.size,a.size,{wrap:gl.REPEAT,filter:gl.LINEAR});B.drawTo(function(){h.gl.drawTexture(h,0,0,a.size,a.size,C.x,C.y,C.width||a.size,C.height||a.size)});B.is_preview=!0;k.textures[y]=B}e&&e(x)})};K.prototype.loadShaders=
function(a,b,e,k){var h=this;-1!=a.indexOf("://")||k||(a=this.assets_folder+a);a+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(a,function(x){h.compileShadersFromAtlas(x,e);h.loading_shaders=!1;b&&b(x)})};K.prototype.compileShadersFromAtlasCode=function(a,b){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a,b)};K.prototype.compileShadersFromAtlas=function(a,b){var e=a.shaders;if(e){this.shader_files=a;for(var k in a)a[k]=GL.Shader.expandImports(a[k],a);e=e.split("\n");for(k=
0;k<e.length;++k){var h=e[k].trim().split(" "),x=h[0].trim();if("//"!=x.substr(0,2)){var y=a[h[1]],C=a[h[2]],B=null,F={};if(3<h.length)for(var L=3;L<h.length;++L)if("#"==h[L][0])F[h[L].substr(1)]=!0;else{B=h.slice(L).join(" ");break}if(!F.WEBGL1||1==gl.webgl_version)if(!F.WEBGL2||2==gl.webgl_version){h[1]&&"@"==h[1][0]&&(F=h[1].substr(1)+"_VERTEX_SHADER",GL.Shader[F]&&(y=GL.Shader[F]));h[2]&&"@"==h[2][0]&&(F=h[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[F]&&(C=GL.Shader[F]));if(B)try{B=JSON.parse(B)}catch(Q){console.error("Error in shader macros: ",
x,B,Q)}if(B&&b){F={};for(var J in B)F[J]=B[J];for(J in b)F[J]=b[J];B=F}else b&&(B=b);try{y&&C?this.shaders[x]?this.shaders[x].updateShader(y,C,B):this.shaders[x]=new GL.Shader(y,C,B):console.warn("Shader subfile not found: ",h[1],h[2])}catch(Q){GL.Shader.dumpErrorToConsole(Q,y,C)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};K.prototype.setShadersFromFile=function(a){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a)};K.cubemap_info=[{front:[1,0,0],
up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];K.prototype.renderToCubemap=function(a,b,e,k,h,x,y){var C=K.cubemap_camera;C||(K.cubemap_camera=C=new f.Camera);C.perspective(90,1,x||.1,y||1E3);var B=vec3.create(),F=this;a.drawTo(function(L,J){L=K.cubemap_info[J];vec3.add(B,e,L.front);C.lookAt(e,B,L.up);F.clear();F.render(b,C,k,h)});return a};K.prototype.drawSphere3D=function(a,b,e){gl.meshes.sphere||
(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var k=gl.shaders.flat;k.setUniform("u_color",e);k.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(d);mat4.translate(d,d,a);mat4.scale(d,d,[b,b,b]);k.setUniform("u_model",d);k.draw(gl.meshes.sphere);this.stats.draw_calls+=1};K.prototype.drawCircle2D=function(a,b,e,k,h){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:.02,slices:64}));var x=
gl.shaders.flat;x.setUniform("u_color",k);x.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(d);mat4.translate(d,d,[a,b,0]);mat4.scale(d,d,[2*e,2*e,2*e]);x.setUniform("u_model",d);x.draw(gl.meshes[h?"circle":"ring"]);this.stats.draw_calls+=1};K.prototype.drawLine2D=function(a,b,e,k,h,x,y){var C=gl.meshes.plane;y=y||gl.shaders.flat;y.setUniform("u_color",x);y.setUniform("u_viewprojection",this._viewprojection2D_matrix);var B=e-a,F=k-b;x=Math.atan2(B,F);B=Math.sqrt(B*B+F*F);
h/=2;mat4.identity(d);mat4.translate(d,d,[.5*(a+e),.5*(b+k),0]);mat4.rotate(d,d,x,f.FRONT);a=h;mat4.scale(d,d,[a,B,a]);y.setUniform("u_model",d);y.draw(C);this.stats.draw_calls+=1};K.prototype.renderDebugSceneTree=function(a,b){for(var e=[],k=0;k<a._nodes.length;++k){var h=a._nodes[k];if(h._parent&&h._parent!=a.root){var x=h._parent.getGlobalPosition();h=h.getGlobalPosition();e.push(x[0],x[1],x[2],h[0],h[1],h[2])}}e=new Float32Array(e);this.renderPoints(e,null,b,null,null,null,GL.LINES);this.renderPoints(e,
null,b,null,null,-10,GL.POINTS)};f.generateTextureAtlas=function(a,b,e,k,h){b=b||1024;e=e||1024;k=k||64;var x=0,y;for(y in a)x++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);x=new GL.Texture(b,e);var C={width:b,height:e,size:k,files:{}},B=0,F=0,L={};x.drawTo(function(){for(var J in a)if(":"!=J[0]&&"white"!=J&&"black"!=J&&"notfound"!=J){var Q=a[J];if(!Q.is_preview&&Q.texture_type==gl.TEXTURE_2D){if(h){var N=Q.toBase64().hashCode();if(L[N]){C.files[J]=C.files[L[N]];continue}L[N]=
J}C.files[J]={x:B,y:F};Q.renderQuad(B,F,k,k);B+=k;if(B==b&&(B=0,F+=k,F==e)){console.warn("Atlas too small, some textures wont be stored.");break}}}});x.info=C;console.log(C);return x};K.prototype.computeResourcesLoaded=function(a){var b=0,e;for(e in a){var k=a[e],h=this.textures[k];h&&!1===h.ready||(k=this.meshes[k])&&!1===k.ready||(h||k)&&b++}return b};Object.defineProperty(K.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(a){},enumerable:!0});Object.defineProperty(K.prototype,
"textures",{get:function(){return this.gl.textures},set:function(a){},enumerable:!0});Object.defineProperty(K.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(a){},enumerable:!0});K.prototype.addMesh=function(a,b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};f.Renderer=K;class W{constructor(){this.name="";this.id=-1;this.flags=0;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=this.draw_range=null;this.reverse_faces=
!1;this.primitive=-1;this.morphs=this.skin=null;this.bounding=BBox.create();this.node=this.instances=null;this._render_priority=0}copyFrom(a){this.name=a.name;this.id=a.id;this.flags=a.flags;this.mesh=a.mesh;this.model=a.model;this.index_buffer_name=a.index_buffer_name;this.group_index=a.group_index;this.material=a.material;this.reverse_faces=a.reverse_faces;this.skin=a.skin;this.draw_range=a.draw_range;this.primitive=a.primitive;this.instances=a.instances;this.morphs=a.morphs;this.bounding.set(a.bounding);
this._render_priority=a._render_priority;this.node=a.node}computeRenderPriority(a){this.name=this.node.name;var b=this.mesh.getBoundingBox();b&&(b=mat4.multiplyVec3(v,this.model,b),this._render_priority=this.material.render_priority||0,a=vec3.distance(a,b),"BLEND"==this.material.alphaMode?(this._render_priority+=.001*a,this._render_priority-=100):this._render_priority+=1E3-.001*a)}}f.Renderable=W;class X{constructor(a,b){this.name="";this.shaders=new Map;this.fs_generator=this.vs_generator=null;this.vs_generator=
a;this.fs_generator=b}replacePragmas(a,b){for(var e in b)a=a.replaceAll("#pragma "+e,b[e])}getShader(a){a=a||0;var b=this.shaders,e=b.get(a);if(e)return e;e=this.vs_generator(a);var k=this.fs_generator(a),h=null;if(a){h={};for(var x in r)a&r[x]&&(h[x]="")}e=new GL.Shader(e,k,h);b.set(a,e);return e}}f.UberShader=X;f.Ray=g;g.prototype.testPlane=function(a,b){return geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point)};g.prototype.testSphere=function(a,b,e){return geo.testRaySphere(this.origin,
this.direction,a,b,this.collision_point,e)};g.prototype.closestPointOnRay=function(a,b,e){e=e||vec3.create();var k=vec3.create();vec3.add(k,this.origin,this.direction);var h=vec3.create();vec3.add(h,a,b);geo.closestPointBetweenLines(this.origin,k,a,h,null,e);return e};f.Factory=function(a,b,e){a=f.Factory.templates[a];var k=new f.SceneNode;a&&k.fromJSON(a);b&&(b.constructor===f.Scene?b.root:b).addChild(k);e&&k.fromJSON(e);return k};f.Factory.templates={grid:{mesh:"grid",material:{primitive:1,color:[.5,
.5,.5,.5],blend_mode:f.BLEND_ALPHA}},sphere:{mesh:"sphere"},floor:{mesh:"planeXZ",scaling:10}};f.parseTextConfig=function(a){function b(k,h){for(var x=e.shift();x;)if(0==x.trim().length)x=e.shift();else{for(var y=0;"\t"==x[y]&&y<x.length;)y++;if(y<h)break;var C={children:[]};try{var B=x.trim();-1!=B.indexOf(":")&&(B="{"+B+"}");var F=new Function("return "+B);C.data=F()}catch(L){console.error(L)}y>=h&&(k&&k.children.push(C),x=b(C,y+1))}return x}var e=a.split("\n");a={data:"",children:[]};b(a,0);return a};
var Z=1;f.orientNodeToCamera=function(a,b,e,k){a&&(a==f.BILLBOARD_CYLINDRIC||a==f.BILLBOARD_PARALLEL_CYLINDRIC?(a==f.BILLBOARD_CYLINDRIC?(a=b.getGlobalPosition(D),vec3.sub(v,e._position,a),l[0]=v[0],l[1]=v[2]):(l[0]=e._front[0],l[1]=e._front[2]),e=vec2.computeSignedAngle(l,f.FRONT2D),isNaN(e)||(mat4.rotateY(d,c,-e),b._global_matrix.set(d),mat4.setTranslation(b._global_matrix,b._position),mat4.scale(b._global_matrix,b._global_matrix,b._scale))):(a==f.BILLBOARD_PARALLEL_SPHERIC?(b._global_matrix.set(e._model_matrix),
mat4.setTranslation(b._global_matrix,b._position)):(mat4.lookAt(b._global_matrix,b._position,e.position,f.UP),mat4.invert(b._global_matrix,b._global_matrix)),mat4.scale(b._global_matrix,b._global_matrix,b._scale)))};f.makeHash=function(a){let b="";for(var e=0;e<a;e++)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(62*Math.random()|0);return b};f.readPixels=function(a,b){var e=new Image;e.src=a;e.onload=function(){var k=document.createElement("canvas");k.width=this.width;
k.height=this.height;var h=k.getContext("2d");h.drawImage(this,0,0);k=h.getImageData(0,0,k.width,k.height);b(k,this)}};f.alignDivToNode=function(a,b,e,k,h,x){function y(N){return 1E-5>Math.abs(N)?0:N}function C(N){return"matrix3d("+y(N[0])+","+y(-N[1])+","+y(N[2])+","+y(N[3])+","+y(N[4])+","+y(-N[5])+","+y(N[6])+","+y(N[7])+","+y(N[8])+","+y(-N[9])+","+y(N[10])+","+y(N[11])+","+y(N[12])+","+y(-N[13])+","+y(N[14])+","+y(N[15])+")"}var B=parseInt(a.clientWidth),F=parseInt(a.clientHeight),L=.5*B,J=.5*
F,Q=h._projection_matrix[5]*J;a.style.width=gl.canvas.width+"px";a.style.height=gl.canvas.height+"px";a.style.perspective=Q+"px";a.style.pointerEvents="none";b&&(a="translateZ("+Q+"px) "+C(h._view_matrix),b.style.transformStyle="preserve-3d",b.style.transform=a+" translate("+L+"px,"+J+"px)",b.style.width=B+"px",b.style.height=F+"px",b.style.pointerEvents="none");k=k.getGlobalMatrix();B=1/e.clientWidth;F=1/e.clientHeight;e.parentNode!=b&&b.appendChild(e);e.style.pointerEvents=x?"auto":"none";e.style.transform=
function(N){return"translate(-50%,-50%) matrix3d("+(y(N[0])+","+y(N[1])+","+y(N[2])+","+y(N[3])+","+y(-N[4])+","+y(-N[5])+","+y(-N[6])+","+y(-N[7])+","+y(N[8])+","+y(N[9])+","+y(N[10])+","+y(N[11])+","+y(N[12])+","+y(N[13])+","+y(N[14])+","+y(N[15])+")")}(k)+" scale3D("+B+","+F+",1)"};t.prototype.move=t.prototype.translate;t.prototype.setRotationFromEuler=t.prototype.setEulerRotation;t.prototype.getGlobalPoint=t.prototype.localToGlobal;t.prototype.serialize=t.prototype.toJSON;t.prototype.configure=
t.prototype.fromJSON;t.ctor=t.prototype._ctor;P.prototype.configure=P.prototype.fromJSON;P.prototype.serialize=P.prototype.toJSON;q.prototype.configure=q.prototype.fromJSON;q.prototype.serialize=q.prototype.toJSON;"undefined"==typeof GL&&(mat4.rotateVec3=function(a,b,e){var k=e[0],h=e[1];e=e[2];a[0]=b[0]*k+b[4]*h+b[8]*e;a[1]=b[1]*k+b[5]*h+b[9]*e;a[2]=b[2]*k+b[6]*h+b[10]*e;return a},mat4.projectVec3=function(a,b,e){var k=e[0],h=e[1];e=e[2];var x=b[1]*k+b[5]*h+b[9]*e+b[13],y=b[2]*k+b[6]*h+b[10]*e+b[14],
C=b[3]*k+b[7]*h+b[11]*e+b[15];a[0]=((b[0]*k+b[4]*h+b[8]*e+b[12])/C+1)/2;a[1]=(x/C+1)/2;a[2]=(y/C+1)/2;return a})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(w){function g(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=.5;this.particles_acceleration=vec3.create();this.velocity_variation=this.particles_end_scale=this.particles_start_scale=
1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function z(){this._ctor()}function n(m){this._ctor();m&&this.configure(m)}class f extends RD.SceneNode{constructor(m){super();this.build();
m&&this.fromJSON(m)}}f.prototype.build=function(){this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};f.prototype.updateVertices=function(m){m&&(this.vertices=m);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),
this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};f.prototype.updateNormals=function(m){m&&(this.normals=m);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};
f.prototype.updateCoords=function(m){m&&(this.coords=m);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};f.prototype.updateIndices=function(m){m&&(this.indices=m);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=
new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=m.length};f.prototype.preRender=function(){this._total&&(this.draw_range=[0,this._total_indices?this._total_indices:this._total/3])};RD.DynamicMeshNode=f;extendClass(g,RD.SceneNode);RD.ParticlesEmissor=g;g.prototype.update=function(m){var r=
this.particles.length,v=this.particles_damping,D=this.particles_acceleration,E=vec3.length(D);if(r){for(var c=[],p=0;p<r;p++){var d=this.particles[p];vec3.scaleAndAdd(d.pos,d.pos,d.vel,m);E&&vec3.scaleAndAdd(d.vel,d.vel,D,m);v&&vec3.scaleAndAdd(d.vel,d.vel,d.vel,-m*v);d.ttl-=m;0<d.ttl&&c.push(d)}this.particles=c}r=this.getGlobalPosition();v=this.emissor_direction;D=this.particles_life;E=this.num_textures*this.num_textures;c=this.velocity_variation;if(0<this.particles_per_second)for(m=this.particles_per_second*
(m+this._accumulated_time),this._accumulated_time=(m-Math.floor(m))/this.particles_per_second,m=Math.floor(m),p=0;p<m&&!(this.particles.length>=this.max_particles);p++)v=vec3.clone(v),v[0]+=.5*Math.random()*c,v[2]+=.5*Math.random()*c,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*E)/E,pos:vec3.clone(r),vel:v,ttl:D})};g.prototype.render=function(m,r){if(0!=this.particles.length){this.updateVertices();var v=this._meshes[m.gl.context_id];v||(v=new GL.Mesh(void 0,void 0,
m.gl),this._vertices_buffer=v.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=v.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=v;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);v=gl.shaders[this.shader];v||(v=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(g._vertex_shader,g._pixel_shader));this.draw_range[1]=this.particles.length;v=gl.getViewport();
this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/v[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(m._model_matrix);m._mvp_matrix.set(m._viewprojection_matrix);m.renderNode(this,m,r)}};g.prototype.updateVertices=function(m){if(m=this.particles.length)for(var r=
this._vertices,v=this._extra,D=0,E=this.particles_life,c=this.num_textures*this.num_textures,p=0;p<m;p++){var d=this.particles[p];r.set(d.pos,D);v[D]=1;v[D+1]=d.ttl/E;1<c&&(v[D+2]=d.tex);D+=3}};extendClass(z,RD.SceneNode);RD.Billboard=z;z.SPHERIC=1;z.PARALLEL_SPHERIC=2;z.CYLINDRIC=3;z.PARALLEL_CYLINDRIC=4;z.prototype._ctor=function(){this.billboard_mode=z.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};z.prototype.render=function(m,r){!1!==this.flags.visible&&(this.auto_orient&&
RD.orientNodeToCamera(this.billboard_mode,this,r,m),m.renderNode(this,m,r))};n.prototype._ctor=function(){SceneNode.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=RD.TOP_LEFT;this.blend_mode=RD.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};
Object.defineProperty(n.prototype,"angle",{get:function(){return this._angle},set:function(m){this._angle=m;quat.setAxisAngle(this._rotation,RD.FRONT,this._angle*DEG2RAD);this._must_update_matrix=!0},enumerable:!0});n.prototype.setSize=function(m,r){this.size[0]=m;this.size[1]=r};n.createFrames=function(m,r,v){v=v||{};if(m.constructor!=Number){num_columns=m[0];var D=m[1]}else D=num_columns=m;var E=m=0,c=1/num_columns,p=1/D;D*=num_columns;if(!r){r=[];for(var d=0;d<D;++d)r.push(String(d))}for(d=0;d<
r.length&&!(v[r[d]]={pos:[m,E],size:[c,p],normalized:!0},m+=c,1<=m&&(m=0,E+=p),1<=E);++d);return v};n.prototype.createFrames=function(m,r){n.createFrames(m,r,this.frames)};n.prototype.addFrame=function(m,r,v,D,E,c){this.frames[m]={pos:vec2.fromValues(r,v),size:vec2.fromValues(D,E),normalized:!!c}};n.prototype.updateTextureMatrix=function(m){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var r=m.textures[this.texture];if(!r&&m.autoload_assets){var v=this;-1!=this.texture.indexOf(".")&&
m.loadTexture(this.texture,m.default_texture_settings,function(c){c&&0==v.size[0]&&0==v.size[0]&&v.setSize(c.width,c.height)});r=gl.textures.white}if(!r)return!1;m=this.texture_matrix;var D=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!D)return!1;if(!D)return this.flags.flipX&&(temp_vec2[0]=this.flags.flipX?1:0,temp_vec2[1]=0,mat3.translate(m,m,temp_vec2),temp_vec2[0]=this.flags.flipX?-1:1,temp_vec2[1]=1,mat3.scale(m,m,temp_vec2)),!0;if(D.normalized)temp_vec2[0]=this.flags.flipX?
D.pos[0]+D.size[0]:D.pos[0],temp_vec2[1]=1-D.pos[1]-D.size[1],mat3.translate(m,m,temp_vec2),temp_vec2[0]=D.size[0]*(this.flags.flipX?-1:1),temp_vec2[1]=D.size[1];else{var E=r.height;temp_vec2[0]=(this.flags.flipX?D.pos[0]+D.size[0]:D.pos[0])/r.width;temp_vec2[1]=(E-D.pos[1]-D.size[1])/E;mat3.translate(m,m,temp_vec2);temp_vec2[0]=D.size[0]*(this.flags.flipX?-1:1)/r.width;temp_vec2[1]=D.size[1]/r.height}mat3.scale(m,m,temp_vec2);return!0};n.prototype.render=function(m,r){if(this.texture&&this.updateTextureMatrix(m)){var v=
m.textures[this.texture];if(v){this.flags.pixelated&&(v.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.billboard_mode&&RD.orientNodeToCamera(this.billboard_mode,this,r,m);0==this.size[0]&&!1!==v.ready&&(this.size[0]=v.width);0==this.size[1]&&!1!==v.ready&&(this.size[1]=v.height);var D=this.size,E=0,c=0;temp_mat4.set(this._global_matrix);
var p=!1;this.current_frame&&this.current_frame.size&&(D=this.current_frame.size,p=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case RD.TOP_LEFT:E=.5;c=-.5;break;case RD.TOP_CENTER:c=-.5;break;case RD.TOP_RIGHT:E=-.5;break;case RD.BOTTOM_LEFT:c=E=.5;break;case RD.BOTTOM_CENTER:c=.5;break;case RD.BOTTOM_RIGHT:E=-.5,c=.5}mat4.translate(temp_mat4,temp_mat4,[E*v.width*D[0],c*v.height*D[1],0])}p?mat4.scale(temp_mat4,temp_mat4,[v.width*D[0],v.height*D[1],1]):mat4.scale(temp_mat4,
temp_mat4,[this.size[0],this.size[1],1]);m.setModelMatrix(temp_mat4);m.renderNode(this,m,r)}}};extendClass(n,RD.SceneNode);RD.Sprite=n})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(w){class g extends RD.SceneNode{constructor(d){super(d);d&&this.configure(d);this.render_priority=0;this.targets=null;this.size=150;this.mode=g.DEFAULT;this.coordinates=g.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();this.onDuplicateTargets=this.onActionFinished=null;d={x:g.XAXIS_COLOR,y:g.YAXIS_COLOR,z:g.ZAXIS_COLOR};var l="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");
this.actions={};for(var u in l){var t=l[u],q={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:.15,visible:!1,flag:g[t.toUpperCase()]};0==t.indexOf("move")&&(q.move=!0);0==t.indexOf("rotate")&&(q.rotate=!0);0==t.indexOf("scale")&&(q.scale=!0);q.color=d[t[t.length-1]];if(q.move||q.rotate)q.cursor="crosshair";this.actions[t]=q}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=
vec3.fromValues(0,1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1;this.mesh="sphere";this.createMaterial({name:"gizmo"}).render=g.prototype.render.bind(this)}}g.MOVEX=1;g.MOVEY=2;g.MOVEZ=4;g.MOVEXY=8;g.MOVEXZ=16;g.MOVEYZ=32;g.ROTATEX=64;g.ROTATEY=128;g.ROTATEZ=
256;g.SCALEX=512;g.SCALEY=1024;g.SCALEZ=2048;g.SCALEXY=4096;g.SCALEYZ=8192;g.SCALEXZ=16384;g.SCALE=32768;g.DRAG=65536;g.ROTATE=131072;g.ROTATEFRONT=262144;g.RESIZE=524288;g.MOVEAXIS=g.MOVEX|g.MOVEY|g.MOVEZ;g.MOVEPLANAR=g.MOVEXY|g.MOVEXZ|g.MOVEYZ;g.MOVEALL=g.DRAG|g.MOVEAXIS|g.MOVEPLANAR;g.PLANAR=g.MOVEX|g.MOVEZ|g.MOVEXZ|g.ROTATEY|g.SCALE;g.ROTATEALL=g.ROTATEX|g.ROTATEY|g.ROTATEZ|g.ROTATEFRONT;g.SCALEALL=g.SCALE|g.SCALEX|g.SCALEY|g.SCALEZ|g.SCALEXY|g.SCALEYZ|g.SCALEXZ;g.MOVEROTATESCALE=g.MOVEAXIS|g.MOVEPLANAR|
g.ROTATEALL|g.SCALE;g.ALL=g.MOVEAXIS|g.MOVEPLANAR|g.ROTATEALL|g.SCALEALL;g.DEFAULT=g.PLANAR;g.OBJECT_SPACE=1;g.WORLD_SPACE=2;w=mat4.create();var z=mat4.create(),n=mat4.create();mat4.create();mat4.create();mat4.create();var f=mat4.create(),m=mat4.create();mat4.create();var r=vec3.create(),v=vec3.create(),D=vec3.create(),E=vec4.create();vec4.create();mat4.translate(w,w,[1.1,0,0]);mat4.rotate(w,w,90*DEG2RAD,[0,0,-1]);mat4.translate(z,z,[0,1.1,0]);mat4.translate(n,n,[0,0,1.1]);mat4.rotate(n,n,90*DEG2RAD,
[1,0,0]);w=mat4.create();mat4.scale(w,w,[-1,-1,-1]);g.full_viewport=null;var c=mat4.create(),p=mat4.create();g.XAXIS_COLOR=[.901,.247,.349,1];g.YAXIS_COLOR=[.55,.81,.11,1];g.ZAXIS_COLOR=[.23,.57,.93,1];g.XYAXIS_COLOR=[.9,.7,.23,.75];g.XZAXIS_COLOR=[.6,.4,.7,.75];g.YZAXIS_COLOR=[.39,.69,.52,.75];g.SPHERE_COLOR=[.8,.8,.8,.4];g.RING_COLOR=[.5,.5,.5,1];g.INNERSPHERE_COLOR=[.6,.6,.6,1];g.SELECTED_COLOR=[1,1,1,1];g.NOAXIS_COLOR=[.901,.247,.749,1];g.STATIC_SPHERE_COLOR=[.1,.1,.1,.3];g.prototype.isTarget=
function(d){return-1!=this.targets.indexOf(d)};g.prototype.setTargets=function(d,l){if(d&&d.constructor!==Array)throw"nodes must be an Array";d&&0!=d.length?(l&&this.targets&&(d=this.targets.concat(d)),this.targets=d=d.filter(function(u,t){return d.indexOf(u)===t}),this.resetTransform(),this.position=this.computeCenter(this.targets)):l||(this.targets=null)};g.prototype.computeCenter=function(d){if((d=d||this.targets)&&d.length){for(var l=null,u=0;u<d.length;++u){var t=d[u];t.layers&this.layers&&(t=
t.getGlobalPosition(),l?vec3.add(l,l,t):l=t)}if(!l)return[0,0,0];vec3.scale(l,l,1/d.length);return l}};g.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?(this.transform=this.targets[0].transform,this.scaling=[1,1,1]):this.position=this.computeCenter(this.targets)))};g.prototype.updateTargets=function(){if(this.targets)for(var d=this.getGlobalMatrix(mat4.create()),
l=0;l<this.targets.length;++l){var u=this.targets[l];u.layers&this.layers&&u.fromMatrix(d,!0)}};g.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var d=0;d<this.targets.length;++d){var l=this.targets[d];l.layers&this.layers&&(this.target_tranforms[d]=new Float32Array(l.transform))}}};g.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var d=0;d<this.targets.length;++d){var l=
this.targets[d];l.layers&this.layers&&(l.transform=this.target_tranforms[d])}};g.prototype.removeTargetsFromScene=function(){if(this.targets){for(var d=0;d<this.targets.length;++d){var l=this.targets[d];l.layers&this.layers&&l.parentNode&&l.parentNode.removeChild(l)}this.targets=null}};g.prototype.getTargetBaseNodes=function(){function d(A){return-1!=u.indexOf(A)?!0:A.parentNode?d(A.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var l=[],u=this.targets,t=0;t<u.length;++t){var q=
u[t];q.layers&this.layers&&(q.parentNode&&d(q.parentNode)||l.push(q))}return l};g.prototype.applyTransformToTarget=function(d,l){var u=this.getGlobalMatrix(mat4.create()),t=mat4.invert(mat4.create(),u),q=mat4.create(),A=this.getTargetBaseNodes();if(A){for(var H=[1,1,1],I=0;I<A.length;++I){var G=A[I];H[0]=0<=G.scaling[0]?1:-1;H[1]=0<=G.scaling[1]?1:-1;H[2]=0<=G.scaling[2]?1:-1;l?(mat4.multiply(q,d,G.matrix),G.fromMatrix(q)):(G.getGlobalMatrix(q),this.coordinates==g.WORLD_SPACE&&mat4.multiply(q,t,q),
mat4.multiply(q,d,q),this.coordinates==g.WORLD_SPACE&&mat4.multiply(q,u,q),G.fromMatrix(q,!0));vec3.mul(G._scale,G._scale,H);G.position=this.applySnap(G.position);if(this.grid_size){var M=quat.toEuler(vec3.create(),G.rotation);M[0]=15*Math.round(M[0]*RAD2DEG/15)*DEG2RAD;M[1]=15*Math.round(M[1]*RAD2DEG/15)*DEG2RAD;M[2]=15*Math.round(M[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(G.rotation,M);quat.normalize(G.rotation,G.rotation)}}mat4.multiply(q,u,d);this.fromMatrix(q);this.scaling=[1,1,1];this.updateGizmo()}};
g.prototype.applyTranslation=function(d,l){var u=mat4.create();mat4.translate(u,u,d);this.applyTransformToTarget(u,l)};g.prototype.applyRotation=function(d,l,u){var t=mat4.create();if(u){var q=mat4.create();mat4.setTranslation(q,u);mat4.mul(t,t,q);mat4.rotate(t,t,d,l);mat4.setTranslation(q,[-u[0],-u[1],-u[2]]);mat4.mul(t,t,q)}else mat4.rotate(t,t,d,l);this.applyTransformToTarget(t)};g.prototype.applyScale=function(d,l){d.constructor===Number&&(d=[d,d,d]);var u=mat4.create();mat4.scale(u,u,d);this.applyTransformToTarget(u,
l)};g.prototype.applySnap=function(d){if(!this.grid_size)return d;d[0]=Math.round(d[0]/this.grid_size)*this.grid_size;d[1]=Math.round(d[1]/this.grid_size)*this.grid_size;d[2]=Math.round(d[2]/this.grid_size)*this.grid_size;return d};g.prototype.setColor=function(d){if(this.targets)for(var l=0;l<this.targets.length;++l){var u=this.targets[l];u.layers&this.layers&&(u=u.getMaterial())&&(u.color=d)}};g.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var d=
[],l=0;l<this.targets.length;++l){var u=this.targets[l];if(u.layers&this.layers){var t=u.clone(!0);u.parentNode.addChild(t);d.push(u)}}return this.targets=d}};g.prototype.onMouse=function(d){if(this._camera&&this.targets&&!1!==this.visible){var l=this._camera,u=l.getFront(),t=[d.canvasx,d.canvasy],q=l.getRay(t[0],t[1]),A=this.position,H=vec3.sub(vec3.create(),A,l.position);vec3.normalize(H,H);var I=this._selected_action,G=this.actions[I],M=this._global_matrix;l.project(A,null,this.center_2D);var P=
mat4.invert(mat4.create(),M),O=this.coordinates==g.OBJECT_SPACE;if("mousedown"==d.type){if(this.click_2D[0]=this.click_2D2[0]=t[0],this.click_2D[1]=this.click_2D2[0]=t[1],d.is_touch&&this.testMouseOver(d),I=this._selected_action=this._hover_action,G=this.actions[I])G.move&&G.axis?(P=vec3.clone(G.axis),mat4.rotateVec3(P,M,P),vec3.normalize(P,P),this._last=q.closestPointOnRay(A,P),d.shiftKey&&this.cloneTargets()):G.move&&G.normal&&(q.testPlane(A,G.normal)&&(this.click_pos=q.collision_point),d.shiftKey&&
this.cloneTargets()),"drag"==I&&(q.testPlane(A,u),this._last=q.collision_point,d.shiftKey&&this.cloneTargets()),"rotatefront"==I?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,.5*this.size),this.click_2D2.set(this.click_2D)):G.rotate&&(G.axis?(I=mat4.rotateVec3(vec3.create(),M,G.axis),q.testPlane(A,I)&&(vec3.sub(this.click_pos,q.collision_point,A),vec3.normalize(this.click_pos,
this.click_pos),A=vec3.scaleAndAdd(vec3.create(),A,this.click_pos,this.current_size),this.current_2D=this.click_2D=l.project(A))):q.testSphere(A,this.current_size)&&(this._last=q.collision_point,vec3.sub(this.click_pos,q.collision_point,A),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),H,this.click_pos))),this.click_model.set(M),this.click_transform.set(this.transform),this.click_dist=vec3.distance(this.click_2D,this.center_2D),this.saveTargetTransforms()}else if("mousemove"==
d.type)if(d.dragging&&this._selected_action){if("rotatefront"==I)return G=vec2.sub(vec3.create(),t,this.center_2D),vec2.normalize(G,G),A=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,G,.5*this.size),A=Math.atan2(G[0],G[1])-Math.atan2(A[0],A[1]),d.shiftKey&&(A=2*Math.PI*Math.ceil(36*A/(2*Math.PI))/36),A&&(this.restoreTargetTransforms(),this.applyRotation(A,H)),!0;if(G.rotate)return G.axis?(I=mat4.rotateVec3(vec3.create(),M,G.axis),q.testPlane(A,I)&&(d=vec3.sub(vec3.create(),q.collision_point,
A),vec3.normalize(d,d),A=vec3.scaleAndAdd(vec3.create(),A,d,this.current_size),this.current_2D=l.project(A),l=Math.clamp(vec3.dot(d,this.click_pos),-1,1),A=Math.acos(l),d=vec3.cross(vec3.create(),d,this.click_pos),vec3.normalize(d,d),l=vec3.dot(I,d),0<l&&(A*=-1),this.restoreTargetTransforms(),this.applyRotation(A,G.axis))):(P=vec3.cross(vec3.create(),H,this.click_pos),A=.01*(vec2.dist(this.center_2D,t)-this.click_dist),d=vec2.sub(vec2.create(),this.center_2D,t),G=vec2.sub(vec2.create(),this.center_2D,
this.click_2D),0>vec2.dot(d,G)&&(A=-A),console.log(A),this.restoreTargetTransforms(),this.applyRotation(A,P),this.click_axis=P),!0;H=null;if(G.move&&G.normal){if(q.testPlane(A,G.normal)&&(G=q.collision_point,this.applySnap(G),H=vec3.sub(vec3.create(),G,this.click_pos),this.click_pos=G,this.coordinates==g.OBJECT_SPACE))return mat4.rotateVec3(H,P,H),this.applyTranslation(H,!0),!0}else if(G.move||G.scale){l=null;G.axis&&(P=vec3.clone(G.axis),mat4.rotateVec3(P,M,P),vec3.normalize(P,P),l=q.closestPointOnRay(A,
P));if("scale"==I||G.scale&&d.ctrlKey)return d=1+.01*(t[1]-this.click_2D[1]),this.applyScale(d,O),this.click_2D[0]=t[0],this.click_2D[1]=t[1],!0;if("scalexy"==I||"scalexz"==I||"scaleyz"==I){d=1+.01*(t[1]-this.click_2D[1]);switch(I){case "scalexy":this.applyScale([d,d,1],O);break;case "scaleyz":this.applyScale([1,d,d],O);break;case "scalexz":this.applyScale([d,1,d],O)}this.click_2D[0]=t[0];this.click_2D[1]=t[1];return!0}if(G.scale)return d=vec2.distance(t,this.center_2D),G=d/this.click_dist,"scalex"==
I?this.applyScale([G,1,1],O):"scaley"==I?this.applyScale([1,G,1],O):"scalez"==I&&this.applyScale([1,1,G],O),this.click_dist=d,!0;G.move&&(O||this.applySnap(l),H=vec3.sub(vec3.create(),l,this._last),this._last.set(l))}"drag"==I&&(q.testPlane(A,this._camera.getFront()),l=q.collision_point,this.applySnap(l),H=vec3.sub(vec3.create(),l,this._last),this._last=l);if(H)return this.applyTranslation(H),!0}else this.testMouseOver(d);else if("wheel"==d.type){if("scale"==this._selected_action)return d=1+2E-4*
d.wheel,this.applyScale(d),!0;if("drag"==this._selected_action)return H=vec3.sub(vec3.create(),A,l.position),d=1+2E-4*d.wheel,vec3.scaleAndAdd(H,l.position,H,d),vec3.sub(H,H,A),this.applyTranslation(H),this._last=A,!0}if("mouseup"==d.type||this._selected_action&&0==d.buttons)if(this.saveTargetTransforms(),this._selected_action){this._selected_action=null;this.render(this._last_renderer,this._last_camera);this.testMouseOver(d);this.updateGizmo();if(this.onActionFinished)this.onActionFinished();return!0}return!1}};
g.prototype.testMouseOver=function(d){this._hover_action=null;var l=[d.canvasx,d.canvasy],u=1E5;d=null;for(var t in this.actions){var q=this.actions[t];if(q.visible){var A=vec2.distance(q.pos2D,l);A<q.radius*this.size&&A<u&&(u=A,d=t)}}d||(t=vec2.distance(this.center_2D,l),this.actions.rotatefront.visible&&10>Math.abs(t-.5*this.size)?d="rotatefront":this.mode&g.ROTATE&&t<.5*this.size&&(d="rotate"));return this._hover_action=d};g.prototype.cancel=function(){this._selected_action&&(this._selected_action=
null,this.restoreTargetTransforms())};g.prototype.render=function(d){this._last_renderer=d;var l=this._last_camera=d._camera;for(u in this.actions)this.actions[u].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.cube=GL.Mesh.cube({size:1}),gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:.1,height:.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:.02,
outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:.5*Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}));var u=gl.meshes.torus;var t=l.getFront(),q=l.getLocalVector(RD.UP);l.getLocalVector(RD.RIGHT);var A=this._position;E.set(A);E[3]=1;var H=l._projection_matrix[5];this.updateMatrices();f.set(this._global_matrix);var I=vec3.sub(vec3.create(),A,l.position);
vec3.normalize(I,I);this._camera=l;this._unitary_model=f;var G=this._hover_action,M=this._selected_action;M&&(G=M);var P=M?this.actions[M]:null,O=this.mode;mat4.rotateVec3(v,f,RD.RIGHT);mat4.rotateVec3(D,f,RD.UP);mat4.rotateVec3(r,f,RD.FRONT);vec3.normalize(v,v);vec3.normalize(D,D);vec3.normalize(r,r);mat4.fromTranslationFrontTop(m,A,t,q);vec4.transformMat4(E,E,l._viewprojection_matrix);this.current_size=q=gl.canvas.width/gl.canvas.height*this.size*E[3]/(gl.canvas.width*H);mat4.scale(f,f,[q,q,q]);
mat4.scale(m,m,[q,q,q]);q=vec3.dot(I,v);H=vec3.dot(I,D);var U=vec3.dot(I,r),K=vec3.dot(t,RD.RIGHT),W=vec3.dot(t,RD.UP),X=vec3.dot(t,RD.FRONT);this._camera.project(A,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);I=gl.shaders[this.shader];I.uniforms(d._uniforms);I.uniforms(l._uniforms);I.uniforms(this.uniforms);if("movex"==M)mat4.rotateZ(c,f,-Math.PI/2),this.drawAxis(c,
g.XAXIS_COLOR);else if("movey"==M)this.drawAxis(f,g.YAXIS_COLOR);else if("movez"==M)mat4.rotateX(c,f,-Math.PI/2),this.drawAxis(c,g.ZAXIS_COLOR);else if("drag"==M)d.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.XAXIS_COLOR,!0);else if(P&&P.normal&&this.render_move_plane)c.set(f),"movexz"==M?mat4.rotateX(c,c,Math.PI/2):"moveyz"==M&&mat4.rotateY(c,c,Math.PI/2),mat4.scale(c,c,[100,100,100]),I.setUniform("u_model",c),I.setUniform("u_color",[.1,.1,.1,.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),
I.draw(gl.meshes.plane),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==M)mat4.rotateX(c,m,Math.PI/2),I.setUniform("u_model",c),I.draw(u),d.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g.XAXIS_COLOR,!0),d.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,g.XAXIS_COLOR,!0),d.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.XAXIS_COLOR,!0),d.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g.XAXIS_COLOR),d.drawLine2D(this.click_2D2[0],
this.click_2D2[1],this.center_2D[0],this.center_2D[1],4,g.XAXIS_COLOR);else{if("rotate"==M){this.click_axis&&(mat4.fromTranslationFrontTop(c,A,t,this.click_axis),mat4.scale(c,c,[this.current_size,this.current_size,this.current_size]),this.drawAxis(c,g.NOAXIS_COLOR));this.drawRotateSphere(f,g.SPHERE_COLOR);d.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g.NOAXIS_COLOR,!0);return}if(P&&P.rotate){l=P.color||g.XAXIS_COLOR;"rotatex"==M?mat4.rotateZ(c,f,Math.PI/2):"rotatey"==M?mat4.rotateY(c,f,Math.PI/
2):"rotatez"==M&&mat4.rotateX(c,f,Math.PI/2);I.setUniform("u_model",c);I.setUniform("u_color",l);I.draw(u);d.drawCircle2D(this.center_2D[0],this.center_2D[1],2,l,!0);d.drawCircle2D(this.click_2D[0],this.click_2D[1],2,l,!0);d.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,l);d.drawCircle2D(this.current_2D[0],this.current_2D[1],2,l,!0);d.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,l);return}}"scale"==M?(d.drawCircle2D(this.center_2D[0],
this.click_2D[1],2,g.INNERSPHERE_COLOR,!0),d.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.INNERSPHERE_COLOR,!0),d.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g.INNERSPHERE_COLOR)):(this.drawRotateSphere(f,g.STATIC_SPHERE_COLOR),O&g.ROTATE&&"rotate"==G&&this.drawRotateSphere(f,g.SPHERE_COLOR),O&g.ROTATEFRONT&&(mat4.rotateX(c,m,Math.PI/2),I.setUniform("u_model",c),I.setUniform("u_color","rotatefront"==G?g.SELECTED_COLOR:g.RING_COLOR),I.draw(u),this.actions.rotatefront.visible=
!0),.1<Math.abs(q)&&O&g.ROTATEX&&(mat4.rotateZ(c,f,Math.PI/2),0>X&&mat4.rotateX(c,c,Math.PI),0>W&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatex"==G?g.SELECTED_COLOR:g.XAXIS_COLOR,"rotatex")),.1<Math.abs(H)&&O&g.ROTATEY&&(c.set(f),0<K&&0>X?mat4.rotateY(c,c,-Math.PI/2):0>K&&0>X?mat4.rotateY(c,c,Math.PI):0>K&&0<X&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatey"==G?g.SELECTED_COLOR:g.YAXIS_COLOR,"rotatey")),.1<Math.abs(U)&&O&g.ROTATEZ&&(c.set(f),mat4.rotateX(c,c,Math.PI/2),0<K&&0>W?
mat4.rotateY(c,c,-Math.PI/2):0>K&&0>W?mat4.rotateY(c,c,Math.PI):0>K&&0<W&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatez"==G?g.SELECTED_COLOR:g.ZAXIS_COLOR,"rotatez")),.95>Math.abs(q)&&(mat4.rotateZ(c,f,0>K?-Math.PI/2:Math.PI/2),O&g.MOVEX&&this.drawArrow(c,"movex"==G?g.SELECTED_COLOR:g.XAXIS_COLOR,"movex"),O&g.SCALEX&&this.drawScale(c,"scalex"==G?g.SELECTED_COLOR:g.XAXIS_COLOR,"scalex")),.95>Math.abs(H)&&(0<W?mat4.rotateZ(c,f,Math.PI):c.set(f),O&g.MOVEY&&this.drawArrow(c,"movey"==G?g.SELECTED_COLOR:
g.YAXIS_COLOR,"movey"),O&g.SCALEY&&this.drawScale(c,"scaley"==G?g.SELECTED_COLOR:g.YAXIS_COLOR,"scaley")),.95>Math.abs(U)&&(mat4.rotateX(c,f,0>X?-Math.PI/2:Math.PI/2),O&g.MOVEZ&&this.drawArrow(c,"movez"==G?g.SELECTED_COLOR:g.ZAXIS_COLOR,"movez"),O&g.SCALEZ&&this.drawScale(c,"scalez"==G?g.SELECTED_COLOR:g.ZAXIS_COLOR,"scalez")),.2<Math.abs(U)&&(O&g.MOVEXY||O&g.SCALEXY)&&(mat4.translate(c,f,[.45*(0>q?1:-1),.45*(0>H?1:-1),0]),O&g.MOVEXY?this.drawFlat(c,"movexy"==G?g.SELECTED_COLOR:g.XYAXIS_COLOR,"movexy"):
this.drawFlat(c,"scalexy"==G?g.SELECTED_COLOR:g.XYAXIS_COLOR,"scalexy","circle")),.2<Math.abs(H)&&(O&g.MOVEXZ||O&g.SCALEXZ)&&(mat4.rotateX(c,f,Math.PI/2),mat4.translate(c,c,[.45*(0>q?1:-1),.45*(0>U?-1:1),0]),O&g.MOVEXZ?this.drawFlat(c,"movexz"==G?g.SELECTED_COLOR:g.XZAXIS_COLOR,"movexz"):this.drawFlat(c,"scalexz"==G?g.SELECTED_COLOR:g.XZAXIS_COLOR,"scalexz","circle")),.2<Math.abs(q)&&(O&g.MOVEYZ||O&g.SCALEYZ)&&(mat4.rotateY(c,f,Math.PI/2),mat4.translate(c,c,[.45*(0>U?1:-1),.45*(0>H?1:-1),0]),O&g.MOVEYZ?
this.drawFlat(c,"moveyz"==G?g.SELECTED_COLOR:g.YZAXIS_COLOR,"moveyz"):this.drawFlat(c,"scaleyz"==G?g.SELECTED_COLOR:g.YZAXIS_COLOR,"scaleyz","circle")),O&g.DRAG&&this.drawInnerSphere(f,"drag"),O&g.SCALE&&this.drawInnerSphere(f,"scale"),O&g.RESIZE&&this.drawResize(f,"resize"),gl.enable(gl.DEPTH_TEST))}}};g.prototype.drawArrow=function(d,l,u){var t=gl.shaders[this.shader],q=gl.meshes.cone,A=gl.meshes.cylinder,H=this._hover_action;mat4.translate(p,d,[0,1.1,0]);t.setUniform("u_model",p);t.setUniform("u_color",
H==u?g.SELECTED_COLOR:l);t.draw(q);this.mode==g.MOVEALL?(mat4.translate(p,p,[0,-.4,0]),mat4.scale(p,p,[1,1,1])):(mat4.translate(p,p,[0,-.15,0]),mat4.scale(p,p,[1,.5,1]));t.setUniform("u_model",p);t.draw(A);this.toScreen(p,u,[0,.6,0])};g.prototype.drawAxis=function(d,l){var u=gl.shaders[this.shader],t=gl.meshes.sphere;mat4.scale(p,d,[.01,100,.01]);u.setUniform("u_model",p);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);u.setUniform("u_color",
[l[0],l[1],l[2],.2]);gl.depthFunc(gl.GREATER);u.draw(t);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);u.setUniform("u_color",l);u.draw(t);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(d)};g.prototype.drawFlat=function(d,l,u,t){t=gl.meshes[t||"plane"];var q=gl.shaders[this.shader];mat4.scale(c,d,[.25,.25,.25]);q.setUniform("u_color",l);q.setUniform("u_model",c);gl.enable(gl.BLEND);q.draw(t);gl.disable(gl.BLEND);this.toScreen(c,u)};g.prototype.drawRotator=function(d,l,u){var t=gl.meshes.quartertorus,
q=gl.shaders[this.shader];mat4.scale(c,d,[.9,.9,.9]);q.setUniform("u_color",l);q.setUniform("u_model",c);q.draw(t);this.toScreen(c,u,[-.75,0,.75])};g.prototype.drawScale=function(d,l,u){var t=gl.meshes.cylinder,q=gl.meshes.sphere,A=gl.shaders[this.shader];A.setUniform("u_color",l);this.mode==g.SCALEALL?(mat4.translate(c,d,[0,.5,0]),mat4.scale(c,c,[1,1,1])):(mat4.translate(c,d,[0,.25,0]),mat4.scale(c,c,[1,.5,1]));A.setUniform("u_model",c);A.draw(t);mat4.translate(c,d,[0,.4,0]);this.mode==g.SCALEALL?
mat4.scale(c,c,[.1,.1,.1]):mat4.scale(c,c,[.1,.2,.1]);A.setUniform("u_model",c);A.draw(q);this.toScreen(c,u)};g.prototype.drawRotateSphere=function(d,l){var u=gl.shaders[this.shader],t=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(c,d,[.9,.9,.9]);u.setUniform("u_model",c);u.setUniform("u_color",l);u.draw(t);gl.disable(gl.BLEND)};g.prototype.drawInnerSphere=function(d,l){var u=gl.shaders[this.shader],t=gl.meshes.sphere,q=this._hover_action;mat4.scale(c,
d,[.1,.1,.1]);u.setUniform("u_model",c);u.setUniform("u_color",q==l?g.SELECTED_COLOR:g.INNERSPHERE_COLOR);u.draw(t);"drag"==l&&(mat4.scale(c,d,[.07,.07,.07]),u.setUniform("u_model",c),u.setUniform("u_color",q==l?g.INNERSPHERE_COLOR:[0,0,0,1]),u.draw(t));l&&this.toScreen(c,l)};g.prototype.drawResize=function(d,l){};g.prototype.computeBounding=function(d){d=d||BBox.create();for(var l=0;l<this.targets.length;++l){var u=this.targets[l].updateBoundingBox();0==l?BBox.copy(d,u):BBox.merge(d,d,u)}return d};
g.prototype.renderOutline=function(d,l,u,t){if((t=t||this.targets)&&t.length){var q=this.layers;t=t.filter(function(M){return M.layers&q});var A=gl.viewport_data[2],H=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==A&&this._selection_buffer.height==H||(this._selection_buffer=new GL.Texture(A,H,{magFilter:gl.NEAREST}));g.outline_material||(g.outline_material=new RD.Material({shader_name:"flat"}));var I=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,
0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);d.shader_overwrite=I;var M=d.onNodeShaderUniforms;d.onNodeShaderUniforms=function(O,U){U.setUniform("u_color",[1,1,1,1])};var P=d.pipeline;d.pipeline=null;d.overwrite_material=RD.Gizmo.outline_material;d.render(l,u,t);d.shader_overwrite=null;d.onNodeShaderUniforms=M;d.pipeline=P;d.overwrite_material=null});var G=gl.shaders.outline;G||=gl.shaders.outline=GL.Shader.createFX("\n\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n");gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(G,{u_color:[1,1,1,1],u_res:[1/A,1/H]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};g.prototype.renderCameraGizmo=function(d,l){this.drawInnerSphere};g.prototype.toScreen=function(d,l,u){l=this.actions[l];mat4.multiplyVec3(l.pos,d,u||[0,0,0]);this._camera.project(l.pos,g.full_viewport,l.pos2D);l.visible=!0};extendClass(g,RD.SceneNode);RD.Gizmo=g})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,convert_skeletons:!1,overwrite_materials:!0,rename_assets:!1,prefabs:{},meshes:{},
texture_options:{format:GL.RGBA,magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT,no_flip:!1},supports_anisotropy:!1,force_anisotropy:!1,nodes_by_index:{},load:function(w,g,z,n){function f(l){function u(A){var H=this.buffer;H.data=A;H.dataview=new Uint8Array(A);l.length?f(l):m()}var t=l.pop(),q=E+"/"+t.uri;"blob:"==t.uri.substr(0,5)&&(q=t.uri);"data:"==t.uri.substr(0,5)?(q=_base64ToArrayBuffer(t.uri.substr(37)),u.call({buffer:t},q)):fetch(q).then(function(A){return A.arrayBuffer()}).then(u.bind({buffer:t}))}
function m(){v.filename=D;v.folder=E;v.url=w;RD.GLTF.parseBuffers(v,d);var l=RD.GLTF.parse(v),u=l.serialize();RD.GLTF.prefabs[w]=u;g&&g(l)}function r(l){"gltf"==z?(v=l,f(v.buffers.concat())):"glb"==z&&((v=RD.GLTF.parseGLB(l))?m():console.error("error parsing GLB:",D))}if(!w)throw"url missing";var v=null,D="",E="";"undefined"!==typeof gl&&(this.meshes=gl.meshes,gl.extensions.EXT_texture_filter_anisotropic&&(this.supports_anisotropy=!0));if(w.constructor===String)if(E=w.split("/"),D=E.pop(),z=z||D.split(".").pop().toLowerCase(),
E=E.join("/"),"undefined"!==typeof fs){var c=new Uint8Array(fs.readFileSync(w,{}).buffer);r(c.buffer)}else{var p=new XMLHttpRequest;p.onload=function(){200!=this.status?(console.error("GLTF not found",w),g&&g(null)):r(p.response)};p.onerror=function(){console.error("Network Error");g&&g(null)};n&&(p.onprogress=function(l){n(w,l.loaded,l.total)});p.responseType="gltf"==z?"json":"arraybuffer";p.open("GET",w);p.send()}else{var d=w;if(D=d.main)w=D,c=d[D],"glb"==c.extension?(v=RD.GLTF.parseGLB(c.data))&&
m():(v=c.data,this.parseBuffers(v),m())}},parseBuffers:function(w,g){for(var z=0;z<w.buffers.length;++z){var n=w.buffers[z];if(!n.data){if(n.uri&&"data:"==n.uri.substr(0,5)){var f=n.uri.indexOf(",");n.data=_base64ToArrayBuffer(n.uri.substr(f+1))}else{if(!g)throw"missing data in glb";n.data=g[n.uri].data}n.dataview=new Uint8Array(n.data)}}},parseGLB:function(w){var g=new Uint8Array(w),z=new DataView(w);if(1179937895!=z.getUint32(0,!0))return console.error("incorrect gltf header"),null;var n=z.getUint32(4,
!0);console.log("GLTF Version: "+n);z.getUint32(8,!0);n=12;for(var f=null,m=0;n<g.length;){var r=z.getUint32(n,!0),v=z.getUint32(n+4,!0),D=w.slice(n+8,n+8+r);n+=8+r;if(v==RD.GLTF.JSON_CHUNK){if("undefined"===typeof TextDecoder)throw"Sorry, this browser does not support TextDecoder...";f=(new TextDecoder("utf-8")).decode(D);f=JSON.parse(f)}else v==RD.GLTF.BINARY_CHUNK?(r=f.buffers[m],r.data=D,r.dataview=new Uint8Array(D),m++):console.warn("gltf unknown chunk type: ","0x"+v.toString(16))}return f},
parse:function(w,g){console.log(w);w.url||(w.url=g||"scene.glb");g={};this.nodes_by_index={};1<w.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var z=w.scenes[w.scene||0].nodes;this.gltf_materials={};if(w.buffers&&w.buffers.length)for(var n=0;n<w.buffers.length;++n){var f=w.buffers[n];f.uri&&!f.data&&"data:"==f.uri.substr(0,5)&&(f.data=_base64ToArrayBuffer(f.uri.substr(37)),f.dataview=new Uint8Array(f.data))}if(w.skins)for(n=0;n<w.skins.length;++n){f=
w.skins[n];for(var m=0;m<f.joints.length;++m)w.nodes[f.joints[m]]._is_joint=!0}f=null;1<z.length&&(f=new RD.SceneNode,f.name="root");for(n=0;n<w.nodes.length;++n){var r=w.nodes[n];m=r.extensions&&r.extensions.KHR_lights_punctual?new RD.Light:new RD.SceneNode;r.name&&(m.name=r.name);this.nodes_by_index[n]=m}for(n=0;n<z.length;++n)r=z[n],m=this.nodes_by_index[r],RD.GLTF.parseNode(m,r,w),f||=m,1<z.length&&f.addChild(m),m.id=w.url.replace(/\//gi,"_")+"::node_"+r,g[m.id]=g[n]=m;if(w.animations&&w.animations.length){if(RD.Animation)for(f.animations=
[],n=0;n<w.animations.length;++n)z=this.parseAnimation(n,w,g),z.id=w.filename+"::"+z.name,z&&(RD.Animations[z.id]=z,f.animations.push(z));else console.error("you must include rendeer-animation.js to allow animations");this.convert_skeletons&&this.convertSkinToSkeleton(f,f)}f.materials=this.gltf_materials;f.meta={asset:w.asset};return f},parseNode:function(w,g,z){var n=z.nodes[g];w=n.extensions&&n.extensions.KHR_lights_punctual?w||new RD.Light:w||new RD.SceneNode;for(var f in n){var m=n[f];switch(f){case "name":w.name=
m;break;case "translation":w.position=m;break;case "rotation":w.rotation=m;break;case "scale":w.scaling=m;var r=0;0>w.scaling[0]&&r++;0>w.scaling[1]&&r++;0>w.scaling[2]&&r++;1==r%2&&(w.flags.frontFace=GL.CW);break;case "matrix":w.fromMatrix(m);0>mat4.determinant(m)&&(w.flags.frontFace=GL.CW);break;case "mesh":if(m=RD.GLTF.parseMesh(m,z)){w.mesh=m.name;w.primitives=[];for(r=0;r<m.info.groups.length;++r){var v=m.info.groups[r],D=null;null!=v.material&&(D=this.parseMaterial(v.material,z));w.primitives.push({index:r,
material:D?D.name:null,mode:v.mode});!w.material&&D&&(w.material=D.name)}m.morphs&&(w.morphs=m.morphs.map(E=>({name:E.name,weight:E.weight})))}break;case "skin":w.skin=this.parseSkin(m,z);break;case "camera":w.camera=z.cameras[m];break;case "children":if(m.length)for(r=0;r<m.length;++r)v=RD.GLTF.parseNode(null,m[r],z),w.addChild(v);break;case "extras":case "extra":w.extras=m;break;case "extensions":m.KHR_lights_punctual&&this.parseLight(w,z.extensions.KHR_lights_punctual.lights[m.KHR_lights_punctual.light]);
break;default:"_"!=f[0]&&console.log("gltf node info ignored:",f,n[f])}}if(w.mesh&&w.skin)for(m=this.meshes[w.mesh],m.bones=[],r=0;r<w.skin.joints.length;++r)m.bones.push([w.skin.joints[r],w.skin.bindMatrices[r]]);n.name||(n.name=w.name="node_"+g);n._is_joint&&(w.is_joint=!0);return w},parseLight:function(w,g){w.color=g.color?g.color:[1,1,1];null!=g.intensity&&vec3.scale(w.color,w.color,g.intensity/1E3);"spot"===g.type?w.light_type=RD.SPOT_LIGHT:"point"===g.type?w.light_type=RD.POINT_LIGHT:"directional"===
g.type&&(w.light_type=RD.DIRECTIONAL_LIGHT);g.spot&&(w.cone_start=g.spot.innerConeAngle*RAD2DEG*2,w.cone_end=g.spot.outerConeAngle*RAD2DEG*2);null!=g.range&&(w.max_distance=g.range)},parseMesh:function(w,g){for(var z=g.meshes[w],n=this.meshes,f=[],m=[],r=0,v=0;v<z.primitives.length;++v){var D=z.primitives[v],E=this.parsePrimitive(D,g);if(E){E.start=r;r+=E.length;m.push(E);var c={vertexBuffers:{},indexBuffers:{}},p;for(p in E.buffers){var d=p;"bones"==d&&(d="bone_indices");"indices"==d||"triangles"==
d?c.indexBuffers[d]={data:E.buffers[p]}:c.vertexBuffers[d]={data:E.buffers[p]}}f.push({mesh:c});if(D.targets){c.morphs=[];for(let q=0;q<D.targets.length;++q){E=D.targets[q];d={name:"",weight:0,buffers:{}};z.extras&&z.extras.targetNames&&(d.name=z.extras.targetNames[q]);z.weights&&(d.weight=z.weights[q]);for(var l in this.buffer_names){var u=this.buffer_names[l],t=E[l];null!=t&&(t=this.parseAccessor(t,g,!1))&&(d.buffers[u]=t)}c.morphs.push(d)}}}}r=null;1<f.length?r=GL.Mesh.mergeMeshes(f):1==f.length&&
(v=f[0].mesh,r=new GL.Mesh(v.vertexBuffers,v.indexBuffers),r.info&&v.info&&(r.info=v.info),r.morphs=v.morphs);if(!r)return null;for(v=0;v<z.primitives.length;++v)(f=r.info.groups[v])||(r.info.groups[v]=f={}),E=z.primitives[v],f.material=E.material,f.mode=null!=E.mode?E.mode:4,f.start=m[v].start,f.length=m[v].length;r.name=z.name+"_"+w;if(!r.name||this.rename_assets)r.name=g.filename+"::mesh_"+(z.name||w);r.updateBoundingBox();r.computeGroupsBoundingBoxes();return n[r.name]=r},parsePrimitive:function(w,
g){var z={buffers:{}},n=z.buffers;if(w.extensions)if(w.extensions.KHR_draco_mesh_compression){if("undefined"==typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";n=z.buffers=this.decompressDraco(w,g);if(!n)return null}else throw"mesh data is compressed, this importer does not support it yet";else{null==!w.attributes.POSITION&&console.warn("gltf mesh without positions");for(var f in this.buffer_names){var m=this.buffer_names[f],r=w.attributes[f];if(null!=
r){var v=this.parseAccessor(r,g,this.flip_uv&&("coords"==m||"coords1"==m));v&&("COLOR_0"===f&&(v=this.convertVertexColor(v,g.accessors[r])),n[m]=v)}}null!=w.indices&&(n.triangles=this.parseAccessor(w.indices,g))}if(!n.vertices)return console.error("primitive without vertices"),null;z.mode=w.mode;z.material=w.material;z.start=0;z.length=n.triangles?n.triangles.length:n.vertices.length/3;return z},parseAccessor:function(w,g,z,n,f){var m=g.accessors[w];if(!m)return console.warn("gltf accessor not found"),
null;f=this.numComponents[m.type];if(!f)return console.warn("gltf accessor of unknown type:",m.type),null;var r=this.createTypedBuffer(m.componentType,m.count*f);if(void 0!==m.bufferView){n=g.bufferViews[m.bufferView];if(!n)return console.warn("gltf bufferView not found"),null;w=g.buffers[n.buffer];if(!w||!w.data)return console.warn("gltf buffer not found or data not loaded"),null;g=new Uint8Array(r.buffer);null==n.byteOffset&&(n.byteOffset=0);var v=n.byteOffset+(m.byteOffset||0);if(n.byteStride&&
n.byteStride!=f*r.BYTES_PER_ELEMENT){g=f*r.BYTES_PER_ELEMENT;v=w.dataview.subarray(v,v+n.byteLength);for(var D=new r.constructor(f),E=new Uint8Array(D.buffer),c=w=0;c<m.count;++c)E.set(v.subarray(w,w+g)),r.set(D,c*f),w+=n.byteStride}else v=w.dataview.subarray(v,v+g.length),g.set(v)}else if(m.sparse){if(m.sparse.indices.componentType===RD.GLTF.UNSIGNED_INT)n=new Uint32Array(m.sparse.count);else if(m.sparse.indices.componentType===RD.GLTF.UNSIGNED_SHORT)n=new Uint16Array(m.sparse.count);else if(m.sparse.indices.componentType===
RD.GLTF.UNSIGNED_BYTE)n=new Uint8Array(m.sparse.count);else throw"indices in gltf in wrong format";w=this.parseBufferView(g,m.sparse.indices.bufferView);w=new Uint8Array(w);w=new n.constructor(w.buffer);n.set(w);v=this.createTypedBuffer(m.componentType,m.sparse.count*f);m=this.parseBufferView(g,m.sparse.values.bufferView);m=new Uint8Array(m);m=new v.constructor(m.buffer);v.set(m);for(g=0;g<n.length;++g)w=n[g],m=v.subarray(g*f,(g+1)*f),r.set(m,w*f)}if(z)for(c=1;c<r.length;c+=f)r[c]=1-r[c];return r},
parseBufferView:function(w,g){g=w.bufferViews[g];if(!g)return console.warn("gltf bufferView not found"),null;w=w.buffers[g.buffer];return w&&w.data?new Uint8Array(w.data,g.byteOffset||0,g.byteLength):(console.warn("gltf buffer not found or data not loaded"),null)},createTypedBuffer:function(w,g){switch(w){case RD.GLTF.FLOAT:return new Float32Array(g);case RD.GLTF.UNSIGNED_INT:return new Uint32Array(g);case RD.GLTF.SHORT:return new Int16Array(g);case RD.GLTF.UNSIGNED_SHORT:return new Uint16Array(g);
case RD.GLTF.BYTE:return new Int8Array(g);case RD.GLTF.UNSIGNED_BYTE:return new Uint8Array(g)}console.warn("gltf accessor of unsupported type: ",w);return new Float32Array(g)},installDracoModule:function(w){var g=this.draco_data_types={},z=this;this.decoderModule?w&&w(this.decoderModule):"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(n){var f=z.decoderModule=n;g[f.DT_INT8]=Int8Array;g[f.DT_UINT8]=Uint8Array;g[f.DT_INT16]=Int16Array;g[f.DT_UINT16]=Uint16Array;g[f.DT_INT32]=
Int32Array;g[f.DT_UINT32]=Uint32Array;g[f.DT_FLOAT32]=Float32Array;w&&w(n)}):console.error("Draco3D not installed")},decompressDraco:function(w,g){if(!this.decoderModule||!this.decoderModule.Decoder)return console.warn("Mesh with DRACO encoding, DRACO Decoder Module not found"),null;this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,w,g)},decodePrimitive:function(w,g,z){var n={};g=z.buffers[z.bufferViews[g.extensions.KHR_draco_mesh_compression.bufferView].buffer];
var f=g.dataview.buffer;z=this.decoderModule;g=new z.DecoderBuffer;g.Init(new Int8Array(f),f.byteLength);if(w.GetEncodedGeometryType(g)==z.TRIANGULAR_MESH){var m=new z.Mesh;f=w.DecodeBufferToMesh(g,m);if(!f.ok()||0===m.ptr)throw Error("GLTF Draco: Decoding failed: "+f.error_msg());m.num_points();for(var r in this.buffer_names){f=this.buffer_names[r];var v=r;"COLOR_0"==v?v="COLOR":"TEXCOORD_0"==v&&(v="TEX_COORD");if(v=this.decodeBuffer(m,z[v],"coords"==f||"coords1"==f,w))n[f]=v.data}r=3*m.num_faces();
f=4*r;v=z._malloc(f);w.GetTrianglesUInt32Array(m,f,v);n.triangles=(new Uint32Array(z.HEAPF32.buffer,v,r)).slice();z._free(v)}z.destroy(g);z.destroy(m);return n},decodeBuffer:function(w,g,z,n){if(null==g)return null;var f=this.decoderModule;g=n.GetAttributeId(w,g);if(-1==g)return null;var m=n.GetAttribute(w,g);g=m.data_type();var r=m.num_components(),v=w.num_points();m.size();var D=v*r,E=this.draco_data_types[g];f=new f.DracoFloat32Array;n.GetAttributeFloatForAllPoints(w,m,f);w=new E(D);for(n=0;n<
w.length;++n)w[n]=f.GetValue(n);if(z)for(n=1;n<w.length;n+=r)w[n]=1-w[n];return{num_points:v,num_comps:r,data_type:g,data:w}},parseMaterial:function(w,g){var z=g.materials[w];if(!z)return console.warn("gltf material not found"),null;var n=z.name;if(!n||this.rename_assets)n=g.filename+"::mat_"+(z.name||w);if((w=RD.Materials[n])&&(!this.overwrite_materials||w.from_filename==g.filename))return w;w=new RD.Material;w.name=n;w.from_filename=g.filename;null!=z.alphaMode&&(w.alphaMode=z.alphaMode);w.alphaCutoff=
null!=z.alphaCutoff?z.alphaCutoff:.5;null!=z.doubleSided&&(w.flags.two_sided=z.doubleSided);w.normalmapFactor=1;z.pbrMetallicRoughness&&(w.model="pbrMetallicRoughness",w.color.set([1,1,1]),w.opacity=1,w.metallicFactor=1,w.roughnessFactor=1,null!=z.pbrMetallicRoughness.baseColorFactor&&(w.color=z.pbrMetallicRoughness.baseColorFactor),z.pbrMetallicRoughness.baseColorTexture&&(w.textures.albedo=this.parseTexture(z.pbrMetallicRoughness.baseColorTexture,g),"MASK"==w.alphaMode&&this.supports_anisotropy&&
RD.GLTF.force_anisotropy&&(n=gl.textures[w.textures.albedo.texture]))&&(n.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8)),null!=z.pbrMetallicRoughness.metallicFactor&&(w.metallicFactor=z.pbrMetallicRoughness.metallicFactor),null!=z.pbrMetallicRoughness.roughnessFactor&&(w.roughnessFactor=z.pbrMetallicRoughness.roughnessFactor),z.pbrMetallicRoughness.metallicRoughnessTexture&&(w.textures.metallicRoughness=this.parseTexture(z.pbrMetallicRoughness.metallicRoughnessTexture,
g)));z.occlusionTexture&&(w.textures.occlusion=this.parseTexture(z.occlusionTexture,g));z.normalTexture&&(w.textures.normal=this.parseTexture(z.normalTexture,g));z.emissiveTexture&&(w.textures.emissive=this.parseTexture(z.emissiveTexture,g));z.emissiveFactor&&(w.emissive=z.emissiveFactor);z.extensions&&z.extensions.KHR_materials_emissive_strength&&w.emissive&&vec3.scale(w.emissive,w.emissive,z.extensions.KHR_materials_emissive_strength.emissiveStrength);z.extras&&(w.extras=z.extras);RD.Materials[w.name]&&
console.debug("Material overwritten: "+w.name);RD.Materials[w.name]=w;return this.gltf_materials[w.name]=w},parseTexture:function(w,g){var z=g.textures[w.index];if(!z)return console.warn("gltf texture not found"),null;if("undefined"===typeof gl)return null;var n=g.images[z.source];if(n.uri){var f=n.uri;f.split(".").pop()}else{f=g.url.replace(/[\/\.:]/gi,"_")+"_image_"+w.index;var m=n.mimeType?n.mimeType.split("/").pop():"png";f+="."+m}var r={};if(!gl.textures[f])if(n.uri){var v=n.uri;if("data:"==
v.substr(0,5)){var D=n.uri.indexOf(","),E=n.uri.substr(5,D);m=E.split("/").pop().toLowerCase();f=g.folder+"/"+v+"image_"+w.index+"."+m;m=_base64ToArrayBuffer(n.uri.substr(D+1));E=URL.createObjectURL(new Blob([m],{type:E}));E=GL.Texture.fromURL(E,this.texture_options);E.name=f;gl.textures[f]=E}else"blob:"==v.substr(0,5)?r.texture=v:r.texture=g.folder+"/"+v}else null!=n.bufferView&&(E=g.bufferViews[n.bufferView],null==E.byteOffset&&(E.byteOffset=0),m=g.buffers[E.buffer].data.slice(E.byteOffset,E.byteOffset+
E.byteLength),E=URL.createObjectURL(new Blob([m],{type:n.mimeType})),E=GL.Texture.fromURL(E,this.texture_options),E.name=f,gl.textures[f]=E,g.asset&&g.asset.low_quality&&(n=g.folder+"/"+g.filename.replace(/\.[^/.]+$/,"")+"/"+n.name,g.asset.hd_textures||(g.asset.hd_textures={}),g.asset.hd_textures[f]=n));r.texture||(r.texture=f);null!=z.sampler&&(g=g.samplers[z.sampler],null!=g.magFilter&&(r.magFilter=g.magFilter),null!=g.minFilter&&(r.minFilter=g.minFilter));w.texCoord&&(r.uv_channel=w.texCoord);
return r},parseSkin:function(w,g){w=g.skins[w];var z={};null!=w.skeleton&&(z.skeleton_root=g.nodes[w.skeleton].name);var n=this.parseAccessor(w.inverseBindMatrices,g);if(!n)return console.warn("accessor is null"),null;z.bindMatrices=this.splitBuffer(n,16);z.joints=[];for(n=0;n<w.joints.length;++n){var f=w.joints[n],m=g.nodes[f],r=m.id||m.name;r||(r=this.nodes_by_index[f],r.name||(r.name="Node_"+f),r=m.name=r.name);z.joints.push(r)}return z},convertSkinToSkeleton:function(w,g){if(w.skin){var z=g.findNodeByName(w.skin.skeleton_root);
w.skeleton||(w.skeleton=new RD.Skeleton);w.skeleton.importSkeleton(z||g)}for(z=0;z<w.children.length;++z)this.convertSkinToSkeleton(w.children[z],g)},splitBuffer:function(w,g){w||console.warn("buffer is null");for(var z=w.length,n=[],f=0;f<z;f+=g)n.push(new w.constructor(w.subarray(f,f+g)));return n},convertVertexColor:function(w,g){if("VEC4"===g.type)return w;var z="VEC4"===g.type?4:3,n=new Uint8Array(4*g.count),f=1;g.componentType===GL.FLOAT&&(f=255);for(let m=0;m<w.length;m+=z)g=4*Math.floor(m/
z),n[g]=w[m]*f,n[g+1]=w[m+1]*f,n[g+2]=w[m+2]*f,n[g+3]=4===z?w[m+3]*f:f;return n},parseAnimation:function(w,g,z){z=g.animations[w];var n=new RD.Animation;n.name=z.name||"anim_"+w;for(var f=w=0;f<z.channels.length;++f){var m=new RD.Animation.Track,r=z.channels[f],v=z.samplers[r.sampler];m.target_node=g.nodes[r.target.node].name;m.target_property=r.target.path.toLowerCase();if(r=this.rename_animation_properties[m.target_property])m.target_property=r;r=this.parseAccessor(v.input,g);var D=this.parseAccessor(v.output,
g);if(D){var E=g.accessors[v.output],c=E.type,p=RD.TYPES[c];p==RD.VEC4&&"rotation"==m.target_property&&(p=RD.QUAT);m.type=p;if("CUBICSPLINE"===v.interpolation){v=r.length;p=new D.constructor(D.length/3);var d=p.length/v;for(let u=0;u<v;++u){var l=D.subarray(d+u*d*3,d+u*d*3+d);p.set(l,u*d)}D=p}if(v=D.length/r.length){c=r.length;p=new Float32Array((1+v)*c);for(d=0;d<c;++d)p[d*(1+v)]=r[d],l=D.subarray(d*v,d*v+v),p.set(l,d*(1+v)+1);m.data=p;m.packed_data=!0;m.num_components="SCALAR"===E.type&&1<v?v:1;
w=Math.max(w,r[r.length-1]);n.addTrack(m)}else console.warn("gltf unknown type:",c)}else console.warn("animation accedor missing")}n.duration=w||.04;return n},loadFromFiles:function(w,g){function z(p){var d=p.target.result,l=this.extension;const u=m.texture_options.magFilter,t=m.texture_options.minFilter;"gltf"==l?(d=JSON.parse(d),n.main=this.filename):"glb"==l?n.main=this.filename:"bin"==l?r.push(this.filename):"jpeg"!=l&&"jpg"!=l&&"png"!=l&&"webp"!=l||"undefined"===typeof gl||(p=URL.createObjectURL(new Blob([d],
{type:p.target.mimeType})),l=GL.Texture.fromURL(p,{wrap:gl.REPEAT,extension:l,magFilter:u,minFilter:t}),l.name=this.filename,gl.textures[l.name]=l,gl.textures["/textures/"+l.name]&&(gl.textures["/textures/"+l.name]=l));n[this.filename]={filename:this.filename,data:d,extension:this.extension};f--;0==f&&(n.binaries=r,m.load(n,function(q){g&&g(q)}))}for(var n={},f=w.length,m=this,r=[],v=0;v<w.length;++v){var D=w[v],E=new FileReader,c=D.name.split(".");c=c[c.length-1].toLowerCase();E.onload=z;E.filename=
D.name;E.extension=c;"gltf"==c?E.readAsText(D):E.readAsArrayBuffer(D)}},removeRootPathFromTextures:function(w,g,z){if(g)for(var n in w){g=w[n];for(var f in g.textures)if(z=g.textures[f])z.constructor===String&&0==z.indexOf(ROOM.root_path)&&-1!=z.texture.indexOf("/")?z.substr(ROOM.root_path.length):z.texture&&0==z.texture.indexOf(ROOM.root_path)&&-1!=z.texture.indexOf("/")&&(z.texture=z.texture.substr(ROOM.root_path.length))}},encodeGLTF:function(w,g){function z(q,A){A=A.data?A.data:A;var H=A.length,
I=1,G=n.FLOAT;A.constructor===Uint32Array?(G=n.UNSIGNED_INT,q="SCALAR"):A.constructor===Uint16Array?(G=n.UNSIGNED_SHORT,q="SCALAR"):"TEXCOORD_0"==q||"TEXCOORD_1"==q?(I=2,q="VEC2"):(I=3,q="VEC3");H/=I;var M=Array.from(A.subarray(0,I));var P=Array.from(A.subarray(0,I));for(var O=0;O<A.length;O++)M[O%I]=Math.min(A[O],M[O%I]),P[O%I]=Math.max(A[O],P[O%I]);A={bufferView:f.push(A)-1,byteOffset:0,componentType:G,count:H,type:q,max:P,min:M};return m.accessors.push(A)-1}var n=WebGL2RenderingContext,f=[],m=
{accessors:[],asset:{generator:"RendeerJS",version:"2.0"},bufferViews:[],buffers:[{}],meshes:[],nodes:[],scene:0,scenes:[{nodes:[0]}]},r=0;g=[];var v=0,D=[];w=w.root.getAllChildren([w.root]);for(var E=0;E<w.length;++E){var c=w[E];c._index_in_glb=E;var p=c.mesh?this.meshes[c.mesh]:null;if(p&&null==p._index_in_glb){p._index_in_glb=r++;g[p._index_in_glb]=p;p._glb_attributes={};p._glb_attributes.POSITION=z("POSITION",p.vertexBuffers.vertices);if(p.vertexBuffers.normals){for(var d=0;d<p.vertexBuffers.normals.data.length;d+=
3){var l=p.vertexBuffers.normals.data.subarray(d,d+3);vec3.normalize(l,l)}p._glb_attributes.NORMAL=z("NORMAL",p.vertexBuffers.normals)}p.vertexBuffers.coords&&(p._glb_attributes.TEXCOORD_0=z("TEXCOORD_0",p.vertexBuffers.coords));p.vertexBuffers.coords1&&(p._glb_attributes.TEXCOORD_1=z("TEXCOORD_1",p.vertexBuffers.coords1));p.indexBuffers.triangles&&(p._glb_indices=z("INDICES",p.indexBuffers.triangles));if(p.indexBuffers.triangles&&p.info&&p.info.groups){l=p.indexBuffers.triangles;var u=[];for(d=0;d<
p.info.groups.length;++d){var t=p.info.groups[d];t=new l.data.constructor(l.data.subarray(t.start,t.start+t.length));t=z("INDICES",t);u.push(t)}p._glb_indices_group=u}}c.material&&(c=RD.Materials[c.material])&&null==c._index_in_glb&&(c._index_in_glb=v++,D[c._index_in_glb]=c)}for(E=0;E<w.length;++E){c=w[E];r={};c.name&&(r.name=c.name);if(c.mesh&&(v=RD.Materials[c.material],p=this.meshes[c.mesh])){if(c.primitives&&c.primitives.length){d={primitives:[]};for(u=0;u<c.primitives.length;++u){l={attributes:p._glb_attributes,
mode:n.TRIANGLES};if(t=RD.Materials[c.primitives[E].material]||v)l.material=t._index_in_glb;null!=p._glb_indices_group[u]&&(l.indices=p._glb_indices_group[u]);d.primitives.push(l)}u=m.meshes.length}else u=m.meshes.length,l={attributes:p._glb_attributes,mode:n.TRIANGLES},v&&(l.material=v._index_in_glb),d={primitives:[l]},null!=c.submesh&&p._glb_indices_group?l.indices=p._glb_indices_group[c.submesh]:null!=p._glb_indices&&(l.indices=p._glb_indices);m.meshes.push(d);r.mesh=u}Object.keys(c.extras).length&&
(r.extras=c.extras);if(c.children&&c.children.length)for(r.children=[],d=0;d<c.children.length;d++)r.children.push(c.children[d]._index_in_glb);p=mat4.create();for(d=0;16>d;++d)if(c._local_matrix[d]!=p[d]){r.matrix=typedArrayToArray(c._local_matrix);break}m.nodes[E]=r}if(D.length)for(m.materials=[],E=0;E<D.length;E++)c=D[E],m.materials[E]={alphaMode:"OPAQUE",doubleSided:c.flags.two_sided,emissiveFactor:[0,0,0],pbrMetallicRoughness:{baseColorFactor:Array.from(c.color)}};for(E=D=c=0;E<f.length;E++)c+=
f[E].byteLength;m.buffers[0].byteLength=c;c=new Uint8Array(c);for(E=0;E<f.length;E++){p=f[E];r=new Uint8Array(p.buffer);c.set(r,D);v={buffer:0,byteOffset:D,byteLength:r.byteLength};if(p.constructor===Float32Array)v.target=n.ARRAY_BUFFER;else if(p.constructor===Uint16Array||p.constructor===Uint32Array)v.target=n.ELEMENT_ARRAY_BUFFER;m.bufferViews.push(v);D+=r.byteLength}for(E=0;E<g.length;++E)delete g[E]._glb_indices,delete g[E]._index_in_glb,delete g[E]._glb_attributes;for(E=0;E<w.length;++E)delete w[E]._index_in_glb;
return{json:m,binary:c}},encodeGLB:function(w,g){w=JSON.stringify(w);var z=(new TextEncoder).encode(w);w=4*Math.ceil(z.byteLength/4);var n=4*Math.ceil(g.byteLength/4),f=new Uint8Array(20+w+8+n),m=new DataView(f.buffer);m.setUint32(0,1179937895,!0);m.setUint32(4,2,!0);m.setUint32(8,f.byteLength,!0);var r=12;m.setUint32(r,w,!0);m.setUint32(r+4,RD.GLTF.JSON_CHUNK,!0);f.set(z,r+8);for(z=z.byteLength;z<w;++z)f[r+8+z]=32;r+=8+w;m.setUint32(r,n,!0);m.setUint32(r+4,RD.GLTF.BINARY_CHUNK,!0);f.set(g,r+8);return f}};
RD.SceneNode.prototype.loadGLTF=function(w,g,z){function n(m){f.loading=!1;m.updateGlobalMatrix(!1,!0);m&&f.addChild(m);g&&g(f,m)}var f=this;RD.GLTF.prefabs[w]&&!z?(z=new RD.SceneNode,z.configure(RD.GLTF.prefabs[w]),n(z)):(this.loading=!0,RD.GLTF.load(w,n))};function _base64ToArrayBuffer(w){w=window.atob(w);for(var g=w.length,z=new Uint8Array(g),n=0;n<g;n++)z[n]=w.charCodeAt(n);return z.buffer}"undefined"!=typeof DracoDecoderModule&&RD.GLTF.installDracoModule(RD.GLTF.onReady);
(function(w){function g(n){this.renderer=n;this.mode=g.FORWARD;this.visible_layers=65535;this.bgcolor=vec4.fromValues(.1,.1,.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.emissive_factor=this.occlusion_gamma=this.occlusion_factor=this.exposure=this.environment_factor=1;this.postfx_shader_name=null;this.timer_queries_enabled=!0;this.brightness=this.contrast=1;this.gamma=2.2;this.parallax_reflection=!1;
this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=mat4.create();this.texture_matrix=mat3.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.skip_background=this.single_pass=!1;this.allow_instancing=!0;this.debug_instancing=!1;this.use_rendertexture=!0;this.alpha_composite_target_texture=this.fx=null;this.frame_time=-1;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_occlusion_gamma:this.occlusion_gamma,
u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_gamma:this.gamma,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_viewport:gl.viewport_data,u_camera_perspective:1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec3.fromValues(0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),u_backface_color:vec3.fromValues(.5,
.5,.5),u_normalFactor:1,u_metallicRough:!1,u_reflectance:.1,u_texture_matrix:this.texture_matrix,u_displacement_factor:0,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:.5,u_isAnisotropic:!1,u_anisotropy:.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this._instancing_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.current_camera=this.final_fbo=this.final_texture=
null;this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new z.Material;this.onRenderBackground=null}var z=w.RD;g.FORWARD=1;g.DEFERRED=2;g.MACROS={UVS2:1,COLOR:2,POINTS:4,INSTANCING:8,SKINNING:16,MORPHTARGETS:32,PARALLAX_REFLECTION:64};g.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");g.maps_sampler=[];for(w=0;w<g.maps.length;++w)g.maps_sampler[w]=
"u_"+g.maps[w]+"_texture";g.prototype.render=function(n,f,m,r,v,D,E){this.renderer=n;this.current_camera=r;this.mode==g.FORWARD?this.renderForward(f,m,r,D,E):this.mode==g.DEFERRED&&this.renderDeferred(f,m,r,E)};g.prototype.fillGlobalUniforms=function(n){var f=this.getBRDFIntegratorTexture();f&&f.bind(0);this.environment_texture?(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=
!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;this.global_uniforms.u_occlusion_gamma=this.occlusion_gamma;this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3);this.global_uniforms.u_camera_perspective=n._projection_matrix[5];this.global_uniforms.u_tonemapper=
0;this.quality?(this.global_uniforms.u_exposure=this.exposure,this.global_uniforms.u_gamma=this.gamma):(this.global_uniforms.u_exposure=Math.pow(this.exposure,1/2.2),this.global_uniforms.u_gamma=this.use_rendertexture?this.gamma:1)};g.prototype.renderForward=function(n,f,m,r,v){f=Math.floor(gl.viewport_data[2]*this.resolution_factor);var D=Math.floor(gl.viewport_data[3]*this.resolution_factor);f=Math.min(f,this.max_texture_size);D=Math.min(D,this.max_texture_size);this.use_rendertexture&&!r&&(this.frame_texture&&
this.frame_texture.width==f&&this.frame_texture.height==D||(this.frame_texture=new GL.Texture(f,D,{format:gl.RGBA,type:gl.HALF_FLOAT,filter:gl.LINEAR}),this.final_fbo?this.final_fbo.setTextures([this.frame_texture]):this.final_fbo=new GL.FBO([this.frame_texture],null,!0),this.frame_texture.name=":frame_texture",gl.textures[this.frame_texture.name]=this.frame_texture,this.final_texture=new GL.Texture(f,D,{format:gl.RGB,filter:gl.LINEAR}),this.final_texture.name=":final_frame_texture",gl.textures[this.final_texture.name]=
this.final_texture),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);if(!this.skip_background){if(this.onRenderBackground)this.onRenderBackground(m,this);else this.renderSkybox(m);LEvent.trigger(this,"renderSkybox",this)}this.fillGlobalUniforms(m);if(this.onRenderOpaque)this.onRenderOpaque(this,this.renderer,
m);LEvent.trigger(this,"renderOpaque",this);this.renderRenderables(n,m,v);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,m);LEvent.trigger(this,"renderAlpha",this);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,m);LEvent.trigger(this,"renderGizmos",this);this.use_rendertexture&&!r&&this.renderFinalBuffer();if(this.renderer.overlay_renderables&&this.renderer.overlay_renderables.length)for(n=this.renderer.overlay_renderables,this.global_uniforms.u_gamma=1,this.global_uniforms.u_exposure=
1,gl.clear(gl.DEPTH_BUFFER_BIT),m=0;m<n.length;++m)r=n[m],this.renderMeshWithMaterial(r.model,r.mesh,r.material,r.index_buffer_name,r.group_index,r.node.extra_uniforms,r.reverse_faces,r.skin)};g.prototype.renderRenderables=function(n,f,m){m=(this.alpha_composite_callback||this.alpha_composite_target_texture)&&GL.FBO.current;for(var r=!0,v=0;v<n.length;++v){var D=n[v];r&&m&&"BLEND"==D.material.alphaMode&&(r=!1,this.alpha_composite_target_texture&&GL.FBO.current.color_textures[0].copyTo(this.alpha_composite_target_texture),
this.alpha_composite_callback&&this.alpha_composite_callback(GL.FBO.current,this.alpha_composite_target_texture));this.renderRenderable(D,f)}};g.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.frame_texture,null,this.frame_texture);this.fx_uniforms.u_viewportSize[0]=this.frame_texture.width;this.fx_uniforms.u_viewportSize[1]=this.frame_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.frame_texture.width;
this.fx_uniforms.u_iViewportSize[1]=1/this.frame_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=this.brightness;this.fx_uniforms.u_gamma=this.gamma;this.frame_texture.copyTo(this.final_texture,gl.shaders.fxaa_tonemapper,this.fx_uniforms);var n=null;this.postfx_shader_name&&(n=gl.shaders[this.postfx_shader_name])&&n.setUniform("u_size",[this.final_texture.width,this.final_texture.height]);this.final_texture.toViewport(n)};g.prototype.setParallaxReflectionTransform=
function(n){this.parallax_reflection_matrix.set(n);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};g.prototype.resetShadersCache=function(){this.compiled_shaders={}};g.prototype.getShader=function(n,f,m){m=m||"";var r=m+":"+f,v=this.compiled_shaders[r];v||=this.compiled_shaders[r]=
new Map;if(r=v.get(n))return r;if(!this.renderer.shader_files)return null;m=this.renderer.shader_files[m||"default.vs"];f=this.renderer.shader_files[f];if(!m||!f)return null;r=null;if(n){r={};for(var D in g.MACROS)n&g.MACROS[D]&&(r[D]="")}r=new GL.Shader(m,f,r);v.set(n,r);return r};g.default_backface_color=[.1,.1,.1];g.prototype.renderRenderable=function(n,f){var m=n.model,r=n.material,v=n.mesh,D=n.skin,E=this.renderer,c=n.primitive,p=n.group_index;if(!r||r.constructor===String)throw"no material in renderRenderable";
if(!("BLEND"==r.alphaMode&&0>=r.color[3])){var d=this.material_uniforms,l=this.sampler_uniforms,u=n.instances?n.instances.length:1;d.u_albedo=r.color.subarray(0,3);d.u_emissive.set(r.emissive||z.ZERO);1!=this.emissive_factor&&vec3.scale(d.u_emissive,d.u_emissive,this.emissive_factor);d.u_backface_color=r.backface_color||g.default_backface_color;var t=0;v.vertexBuffers.coords1&&(t|=g.MACROS.UVS2);v.vertexBuffers.colors&&(t|=g.MACROS.COLOR);D&&(t|=g.MACROS.SKINNING);n.morphs&&(t|=g.MACROS.MORPHTARGETS);
this.parallax_reflection&&(t|=g.MACROS.PARALLAX_REFLECTION);r.primitive==GL.POINTS&&(t|=g.MACROS.POINTS);1<u&&(t|=g.MACROS.INSTANCING);this.overwrite_shader_name?t=gl.shaders[this.overwrite_shader_name]:this.overwrite_shader_mode?t=this.getShader(t,this.overwrite_shader_mode):r.shader_name?t=gl.shaders[r.shader_name]:r.overlay?t=this.getShader(t,"overlay.fs"):"pbrMetallicRoughness"==r.model&&this.quality?(d.u_metalness=r.metallicFactor,d.u_roughness=r.roughnessFactor,d.u_metallicRough=!!r.textures.metallicRoughness,
t=this.getShader(t,"pbr.fs")):t=this.getShader(t,"nopbr.fs");if(t){d.u_alpha=r.opacity;d.u_alpha_cutoff=0;d.u_normalFactor=null!=r.normalmapFactor?r.normalmapFactor:1;d.u_displacement_factor=null!=r.displacementFactor?r.displacementFactor:1;r.uv_transform?this.texture_matrix.set(r.uv_transform):mat3.identity(this.texture_matrix);for(var q=2,A=2,H=d.u_maps_info,I=0;I<g.maps.length;++I){var G=g.maps[I];H[I]=-1;if(G=r.textures[G]){var M=null;G.constructor===Object?M=G.texture:G.constructor===String&&
(M=G,G=null);if(M){var P=g.maps_sampler[I];if(!t||t.samplers[P])A=gl.textures[M],A||(E.autoload_assets&&-1!=M.indexOf(".")&&E.loadTexture(M,E.default_texture_settings),A=gl.textures.white),M=16>this.max_textures?q++:I+2,l[P]=A.bind(M),H[I]=G&&null!=G.uv_channel?Math.clamp(G.uv_channel,0,3):0,A=M}}}n.morphs&&t.uniforms({u_morph_texture:n.morphs.bind(++A)});n.reverse_faces||gl.frontFace(GL.CCW);E.enableItemFlags(r);n.reverse_faces&&gl.frontFace(GL.CW);"BLEND"==r.alphaMode?(gl.enable(gl.BLEND),r.additive||
"ADD"==r.blendMode?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):"MULTIPLY"==r.blendMode?gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1),d.u_alpha_cutoff=0):"MASK"==r.alphaMode?d.u_alpha_cutoff=r.alphaCutoff:gl.disable(gl.BLEND);D&&t.uniformInfo.u_bones&&(D.constructor===z.Skeleton?(this.bones=D.computeFinalBoneMatrices(this.bones,v),t.setUniform("u_bones",this.bones)):D._bone_matrices&&t.setUniform("u_bones",D._bone_matrices));1==u&&E._uniforms.u_model.set(m);
D&&D.skip_model&&mat4.identity(E._uniforms.u_model);t.uniforms(E._uniforms);t.uniforms(this.global_uniforms);t.uniforms(f._uniforms);t.uniforms(r.uniforms);t.uniforms(d);t.uniforms(l);r.primitive==GL.POINTS&&t.setUniform("u_pointSize",r.point_size||-1);f=null;null!=p&&v.info&&v.info.groups&&v.info.groups[p]&&(f=v.info.groups[p]);-1<r.primitive&&(c=r.primitive);p=this._instancing_uniforms;n.instances&&(p.u_model=n.instances.flat());m=n.index_buffer_name||"triangles";r.flags.preAlpha&&(gl.colorMask(!1,
!1,!1,!1),gl.depthMask(!0),1<u?t.drawInstanced(v,c,m,p):f?t.drawRange(v,c,f.start,f.length,m):t.draw(v,c,m),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL),this.rendered_renderables++);1<u?f?t.drawInstanced(v,c,m,p,f.start,f.length):t.drawInstanced(v,c,m,p):f?t.drawRange(v,c,f.start,f.length,m):t.draw(v,c,m);this.rendered_renderables++;E.disableItemFlags(r);n.reverse_faces&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};g.prototype.renderDeferred=function(n,f,m,r,v){r=this.prepareGBuffers();
r.fbo.bind();this.renderToGBuffers(n,m,v);r.fbo.unbind();r.final_fbo.bind();this.renderFinalPass(r,f,m);r.final_fbo.unbind();this.applyPostFX(r)};g.prototype.prepareGBuffers=function(n){var f=gl.drawingBufferWidth,m=gl.drawingBufferHeight;if(this._gbuffers&&this._gbuffers.width==f&&this._gbuffers.height==m)return this._gbuffers;this._gbuffers||(this._gbuffers={});n=this._gbuffers;n.fbo||(n.fbo=new GL.FBO);n.final_fbo||(n.final_fbo=new GL.FBO);n.width=f;n.height=m;var r={format:GL.RGBA,filter:gl.NEAREST,
wrap:gl.CLAMP_TO_EDGE},v=new GL.Texture(f,m,r),D=new GL.Texture(f,m,r),E=new GL.Texture(f,m,r);r=new GL.Texture(f,m,r);var c=new GL.Texture(f,m,{format:GL.DEPTH_STENCIL,type:GL.UNSIGNED_INT_24_8,filter:gl.NEAREST});n.fbo.setTextures([v,D,E,r],c);f=new GL.Texture(f,m,{format:GL.RGBA,type:gl.HALF_FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE});n.final_fbo.setTextures([f]);n.albedo=v;n.matprop=D;n.emissive=E;n.normal=r;n.depth=c;n.final=f;return n};g.prototype.renderToGBuffers=function(n,f,m){gl.clearColor(this.bgcolor[0],
this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);this.fillGlobalUniforms(f);for(f=0;f<n.length;++f)m=n[f],this.renderMeshWithMaterialToGBuffers(m.model,m.mesh,m.material,m.index_buffer_name,m.group_index,m.node.extra_uniforms,m.reverse_faces,m.skin)};g.prototype.renderFinalPass=function(n,f,m){gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);(f=gl.shaders.deferred_global)&&
n.albedo.toViewport(f,{normal_texture:n.normal.bind(1),material_texture:n.matprop.bind(2),emissive_texture:n.emissive.bind(3),depth_texture:n.depth.bind(4),u_invVP:m._inv_viewprojection_matrix})};g.prototype.applyPostFX=function(n){gl.disable(GL.DEPTH_TEST);gl.disable(GL.BLEND);var f=n.width,m=n.height;this.debug&&(gl.viewport(0,0,.5*f,.5*m),n.albedo.toViewport(),gl.viewport(.5*f,0,.5*f,.5*m),n.matprop.toViewport(),gl.viewport(0,.5*m,.5*f,.5*m),n.emissive.toViewport(),gl.viewport(.5*f,.5*m,.5*f,.5*
m),n.normal.toViewport(),gl.viewport(0,0,f,m));n.final.toViewport()};g.prototype.renderMeshWithMaterialToGBuffers=function(n,f,m,r,v,D,E,c){var p=this.renderer,d=p._camera;if(!m||m.constructor===String)throw"no material in renderMeshWithMaterial";if("BLEND"!=m.alphaMode){var l=this.material_uniforms,u=this.sampler_uniforms,t=n.length/16;l.u_albedo=m.color.subarray(0,3);l.u_emissive.set(m.emissive||z.ZERO);1!=this.emissive_factor&&vec3.scale(l.u_emissive,l.u_emissive,this.emissive_factor);l.u_backface_color=
m.backface_color||g.default_backface_color;var q=0;f.vertexBuffers.coords1&&(q|=g.MACROS.UVS2);f.vertexBuffers.colors&&(q|=g.MACROS.COLOR);c&&(q|=g.MACROS.SKINNING);m.primitive==GL.POINTS&&(q|=g.MACROS.POINTS);1<t&&(q|=g.MACROS.INSTANCING);if(q=this.getShader(q,"gbuffer.fs")){l.u_alpha=m.opacity;l.u_alpha_cutoff=0;l.u_normalFactor=null!=m.normalmapFactor?m.normalmapFactor:1;l.u_displacement_factor=null!=m.displacementFactor?m.displacementFactor:1;m.uv_transform?this.texture_matrix.set(m.uv_transform):
mat3.identity(this.texture_matrix);for(var A=2,H=l.u_maps_info,I=0;I<g.maps.length;++I){var G=g.maps[I];H[I]=-1;if(G=m.textures[G]){var M=null;G.constructor===Object?M=G.texture:G.constructor===String&&(M=G,G=null);if(M){var P=g.maps_sampler[I];if(!q||q.samplers[P]){var O=gl.textures[M];O||(p.autoload_assets&&-1!=M.indexOf(".")&&p.loadTexture(M,p.default_texture_settings),O=gl.textures.white);M=16>this.max_textures?A++:I+2;u[P]=O.bind(M);H[I]=G&&null!=G.uv_channel?Math.clamp(G.uv_channel,0,3):0}}}}E||
gl.frontFace(GL.CCW);p.enableItemFlags(m);E&&gl.frontFace(GL.CW);"MASK"==m.alphaMode&&(l.u_alpha_cutoff=m.alphaCutoff);if(c){if(c.constructor===z.Skeleton)this.bones=c.computeFinalBoneMatrices(this.bones,f),q.setUniform("u_bones",this.bones);else if(c._bone_matrices)q.setUniform("u_bones",c._bone_matrices);else return;c.joints&&(c.skip_model=!0)}1==t&&p._uniforms.u_model.set(n);c&&c.skip_model&&mat4.identity(p._uniforms.u_model);q.uniforms(p._uniforms);q.uniforms(this.global_uniforms);q.uniforms(d._uniforms);
q.uniforms(m.uniforms);q.uniforms(l);q.uniforms(u);D&&q.uniforms(D);m.primitive==GL.POINTS&&q.setUniform("u_pointSize",m.point_size||-1);D=null;null!=v&&f.info&&f.info.groups&&f.info.groups[v]&&(D=f.info.groups[v]);v=this._instancing_uniforms;v.u_model=n;n=gl.TRIANGLES;1<t?D?q.drawInstanced(f,n,r,v,D.start,D.length):q.drawInstanced(f,n,r,v):D?q.drawRange(f,n,D.start,D.length,r):q.draw(f,n,r);this.rendered_renderables++;p.disableItemFlags(m);E&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};
g.prototype.renderSkybox=function(n){if((!this.onRenderSkybox||!this.onRenderSkybox(this,n))&&this.environment_texture&&this.render_skybox){var f=gl.meshes.cube,m=gl.shaders[this.overwrite_shader_name||"skybox"];if(m){var r=this.skybox_texture||this.environment_texture;if(r&&r.texture_type===GL.TEXTURE_CUBE_MAP){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var v=this.renderer._model_matrix;mat4.identity(v);mat4.translate(v,v,n.position);mat4.scale(v,v,[10,10,10]);m.uniforms(this.renderer._uniforms);
m.uniforms(n._uniforms);m.uniforms({u_color_texture:r.bind(1),u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD});m.draw(f,GL.TRIANGLES)}}}};g.prototype.loadEnvironment=function(n,f,m){var r=this,v=gl.textures[n];v?(m?r.skybox_texture=v:(v.shs&&(r.environment_sh_coeffs=v.shs),r.environment_texture=v),f&&f(v)):HDRE.load(n,function(D){var E=D.toTexture(!0);E&&(gl.textures[n]=E,m?r.skybox_texture=E:(E.shs=D.shs?D.shs:null,r.environment_texture=E,E.shs&&
(r.environment_sh_coeffs=E.shs)));f&&f(E)})};g.prototype.captureEnvironment=function(n,f,m){m=m||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(m,m,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));var r=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,n,f);this.use_rendertexture=r;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);
this.environment_texture||(this.environment_texture=new GL.Texture(m,m,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};g.prototype.getBRDFIntegratorTexture=function(n){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var f=gl.shaders.brdf_integrator;if(f){var m=gl.textures.brdf_integrator=new GL.Texture(128,128,{format:gl.RGBA,type:gl.FLOAT,texture_type:gl.TEXTURE_2D,
filter:gl.LINEAR});if(n)return fetch(n).then(function(v){return v.arrayBuffer()}).then(function(v){m.uploadData(new Float32Array(v),{no_flip:!0})}),m;var r=gl.textures.hammersley_sample_texture;r||=this.createHammersleySampleTexture();m.drawTo(function(v){r&&r.bind(0);f.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return m}};g.prototype.createHammersleySampleTexture=function(n){n=n||8192;for(var f=4*n,m=new Float32Array(f),r=0;r<f;r+=4){var v=2*Math.radical_inverse(r)*
Math.PI;m[r]=Math.cos(v);m[r+1]=Math.sin(v)}n=new GL.Texture(n,1,{type:gl.FLOAT,format:gl.RGBA,filter:gl.LINEAR,pixel_data:m});return gl.textures.hammersley_sample_texture=n};g.prototype.setClippingPlane=function(n,f){n?this.global_uniforms.u_clipping_plane.set([f[0],f[1],f[2],vec3.dot(n,f)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};g.prototype.startGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var n=gl.extensions.EXT_disjoint_timer_query;
this._waiting_gpu_query||(void 0===this._useQueryTimestamps&&(this._useQueryTimestamps=!1,0<n.getQueryEXT(n.TIMESTAMP_EXT,n.QUERY_COUNTER_BITS_EXT)&&(this._useQueryTimestamps=!0)),gl.getParameter(n.GPU_DISJOINT_EXT),this._useQueryTimestamps?(this._start_gpu_query=n.createQueryEXT(),this._end_gpu_query=n.createQueryEXT(),n.queryCounterEXT(this._start_gpu_query,n.TIMESTAMP_EXT)):(this._timeElapsed_gpu_query=n.createQueryEXT(),n.beginQueryEXT(n.TIME_ELAPSED_EXT,this._timeElapsed_gpu_query)))}};g.prototype.endGPUQuery=
function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled&&!this._waiting_gpu_query){var n=gl.extensions.EXT_disjoint_timer_query;this._useQueryTimestamps?n.queryCounterEXT(this._end_gpu_query,n.TIMESTAMP_EXT):n.endQueryEXT(n.TIME_ELAPSED_EXT);this._waiting_gpu_query=!0}};g.prototype.resolveQueries=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var n=gl.extensions.EXT_disjoint_timer_query,f=this._start_gpu_query,m=this._end_gpu_query,r=this._timeElapsed_gpu_query,
v=this._useQueryTimestamps;if(f||m||r){var D=gl.getParameter(n.GPU_DISJOINT_EXT),E;if(!D&&(E=v?n.getQueryObjectEXT(m,n.QUERY_RESULT_AVAILABLE_EXT):n.getQueryObjectEXT(r,n.QUERY_RESULT_AVAILABLE_EXT))){if(v){var c=n.getQueryObjectEXT(f,n.QUERY_RESULT_EXT);c=n.getQueryObjectEXT(m,n.QUERY_RESULT_EXT)-c}else c=n.getQueryObjectEXT(r,n.QUERY_RESULT_EXT);this.frame_time=1E-6*c}if(E||D)v?(n.deleteQueryEXT(f),n.deleteQueryEXT(m),this._end_gpu_query=this._start_gpu_query=null):(n.deleteQueryEXT(r),this._timeElapsed_gpu_query=
null),this._waiting_gpu_query=!1}return this.frame_time}};Math.radical_inverse=function(n){for(var f=0,m=.5;n;m*=.5,n>>=1)n&1&&(f+=m);return f};z.PBRPipeline=g})(this);(function(w){})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(w){function g(){this.name="";this.tracks=[];this.duration=10}function z(c,p,d){return c*(1-d)+p*d}function n(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function f(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function m(){this.skeleton=new n;this.duration=1;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this._loading=!1;this.bones_map=new Uint8Array(m.MAX_BONES);
this.keyframes=null}function r(c,p,d){for(var l="",u=0;u<d;++u){var t=c.getUint8(p+u);if(!t)break;l+=String.fromCharCode(t)}return l}var v=w.RD=w.RD||{};v.Animations={};g.prototype.addTrack=function(c,p){if(p)for(p=0;p<this.tracks.length;++p)if(this.tracks[p].target_node==c.target_node){this.tracks.splice(p+1,0,c);return}this.tracks.push(c)};g.prototype.applyAnimation=function(c,p,d,l){for(var u=0;u<this.tracks.length;++u){var t=this.tracks[u];!1!==t.enabled&&(l&&(p=this.duration?p%this.duration:
0),t.applyTrack(c,p,d))}};g.prototype.toJSON=function(){for(var c={name:this.name,duration:this.duration,tracks:[]},p=0;p<this.tracks.length;++p)c.tracks.push(this.tracks[p].toJSON());return c};g.prototype.fromJSON=function(c){this.name=c.name;this.duration=c.duration;for(var p=this.tracks.length=0;p<c.tracks.length;++p){var d=new v.Animation.Track;d.fromJSON(c.tracks[p]);this.tracks.push(d)}return c};g.prototype.findNearestLeft=function(c){for(var p=0,d=0;d<this.tracks.length;++d){var l=this.tracks[d],
u=l.findTimeIndex(c);-1!=u&&(l=l.data[u],l>p&&(p=l))}return p};g.prototype.findNearestRight=function(c){for(var p=this.duration,d=0;d<this.tracks.length;++d){var l=this.tracks[d],u=l.findTimeIndex(c);-1!=u&&(l=l.data[u+1],null!=l&&l<p&&(p=l))}return p};g.prototype.isValid=function(c){for(var p=0;p<this.tracks.length;++p)if(this.tracks[p].getTarget(c))return!0;return!1};v.Animation=g;class D{constructor(){this.enabled=!0;this.target_property=this.target_node="";this.type=v.SCALAR;this.num_components=
1;this.data=[];this.packed_data=!1;this._target=null}get value_size(){return v.TYPES_SIZE[this.type]}}g.Track=D;D.prototype.addKeyframe=function(c,p,d){1<this.value_size&&(p=new Float32Array(p));for(var l=0;l<this.data.length;++l)if(!(this.data[l][0]<c))return this.data[l][0]!=c||d?this.data.splice(l,0,[c,p]):this.data[l][1]=p,l;this.data.push([c,p]);return this.data.length-1};D.prototype.getKeyframe=function(c){if(0>c||c>=this.data.length)return console.warn("keyframe index out of bounds"),null;
var p=v.TYPES_SIZE[this.type];return this.packed_data?(c*=1+p,c>this.data.length-p?null:[this.data[c],this.data.subarray(c+1,c+p+1)]):this.data[c]};D.prototype.findTimeIndex=function(c){var p=this.data;if(!p||0==p.length)return-1;var d=v.TYPES_SIZE[this.type]*this.num_components;if(this.packed_data){d+=1;var l=p.length/d,u=0,t=0,q=l;if(0==l)return-1;if(1==l)return 0;if(p[(q-1)*d]<c)return q-1;for(;q>=u;){t=.5*(q+u)|0;l=p[t*d];if(l==c)break;if(u==q-1)return u;l<c?u=t:q=t}return t}l=p.length;t=u=0;
q=l;if(0==l)return-1;if(1==l)return 0;if(p[q-1][0]<c)return q-1;for(;q>=u;){t=.5*(q+u)|0;l=p[t][0];if(l==c)break;if(u==q-1)return u;l<c?u=t:q=t}return t};D.prototype.getSample=function(c,p,d){if(this.data&&0!==this.data.length)return this.packed_data?this.getSamplePacked(c,p,d):this.getSampleUnpacked(c,p,d)};D.prototype.getSampleUnpacked=function(c,p,d){c=Math.clamp(c,0,this.data[this.data.length-1][0]);var l=this.findTimeIndex(c);-1===l&&(l=0);var u=l,t=l+1,q=this.data;var A=v.TYPES_SIZE[this.type];
if(!p||0==A||1==q.length||t==q.length||0==u&&this.data[0][0]>c)return this.data[l][1];u=q[u];t=q[t];c=(t[0]-c)/(t[0]-u[0]);1<A&&(d=d||this._result,d&&d.length==A||(d=this._result=new Float32Array(A)));if(p===v.LINEAR)return 1==A?u[1]*c+t[1]*(1-c):v.interpolateLinear(u[1],t[1],c,d,this.type,A,this);if(p===v.CUBIC){p=0<l?q[l-1]:u;l=l<q.length-2?q[l+2]:t;if(1===A)return v.EvaluateHermiteSpline(u[1],t[1],p[1],l[1],1-c);d=v.EvaluateHermiteSplineVector(u[1],t[1],p[1],l[1],1-c,d);this.type==v.QUAT?(quat.slerp(d,
t[1],u[1],c),quat.normalize(d,d)):this.type==v.TRANS10&&(A=d.subarray(3,7),u=u[1].subarray(3,7),t=t[1].subarray(3,7),quat.slerp(A,t,u,c),quat.normalize(A,A));return d}return null};D.prototype.getSamplePacked=function(c,p,d){if(!this.data.length)return null;var l=v.TYPES_SIZE[this.type]*this.num_components;c=Math.clamp(c,0,this.data[this.data.length-l-1]);var u=this.findTimeIndex(c);-1==u&&(u=0);var t=l+1,q=u,A=u+1,H=this.data,I=H.length/t;if(!p||1==I||A==I||0==q&&this.data[0]>c)return this.getKeyframe(u)[1];
1<l&&(d=d||this._result,d&&d.length==l||(d=this._result=new Float32Array(l)));var G=H.subarray(q*t,(q+1)*t);q=H.subarray(A*t,(A+1)*t);c=(q[0]-c)/(q[0]-G[0]);if(p===v.LINEAR){if(1==l)return G[1]*c+q[1]*(1-c);t=G.subarray(1,l+1);q=q.subarray(1,l+1);return v.interpolateLinear(t,q,c,d,this.type,l,this)}if(p===v.CUBIC){if(0===l)return G[1];p=0<u?H.subarray((u-1)*t,u*t):G;A=A<I-1?H.subarray((A+1)*t,(A+2)*t):q;if(1===l)return v.EvaluateHermiteSpline(G[1],q[1],p[1],A[1],1-c);l=G.subarray(1,t);q=q.subarray(1,
t);d=v.EvaluateHermiteSplineVector(l,q,p.subarray(1,t),A.subarray(1,t),1-c,d);this.type==v.QUAT?(quat.slerp(d,q,l,c),quat.normalize(d,d)):this.type==v.TRANS10&&(t=d.subarray(3,7),l=l.subarray(3,7),q=q.subarray(3,7),quat.slerp(t,q,l,c),quat.normalize(t,t));return d}return null};D.prototype.getTarget=function(c){if(c.constructor===v.SceneNode){if(c=c.name==this.target_node?c:c.findNodeByName(this.target_node))return c}else if(c.constructor===v.Skeleton&&(c=c.getBone(this.target_node))&&this.type==v.MAT4)return c;
return null};D.prototype.applyTrack=function(c,p,d){if(c&&(c=this.getTarget(c))){p=this.getSample(p,d);if(c instanceof v.SceneNode)if(c.morphs&&"weights"===this.target_property&&c.morphs.length===p.length)for(d=0;d<this.num_components;++d)c.morphs[d].weight=p[d];else c[this.target_property]=p;else c.constructor===v.Bone&&(this._bone=c,c.model.set(p));return p}};D.prototype.toJSON=function(){return{enabled:this.enabled,target_node:this.target_node,target_property:this.target_property,type:this.type,
data:this.data.constructor==Array?this.data.concat():typedArrayToArray(this.data),packed_data:this.packed_data}};D.prototype.fromJSON=function(c){this.enabled=c.enabled;this.target_node=c.target_node;this.target_property=c.target_property;if(c.property){var p=c.property.indexOf("/");this.target_node=c.property.substr(0,p);this.target_property=c.property.substr(p+1)}null!=c.type&&(this.type=c.type.constructor===String?v.TYPES[c.type.toUpperCase()]||0:c.type);c.packed_data||c.data.constructor===Float32Array?
(this.packed_data=!0,this.data=new Float32Array(c.data)):(this.packed_data=!1,this.data=c.data.concat())};v.interpolateLinear=function(c,p,d,l,u,t,q){if(1==t)return c*d+p*(1-d);l=l||q._result;l&&l.length==t||(l=q._result=new Float32Array(t));switch(u){case v.QUAT:quat.slerp(l,p,c,d);quat.normalize(l,l);break;case v.TRANS10:for(u=0;3>u;u++)l[u]=c[u]*d+p[u]*(1-d);for(u=7;10>u;u++)l[u]=c[u]*d+p[u]*(1-d);c=c.subarray(3,7);p=p.subarray(3,7);t=l.subarray(3,7);quat.slerp(t,p,c,d);quat.normalize(t,t);break;
default:for(u=0;u<t;u++)l[u]=c[u]*d+p[u]*(1-d)}return l};v.EvaluateHermiteSpline=function(c,p,d,l,u){var t=u*u,q=t*u;return(2*q-3*t+1)*c+(-2*q+3*t)*p+(q-2*t+u)*(p-d)+(q-t)*(l-c)};v.EvaluateHermiteSplineVector=function(c,p,d,l,u,t){t=t||new Float32Array(t.length);var q=u*u,A=q*u,H=2*A-3*q+1,I=-2*A+3*q;u=A-2*q+u;q=A-q;A=0;for(var G=t.length;A<G;++A)t[A]=H*c[A]+I*p[A]+u*(p[A]-d[A])+q*(l[A]-c[A]);return t};Math.lerp||(Math.lerp=z);v.Skeleton=n;n.Bone=f;f.prototype.toJSON=function(){return{name:this.name,
model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};f.prototype.fromJSON=function(c){this.name=c.name;this.model.set(c.model);this.parent=c.parent;this.layer=c.layer;this.num_children=0;this.index=null!=c.index?c.index:-1;c.children&&(this.children.set(c.children),this.num_children=c.children.constructor===Array?c.children.length:c.num_children)};n.prototype.applyTransformToBones=function(c,
p){(c=this.getBone(c))&&mat4.multiply(c.model,c.model,p)};n.prototype.getBone=function(c){return this.bones[this.bones_by_name.get(c)]};n.identity=mat4.create();n.prototype.getBoneMatrix=function(c,p,d){var l=-1;c.constructor===String?l=this.bones_by_name.get(c):c.constructor===Number&&(l=c);if(void 0===l)return n.identity;if(!p)return this.bones[l].model;c=this.global_bone_matrices[l];if(!d)return c;d=this.bones[l];c.set(d.model);for(d=this.bones[d.parent];d;)c=mat4.mul(c,d.model,c),d=this.bones[d.parent];
return c};n.prototype.updateBoneGlobalMatrix=function(c){var p=this.bones[c];if(p)for(c=this.global_bone_matrices[c],c.set(p.model),p=this.bones[p.parent];p;)c=mat4.mul(c,p.model,c),p=this.bones[p.parent]};n.prototype.updateChildBonesGlobalMatrices=function(c){if(c=c.constructor==n.Bone?c:this.getBone(c)){var p=this.global_bone_matrices[c.index];mat4.mul(p,this.global_bone_matrices[c.parent],p);for(c=0;c<this.num_children;++c)this.updateChildBonesGlobalMatrices(this.children[c])}};n.prototype.importSkeleton=
function(c,p){function d(t){var q=new f;q.name=t.name||t.id;t.model?q.model.set(t.model):t.transform&&t.getLocalMatrix&&q.model.set(t.getLocalMatrix());q.index=u.length;u.push(q);l.bones_by_name.set(q.name,q.index);l.global_bone_matrices.push(mat4.create());if(t.children&&t.children.length){q.num_children=t.children.length;for(var A=0;A<t.children.length;++A){var H=d(t.children[A]);q.children[A]=H.index;H.parent=q.index}}return q}var l=this;u?this.bones.length=0:this.bones=[];var u=this.bones;d(c);
p&&mat4.mul(u[0].model,p,u[0].model);this.updateGlobalMatrices()};n.temp_mat4=mat4.create();n.temp_mat43=n.temp_mat4.subarray(0,12);n.prototype.computeFinalBoneMatrices=function(c,p,d){if(!this.bones.length||!p||!p.bones)return c||[];this.updateGlobalMatrices();var l=d?12*p.bones.length:16*p.bones.length;c&&c.length==l||(c=new Float32Array(l));if(d){var u=n.temp_mat43;for(d=0;d<p.bones.length;++d)l=p.bones[d],mat4.multiply(temp_mat4,this.getBoneMatrix(l[0],!0),l[1]),p.bind_matrix&&mat4.multiply(temp_mat4,
temp_mat4,p.bind_matrix),mat4.transpose(temp_mat4,temp_mat4),c.set(u,12*d)}else for(d=0;d<p.bones.length;++d)l=p.bones[d],u=c.subarray(16*d,16*d+16),mat4.multiply(u,this.getBoneMatrix(l[0],!0),l[1]),p.bind_matrix&&mat4.multiply(u,u,p.bind_matrix);return c};n.prototype.computeFinalBoneMatricesAsArray=function(c,p,d){if(!this.bones.length||!p||!p.bones)return c||[];this.updateGlobalMatrices();c=c||[];c.length=p.bones.length;for(var l=0;l<p.bones.length;++l){var u=p.bones[l];c[l]||(c[l]=mat4.create());
var t=c[l];mat4.multiply(t,this.getBoneMatrix(u[0],!0),u[1]);p.bind_matrix&&mat4.multiply(t,t,p.bind_matrix);d&&mat4.multiply(t,d,t)}return c};n.prototype.updateGlobalMatrices=function(){var c=this.bones;if(c.length){var p=this.bones.length;this.global_bone_matrices[0].set(c[0].model);for(var d=1;d<p;++d){var l=c[d];mat4.multiply(this.global_bone_matrices[d],this.global_bone_matrices[l.parent],l.model)}}};n.prototype.assignLayer=function(c,p){};n.temp_vec3=vec3.create();n.temp_vec4=vec4.create();
n.temp_mat4=mat4.create();n.prototype.applyTracksAnimation=function(c,p){for(var d=n.temp_vec3,l=n.temp_vec4,u=n.temp_mat4,t=0;t<c.tracks.length;++t){var q=c.tracks[t],A=this.bones_by_name.get(q.target_node);null!=A&&(A=this.bones[A],"model"==q.target_property||"matrix"==q.target_property?q.getSample(p,v.LINEAR,A.model):"position"==q.target_property?(q.getSample(p,v.LINEAR,d),mat4.setTranslation(A.model,d)):"rotation"==q.target_property?(q.getSample(p,v.LINEAR,l),mat4.fromQuat(u,l),mat4.getTranslation(d,
A.model),mat4.setTranslation(u,d),A.model.set(u)):"scaling"==q.target_property&&(q.getSample(p,v.LINEAR,d),mat4.scale(A.model,A.model,d)))}};n.prototype.getVertices=function(c,p){if(!this.bones.length)return null;p||this.updateGlobalMatrices();p=6*(this.bones.length-1);this._vertices&&this._vertices.length==p||(this._vertices=new Float32Array(p));p=this._vertices;for(var d=0,l=1;l<this.bones.length;++l){var u=this.global_bone_matrices[this.bones[l].parent],t=this.global_bone_matrices[l],q=p.subarray(d,
d+3),A=p.subarray(d+3,d+6);mat4.getTranslation(q,t);mat4.getTranslation(A,u);c&&(vec3.transformMat4(q,q,c),vec3.transformMat4(A,A,c));d+=6}return p};n.prototype.resizeBones=function(c){if(this.bones.length!=c)if(this.bones.length>c)this.bones.length=c,this.global_bone_matrices.length=c;else{var p=this.bones.length;for(this.bones.length=c;p<c;++p)this.bones[p]=new f,this.global_bone_matrices[p]=mat4.create()}};n.prototype.copyFrom=function(c){this.resizeBones(c.bones.length);for(var p=0;p<c.bones.length;++p)this.bones[p].copyFrom(c.bones[p]),
this.global_bone_matrices[p].set(c.global_bone_matrices[p]);this.bones_by_name=new Map(c.bones_by_name)};n.prototype.toJSON=function(){for(var c={bones:[],bone_names:{}},p=0;p<this.bones.length;++p)c.bones.push(this.bones[p].toJSON());return c};n.prototype.fromJSON=function(c){this.resizeBones(c.bones.length);c.bones_by_name?this.bones_by_name=new Map(c.bones_by_name):this.bones_by_name.clear();for(var p=0;p<c.bones.length;++p){var d=this.bones[p];d.copyFrom(c.bones[p]);d.index=p;c.global_bone_matrices?
this.global_bone_matrices[p].set(c.global_bone_matrices[p]):this.bones_by_name.set(this.bones[p].name,p)}};var E=vec3.create();n.blend=function(c,p,d,l,u,t){if(c.bones.length!=p.bones.length)console.error("skeleton must contain the same number of bones");else{d=Math.clamp(d,0,1);if(255==u){if(0==d){if(l==c)return;l.copyFrom(c);return}if(1==d){l.copyFrom(p);return}}if(l!=c){l.resizeBones(c.bones.length);for(u=0;u<l.bones.length;++u){var q=l.bones[u];q||=l.bones[u]=new n.Bone;q.copyFrom(c.bones[u])}l.bones_by_name=
new Map(c.bones_by_name)}for(u=0;u<l.bones.length;++u){var A=l.bones[u],H=c.bones[u],I=p.bones[u];for(q=0;16>q;++q)A.model[q]=Math.lerp(H.model[q],I.model[q],d);if(!t)for(A=A.model,q=0;3>q;++q)E[0]=A[0+q],E[1]=A[4+q],E[2]=A[8+q],vec3.normalize(E,E),A[0+q]=E[0],A[4+q]=E[1],A[8+q]=E[2]}}};n.vertex_shader_code=`
	precision highp float;
	attribute vec3 a_vertex;
	attribute vec3 a_normal;
	attribute vec2 a_coord;
	
	varying vec3 v_wPosition;
	varying vec3 v_wNormal;
	varying vec2 v_coord;
	
	uniform mat4 u_viewprojection;
	uniform mat4 u_model;
	uniform mat4 u_normal_matrix;
	
	${v.Renderer.shader_snippets} //
	
	void main() {
		v_wPosition = a_vertex;
		v_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;
		v_coord = a_coord;
		
		computeSkinning( v_wPosition, v_wNormal);
		
		v_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;
		
		gl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );
	}
`;m.MAX_BONES=64;m.VERSION=4;v.SkeletalAnimation=m;m.prototype.load=function(c,p){var d=this,l=-1!=c.toLowerCase().indexOf(".abin");this._loading=!0;return HttpRequest(c,null,function(u){d._loading=!1;u.constructor===String?d.fromData(u):d.fromBinary(u);p&&p(d)},null,{binary:l})};m.prototype.assignTime=function(c,p,d,l){if(this.duration&&this.samples_per_second){(p||void 0===p)&&this.duration?(c%=this.duration,0>c&&(c=this.duration+c)):c=Math.clamp(c,0,this.duration-1/this.samples_per_second);void 0===
d&&(d=!0);c*=this.samples_per_second;l=Math.floor(c);var u=(l+1)%this.num_keyframes;l%=this.num_keyframes;c-=Math.floor(c);var t=this.num_animated_bones;p=16*t;l*=p;u*=p;var q=this.skeleton,A=this.keyframes,H=this.bones_map;t=Math.min(t,H.length);for(var I=0;I<t;++I){var G=q.bones[H[I]];if(!G)throw"bone not found in skeleton";p=16*I;if(d)for(var M=0;16>M;++M)G.model[M]=z(A[l+p+M],A[u+p+M],c);else G.model.set(A.subarray(l+p,l+p+16))}}};m.prototype.resize=function(c,p){this.num_keyframes=Math.floor(c);
this.num_animated_bones=p;this.keyframes=new Float32Array(c*p*16)};m.prototype.assignPoseToKeyframe=function(c,p){if(p>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";p=p*this.num_animated_bones*16;for(var d=0;d<this.num_animated_bones;++d){var l=c.bones[this.bones_map[d]];null!=l&&this.keyframes.set(l.model,p+16*d)}};m.prototype.fromData=function(c){var p=c.split("\n"),d=p[0].split(",");this.duration=Number(d[0]);this.samples_per_second=
Number(d[1]);this.num_keyframes=Number(d[2]);this._datasize=c.length;this.skeleton.resizeBones(Number(d[3]));c=0;for(d=1;d<p.length;++d){var l=p[d],u=l[0];l=l.substr(1).split(",");if("B"==u){var t=Number(l[0]),q=this.skeleton.bones[t];if(!q)throw"bone not found in skeleton";q.name=l[1];q.parent=Number(l[2]);for(u=0;16>u;++u)q.model[u]=Number(l[3+u]);-1!=q.parent&&(l=this.skeleton.bones[q.parent],16<=l.num_children?console.warn("too many child bones, max is 16"):l.children[l.num_children++]=t);this.skeleton.bones_by_name.set(q.name,
t)}else if("@"==u){this.num_animated_bones=Number(l[0]);for(u=0;u<this.num_animated_bones;++u)this.bones_map[u]=Number(l[u+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==u){t=c*this.num_animated_bones*16;u=0;for(q=16*this.num_animated_bones;u<q;++u)this.keyframes[t+u]=Number(l[u+1]);c++}else break}this.assignTime(0,!1,!1)};m.prototype.toData=function(){var c=[];c.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());
for(var p=this.skeleton.bones,d=0;d<p.length;++d){var l=p[d];c.push("B"+d+","+l.name+","+l.parent+","+typedArrayToArray(l.model))}p=[];for(d=0;d<this.num_animated_bones;++d)p.push(this.bones_map[d]);c.push("@"+p.length+","+p.join(","));p=1/this.samples_per_second;for(d=0;d<this.num_keyframes;++d){l=16*d*this.num_animated_bones;l=this.keyframes.subarray(l,l+16*this.num_animated_bones);for(var u=0;u<l.length;++u)1E-6>Math.abs(l[u])&&(l[u]=0);c.push("K"+(d*p).toFixed(3)+","+l.join(","))}return c.join("\n")};
m.prototype.fromPose=function(c){this.samples_per_second=15;this.duration=1/this.samples_per_second;this.skeleton.copyFrom(c);for(var p=c.bones.length,d=0;d<c.bones.length;++d)this.bones_map[d]=d;this.resize(1,p);this.assignPoseToKeyframe(this.skeleton,0)};m.prototype.fromTracksAnimation=function(c,p,d,l){this.duration=p.duration;this.samples_per_second=d;this.skeleton.copyFrom(c);for(var u=0,t={},q=0;q<p.tracks.length;++q){var A=p.tracks[q],H=c.bones_by_name.get(A.target_node);null!=H&&(this.bones_map[u]=
H,null==t[A.target_node]&&(t[A.target_node]=A.target_node,u++))}u>c.bones.length&&console.warn("more animated bones than bones?");this.resize(Math.floor(p.duration*d),u);for(q=0;q<this.num_keyframes;++q)this.skeleton.applyTracksAnimation(p,1/d*q),l&&mat4.mul(this.skeleton.bones[0].model,l,this.skeleton.bones[0].model),this.assignPoseToKeyframe(this.skeleton,q)};m.prototype.toBinary=function(){for(var c=this.skeleton.bones.length,p=new Uint8Array(176+115*c+this.num_keyframes*this.num_animated_bones*
64),d=new DataView(p.buffer),l=0;4>l;++l)d.setUint8(l,"ABIN".charCodeAt(l));d.setInt32(4,m.VERSION,!0);d.setInt32(8,172,!0);d.setFloat32(12,this.duration,!0);d.setFloat32(16,this.samples_per_second,!0);d.setUint32(20,this.num_animated_bones,!0);d.setUint32(24,this.num_keyframes,!0);d.setUint32(28,c,!0);for(l=0;l<this.bones_map.length;++l)d.setUint8(32+l,this.bones_map[l]);var u=176;for(l=0;l<this.skeleton.bones.length;++l){var t=this.skeleton.bones[l];d.setInt8(u,t.parent);for(var q=0;32>q;++q)d.setInt8(u+
q+1,t.name.charCodeAt(q)||0);for(q=0;16>q;++q)d.setFloat32(u+32+1+4*q,t.model[q],!0);d.setUint8(u+32+1+64,t.layer);d.setUint8(u+32+2+64,t.num_children);for(q=0;16>q;++q)d.setInt8(u+32+3+64+q,t.children[q]);u+=115}u=176+115*c;c=new Uint8Array(this.keyframes.buffer);p.set(c,u);return p};m.prototype.fromBinary=function(c){c.constructor===ArrayBuffer&&(c=new Uint8Array(c));var p=new DataView(c.buffer);if("ABIN"!=r(p,0,4))return console.error("not an animation file"),!1;var d=p.getInt32(4,!0);p.getInt32(8,
!0);this.duration=p.getFloat32(12,!0);this.samples_per_second=3==d?p.getInt32(16,!0):p.getFloat32(16,!0);this.num_animated_bones=p.getUint32(20,!0);this.num_keyframes=p.getUint32(24,!0);d=p.getUint32(28,!0);for(var l=0;l<this.bones_map.length;++l)this.bones_map[l]=p.getUint8(32+l);var u=176;this.skeleton.resizeBones(d);this.skeleton.bones_by_name.clear();for(l=0;l<d;++l){var t=this.skeleton.bones[l];t.parent=p.getInt8(u);t.name=r(p,u+1,32);for(var q=0;16>q;++q)t.model[q]=p.getFloat32(u+32+1+4*q,!0);
t.layer=p.getUint8(u+32+1+64);t.num_children=p.getUint8(u+32+2+64);for(q=0;16>q;++q)t.children[q]=p.getInt8(u+32+3+64+q);u+=115;this.skeleton.bones_by_name.set(t.name,l)}u=176+115*d;p=new Uint8Array(c.subarray(u,u+this.num_keyframes*this.num_animated_bones*64));this.keyframes=new Float32Array(p.buffer);this._datasize=c.length};v.SceneNode&&(v.SceneNode.prototype.assignSkeleton=function(c){var p=gl.meshes[this.mesh];p&&(this.bones=c.computeFinalBoneMatrices(this.bones,p),this.uniforms.u_bones=this.bones)},
v.SceneNode.prototype.assignAnimation=function(c){this.assignSkeleton(c.skeleton)});v.AnimatedCharacterFromScene=function(c,p,d){var l=[],u=[],t=d=null;t=c.constructor===v.SceneNode?c:c.root;for(var q=0;q<t.children.length;++q){var A=t.children[q];if(A.name&&("Armature"==A.name||-1!=A.name.indexOf("_Hips"))||"JOINT"==A.type||A.is_joint)d=A;else if(A.mesh){l.push(A);var H=null;gl.meshes[A.mesh]?H=gl.meshes[A.mesh]:c.meshes&&c.meshes[A.mesh]&&(H=GL.Mesh.load(c.meshes[A.mesh]));H&&u.push({mesh:H})}}!d&&
t.findNodesByFilter&&(q=t.findNodesByFilter(function(I){return I.skin}))&&q.length&&(d=q[0]);!l.length&&t.findNodesByFilter&&(l=t.findNodesByFilter(function(I){return I.mesh}));l.length&&l[0].skin&&l[0].skin.skeleton_root&&(d=t.findNodeByName(l[0].skin.skeleton_root));if(!d)throw"this scene doesnt contain an animated character";q=t=null;l.length&&(A=null,1<l.length?(q=GL.Mesh.mergeMeshes(u),A=l[0].mesh,q.filename=A):(A=l[0].mesh,gl.meshes[A]?(q=gl.meshes[A],q.filename=A):c.meshes&&(q=GL.Mesh.fromBinary(c.meshes[A]),
q.filename=A)),gl.meshes[A]=q,u=null,l[0].material?u=l[0].material:l[0].primitives&&l[0].primitives.length&&(u=l[0].primitives[0].material),v.Materials[u]?t=v.Materials[u]:c.materials&&(t=c.materials[u]));l=new v.Skeleton;l.importSkeleton(d,null);u=null;c.root&&c.root.animation?u=c.root.animation:c.animations&&(u=c.animations[0].id);d=null;null!=u&&(v.Animations[u]?d=v.Animations[u]:c.resources&&(c=c.resources[u],d=new v.Animation,d.fromJSON(c.takes["default"])));d?(c=new v.SkeletalAnimation,c.fromTracksAnimation(l,
d,30,null)):(console.warn("no animation in scene, creating pose one"),c=new v.SkeletalAnimation,c.fromPose(l));c.filename=p;return{mesh:q?q.filename:null,material:t,skeleton:l,skeletal_anim:c,tracks_anim:d}};g.prototype.serialize=g.prototype.toJSON;g.prototype.configure=g.prototype.fromJSON;D.prototype.serialize=D.prototype.toJSON;D.prototype.configure=D.prototype.fromJSON;n.prototype.serialize=n.prototype.toJSON;n.prototype.configure=n.prototype.fromJSON;f.prototype.serialize=f.prototype.toJSON;
f.prototype.configure=f.prototype.fromJSON;f.prototype.copyFrom=f.prototype.configure})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
