(function(v){function g(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();a&&this.origin.set(a);b&&this.direction.set(b)}function x(a,b){return vec3.dot(a,b)+a[3]}function q(a,b,e){var m=a[3];e=Math.abs(e[0]*a[0])+Math.abs(e[1]*a[1])+Math.abs(e[2]*a[2]);a=vec3.dot(a,b)+m;return a<=-e?H:a<=e?I:B}var c=v.RD={version:.5};c.ZERO=vec3.fromValues(0,0,0);c.ONE=vec3.fromValues(1,1,1);c.RIGHT=vec3.fromValues(1,0,0);c.LEFT=vec3.fromValues(-1,0,0);c.UP=vec3.fromValues(0,
1,0);c.DOWN=vec3.fromValues(0,-1,0);c.FRONT=vec3.fromValues(0,0,-1);c.BACK=vec3.fromValues(0,0,1);c.FRONT2D=vec2.fromValues(0,1);c.WHITE=vec3.fromValues(1,1,1);c.BLACK=vec3.fromValues(0,0,0);c.IDENTITY=mat4.create();c.ONES4=vec4.fromValues(1,1,1,1);c.TRANS10_IDENTITY=new Float32Array([0,0,0,0,0,0,1,1,1,1]);c.CENTER=0;c.TOP_LEFT=1;c.TOP_RIGHT=2;c.BOTTOM_LEFT=3;c.BOTTOM_RIGHT=4;c.TOP_CENTER=5;c.BOTTOM_CENTER=6;c.PRIORITY_BACKGROUND=30;c.PRIORITY_OPAQUE=20;c.PRIORITY_ALPHA=10;c.PRIORITY_HUD=0;c.BLEND_NONE=
0;c.BLEND_ALPHA=1;c.BLEND_ADD=2;c.BLEND_MULTIPLY=3;c.NO_BILLBOARD=0;c.BILLBOARD_SPHERIC=1;c.BILLBOARD_PARALLEL_SPHERIC=2;c.BILLBOARD_CYLINDRIC=3;c.BILLBOARD_PARALLEL_CYLINDRIC=4;c.UNKNOWN=0;c.NUMBER=c.SCALAR=1;c.VEC2=2;c.VEC3=3;c.VEC4=4;c.QUAT=5;c.MAT3=6;c.TRANS10=7;c.MAT4=8;c.STRING=9;c.TYPES={NUMBER:c.NUMBER,SCALAR:c.NUMBER,VEC2:c.VEC2,VEC3:c.VEC3,VEC4:c.VEC4,QUAT:c.QUAT,MAT3:c.MAT3,TRANS10:c.TRANS10,MAT4:c.MAT4,STRING:c.STRING};c.TYPES_SIZE=[0,1,2,3,4,4,9,10,16,0];c.NO_INTERPOLATION=0;c.LINEAR=
1;c.CUBIC=2;var p=c.DEG2RAD=.0174532925;c.RAD2DEG=57.295779578552306;var u={COLOR:1,COORD1:2,INSTANCING:4,SKINNING:8,POINTS:16,PHONG:32,TEXTURE:64,ALBEDO:128,EMISSIVE:256,OCCLUSION:512,ALPHA_HASH:1024,LIGHTS:2048,FOG:4096,FLAT_NORMAL:8192};c.Materials={};c.Images={};c.setup=function(a){a=a||{};if(c.configuration)throw"already called setup";c.configuration=a};var z=0;"undefined"==typeof extendClass&&(v.extendClass=function(a,b){for(var e in b)a.hasOwnProperty(e)||(a[e]=b[e]);if(b.prototype){var m=
Object.getOwnPropertyNames(b.prototype);for(e=0;e<m.length;++e){var h=m[e];a.prototype.hasOwnProperty(h)||(b.prototype.__lookupGetter__(h)?a.prototype.__defineGetter__(h,b.prototype.__lookupGetter__(h)):a.prototype[h]=b.prototype[h],b.prototype.__lookupSetter__(h)&&a.prototype.__defineSetter__(h,b.prototype.__lookupSetter__(h)))}}a.hasOwnProperty("superclass")||Object.defineProperty(a,"superclass",{get:function(){return b},enumerable:!1})});var A=mat4.create(),C=mat3.create(),d=mat4.create(),l=vec2.create(),
f=vec3.create(),k=vec3.create();vec4.create();var t=quat.create();class r{set id(a){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=a}get id(){return this._id}get position(){return this._position}set position(a){this._position.set(a);this._must_update_matrix=!0}get x(){return this._position[0]}set x(a){this._position[0]=a;this._must_update_matrix=!0}get y(){return this._position[1]}set y(a){this._position[1]=a;this._must_update_matrix=!0}get z(){return this._position[2]}set z(a){this._position[2]=
a;this._must_update_matrix=!0}get rotation(){return this._rotation}set rotation(a){this._rotation.set(a);this._must_update_matrix=!0}get scaling(){return this._scale}set scaling(a){a.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=a:this._scale.set(a);this._must_update_matrix=!0}get transform(){return this._transform}set transform(a){this._transform.set(a);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0}get matrix(){return this._local_matrix}set matrix(a){this.fromMatrix(a)}get pivot(){return this._pivot}set pivot(a){this._must_update_matrix=
!0;a?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(a),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)}set color(a){if(this.material){var b=this.getMaterial();b&&(b.color=a)}else console.warn("cannot set color of node without material")}get color(){var a=this.getMaterial();a&&a.color;console.warn("cannot get color of node without material");return null}get mustUpdate(){return this._must_update_matrix}set mustUpdate(a){a&&(this._must_update_matrix=!0)}get visible(){return this.flags.visible}set visible(a){this.flags.visible=
a}get scene(){return this._scene}set scene(a){throw"cannot set scene, you must use addChild in its parent node";}get parentNode(){return this._parent}set parentNode(a){throw"Cannot set parentNode of SceneNode, use addChild on parent";}constructor(a){this._uid=z++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);this._local_matrix=mat4.create();this._global_matrix=
mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.layers=3;this.draw_range=this.instances=this.mesh=null;this.submesh=-1;this.primitives=[];this.material=null;this.flags={visible:!0,collides:!0};this.extras={};this._parent=null;this.children=[];quat.identity(this._rotation);this._scale.set(c.ONE);a&&this.fromJSON(a)}clone(a){var b=new this.constructor,e;for(e in this)if("_"!=e[0])if("children"==e){if(a)for(var m=0;m<this.children.length;++m)b.addChild(this.children[m].clone(a))}else m=
this[e],void 0!==m&&(null===m?b[e]=null:m.constructor===Object?b[e]=GL.cloneObject(m):m.constructor===Array?b[e]=m.concat():b[e]!==m&&(b[e]=m));b.position=this.position;b.rotation=this.rotation;b.scaling=this.scaling;return b}toJSON(){var a={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(a.name=this.name);this.primitives&&
this.primitives.length&&(a.primitives=this.primitives.map(function(m){return Object.assign({},m)}));this.mesh&&(a.mesh=this.mesh);this.material&&(a.material=this.material);null!=this.submesh&&(a.submesh=this.submesh);this.flags&&(a.flags=JSON.parse(JSON.stringify(this.flags)));this.extras&&(a.extras=this.extras);this.animation&&(a.animation=this.animation);if(this.animations){a.animations=[];for(var b=0;b<this.animations.length;++b)a.animations.push(this.animations[b].toJSON())}if(this.skin)for(a.skin=
{},a.skin.joints=this.skin.joints.concat(),a.skin.skeleton_root=this.skin.skeleton_root,a.skin.bindMatrices=[],b=0;b<this.skin.bindMatrices.length;++b)a.skin.bindMatrices.push(typedArrayToArray(this.skin.bindMatrices[b]));this.skeleton&&(a.skeleton=this.skeleton.toJSON());if(this.onSerialize)this.onSerialize(a);if(this.children){b=0;for(var e=this.children.length;b<e;b++)a.children.push(this.children[b].toJSON())}return a}fromJSON(a){var b=null,e;for(e in a){switch(e){case "children":continue;case "uniforms":for(var m in a.uniforms)this.uniforms[m]=
a.uniforms[m];continue;case "flags":for(m in a.flags)this.flags[m]=a.flags[m];continue;case "scale":case "scaling":vec3.copy(this._scale,[1,1,1]);this.scale(a[e]);continue;case "tiling":isNumber(a[e])?this.setTextureTiling(a[e],a[e]):this.setTextureTiling(a[e][0],a[e][1],a[e][2],a[e][3]);continue;case "skeleton":var h=new c.Skeleton;h.fromJSON(a[e]);this.skeleton=h;continue;case "animations":this.animations=[];for(m=0;m<a.animations.length;++m)h=new c.Animation,h.fromJSON(a.animations[m]),this.animations.push(h);
continue;case "primitives":this.primitives=a.primitives.map(function(y){return Object.assign({},y)});continue;case "material":this.material=a[e]&&a[e].constructor===Object?(new M(a[e])).register().name:a[e];continue;case "name":case "mesh":case "ref":case "draw_range":case "submesh":case "skin":case "extra":case "extras":case "animation":this[e]=a[e];continue;case "parent":b=a[e]}h=this[e];void 0!==h&&(h&&h.constructor===Float32Array?h.set(a[e]):this[e]=a[e])}this._must_update_matrix=!0;this.updateGlobalMatrix();
if(a.children)for(this.removeAllChildren(),e=0;e<a.children.length;++e)m=new c.SceneNode,m.fromJSON(a.children[e]),this.addChild(m);b&&(this.parentNode?console.error("This node already has a parent"):b.addChild(this))}setMesh(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null}addChild(a,b){function e(m,h){if(m._scene&&m._scene!=h){var y=m._scene._nodes.indexOf(m);-1!=y&&m._scene._nodes.splice(y,1);m.id&&m._scene._nodes_by_id[m.id]==m&&delete m._scene._nodes_by_id[m.id]}if(m._scene=h)h._nodes.push(m),
m.id&&h&&(h._nodes_by_id[m.id]=m);if(m.children){y=0;for(var w=m.children.length;y<w;y++){var G=m.children[y];G._scene!=h&&e(G,h)}}}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";a._parent=this;b&&a.fromMatrix(a._global_matrix);this.children||(this.children=[]);this.children.push(a);this._scene!=a._scene&&e(a,this._scene);return this}removeChild(a,b){function e(h){if(h._scene){h.id&&h._scene._nodes_by_id[h.id]==h&&delete h._scene._nodes_by_id[h.id];var y=
h._scene._nodes.indexOf(h);-1!=y&&h._scene._nodes.splice(y,1)}h._scene=null;y=0;for(var w=h.children.length;y<w;y++)e(h.children[y])}if(a._parent!=this)throw"removeChild: Not its children";if(!this.children)return this;var m=this.children.indexOf(a);if(-1==m)throw"removeChild: impossible, should be children";this.children.splice(m,1);a._parent=null;b?a.fromMatrix(a._global_matrix):a._global_matrix.set(a._local_matrix);e(a);return this}removeAllChildren(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])}clear(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-
1])}remove(){this._parent&&this._parent.removeChild(this)}destroy(a){!this.scene||a?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)}setChildIndex(a,b){if(this.children){var e=this.children.indexOf(a);-1!=e&&(this.children.splice(e,1),this.children.splice(b,0,a))}}getAllChildren(a){a=a||[];if(!this.children)return a;for(var b=0,e=this.children.length;b<e;b++){var m=this.children[b];a.push(m);m.getAllChildren(a)}return a}getVisibleChildren(a,b,e){a=a||[];null==b&&(b=65535);
if(!this.children||!1===this.flags.visible)return a;for(var m=0,h=this.children.length;m<h;m++){var y=this.children[m];if(!1!==y.flags.visible){var w=y.layers&b;if(!e||w)w&&a.push(y),y.getVisibleChildren(a,b)}}return a}findNode(a){for(var b=0,e=this.children.length;b<e;b++){var m=this.children[b];if(m.id==a||(m=m.findNode(a)))return m}return null}findNodeByName(a){if(null==a)return null;for(var b=0,e=this.children.length;b<e;b++){var m=this.children[b];if(m.name==a||(m=m.findNodeByName(a)))return m}return null}findNodesByFilter(a,
b,e){null==b&&(b=65535);e=e||[];for(var m=0,h=this.children.length;m<h;m++){var y=this.children[m];y.layers&b&&(a&&!a(y)||e.push(y),y.findNodesByFilter(a,b,e))}return e}propagate(a,b){for(var e=0,m=this.children.length;e<m;e++){var h=this.children[e];h&&(h[a]&&h[a].apply(h,b),h.children&&h.children.length&&h.propagate(a,b))}}resetTransform(){this._position.set(c.ZERO);quat.identity(this._rotation);this._scale.set(c.ONE);this._must_update_matrix=!0}translate(a,b){b?this.getGlobalVector(a,f):f.set(a);
vec3.add(this._position,this._position,f);this._must_update_matrix=!0}moveLocal(a){this.translate(a,!0)}setEulerRotation(a,b,e){a&&3<=a.length?quat.fromEuler(this._rotation,a):quat.fromEuler(this._rotation,[a,b,e]);this._must_update_matrix=!0}getEulerRotation(a){a=a||vec3.create();quat.toEuler(a,this._rotation);return a}rotate(a,b,e){e&&(b=this.getGlobalVector(b,f));quat.setAxisAngle(t,b,a);quat.multiply(this._rotation,t,this._rotation);this._must_update_matrix=!0}rotateQuat(a,b){b?quat.multiply(this._rotation,
a,this._rotation):quat.multiply(this._rotation,this._rotation,a);this._must_update_matrix=!0}scale(a){a.constructor===Number?(f[0]=f[1]=f[2]=a,vec3.mul(this._scale,this._scale,f)):vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0}lookAt(a,b,e,m){this.position=a;this.orientTo(b,m,e)}orientTo(a,b,e,m,h){var y=this.getGlobalPosition(),w=vec3.create();m?w.set(a):vec3.sub(w,y,a);h&&(w[1]=0);e=e||c.UP;vec3.normalize(w,w);b&&vec3.scale(w,w,-1);a=mat3.create();e=vec3.cross(vec3.create(),e,w);
vec3.normalize(e,e);b=vec3.cross(vec3.create(),w,e);vec3.normalize(b,b);mat3.setColumn(a,e,0);mat3.setColumn(a,b,1);mat3.setColumn(a,w,2);quat.fromMat3(this._rotation,a);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0;return this}setPivot(a){this.pivot=a}getLocalMatrix(a){this._must_update_matrix&&this.updateLocalMatrix();return a?(a.set(this._global_matrix),a):this._local_matrix}getGlobalMatrix(a,b){this.updateGlobalMatrix(b);return a?(a.set(this._global_matrix),a):this._global_matrix}getGlobalRotation(a){a=
a||vec4.create();quat.identity(a);for(var b=this,e=this._scene?this._scene._root:null;b!=e;)quat.multiply(a,b._rotation,a),b=b._parent;return a}updateLocalMatrix(){var a=this._local_matrix;this._must_update_matrix=!1;mat4.identity(a);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(a[12]=this._pivot[0],a[13]=this._pivot[1],a[14]=this._pivot[2]),mat4.translate(a,a,this._position),mat4.fromQuat(d,this._rotation),mat4.multiply(a,a,d),mat4.scale(a,a,this._scale),this.flags.pivot&&this._pivot&&
mat4.translate(a,a,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))}updateGlobalMatrix(a,b){this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?(a=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,
b)}updateMatrices(a){this.updateLocalMatrix();this.updateGlobalMatrix(a)}fromMatrix(a,b){b&&this._parent&&this._parent._transform&&(mat4.copy(this._global_matrix,a),b=this._parent.getGlobalMatrix(),mat4.invert(b,b),a=mat4.multiply(this._local_matrix,b,a));b=mat4.clone(a);mat4.multiplyVec3(this._position,b,[0,0,0]);var e=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(e,b,c.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(e,b,c.UP));this._scale[2]=vec3.length(mat4.rotateVec3(e,b,c.BACK));
b=mat3.fromMat4(C,b);quat.fromMat3AndQuat(this._rotation,b);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1}getLocalPoint(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,a,this._local_matrix)}getParentVector(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)}getLocalVector(a){console.error("DEPRECATED: SceneNode.prototype.getLocalVector, use getGlobalVector or getParentVector")}getGlobalPosition(a,
b){a=a||vec3.create();if(b)return vec3.transformMat4(a,c.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return a.set(this._position),a;b=this.getGlobalMatrix();return vec3.transformMat4(a,c.ZERO,b)}localToGlobal(a,b,e){b=b||vec3.create();e=this.getGlobalMatrix(null,e);return vec3.transformMat4(b,a,e)}globalToLocal(a,b){b=b||vec3.create();var e=this.getGlobalMatrix();mat4.invert(d,e);return vec3.transformMat4(b,a,d)}globalVectorToLocal(a,b){b=b||vec3.create();var e=this.getGlobalRotation();
quat.invert(e,e);return vec3.transformQuat(b,a,e)}getGlobalVector(a,b){b=b||vec3.create();var e=this.getGlobalRotation(t);return vec3.transformQuat(b,a,e)}getDistanceTo(a){var b=this.getGlobalMatrix();return vec3.distance(a,b.subarray(12,15))}updateBoundingBox(a){var b=this._global_matrix,e=gl.meshes[this.mesh],m=null;e&&(m=e.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),m=BBox.transformMat4(this.bounding_box,m,b));if(a||!this.children||0==this.children.length)return m;for(a=
0;a<this.children.length;++a)if(b=this.children[a].updateBoundingBox())m?BBox.merge(m,m,b):(m=this.bounding_box=BBox.create(),m.set(b));return m}createMaterial(a){a=new c.Material(a);this.material=a.register().name;return a}getMaterial(a){a=a||0;return this.material?c.Materials[this.material]:this.primitives&&this.primitives.length>a?c.Materials[this.primitives[a].material]:null}setLayerBit(a,b){a=1<<a;this.layers&=~a;b&&(this.layers|=a)}isInLayerBit(a){return 0!==(this.layers&1<<a)}setRangeFromSubmesh(a){if(null!=
a&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(a.constructor===String){for(var e=0;e<b.info.groups.length;++e)if(b.info.groups[e].name==a){a=e;break}if(e===b.info.groups.length)return!1}if(a=b.info.groups[a])this.draw_range[0]=a.start,this.draw_range[1]=a.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null}findNodesInSphere(a,b,e,m){null==e&&(e=65535);m=m||[];for(var h=0;h<this.children.length;++h){var y=this.children[h];
y.layers&e&&(y.getGlobalPosition(f,!0),vec3.distance(f,a)<=b&&m.push(y));y.children.length&&y.findNodesInSphere(a,b,e,m)}return m}}c.SceneNode=r;r["@position"]={type:"vec3"};r["@scaling"]={type:"vec3"};r["@rotation"]={type:"quat"};r.prototype.testRay=function(){var a=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();mat4.create();return function(b,e,m,h,y,w){m=null==m?Number.MAX_VALUE:m;null==h&&(h=65535);e=e||vec3.create();void 0!==D._ray_tested_objects&&D._ray_tested_objects++;
var G=null,F=null;if(!1===this.flags.visible)return null;this.layers&h&&!1!==this.flags.collides&&this.mesh&&(F=this.testRayWithMesh(b,a,m,h,y,w));F&&(w=vec3.distance(b.origin,a),null==m||w<m)&&(m=w,e.set(a),G=this);if(!this.children||!this.children.length)return G;F=vec3.create();for(var J=0,L=this.children.length;J<L;++J){var O=this.children[J].testRay(b,F,m,h,y);O&&(w=vec3.distance(b.origin,F),w>m||(m=w,e.set(F),G=O))}return G}}();r.prototype.testRayWithMesh=function(){var a=vec3.create(),b=vec3.create(),
e=vec3.create(),m=mat4.create(),h=mat4.create();return function(y,w,G,F,J){if(!this.mesh)return!1;var L=gl.meshes[this.mesh];if(!L||!1===L.ready)return!1;var O=null==this.submesh?-1:this.submesh,P=this.getGlobalMatrix(m,!0),N=L.getBoundingBox();if(0!==P[0]&&P[0]===P[5]&&P[0]===P[10]&&!geo.testRaySphere(y.origin,y.direction,vec3.transformMat4(a,N.subarray(0,3),P),vec3.length(N.subarray(3,6))*P[0],void 0,G))return!1;mat4.invert(h,P);vec3.transformMat4(a,y.origin,h);vec3.add(e,y.origin,y.direction);
vec3.transformMat4(e,e,h);vec3.sub(b,e,a);vec3.normalize(b,b);N=this.flags.two_sided;if(this.primitives&&this.primitives.length){var V=c.Materials[this.primitives[0].material];V&&(N=V.flags.two_sided)}return c.testRayMesh(y,a,b,P,L,O,w,G,F,J,N)}}();r.prototype.testSphere=function(){return function(a,b,e,m){null==e&&(e=65535);var h=null;if(!1===this.flags.visible)return null;this.layers&e&&!1!==this.flags.collides&&this.mesh&&(h=this.testSphereWithMesh(a,b,e,m));if(h)return this;if(!this.children||
!this.children.length)return null;h=0;for(var y=this.children.length;h<y;++h){var w=this.children[h].testSphere(a,b,e,m);if(w)return w}return null}}();r.prototype.testSphereWithMesh=function(){var a=vec3.create();vec3.create();vec3.create();var b=mat4.create(),e=mat4.create();return function(m,h,y,w){if(!this.mesh)return!1;var G=gl.meshes[this.mesh];if(!G||!1===G.ready)return!1;var F=null==this.submesh?-1:this.submesh,J=this.getGlobalMatrix(b,!0);mat4.invert(e,J);vec3.transformMat4(a,m,e);m=h/vec3.length(J);
h=this.flags.two_sided;if(this.primitives&&this.primitives.length){var L=c.Materials[this.primitives[0].material];L&&(h=L.flags.two_sided)}return c.testSphereMesh(a,m,J,G,F,y,w,h)}}();r.prototype.findNearestPointToMesh=function(){var a=mat4.create(),b=mat4.create(),e=vec3.create();return function(m,h,y,w,G){if(!this.mesh)return!1;var F=gl.meshes[this.mesh];if(!F||!1===F.ready)return Infinity;G?vec3.copy(e,m):(this.getGlobalMatrix(a),mat4.invert(b,a),vec3.transformMat4(e,m,b));F.octree||(F.octree=
new GL.Octree(F));m=F.octree.findNearestPoint(e,y,h,w);if(m===h)return m;G||vec3.transformMat4(y,y,a);return m}}();r.prototype.findNearestPointToNode=function(a,b,e,m){var h=null,y=b;this.mesh&&this.flags.collides&&(y=this.findNearestPointToMesh(a,b,e,m),y<b&&(h={node:this,distance:y}));for(let w=0;w<this.children.length;++w)this.children[w].flags.collides&&(b=this.findNearestPointToNode(a,y,e,m),b.distance<y&&(h=b));return h};class n{static $jscomp$static$init$m289530114$0$PERSPECTIVE(){return 1}static $jscomp$static$init$m289530114$1$ORTHOGRAPHIC(){return 2}constructor(a){this.type=
c.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();
this._front=vec3.create();this._uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(.1,1E3)};a&&this.fromJSON(a);this.updateMatrices()}}n.PERSPECTIVE=n.$jscomp$static$init$m289530114$0$PERSPECTIVE();n.ORTHOGRAPHIC=n.$jscomp$static$init$m289530114$1$ORTHOGRAPHIC();c.Camera=n;n.prototype.fromJSON=function(a){null!=a.type&&(this.type=
a.type);a.position&&this._position.set(a.position);a.target&&this._target.set(a.target);a.up&&this._up.set(a.up);a.near&&(this.near=a.near);a.far&&(this.far=a.far);a.fov&&(this.fov=a.fov);a.aspect&&(this.aspect=a.aspect)};n.prototype.toJSON=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};Object.defineProperty(n.prototype,"position",
{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"fov",{get:function(){return this._fov},
set:function(a){this._fov=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(a){this._frustum_size=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"near",{get:function(){return this._near},set:function(a){this._near=
this._uniforms.u_camera_planes[0]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"far",{get:function(){return this._far},set:function(a){this._far=this._uniforms.u_camera_planes[1]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(n.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(a){this._view_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(n.prototype,
"projection_matrix",{get:function(){return this._projection_matrix},set:function(a){this._projection_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(n.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(a){this._viewprojection_matrix.set(a)},enumerable:!1});n.prototype.perspective=function(a,b,e,m){this.type=n.PERSPECTIVE;this._fov=a;this._aspect=b;this._near=e;
this._far=m;this._must_update_matrix=!0};n.prototype.orthographic=function(a,b,e,m){this.type=n.ORTHOGRAPHIC;this._frustum_size=a;1<arguments.lenth&&(this._near=b,this._far=e,this._aspect=m||1);this._must_update_matrix=!0};n.prototype.lookAt=function(a,b,e){this._position==b&&(b=vec3.clone(b));vec3.copy(this._position,a);vec3.copy(this._target,b);vec3.copy(this._up,e);this._must_update_matrix=!0};n.prototype.updateMatrices=function(a){if(this._autoupdate_matrices||a)if(this.type==n.ORTHOGRAPHIC?this.frustum_size.constructor===
Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*p,this._aspect,this._near,
this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up),this.view_texel_grid&&this.type==n.ORTHOGRAPHIC){a=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var b=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/a)*
a;this._view_matrix[13]=Math.floor(this._view_matrix[13]/b)*b}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,c.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,c.UP);mat4.rotateVec3(this._front,this._model_matrix,c.FRONT);this.distance=vec3.distance(this._position,
this._target);this._uniforms.u_camera_planes[0]=this._near;this._uniforms.u_camera_planes[1]=this._far};n.prototype.getModel=function(a){a=a||mat4.create();this._must_update_matrix&&this.updateMatrices();mat4.copy(a,this._model_matrix);return a};n.prototype.updateVectors=function(a){var b=vec3.subtract(f,this._target,this._position);b=vec3.length(b);mat4.multiplyVec3(this._position,a,c.ZERO);mat4.multiplyVec3(this._target,a,[0,0,-b]);mat4.rotateVec3(this._up,a,c.UP)};n.prototype.getLocalVector=function(a,
b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,a)};n.prototype.localToGlobal=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};n.prototype.getLocalPoint=n.prototype.localToGlobal;n.prototype.globalToLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._view_matrix)};n.prototype.globalVectorToLocal=
function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._view_matrix,a)};n.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this._target,this._position);vec3.normalize(a,a);return a};n.prototype.move=function(a,b){void 0!==b&&(vec3.scale(f,a,b),a=f);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};n.prototype.moveLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();
a=mat4.rotateVec3(f,this._model_matrix,a);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};n.prototype.rotate=function(a,b){a=quat.setAxisAngle(t,b,a);b=vec3.subtract(f,this._target,this._position);vec3.transformQuat(b,b,a);vec3.add(this._target,this._position,b);this._must_update_matrix=!0};n.prototype.rotateLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();b=mat4.rotateVec3(k,this._model_matrix,
b);a=quat.setAxisAngle(t,b,a);b=vec3.subtract(f,this._target,this._position);vec3.transformQuat(b,b,a);vec3.add(this._target,this._position,b);this._must_update_matrix=!0};n.prototype.orbit=function(a,b,e,m){if(!b)throw"RD: orbit axis missing";e=e||this._target;m&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(k,this._model_matrix,b));a=quat.setAxisAngle(t,b,a);b=vec3.subtract(f,this._position,this._target);vec3.transformQuat(b,b,a);vec3.add(this._position,e,b);this._must_update_matrix=
!0};n.prototype.orbitDistanceFactor=function(a,b){b=b||this._target;var e=vec3.subtract(f,this._position,b);vec3.scale(e,e,a);vec3.add(this._position,b,e);this._must_update_matrix=!0};n.prototype.project=function(a,b,e){e=e||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(e,this._viewprojection_matrix,a);e[0]=e[0]*b[2]+b[0];e[1]=e[1]*b[3]+b[1];return e};n.prototype.computeProjectedRadius=function(a,b,e,m){e=e||gl.viewport_data;if(m)return m=vec4.create(),
m.set(a),m[3]=1,a=vec4.transformMat4(m,m,this._viewprojection_matrix),Math.max(1,e[3]*this._projection_matrix[5]*b/a[3]);if(this.type==c.Camera.ORTHOGRAPHIC)return b/(this._frustum_size.constructor===Number?this._frustum_size:1)*e[3]/2;a=vec3.distance(a,this.position);return 0==a?0:1/Math.tan(this.fov/2*Math.PI/180)*b/Math.sqrt(a*a-b*b)*(e[3]/2)};n.prototype.unproject=function(a,b,e){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(e||vec3.create(),a,this._viewprojection_matrix,
b)};n.prototype.getRay=function(a,b,e,m){if(void 0===a||void 0===b)throw"RD.Camera.getRay requires x and y parameters";e=e||gl.viewport_data;m||=new c.Ray;this._must_update_matrix&&this.updateMatrices();var h=m.origin;vec3.set(h,a,b,0);this.type==c.Camera.ORTHOGRAPHIC?vec3.unproject(h,h,this._viewprojection_matrix,e):vec3.copy(h,this.position);var y=m.direction;vec3.set(y,a,b,1);vec3.unproject(y,y,this._viewprojection_matrix,e);vec3.sub(y,y,h);vec3.normalize(y,y);return m};n.prototype.getRayPlaneCollision=
function(a,b,e,m,h,y){h=h||vec3.create();a=this.getRay(a,b,y);return geo.testRayPlane(a.origin,a.direction,e,m,h)?h:null};n.prototype.getModelForScreenPixel=function(a,b,e,m,h){h=h||mat4.create();a=this.unproject([a,b,-1]);b=vec3.sub(vec3.create(),a,this._position);vec3.normalize(b,b);vec3.scaleAndAdd(a,a,b,e);vec3.normalize(b,b);mat4.fromTranslationFrontTop(h,a,b,this._up);return h};n.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};n.prototype.applyController=function(a,b,e,
m){e=e||10;if(a){var h=vec3.create();if(gl.keys[n.controller_keys.forward]||m&&gl.keys.W)h[2]=-1;else if(gl.keys[n.controller_keys.back]||m&&gl.keys.S)h[2]=1;if(gl.keys[n.controller_keys.left]||m&&gl.keys.A)h[0]=-1;else if(gl.keys[n.controller_keys.right]||m&&gl.keys.D)h[0]=1;vec3.sqrLen(h)&&this.moveLocal(h,a*e)}b&&(a=b.deltax||b.movementX,b=b.deltay||b.movementY,a&&this.rotate(-.005*a,c.UP),b&&this.rotateLocal(-.005*b,c.RIGHT))};n.prototype.lerp=function(a,b){vec3.lerp(this._position,this._position,
a._position,b);vec3.lerp(this._target,this._target,a._target,b);vec3.lerp(this._up,this._up,a._up,b);this._fov=this._fov*(1-b)+a._fov*b;this._near=this._near*(1-b)+a._near*b;this._far=this._far*(1-b)+a._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+a._frustum_sizer*b);this._must_update_matrix=!0};n.prototype.orientMatrixToCamera=function(a){a.set(this._right,0);a.set(this._top,4);a.set(this._front,8)};n.prototype.extractPlanes=function(){function a(m){var h=
e.subarray(m,m+3);h=vec3.length(h);h=1/h;e[m]*=h;e[m+1]*=h;e[m+2]*=h;e[m+3]*=h}var b=this._viewprojection_matrix,e=this._planes_data||new Float32Array(24);e.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);a(0);e.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);e.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);a(8);e.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);e.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);e.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],
20);a(20);this._planes_data=e;this._frustrum_planes||(this._frustrum_planes=[e.subarray(0,4),e.subarray(4,8),e.subarray(8,12),e.subarray(12,16),e.subarray(16,20),e.subarray(20,24)])};var B=c.CLIP_INSIDE=0,H=c.CLIP_OUTSIDE=1,I=c.CLIP_OVERLAP=2;n.prototype.testMesh=function(){if(v.BBox){var a=BBox.create(),b=a.subarray(0,3),e=a.subarray(3,6);return function(m,h){m=m.bounding;if(!m)return B;BBox.transformMat4(a,m,h);return this.testBox(b,e)}}}();n.prototype.testBox=function(a,b){this._frustrum_planes||
this.extractPlanes();var e=this._frustrum_planes,m=0;var h=q(e[0],a,b);if(h==H)return H;m+=h;h=q(e[1],a,b);if(h==H)return H;m+=h;h=q(e[2],a,b);if(h==H)return H;m+=h;h=q(e[3],a,b);if(h==H)return H;m+=h;h=q(e[4],a,b);if(h==H)return H;m+=h;h=q(e[5],a,b);return h==H?H:0==m+h?B:I};n.prototype.testSphere=function(a,b){this._frustrum_planes||this.extractPlanes();var e=this._frustrum_planes,m=!1;var h=x(e[0],a);if(h<-b)return H;h>=-b&&h<=b&&(m=!0);h=x(e[1],a);if(h<-b)return H;h>=-b&&h<=b&&(m=!0);h=x(e[2],
a);if(h<-b)return H;h>=-b&&h<=b&&(m=!0);h=x(e[3],a);if(h<-b)return H;h>=-b&&h<=b&&(m=!0);h=x(e[4],a);if(h<-b)return H;h>=-b&&h<=b&&(m=!0);h=x(e[5],a);if(h<-b)return H;h>=-b&&h<=b&&(m=!0);return m?I:B};class D{constructor(){this._root=new c.SceneNode;this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}}c.Scene=D;D.prototype.clear=function(){this._root=new c.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id=
{};this.time=0};D.prototype.getNodeById=function(a){return this._nodes_by_id[a]};D.prototype.findNodesInBBox=function(a,b,e){null==b&&(b=65535);e=e||[];for(var m=0;m<this.nodes.length;++m){var h=this.nodes[m];h.bounding_box&&h.layers&b&&geo.testBBoxBBox(h.bounding_box,a)&&e.push(h)}return e};D.prototype.update=function(a){this.time+=a;this._root.propagate("update",[a]);this.destroyPendingNodes()};D.prototype.destroyPendingNodes=function(a){if(this._to_destroy.length)for(;a=this._to_destroy.pop();)a._parent&&
a._parent.removeChild(a)};Object.defineProperty(D.prototype,"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});D.prototype.testRay=function(a,b,e,m,h){c.Scene._ray_tested_objects=0;b||(b=a.collision_point);null==h&&(h=!0);return this.root.testRay(a,b,e,null==m?65535:m,h)};D.prototype.testSphere=function(a,b,e,m){null==m&&(m=!0);return this.root.testSphere(a,b,null==e?65535:e,m)};D.prototype.gatherObjects=function(a,b,e){e=e||[];a.updateGlobalMatrix(!0);
if(a.mesh&&b&a.layers&&!a.skeleton){if(a.primitives&&a.primitives.length)for(var m=0;m<a.primitives.length;++m){var h=a.primitives[m];(this.overwrite_material||c.Materials[h.material])&&e.push([a,a._global_matrix,a.mesh,m,a.material])}}else e.push([a,a._global_matrix,a.mesh,-1,a.material]);for(m=0;m<a.children.length;++m)this.gatherObjects(a.children[m],b,e);return e};c.testRayWithNodes=function(a,b,e,m,h,y,w){c.testRayWithNodes.coll_node=null;m=null==m?Number.MAX_VALUE:m;h=null==h?65535:h;c.Scene._ray_tested_objects=
0;e||(e=a.collision_point);c.testRayWithNodes.local_result||(c.testRayWithNodes.local_result=vec3.create());for(var G=c.testRayWithNodes.local_result,F=null,J=0;J<b.length;++J){var L=b[J],O=L.testRay(a,G,m,h,y);if(O){var P=vec3.distance(a.origin,G);P>m||(m=P,e.set(G),c.testRayWithNodes.coll_node=O,F=w?O:L)}}return F};c.last_hit_test=null;c.testRayMesh=function(a,b,e,m,h,y,w,G,F,J,L){G=null==G?Number.MAX_VALUE:G;-1==y?(F=h.getBoundingBox(),y=h):(y=h.info.groups[y],F=y.bounding,F||(h.computeGroupsBoundingBoxes(),
F=y.bounding));if(!F)return!1;G||=1E7;if(!geo.testRayBBox(b,e,F,null,f))return!1;vec3.transformMat4(w,f,m);F=vec3.distance(a.origin,w);if(F>G)return!1;if(!J)return!0;y._octree||(y._octree=y==h?new GL.Octree(h):new GL.Octree(h,y.start,y.length));b=y._octree.testRay(b,e,0,G,L);if(!b)return!1;c.last_hit_test=b;w.set(b.hit);vec3.transformMat4(w,w,m);F=vec3.distance(a.origin,w);return F>G?!1:!0};c.testSphereMesh=function(a,b,e,m,h,y,w){-1==h?(e=m.getBoundingBox(),h=m):(h=m.info.groups[h],e=h.bounding,
e||(m.computeGroupsBoundingBoxes(),e=h.bounding));if(!e||!geo.testSphereBBox(a,b,e))return!1;if(!w)return!0;h._octree||(h._octree=h==m?new GL.Octree(m):new GL.Octree(m,h.start,h.length));return h._octree.testSphere(a,b)?!0:!1};D.prototype.fromJSON=function(a){this.root.clear();this.root.fromJSON(a)};D.prototype.toJSON=function(a){function b(h,y){if(a){if(!a(h,y))return!1}else{if(!h.flags.no_transform){y.position=typedArrayToArray(h.position);if(0!=h.rotation[0]||0!=h.rotation[1]||0!=h.rotation[2]||
1!=h.rotation[3])y.rotation=typedArrayToArray(h.rotation);if(1!=h.scaling[0]||1!=h.scaling[1]||1!=h.scaling[2])y.scaling=typedArrayToArray(h.scaling)}h.id&&(y.id=h.id);h.ref=y.ref=e++;h.mesh&&(y.mesh=h.mesh);null!=h.submesh&&(y.submesh=h.submesh);h.draw_range&&(y.draw_range=h.draw_range.concat());h.material&&(y.material=h.material);h.extra&&(y.extra=h.extra);y.layers=h.layers;y.flags=h.flags}if(!h.children.length)return!0;for(var w=[],G=0;G<h.children.length;++G){var F={};b(h.children[G],F)&&w.push(F)}w.length&&
(y.children=w);return!0}a&&a.constructor!==Function&&(a=null);var e=0,m={};b(this.root,m);return m};var K={u_model:null};class M{static $jscomp$static$init$m289530114$2$last_material_id(){return 0}constructor(a){this._color=vec4.fromValues(1,1,1,1);this._emissive=vec3.fromValues(0,0,0);this.shader_name=null;this.uniforms={};this.textures={};this.primitive=-1;this.blend_mode=c.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};a&&this.fromJSON(a)}set color(a){this._color.set(a)}get color(){return this._color}set albedo(a){this._color.set(a)}get albedo(){return this._color}set emissive(a){this._emissive.set(a)}get emissive(){return this._emissive}set opacity(a){this._color[3]=
a}get opacity(){return this._color[3]}fromJSON(a){for(var b in a){var e=a[b];if(e)if("name"===b)this.register(e);else if("material"===b&&e)e.constructor===Object?(e=new c.Material(e),this.register(),e=e.name):e.constructor===c.Material&&(this.register(),e=e.name);else if("texture"===b){this.textures.color=e;continue}else e.constructor===Object?e=JSON.parse(JSON.stringify(e)):e.constructor===Array?e=e.concat():e.constructor===Float32Array&&(e=new Float32Array(e));this[b]=e}}register(a){a||=this.name||
c.makeHash(32);this.name=a;c.Materials[this.name]=this;return this}toJSON(){var a={flags:JSON.parse(JSON.stringify(this.flags)),textures:JSON.parse(JSON.stringify(this.textures))};a.color=typedArrayToArray(this._color);this.name&&(a.name=this.name);this.alphaMode&&(a.alphaMode=this.alphaMode);this.blendMode&&(a.blendMode=this.blendMode);.5!=this.alphaCutoff&&(a.alphaCutoff=this.alphaCutoff);this.uv_transform&&(a.uv_transform=this.uv_transform);this.normalFactor&&(a.normalFactor=this.normalFactor);
this.displacementFactor&&(a.displacementFactor=this.displacementFactor);this.backface_color&&(a.backface_color=typedArrayToArray(this.backface_color));this.emissive&&(a.emissive=typedArrayToArray(this.emissive));this.model&&(a.model=this.model,a.metallicFactor=this.metallicFactor,a.roughnessFactor=this.roughnessFactor);return a}render(a,b){var e=b.mesh,m=b.node,h=b.skin,y=a._camera;if(a.on_getShader){var w=a.on_getShader(b.node,y);if(!w)return}else(w=a.shader_overwrite||this.shader_name)?w=gl.shaders[w]:
(w=0,a.use_alpha_hash&&(w|=u.ALPHA_HASH),a.use_flat_normal&&(w|=u.FLAT_NORMAL),a.use_fog&&(w|=u.FOG),e.vertexBuffers.colors&&(w|=u.COLOR),e.vertexBuffers.coords1&&(w|=u.COORD1),h&&(w|=u.SKINNING),b.instances&&(w|=u.INSTANCING),"phong"==a.light_model&&(w|=u.PHONG),this.textures.color&&(w|=u.TEXTURE),this.textures.albedo&&(w|=u.ALBEDO),this.textures.emissive&&(w|=u.EMISSIVE),this.textures.occlusion&&(w|=u.OCCLUSION),w=a.getMasterShader(w));w||(w=this.textures.color||this.textures.albedo,w=h?w?a._texture_skinning_shader:
a._flat_skinning_shader:w?a._texture_shader:a._flat_shader);var G=!1;b.instances&&a.supports_instancing&&(G=!0);G&&!w.attributes.u_model&&(G=!1);var F=0,J=null,L;for(L in this.textures){var O=this.textures[L];if(O){O.constructor===Object&&(O=O.texture);var P="u_"+L+"_texture";if(!w||w.samplers[P])J=gl.textures[O],J||(a.autoload_assets&&-1!=O.indexOf(".")&&a.loadTexture(O,a.default_texture_settings),J=gl.textures.white),this.uniforms[P]=J.bind(F++)}}J||(w.samplers.u_albedo_texture||w.samplers.u_color_texture)&&
gl.textures.white.bind(0);a.enableItemFlags(this);a._uniforms.u_model.set(b.model);h&&w.uniformInfo.u_bones&&(this.bones=h.computeFinalBoneMatrices(this.bones,e),w.setUniform("u_bones",this.bones));a._uniforms.u_global_alpha_clip=null!=this.alphaCutoff&&"MASK"==this.alphaMode?this.alphaCutoff:-1;w.uniforms(a._uniforms);w.uniforms(y._uniforms);a.use_fog&&w.uniforms(a._fog_uniforms);w.setUniform("u_color",this._color);w.setUniform("u_emissive",this._emissive);w.uniforms(this.uniforms);"phong"==a.light_model&&
w.uniforms(a._phong_uniforms);if(a.onNodeShaderUniforms)a.onNodeShaderUniforms(a,w,m);a.use_alpha_hash&&w.hasUniform("u_bayer_texture")&&w.uniforms({u_bayer_texture:a._bayer_texture.bind(F++)});h=null;null!=b.group_index&&e.info&&e.info.groups&&e.info.groups[b.group_index]&&(h=e.info.groups[b.group_index]);y=b.primitive;if(null==y||-1==y)y=gl.TRIANGLES;if(G)K.u_model=b.instances,h?w.drawInstanced(e,y,b.index_buffer_name,K,h.start,h.length):m.draw_range?w.drawInstanced(e,y,b.index_buffer_name,K,b.draw_range[0],
b.draw_range[1]):w.drawInstanced(e,y,b.index_buffer_name,K);else if(b.instances){for(L=0;L<b.instances.length;L++)w.setUniform("u_model",b.instances[L]),h?w.drawRange(e,y,h.start,h.length,b.index_buffer_name):b.draw_range?w.drawRange(e,y,b.index_buffer_name,b.draw_range[0],b.draw_range[1]):w.draw(e,y,b.index_buffer_name),a.draw_calls+=1;a.draw_calls--}else h?w.drawRange(e,y,h.start,h.length,b.index_buffer_name):b.draw_range?w.drawRange(e,y,b.index_buffer_name,b.draw_range[0],b.draw_range[1]):w.draw(e,
y,b.index_buffer_name);a.disableItemFlags(this);a.draw_calls+=1}}M.last_material_id=M.$jscomp$static$init$m289530114$2$last_material_id();c.Material=M;class E{constructor(a,b){b=b||{};var e=this.gl=this.context=a=a.constructor===HTMLCanvasElement?GL.create({canvas:a,version:2}):a;if(!e||!e.enable)throw"litegl GL context not found.";a!=v.gl&&e.makeCurrent();this.assets_folder="";this.layers_affect_children=this.use_fog=this.use_flat_normal=this.use_alpha_hash=this.disable_cull_face=this.reverse_normals=
!1;this.light_model="flat";this.allow_instancing=!0;this.point_size=1;this._color=vec4.fromValues(1,1,1,1);this._model_matrix=mat4.create();this._mvp_matrix=mat4.create();this._texture_matrix=mat3.create();this.renderables=[];this.renderables_pool=[];this.rendered_renderables=this.used_renderables=0;this.overlay_renderables=[];this._nodes=[];this._uniforms={u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_point_size:this.point_size,u_res:new Float32Array([1,1,1,1])};this._fog_uniforms=
{u_fog_color:new Float32Array([.5,.5,.5,1])};this.global_uniforms_containers=[this._uniforms];this.ambient_light=vec3.fromValues(.6,.67,.8);this.light_color=vec3.fromValues(.5,.4,.3);this.light_vector=vec3.fromValues(.5442,.6385,.544);this._phong_uniforms={u_ambient:this.ambient_light,u_light_vector:this.light_vector,u_light_color:this.light_color};v.gl=this.gl;this.canvas=e.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings=
{wrap:e.REPEAT,minFilter:e.LINEAR_MIPMAP_LINEAR,magFilter:e.LINEAR};this.default_cubemap_settings={minFilter:e.LINEAR_MIPMAP_LINEAR,magFilter:e.LINEAR,is_cross:1};this.default_material=new c.Material;this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=
new GL.Texture(1,1,{filter:e.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:e.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.textures.bayer8x8=this._bayer_texture=new GL.Texture(8,8,{format:GL.LUMINANCE,pixel_data:new Uint8Array([0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21])});this._bayer_texture.setParameter(GL.TEXTURE_MAG_FILTER,
e.NEAREST);this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.supports_instancing=e.extensions.ANGLE_instanced_arrays||1<e.webgl_version;this.createShaders();b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}}E.prototype.getMasterShader=function(a){this.master_shaders_compiled||(this.master_shaders_compiled=new Map);var b=this.master_shaders_compiled,e=b.get(a);if(e)return e;e=E.master_vertex_shader;var m=E.master_fragment_shader;
c.Skeleton&&a&u.SKINNING&&(e=e.replaceAll("#pragma SKINNING_HEADER",`
		#ifdef SKINNING
			${c.Skeleton.shader_code} //
		#endif
		`),e=e.replaceAll("#pragma SKINNING_BODY","\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t"));var h=null;if(a){h={};for(var y in u)a&u[y]&&(h[y]="")}e=new GL.Shader(e,m,h);b.set(a,e);return e};E.master_vertex_shader="\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\t#ifndef FLAT_NORMAL\n\t\tattribute vec3 a_normal;\n\t#endif\n\tattribute vec2 a_coord;\n\t#ifdef COORD1\n\t\tattribute vec2 a_coord1;\n\t\tvarying vec2 v_coord1;\n\t#endif\n\tvarying vec3 v_pos;\n\tvarying vec3 v_normal;\n\tvarying vec2 v_coord;\n\t#ifdef COLOR\n\tattribute vec4 a_color;\n\tvarying vec4 v_color;\n\t#endif\n\n\t#pragma SKINNING_HEADER\n\t#ifdef INSTANCING\n\t\tattribute mat4 u_model;\n\t#else\n\t\tuniform mat4 u_model;\n\t#endif\n\tuniform mat4 u_viewprojection;\n\tuniform float u_point_size;\n\n\tvoid main() {\n\t\tv_pos = a_vertex;\n\t\t#pragma SKINNING_BODY\n\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t#ifndef FLAT_NORMAL\n\t\tv_normal = a_normal;\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t#endif\n\t\tv_coord = a_coord;\n\t\t#ifdef COORD1\n\t\t\tv_coord1 = a_coord1;\n\t\t#endif\n\t\t#ifdef COLOR\n\t\tv_color = a_color;\n\t\t#endif\n\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\tgl_PointSize = u_point_size;\n\t}\n";
E.master_fragment_shader="\n\t#extension GL_OES_standard_derivatives : enable\n\t\n\tprecision highp float;\n\tvarying vec3 v_pos;\n\tvarying vec2 v_coord;\n\tvarying vec3 v_normal;\n\tuniform vec4 u_color;\n\tuniform vec3 u_emissive;\n\t#ifdef COLOR\n\tvarying vec4 v_color;\n\t#endif\n\t#ifdef TEXTURE\n\t\tuniform sampler2D u_color_texture;\n\t#endif\n\t#ifdef ALBEDO\n\t\tuniform sampler2D u_albedo_texture;\n\t#endif\n\t#ifdef EMISSIVE\n\t\tuniform sampler2D u_emissive_texture;\n\t#endif\n\t#ifdef OCCLUSION\n\t\tuniform sampler2D u_occlusion_texture;\n\t#endif\n\t#ifdef COORD1\n\t\tvarying vec2 v_coord1;\n\t#else\n\t\tvec2 v_coord1;\n\t#endif\t\n\t#ifdef PHONG\n\t\tuniform vec3 u_ambient;\n\t\tuniform vec3 u_light_color;\n\t\tuniform vec3 u_light_vector;\n\t#endif\n\t#ifdef FOG\n\t\tuniform vec4 u_fog_color;\n\t#endif\n\n\t#ifdef LIGHTS\n\t\t//WIP\n\t\tuniform int u_num_lights;\n\t\tuniform vec4 u_light_color[4]; //color, type\n\t\tuniform vec4 u_light_position[4]; //pos or vector\n\t\tuniform vec4 u_light_params[4]; //front, max_dist\n\t\tuniform vec4 u_light_shadowmap_area[4];\n\t\tuniform vec4 u_light_shadowmap_vps[4];\n\t\tuniform sampler2D u_shadowmap;\n\t#endif\n\t#ifdef ALPHA_HASH\n\t\tuniform sampler2D u_bayer_texture;\n\n\t\tfloat bayer8x8(vec2 position) {\n\t\t\tint x = int(mod(position.x, 8.0));\n\t\t\tint y = int(mod(position.y, 8.0));\n\t\t\treturn texture2D( u_bayer_texture, vec2(float(x)/8.0,float(y)/8.0)).x * 4.0;\n\t\t}\n\t#endif\n\n\tuniform float u_global_alpha_clip;\n\tuniform vec4 u_res;\n\tuniform vec3 u_camera_position;\n\tuniform vec2 u_camera_planes;\n\n\tfloat linearize_depth(float d)\n\t{\n\t\tfloat z_n = 2.0 * d - 1.0;\n\t\treturn 2.0 * u_camera_planes.x * u_camera_planes.y / (u_camera_planes.y + u_camera_planes.x - z_n * (u_camera_planes.y - u_camera_planes.x));\n\t}\t\n\n\tvoid main() {\n\t\tvec4 color = u_color;\n\t\t#ifndef COORD1\n\t\t\tv_coord1 = v_coord;\n\t\t#endif\t\t\n\t\t#ifdef ALBEDO\n\t\t\tcolor *= texture2D(u_albedo_texture, v_coord);\n\t\t#endif\n\t\t#ifdef TEXTURE\n\t\t\tcolor *= texture2D(u_color_texture, v_coord);\n\t\t#endif\n\t\t#ifdef COLOR\n\t\t\tcolor *= v_color;\n\t\t#endif\n\t\tif(color.a <= u_global_alpha_clip)\n\t\t\tdiscard;\n\t\t#ifdef ALPHA_HASH\n\t\tif(color.a < bayer8x8(gl_FragCoord.xy))\n\t\t\tdiscard;\n\t\t#endif\n\n\t\t#ifdef FLAT_NORMAL\n\t\t\tvec3 A = dFdx(v_pos);\n\t\t\tvec3 B = dFdy(v_pos);\n\t\t\tvec3 N = normalize(cross(A,B));\n\t\t#else\n\t\t\tvec3 N = normalize(v_normal);\n\t\t#endif\n\t\tvec3 light = vec3(1.0);\n\t\t#ifdef PHONG\n\t\t\tfloat NdotL = max(dot(N,u_light_vector),0.0);\n\t\t\tlight = ( u_ambient * (1.0 - max(0.0,-N.y) * 0.5 ) ) + NdotL * u_light_color;\n\t\t#endif\n\t\t#ifdef OCCLUSION\n\t\t\tlight = texture2D(u_occlusion_texture, v_coord1).xyz;\n\t\t#endif\n\t\tcolor.xyz *= light;\n\t\t#ifdef EMISSIVE\n\t\t\tcolor.xyz += u_emissive * texture2D(u_emissive_texture, v_coord).xyz;\n\t\t#else\n\t\t\tcolor.xyz += u_emissive;\n\t\t#endif\n\n\t\t#ifdef FOG\n\t\t\t//float normalized_depth = linearize_depth(gl_FragCoord.z);//(gl_FragCoord.z * gl_FragCoord.w);\n\t\t\tfloat fog_factor = length( u_camera_position - v_pos ) / u_camera_planes.y;\n\t\t\tcolor.xyz = mix(color.xyz, u_fog_color.xyz, pow( fog_factor, 1.0 / u_fog_color.w ));\n\t\t#endif\n\t\tgl_FragColor = color;\n\t}\n";
c.Renderer=E;Object.defineProperty(E.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});Object.defineProperty(E.prototype,"fog_color",{set:function(a){this._fog_uniforms.u_fog_color.set([a[0],a[1],a[2]])},get:function(){return this._fog_uniforms.u_fog_color.subarray(0,3)},enumerable:!0});Object.defineProperty(E.prototype,"fog_density",{set:function(a){this._fog_uniforms.u_fog_color[3]=a},get:function(){return this._fog_uniforms.u_fog_color[3]},
enumerable:!0});E.prototype.setDataFolder=function(a){a?(this.assets_folder=a,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};E.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],3<=a.length?a[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};E._sort_by_dist_func=function(a,b){return b._distance-a._distance};E._sort_by_priority_func=function(a,b){var e=b.render_priority-a.render_priority;return 0!=e?e:b._index-
a._index};E._sort_by_priority_and_dist_func=function(a,b){var e=b.render_priority-a.render_priority;return 0!=e?e:b._distance-a._distance};E.prototype.destroy=function(){gl.destroy();c.Materials={}};E.prototype.render=function(a,b,e,m,h,y){null==m&&(m=65535);if(!a)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";b=b||a.camera;if(!b)throw"Renderer.render: camera not provided";v.gl=this.gl;this._nodes.length=
0;e||a._root.getVisibleChildren(this._nodes,m,this.layers_affect_children);e=e||this._nodes;for(var w=0;w<e.length;++w)e[w].preRender&&e[w].preRender();w=this.getAllRenderables(e,m,b);this.enableCamera(b);this._uniforms.u_res[0]=gl.viewport_data[2];this._uniforms.u_res[1]=gl.viewport_data[3];this._uniforms.u_res[2]=1/gl.viewport_data[2];this._uniforms.u_res[3]=1/gl.viewport_data[3];this._uniforms.u_point_size=this.point_size;this._state=[];this._meshes_missing=0;this._current_scene=a;this._uniforms.u_time=
a.time;h=h||this.pipeline;e=w.filter(G=>G.instances||b.testMesh(G.mesh,G.model)!==c.CLIP_OUTSIDE);if(h)h.render(this,e,b,a,y);else for(this.allow_instancing&&this.supports_instancing&&(e=this.groupRenderablesForInstancing(e)),this.skybox_texture&&this.renderSkybox(b,this.skybox_texture),w=0;w<e.length;++w)h=e[w],h.node.flags.was_rendered=!0,h.material.render(this,h);if(this.onPostRender)this.onPostRender(b);a.frame++;this.frame++;this._current_scene=null};E.prototype.enableCamera=function(a){this._camera=
a;a.updateMatrices();a.extractPlanes()};E.prototype.renderSkybox=function(a,b){var e=this._skybox_shader,m=gl.meshes.cube,h=gl.textures[b];h?(b=this._model_matrix,mat4.identity(b),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),mat4.setTranslation(b,a.position),a=.5*a.far+.5*a.near,mat4.scale(b,b,[a,a,a]),this.renderMesh(b,m,h,[1,1,1,1],e)):this.autoload_assets&&-1!=b.indexOf(".")&&this.loadTexture(b,renderer.default_texture_settings)};E.prototype.saveState=function(){this.state.push({camera:this._camera,
nodes:this._nodes})};E.prototype.restoreState=function(){var a=this.state.pop(),b=this.camera=a.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=a.nodes};E.prototype.setModelMatrix=function(a){this._model_matrix.set(a);mat4.multiply(this._mvp_matrix,this._camera._viewprojection_matrix,a)};E.prototype.setGlobalUniforms=function(a){for(var b in a)this._uniforms[b]&&
this._uniforms[b].set?this._uniforms[b].set(a[b]):this._uniforms[b]=a[b]};E.prototype.renderMesh=function(a,b,e,m,h,y,w,G){b&&(a||(a=c.IDENTITY),this._uniforms.u_model.set(a),h||=this.getMasterShader(e?u.ALBEDO:0),e&&(this._uniforms.u_texture=e.bind(0)),h.uniforms(this._uniforms),h.uniforms(this._camera._uniforms),m&&h.uniforms({u_color:m}),h.draw(b,null==y?gl.TRIANGLES:y,w),this.draw_calls+=1)};E.prototype.getAllRenderables=function(a,b,e){this.resetRenderablesPool();for(var m=this.renderables,h=
m.length=0;h<a.length;++h){var y=a[h];y.flags.was_renderer=!1;!1!==y.flags.visible&&y.layers&b&&(y.mesh||y._mesh)&&this.getNodeRenderables(y,b,e)}if(this.onFilterRenderables)this.onFilterRenderables(m);if(e){for(h=0;h<m.length;++h)m[h].computeRenderPriority(e._position);m=m.sort(E.rc_sort_function)}return m};E.prototype.resetRenderablesPool=function(){this.used_renderables=0};E.prototype.getRenderablesFromPool=function(){if(this.used_renderables<this.renderables_pool.length){var a=this.renderables_pool[this.used_renderables];
this.used_renderables++;return a}a=new c.Renderable;a.id=this.used_renderables;this.renderables_pool.push(a);this.used_renderables++;return a};E.prototype.getNodeRenderables=function(a,b){var e=null;if(a._mesh)e=a._mesh;else if(a.mesh&&(e=gl.meshes[a.mesh],!e)){this.autoload_assets&&-1!=a.mesh.indexOf(".")&&this.loadMesh(a.mesh);return}a.updateGlobalMatrix(!0);if(e){var m=a.skeleton||a.skin||null;!m||m.bones||m.joints||(m=null);m&&m.bones&&!m.bones.length&&(m=null);m&&m.joints&&!m.joints.length&&
(m=null);m&&m.joints&&(m._bone_matrices||a.updateSkinningBones(a.parentNode));if(this.test_visibility&&!m&&b){E.temp_bbox||(E.temp_bbox=BBox.create(),E.aabb_center=BBox.getCenter(E.temp_bbox),E.aabb_halfsize=BBox.getHalfsize(E.temp_bbox));BBox.transformMat4(E.temp_bbox,e.getBoundingBox(),a._global_matrix);if(b.testBox(E.aabb_center,E.aabb_halfsize)==c.CLIP_OUTSIDE)return;a._last_rendered_frame=this.frame}if(a.primitives&&a.primitives.length)for(b=0;b<a.primitives.length;++b){var h=a.primitives[b],
y;if(y=h.material?c.Materials[h.material]:this.default_material){var w=this.getRenderablesFromPool();w.material=y;w.model=a._global_matrix;w.mesh=e;w.group_index=b;w.node=a;w.draw_range=null;w._render_priority=y.render_priority||0;w.instances=a._instances;w.reverse_faces=a.flags.frontFace==GL.CW;w.skin=m;w.primitive=null!=h.mode?h.mode:y.primitive;this.renderables.push(w)}}else a.material&&(y=c.Materials[a.material])&&(w=this.getRenderablesFromPool(),w.material=y,w.model=a._global_matrix,w.mesh=e,
w.group_index=a.submesh,w.node=a,w.instances=a._instances,w.skin=m,w.draw_range=a.draw_range,w.primitive=null!=a.primitive?a.primitive:y.primitive,w._render_priority=y.render_priority||0,w.reverse_faces=a.flags.frontFace==GL.CW,this.renderables.push(w))}};E._last_mesh_id=0;E.prototype.groupRenderablesForInstancing=function(a){for(var b=new Map,e=0,m=0;m<a.length;++m){var h=a[m];h.mesh.name||(h.mesh.name="##M"+E._last_mesh_id++);var y=h.instances||h.skin||h.draw_range?e++:h.mesh.name+":"+h.group_index+
"/"+h.primitive+"/"+h.material.name+(h.reverse_faces?"[R]":"");b.has(y)?b.get(y).push(h):b.set(y,[h])}a=[];h=b.values();for(var w of h)if(0!=w.length)if(1==w.length)h=w[0],this.debug_instancing||a.push(h);else{h=this.getRenderablesFromPool();h.copyFrom(w[0]);h.instances=Array(w.length);for(b=0;b<w.length;++b)h.instances[b]=w[b].model;a.push(h)}return a};E.rc_sort_function=function(a,b){return b._render_priority-a._render_priority};E.prototype.renderBounding=function(a,b,e){if(a){b=b||c.IDENTITY;var m=
this._uniforms.u_model;a=a.constructor===GL.Mesh?a._bounding:a;e=e||[1,1,0,1];var h=a.subarray(3,6);mat4.translate(m,b,a.subarray(0,3));mat4.scale(m,m,[2*h[0],2*h[1],2*h[2]]);this.renderMesh(m,gl.meshes.cube,null,e,null,gl.LINES,"wireframe")}};E.prototype.enableItemFlags=function(a){var b=a.flags.flip_normals;this.reverse_normals&&(b=!b);gl.frontFace(b?gl.CW:gl.CCW);!1===a.flags.depth_test?gl.disable(gl.DEPTH_TEST):gl.enable(gl.DEPTH_TEST);!1===a.flags.depth_write&&gl.depthMask(!1);!0===a.flags.two_sided||
this.disable_cull_face?gl.disable(gl.CULL_FACE):gl.enable(gl.CULL_FACE);if(a.blend_mode===c.BLEND_NONE||this.use_alpha_hash)gl.disable(gl.BLEND);else switch(gl.enable(gl.BLEND),a.blend_mode){case c.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case c.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case c.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}this.use_alpha_hash||"BLEND"!==a.alphaMode||(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),
gl.depthMask(!1))};E.prototype.disableItemFlags=function(a){a.flags.flip_normals&&gl.frontFace(gl.CCW);!1===a.flags.depth_test&&gl.enable(gl.DEPTH_TEST);a.blend_mode!==c.BLEND_NONE&&gl.disable(gl.BLEND);a.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===a.flags.depth_write&&gl.depthMask(!0);"BLEND"==a.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};E.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};c.Renderer.prototype.renderPoints=function(a,
b,e,m,h,y,w,G,F){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";h||(w==GL.LINES||w==GL.LINE_LOOP?h=this.shaders.flat:G?(h=this.shaders._points_textured,h||(h=this.shaders._points_textured=new GL.Shader(c.points_vs_shader,c.points_fs_shader,{TEXTURED:""}),h.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(h=this.shaders[b?"_points_color":"_points"],h||(h=b?this.shaders._points_color=new GL.Shader(c.points_vs_shader,c.points_fs_shader,{COLORED:""}):this.shaders._points=
new GL.Shader(c.points_vs_shader,c.points_fs_shader),h.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));y=y||1;var J=1024;m=m||a.length/3;var L=this._points_mesh;m>a.length/3&&(m=a.length/3);if(!L||a.length>3*J){m>J&&(J=GL.Texture.nextPOT(m));var O=new Float32Array(3*J);J=new Float32Array(4*J);L=this._points_mesh=GL.Mesh.load({vertices:O,extra4:J})}else O=this._points_mesh.getBuffer("vertices").data,J=this._points_mesh.getBuffer("extra4").data;O.set(O.length>a.length?a:a.subarray(0,O.length));b?
J.set(J.length>b.length?b:b.subarray(0,J.length)):J.fill&&J.fill(0);L.upload(GL.DYNAMIC_STREAM);h.setUniform("u_color",this._color);h.setUniform("u_pointSize",y);h.setUniform("u_camera_perspective",e._projection_matrix[5]);h.setUniform("u_model",F||c.IDENTITY);h.setUniform("u_viewport",gl.viewport_data);h.setUniform("u_viewprojection",e._viewprojection_matrix);G&&h.setUniform("u_texture",G.bind(0));h.drawRange(L,null!=w?w:GL.POINTS,0,m);return L};c.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
c.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvarying vec4 v_extra4;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef COLORED\n\t\tcolor *= v_extra4;\n\t#endif\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
E.prototype.renderLines=function(a,b,e){this.renderPoints(a,null,null,null,null,null,gl.LINES,null,e)};E.prototype.render3DLines=function(a,b,e,m){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var h=this.shaders._lines;h||=this.shaders._lines=new GL.Shader(c.lines_vs_shader,this._flat_fragment_shader);var y=this._camera,w=a.length/3,G=e?2*w:4*w;var F=this._lines_mesh;if(!F||3*G>F.getBuffer("vertices").data.length){F=GL.Texture.nextPOT(G);G=new Float32Array(3*
F);var J=new Float32Array(3*F);var L=new Float32Array(2*F);indices_data=new Uint16Array(3*F);F=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:G,normals:J,extra2:L})}else G=this._lines_mesh.getBuffer("vertices").data,J=this._lines_mesh.getBuffer("normals").data,L=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data;var O=vec2.fromValues(-1,-1),P=vec2.fromValues(1,-1),N=vec2.fromValues(-1,1),V=vec2.fromValues(1,1),U=vec3.create();if(e)throw"strip lines not supported yet";
for(var X=Math.floor(w/2),Q=0;Q<X;++Q){var T=2*Q,W=a.subarray(3*T,3*T+3);T=a.subarray(3*T+3,3*T+6);vec3.sub(U,T,W);G.set(W,12*Q);G.set(W,12*Q+3);G.set(T,12*Q+6);G.set(T,12*Q+9);J.set(U,12*Q);J.set(U,12*Q+3);J.set(U,12*Q+6);J.set(U,12*Q+9);L.set(O,8*Q);L.set(P,8*Q+2);L.set(N,8*Q+4);L.set(V,8*Q+6);indices_data.set([4*Q,4*Q+2,4*Q+1,4*Q+1,4*Q+2,4*Q+3],6*Q)}F.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);h.setUniform("u_model",m||c.IDENTITY);h.setUniform("u_color",this._color);h.setUniform("u_camera_front",
y._front);h.setUniform("u_camera_position",y.eye);h.setUniform("u_lineWidth",.5*b);h.setUniform("u_camera_perspective",y._projection_matrix[5]);h.setUniform("u_viewport",gl.viewport_data);h.setUniform("u_viewprojection",y._viewprojection_matrix);h.drawRange(F,gl.TRIANGLES,0,w*(e?6:3));return F};c.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
c.Renderer.prototype.drawImage=function(a,b,e,m,h,y,w,G,F){a.constructor===String&&(a=this.loadTexture(a));if(a){var J=this.shaders._textured_quad;J||=this.shaders._textured_quad=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_rect;\n\t\tuniform vec4 u_src_rect;\n\t\tuniform vec4 u_viewport;\n\t\tfloat remap(in float value, in float low1, in float high1, in float low2, in float high2 ) { float range1 = high1 - low1; float range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n\t\t\n\t\tvoid main() {\n\t\t\tv_coord = a_coord;\n\t\t\tvec4 pos = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\tpos.x = remap(pos.x, -1.0, 1.0, u_rect.x, u_rect.x + u_rect.z );\n\t\t\tpos.x = remap(pos.x, 0.0, u_viewport.z, -1.0, 1.0 );\n\t\t\tpos.y = remap(pos.y, -1.0, 1.0, u_rect.y, u_rect.y + u_rect.w );\n\t\t\tpos.y = remap(pos.y, 0.0, u_viewport.w, 1.0, -1.0 );\n\t\t\tv_coord.x = remap( v_coord.x, 0.0, 1.0, u_src_rect.x, u_src_rect.x + u_src_rect.z );\n\t\t\tv_coord.y = remap( v_coord.y, 1.0, 0.0, u_src_rect.y, u_src_rect.y + u_src_rect.w );\n\t\t\tgl_Position = pos;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform sampler2D u_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\tif(color.a == 0.0) discard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t");var L=GL.Mesh.getScreenQuad();J.bind();J.setUniform("u_color",this._color);J.setUniform("u_rect",[y,w,G,F]);J.setUniform("u_src_rect",[b/a.width,e/a.height,m/a.width,h/a.height]);J.setUniform("u_viewport",gl.viewport_data);J.setUniform("u_texture",
a.bind(0));gl.disable(GL.DEPTH_TEST);gl.disable(GL.CULL_FACE);J.draw(L,GL.TRIANGLES)}};E.prototype.getAssetFullPath=function(a,b){if(-1==a.indexOf("://")&&!b&&this.assets_folder){if(this.onGetAssetsFolder)return this.onGetAssetFolder(a);b="/"==this.assets_folder.substr(-1);var e="/"==a[0];return b!=e?this.assets_folder+a:b&&e?this.assets_folder+a.substr(1):this.assets_folder+"/"+a}return a};E.prototype.loadMesh=function(a,b,e){if(!a)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[a]&&
!this.assets_not_found[a]){var m=this.meshes[a];if(m)return b&&b(m),m;var h=this;e=this.getAssetFullPath(a,e);e=GL.Mesh.fromURL(e,function(y){y?h.meshes[a]=y:(h.assets_not_found[a]=!0,delete h.meshes[a]);h.num_assets_loading--;delete h.assets_loading[a];b&&b(y,a)});this.assets_loading[a]=e;this.num_assets_loading++;return this.meshes[a]=e}};E.prototype.loadTexture=function(a,b,e,m){function h(J){G.debug&&console.log(" + texture loaded: "+a);J?G.textures[y]=J:G.assets_not_found[a]=!0;e&&e(J,y);G.num_assets_loading--;
delete G.assets_loading[a];if(G.on_texture_load)G.on_texture_load(J,y)}if(!a)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var y=a;b&&(b.name&&(y=b.name),b.preview&&(y=b.preview));var w=this.textures[y];if(w&&!w.is_preview)return e&&e(w),w;var G=this;m=this.getAssetFullPath(a,m);var F=null;-1!=a.indexOf("CUBEMAP")?F=GL.Texture.cubemapFromURL(m,this.default_cubemap_settings,h):this.credentials?(this.credentials.headers?this.credentials.headers["Content-Type"]=
"application/octet-stream":this.credentials.headers={"Content-Type":"application/octet-stream"},F=new GL.Texture(1,1,b),fetch(m,this.credentials).then(function(J){if(!J.ok)throw Error("HTTP "+J.status+":"+J.statusText);return J.arrayBuffer()}).then(function(J){var L=URL.createObjectURL(new Blob([J]));b.texture=F;F=GL.Texture.fromURL(L,b,h);b.texture=null;setTimeout(function(){URL.revokeObjectURL(L)},6E4)})):F=GL.Texture.fromURL(m,b,h);b&&b.preview&&(F.is_preview=!0);this.assets_loading[a]=F;this.num_assets_loading++;
return this.textures[y]=F}};E.prototype.createShaders=function(){var a=this._vertex_shader="\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec3 v_pos;\n\t\tvarying vec3 v_normal;\n\t\tvarying vec2 v_coord;\n\t\t#ifdef COLOR\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t\tvoid main() {\n\t\t\tv_pos = a_vertex;\n\t\t\tv_normal = a_normal;\n\t\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t\tv_coord = a_coord;\n\t\t\t#ifdef COLOR\n\t\t\tv_color = a_color;\n\t\t\t#endif\n\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\tgl_PointSize = 2.0;\n\t\t}\n\t",
b=this._flat_fragment_shader="\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\t#ifdef COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t\t#endif\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color = u_color;\n\t\t\t\t\t#ifdef COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t\t#endif\n\t\t\t\t  gl_FragColor = color;\n\t\t\t\t}\n\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,b);gl.shaders.flat_color=this._flat_instancing_shader=new GL.Shader(a,b,{COLOR:""});this._point_shader=new GL.Shader("\n\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tuniform mat4 u_mvp;\n\t\t\t\tuniform float u_pointSize;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\t}\n\t\t\t\t",
"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\n\t\t\t\t     discard;\n\t\t\t\t  gl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t\tuniform vec4 u_color;\n\t\tuniform mat4 u_mvp;\n\t\tvoid main() {\n\t\t\tv_color = a_color * u_color;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec4 v_color;\n\t\tvoid main() {\n\t\t  gl_FragColor = v_color;\n\t\t}\n\t");gl.shaders.color=this._color_shader;gl.shaders.texture=this._texture_shader=new GL.Shader(a,"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\t#ifdef COLOR\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\t#ifdef COLOR\n\t\t\t\tcolor *= v_color;\n\t\t\t#endif\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");
gl.shaders.skybox=this._skybox_shader=new GL.Shader("\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\tvarying vec3 v_pos;\n\tvarying vec3 v_wPos;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\t\n\tvoid main() {\n\t\tv_coord = a_coord;\n\t\tvec3 vertex = a_vertex;\t\n\t\tv_pos = vertex;\n\t\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\t\tv_wNormal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\tgl_Position = u_viewprojection * vec4(v_wPos,1.0);\n\t}\n\t",
"\n\tprecision highp float;\n\tvarying vec3 v_pos;\n\tvarying vec3 v_wPos;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\t\n\tuniform vec4 u_color;\n\tuniform samplerCube u_color_texture;\n\tuniform vec3 u_camera_position;\n\t\n\tvoid main() {\n\t  vec3 L = normalize(vec3(1.,1.,-1.));\n\t  vec3 N = normalize( v_wNormal );\n\t\tvec3 E = normalize( v_wPos - u_camera_position );\n\t  vec4 color = u_color;\n\t  color.xyz = textureCube( u_color_texture, -E * vec3(1.0,-1.0,1.0) ).xyz;\n\t  gl_FragColor = color;\n\t}\n\t")};
E.prototype.loadTextureAtlas=function(a,b,e){"string"==typeof a&&(a=JSON.parse(a));var m=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(h){var y=a.files;m.textures[":atlas"]=h;for(var w in y)if(!m.textures[w]||m.textures[w].is_preview){var G=y[w],F=new GL.Texture(a.size,a.size,{wrap:gl.REPEAT,filter:gl.LINEAR});F.drawTo(function(){h.gl.drawTexture(h,0,0,a.size,a.size,G.x,G.y,G.width||a.size,G.height||a.size)});F.is_preview=!0;m.textures[w]=F}e&&e(y)})};E.prototype.loadShaders=
function(a,b,e,m){var h=this;-1!=a.indexOf("://")||m||(a=this.assets_folder+a);a+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(a,function(y){h.compileShadersFromAtlas(y,e);h.loading_shaders=!1;b&&b(y)})};E.prototype.reloadShaders=function(a){};E.prototype.compileShadersFromAtlasCode=function(a,b){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a,b)};E.prototype.compileShadersFromAtlas=function(a,b){var e=a.shaders;if(e){this.shader_files=a;for(var m in a)a[m]=GL.Shader.expandImports(a[m],
a);e=e.split("\n");for(m=0;m<e.length;++m){var h=e[m].trim().split(" "),y=h[0].trim();if("//"!=y.substr(0,2)){var w=a[h[1]],G=a[h[2]],F=null,J={};if(3<h.length)for(var L=3;L<h.length;++L)if("#"==h[L][0])J[h[L].substr(1)]=!0;else{F=h.slice(L).join(" ");break}if(!J.WEBGL1||1==gl.webgl_version)if(!J.WEBGL2||2==gl.webgl_version){h[1]&&"@"==h[1][0]&&(J=h[1].substr(1)+"_VERTEX_SHADER",GL.Shader[J]&&(w=GL.Shader[J]));h[2]&&"@"==h[2][0]&&(J=h[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[J]&&(G=GL.Shader[J]));
if(F)try{F=JSON.parse(F)}catch(P){console.error("Error in shader macros: ",y,F,P)}if(F&&b){J={};for(var O in F)J[O]=F[O];for(O in b)J[O]=b[O];F=J}else b&&(F=b);try{w&&G?this.shaders[y]?this.shaders[y].updateShader(w,G,F):this.shaders[y]=new GL.Shader(w,G,F):console.warn("Shader subfile not found: ",h[1],h[2])}catch(P){GL.Shader.dumpErrorToConsole(P,w,G)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};E.prototype.setShadersFromFile=function(a){a=GL.processFileAtlas(a);
this.compileShadersFromAtlas(a)};E.cubemap_info=[{front:[1,0,0],up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];E.prototype.renderToCubemap=function(a,b,e,m,h,y,w){var G=E.cubemap_camera;G||(E.cubemap_camera=G=new c.Camera);G.perspective(90,1,y||.1,w||1E3);var F=vec3.create(),J=this;a.drawTo(function(L,O){L=E.cubemap_info[O];vec3.add(F,e,L.front);G.lookAt(e,F,L.up);J.clear();J.render(b,G,m,
h)});return a};E.prototype.drawSphere3D=function(a,b,e){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var m=gl.shaders.flat;m.setUniform("u_color",e);m.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(d);mat4.translate(d,d,a);mat4.scale(d,d,[b,b,b]);m.setUniform("u_model",d);m.draw(gl.meshes.sphere);this.draw_calls+=1};E.prototype.drawCircle2D=function(a,b,e,m,h){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=
GL.Mesh.ring({radius:1,thickness:.02,slices:64}));var y=gl.shaders.flat;y.setUniform("u_color",m);y.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(d);mat4.translate(d,d,[a,b,0]);mat4.scale(d,d,[2*e,2*e,2*e]);y.setUniform("u_model",d);y.draw(gl.meshes[h?"circle":"ring"]);this.draw_calls+=1};E.prototype.drawLine2D=function(a,b,e,m,h,y,w){var G=gl.meshes.plane;w=w||gl.shaders.flat;w.setUniform("u_color",y);w.setUniform("u_viewprojection",this._viewprojection2D_matrix);var F=
e-a,J=m-b;y=Math.atan2(F,J);F=Math.sqrt(F*F+J*J);h/=2;mat4.identity(d);mat4.translate(d,d,[.5*(a+e),.5*(b+m),0]);mat4.rotate(d,d,y,c.FRONT);a=h;mat4.scale(d,d,[a,F,a]);w.setUniform("u_model",d);w.draw(G);this.draw_calls+=1};E.prototype.renderDebugSceneTree=function(a,b){for(var e=[],m=0;m<a._nodes.length;++m){var h=a._nodes[m];if(h._parent&&h._parent!=a.root){var y=h._parent.getGlobalPosition();h=h.getGlobalPosition();e.push(y[0],y[1],y[2],h[0],h[1],h[2])}}e=new Float32Array(e);this.renderPoints(e,
null,b,null,null,null,GL.LINES);this.renderPoints(e,null,b,null,null,-10,GL.POINTS)};c.sortByDistance=function(a,b){a.forEach(function(e){e._distance=e.getDistanceTo(b)});a.sort(function(e,m){return m._distance-e._distance})};c.noBlending=function(a){return a.blend_mode===c.BLEND_NONE};c.generateTextureAtlas=function(a,b,e,m,h){b=b||1024;e=e||1024;m=m||64;var y=0,w;for(w in a)y++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);y=new GL.Texture(b,e);var G={width:b,height:e,
size:m,files:{}},F=0,J=0,L={};y.drawTo(function(){for(var O in a)if(":"!=O[0]&&"white"!=O&&"black"!=O&&"notfound"!=O){var P=a[O];if(!P.is_preview&&P.texture_type==gl.TEXTURE_2D){if(h){var N=P.toBase64().hashCode();if(L[N]){G.files[O]=G.files[L[N]];continue}L[N]=O}G.files[O]={x:F,y:J};P.renderQuad(F,J,m,m);F+=m;if(F==b&&(F=0,J+=m,J==e)){console.warn("Atlas too small, some textures wont be stored.");break}}}});y.info=G;console.log(G);return y};E.prototype.computeResourcesLoaded=function(a){var b=0,
e;for(e in a){var m=a[e],h=this.textures[m];h&&!1===h.ready||(m=this.meshes[m])&&!1===m.ready||(h||m)&&b++}return b};Object.defineProperty(E.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(a){},enumerable:!0});Object.defineProperty(E.prototype,"textures",{get:function(){return this.gl.textures},set:function(a){},enumerable:!0});Object.defineProperty(E.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(a){},enumerable:!0});E.prototype.addMesh=function(a,
b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};c.Renderer=E;c.Ray=g;g.prototype.testPlane=function(a,b){return geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point)};g.prototype.testSphere=function(a,b,e){return geo.testRaySphere(this.origin,this.direction,a,b,this.collision_point,e)};g.prototype.closestPointOnRay=function(a,b,e){e=e||vec3.create();var m=vec3.create();vec3.add(m,this.origin,this.direction);var h=vec3.create();vec3.add(h,a,b);geo.closestPointBetweenLines(this.origin,
m,a,h,null,e);return e};c.Factory=function(a,b,e){a=c.Factory.templates[a];var m=new c.SceneNode;a&&m.fromJSON(a);b&&(b.constructor===c.Scene?b.root:b).addChild(m);e&&m.fromJSON(e);return m};c.Factory.templates={grid:{mesh:"grid",material:{primitive:1,color:[.5,.5,.5,.5],blend_mode:c.BLEND_ALPHA}},sphere:{mesh:"sphere"},floor:{mesh:"planeXZ",scaling:10}};class R extends r{constructor(a){super();this.build();a&&this.fromJSON(a)}}R.prototype.build=function(){this.vertices=[];this.normals=[];this.coords=
[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};R.prototype.updateVertices=function(a){a&&(this.vertices=a);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);
this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};R.prototype.updateNormals=function(a){a&&(this.normals=a);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};R.prototype.updateCoords=function(a){a&&(this.coords=
a);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};R.prototype.updateIndices=function(a){a&&(this.indices=a);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=new Float32Array(2*this.indices.length),
this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=a.length};R.prototype.preRender=function(){this._total&&(this.draw_range=[0,this._total_indices?this._total_indices:this._total/3])};c.DynamicMeshNode=R;c.parseTextConfig=function(a){function b(m,h){for(var y=e.shift();y;)if(0==y.trim().length)y=e.shift();else{for(var w=
0;"\t"==y[w]&&w<y.length;)w++;if(w<h)break;var G={children:[]};try{var F=y.trim();-1!=F.indexOf(":")&&(F="{"+F+"}");var J=new Function("return "+F);G.data=J()}catch(L){console.error(L)}w>=h&&(m&&m.children.push(G),y=b(G,w+1))}return y}var e=a.split("\n");a={data:"",children:[]};b(a,0);return a};f=vec3.create();class S{constructor(){this.name="";this.id=-1;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=this.draw_range=null;this.reverse_faces=!1;this.primitive=
-1;this.node=this.instances=this.skin=null;this._render_priority=0}copyFrom(a){this.name=a.name;this.id=a.id;this.mesh=a.mesh;this.model=a.model;this.index_buffer_name=a.index_buffer_name;this.group_index=a.group_index;this.material=a.material;this.reverse_faces=a.reverse_faces;this.node=a.node;this.skin=a.skin;this.draw_range=a.draw_range;this.primitive=a.primitive;this.instances=a.instances;this._render_priority=a._render_priority}computeRenderPriority(a){this.name=this.node.name;var b=this.mesh.getBoundingBox();
b&&(b=mat4.multiplyVec3(f,this.model,b),this._render_priority=this.material.render_priority||0,a=vec3.distance(a,b),"BLEND"==this.material.alphaMode?(this._render_priority+=.001*a,this._render_priority-=100):this._render_priority+=1E3-.001*a)}}c.Renderable=S;c.orientNodeToCamera=function(a,b,e,m){a&&(a==c.BILLBOARD_CYLINDRIC||a==c.BILLBOARD_PARALLEL_CYLINDRIC?(a==c.BILLBOARD_CYLINDRIC?(a=b.getGlobalPosition(k),vec3.sub(f,e._position,a),l[0]=f[0],l[1]=f[2]):(l[0]=e._front[0],l[1]=e._front[2]),e=vec2.computeSignedAngle(l,
c.FRONT2D),isNaN(e)||(mat4.rotateY(d,A,-e),b._global_matrix.set(d),mat4.setTranslation(b._global_matrix,b._position),mat4.scale(b._global_matrix,b._global_matrix,b._scale))):(a==c.BILLBOARD_PARALLEL_SPHERIC?(b._global_matrix.set(e._model_matrix),mat4.setTranslation(b._global_matrix,b._position)):(mat4.lookAt(b._global_matrix,b._position,e.position,c.UP),mat4.invert(b._global_matrix,b._global_matrix)),mat4.scale(b._global_matrix,b._global_matrix,b._scale)),m.setModelMatrix(b._global_matrix))};c.makeHash=
function(a){let b="";for(var e=0;e<a;e++)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(62*Math.random()|0);return b};c.readPixels=function(a,b){var e=new Image;e.src=a;e.onload=function(){var m=document.createElement("canvas");m.width=this.width;m.height=this.height;var h=m.getContext("2d");h.drawImage(this,0,0);m=h.getImageData(0,0,m.width,m.height);b(m,this)}};c.alignDivToNode=function(a,b,e,m,h,y){function w(N){return 1E-5>Math.abs(N)?0:N}function G(N){return"matrix3d("+
w(N[0])+","+w(-N[1])+","+w(N[2])+","+w(N[3])+","+w(N[4])+","+w(-N[5])+","+w(N[6])+","+w(N[7])+","+w(N[8])+","+w(-N[9])+","+w(N[10])+","+w(N[11])+","+w(N[12])+","+w(-N[13])+","+w(N[14])+","+w(N[15])+")"}var F=parseInt(a.clientWidth),J=parseInt(a.clientHeight),L=.5*F,O=.5*J,P=h._projection_matrix[5]*O;a.style.width=gl.canvas.width+"px";a.style.height=gl.canvas.height+"px";a.style.perspective=P+"px";a.style.pointerEvents="none";b&&(a="translateZ("+P+"px) "+G(h._view_matrix),b.style.transformStyle="preserve-3d",
b.style.transform=a+" translate("+L+"px,"+O+"px)",b.style.width=F+"px",b.style.height=J+"px",b.style.pointerEvents="none");m=m.getGlobalMatrix();F=1/e.clientWidth;J=1/e.clientHeight;e.parentNode!=b&&b.appendChild(e);e.style.pointerEvents=y?"auto":"none";e.style.transform=function(N){return"translate(-50%,-50%) matrix3d("+(w(N[0])+","+w(N[1])+","+w(N[2])+","+w(N[3])+","+w(-N[4])+","+w(-N[5])+","+w(-N[6])+","+w(-N[7])+","+w(N[8])+","+w(N[9])+","+w(N[10])+","+w(N[11])+","+w(N[12])+","+w(N[13])+","+w(N[14])+
","+w(N[15])+")")}(m)+" scale3D("+F+","+J+",1)"};r.prototype.move=r.prototype.translate;r.prototype.setRotationFromEuler=r.prototype.setEulerRotation;r.prototype.getGlobalPoint=r.prototype.localToGlobal;r.prototype.serialize=r.prototype.toJSON;r.prototype.configure=r.prototype.fromJSON;r.ctor=r.prototype._ctor;M.prototype.configure=M.prototype.fromJSON;M.prototype.serialize=M.prototype.toJSON;n.prototype.configure=n.prototype.fromJSON;n.prototype.serialize=n.prototype.toJSON;"undefined"==typeof GL&&
(mat4.rotateVec3=function(a,b,e){var m=e[0],h=e[1];e=e[2];a[0]=b[0]*m+b[4]*h+b[8]*e;a[1]=b[1]*m+b[5]*h+b[9]*e;a[2]=b[2]*m+b[6]*h+b[10]*e;return a},mat4.projectVec3=function(a,b,e){var m=e[0],h=e[1];e=e[2];var y=b[1]*m+b[5]*h+b[9]*e+b[13],w=b[2]*m+b[6]*h+b[10]*e+b[14],G=b[3]*m+b[7]*h+b[11]*e+b[15];a[0]=((b[0]*m+b[4]*h+b[8]*e+b[12])/G+1)/2;a[1]=(y/G+1)/2;a[2]=(w/G+1)/2;return a})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(v){function g(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=.5;this.particles_acceleration=vec3.create();this.velocity_variation=this.particles_end_scale=this.particles_start_scale=
1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function x(){this._ctor()}function q(c){this._ctor();c&&this.configure(c)}extendClass(g,RD.SceneNode);RD.ParticlesEmissor=g;g.prototype.update=
function(c){var p=this.particles.length,u=this.particles_damping,z=this.particles_acceleration,A=vec3.length(z);if(p){for(var C=[],d=0;d<p;d++){var l=this.particles[d];vec3.scaleAndAdd(l.pos,l.pos,l.vel,c);A&&vec3.scaleAndAdd(l.vel,l.vel,z,c);u&&vec3.scaleAndAdd(l.vel,l.vel,l.vel,-c*u);l.ttl-=c;0<l.ttl&&C.push(l)}this.particles=C}p=this.getGlobalPosition();u=this.emissor_direction;z=this.particles_life;A=this.num_textures*this.num_textures;C=this.velocity_variation;if(0<this.particles_per_second)for(c=
this.particles_per_second*(c+this._accumulated_time),this._accumulated_time=(c-Math.floor(c))/this.particles_per_second,c=Math.floor(c),d=0;d<c&&!(this.particles.length>=this.max_particles);d++)u=vec3.clone(u),u[0]+=.5*Math.random()*C,u[2]+=.5*Math.random()*C,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*A)/A,pos:vec3.clone(p),vel:u,ttl:z})};g.prototype.render=function(c,p){if(0!=this.particles.length){this.updateVertices();var u=this._meshes[c.gl.context_id];u||(u=
new GL.Mesh(void 0,void 0,c.gl),this._vertices_buffer=u.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=u.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=u;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);u=gl.shaders[this.shader];u||(u=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(g._vertex_shader,g._pixel_shader));this.draw_range[1]=this.particles.length;
u=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/u[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(c._model_matrix);c._mvp_matrix.set(c._viewprojection_matrix);c.renderNode(this,c,p)}};g.prototype.updateVertices=function(c){if(c=
this.particles.length)for(var p=this._vertices,u=this._extra,z=0,A=this.particles_life,C=this.num_textures*this.num_textures,d=0;d<c;d++){var l=this.particles[d];p.set(l.pos,z);u[z]=1;u[z+1]=l.ttl/A;1<C&&(u[z+2]=l.tex);z+=3}};extendClass(x,RD.SceneNode);RD.Billboard=x;x.SPHERIC=1;x.PARALLEL_SPHERIC=2;x.CYLINDRIC=3;x.PARALLEL_CYLINDRIC=4;x.prototype._ctor=function(){this.billboard_mode=x.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};x.prototype.render=function(c,p){!1!==this.flags.visible&&
(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,p,c),c.renderNode(this,c,p))};q.prototype._ctor=function(){SceneNode.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=RD.TOP_LEFT;this.blend_mode=RD.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=
this.texture_matrix};Object.defineProperty(q.prototype,"angle",{get:function(){return this._angle},set:function(c){this._angle=c;quat.setAxisAngle(this._rotation,RD.FRONT,this._angle*DEG2RAD);this._must_update_matrix=!0},enumerable:!0});q.prototype.setSize=function(c,p){this.size[0]=c;this.size[1]=p};q.createFrames=function(c,p,u){u=u||{};if(c.constructor!=Number){num_columns=c[0];var z=c[1]}else z=num_columns=c;var A=c=0,C=1/num_columns,d=1/z;z*=num_columns;if(!p){p=[];for(var l=0;l<z;++l)p.push(String(l))}for(l=
0;l<p.length&&!(u[p[l]]={pos:[c,A],size:[C,d],normalized:!0},c+=C,1<=c&&(c=0,A+=d),1<=A);++l);return u};q.prototype.createFrames=function(c,p){q.createFrames(c,p,this.frames)};q.prototype.addFrame=function(c,p,u,z,A,C){this.frames[c]={pos:vec2.fromValues(p,u),size:vec2.fromValues(z,A),normalized:!!C}};q.prototype.updateTextureMatrix=function(c){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var p=c.textures[this.texture];if(!p&&c.autoload_assets){var u=this;-1!=this.texture.indexOf(".")&&
c.loadTexture(this.texture,c.default_texture_settings,function(C){C&&0==u.size[0]&&0==u.size[0]&&u.setSize(C.width,C.height)});p=gl.textures.white}if(!p)return!1;c=this.texture_matrix;var z=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!z)return!1;if(!z)return this.flags.flipX&&(temp_vec2[0]=this.flags.flipX?1:0,temp_vec2[1]=0,mat3.translate(c,c,temp_vec2),temp_vec2[0]=this.flags.flipX?-1:1,temp_vec2[1]=1,mat3.scale(c,c,temp_vec2)),!0;if(z.normalized)temp_vec2[0]=this.flags.flipX?
z.pos[0]+z.size[0]:z.pos[0],temp_vec2[1]=1-z.pos[1]-z.size[1],mat3.translate(c,c,temp_vec2),temp_vec2[0]=z.size[0]*(this.flags.flipX?-1:1),temp_vec2[1]=z.size[1];else{var A=p.height;temp_vec2[0]=(this.flags.flipX?z.pos[0]+z.size[0]:z.pos[0])/p.width;temp_vec2[1]=(A-z.pos[1]-z.size[1])/A;mat3.translate(c,c,temp_vec2);temp_vec2[0]=z.size[0]*(this.flags.flipX?-1:1)/p.width;temp_vec2[1]=z.size[1]/p.height}mat3.scale(c,c,temp_vec2);return!0};q.prototype.render=function(c,p){if(this.texture&&this.updateTextureMatrix(c)){var u=
c.textures[this.texture];if(u){this.flags.pixelated&&(u.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.billboard_mode&&RD.orientNodeToCamera(this.billboard_mode,this,p,c);0==this.size[0]&&!1!==u.ready&&(this.size[0]=u.width);0==this.size[1]&&!1!==u.ready&&(this.size[1]=u.height);var z=this.size,A=0,C=0;temp_mat4.set(this._global_matrix);
var d=!1;this.current_frame&&this.current_frame.size&&(z=this.current_frame.size,d=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case RD.TOP_LEFT:A=.5;C=-.5;break;case RD.TOP_CENTER:C=-.5;break;case RD.TOP_RIGHT:A=-.5;break;case RD.BOTTOM_LEFT:C=A=.5;break;case RD.BOTTOM_CENTER:C=.5;break;case RD.BOTTOM_RIGHT:A=-.5,C=.5}mat4.translate(temp_mat4,temp_mat4,[A*u.width*z[0],C*u.height*z[1],0])}d?mat4.scale(temp_mat4,temp_mat4,[u.width*z[0],u.height*z[1],1]):mat4.scale(temp_mat4,
temp_mat4,[this.size[0],this.size[1],1]);c.setModelMatrix(temp_mat4);c.renderNode(this,c,p)}}};extendClass(q,RD.SceneNode);RD.Sprite=q})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(v){class g extends RD.SceneNode{constructor(f){super(f);f&&this.configure(f);this.render_priority=0;this.targets=null;this.size=150;this.mode=g.DEFAULT;this.coordinates=g.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();this.onDuplicateTargets=this.onActionFinished=null;f={x:g.XAXIS_COLOR,y:g.YAXIS_COLOR,z:g.ZAXIS_COLOR};var k="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");
this.actions={};for(var t in k){var r=k[t],n={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:.15,visible:!1,flag:g[r.toUpperCase()]};0==r.indexOf("move")&&(n.move=!0);0==r.indexOf("rotate")&&(n.rotate=!0);0==r.indexOf("scale")&&(n.scale=!0);n.color=f[r[r.length-1]];if(n.move||n.rotate)n.cursor="crosshair";this.actions[r]=n}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=
vec3.fromValues(0,1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1;this.mesh="sphere";this.createMaterial({name:"gizmo"}).render=g.prototype.render.bind(this)}}g.MOVEX=1;g.MOVEY=2;g.MOVEZ=4;g.MOVEXY=8;g.MOVEXZ=16;g.MOVEYZ=32;g.ROTATEX=64;g.ROTATEY=128;g.ROTATEZ=
256;g.SCALEX=512;g.SCALEY=1024;g.SCALEZ=2048;g.SCALEXY=4096;g.SCALEYZ=8192;g.SCALEXZ=16384;g.SCALE=32768;g.DRAG=65536;g.ROTATE=131072;g.ROTATEFRONT=262144;g.RESIZE=524288;g.MOVEAXIS=g.MOVEX|g.MOVEY|g.MOVEZ;g.MOVEPLANAR=g.MOVEXY|g.MOVEXZ|g.MOVEYZ;g.MOVEALL=g.DRAG|g.MOVEAXIS|g.MOVEPLANAR;g.PLANAR=g.MOVEX|g.MOVEZ|g.MOVEXZ|g.ROTATEY|g.SCALE;g.ROTATEALL=g.ROTATEX|g.ROTATEY|g.ROTATEZ|g.ROTATEFRONT;g.SCALEALL=g.SCALE|g.SCALEX|g.SCALEY|g.SCALEZ|g.SCALEXY|g.SCALEYZ|g.SCALEXZ;g.MOVEROTATESCALE=g.MOVEAXIS|g.MOVEPLANAR|
g.ROTATEALL|g.SCALE;g.ALL=g.MOVEAXIS|g.MOVEPLANAR|g.ROTATEALL|g.SCALEALL;g.DEFAULT=g.PLANAR;g.OBJECT_SPACE=1;g.WORLD_SPACE=2;v=mat4.create();var x=mat4.create(),q=mat4.create();mat4.create();mat4.create();mat4.create();var c=mat4.create(),p=mat4.create();mat4.create();var u=vec3.create(),z=vec3.create(),A=vec3.create(),C=vec4.create();vec4.create();mat4.translate(v,v,[1.1,0,0]);mat4.rotate(v,v,90*DEG2RAD,[0,0,-1]);mat4.translate(x,x,[0,1.1,0]);mat4.translate(q,q,[0,0,1.1]);mat4.rotate(q,q,90*DEG2RAD,
[1,0,0]);v=mat4.create();mat4.scale(v,v,[-1,-1,-1]);g.full_viewport=null;var d=mat4.create(),l=mat4.create();g.XAXIS_COLOR=[.901,.247,.349,1];g.YAXIS_COLOR=[.55,.81,.11,1];g.ZAXIS_COLOR=[.23,.57,.93,1];g.XYAXIS_COLOR=[.9,.7,.23,.75];g.XZAXIS_COLOR=[.6,.4,.7,.75];g.YZAXIS_COLOR=[.39,.69,.52,.75];g.SPHERE_COLOR=[.8,.8,.8,.4];g.RING_COLOR=[.5,.5,.5,1];g.INNERSPHERE_COLOR=[.6,.6,.6,1];g.SELECTED_COLOR=[1,1,1,1];g.NOAXIS_COLOR=[.901,.247,.749,1];g.STATIC_SPHERE_COLOR=[.1,.1,.1,.3];g.prototype.isTarget=
function(f){return-1!=this.targets.indexOf(f)};g.prototype.setTargets=function(f,k){if(f&&f.constructor!==Array)throw"nodes must be an Array";f&&0!=f.length?(k&&this.targets&&(f=this.targets.concat(f)),this.targets=f=f.filter(function(t,r){return f.indexOf(t)===r}),this.resetTransform(),this.position=this.computeCenter(this.targets)):k||(this.targets=null)};g.prototype.computeCenter=function(f){if((f=f||this.targets)&&f.length){for(var k=null,t=0;t<f.length;++t){var r=f[t];r.layers&this.layers&&(r=
r.getGlobalPosition(),k?vec3.add(k,k,r):k=r)}if(!k)return[0,0,0];vec3.scale(k,k,1/f.length);return k}};g.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?(this.transform=this.targets[0].transform,this.scaling=[1,1,1]):this.position=this.computeCenter(this.targets)))};g.prototype.updateTargets=function(){if(this.targets)for(var f=this.getGlobalMatrix(mat4.create()),
k=0;k<this.targets.length;++k){var t=this.targets[k];t.layers&this.layers&&t.fromMatrix(f,!0)}};g.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var f=0;f<this.targets.length;++f){var k=this.targets[f];k.layers&this.layers&&(this.target_tranforms[f]=new Float32Array(k.transform))}}};g.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var f=0;f<this.targets.length;++f){var k=
this.targets[f];k.layers&this.layers&&(k.transform=this.target_tranforms[f])}};g.prototype.removeTargetsFromScene=function(){if(this.targets){for(var f=0;f<this.targets.length;++f){var k=this.targets[f];k.layers&this.layers&&k.parentNode&&k.parentNode.removeChild(k)}this.targets=null}};g.prototype.getTargetBaseNodes=function(){function f(B){return-1!=t.indexOf(B)?!0:B.parentNode?f(B.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var k=[],t=this.targets,r=0;r<t.length;++r){var n=
t[r];n.layers&this.layers&&(n.parentNode&&f(n.parentNode)||k.push(n))}return k};g.prototype.applyTransformToTarget=function(f,k){var t=this.getGlobalMatrix(mat4.create()),r=mat4.invert(mat4.create(),t),n=mat4.create(),B=this.getTargetBaseNodes();if(B){for(var H=[1,1,1],I=0;I<B.length;++I){var D=B[I];H[0]=0<=D.scaling[0]?1:-1;H[1]=0<=D.scaling[1]?1:-1;H[2]=0<=D.scaling[2]?1:-1;k?(mat4.multiply(n,f,D.matrix),D.fromMatrix(n)):(D.getGlobalMatrix(n),this.coordinates==g.WORLD_SPACE&&mat4.multiply(n,r,n),
mat4.multiply(n,f,n),this.coordinates==g.WORLD_SPACE&&mat4.multiply(n,t,n),D.fromMatrix(n,!0));vec3.mul(D._scale,D._scale,H);D.position=this.applySnap(D.position);if(this.grid_size){var K=quat.toEuler(vec3.create(),D.rotation);K[0]=15*Math.round(K[0]*RAD2DEG/15)*DEG2RAD;K[1]=15*Math.round(K[1]*RAD2DEG/15)*DEG2RAD;K[2]=15*Math.round(K[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(D.rotation,K);quat.normalize(D.rotation,D.rotation)}}mat4.multiply(n,t,f);this.fromMatrix(n);this.scaling=[1,1,1];this.updateGizmo()}};
g.prototype.applyTranslation=function(f,k){var t=mat4.create();mat4.translate(t,t,f);this.applyTransformToTarget(t,k)};g.prototype.applyRotation=function(f,k,t){var r=mat4.create();if(t){var n=mat4.create();mat4.setTranslation(n,t);mat4.mul(r,r,n);mat4.rotate(r,r,f,k);mat4.setTranslation(n,[-t[0],-t[1],-t[2]]);mat4.mul(r,r,n)}else mat4.rotate(r,r,f,k);this.applyTransformToTarget(r)};g.prototype.applyScale=function(f,k){f.constructor===Number&&(f=[f,f,f]);var t=mat4.create();mat4.scale(t,t,f);this.applyTransformToTarget(t,
k)};g.prototype.applySnap=function(f){if(!this.grid_size)return f;f[0]=Math.round(f[0]/this.grid_size)*this.grid_size;f[1]=Math.round(f[1]/this.grid_size)*this.grid_size;f[2]=Math.round(f[2]/this.grid_size)*this.grid_size;return f};g.prototype.setColor=function(f){if(this.targets)for(var k=0;k<this.targets.length;++k){var t=this.targets[k];t.layers&this.layers&&(t=t.getMaterial())&&(t.color=f)}};g.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var f=
[],k=0;k<this.targets.length;++k){var t=this.targets[k];if(t.layers&this.layers){var r=t.clone(!0);t.parentNode.addChild(r);f.push(t)}}return this.targets=f}};g.prototype.onMouse=function(f){if(this._camera&&this.targets&&!1!==this.visible){var k=this._camera,t=k.getFront(),r=[f.canvasx,f.canvasy],n=k.getRay(r[0],r[1]),B=this.position,H=vec3.sub(vec3.create(),B,k.position);vec3.normalize(H,H);var I=this._selected_action,D=this.actions[I],K=this._global_matrix;k.project(B,null,this.center_2D);var M=
mat4.invert(mat4.create(),K),E=this.coordinates==g.OBJECT_SPACE;if("mousedown"==f.type){if(this.click_2D[0]=this.click_2D2[0]=r[0],this.click_2D[1]=this.click_2D2[0]=r[1],f.is_touch&&this.testMouseOver(f),I=this._selected_action=this._hover_action,D=this.actions[I])D.move&&D.axis?(M=vec3.clone(D.axis),mat4.rotateVec3(M,K,M),vec3.normalize(M,M),this._last=n.closestPointOnRay(B,M),f.shiftKey&&this.cloneTargets()):D.move&&D.normal&&(n.testPlane(B,D.normal)&&(this.click_pos=n.collision_point),f.shiftKey&&
this.cloneTargets()),"drag"==I&&(n.testPlane(B,t),this._last=n.collision_point,f.shiftKey&&this.cloneTargets()),"rotatefront"==I?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,.5*this.size),this.click_2D2.set(this.click_2D)):D.rotate&&(D.axis?(I=mat4.rotateVec3(vec3.create(),K,D.axis),n.testPlane(B,I)&&(vec3.sub(this.click_pos,n.collision_point,B),vec3.normalize(this.click_pos,
this.click_pos),B=vec3.scaleAndAdd(vec3.create(),B,this.click_pos,this.current_size),this.current_2D=this.click_2D=k.project(B))):n.testSphere(B,this.current_size)&&(this._last=n.collision_point,vec3.sub(this.click_pos,n.collision_point,B),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),H,this.click_pos))),this.click_model.set(K),this.click_transform.set(this.transform),this.click_dist=vec3.distance(this.click_2D,this.center_2D),this.saveTargetTransforms()}else if("mousemove"==
f.type)if(f.dragging&&this._selected_action){if("rotatefront"==I)return D=vec2.sub(vec3.create(),r,this.center_2D),vec2.normalize(D,D),B=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,D,.5*this.size),B=Math.atan2(D[0],D[1])-Math.atan2(B[0],B[1]),f.shiftKey&&(B=2*Math.PI*Math.ceil(36*B/(2*Math.PI))/36),B&&(this.restoreTargetTransforms(),this.applyRotation(B,H)),!0;if(D.rotate)return D.axis?(I=mat4.rotateVec3(vec3.create(),K,D.axis),n.testPlane(B,I)&&(f=vec3.sub(vec3.create(),n.collision_point,
B),vec3.normalize(f,f),B=vec3.scaleAndAdd(vec3.create(),B,f,this.current_size),this.current_2D=k.project(B),k=Math.clamp(vec3.dot(f,this.click_pos),-1,1),B=Math.acos(k),f=vec3.cross(vec3.create(),f,this.click_pos),vec3.normalize(f,f),k=vec3.dot(I,f),0<k&&(B*=-1),this.restoreTargetTransforms(),this.applyRotation(B,D.axis))):(M=vec3.cross(vec3.create(),H,this.click_pos),B=.01*(vec2.dist(this.center_2D,r)-this.click_dist),f=vec2.sub(vec2.create(),this.center_2D,r),D=vec2.sub(vec2.create(),this.center_2D,
this.click_2D),0>vec2.dot(f,D)&&(B=-B),console.log(B),this.restoreTargetTransforms(),this.applyRotation(B,M),this.click_axis=M),!0;H=null;if(D.move&&D.normal){if(n.testPlane(B,D.normal)&&(D=n.collision_point,this.applySnap(D),H=vec3.sub(vec3.create(),D,this.click_pos),this.click_pos=D,this.coordinates==g.OBJECT_SPACE))return mat4.rotateVec3(H,M,H),this.applyTranslation(H,!0),!0}else if(D.move||D.scale){k=null;D.axis&&(M=vec3.clone(D.axis),mat4.rotateVec3(M,K,M),vec3.normalize(M,M),k=n.closestPointOnRay(B,
M));if("scale"==I||D.scale&&f.ctrlKey)return f=1+.01*(r[1]-this.click_2D[1]),this.applyScale(f,E),this.click_2D[0]=r[0],this.click_2D[1]=r[1],!0;if("scalexy"==I||"scalexz"==I||"scaleyz"==I){f=1+.01*(r[1]-this.click_2D[1]);switch(I){case "scalexy":this.applyScale([f,f,1],E);break;case "scaleyz":this.applyScale([1,f,f],E);break;case "scalexz":this.applyScale([f,1,f],E)}this.click_2D[0]=r[0];this.click_2D[1]=r[1];return!0}if(D.scale)return f=vec2.distance(r,this.center_2D),D=f/this.click_dist,"scalex"==
I?this.applyScale([D,1,1],E):"scaley"==I?this.applyScale([1,D,1],E):"scalez"==I&&this.applyScale([1,1,D],E),this.click_dist=f,!0;D.move&&(E||this.applySnap(k),H=vec3.sub(vec3.create(),k,this._last),this._last.set(k))}"drag"==I&&(n.testPlane(B,this._camera.getFront()),k=n.collision_point,this.applySnap(k),H=vec3.sub(vec3.create(),k,this._last),this._last=k);if(H)return this.applyTranslation(H),!0}else this.testMouseOver(f);else if("wheel"==f.type){if("scale"==this._selected_action)return f=1+2E-4*
f.wheel,this.applyScale(f),!0;if("drag"==this._selected_action)return H=vec3.sub(vec3.create(),B,k.position),f=1+2E-4*f.wheel,vec3.scaleAndAdd(H,k.position,H,f),vec3.sub(H,H,B),this.applyTranslation(H),this._last=B,!0}if("mouseup"==f.type||this._selected_action&&0==f.buttons)if(this.saveTargetTransforms(),this._selected_action){this._selected_action=null;this.render(this._last_renderer,this._last_camera);this.testMouseOver(f);this.updateGizmo();if(this.onActionFinished)this.onActionFinished();return!0}return!1}};
g.prototype.testMouseOver=function(f){this._hover_action=null;var k=[f.canvasx,f.canvasy],t=1E5;f=null;for(var r in this.actions){var n=this.actions[r];if(n.visible){var B=vec2.distance(n.pos2D,k);B<n.radius*this.size&&B<t&&(t=B,f=r)}}f||(r=vec2.distance(this.center_2D,k),this.actions.rotatefront.visible&&10>Math.abs(r-.5*this.size)?f="rotatefront":this.mode&g.ROTATE&&r<.5*this.size&&(f="rotate"));return this._hover_action=f};g.prototype.cancel=function(){this._selected_action&&(this._selected_action=
null,this.restoreTargetTransforms())};g.prototype.render=function(f){this._last_renderer=f;var k=this._last_camera=f._camera;for(t in this.actions)this.actions[t].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.cube=GL.Mesh.cube({size:1}),gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:.1,height:.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:.02,
outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:.5*Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}));var t=gl.meshes.torus;var r=k.getFront(),n=k.getLocalVector(RD.UP);k.getLocalVector(RD.RIGHT);var B=this._position;C.set(B);C[3]=1;var H=k._projection_matrix[5];this.updateMatrices();c.set(this._global_matrix);var I=vec3.sub(vec3.create(),B,k.position);
vec3.normalize(I,I);this._camera=k;this._unitary_model=c;var D=this._hover_action,K=this._selected_action;K&&(D=K);var M=K?this.actions[K]:null,E=this.mode;mat4.rotateVec3(z,c,RD.RIGHT);mat4.rotateVec3(A,c,RD.UP);mat4.rotateVec3(u,c,RD.FRONT);vec3.normalize(z,z);vec3.normalize(A,A);vec3.normalize(u,u);mat4.fromTranslationFrontTop(p,B,r,n);vec4.transformMat4(C,C,k._viewprojection_matrix);this.current_size=n=gl.canvas.width/gl.canvas.height*this.size*C[3]/(gl.canvas.width*H);mat4.scale(c,c,[n,n,n]);
mat4.scale(p,p,[n,n,n]);n=vec3.dot(I,z);H=vec3.dot(I,A);var R=vec3.dot(I,u),S=vec3.dot(r,RD.RIGHT),a=vec3.dot(r,RD.UP),b=vec3.dot(r,RD.FRONT);this._camera.project(B,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);I=gl.shaders[this.shader];I.uniforms(f._uniforms);I.uniforms(k._uniforms);I.uniforms(this.uniforms);if("movex"==K)mat4.rotateZ(d,c,-Math.PI/2),this.drawAxis(d,
g.XAXIS_COLOR);else if("movey"==K)this.drawAxis(c,g.YAXIS_COLOR);else if("movez"==K)mat4.rotateX(d,c,-Math.PI/2),this.drawAxis(d,g.ZAXIS_COLOR);else if("drag"==K)f.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.XAXIS_COLOR,!0);else if(M&&M.normal&&this.render_move_plane)d.set(c),"movexz"==K?mat4.rotateX(d,d,Math.PI/2):"moveyz"==K&&mat4.rotateY(d,d,Math.PI/2),mat4.scale(d,d,[100,100,100]),I.setUniform("u_model",d),I.setUniform("u_color",[.1,.1,.1,.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),
I.draw(gl.meshes.plane),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==K)mat4.rotateX(d,p,Math.PI/2),I.setUniform("u_model",d),I.draw(t),f.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g.XAXIS_COLOR,!0),f.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,g.XAXIS_COLOR,!0),f.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.XAXIS_COLOR,!0),f.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g.XAXIS_COLOR),f.drawLine2D(this.click_2D2[0],
this.click_2D2[1],this.center_2D[0],this.center_2D[1],4,g.XAXIS_COLOR);else{if("rotate"==K){this.click_axis&&(mat4.fromTranslationFrontTop(d,B,r,this.click_axis),mat4.scale(d,d,[this.current_size,this.current_size,this.current_size]),this.drawAxis(d,g.NOAXIS_COLOR));this.drawRotateSphere(c,g.SPHERE_COLOR);f.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g.NOAXIS_COLOR,!0);return}if(M&&M.rotate){k=M.color||g.XAXIS_COLOR;"rotatex"==K?mat4.rotateZ(d,c,Math.PI/2):"rotatey"==K?mat4.rotateY(d,c,Math.PI/
2):"rotatez"==K&&mat4.rotateX(d,c,Math.PI/2);I.setUniform("u_model",d);I.setUniform("u_color",k);I.draw(t);f.drawCircle2D(this.center_2D[0],this.center_2D[1],2,k,!0);f.drawCircle2D(this.click_2D[0],this.click_2D[1],2,k,!0);f.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,k);f.drawCircle2D(this.current_2D[0],this.current_2D[1],2,k,!0);f.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,k);return}}"scale"==K?(f.drawCircle2D(this.center_2D[0],
this.click_2D[1],2,g.INNERSPHERE_COLOR,!0),f.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g.INNERSPHERE_COLOR,!0),f.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g.INNERSPHERE_COLOR)):(this.drawRotateSphere(c,g.STATIC_SPHERE_COLOR),E&g.ROTATE&&"rotate"==D&&this.drawRotateSphere(c,g.SPHERE_COLOR),E&g.ROTATEFRONT&&(mat4.rotateX(d,p,Math.PI/2),I.setUniform("u_model",d),I.setUniform("u_color","rotatefront"==D?g.SELECTED_COLOR:g.RING_COLOR),I.draw(t),this.actions.rotatefront.visible=
!0),.1<Math.abs(n)&&E&g.ROTATEX&&(mat4.rotateZ(d,c,Math.PI/2),0>b&&mat4.rotateX(d,d,Math.PI),0>a&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatex"==D?g.SELECTED_COLOR:g.XAXIS_COLOR,"rotatex")),.1<Math.abs(H)&&E&g.ROTATEY&&(d.set(c),0<S&&0>b?mat4.rotateY(d,d,-Math.PI/2):0>S&&0>b?mat4.rotateY(d,d,Math.PI):0>S&&0<b&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatey"==D?g.SELECTED_COLOR:g.YAXIS_COLOR,"rotatey")),.1<Math.abs(R)&&E&g.ROTATEZ&&(d.set(c),mat4.rotateX(d,d,Math.PI/2),0<S&&0>a?
mat4.rotateY(d,d,-Math.PI/2):0>S&&0>a?mat4.rotateY(d,d,Math.PI):0>S&&0<a&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatez"==D?g.SELECTED_COLOR:g.ZAXIS_COLOR,"rotatez")),.95>Math.abs(n)&&(mat4.rotateZ(d,c,0>S?-Math.PI/2:Math.PI/2),E&g.MOVEX&&this.drawArrow(d,"movex"==D?g.SELECTED_COLOR:g.XAXIS_COLOR,"movex"),E&g.SCALEX&&this.drawScale(d,"scalex"==D?g.SELECTED_COLOR:g.XAXIS_COLOR,"scalex")),.95>Math.abs(H)&&(0<a?mat4.rotateZ(d,c,Math.PI):d.set(c),E&g.MOVEY&&this.drawArrow(d,"movey"==D?g.SELECTED_COLOR:
g.YAXIS_COLOR,"movey"),E&g.SCALEY&&this.drawScale(d,"scaley"==D?g.SELECTED_COLOR:g.YAXIS_COLOR,"scaley")),.95>Math.abs(R)&&(mat4.rotateX(d,c,0>b?-Math.PI/2:Math.PI/2),E&g.MOVEZ&&this.drawArrow(d,"movez"==D?g.SELECTED_COLOR:g.ZAXIS_COLOR,"movez"),E&g.SCALEZ&&this.drawScale(d,"scalez"==D?g.SELECTED_COLOR:g.ZAXIS_COLOR,"scalez")),.2<Math.abs(R)&&(E&g.MOVEXY||E&g.SCALEXY)&&(mat4.translate(d,c,[.45*(0>n?1:-1),.45*(0>H?1:-1),0]),E&g.MOVEXY?this.drawFlat(d,"movexy"==D?g.SELECTED_COLOR:g.XYAXIS_COLOR,"movexy"):
this.drawFlat(d,"scalexy"==D?g.SELECTED_COLOR:g.XYAXIS_COLOR,"scalexy","circle")),.2<Math.abs(H)&&(E&g.MOVEXZ||E&g.SCALEXZ)&&(mat4.rotateX(d,c,Math.PI/2),mat4.translate(d,d,[.45*(0>n?1:-1),.45*(0>R?-1:1),0]),E&g.MOVEXZ?this.drawFlat(d,"movexz"==D?g.SELECTED_COLOR:g.XZAXIS_COLOR,"movexz"):this.drawFlat(d,"scalexz"==D?g.SELECTED_COLOR:g.XZAXIS_COLOR,"scalexz","circle")),.2<Math.abs(n)&&(E&g.MOVEYZ||E&g.SCALEYZ)&&(mat4.rotateY(d,c,Math.PI/2),mat4.translate(d,d,[.45*(0>R?1:-1),.45*(0>H?1:-1),0]),E&g.MOVEYZ?
this.drawFlat(d,"moveyz"==D?g.SELECTED_COLOR:g.YZAXIS_COLOR,"moveyz"):this.drawFlat(d,"scaleyz"==D?g.SELECTED_COLOR:g.YZAXIS_COLOR,"scaleyz","circle")),E&g.DRAG&&this.drawInnerSphere(c,"drag"),E&g.SCALE&&this.drawInnerSphere(c,"scale"),E&g.RESIZE&&this.drawResize(c,"resize"),gl.enable(gl.DEPTH_TEST))}}};g.prototype.drawArrow=function(f,k,t){var r=gl.shaders[this.shader],n=gl.meshes.cone,B=gl.meshes.cylinder,H=this._hover_action;mat4.translate(l,f,[0,1.1,0]);r.setUniform("u_model",l);r.setUniform("u_color",
H==t?g.SELECTED_COLOR:k);r.draw(n);this.mode==g.MOVEALL?(mat4.translate(l,l,[0,-.4,0]),mat4.scale(l,l,[1,1,1])):(mat4.translate(l,l,[0,-.15,0]),mat4.scale(l,l,[1,.5,1]));r.setUniform("u_model",l);r.draw(B);this.toScreen(l,t,[0,.6,0])};g.prototype.drawAxis=function(f,k){var t=gl.shaders[this.shader],r=gl.meshes.sphere;mat4.scale(l,f,[.01,100,.01]);t.setUniform("u_model",l);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);t.setUniform("u_color",
[k[0],k[1],k[2],.2]);gl.depthFunc(gl.GREATER);t.draw(r);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);t.setUniform("u_color",k);t.draw(r);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(f)};g.prototype.drawFlat=function(f,k,t,r){r=gl.meshes[r||"plane"];var n=gl.shaders[this.shader];mat4.scale(d,f,[.25,.25,.25]);n.setUniform("u_color",k);n.setUniform("u_model",d);gl.enable(gl.BLEND);n.draw(r);gl.disable(gl.BLEND);this.toScreen(d,t)};g.prototype.drawRotator=function(f,k,t){var r=gl.meshes.quartertorus,
n=gl.shaders[this.shader];mat4.scale(d,f,[.9,.9,.9]);n.setUniform("u_color",k);n.setUniform("u_model",d);n.draw(r);this.toScreen(d,t,[-.75,0,.75])};g.prototype.drawScale=function(f,k,t){var r=gl.meshes.cylinder,n=gl.meshes.sphere,B=gl.shaders[this.shader];B.setUniform("u_color",k);this.mode==g.SCALEALL?(mat4.translate(d,f,[0,.5,0]),mat4.scale(d,d,[1,1,1])):(mat4.translate(d,f,[0,.25,0]),mat4.scale(d,d,[1,.5,1]));B.setUniform("u_model",d);B.draw(r);mat4.translate(d,f,[0,.4,0]);this.mode==g.SCALEALL?
mat4.scale(d,d,[.1,.1,.1]):mat4.scale(d,d,[.1,.2,.1]);B.setUniform("u_model",d);B.draw(n);this.toScreen(d,t)};g.prototype.drawRotateSphere=function(f,k){var t=gl.shaders[this.shader],r=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(d,f,[.9,.9,.9]);t.setUniform("u_model",d);t.setUniform("u_color",k);t.draw(r);gl.disable(gl.BLEND)};g.prototype.drawInnerSphere=function(f,k){var t=gl.shaders[this.shader],r=gl.meshes.sphere,n=this._hover_action;mat4.scale(d,
f,[.1,.1,.1]);t.setUniform("u_model",d);t.setUniform("u_color",n==k?g.SELECTED_COLOR:g.INNERSPHERE_COLOR);t.draw(r);"drag"==k&&(mat4.scale(d,f,[.07,.07,.07]),t.setUniform("u_model",d),t.setUniform("u_color",n==k?g.INNERSPHERE_COLOR:[0,0,0,1]),t.draw(r));k&&this.toScreen(d,k)};g.prototype.drawResize=function(f,k){};g.prototype.computeBounding=function(f){f=f||BBox.create();for(var k=0;k<this.targets.length;++k){var t=this.targets[k].updateBoundingBox();0==k?BBox.copy(f,t):BBox.merge(f,f,t)}return f};
g.prototype.renderOutline=function(f,k,t,r){if((r=r||this.targets)&&r.length){var n=this.layers;r=r.filter(function(K){return K.layers&n});var B=gl.viewport_data[2],H=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==B&&this._selection_buffer.height==H||(this._selection_buffer=new GL.Texture(B,H,{magFilter:gl.NEAREST}));g.outline_material||(g.outline_material=new RD.Material({shader_name:"flat"}));var I=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,
0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);f.shader_overwrite=I;var K=f.onNodeShaderUniforms;f.onNodeShaderUniforms=function(E,R){R.setUniform("u_color",[1,1,1,1])};var M=f.pipeline;f.pipeline=null;f.overwrite_material=RD.Gizmo.outline_material;f.render(k,t,r);f.shader_overwrite=null;f.onNodeShaderUniforms=K;f.pipeline=M;f.overwrite_material=null});var D=gl.shaders.outline;D||=gl.shaders.outline=GL.Shader.createFX("\n\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n");gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(D,{u_color:[1,1,1,1],u_res:[1/B,1/H]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};g.prototype.renderCameraGizmo=function(f,k){this.drawInnerSphere};g.prototype.toScreen=function(f,k,t){k=this.actions[k];mat4.multiplyVec3(k.pos,f,t||[0,0,0]);this._camera.project(k.pos,g.full_viewport,k.pos2D);k.visible=!0};extendClass(g,RD.SceneNode);RD.Gizmo=g})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,convert_skeletons:!1,overwrite_materials:!0,rename_assets:!1,prefabs:{},texture_options:{format:GL.RGBA,
magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT,no_flip:!1},load:function(v,g,x,q){function c(f){function k(n){var B=this.buffer;B.data=n;B.dataview=new Uint8Array(n);f.length?c(f):p()}var t=f.pop(),r=A+"/"+t.uri;"blob:"==t.uri.substr(0,5)&&(r=t.uri);"data:"==t.uri.substr(0,5)?(r=_base64ToArrayBuffer(t.uri.substr(37)),k.call({buffer:t},r)):fetch(r).then(function(n){return n.arrayBuffer()}).then(k.bind({buffer:t}))}function p(){u.filename=z;u.folder=A;u.url=v;RD.GLTF.parseBuffers(u,
d);var f=RD.GLTF.parse(u),k=f.serialize();RD.GLTF.prefabs[v]=k;g&&g(f)}if(!v)throw"url missing";var u=null,z="",A="";if(v.constructor===String){A=v.split("/");z=A.pop();x=x||z.split(".").pop().toLowerCase();A=A.join("/");var C=new XMLHttpRequest;C.onload=function(){if(200!=this.status)console.error("GLTF not found",v),g&&g(null);else{var f=C.response;"gltf"==x?(u=f,c(u.buffers.concat())):"glb"==x&&((u=RD.GLTF.parseGLB(f))?p():console.error("error parsing GLB:",z))}};C.onerror=function(){console.error("Network Error");
g&&g(null)};q&&(C.onprogress=function(f){q(v,f.loaded,f.total)});C.responseType="gltf"==x?"json":"arraybuffer";C.open("GET",v);C.send()}else{var d=v;if(z=d.main){v=z;var l=d[z];"glb"==l.extension?(u=RD.GLTF.parseGLB(l.data))&&p():(u=l.data,this.parseBuffers(),p())}}},parseBuffers:function(v,g){for(var x=0;x<v.buffers.length;++x){var q=v.buffers[x];if(!q.data){if(q.uri&&"data:"==q.uri.substr(0,5))q.data=_base64ToArrayBuffer(q.uri.substr(37));else{if(!g)throw"missing data in glb";q.data=g[q.uri].data}q.dataview=
new Uint8Array(q.data)}}},parseGLB:function(v){var g=new Uint8Array(v),x=new DataView(v);if(1179937895!=x.getUint32(0,!0))return console.error("incorrect gltf header"),null;var q=x.getUint32(4,!0);console.log("GLTF Version: "+q);x.getUint32(8,!0);q=12;for(var c=null,p=0;q<g.length;){var u=x.getUint32(q,!0),z=x.getUint32(q+4,!0),A=v.slice(q+8,q+8+u);q+=8+u;if(z==RD.GLTF.JSON_CHUNK){if("undefined"===typeof TextDecoder)throw"Sorry, this browser does not support TextDecoder...";c=(new TextDecoder("utf-8")).decode(A);
c=JSON.parse(c)}else z==RD.GLTF.BINARY_CHUNK?(u=c.buffers[p],u.data=A,u.dataview=new Uint8Array(A),p++):console.warn("gltf unknown chunk type: ","0x"+z.toString(16))}return c},parse:function(v,g){console.log(v);v.url||(v.url=g||"scene.glb");g={};1<v.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var x=v.scenes[v.scene||0].nodes;this.gltf_materials={};if(v.buffers&&v.buffers.length)for(var q=0;q<v.buffers.length;++q){var c=v.buffers[q];c.uri&&!c.data&&
"data:"==c.uri.substr(0,5)&&(c.data=_base64ToArrayBuffer(c.uri.substr(37)),c.dataview=new Uint8Array(c.data))}if(v.skins)for(q=0;q<v.skins.length;++q){c=v.skins[q];for(var p=0;p<c.joints.length;++p)v.nodes[c.joints[p]]._is_joint=!0}c=null;1<x.length&&(c=new RD.SceneNode,c.name="root");for(q=0;q<x.length;++q){var u=p=x[q];null!=p.node&&(u=p.node);p=RD.GLTF.parseNode(null,u,v);c||=p;1<x.length&&c.addChild(p);p.id=v.url.replace(/\//gi,"_")+"::node_"+q;g[p.id]=g[q]=p}if(v.animations&&v.animations.length){if(RD.Animation)for(c.animations=
[],q=0;q<v.animations.length;++q)x=this.parseAnimation(q,v,g),x.id=v.filename+"::"+x.name,x&&(RD.Animations[x.id]=x,c.animations.push(x));else console.error("you must include rendeer-animation.js to allow animations");this.convert_skeletons&&this.convertSkinToSkeleton(c,c)}c.materials=this.gltf_materials;c.meta={asset:v.asset};return c},parseNode:function(v,g,x){var q=x.nodes[g];v=v||new RD.SceneNode;for(var c in q){var p=q[c];switch(c){case "name":v.name=p;break;case "translation":v.position=p;break;
case "rotation":v.rotation=p;break;case "scale":v.scaling=p;var u=0;0>v.scaling[0]&&u++;0>v.scaling[1]&&u++;0>v.scaling[2]&&u++;1==u%2&&(v.flags.frontFace=GL.CW);break;case "matrix":v.fromMatrix(p);0>mat4.determinant(p)&&(v.flags.frontFace=GL.CW);break;case "mesh":if(p=RD.GLTF.parseMesh(p,x))for(v.mesh=p.name,v.primitives=[],u=0;u<p.info.groups.length;++u){var z=p.info.groups[u],A=null;null!=z.material&&(A=this.parseMaterial(z.material,x));v.primitives.push({index:u,material:A?A.name:null,mode:z.mode});
!v.material&&A&&(v.material=A.name)}break;case "skin":v.skin=this.parseSkin(p,x);break;case "children":if(p.length)for(u=0;u<p.length;++u)z=RD.GLTF.parseNode(null,p[u],x),v.addChild(z);break;case "extras":case "extra":v.extras=p;break;default:"_"!=c[0]&&console.log("gltf node info ignored:",c,q[c])}}if(v.mesh&&v.skin)for(p=gl.meshes[v.mesh],p.bones=[],u=0;u<v.skin.joints.length;++u)p.bones.push([v.skin.joints[u],v.skin.bindMatrices[u]]);q.name||(q.name=v.name="node_"+g);q._is_joint&&(v.is_joint=!0);
return v},parseMesh:function(v,g){for(var x=g.meshes[v],q=gl.meshes,c=[],p=[],u=0,z=0;z<x.primitives.length;++z){var A=this.parsePrimitive(x,z,g);if(A){A.start=u;u+=A.length;p.push(A);var C={vertexBuffers:{},indexBuffers:{}},d;for(d in A.buffers){var l=d;"bones"==l&&(l="bone_indices");"indices"==l||"triangles"==l?C.indexBuffers[l]={data:A.buffers[d]}:C.vertexBuffers[l]={data:A.buffers[d]}}c.push({mesh:C})}}u=null;1<c.length?u=GL.Mesh.mergeMeshes(c):1==c.length&&(z=c[0].mesh,u=new GL.Mesh(z.vertexBuffers,
z.indexBuffers),u.info&&z.info&&(u.info=z.info));if(!u)return null;for(z=0;z<x.primitives.length;++z)(c=u.info.groups[z])||(u.info.groups[z]=c={}),A=x.primitives[z],c.material=A.material,c.mode=null!=A.mode?A.mode:4,c.start=p[z].start,c.length=p[z].length;u.name=x.name+"_"+v;if(!u.name||this.rename_assets)u.name=g.filename+"::mesh_"+(x.name||v);u.updateBoundingBox();u.computeGroupsBoundingBoxes();return q[u.name]=u},parsePrimitive:function(v,g,x){var q={buffers:{}},c=q.buffers;v=v.primitives[g];if(v.extensions)if(v.extensions.KHR_draco_mesh_compression){if("undefined"==
typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";c=q.buffers=this.decompressDraco(v,x);if(!c)return null}else throw"mesh data is compressed, this importer does not support it yet";else{null==!v.attributes.POSITION&&console.warn("gltf mesh without positions");for(var p in this.buffer_names){g=this.buffer_names[p];var u=v.attributes[p];null!=u&&(u=this.parseAccessor(u,x,this.flip_uv&&("coords"==g||"coords1"==g)))&&(c[g]=u)}null!=v.indices&&(c.triangles=
this.parseAccessor(v.indices,x))}if(!c.vertices)return console.error("primitive without vertices"),null;q.mode=v.mode;q.material=v.material;q.start=0;q.length=c.triangles?c.triangles.length:c.vertices.length/3;return q},convertSkinToSkeleton:function(v,g){if(v.skin){var x=g.findNodeByName(v.skin.skeleton_root);v.skeleton||(v.skeleton=new RD.Skeleton);v.skeleton.importSkeleton(x||g)}for(x=0;x<v.children.length;++x)this.convertSkinToSkeleton(v.children[x],g)},installDracoModule:function(v){var g=this.draco_data_types=
{},x=this;this.decoderModule?v&&v(this.decoderModule):"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(q){var c=x.decoderModule=q;g[c.DT_INT8]=Int8Array;g[c.DT_UINT8]=Uint8Array;g[c.DT_INT16]=Int16Array;g[c.DT_UINT16]=Uint16Array;g[c.DT_INT32]=Int32Array;g[c.DT_UINT32]=Uint32Array;g[c.DT_FLOAT32]=Float32Array;v&&v(q)}):console.error("Draco3D not installed")},decompressDraco:function(v,g){if(!this.decoderModule||!this.decoderModule.Decoder)return console.warn("Mesh with DRACO encoding, DRACO Decoder Module not found"),
null;this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,v,g)},decodePrimitive:function(v,g,x){var q={};g=x.buffers[x.bufferViews[g.extensions.KHR_draco_mesh_compression.bufferView].buffer];var c=g.dataview.buffer;x=this.decoderModule;g=new x.DecoderBuffer;g.Init(new Int8Array(c),c.byteLength);if(v.GetEncodedGeometryType(g)==x.TRIANGULAR_MESH){var p=new x.Mesh;c=v.DecodeBufferToMesh(g,p);if(!c.ok()||0===p.ptr)throw Error("GLTF Draco: Decoding failed: "+
c.error_msg());p.num_points();for(var u in this.buffer_names){c=this.buffer_names[u];var z=u;"COLOR_0"==z?z="COLOR":"TEXCOORD_0"==z&&(z="TEX_COORD");if(z=this.decodeBuffer(p,x[z],"coords"==c||"coords1"==c,v))q[c]=z.data}u=3*p.num_faces();c=4*u;z=x._malloc(c);v.GetTrianglesUInt32Array(p,c,z);q.triangles=(new Uint32Array(x.HEAPF32.buffer,z,u)).slice();x._free(z)}x.destroy(g);x.destroy(p);return q},decodeBuffer:function(v,g,x,q){if(null==g)return null;var c=this.decoderModule;g=q.GetAttributeId(v,g);
if(-1==g)return null;var p=q.GetAttribute(v,g);g=p.data_type();var u=p.num_components(),z=v.num_points();p.size();var A=z*u,C=this.draco_data_types[g];c=new c.DracoFloat32Array;q.GetAttributeFloatForAllPoints(v,p,c);v=new C(A);for(q=0;q<v.length;++q)v[q]=c.GetValue(q);if(x)for(q=1;q<v.length;q+=u)v[q]=1-v[q];return{num_points:z,num_comps:u,data_type:g,data:v}},parseAccessor:function(v,g,x,q,c){c=g.accessors[v];if(!c)return console.warn("gltf accessor not found"),null;var p=this.numComponents[c.type];
if(!p)return console.warn("gltf accessor of unknown type:",c.type),null;var u=c.count*p;switch(c.componentType){case RD.GLTF.FLOAT:u=new Float32Array(u);break;case RD.GLTF.UNSIGNED_INT:u=new Uint32Array(u);break;case RD.GLTF.SHORT:u=new Int16Array(u);break;case RD.GLTF.UNSIGNED_SHORT:u=new Uint16Array(u);break;case RD.GLTF.BYTE:u=new Int8Array(u);break;case RD.GLTF.UNSIGNED_BYTE:u=new Uint8Array(u);break;default:console.warn("gltf accessor of unsupported type: ",c.componentType),u=new Float32Array(u)}null==
q&&(q=g.bufferViews[c.bufferView]);if(!q)return console.warn("gltf bufferView not found"),null;v=g.buffers[q.buffer];if(!v||!v.data)return console.warn("gltf buffer not found or data not loaded"),null;g=new Uint8Array(u.buffer);null==q.byteOffset&&(q.byteOffset=0);var z=q.byteOffset+(c.byteOffset||0);if(q.byteStride&&q.byteStride!=p*u.BYTES_PER_ELEMENT){g=p*u.BYTES_PER_ELEMENT;z=v.dataview.subarray(z,z+q.byteLength);for(var A=new u.constructor(p),C=new Uint8Array(A.buffer),d=v=0;d<c.count;++d)C.set(z.subarray(v,
v+g)),u.set(A,d*p),v+=q.byteStride}else z=v.dataview.subarray(z,z+g.length),g.set(z);if(x)for(d=1;d<u.length;d+=p)u[d]=1-u[d];return u},parseMaterial:function(v,g){var x=g.materials[v];if(!x)return console.warn("gltf material not found"),null;var q=x.name;if(!q||this.rename_assets)q=g.filename+"::mat_"+(x.name||v);if((v=RD.Materials[q])&&(!this.overwrite_materials||v.from_filename==g.filename))return v;v=new RD.Material;v.name=q;v.from_filename=g.filename;null!=x.alphaMode&&(v.alphaMode=x.alphaMode);
v.alphaCutoff=null!=x.alphaCutoff?x.alphaCutoff:.5;null!=x.doubleSided&&(v.flags.two_sided=x.doubleSided);v.normalmapFactor=1;x.pbrMetallicRoughness&&(v.model="pbrMetallicRoughness",v.color.set([1,1,1]),v.opacity=1,v.metallicFactor=1,v.roughnessFactor=1,null!=x.pbrMetallicRoughness.baseColorFactor&&(v.color=x.pbrMetallicRoughness.baseColorFactor),x.pbrMetallicRoughness.baseColorTexture&&(v.textures.albedo=this.parseTexture(x.pbrMetallicRoughness.baseColorTexture,g),"MASK"==v.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic&&
(q=gl.textures[v.textures.albedo.texture]))&&(q.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8)),null!=x.pbrMetallicRoughness.metallicFactor&&(v.metallicFactor=x.pbrMetallicRoughness.metallicFactor),null!=x.pbrMetallicRoughness.roughnessFactor&&(v.roughnessFactor=x.pbrMetallicRoughness.roughnessFactor),x.pbrMetallicRoughness.metallicRoughnessTexture&&(v.textures.metallicRoughness=this.parseTexture(x.pbrMetallicRoughness.metallicRoughnessTexture,
g)));x.occlusionTexture&&(v.textures.occlusion=this.parseTexture(x.occlusionTexture,g));x.normalTexture&&(v.textures.normal=this.parseTexture(x.normalTexture,g));x.emissiveTexture&&(v.textures.emissive=this.parseTexture(x.emissiveTexture,g));x.emissiveFactor&&(v.emissive=x.emissiveFactor);x.extensions&&x.extensions.KHR_materials_emissive_strength&&v.emissive&&vec3.scale(v.emissive,v.emissive,x.extensions.KHR_materials_emissive_strength.emissiveStrength);RD.Materials[v.name]&&console.debug("Material overwritten: "+
v.name);RD.Materials[v.name]=v;return this.gltf_materials[v.name]=v},parseTexture:function(v,g){var x=g.textures[v.index];if(!x)return console.warn("gltf texture not found"),null;var q=g.images[x.source];if(q.uri){var c=q.uri;c.split(".").pop()}else{c=g.url.replace(/[\/\.:]/gi,"_")+"_image_"+v.index;var p=q.mimeType?q.mimeType.split("/").pop():"png";c+="."+p}var u={};if(!gl.textures[c])if(q.uri){var z=q.uri;if("data:"==z.substr(0,5)){var A=q.uri.indexOf(","),C=q.uri.substr(5,A);p=C.split("/").pop().toLowerCase();
c=g.folder+"/"+z+"image_"+v.index+"."+p;p=_base64ToArrayBuffer(q.uri.substr(A+1));C=URL.createObjectURL(new Blob([p],{type:C}));C=GL.Texture.fromURL(C,this.texture_options);C.name=c;gl.textures[c]=C}else"blob:"==z.substr(0,5)?u.texture=z:u.texture=g.folder+"/"+z}else null!=q.bufferView&&(C=g.bufferViews[q.bufferView],null==C.byteOffset&&(C.byteOffset=0),p=g.buffers[C.buffer].data.slice(C.byteOffset,C.byteOffset+C.byteLength),C=URL.createObjectURL(new Blob([p],{type:q.mimeType})),C=GL.Texture.fromURL(C,
this.texture_options),C.name=c,gl.textures[c]=C,g.asset&&g.asset.low_quality&&(q=g.folder+"/"+g.filename.replace(/\.[^/.]+$/,"")+"/"+q.name,g.asset.hd_textures||(g.asset.hd_textures={}),g.asset.hd_textures[c]=q));u.texture||(u.texture=c);null!=x.sampler&&(g=g.samplers[x.sampler],null!=g.magFilter&&(u.magFilter=g.magFilter),null!=g.minFilter&&(u.minFilter=g.minFilter));v.texCoord&&(u.uv_channel=v.texCoord);return u},parseSkin:function(v,g){v=g.skins[v];var x={};null!=v.skeleton&&(x.skeleton_root=g.nodes[v.skeleton].name);
var q=this.parseAccessor(v.inverseBindMatrices,g);if(!q)return console.warn("accessor is null"),null;x.bindMatrices=this.splitBuffer(q,16);x.joints=[];for(q=0;q<v.joints.length;++q){var c=g.nodes[v.joints[q]];x.joints.push(c.id||c.name)}return x},splitBuffer:function(v,g){v||console.warn("buffer is null");for(var x=v.length,q=[],c=0;c<x;c+=g)q.push(new v.constructor(v.subarray(c,c+g)));return q},parseAnimation:function(v,g,x){x=g.animations[v];var q=new RD.Animation;q.name=x.name||"anim_"+v;for(var c=
v=0;c<x.channels.length;++c){var p=new RD.Animation.Track,u=x.channels[c],z=x.samplers[u.sampler];p.target_node=g.nodes[u.target.node].name;p.target_property=u.target.path.toLowerCase();if(u=this.rename_animation_properties[p.target_property])p.target_property=u;u=this.parseAccessor(z.input,g);var A=this.parseAccessor(z.output,g);if(A){var C=g.accessors[z.output].type;z=RD.TYPES[C];z==RD.VEC4&&"rotation"==p.target_property&&(z=RD.QUAT);p.type=z;if(z=RD.TYPES_SIZE[z]){C=A.length/z;for(var d=new Float32Array((1+
z)*C),l=0;l<C;++l){d[l*(1+z)]=u[l];var f=A.subarray(l*z,l*z+z);d.set(f,l*(1+z)+1)}p.data=d;p.packed_data=!0;v=Math.max(v,u[u.length-1]);q.addTrack(p)}else console.warn("gltf unknown type:",C)}else console.warn("animation accedor missing")}q.duration=v;return q},loadFromFiles:function(v,g){function x(l){var f=l.target.result,k=this.extension;const t=p.texture_options.magFilter,r=p.texture_options.minFilter;if("gltf"==k)f=JSON.parse(f),q.main=this.filename;else if("glb"==k)q.main=this.filename;else if("bin"==
k)u.push(this.filename);else if("jpeg"==k||"jpg"==k||"png"==k)l=URL.createObjectURL(new Blob([f],{type:l.target.mimeType})),k=GL.Texture.fromURL(l,{wrap:gl.REPEAT,extension:k,magFilter:t,minFilter:r}),k.name=this.filename,gl.textures[k.name]=k,gl.textures["/textures/"+k.name]&&(gl.textures["/textures/"+k.name]=k);q[this.filename]={filename:this.filename,data:f,extension:this.extension};c--;0==c&&(q.binaries=u,p.load(q,function(n){g&&g(n)}))}for(var q={},c=v.length,p=this,u=[],z=0;z<v.length;++z){var A=
v[z],C=new FileReader,d=A.name.split(".");d=d[d.length-1].toLowerCase();C.onload=x;C.filename=A.name;C.extension=d;"gltf"==d?C.readAsText(A):C.readAsArrayBuffer(A)}},removeRootPathFromTextures:function(v,g,x){if(g)for(var q in v){g=v[q];for(var c in g.textures)if(x=g.textures[c])x.constructor===String&&0==x.indexOf(ROOM.root_path)&&-1!=x.texture.indexOf("/")?x.substr(ROOM.root_path.length):x.texture&&0==x.texture.indexOf(ROOM.root_path)&&-1!=x.texture.indexOf("/")&&(x.texture=x.texture.substr(ROOM.root_path.length))}},
encodeGLTF:function(v,g){function x(n,B){B=B.data?B.data:B;var H=B.length,I=1,D=q.FLOAT;B.constructor===Uint32Array?(D=q.UNSIGNED_INT,n="SCALAR"):B.constructor===Uint16Array?(D=q.UNSIGNED_SHORT,n="SCALAR"):"TEXCOORD_0"==n||"TEXCOORD_1"==n?(I=2,n="VEC2"):(I=3,n="VEC3");H/=I;var K=Array.from(B.subarray(0,I));var M=Array.from(B.subarray(0,I));for(var E=0;E<B.length;E++)K[E%I]=Math.min(B[E],K[E%I]),M[E%I]=Math.max(B[E],M[E%I]);B={bufferView:c.push(B)-1,byteOffset:0,componentType:D,count:H,type:n,max:M,
min:K};return p.accessors.push(B)-1}var q=WebGL2RenderingContext,c=[],p={accessors:[],asset:{generator:"RendeerJS",version:"2.0"},bufferViews:[],buffers:[{}],meshes:[],nodes:[],scene:0,scenes:[{nodes:[0]}]},u=0;g=[];var z=0,A=[];v=v.root.getAllChildren([v.root]);for(var C=0;C<v.length;++C){var d=v[C];d._index_in_glb=C;var l=d.mesh?gl.meshes[d.mesh]:null;if(l&&null==l._index_in_glb){l._index_in_glb=u++;g[l._index_in_glb]=l;l._glb_attributes={};l._glb_attributes.POSITION=x("POSITION",l.vertexBuffers.vertices);
if(l.vertexBuffers.normals){for(var f=0;f<l.vertexBuffers.normals.data.length;f+=3){var k=l.vertexBuffers.normals.data.subarray(f,f+3);vec3.normalize(k,k)}l._glb_attributes.NORMAL=x("NORMAL",l.vertexBuffers.normals)}l.vertexBuffers.coords&&(l._glb_attributes.TEXCOORD_0=x("TEXCOORD_0",l.vertexBuffers.coords));l.vertexBuffers.coords1&&(l._glb_attributes.TEXCOORD_1=x("TEXCOORD_1",l.vertexBuffers.coords1));l.indexBuffers.triangles&&(l._glb_indices=x("INDICES",l.indexBuffers.triangles));if(l.indexBuffers.triangles&&
l.info&&l.info.groups){k=l.indexBuffers.triangles;var t=[];for(f=0;f<l.info.groups.length;++f){var r=l.info.groups[f];r=new k.data.constructor(k.data.subarray(r.start,r.start+r.length));r=x("INDICES",r);t.push(r)}l._glb_indices_group=t}}d.material&&(d=RD.Materials[d.material])&&null==d._index_in_glb&&(d._index_in_glb=z++,A[d._index_in_glb]=d)}for(C=0;C<v.length;++C){d=v[C];u={};d.name&&(u.name=d.name);if(d.mesh&&(z=RD.Materials[d.material],l=gl.meshes[d.mesh])){if(d.primitives&&d.primitives.length){f=
{primitives:[]};for(t=0;t<d.primitives.length;++t){k={attributes:l._glb_attributes,mode:q.TRIANGLES};if(r=RD.Materials[d.primitives[C].material]||z)k.material=r._index_in_glb;null!=l._glb_indices_group[t]&&(k.indices=l._glb_indices_group[t]);f.primitives.push(k)}t=p.meshes.length}else t=p.meshes.length,k={attributes:l._glb_attributes,mode:q.TRIANGLES},z&&(k.material=z._index_in_glb),f={primitives:[k]},null!=d.submesh&&l._glb_indices_group?k.indices=l._glb_indices_group[d.submesh]:null!=l._glb_indices&&
(k.indices=l._glb_indices);p.meshes.push(f);u.mesh=t}Object.keys(d.extras).length&&(u.extras=d.extras);if(d.children&&d.children.length)for(u.children=[],f=0;f<d.children.length;f++)u.children.push(d.children[f]._index_in_glb);l=mat4.create();for(f=0;16>f;++f)if(d._local_matrix[f]!=l[f]){u.matrix=typedArrayToArray(d._local_matrix);break}p.nodes[C]=u}if(A.length)for(p.materials=[],C=0;C<A.length;C++)d=A[C],p.materials[C]={alphaMode:"OPAQUE",doubleSided:d.flags.two_sided,emissiveFactor:[0,0,0],pbrMetallicRoughness:{baseColorFactor:Array.from(d.color)}};
for(C=A=d=0;C<c.length;C++)d+=c[C].byteLength;p.buffers[0].byteLength=d;d=new Uint8Array(d);for(C=0;C<c.length;C++){l=c[C];u=new Uint8Array(l.buffer);d.set(u,A);z={buffer:0,byteOffset:A,byteLength:u.byteLength};if(l.constructor===Float32Array)z.target=q.ARRAY_BUFFER;else if(l.constructor===Uint16Array||l.constructor===Uint32Array)z.target=q.ELEMENT_ARRAY_BUFFER;p.bufferViews.push(z);A+=u.byteLength}for(C=0;C<g.length;++C)delete g[C]._glb_indices,delete g[C]._index_in_glb,delete g[C]._glb_attributes;
for(C=0;C<v.length;++C)delete v[C]._index_in_glb;return{json:p,binary:d}},encodeGLB:function(v,g){v=JSON.stringify(v);var x=(new TextEncoder).encode(v);v=4*Math.ceil(x.byteLength/4);var q=4*Math.ceil(g.byteLength/4),c=new Uint8Array(20+v+8+q),p=new DataView(c.buffer);p.setUint32(0,1179937895,!0);p.setUint32(4,2,!0);p.setUint32(8,c.byteLength,!0);var u=12;p.setUint32(u,v,!0);p.setUint32(u+4,RD.GLTF.JSON_CHUNK,!0);c.set(x,u+8);for(x=x.byteLength;x<v;++x)c[u+8+x]=32;u+=8+v;p.setUint32(u,q,!0);p.setUint32(u+
4,RD.GLTF.BINARY_CHUNK,!0);c.set(g,u+8);return c}};RD.SceneNode.prototype.loadGLTF=function(v,g){function x(p){q.loading=!1;p.updateGlobalMatrix(!1,!0);p&&q.addChild(p);g&&g(q,p)}var q=this;if(RD.GLTF.prefabs[v]){var c=new RD.SceneNode;c.configure(RD.GLTF.prefabs[v]);x(c)}else this.loading=!0,RD.GLTF.load(v,x)};function _base64ToArrayBuffer(v){v=window.atob(v);for(var g=v.length,x=new Uint8Array(g),q=0;q<g;q++)x[q]=v.charCodeAt(q);return x.buffer}"undefined"!=typeof DracoDecoderModule&&RD.GLTF.installDracoModule(RD.GLTF.onReady);
(function(v){function g(q){this.renderer=q;this.mode=g.FORWARD;this.visible_layers=65535;this.bgcolor=vec4.fromValues(.1,.1,.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.emissive_factor=this.occlusion_gamma=this.occlusion_factor=this.exposure=this.environment_factor=1;this.postfx_shader_name=null;this.allow_overlay=this.timer_queries_enabled=!0;this.brightness=this.contrast=1;this.gamma=2.2;this.parallax_reflection=
!1;this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=mat4.create();this.texture_matrix=mat3.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.skip_background=this.single_pass=!1;this.allow_instancing=!0;this.debug_instancing=!1;this.use_rendertexture=!0;this.alpha_composite_target_texture=this.fx=null;this.frame_time=-1;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_occlusion_gamma:this.occlusion_gamma,
u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_gamma:this.gamma,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_viewport:gl.viewport_data,u_camera_perspective:1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec3.fromValues(0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),u_backface_color:vec3.fromValues(.5,
.5,.5),u_normalFactor:1,u_metallicRough:!1,u_reflectance:.1,u_texture_matrix:this.texture_matrix,u_displacement_factor:0,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:.5,u_isAnisotropic:!1,u_anisotropy:.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this._instancing_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.current_camera=this.final_fbo=this.final_texture=
null;this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new x.Material;this.onRenderBackground=null}var x=v.RD;g.FORWARD=1;g.DEFERRED=2;g.MACROS={UVS2:1,COLOR:2,POINTS:4,INSTANCING:8,SKINNING:16,PARALLAX_REFLECTION:32};g.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");g.maps_sampler=[];for(v=0;v<g.maps.length;++v)g.maps_sampler[v]="u_"+
g.maps[v]+"_texture";g.prototype.render=function(q,c,p,u,z,A){this.renderer=q;this.current_camera=p;this.mode==g.FORWARD?this.renderForward(c,p,z,A):this.mode==g.DEFERRED&&this.renderDeferred(c,p,A)};g.prototype.fillGlobalUniforms=function(q){var c=this.getBRDFIntegratorTexture();c&&c.bind(0);this.environment_texture?(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=
!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;this.global_uniforms.u_occlusion_gamma=this.occlusion_gamma;this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3);this.global_uniforms.u_camera_perspective=q._projection_matrix[5];this.global_uniforms.u_tonemapper=
0;this.quality?(this.global_uniforms.u_exposure=this.exposure,this.global_uniforms.u_gamma=this.gamma):(this.global_uniforms.u_exposure=Math.pow(this.exposure,1/2.2),this.global_uniforms.u_gamma=this.use_rendertexture?this.gamma:1)};g.prototype.renderForward=function(q,c,p,u){var z=Math.floor(gl.viewport_data[2]*this.resolution_factor),A=Math.floor(gl.viewport_data[3]*this.resolution_factor);z=Math.min(z,this.max_texture_size);A=Math.min(A,this.max_texture_size);this.use_rendertexture&&!p&&(this.frame_texture&&
this.frame_texture.width==z&&this.frame_texture.height==A||(this.frame_texture=new GL.Texture(z,A,{format:gl.RGBA,type:gl.HIGH_PRECISION_FORMAT,filter:gl.LINEAR}),this.final_fbo?this.final_fbo.setTextures([this.frame_texture]):this.final_fbo=new GL.FBO([this.frame_texture],null,!0),this.frame_texture.name=":frame_texture",gl.textures[this.frame_texture.name]=this.frame_texture,this.final_texture=new GL.Texture(z,A,{format:gl.RGB,filter:gl.LINEAR}),this.final_texture.name=":final_frame_texture",gl.textures[this.final_texture.name]=
this.final_texture),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);if(!this.skip_background){if(this.onRenderBackground)this.onRenderBackground(c,this);else this.renderSkybox(c);LEvent.trigger(this,"renderSkybox",this)}this.fillGlobalUniforms(c);if(this.onRenderOpaque)this.onRenderOpaque(this,this.renderer,
c);LEvent.trigger(this,"renderOpaque",this);this.renderRenderables(q,c,u);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,c);LEvent.trigger(this,"renderAlpha",this);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,c);LEvent.trigger(this,"renderGizmos",this);this.use_rendertexture&&!p&&this.renderFinalBuffer();if(this.renderer.overlay_renderables.length)for(q=this.renderer.overlay_renderables,this.global_uniforms.u_gamma=1,this.global_uniforms.u_exposure=1,gl.clear(gl.DEPTH_BUFFER_BIT),
c=0;c<q.length;++c)p=q[c],this.renderMeshWithMaterial(p.model,p.mesh,p.material,p.index_buffer_name,p.group_index,p.node.extra_uniforms,p.reverse_faces,p.skin)};g.prototype.renderRenderables=function(q,c,p){c=(this.alpha_composite_callback||this.alpha_composite_target_texture)&&GL.FBO.current;p=!0;for(var u=this.renderer.overlay_renderables,z=u.length=0;z<q.length;++z){var A=q[z];if(A.material.overlay&&this.allow_overlay)u.push(A);else{p&&c&&"BLEND"==A.material.alphaMode&&(p=!1,this.alpha_composite_target_texture&&
GL.FBO.current.color_textures[0].copyTo(this.alpha_composite_target_texture),this.alpha_composite_callback&&this.alpha_composite_callback(GL.FBO.current,this.alpha_composite_target_texture));var C=A.model;A.instances&&A.instances.length&&(C=GL.linearizeArray(A.instances,Float32Array));this.renderMeshWithMaterial(C,A.mesh,A.material,A.index_buffer_name,A.group_index,A.node.extra_uniforms,A.reverse_faces,A.skin)}}};g.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);
gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.frame_texture,null,this.frame_texture);this.fx_uniforms.u_viewportSize[0]=this.frame_texture.width;this.fx_uniforms.u_viewportSize[1]=this.frame_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.frame_texture.width;this.fx_uniforms.u_iViewportSize[1]=1/this.frame_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=this.brightness;this.fx_uniforms.u_gamma=this.gamma;this.frame_texture.copyTo(this.final_texture,
gl.shaders.fxaa_tonemapper,this.fx_uniforms);var q=null;this.postfx_shader_name&&(q=gl.shaders[this.postfx_shader_name])&&q.setUniform("u_size",[this.final_texture.width,this.final_texture.height]);this.final_texture.toViewport(q)};g.prototype.setParallaxReflectionTransform=function(q){this.parallax_reflection_matrix.set(q);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);
this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};g.prototype.resetShadersCache=function(){this.compiled_shaders={}};g.prototype.getShader=function(q,c,p){p=p||"";var u=p+":"+c,z=this.compiled_shaders[u];z||=this.compiled_shaders[u]=new Map;if(u=z.get(q))return u;if(!this.renderer.shader_files)return null;p=this.renderer.shader_files[p||"default.vs"];c=this.renderer.shader_files[c];if(!p||!c)return null;u=null;if(q){u={};for(var A in g.MACROS)q&g.MACROS[A]&&(u[A]=
"")}u=new GL.Shader(p,c,u);z.set(q,u);return u};g.prototype.renderRenderable=function(q){var c=q.model;q.instances&&q.instances.length&&(c=new Float32Array(q.instances.flat()));this.renderMeshWithMaterial(c,q.mesh,q.material,q.index_buffer_name,q.group_index,q.node?.extra_uniforms,q.reverse_faces,q.skin)};g.default_backface_color=[.1,.1,.1];g.prototype.renderMeshWithMaterial=function(q,c,p,u,z,A,C,d){var l=this.renderer;if(!p||p.constructor===String)throw"no material in renderMeshWithMaterial";if(!("BLEND"==
p.alphaMode&&0>=p.color[3])){var f=this.material_uniforms,k=this.sampler_uniforms,t=q.length/16;f.u_albedo=p.color.subarray(0,3);f.u_emissive.set(p.emissive||x.ZERO);1!=this.emissive_factor&&vec3.scale(f.u_emissive,f.u_emissive,this.emissive_factor);f.u_backface_color=p.backface_color||g.default_backface_color;var r=0;c.vertexBuffers.coords1&&(r|=g.MACROS.UVS2);c.vertexBuffers.colors&&(r|=g.MACROS.COLOR);d&&(r|=g.MACROS.SKINNING);this.parallax_reflection&&(r|=g.MACROS.PARALLAX_REFLECTION);p.primitive==
GL.POINTS&&(r|=g.MACROS.POINTS);1<t&&(r|=g.MACROS.INSTANCING);this.overwrite_shader_name?r=gl.shaders[this.overwrite_shader_name]:this.overwrite_shader_mode?r=this.getShader(r,this.overwrite_shader_mode):p.shader_name?r=gl.shaders[p.shader_name]:p.overlay?r=this.getShader(r,"overlay.fs"):"pbrMetallicRoughness"==p.model&&this.quality?(f.u_metalness=p.metallicFactor,f.u_roughness=p.roughnessFactor,f.u_metallicRough=!!p.textures.metallicRoughness,r=this.getShader(r,"pbr.fs")):r=this.getShader(r,"nopbr.fs");
if(r){f.u_alpha=p.opacity;f.u_alpha_cutoff=0;f.u_normalFactor=null!=p.normalmapFactor?p.normalmapFactor:1;f.u_displacement_factor=null!=p.displacementFactor?p.displacementFactor:1;p.uv_transform?this.texture_matrix.set(p.uv_transform):mat3.identity(this.texture_matrix);for(var n=2,B=f.u_maps_info,H=0;H<g.maps.length;++H){var I=g.maps[H];B[H]=-1;if(I=p.textures[I]){var D=null;I.constructor===Object?D=I.texture:I.constructor===String&&(D=I,I=null);if(D){var K=g.maps_sampler[H];if(!r||r.samplers[K]){var M=
gl.textures[D];M||(l.autoload_assets&&-1!=D.indexOf(".")&&l.loadTexture(D,l.default_texture_settings),M=gl.textures.white);D=16>this.max_textures?n++:H+2;k[K]=M.bind(D);B[H]=I&&null!=I.uv_channel?Math.clamp(I.uv_channel,0,3):0}}}}C||gl.frontFace(GL.CCW);l.enableItemFlags(p);C&&gl.frontFace(GL.CW);"BLEND"==p.alphaMode?(gl.enable(gl.BLEND),p.additive||"ADD"==p.blendMode?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):"MULTIPLY"==p.blendMode?gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,
gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1),f.u_alpha_cutoff=0):"MASK"==p.alphaMode?f.u_alpha_cutoff=p.alphaCutoff:gl.disable(gl.BLEND);if(d){if(d.constructor===x.Skeleton)this.bones=d.computeFinalBoneMatrices(this.bones,c),r.setUniform("u_bones",this.bones);else if(d._bone_matrices)r.setUniform("u_bones",d._bone_matrices);else return;d.joints&&(d.skip_model=!0)}1==t&&l._uniforms.u_model.set(q);d&&d.skip_model&&mat4.identity(l._uniforms.u_model);r.uniforms(l._uniforms);r.uniforms(this.global_uniforms);
r.uniforms(camera._uniforms);r.uniforms(p.uniforms);r.uniforms(f);r.uniforms(k);A&&r.uniforms(A);p.primitive==GL.POINTS&&r.setUniform("u_pointSize",p.point_size||-1);A=null;null!=z&&c.info&&c.info.groups&&c.info.groups[z]&&(A=c.info.groups[z]);z=this._instancing_uniforms;z.u_model=q;p.flags.preAlpha&&(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),1<t?r.drawInstanced(c,void 0===p.primitive?gl.TRIANGLES:p.primitive,u,z):A?r.drawRange(c,p.primitive,A.start,A.length,u):r.draw(c,p.primitive,u),gl.colorMask(!0,
!0,!0,!0),gl.depthFunc(gl.LEQUAL),this.rendered_renderables++);1<t?A?r.drawInstanced(c,void 0===p.primitive?gl.TRIANGLES:p.primitive,u,z,A.start,A.length):r.drawInstanced(c,void 0===p.primitive?gl.TRIANGLES:p.primitive,u,z):A?r.drawRange(c,p.primitive,A.start,A.length,u):r.draw(c,p.primitive,u);this.rendered_renderables++;l.disableItemFlags(p);C&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};g.prototype.renderDeferred=function(q,c,p,u){p=this.prepareBuffers();p.fbo.bind();this.renderToGBuffers(q,
c,u);p.fbo.unbind();p.final_fbo.bind();q=this.gatherLightsFromNodes(q,u);this.renderFinalPass(p,q,c);p.final_fbo.unbind();this.applyPostFX(p)};g.prototype.prepareBuffers=function(q){q=gl.drawingBufferWidth;var c=gl.drawingBufferHeight;if(this._gbuffers&&this._gbuffers.width==q&&this._gbuffers.height==c)return this._gbuffers;this._gbuffers||(this._gbuffers={});var p=this._gbuffers;p.fbo||(p.fbo=new GL.FBO);p.final_fbo||(p.final_fbo=new GL.FBO);var u={format:GL.RGBA,minFilter:gl.NEAREST,magFilter:gl.NEAREST,
wrap:gl.CLAMP_TO_EDGE},z=new GL.Texture(q,c,u),A=new GL.Texture(q,c,u),C=new GL.Texture(q,c,u);u=new GL.Texture(q,c,u);var d=new GL.Texture(q,c,{format:GL.DEPTH_STENCIL,type:GL.UNSIGNED_INT_24_8_WEBGL}),l=new GL.Texture(q,c,{format:GL.RGB,type:gl.HIGH_PRECISION_FORMAT,magFilter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE});p.fbo.setTextures([z,A,C,u],d);p.final_fbo.setTextures([l]);p.albedo=z;p.matprop=A;p.emissive=C;p.normal=u;p.width=q;p.height=c;return p};g.prototype.renderToGBuffers=function(q,c,p){q=this.getAllRenderables(q,
p,c);gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);this.fillGlobalUniforms(c);for(c=0;c<q.length;++c)if(p=q[c],p.material.overlay&&this.allow_overlay)overlay_rcs.push(p);else{var u=p.model;p.instances&&p.instances.length&&(u=GL.linearizeArray(p.instances,Float32Array));this.renderMeshWithMaterialToGBuffers(u,p.mesh,p.material,
p.index_buffer_name,p.group_index,p.node.extra_uniforms,p.reverse_faces,p.skin)}};g.prototype.renderFinalPass=function(q,c,p){q.albedo.toViewport()};g.prototype.applyPostFX=function(q){gl.disable(GL.DEPTH_TEST);gl.disable(GL.BLEND);var c=q.width,p=q.height;gl.viewport(0,0,.5*c,.5*p);q.albedo.toViewport();gl.viewport(.5*c,0,.5*c,.5*p);q.matprop.toViewport();gl.viewport(0,.5*p,.5*c,.5*p);q.emissive.toViewport();gl.viewport(.5*c,.5*p,.5*c,.5*p);q.normal.toViewport();gl.viewport(0,0,c,p)};g.prototype.gatherLightsFromNodes=
function(q,c){};g.prototype.renderMeshWithMaterialToGBuffers=function(q,c,p,u,z,A,C,d){var l=this.renderer,f=l._camera;if(!p||p.constructor===String)throw"no material in renderMeshWithMaterial";if("BLEND"!=p.alphaMode){var k=this.material_uniforms,t=this.sampler_uniforms,r=q.length/16;k.u_albedo=p.color.subarray(0,3);k.u_emissive.set(p.emissive||x.ZERO);1!=this.emissive_factor&&vec3.scale(k.u_emissive,k.u_emissive,this.emissive_factor);k.u_backface_color=p.backface_color||g.default_backface_color;
var n=0;c.vertexBuffers.coords1&&(n|=g.MACROS.UVS2);c.vertexBuffers.colors&&(n|=g.MACROS.COLOR);d&&(n|=g.MACROS.SKINNING);p.primitive==GL.POINTS&&(n|=g.MACROS.POINTS);1<r&&(n|=g.MACROS.INSTANCING);if(n=this.getShader(n,"gbuffer.fs")){k.u_alpha=p.opacity;k.u_alpha_cutoff=0;k.u_normalFactor=null!=p.normalmapFactor?p.normalmapFactor:1;k.u_displacement_factor=null!=p.displacementFactor?p.displacementFactor:1;p.uv_transform?this.texture_matrix.set(p.uv_transform):mat3.identity(this.texture_matrix);for(var B=
2,H=k.u_maps_info,I=0;I<g.maps.length;++I){var D=g.maps[I];H[I]=-1;if(D=p.textures[D]){var K=null;D.constructor===Object?K=D.texture:D.constructor===String&&(K=D,D=null);if(K){var M=g.maps_sampler[I];if(!n||n.samplers[M]){var E=gl.textures[K];E||(l.autoload_assets&&-1!=K.indexOf(".")&&l.loadTexture(K,l.default_texture_settings),E=gl.textures.white);K=16>this.max_textures?B++:I+2;t[M]=E.bind(K);H[I]=D&&null!=D.uv_channel?Math.clamp(D.uv_channel,0,3):0}}}}C||gl.frontFace(GL.CCW);l.enableItemFlags(p);
C&&gl.frontFace(GL.CW);"MASK"==p.alphaMode&&(k.u_alpha_cutoff=p.alphaCutoff);if(d){if(d.constructor===x.Skeleton)this.bones=d.computeFinalBoneMatrices(this.bones,c),n.setUniform("u_bones",this.bones);else if(d._bone_matrices)n.setUniform("u_bones",d._bone_matrices);else return;d.joints&&(d.skip_model=!0)}1==r&&l._uniforms.u_model.set(q);d&&d.skip_model&&mat4.identity(l._uniforms.u_model);n.uniforms(l._uniforms);n.uniforms(this.global_uniforms);n.uniforms(f._uniforms);n.uniforms(p.uniforms);n.uniforms(k);
n.uniforms(t);A&&n.uniforms(A);p.primitive==GL.POINTS&&n.setUniform("u_pointSize",p.point_size||-1);A=null;null!=z&&c.info&&c.info.groups&&c.info.groups[z]&&(A=c.info.groups[z]);z=this._instancing_uniforms;z.u_model=q;1<r?A?n.drawInstanced(c,void 0===p.primitive?gl.TRIANGLES:p.primitive,u,z,A.start,A.length):n.drawInstanced(c,void 0===p.primitive?gl.TRIANGLES:p.primitive,u,z):A?n.drawRange(c,p.primitive,A.start,A.length,u):n.draw(c,p.primitive,u);this.rendered_renderables++;l.disableItemFlags(p);
C&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};g.prototype.renderSkybox=function(q){if((!this.onRenderSkybox||!this.onRenderSkybox(this,q))&&this.environment_texture&&this.render_skybox){var c=gl.meshes.cube,p=gl.shaders[this.overwrite_shader_name||"skybox"];if(p){var u=this.skybox_texture||this.environment_texture;if(u&&u.texture_type===GL.TEXTURE_CUBE_MAP){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var z=this.renderer._model_matrix;mat4.identity(z);
mat4.translate(z,z,q.position);mat4.scale(z,z,[10,10,10]);this.renderer.setModelMatrix(z);p.uniforms(this.renderer._uniforms);p.uniforms(q._uniforms);p.uniforms({u_color_texture:u.bind(1),u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD});p.draw(c,GL.TRIANGLES)}}}};g.prototype.loadEnvironment=function(q,c,p){var u=this,z=gl.textures[q];z?(p?u.skybox_texture=z:(z.shs&&(u.environment_sh_coeffs=z.shs),u.environment_texture=z),c&&c(z)):HDRE.load(q,function(A){var C=
A.toTexture(!0);C&&(gl.textures[q]=C,p?u.skybox_texture=C:(C.shs=A.shs?A.shs:null,u.environment_texture=C,C.shs&&(u.environment_sh_coeffs=C.shs)));c&&c(C)})};g.prototype.captureEnvironment=function(q,c,p){p=p||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(p,p,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));var u=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,
q,c);this.use_rendertexture=u;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);this.environment_texture||(this.environment_texture=new GL.Texture(p,p,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};g.prototype.getBRDFIntegratorTexture=function(q){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var c=
gl.shaders.brdf_integrator;if(c){var p=gl.textures.brdf_integrator=new GL.Texture(128,128,{type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});if(q)return fetch(q).then(function(z){return z.arrayBuffer()}).then(function(z){p.uploadData(new Float32Array(z),{no_flip:!0})}),p;var u=gl.textures.hammersley_sample_texture;u||=this.createHammersleySampleTexture();p.drawTo(function(z){u&&u.bind(0);c.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return p}};
g.prototype.createHammersleySampleTexture=function(q){q=q||8192;for(var c=3*q,p=new Float32Array(c),u=0;u<c;u+=3){var z=2*Math.radical_inverse(u)*Math.PI;p[u]=Math.cos(z);p[u+1]=Math.sin(z);p[u+2]=0}q=new GL.Texture(q,1,{pixel_data:p,type:GL.FLOAT,format:GL.RGB});return gl.textures.hammersley_sample_texture=q};g.prototype.setClippingPlane=function(q,c){q?this.global_uniforms.u_clipping_plane.set([c[0],c[1],c[2],vec3.dot(q,c)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};g.prototype.startGPUQuery=
function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var q=gl.extensions.EXT_disjoint_timer_query;this._waiting_gpu_query||(void 0===this._useQueryTimestamps&&(this._useQueryTimestamps=!1,0<q.getQueryEXT(q.TIMESTAMP_EXT,q.QUERY_COUNTER_BITS_EXT)&&(this._useQueryTimestamps=!0)),gl.getParameter(q.GPU_DISJOINT_EXT),this._useQueryTimestamps?(this._start_gpu_query=q.createQueryEXT(),this._end_gpu_query=q.createQueryEXT(),q.queryCounterEXT(this._start_gpu_query,q.TIMESTAMP_EXT)):
(this._timeElapsed_gpu_query=q.createQueryEXT(),q.beginQueryEXT(q.TIME_ELAPSED_EXT,this._timeElapsed_gpu_query)))}};g.prototype.endGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled&&!this._waiting_gpu_query){var q=gl.extensions.EXT_disjoint_timer_query;this._useQueryTimestamps?q.queryCounterEXT(this._end_gpu_query,q.TIMESTAMP_EXT):q.endQueryEXT(q.TIME_ELAPSED_EXT);this._waiting_gpu_query=!0}};g.prototype.resolveQueries=function(){if(gl.extensions.EXT_disjoint_timer_query&&
this.timer_queries_enabled){var q=gl.extensions.EXT_disjoint_timer_query,c=this._start_gpu_query,p=this._end_gpu_query,u=this._timeElapsed_gpu_query,z=this._useQueryTimestamps;if(c||p||u){var A=gl.getParameter(q.GPU_DISJOINT_EXT),C;if(!A&&(C=z?q.getQueryObjectEXT(p,q.QUERY_RESULT_AVAILABLE_EXT):q.getQueryObjectEXT(u,q.QUERY_RESULT_AVAILABLE_EXT))){if(z){var d=q.getQueryObjectEXT(c,q.QUERY_RESULT_EXT);d=q.getQueryObjectEXT(p,q.QUERY_RESULT_EXT)-d}else d=q.getQueryObjectEXT(u,q.QUERY_RESULT_EXT);this.frame_time=
1E-6*d}if(C||A)z?(q.deleteQueryEXT(c),q.deleteQueryEXT(p),this._end_gpu_query=this._start_gpu_query=null):(q.deleteQueryEXT(u),this._timeElapsed_gpu_query=null),this._waiting_gpu_query=!1}return this.frame_time}};Math.radical_inverse=function(q){for(var c=0,p=.5;q;p*=.5,q>>=1)q&1&&(c+=p);return c};x.PBRPipeline=g})(this);
(function(v){class g{static $jscomp$static$init$m289530114$3$DEFAULT_SHADOWMAP_RESOLUTION(){return 2048}constructor(){this.area=this.intensity=1;this._color=vec3.fromValues(.9,.9,.9);this._position=vec3.fromValues(10,20,5);this._target=vec3.create();this._vector=vec3.create();this.camera=new RD.Camera;this._castShadows=!1;this.shadowmap={texture:null,resolution:2048,bias:1E-5,uniforms:{u_shadowmap_matrix:this.camera._viewprojection_matrix,u_shadowmap_texture:4,u_shadowbias:1E-5}};this.uniforms={u_light_position:this._position,
u_light_color:vec3.create(),u_light_vector:this._vector};this.flags={skip_shadows:!1}}set color(x){this._color.set(x)}get color(){return this._color}set castShadows(x){x?this.enableShadows():this.disableShadows()}get castShadows(){return this._castShadows}updateData(){vec3.sub(this._vector,this._target,this._position);vec3.normalize(this._vector,this._vector)}setUniforms(x){this.shadowmap.uniforms.u_shadowbias=this.shadowmap.bias;this.uniforms.u_light_color.set(this._color);vec3.scale(this.uniforms.u_light_color,
this.uniforms.u_light_color,this.intensity);if(x.constructor===GL.Shader)x.uniforms(this.uniforms),this._castShadows&&(x.uniforms(this.shadowmap.uniforms),this.shadowmap.texture.bind(this.shadowmap.uniforms.u_shadowmap_texture));else{for(var q in this.uniforms)x[q]=this.uniforms[q];if(this._castShadows)for(q in this.shadowmap.uniforms)x[q]=this.shadowmap.uniforms[q]}}lookAt(x,q,c){this._position.set(x);this._target.set(q);this.camera.lookAt(x,q,c);this.updateData()}setView(x,q,c){this.area=x;this.camera.orthographic(x,
q,c,1);this.updateData()}followCamera(x,q){var c=q||5;q=vec3.scaleAndAdd(vec3.create(),x.target,this._vector,-q);this.lookAt(q,x.target,x.up);this.camera.orthographic(c,.01,3*c,1);this.camera.updateMatrices()}enableShadows(){this._castShadows=!0;var x=this.shadowmap.resolution||g.DEFAULT_SHADOWMAP_RESOLUTION;this.shadowmap.texture&&this.shadowmap.texture.width==x||(this.shadowmap.texture=new GL.Texture(x,x,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadowmap.fbo=new GL.FBO(null,
this.shadowmap.texture))}disableShadows(){this._castShadows=!1;this.shadowmap.texture=null;this.shadowmap.fbo=null}generateShadowmap(x,q,c){if(this.castShadows){if(!this.shadowmap.fbo)throw"no shadowmap fbo";this.camera.view_texel_grid=[this.shadowmap.resolution,this.shadowmap.resolution];x.generating_shadowmap=!0;this.shadowmap.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);x.shader_overwrite="flat";if(q.constructor===Array)for(var p=0;p<q.length;++p)x.render(q[p],this.camera,null,c||255);else x.render(q,
this.camera,null,c||255);x.shader_overwrite=null;this.shadowmap.fbo.unbind();x.generating_shadowmap=!1;this.shadowmap.texture.bind(4);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR)}}static $jscomp$static$init$m289530114$4$shadow_shader_function(){return"uniform mat4 u_shadowmap_matrix;\n\tuniform sampler2D u_shadowmap_texture;\n\t\n\tfloat testShadowmap( vec3 pos )\n\t{\n\t\tconst float bias = 0.004;\n\t\tvec4 proj = u_shadowmap_matrix * vec4(pos, 1.0);\n\t\tvec2 sample = (proj.xy / proj.w) * vec2(0.5) + vec2(0.5);\n\t\tif(sample.x >= 0.0 && sample.x <= 1.0 && sample.y >= 0.0 && sample.y <= 1.0 )\n\t\t{\n\t\t\tfloat depth = texture2D( u_shadowmap_texture, sample ).x;\n\t\t\tif( depth > 0.0 && depth < 1.0 && depth <= ( ((proj.z-bias) / proj.w) * 0.5 + 0.5) )\n\t\t\t\treturn 0.0;\n\t\t}\n\t\treturn 1.0;\n\t}"}}
g.DEFAULT_SHADOWMAP_RESOLUTION=g.$jscomp$static$init$m289530114$3$DEFAULT_SHADOWMAP_RESOLUTION();g.shadow_shader_function=g.$jscomp$static$init$m289530114$4$shadow_shader_function();RD.Light=g})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(v){function g(){this.name="";this.tracks=[];this.duration=10}function x(){this.enabled=!0;this.target_property=this.target_node="";this.type=A.SCALAR;this.data=[];this.packed_data=!1;this._target=null}function q(d,l,f){return d*(1-f)+l*f}function c(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function p(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function u(){this.skeleton=
new c;this.duration=0;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this._loading=!1;this.bones_map=new Uint8Array(u.MAX_BONES);this.keyframes=null}function z(d,l,f){for(var k="",t=0;t<f;++t){var r=d.getUint8(l+t);if(!r)break;k+=String.fromCharCode(r)}return k}var A=v.RD=v.RD||{};A.Animations={};g.prototype.addTrack=function(d,l){if(l)for(l=0;l<this.tracks.length;++l)if(this.tracks[l].target_node==d.target_node){this.tracks.splice(l+1,0,d);return}this.tracks.push(d)};g.prototype.applyAnimation=
function(d,l,f,k){for(var t=0;t<this.tracks.length;++t){var r=this.tracks[t];!1!==r.enabled&&(k&&(l%=this.duration),r.applyTrack(d,l,f))}};g.prototype.toJSON=function(){for(var d={name:this.name,duration:this.duration,tracks:[]},l=0;l<this.tracks.length;++l)d.tracks.push(this.tracks[l].toJSON());return d};g.prototype.fromJSON=function(d){this.name=d.name;this.duration=d.duration;for(var l=this.tracks.length=0;l<d.tracks.length;++l){var f=new A.Animation.Track;f.fromJSON(d.tracks[l]);this.tracks.push(f)}return d};
g.prototype.findNearestLeft=function(d){for(var l=0,f=0;f<this.tracks.length;++f){var k=this.tracks[f],t=k.findTimeIndex(d);-1!=t&&(k=k.data[t],k>l&&(l=k))}return l};g.prototype.findNearestRight=function(d){for(var l=this.duration,f=0;f<this.tracks.length;++f){var k=this.tracks[f],t=k.findTimeIndex(d);-1!=t&&(k=k.data[t+1],null!=k&&k<l&&(l=k))}return l};A.Animation=g;g.Track=x;Object.defineProperty(x.prototype,"value_size",{set:function(d){throw"cannot be set, use type instead";},get:function(){return A.TYPES_SIZE[this.type]}});
x.prototype.addKeyframe=function(d,l,f){1<this.value_size&&(l=new Float32Array(l));for(var k=0;k<this.data.length;++k)if(!(this.data[k][0]<d))return this.data[k][0]!=d||f?this.data.splice(k,0,[d,l]):this.data[k][1]=l,k;this.data.push([d,l]);return this.data.length-1};x.prototype.getKeyframe=function(d){if(0>d||d>=this.data.length)return console.warn("keyframe index out of bounds"),null;var l=A.TYPES_SIZE[this.type];return this.packed_data?(d*=1+l,d>this.data.length-l?null:[this.data[d],this.data.subarray(d+
1,d+l+1)]):this.data[d]};x.prototype.findTimeIndex=function(d){var l=this.data;if(!l||0==l.length)return-1;var f=A.TYPES_SIZE[this.type];if(this.packed_data){f+=1;var k=l.length/f,t=0,r=0,n=k;if(0==k)return-1;if(1==k)return 0;if(l[(n-1)*f]<d)return n-1;for(;n>=t;){r=.5*(n+t)|0;k=l[r*f];if(k==d)break;if(t==n-1)return t;k<d?t=r:n=r}return r}k=l.length;r=t=0;n=k;if(0==k)return-1;if(1==k)return 0;if(l[n-1][0]<d)return n-1;for(;n>=t;){r=.5*(n+t)|0;k=l[r][0];if(k==d)break;if(t==n-1)return t;k<d?t=r:n=r}return r};
x.prototype.getSample=function(d,l,f){if(this.data&&0!==this.data.length)return this.packed_data?this.getSamplePacked(d,l,f):this.getSampleUnpacked(d,l,f)};x.prototype.getSampleUnpacked=function(d,l,f){d=Math.clamp(d,0,this.data[this.data.length-1][0]);var k=this.findTimeIndex(d);-1===k&&(k=0);var t=k,r=k+1,n=this.data;var B=A.TYPES_SIZE[this.type];if(!l||0==B||1==n.length||r==n.length||0==t&&this.data[0][0]>d)return this.data[k][1];t=n[t];r=n[r];d=(r[0]-d)/(r[0]-t[0]);1<B&&(f=f||this._result,f&&
f.length==B||(f=this._result=new Float32Array(B)));if(l===A.LINEAR)return 1==B?t[1]*d+r[1]*(1-d):A.interpolateLinear(t[1],r[1],d,f,this.type,B,this);if(l===A.CUBIC){l=0<k?n[k-1]:t;k=k<n.length-2?n[k+2]:r;if(1===B)return A.EvaluateHermiteSpline(t[1],r[1],l[1],k[1],1-d);f=A.EvaluateHermiteSplineVector(t[1],r[1],l[1],k[1],1-d,f);this.type==A.QUAT?(quat.slerp(f,r[1],t[1],d),quat.normalize(f,f)):this.type==A.TRANS10&&(B=f.subarray(3,7),t=t[1].subarray(3,7),r=r[1].subarray(3,7),quat.slerp(B,r,t,d),quat.normalize(B,
B));return f}return null};x.prototype.getSamplePacked=function(d,l,f){if(!this.data.length)return null;var k=A.TYPES_SIZE[this.type];d=Math.clamp(d,0,this.data[this.data.length-k-1]);var t=this.findTimeIndex(d);-1==t&&(t=0);var r=k+1,n=t,B=t+1,H=this.data,I=H.length/r;if(!l||1==I||B==I||0==n&&this.data[0]>d)return this.getKeyframe(t)[1];1<k&&(f=f||this._result,f&&f.length==k||(f=this._result=new Float32Array(k)));var D=H.subarray(n*r,(n+1)*r);n=H.subarray(B*r,(B+1)*r);d=(n[0]-d)/(n[0]-D[0]);if(l===
A.LINEAR){if(1==k)return D[1]*d+n[1]*(1-d);r=D.subarray(1,k+1);n=n.subarray(1,k+1);return A.interpolateLinear(r,n,d,f,this.type,k,this)}if(l===A.CUBIC){if(0===k)return D[1];l=0<t?H.subarray((t-1)*r,t*r):D;B=B<I-1?H.subarray((B+1)*r,(B+2)*r):n;if(1===k)return A.EvaluateHermiteSpline(D[1],n[1],l[1],B[1],1-d);k=D.subarray(1,r);n=n.subarray(1,r);f=A.EvaluateHermiteSplineVector(k,n,l.subarray(1,r),B.subarray(1,r),1-d,f);this.type==A.QUAT?(quat.slerp(f,n,k,d),quat.normalize(f,f)):this.type==A.TRANS10&&
(r=f.subarray(3,7),k=k.subarray(3,7),n=n.subarray(3,7),quat.slerp(r,n,k,d),quat.normalize(r,r));return f}return null};x.prototype.applyTrack=function(d,l,f){if(d){l=this.getSample(l,f);if(d.constructor===A.SceneNode){if(d=d.name==this.target_node?d:d.findNodeByName(this.target_node))this._node=d,d[this.target_property]=l}else d.constructor===A.Skeleton&&(d=d.getBone(this.target_node))&&this.type==A.MAT4&&(this._bone=d,d.model.set(l));return l}};x.prototype.toJSON=function(){return{enabled:this.enabled,
target_node:this.target_node,target_property:this.target_property,type:this.type,data:this.data.constructor==Array?this.data.concat():typedArrayToArray(this.data),packed_data:this.packed_data}};x.prototype.fromJSON=function(d){this.enabled=d.enabled;this.target_node=d.target_node;this.target_property=d.target_property;if(d.property){var l=d.property.indexOf("/");this.target_node=d.property.substr(0,l);this.target_property=d.property.substr(l+1)}null!=d.type&&(this.type=d.type.constructor===String?
A.TYPES[d.type.toUpperCase()]||0:d.type);d.packed_data||d.data.constructor===Float32Array?(this.packed_data=!0,this.data=new Float32Array(d.data)):(this.packed_data=!1,this.data=d.data.concat())};A.interpolateLinear=function(d,l,f,k,t,r,n){if(1==r)return d*f+l*(1-f);k=k||n._result;k&&k.length==r||(k=n._result=new Float32Array(r));switch(t){case A.QUAT:quat.slerp(k,l,d,f);quat.normalize(k,k);break;case A.TRANS10:for(t=0;3>t;t++)k[t]=d[t]*f+l[t]*(1-f);for(t=7;10>t;t++)k[t]=d[t]*f+l[t]*(1-f);d=d.subarray(3,
7);l=l.subarray(3,7);r=k.subarray(3,7);quat.slerp(r,l,d,f);quat.normalize(r,r);break;default:for(t=0;t<r;t++)k[t]=d[t]*f+l[t]*(1-f)}return k};A.EvaluateHermiteSpline=function(d,l,f,k,t){var r=t*t,n=r*t;return(2*n-3*r+1)*d+(-2*n+3*r)*l+(n-2*r+t)*(l-f)+(n-r)*(k-d)};A.EvaluateHermiteSplineVector=function(d,l,f,k,t,r){r=r||new Float32Array(r.length);var n=t*t,B=n*t,H=2*B-3*n+1,I=-2*B+3*n;t=B-2*n+t;n=B-n;B=0;for(var D=r.length;B<D;++B)r[B]=H*d[B]+I*l[B]+t*(l[B]-f[B])+n*(k[B]-d[B]);return r};Math.lerp||
(Math.lerp=q);A.Skeleton=c;c.Bone=p;p.prototype.toJSON=function(){return{name:this.name,model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};p.prototype.fromJSON=function(d){this.name=d.name;this.model.set(d.model);this.parent=d.parent;this.layer=d.layer;this.num_children=0;this.index=null!=d.index?d.index:-1;d.children&&(this.children.set(d.children),this.num_children=d.children.constructor===
Array?d.children.length:d.num_children)};c.prototype.applyTransformToBones=function(d,l){(d=this.getBone(d))&&mat4.multiply(d.model,d.model,l)};c.prototype.getBone=function(d){return this.bones[this.bones_by_name.get(d)]};c.identity=mat4.create();c.prototype.getBoneMatrix=function(d,l,f){var k=-1;d.constructor===String?k=this.bones_by_name.get(d):d.constructor===Number&&(k=d);if(void 0===k)return c.identity;if(!l)return this.bones[k].model;d=this.global_bone_matrices[k];if(!f)return d;f=this.bones[k];
d.set(f.model);for(f=this.bones[f.parent];f;)d=mat4.mul(d,f.model,d),f=this.bones[f.parent];return d};c.prototype.updateBoneGlobalMatrix=function(d){var l=this.bones[d];if(l)for(d=this.global_bone_matrices[d],d.set(l.model),l=this.bones[l.parent];l;)d=mat4.mul(d,l.model,d),l=this.bones[l.parent]};c.prototype.updateChildBonesGlobalMatrices=function(d){if(d=d.constructor==c.Bone?d:this.getBone(d)){var l=this.global_bone_matrices[d.index];mat4.mul(l,this.global_bone_matrices[d.parent],l);for(d=0;d<this.num_children;++d)this.updateChildBonesGlobalMatrices(this.children[d])}};
c.prototype.importSkeleton=function(d,l){function f(r){var n=new p;n.name=r.name||r.id;r.model?n.model.set(r.model):r.transform&&r.getLocalMatrix&&n.model.set(r.getLocalMatrix());n.index=t.length;t.push(n);k.bones_by_name.set(n.name,n.index);k.global_bone_matrices.push(mat4.create());if(r.children&&r.children.length){n.num_children=r.children.length;for(var B=0;B<r.children.length;++B){var H=f(r.children[B]);n.children[B]=H.index;H.parent=n.index}}return n}var k=this;t?this.bones.length=0:this.bones=
[];var t=this.bones;f(d);l&&mat4.mul(t[0].model,l,t[0].model);this.updateGlobalMatrices()};c.temp_mat4=mat4.create();c.temp_mat43=c.temp_mat4.subarray(0,12);c.prototype.computeFinalBoneMatrices=function(d,l,f){if(!this.bones.length||!l||!l.bones)return d||[];this.updateGlobalMatrices();var k=f?12*l.bones.length:16*l.bones.length;d&&d.length==k||(d=new Float32Array(k));if(f){var t=c.temp_mat43;for(f=0;f<l.bones.length;++f)k=l.bones[f],mat4.multiply(temp_mat4,this.getBoneMatrix(k[0],!0),k[1]),l.bind_matrix&&
mat4.multiply(temp_mat4,temp_mat4,l.bind_matrix),mat4.transpose(temp_mat4,temp_mat4),d.set(t,12*f)}else for(f=0;f<l.bones.length;++f)k=l.bones[f],t=d.subarray(16*f,16*f+16),mat4.multiply(t,this.getBoneMatrix(k[0],!0),k[1]),l.bind_matrix&&mat4.multiply(t,t,l.bind_matrix);return d};c.prototype.computeFinalBoneMatricesAsArray=function(d,l,f){if(!this.bones.length||!l||!l.bones)return d||[];this.updateGlobalMatrices();d=d||[];d.length=l.bones.length;for(var k=0;k<l.bones.length;++k){var t=l.bones[k];
d[k]||(d[k]=mat4.create());var r=d[k];mat4.multiply(r,this.getBoneMatrix(t[0],!0),t[1]);l.bind_matrix&&mat4.multiply(r,r,l.bind_matrix);f&&mat4.multiply(r,f,r)}return d};c.prototype.updateGlobalMatrices=function(){var d=this.bones;if(d.length){var l=this.bones.length;this.global_bone_matrices[0].set(d[0].model);for(var f=1;f<l;++f){var k=d[f];mat4.multiply(this.global_bone_matrices[f],this.global_bone_matrices[k.parent],k.model)}}};c.prototype.assignLayer=function(d,l){};c.temp_vec3=vec3.create();
c.temp_vec4=vec4.create();c.temp_mat4=mat4.create();c.prototype.applyTracksAnimation=function(d,l){for(var f=c.temp_vec3,k=c.temp_vec4,t=c.temp_mat4,r=0;r<d.tracks.length;++r){var n=d.tracks[r],B=this.bones_by_name.get(n.target_node);null!=B&&(B=this.bones[B],"model"==n.target_property||"matrix"==n.target_property?n.getSample(l,A.LINEAR,B.model):"position"==n.target_property?(n.getSample(l,A.LINEAR,f),mat4.setTranslation(B.model,f)):"rotation"==n.target_property?(n.getSample(l,A.LINEAR,k),mat4.fromQuat(t,
k),mat4.getTranslation(f,B.model),mat4.setTranslation(t,f),B.model.set(t)):"scaling"==n.target_property&&(n.getSample(l,A.LINEAR,f),mat4.scale(B.model,B.model,f)))}};c.prototype.getVertices=function(d,l){if(!this.bones.length)return null;l||this.updateGlobalMatrices();l=6*(this.bones.length-1);this._vertices&&this._vertices.length==l||(this._vertices=new Float32Array(l));l=this._vertices;for(var f=0,k=1;k<this.bones.length;++k){var t=this.global_bone_matrices[this.bones[k].parent],r=this.global_bone_matrices[k],
n=l.subarray(f,f+3),B=l.subarray(f+3,f+6);mat4.getTranslation(n,r);mat4.getTranslation(B,t);d&&(vec3.transformMat4(n,n,d),vec3.transformMat4(B,B,d));f+=6}return l};c.prototype.resizeBones=function(d){if(this.bones.length!=d)if(this.bones.length>d)this.bones.length=d,this.global_bone_matrices.length=d;else{var l=this.bones.length;for(this.bones.length=d;l<d;++l)this.bones[l]=new p,this.global_bone_matrices[l]=mat4.create()}};c.prototype.copyFrom=function(d){this.resizeBones(d.bones.length);for(var l=
0;l<d.bones.length;++l)this.bones[l].copyFrom(d.bones[l]),this.global_bone_matrices[l].set(d.global_bone_matrices[l]);this.bones_by_name=new Map(d.bones_by_name)};c.prototype.toJSON=function(){for(var d={bones:[],bone_names:{}},l=0;l<this.bones.length;++l)d.bones.push(this.bones[l].toJSON());return d};c.prototype.fromJSON=function(d){this.resizeBones(d.bones.length);d.bones_by_name?this.bones_by_name=new Map(d.bones_by_name):this.bones_by_name.clear();for(var l=0;l<d.bones.length;++l){var f=this.bones[l];
f.copyFrom(d.bones[l]);f.index=l;d.global_bone_matrices?this.global_bone_matrices[l].set(d.global_bone_matrices[l]):this.bones_by_name.set(this.bones[l].name,l)}};var C=vec3.create();c.blend=function(d,l,f,k,t,r){if(d.bones.length!=l.bones.length)console.error("skeleton must contain the same number of bones");else{f=Math.clamp(f,0,1);if(255==t){if(0==f){if(k==d)return;k.copyFrom(d);return}if(1==f){k.copyFrom(l);return}}if(k!=d){k.resizeBones(d.bones.length);for(t=0;t<k.bones.length;++t){var n=k.bones[t];
n||=k.bones[t]=new c.Bone;n.copyFrom(d.bones[t])}k.bones_by_name=new Map(d.bones_by_name)}for(t=0;t<k.bones.length;++t){var B=k.bones[t],H=d.bones[t],I=l.bones[t];for(n=0;16>n;++n)B.model[n]=Math.lerp(H.model[n],I.model[n],f);if(!r)for(B=B.model,n=0;3>n;++n)C[0]=B[0+n],C[1]=B[4+n],C[2]=B[8+n],vec3.normalize(C,C),B[0+n]=C[0],B[4+n]=C[1],B[8+n]=C[2]}}};c.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
c.vertex_shader_code=`
	precision highp float;
	attribute vec3 a_vertex;
	attribute vec3 a_normal;
	attribute vec2 a_coord;
	
	varying vec3 v_wPosition;
	varying vec3 v_wNormal;
	varying vec2 v_coord;
	
	uniform mat4 u_viewprojection;
	uniform mat4 u_model;
	uniform mat4 u_normal_matrix;
	
	${c.shader_code} //
	
	void main() {
		v_wPosition = a_vertex;
		v_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;
		v_coord = a_coord;
		
		computeSkinning( v_wPosition, v_wNormal);
		
		v_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;
		
		gl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );
	}
`;u.MAX_BONES=64;u.VERSION=4;A.SkeletalAnimation=u;u.prototype.load=function(d,l){var f=this,k=-1!=d.toLowerCase().indexOf(".abin");this._loading=!0;return HttpRequest(d,null,function(t){f._loading=!1;t.constructor===String?f.fromData(t):f.fromBinary(t);l&&l(f)},null,{binary:k})};u.prototype.assignTime=function(d,l,f,k){if(this.duration&&this.samples_per_second){l||void 0===l?(d%=this.duration,0>d&&(d=this.duration+d)):d=Math.clamp(d,0,this.duration-1/this.samples_per_second);void 0===f&&(f=!0);d*=
this.samples_per_second;k=Math.floor(d);var t=(k+1)%this.num_keyframes;k%=this.num_keyframes;d-=Math.floor(d);var r=this.num_animated_bones;l=16*r;k*=l;t*=l;var n=this.skeleton,B=this.keyframes,H=this.bones_map;r=Math.min(r,H.length);for(var I=0;I<r;++I){var D=n.bones[H[I]];if(!D)throw"bone not found in skeleton";l=16*I;if(f)for(var K=0;16>K;++K)D.model[K]=q(B[k+l+K],B[t+l+K],d);else D.model.set(B.subarray(k+l,k+l+16))}}};u.prototype.resize=function(d,l){this.num_keyframes=Math.floor(d);this.num_animated_bones=
l;this.keyframes=new Float32Array(d*l*16)};u.prototype.assignPoseToKeyframe=function(d,l){if(l>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";l=l*this.num_animated_bones*16;for(var f=0;f<this.num_animated_bones;++f){var k=d.bones[this.bones_map[f]];null!=k&&this.keyframes.set(k.model,l+16*f)}};u.prototype.fromData=function(d){var l=d.split("\n"),f=l[0].split(",");this.duration=Number(f[0]);this.samples_per_second=Number(f[1]);this.num_keyframes=
Number(f[2]);this._datasize=d.length;this.skeleton.resizeBones(Number(f[3]));d=0;for(f=1;f<l.length;++f){var k=l[f],t=k[0];k=k.substr(1).split(",");if("B"==t){var r=Number(k[0]),n=this.skeleton.bones[r];if(!n)throw"bone not found in skeleton";n.name=k[1];n.parent=Number(k[2]);for(t=0;16>t;++t)n.model[t]=Number(k[3+t]);-1!=n.parent&&(k=this.skeleton.bones[n.parent],16<=k.num_children?console.warn("too many child bones, max is 16"):k.children[k.num_children++]=r);this.skeleton.bones_by_name.set(n.name,
r)}else if("@"==t){this.num_animated_bones=Number(k[0]);for(t=0;t<this.num_animated_bones;++t)this.bones_map[t]=Number(k[t+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==t){r=d*this.num_animated_bones*16;t=0;for(n=16*this.num_animated_bones;t<n;++t)this.keyframes[r+t]=Number(k[t+1]);d++}else break}this.assignTime(0,!1,!1)};u.prototype.toData=function(){var d=[];d.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());
for(var l=this.skeleton.bones,f=0;f<l.length;++f){var k=l[f];d.push("B"+f+","+k.name+","+k.parent+","+typedArrayToArray(k.model))}l=[];for(f=0;f<this.num_animated_bones;++f)l.push(this.bones_map[f]);d.push("@"+l.length+","+l.join(","));l=1/this.samples_per_second;for(f=0;f<this.num_keyframes;++f){k=16*f*this.num_animated_bones;k=this.keyframes.subarray(k,k+16*this.num_animated_bones);for(var t=0;t<k.length;++t)1E-6>Math.abs(k[t])&&(k[t]=0);d.push("K"+(f*l).toFixed(3)+","+k.join(","))}return d.join("\n")};
u.prototype.fromPose=function(d){this.samples_per_second=15;this.duration=1/this.samples_per_second;this.skeleton.copyFrom(d);for(var l=d.bones.length,f=0;f<d.bones.length;++f)this.bones_map[f]=f;this.resize(1,l);this.assignPoseToKeyframe(this.skeleton,0)};u.prototype.fromTracksAnimation=function(d,l,f,k){this.duration=l.duration;this.samples_per_second=f;this.skeleton.copyFrom(d);for(var t=0,r={},n=0;n<l.tracks.length;++n){var B=l.tracks[n],H=d.bones_by_name.get(B.target_node);null!=H&&(this.bones_map[t]=
H,null==r[B.target_node]&&(r[B.target_node]=B.target_node,t++))}t>d.bones.length&&console.warn("more animated bones than bones?");this.resize(Math.floor(l.duration*f),t);for(n=0;n<this.num_keyframes;++n)this.skeleton.applyTracksAnimation(l,1/f*n),k&&mat4.mul(this.skeleton.bones[0].model,k,this.skeleton.bones[0].model),this.assignPoseToKeyframe(this.skeleton,n)};u.prototype.toBinary=function(){for(var d=this.skeleton.bones.length,l=new Uint8Array(176+115*d+this.num_keyframes*this.num_animated_bones*
64),f=new DataView(l.buffer),k=0;4>k;++k)f.setUint8(k,"ABIN".charCodeAt(k));f.setInt32(4,u.VERSION,!0);f.setInt32(8,172,!0);f.setFloat32(12,this.duration,!0);f.setFloat32(16,this.samples_per_second,!0);f.setUint32(20,this.num_animated_bones,!0);f.setUint32(24,this.num_keyframes,!0);f.setUint32(28,d,!0);for(k=0;k<this.bones_map.length;++k)f.setUint8(32+k,this.bones_map[k]);var t=176;for(k=0;k<this.skeleton.bones.length;++k){var r=this.skeleton.bones[k];f.setInt8(t,r.parent);for(var n=0;32>n;++n)f.setInt8(t+
n+1,r.name.charCodeAt(n)||0);for(n=0;16>n;++n)f.setFloat32(t+32+1+4*n,r.model[n],!0);f.setUint8(t+32+1+64,r.layer);f.setUint8(t+32+2+64,r.num_children);for(n=0;16>n;++n)f.setInt8(t+32+3+64+n,r.children[n]);t+=115}t=176+115*d;d=new Uint8Array(this.keyframes.buffer);l.set(d,t);return l};u.prototype.fromBinary=function(d){d.constructor===ArrayBuffer&&(d=new Uint8Array(d));var l=new DataView(d.buffer);if("ABIN"!=z(l,0,4))return console.error("not an animation file"),!1;var f=l.getInt32(4,!0);l.getInt32(8,
!0);this.duration=l.getFloat32(12,!0);this.samples_per_second=3==f?l.getInt32(16,!0):l.getFloat32(16,!0);this.num_animated_bones=l.getUint32(20,!0);this.num_keyframes=l.getUint32(24,!0);f=l.getUint32(28,!0);for(var k=0;k<this.bones_map.length;++k)this.bones_map[k]=l.getUint8(32+k);var t=176;this.skeleton.resizeBones(f);this.skeleton.bones_by_name.clear();for(k=0;k<f;++k){var r=this.skeleton.bones[k];r.parent=l.getInt8(t);r.name=z(l,t+1,32);for(var n=0;16>n;++n)r.model[n]=l.getFloat32(t+32+1+4*n,!0);
r.layer=l.getUint8(t+32+1+64);r.num_children=l.getUint8(t+32+2+64);for(n=0;16>n;++n)r.children[n]=l.getInt8(t+32+3+64+n);t+=115;this.skeleton.bones_by_name.set(r.name,k)}t=176+115*f;l=new Uint8Array(d.subarray(t,t+this.num_keyframes*this.num_animated_bones*64));this.keyframes=new Float32Array(l.buffer);this._datasize=d.length};A.SceneNode&&(A.SceneNode.prototype.assignSkeleton=function(d){var l=gl.meshes[this.mesh];l&&(this.bones=d.computeFinalBoneMatrices(this.bones,l),this.uniforms.u_bones=this.bones)},
A.SceneNode.prototype.assignAnimation=function(d){this.assignSkeleton(d.skeleton)},A.SceneNode.prototype.updateSkinningBones=function(d){d=d||this;this.skin&&this.mesh&&A.collectBones(d,this.skin,gl.meshes[this.mesh]);if(this.children&&this.children.length)for(var l=0;l<this.children.length;++l)this.children[l].updateSkinningBones(d)});A.collectBones=function(d,l,f){function k(D,K,M){if(!K||!D)return M;if(D==K)return mat4.mul(M,D.getGlobalMatrix(),M),M;mat4.mul(M,D.matrix,M);return k(D._parent,K,
M)}if(f&&f.bones){var t=f.bones.length;l._bone_matrices||(l._bone_matrices=new Float32Array(16*t));t=l._bone_matrices;mat4.create();(l=d.findNodeByName(l.skeleton_root))||l==d;for(var r=mat4.create(),n=0;n<f.bones.length;++n){var B=f.bones[n],H=t.subarray(16*n,16*n+16),I=d.findNodeByName(B[0]);I&&(mat4.identity(r),k(I,l,r),mat4.multiply(H,r,B[1]),f.bind_matrix&&mat4.multiply(H,H,f.bind_matrix))}return t}};A.AnimatedCharacterFromScene=function(d,l,f){var k=[],t=[],r=f=null;r=d.constructor===A.SceneNode?
d:d.root;for(var n=0;n<r.children.length;++n){var B=r.children[n];if(B.name&&("Armature"==B.name||-1!=B.name.indexOf("_Hips"))||"JOINT"==B.type||B.is_joint)f=B;else if(B.mesh){k.push(B);var H=null;gl.meshes[B.mesh]?H=gl.meshes[B.mesh]:d.meshes&&d.meshes[B.mesh]&&(H=GL.Mesh.load(d.meshes[B.mesh]));H&&t.push({mesh:H})}}!f&&r.findNodesByFilter&&(n=r.findNodesByFilter(function(I){return I.skin}))&&n.length&&(f=n[0]);!k.length&&r.findNodesByFilter&&(k=r.findNodesByFilter(function(I){return I.mesh}));k.length&&
k[0].skin&&k[0].skin.skeleton_root&&(f=r.findNodeByName(k[0].skin.skeleton_root));if(!f)throw"this scene doesnt contain an animated character";n=r=null;k.length&&(B=null,1<k.length?(n=GL.Mesh.mergeMeshes(t),B=k[0].mesh,n.filename=B):(B=k[0].mesh,gl.meshes[B]?(n=gl.meshes[B],n.filename=B):d.meshes&&(n=GL.Mesh.fromBinary(d.meshes[B]),n.filename=B)),gl.meshes[B]=n,t=null,k[0].material?t=k[0].material:k[0].primitives&&k[0].primitives.length&&(t=k[0].primitives[0].material),A.Materials[t]?r=A.Materials[t]:
d.materials&&(r=d.materials[t]));k=new A.Skeleton;k.importSkeleton(f,null);t=null;d.root&&d.root.animation?t=d.root.animation:d.animations&&(t=d.animations[0].id);f=null;null!=t&&(A.Animations[t]?f=A.Animations[t]:d.resources&&(d=d.resources[t],f=new A.Animation,f.fromJSON(d.takes["default"])));f?(d=new A.SkeletalAnimation,d.fromTracksAnimation(k,f,30,null)):(console.warn("no animation in scene, creating pose one"),d=new A.SkeletalAnimation,d.fromPose(k));d.filename=l;return{mesh:n?n.filename:null,
material:r,skeleton:k,skeletal_anim:d,tracks_anim:f}};g.prototype.serialize=g.prototype.toJSON;g.prototype.configure=g.prototype.fromJSON;x.prototype.serialize=x.prototype.toJSON;x.prototype.configure=x.prototype.fromJSON;c.prototype.serialize=c.prototype.toJSON;c.prototype.configure=c.prototype.fromJSON;p.prototype.serialize=p.prototype.toJSON;p.prototype.configure=p.prototype.fromJSON;p.prototype.copyFrom=p.prototype.configure})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
