'use strict';(function(p){function a(c){if(this.constructor!==b.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();c&&this.configure(c)}function g(c){this.type=b.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=0.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=
mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();this.uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection_matrix:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(0.1,1E3)};c&&this.configure(c);this.updateMatrices()}function m(){this._root=new b.SceneNode;
this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}function h(c){this._color=vec4.fromValues(1,1,1,1);this.shader_name=null;this.uniforms={u_color:this._color};this.textures={};this.primitive=GL.TRIANGLES;this.blend_mode=b.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};c&&this.configure(c)}function f(c,z){z=z||{};var b=this.gl=this.context=c;if(!b||!b.enable)throw"litegl GL context not found.";c!=
p.gl&&b.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this.layers_affect_children=this.reverse_normals=this.sort_by_distance=!1;this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._texture_matrix=mat3.create();this._color=vec4.fromValues(1,1,1,1);this._viewprojection2D_matrix=mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,
u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_color:this._color,u_texture_matrix:this._texture_matrix};this.global_uniforms_containers=[this._uniforms];p.gl=this.gl;this.canvas=b.canvas;this.assets_folder=z.assets_folder||"";this.autoload_assets=void 0!==z.autoload_assets?z.autoload_assets:!0;this.default_texture_settings={wrap:b.REPEAT,minFilter:b.LINEAR_MIPMAP_LINEAR,magFilter:b.LINEAR};this.default_cubemap_settings={minFilter:b.LINEAR_MIPMAP_LINEAR,
magFilter:b.LINEAR,is_cross:1};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:b.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:b.NEAREST,pixel_data:new Uint8Array([255,
255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.createShaders();z.shaders_file&&this.loadShaders(z.shaders_file,null,z.shaders_macros)}function q(c,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();c&&this.origin.set(c);b&&this.direction.set(b)}function k(c){this._ctor();c&&this.configure(c)}function s(c){this._ctor();c&&this.configure(c)}function e(c){a.prototype._ctor.call(this,
c);this._ctor();c&&this.configure(c)}function d(c,b){return vec3.dot(c,b)+c[3]}function l(c,b,a){var B=c[3],e=Math.abs(a[0]*c[0]),d=Math.abs(a[1]*c[1]);a=Math.abs(a[2]*c[2]);e=e+d+a;c=vec3.dot(c,b)+B;return c<=-e?x:c<=e?F:C}var b=p.RD={version:0.5};b.ZERO=vec3.fromValues(0,0,0);b.ONE=vec3.fromValues(1,1,1);b.RIGHT=vec3.fromValues(1,0,0);b.LEFT=vec3.fromValues(-1,0,0);b.UP=vec3.fromValues(0,1,0);b.DOWN=vec3.fromValues(0,-1,0);b.FRONT=vec3.fromValues(0,0,-1);b.BACK=vec3.fromValues(0,0,1);b.FRONT2D=
vec2.fromValues(0,1);b.WHITE=vec3.fromValues(1,1,1);b.BLACK=vec3.fromValues(0,0,0);b.IDENTITY=mat4.create();b.ONES4=vec4.fromValues(1,1,1,1);b.CENTER=0;b.TOP_LEFT=1;b.TOP_RIGHT=2;b.BOTTOM_LEFT=3;b.BOTTOM_RIGHT=4;b.TOP_CENTER=5;b.BOTTOM_CENTER=6;b.PRIORITY_BACKGROUND=30;b.PRIORITY_OPAQUE=20;b.PRIORITY_ALPHA=10;b.PRIORITY_HUD=0;b.BLEND_NONE=0;b.BLEND_ALPHA=1;b.BLEND_ADD=2;b.BLEND_MULTIPLY=3;b.NO_BILLBOARD=0;b.BILLBOARD_SPHERIC=1;b.BILLBOARD_PARALLEL_SPHERIC=2;b.BILLBOARD_CYLINDRIC=3;b.BILLBOARD_PARALLEL_CYLINDRIC=
4;b.UNKNOWN=0;b.NUMBER=b.SCALAR=1;b.VEC2=2;b.VEC3=3;b.VEC4=4;b.QUAT=5;b.MAT3=6;b.TRANS10=7;b.MAT4=8;b.TYPES={NUMBER:b.NUMBER,SCALAR:b.NUMBER,VEC2:b.VEC2,VEC3:b.VEC3,VEC4:b.VEC4,QUAT:b.QUAT,MAT3:b.MAT3,TRANS10:b.TRANS10,MAT4:b.MAT4};b.TYPES_SIZE=[0,1,2,3,4,4,9,10,16];b.NO_INTERPOLATION=0;b.LINEAR=1;b.CUBIC=2;var n=b.DEG2RAD=0.0174532925;b.RAD2DEG=57.295779578552306;b.Materials={};b.Images={};b.setup=function(c){c=c||{};if(b.configuration)throw"already called setup";b.configuration=c};var r=0;"undefined"==
typeof extendClass&&(p.extendClass=function(c,b){for(var a in b)c.hasOwnProperty(a)||(c[a]=b[a]);if(b.prototype){var B=Object.getOwnPropertyNames(b.prototype);for(a=0;a<B.length;++a){var e=B[a];c.prototype.hasOwnProperty(e)||(b.prototype.__lookupGetter__(e)?c.prototype.__defineGetter__(e,b.prototype.__lookupGetter__(e)):c.prototype[e]=b.prototype[e],b.prototype.__lookupSetter__(e)&&c.prototype.__defineSetter__(e,b.prototype.__lookupSetter__(e)))}}c.hasOwnProperty("superclass")||Object.defineProperty(c,
"superclass",{get:function(){return b},enumerable:!1})});var u=mat4.create(),D=mat3.create(),v=mat4.create(),w=vec2.create(),t=vec3.create(),y=vec3.create();vec4.create();var A=quat.create();b.SceneNode=a;a.prototype._ctor=function(){this._uid=r++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);quat.identity(this._rotation);this._scale.set(b.ONE);this._local_matrix=
mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.render_priority=b.PRIORITY_OPAQUE;this.layers=3;this._instances=this.draw_range=null;this.primitive=GL.TRIANGLES;this.primitives=[];this.mesh=null;this.textures={};this.shader=null;this.blend_mode=b.BLEND_NONE;this._color=vec4.fromValues(1,1,1,1);this.material=null;this.onRender||(this.onRender=null);this.onShaderUniforms||(this.onShaderUniforms=null);this.flags={visible:!0,collides:!0};this.children=
[];this._uniforms={u_color:this._color,u_color_texture:0}};a.ctor=a.prototype._ctor;a.prototype.clone=function(c){var b=new this.constructor,a;for(a in this)if("_"!=a[0])if("children"==a){if(c)for(var B=0;B<this.children.length;++B)b.addChild(this.children[B].clone(c))}else B=this[a],void 0!==B&&(null===B?b[a]=null:B.constructor===Object?b[a]=GL.cloneObject(B):B.constructor===Array?b[a]=B.concat():b[a]!==B&&(b[a]=B));return b};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},
set:function(c){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=c},enumerable:!0});Object.defineProperty(a.prototype,"uniforms",{get:function(){return this._uniforms},set:function(c){GL.cloneObject(c,this._uniforms);this._uniforms.u_color=this._color},enumerable:!0});Object.defineProperty(a.prototype,"position",{get:function(){return this._position},set:function(c){this._position.set(c);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,
"x",{get:function(){return this._position[0]},set:function(c){this._position[0]=c;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"y",{get:function(){return this._position[1]},set:function(c){this._position[1]=c;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"z",{get:function(){return this._position[2]},set:function(c){this._position[2]=c;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rotation},
set:function(c){this._rotation.set(c);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"scaling",{get:function(){return this._scale},set:function(c){c.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=c:this._scale.set(c);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"transform",{get:function(){return this._transform},set:function(c){this._transform.set(c);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,
"matrix",{get:function(){return this._model_matrix},set:function(c){this.fromMatrix(c)},enumerable:!1});Object.defineProperty(a.prototype,"pivot",{get:function(){return this._pivot},set:function(c){this._must_update_matrix=!0;c?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(c),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(a.prototype,"color",{get:function(){return this._color},set:function(c){this._color.set(c)},enumerable:!0});Object.defineProperty(a.prototype,
"opacity",{get:function(){return this._color[3]},set:function(c){this._color[3]=c},enumerable:!0});Object.defineProperty(a.prototype,"visible",{get:function(){return this.flags.visible},set:function(c){this.flags.visible=c},enumerable:!0});Object.defineProperty(a.prototype,"texture",{get:function(){return this.textures.color},set:function(c){this.textures.color=c},enumerable:!1});Object.defineProperty(a.prototype,"scene",{get:function(){return this._scene},set:function(c){throw"cannot set scene, you must use addChild in its parent node";
},enumerable:!1});Object.defineProperty(a.prototype,"parentNode",{get:function(){return this._parent},set:function(c){throw"Cannot set parentNode of SceneNode";},enumerable:!1});a.prototype.addChild=function(c,b){function a(c,b){if(c._scene&&c._scene!=b){var z=c._scene._nodes.indexOf(c);-1!=z&&c._scene._nodes.splice(z,1);c.id&&c._scene._nodes_by_id[c.id]==c&&delete c._scene._nodes_by_id[c.id]}if(c._scene=b)b._nodes.push(c),c.id&&b&&(b._nodes_by_id[c.id]=c);if(c.children)for(var z=0,e=c.children.length;z<
e;z++){var d=c.children[z];d._scene!=b&&a(d,b)}}if(c._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";c._parent=this;b&&c.fromMatrix(c._global_matrix);this.children||(this.children=[]);this.children.push(c);this._scene!=c._scene&&a(c,this._scene)};a.prototype.removeChild=function(c,b){function a(c){if(c._scene){c.id&&c._scene._nodes_by_id[c.id]==c&&delete c._scene._nodes_by_id[c.id];var b=c._scene._nodes.indexOf(c);-1!=b&&c._scene._nodes.splice(b,1)}c._scene=null;
for(var b=0,z=c.children.length;b<z;b++)a(c.children[b])}if(c._parent!=this)throw"removeChild: Not its children";if(this.children){var e=this.children.indexOf(c);if(-1==e)throw"removeChild: impossible, should be children";this.children.splice(e,1);c._parent=null;b&&c.fromMatrix(c._global_matrix);a(c)}};a.prototype.removeAllChildren=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])};a.prototype.clear=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-
1])};a.prototype.setChildIndex=function(c,b){if(this.children){var a=this.children.indexOf(c);-1!=a&&(this.children.splice(a,1),this.children.splice(b,0,c))}};a.prototype.getAllChildren=function(c){c=c||[];if(!this.children)return c;for(var b=0,a=this.children.length;b<a;b++){var e=this.children[b];c.push(e);e.getAllChildren(c)}return c};a.prototype.getVisibleChildren=function(c,b,a){c=c||[];void 0===b&&(b=255);if(!this.children||!1===this.flags.visible)return c;for(var e=0,d=this.children.length;e<
d;e++){var n=this.children[e],f=n.layers&b;if(!a||f)f&&c.push(n),n.getVisibleChildren(c,b)}return c};a.prototype.serialize=function(){var c={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(c.name=this.name);this.primitives&&this.primitives.length&&(c.primitives=this.primitives.concat());this.mesh&&(c.mesh=this.mesh);this.material&&
(c.material=this.material);null!=this.submesh&&(c.submesh=this.submesh);this.flags&&(c.flags=JSON.parse(JSON.stringify(this.flags)));this.extra&&(c.extra=this.extra);this.animation&&(c.animation=this.animation);if(this.onSerialize)this.onSerialize(c);if(this.children)for(var b=0,a=this.children.length;b<a;b++)c.children.push(this.children[b].serialize());return c};a.prototype.configure=function(c){var z=null,a;for(a in c){switch(a){case "children":continue;case "uniforms":for(var e in c.uniforms)this.uniforms[e]=
c.uniforms[e];continue;case "texture":this[a]=c[a];continue;case "flags":for(e in c.flags)this.flags[e]=c.flags[e];continue;case "scale":case "scaling":this.scale(c[a]);continue;case "tiling":isNumber(c[a])?this.setTextureTiling(c[a],c[a]):this.setTextureTiling(c[a][0],c[a][1],c[a][2],c[a][3]);continue;case "name":case "mesh":case "primitives":case "material":case "ref":case "draw_range":case "submesh":case "animation":this[a]=c[a];continue;case "parent":z=c[a]}var d=this[a];void 0!==d&&(d&&d.constructor===
Float32Array?d.set(c[a]):this[a]=c[a])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(c.children)for(this.removeAllChildren(),a=0;a<c.children.length;++a)e=new b.SceneNode,e.configure(c.children[a]),this.addChild(e);z&&(this.parentNode?console.error("This node already has a parent"):z.addChild(this))};a.prototype.setMesh=function(c){c?"string"==typeof c?this.mesh=c:this._mesh=c:this.mesh=null};a.prototype.setTexture=function(c,b){b?"string"==typeof b&&(this.textures[c]=b):this.textures[c]=
null};a.prototype.resetTransform=function(){this._position.set(b.ZERO);quat.identity(this._rotation);this._scale.set(b.ONE);this._must_update_matrix=!0};a.prototype.translate=function(c,b){b?this.getLocalVector(c,t):t.set(c);vec3.add(this._position,this._position,t);this._must_update_matrix=!0};a.prototype.move=a.prototype.translate;a.prototype.moveLocal=function(c){this.translate(c,!0)};a.prototype.rotate=function(c,b,a){quat.setAxisAngle(A,b,c);a?quat.multiply(this._rotation,A,this._rotation):quat.multiply(this._rotation,
this._rotation,A);this._must_update_matrix=!0};a.prototype.rotateQuat=function(c,b){b?quat.multiply(this._rotation,c,this._rotation):quat.multiply(this._rotation,this._rotation,c);this._must_update_matrix=!0};a.prototype.scale=function(c){c.constructor===Number?(t[0]=t[1]=t[2]=c,vec3.mul(this._scale,this._scale,t)):vec3.mul(this._scale,this._scale,c);this._must_update_matrix=!0};a.prototype.lookAt=function(c,b,a,e){this.position=c;this.orientTo(b,e,a)};a.prototype.orientTo=function(c,z,a){var e=this.getGlobalPosition();
c=vec3.sub(vec3.create(),e,c);a=a||b.UP;vec3.normalize(c,c);z&&vec3.scale(c,c,-1);z=mat3.create();a=vec3.cross(vec3.create(),a,c);vec3.normalize(a,a);e=vec3.cross(vec3.create(),c,a);vec3.normalize(e,e);mat3.setColumn(z,a,0);mat3.setColumn(z,e,1);mat3.setColumn(z,c,2);quat.fromMat3(this._rotation,z);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0};a.prototype.setPivot=function(c){this.pivot=c};a.prototype.setTextureTiling=function(c,b,a,e){this.texture_matrix||(this.texture_matrix=
mat3.create(),this._uniforms.u_texture_matrix=this.texture_matrix);a=a||0;e=e||0;this.shader||(this.shader="texture_transform");mat3.identity(this.texture_matrix);mat3.translate(this.texture_matrix,this.texture_matrix,[a,e]);mat3.scale(this.texture_matrix,this.texture_matrix,[c,b])};a.prototype.getLocalMatrix=function(c){this._must_update_matrix&&this.updateLocalMatrix();return c?(c.set(this._global_matrix),c):this._local_matrix};a.prototype.getGlobalMatrix=function(c){this.updateGlobalMatrix();return c?
(c.set(this._global_matrix),c):this._global_matrix};a.prototype.getGlobalRotation=function(c){c=c||vec4.create();quat.identity(c);for(var b=this,a=this._scene?this._scene._root:null;b!=a;)quat.multiply(c,b._rotation,c),b=b._parent;return c};a.prototype.updateLocalMatrix=function(){var c=this._local_matrix;this._must_update_matrix=!1;mat4.identity(c);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(c[12]=this._pivot[0],c[13]=this._pivot[1],c[14]=this._pivot[2]),mat4.translate(c,c,this._position),
mat4.fromQuat(v,this._rotation),mat4.multiply(c,c,v),mat4.scale(c,c,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(c,c,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))};a.prototype.updateGlobalMatrix=function(c,b){var a=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?(a=c?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):
mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,b)};a.prototype.updateMatrices=function(c){this.updateLocalMatrix();this.updateGlobalMatrix(c)};a.prototype.fromMatrix=function(c,a){if(a&&this._parent&&this._parent._transform){mat4.copy(this._global_matrix,c);var e=this._parent.getGlobalMatrix();mat4.invert(e,e);c=mat4.multiply(this._local_matrix,e,c)}e=mat4.clone(c);
mat4.multiplyVec3(this._position,e,[0,0,0]);var d=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(d,e,b.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(d,e,b.UP));this._scale[2]=vec3.length(mat4.rotateVec3(d,e,b.BACK));e=mat3.fromMat4(D,e);quat.fromMat3AndQuat(this._rotation,e);c!=this._local_matrix&&mat4.copy(this._local_matrix,c);this._must_update_matrix=!1};a.prototype.getLocalPoint=function(c,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,
c,this._local_matrix)};a.prototype.getLocalVector=function(c,b){b=b||vec3.create();return vec3.transformQuat(b,c,this._rotation)};a.prototype.getGlobalPosition=function(c,a){c=c||vec3.create();if(a)return vec3.transformMat4(c,b.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return c.set(this._position),c;var e=this.getGlobalMatrix();return vec3.transformMat4(c,b.ZERO,e)};a.prototype.getGlobalPoint=function(c,b){b=b||vec3.create();var a=this.getGlobalMatrix();return vec3.transformMat4(b,
c,a)};a.prototype.localToGlobal=a.prototype.getGlobalPoint;a.prototype.globalToLocal=function(c,b){b=b||vec3.create();var a=this.getGlobalMatrix();mat4.invert(v,a);return vec3.transformMat4(b,c,v)};a.prototype.getGlobalVector=function(c,b){b=b||vec3.create();var a=this.getGlobalRotation(A);return vec3.transformQuat(b,c,a)};a.prototype.getDistanceTo=function(c){var b=this.getGlobalMatrix();return vec3.distance(c,b.subarray(12,15))};a.prototype.findNode=function(c){for(var b=0,a=this.children.length;b<
a;b++){var e=this.children[b];if(e.id==c||(e=e.findNode(c)))return e}return null};a.prototype.findNodeByName=function(c){if(null==c)return null;for(var b=0,a=this.children.length;b<a;b++){var e=this.children[b];if(e.name==c||(e=e.findNodeByName(c)))return e}return null};a.prototype.findNodesByFilter=function(c,b,a){void 0===b&&(b=255);a=a||[];for(var e=0,d=this.children.length;e<d;e++){var n=this.children[e];n.layer&b&&(c&&!c(n)||a.push(n),n.findNodesByFilter(c,b,a))}return a};a.prototype.propagate=
function(c,b){for(var a=0,e=this.children.length;a<e;a++){var d=this.children[a];d&&(d[c]&&d[c].apply(d,b),d.children&&d.children.length&&d.propagate(c,b))}};a.prototype.loadTextConfig=function(c,a){GL.request(c,null,function(c){c=b.parseTextConfig(c);a&&a(c)},alert)};a.prototype.destroy=function(c){!this.scene||c?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)};a.prototype.updateBoundingBox=function(c){var b=this._global_matrix,a=gl.meshes[this.mesh],e=null;a&&(e=a.getBoundingBox(),
this.bounding_box||(this.bounding_box=BBox.create()),e=BBox.transformMat4(this.bounding_box,e,b));if(c||!this.children||0==this.children.length)return e;for(c=0;c<this.children.length;++c)if(b=this.children[c].updateBoundingBox())e||(e=this.bounding_box=BBox.create()),BBox.merge(e,e,b);return e};a.prototype.testRay=function(){var c=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();mat4.create();return function(b,a,e,d,n,f){e=void 0===e?Number.MAX_VALUE:e;void 0===
d&&(d=255);a=a||vec3.create();void 0!==m._ray_tested_objects&&m._ray_tested_objects++;var l=null,k=null;if(!1===this.flags.visible)return null;this.layers&d&&!this.flags.ignore_collisions&&this.mesh&&(k=this.testRayWithMesh(b,c,e,d,n,f));k&&(f=vec3.distance(b.origin,c),null==e||f<e)&&(e=f,a.set(c),l=this);if(!this.children||!this.children.length)return l;for(var k=vec3.create(),g=0;g<this.children.length;++g){var r=this.children[g].testRay(b,k,e,d,n);r&&(f=vec3.distance(b.origin,k),f<e&&(e=f,a.set(k),
l=r))}return l}}();a.prototype.testRayWithMesh=function(){var c=vec3.create(),a=vec3.create(),e=vec3.create(),d=mat4.create();return function(n,f,l,k,g,r){if(!this.mesh)return!1;var u=gl.meshes[this.mesh];if(!u||!1===u.ready)return!1;var h=null==this.submesh?-1:this.submesh,m=this._global_matrix;mat4.invert(d,m);vec3.transformMat4(c,n.origin,d);vec3.add(e,n.origin,n.direction);vec3.transformMat4(e,e,d);vec3.sub(a,e,c);vec3.normalize(a,a);if(this.primitives&&r)for(r=0;r<this.primitives.length;++r)b.testRayMesh(n,
c,a,u,this.primitives[r].index,f,l,k,g,!0);else return b.testRayMesh(n,c,a,m,u,h,f,l,k,g,this.flags.two_sided)}}();a.prototype.setRangeFromSubmesh=function(c){if(void 0!==c&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(c.constructor===String){for(var a=0;a<b.info.groups.length;++a)if(b.info.groups[a].name==c){c=a;break}if(a===b.info.groups.length)return!1}if(c=b.info.groups[c])this.draw_range[0]=c.start,this.draw_range[1]=c.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=
null};a.prototype.findNodesInSphere=function(c,b,a,e){void 0===a&&(a=255);e=e||[];for(var d=0;d<this.children.length;++d){var n=this.children[d];n.layers&a&&(n.getGlobalPosition(t,!0),vec3.distance(t,c)<=b&&e.push(n));n.children.length&&n.findNodesInSphere(c,b,a,e)}return e};b.Camera=g;g.PERSPECTIVE=1;g.ORTHOGRAPHIC=2;g.prototype.configure=function(c){null!=c.type&&(this.type=c.type);c.position&&this._position.set(c.position);c.target&&this._target.set(c.target);c.up&&this._up.set(c.up);c.near&&(this.near=
c.near);c.far&&(this.far=c.far);c.fov&&(this.fov=c.fov);c.aspect&&(this.aspect=c.aspect)};g.prototype.serialize=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};Object.defineProperty(g.prototype,"position",{get:function(){return this._position},set:function(c){this._position.set(c);this._must_update_matrix=!0},enumerable:!1});
Object.defineProperty(g.prototype,"target",{get:function(){return this._target},set:function(c){this._target.set(c);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"up",{get:function(){return this._up},set:function(c){this._up.set(c);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"fov",{get:function(){return this._fov},set:function(c){this._fov=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"aspect",{get:function(){return this._aspect},
set:function(c){this._aspect=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(c){this._frustum_size=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"near",{get:function(){return this._near},set:function(c){this._near=this.uniforms.u_camera_planes[0]=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"far",{get:function(){return this._far},
set:function(c){this._far=this.uniforms.u_camera_planes[1]=c;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(c){this._view_matrix.set(c);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(g.prototype,"projection_matrix",{get:function(){return this._projection_matrix},set:function(c){this._projection_matrix.set(c);mat4.multiply(this._viewprojection_matrix,
this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(g.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(c){this._viewprojection_matrix.set(c)},enumerable:!1});g.prototype.perspective=function(c,b,a,e){this.type=g.PERSPECTIVE;this._fov=c;this._aspect=b;this._near=a;this._far=e;this._must_update_matrix=!0};g.prototype.orthographic=function(c,b,a,e){this.type=g.ORTHOGRAPHIC;this._frustum_size=c;1<arguments.lenth&&(this._near=
b,this._far=a,this._aspect=e||1);this._must_update_matrix=!0};g.prototype.lookAt=function(c,b,a){vec3.copy(this._position,c);vec3.copy(this._target,b);vec3.copy(this._up,a);this._must_update_matrix=!0};g.prototype.updateMatrices=function(c){if(this._autoupdate_matrices||c)if(this.type==g.ORTHOGRAPHIC?this.frustum_size.constructor===Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&
mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*n,this._aspect,this._near,this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up),this.view_texel_grid&&this.type==
g.ORTHOGRAPHIC){c=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var a=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/c)*c;this._view_matrix[13]=Math.floor(this._view_matrix[13]/a)*a}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,
this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,b.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,b.UP);mat4.rotateVec3(this._front,this._model_matrix,b.FRONT);this.distance=vec3.distance(this._position,this._target);this.uniforms.u_camera_planes[0]=this._near;this.uniforms.u_camera_planes[1]=this._far};g.prototype.getModel=function(c){c=c||mat4.create();mat4.invert(this._model_matrix,this._view_matrix);
mat4.copy(c,this._model_matrix);return c};g.prototype.updateVectors=function(c){var a=vec3.subtract(t,this._target,this._position),a=vec3.length(a);mat4.multiplyVec3(this._position,c,b.ZERO);mat4.multiplyVec3(this._target,c,[0,0,-a]);mat4.rotateVec3(this._up,c,b.UP)};g.prototype.getLocalVector=function(c,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,c)};g.prototype.getLocalPoint=function(c,b){this._must_update_matrix&&this.updateMatrices();
return vec3.transformMat4(b||vec3.create(),c,this._model_matrix)};g.prototype.localToGlobal=g.prototype.getLocalPoint;g.prototype.getFront=function(c){c=c||vec3.create();vec3.subtract(c,this._target,this._position);vec3.normalize(c,c);return c};g.prototype.move=function(c,b){void 0!==b&&(vec3.scale(t,c,b),c=t);vec3.add(this._target,this._target,c);vec3.add(this._position,this._position,c);this._must_update_matrix=!0};g.prototype.moveLocal=function(c,b){this._must_update_matrix&&this.updateMatrices();
var a=mat4.rotateVec3(t,this._model_matrix,c);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};g.prototype.rotate=function(c,b){var a=quat.setAxisAngle(A,b,c),e=vec3.subtract(t,this._target,this._position);vec3.transformQuat(e,e,a);vec3.add(this._target,this._position,e);this._must_update_matrix=!0};g.prototype.rotateLocal=function(c,b){this._must_update_matrix&&this.updateMatrices();var a=mat4.rotateVec3(y,
this._model_matrix,b),a=quat.setAxisAngle(A,a,c),e=vec3.subtract(t,this._target,this._position);vec3.transformQuat(e,e,a);vec3.add(this._target,this._position,e);this._must_update_matrix=!0};g.prototype.orbit=function(c,b,a,e){if(!b)throw"RD: orbit axis missing";a=a||this._target;e&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(y,this._model_matrix,b));c=quat.setAxisAngle(A,b,c);b=vec3.subtract(t,this._position,this._target);vec3.transformQuat(b,b,c);vec3.add(this._position,a,
b);this._must_update_matrix=!0};g.prototype.orbitDistanceFactor=function(c,b){b=b||this._target;var a=vec3.subtract(t,this._position,b);vec3.scale(a,a,c);vec3.add(this._position,b,a);this._must_update_matrix=!0};g.prototype.project=function(c,b,a){a=a||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(a,this._viewprojection_matrix,c);a[0]=a[0]*b[2]+b[0];a[1]=a[1]*b[3]+b[1];return a};g.prototype.unproject=function(c,b,a){b=b||gl.viewport_data;this._must_update_matrix&&
this.updateMatrices();return vec3.unproject(a||vec3.create(),c,this._viewprojection_matrix,b)};g.prototype.getRay=function(c,a,e,d){if(void 0===c||void 0===a)throw"RD.Camera.getRay requires x and y parameters";e=e||gl.viewport_data;d||(d=new b.Ray);this._must_update_matrix&&this.updateMatrices();var n=d.origin;vec3.set(n,c,a,0);this.type==b.Camera.ORTHOGRAPHIC?vec3.unproject(n,n,this._viewprojection_matrix,e):vec3.copy(n,this.position);var f=d.direction;vec3.set(f,c,a,1);vec3.unproject(f,f,this._viewprojection_matrix,
e);vec3.sub(f,f,n);vec3.normalize(f,f);return d};g.prototype.getRayPlaneCollision=function(c,b,a,e,d,n){d=d||vec3.create();c=this.getRay(c,b,n);return geo.testRayPlane(c.origin,c.direction,a,e,d)?d:null};g.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};g.prototype.applyController=function(c,a,e,d){e=e||10;if(c){var n=vec3.create();if(gl.keys[g.controller_keys.forward]||d&&gl.keys.W)n[2]=-1;else if(gl.keys[g.controller_keys.back]||d&&gl.keys.S)n[2]=1;if(gl.keys[g.controller_keys.left]||
d&&gl.keys.A)n[0]=-1;else if(gl.keys[g.controller_keys.right]||d&&gl.keys.D)n[0]=1;vec3.sqrLen(n)&&this.moveLocal(n,c*e)}a&&(a.deltax&&this.rotate(-0.005*a.deltax,b.UP),a.deltay&&this.rotateLocal(-0.005*a.deltay,b.RIGHT))};g.prototype.lerp=function(c,b){vec3.lerp(this._position,this._position,c._position,b);vec3.lerp(this._target,this._target,c._target,b);vec3.lerp(this._up,this._up,c._up,b);this._fov=this._fov*(1-b)+c._fov*b;this._near=this._near*(1-b)+c._near*b;this._far=this._far*(1-b)+c._far*
b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+c._frustum_sizer*b);this._must_update_matrix=!0};g.prototype.orientMatrixToCamera=function(c){c.set(this._right,0);c.set(this._top,4);c.set(this._front,8)};g.prototype.extractPlanes=function(){function c(c){var b=a.subarray(c,c+3),b=vec3.length(b);0!==!b&&(b=1/b,a[c]*=b,a[c+1]*=b,a[c+2]*=b,a[c+3]*=b)}var b=this._viewprojection_matrix,a=this._planes_data||new Float32Array(24);a.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],
b[15]-b[12]],0);c(0);a.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);c(4);a.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);c(8);a.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);c(12);a.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);c(16);a.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);c(20);this._planes_data=a;this._frustrum_planes||(this._frustrum_planes=[a.subarray(0,4),a.subarray(4,8),a.subarray(8,12),a.subarray(12,16),a.subarray(16,20),a.subarray(20,24)])};var C=
b.CLIP_INSIDE=0,x=b.CLIP_OUTSIDE=1,F=b.CLIP_OVERLAP=2;g.prototype.testMesh=function(){if(p.BBox){var c=BBox.create(),b=c.subarray(0,3),a=c.subarray(3,6);return function(e,d){var n=e.bounding;if(!n)return C;BBox.transformMat4(c,n,d);return this.testBox(b,a)}}}();g.prototype.testBox=function(c,b){this._frustrum_planes||this.extractPlanes();var a=this._frustrum_planes,e=0,d=0,e=l(a[0],c,b);if(e==x)return x;d+=e;e=l(a[1],c,b);if(e==x)return x;d+=e;e=l(a[2],c,b);if(e==x)return x;d+=e;e=l(a[3],c,b);if(e==
x)return x;d+=e;e=l(a[4],c,b);if(e==x)return x;d+=e;e=l(a[5],c,b);return e==x?x:0==d+e?C:F};g.prototype.testSphere=function(c,b){this._frustrum_planes||this.extractPlanes();var a=this._frustrum_planes,e,n=!1;e=d(a[0],c);if(e<-b)return x;e>=-b&&e<=b&&(n=!0);e=d(a[1],c);if(e<-b)return x;e>=-b&&e<=b&&(n=!0);e=d(a[2],c);if(e<-b)return x;e>=-b&&e<=b&&(n=!0);e=d(a[3],c);if(e<-b)return x;e>=-b&&e<=b&&(n=!0);e=d(a[4],c);if(e<-b)return x;e>=-b&&e<=b&&(n=!0);e=d(a[5],c);if(e<-b)return x;e>=-b&&e<=b&&(n=!0);
return n?F:C};b.Scene=m;m.prototype.clear=function(){this._root=new b.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};m.prototype.getNodeById=function(c){return this._nodes_by_id[c]};m.prototype.findNodesInBBox=function(c,b,a){void 0===b&&(b=255);a=a||[];for(var e=0;e<this.nodes.length;++e){var d=this.nodes[e];d.bounding_box&&d.layers&b&&geo.testBBoxBBox(d.bounding_box,c)&&a.push(d)}return a};m.prototype.update=function(c){this.time+=c;this._root.propagate("update",
[c]);this.destroyPendingNodes()};m.prototype.destroyPendingNodes=function(c){if(this._to_destroy.length)for(c=null;c=this._to_destroy.pop();)c._parent&&c._parent.removeChild(c)};Object.defineProperty(m.prototype,"root",{get:function(){return this._root},set:function(c){throw"Cannot set root of scene";},enumerable:!1});m.prototype.testRay=function(c,a,e,d,n){b.Scene._ray_tested_objects=0;a||(a=c.collision_point);void 0===n&&(n=!0);return this.root.testRay(c,a,e,void 0===d?255:d,n)};b.testRayWithNodes=
function(c,a,e,d,n,f,l){b.testRayWithNodes.coll_node=null;d=null==d?Number.MAX_VALUE:d;n=void 0===n?255:n;b.Scene._ray_tested_objects=0;e||(e=c.collision_point);for(var k=vec3.create(),g=null,r=0;r<a.length;++r){var u=a[r],h=u.testRay(c,k,d,n,f);if(h){var m=vec3.distance(c.origin,k);m<d&&(d=m,e.set(k),b.testRayWithNodes.coll_node=h,g=l?h:u)}}return g};b.testRayMesh=function(c,b,a,e,d,n,f,l,k,g,r){l=null==l?Number.MAX_VALUE:l;var u=null;k=null;-1==n?(u=d.getBoundingBox(),k=d):(k=d.info.groups[n],u=
k.bounding,u||(d.computeGroupsBoundingBoxes(),u=k.bounding));if(!u)return!1;l||(l=1E7);if(!geo.testRayBBox(b,a,u,null,t))return!1;vec3.transformMat4(f,t,e);n=vec3.distance(c.origin,f);if(n>l)return!1;if(!g)return!0;k._octree||(k._octree=k==d?new GL.Octree(d):new GL.Octree(d,k.start,k.length));b=k._octree.testRay(b,a,0,l,r);if(!b)return!1;f.set(b.hit);vec3.transformMat4(f,f,e);n=vec3.distance(c.origin,f);return n>l?!1:!0};m.prototype.fromJSON=function(c){this.root.clear();this.root.configure(c)};m.prototype.toJSON=
function(c){function b(e,d){if(c){if(!c(e,d))return!1}else{if(!e.flags.no_transform){d.position=typedArrayToArray(e.position);if(0!=e.rotation[0]||0!=e.rotation[1]||0!=e.rotation[2]||1!=e.rotation[3])d.rotation=typedArrayToArray(e.rotation);if(1!=e.scaling[0]||1!=e.scaling[1]||1!=e.scaling[2])d.scaling=typedArrayToArray(e.scaling)}e.id&&(d.id=e.id);e.ref=d.ref=a++;e.mesh&&(d.mesh=e.mesh);null!=e.submesh&&(d.submesh=e.submesh);e.draw_range&&(d.draw_range=e.draw_range.concat());e.material&&(d.material=
e.material);e.shader&&(d.shader=e.shader);if(1!=e.color[0]||1!=e.color[1]||1!=e.color[2]||1!=e.color[3])d.color=typedArrayToArray(e.color);0<Object.values(e.textures).filter(function(c){return c})&&(d.shader=e.shader);e.extra&&(d.extra=e.extra);d.layers=e.layers;d.flags=e.flags}if(!e.children.length)return!0;for(var n=[],f=0;f<e.children.length;++f){var l={};b(e.children[f],l)&&n.push(l)}n.length&&(d.children=n);return!0}c&&c.constructor!==Function&&(c=null);var a=0,e={};b(this.root,e);return e};
h.default_shader_name="texture";Object.defineProperty(h.prototype,"color",{set:function(c){this._color.set(c)},get:function(){return this._color},enumerable:!0});Object.defineProperty(h.prototype,"opacity",{get:function(){return this._color[3]},set:function(c){this._color[3]=c},enumerable:!0});Object.defineProperty(h.prototype,"albedo",{set:function(c){this._color.set(c)},get:function(){return this._color},enumerable:!1});h.prototype.configure=function(c){for(var b in c)this[b]=c[b]};h.prototype.serialize=
function(){var c={flags:this.flags,textures:this.textures};c.color=typedArrayToArray(this._color);this.name&&(c.name=this.name);this.alphaMode&&(c.alphaMode=this.alphaMode);0.5!=this.alphaCutoff&&(c.alphaCutoff=this.alphaCutoff);this.model&&(c.model=this.model,c.metallicFactor=this.metallicFactor,c.roughnessFactor=this.roughnessFactor,this.emissive&&(c.emissive=typedArrayToArray(this.emissive)));return c};h.prototype.render=function(c,a,e,d,n){var f=this.shader_name;f||(f="pbrMetallicRoughness"==
this.model?"texture_albedo":c.default_shader_name||b.Material.default_shader_name);(f=gl.shaders[f])||(f=this.textures.color||this.textures.albedo?c._texture_shader:c._flat_shader);var l=0,k=null,g;for(g in this.textures){var r=this.textures[g];if(r){r.constructor===Object&&(r=r.texture);var u="u_"+g+"_texture";if(!f||f.samplers[u])k=gl.textures[r],k||(c.autoload_assets&&-1!=r.indexOf(".")&&c.loadTexture(r,c.default_texture_settings),k=gl.textures.white),this.uniforms[u]=k.bind(l++)}}c.enableItemFlags(this);
c._uniforms.u_model.set(a);f.uniforms(c._uniforms);f.uniforms(this.uniforms);a=null;null!=n&&e.info&&e.info.groups&&e.info.groups[n]&&(a=e.info.groups[n]);a?f.drawRange(e,this.primitive,a.start,a.length,d):f.draw(e,this.primitive,d);c.disableItemFlags(this);c.draw_calls+=1};b.Material=h;b.Renderer=f;Object.defineProperty(f.prototype,"color",{set:function(c){this._color.set(c)},get:function(){return this._color},enumerable:!0});f.prototype.setDataFolder=function(c){c?(this.assets_folder=c,"/"!=this.assets_folder.substr(-1)&&
(this.assets_folder+="/")):this.assets_folder=""};f.prototype.clear=function(c){c?this.gl.clearColor(c[0],c[1],c[2],3<=c.length?c[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};f._sort_by_dist_func=function(c,b){return b._distance-c._distance};f._sort_by_priority_func=function(c,b){return b.render_priority-c.render_priority};f._sort_by_priority_and_dist_func=function(c,b){var a=b.render_priority-c.render_priority;return 0!=a?a:b._distance-c._distance};f.prototype.render=
function(c,a,e,d,n,f){null==d&&(d=255);if(!c)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";a=a||c.camera;if(!a)throw"Renderer.render: camera not provided";p.gl=this.gl;this._nodes.length=0;e||c._root.getVisibleChildren(this._nodes,d,this.layers_affect_children);e=e||this._nodes;this.enableCamera(a);this.enable2DView();this._state=[];this._meshes_missing=0;this._current_scene=c;this._uniforms.u_time=
c.time;this.sort_by_distance&&e.forEach(function(c){c._distance=c.getDistanceTo(a._position)});var l=this;e=e.filter(function(c){return!c.mustRender||!1!=c.mustRender(l,a)});this.sort_by_distance&&this.sort_by_priority?e.sort(b.Renderer._sort_by_priority_and_dist_func):this.sort_by_priority?e.sort(b.Renderer._sort_by_priority_func):this.sort_by_distance&&e.sort(b.Renderer._sort_by_dist_func);if(this.onPreRender)this.onPreRender(a);c._root.preRender&&c._root.preRender(this,a);if(n=n||this.pipeline)n.render(this,
e,a,c,f);else{for(n=0;n<e.length;++n){f=e[n];f.updateGlobalMatrix(!0);if(this.onPreRenderNode)this.onPreRenderNode(f,a);f.preRender&&f.preRender(this,a)}for(n=0;n<e.length;++n)f=e[n],f.flags.was_rendered=!1,!1!==f.flags.visible&&f.layers&d&&(!this.mustRenderNode||!1!==this.mustRenderNode(f,a))&&(f.flags.was_rendered=!0,this.setModelMatrix(f._global_matrix),f.render?f.render(this,a):this.renderNode(f,a));c._root.postRender&&c._root.postRender(this,a);for(n=0;n<e.length;++n)if(f=e[n],f.postRender&&
f.postRender(this,a),this.onPostRenderNode)this.onPostRenderNode(f,a)}if(this.onPostRender)this.onPostRender(a);c.frame++;this.frame++;this._current_scene=null};f.prototype.enableCamera=function(c){this._camera=c;c.updateMatrices();c.extractPlanes();this._view_matrix.set(c._view_matrix);this._projection_matrix.set(c._projection_matrix);this._viewprojection_matrix.set(c._viewprojection_matrix);this._uniforms.u_camera_position=c.position};f.prototype.enable2DView=function(){mat4.ortho(this._viewprojection2D_matrix,
0,gl.viewport_data[2],0,gl.viewport_data[3],-1,1)};f.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};f.prototype.restoreState=function(){var c=this.state.pop(),b=this.camera=c.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=c.nodes};f.prototype.setModelMatrix=function(c){this._model_matrix.set(c);mat4.multiply(this._mvp_matrix,
this._viewprojection_matrix,c)};f.prototype.setGlobalUniforms=function(c){for(var b in c)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(c[b]):this._uniforms[b]=c[b]};var E={u_model:null};f.prototype.renderNode=function(c,a){var e=null;c._mesh?e=c._mesh:c.mesh&&(e=gl.meshes[c.mesh],e||(this._meshes_missing++,this.autoload_assets&&-1!=c.mesh.indexOf(".")&&this.loadMesh(c.mesh)));if(c.primitives&&c.primitives.length){if(e)for(var d=0;d<c.primitives.length;++d){var n=c.primitives[d];(n=
this.overwrite_material||b.Materials[n.material])&&this.renderMeshWithMaterial(c._global_matrix,e,n,"triangles",d)}}else{if(e&&(c.material||this.overwrite_material)&&(n=this.overwrite_material||b.Materials[c.material])){if(n.render){this.renderMeshWithMaterial(c._global_matrix,e,n,c.indices,c.submesh);return}c.color=n.color}if(e){n=!1;c._instances&&(1<gl.webgl_version||gl.extensions.ANGLE_instanced_arrays)&&(n=!0);var f=null,l=c.shader;this.on_getShader?f=this.on_getShader(c,a):(!f&&c.shader&&(f=
gl.shaders[l]),this.shader_overwrite&&(f=gl.shaders[this.shader_overwrite]));f||(f=c.textures.color?this._texture_shader:this._flat_shader);n&&!f.attributes.u_model&&(n=!1);var l=0,k=null;for(d in c.textures){var g=c.textures[d];if(g){g.constructor===Object&&(g=g.texture);var r="u_"+d+"_texture";if(!f||f.samplers[r])k=gl.textures[g],k||(this.autoload_assets&&-1!=g.indexOf(".")&&this.loadTexture(g,this.default_texture_settings),k=gl.textures.white),c.flags.pixelated?(k.bind(0),gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST)):!1===c.flags.pixelated&&(k.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)),c._uniforms[r]=k.bind(l++)}}this.ignore_flags||this.enableItemFlags(c);if(c.onRender)c.onRender(this,a,f);for(d=0;d<this.global_uniforms_containers.length;++d)f.uniforms(this.global_uniforms_containers[d]);this.skip_node_uniforms||
f.uniforms(c._uniforms);if(c.onShaderUniforms)c.onShaderUniforms(this,f);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,f,c);d=null;null!=c.submesh&&e.info&&e.info.groups&&e.info.groups[c.submesh]&&(d=e.info.groups[c.submesh]);n?(E.u_model=c._instances,d?f.drawInstanced(e,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices,E,d.start,d.length):c.draw_range?f.drawInstanced(e,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices,E,c.draw_range[0],c.draw_range[1]):f.drawInstanced(e,
void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices,E)):d?f.drawRange(e,void 0===c.primitive?gl.TRIANGLES:c.primitive,d.start,d.length,c.indices):c.draw_range?f.drawRange(e,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.draw_range[0],c.draw_range[1],c.indices):f.draw(e,void 0===c.primitive?gl.TRIANGLES:c.primitive,c.indices);this.ignore_flags||this.disableItemFlags(c);this.draw_calls+=1}else if(c.onRender)c.onRender(this,a)}};f.prototype.renderMesh=function(c,a,e,d,n,f,l,k){a&&(d&&this._uniforms.u_color.set(d),
c||(c=b.IDENTITY),this._uniforms.u_model.set(c),n||(n=e?gl.shaders.texture:gl.shaders.flat),e&&(this._uniforms.u_texture=e.bind(0)),n.uniforms(this._uniforms),n.draw(a,void 0===f?gl.TRIANGLES:f,l),this.draw_calls+=1)};f.prototype.renderMeshWithMaterial=function(c,b,a,e,d){a.render&&a.render(this,c,b,e,d)};f.prototype.renderBounding=function(c,a){if(c){a=a||b.IDENTITY;var e=this._uniforms.u_model,d=null,d=c.constructor===GL.Mesh?c._bounding:c,n=d.subarray(3,6);mat4.translate(e,a,d.subarray(0,3));mat4.scale(e,
e,[2*n[0],2*n[1],2*n[2]]);this.renderMesh(e,gl.meshes.cube,null,[1,1,0,1],null,gl.LINES,"wireframe")}};f.prototype.enableItemFlags=function(c){var a=c.flags.flip_normals;this.reverse_normals&&(a=!a);gl.frontFace(a?gl.CW:gl.CCW);gl[!1===c.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST);!1===c.flags.depth_write&&gl.depthMask(!1);gl[!0===c.flags.two_sided?"disable":"enable"](gl.CULL_FACE);if(c.blend_mode!==b.BLEND_NONE)switch(gl.enable(gl.BLEND),c.blend_mode){case b.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,
gl.ONE_MINUS_SRC_ALPHA);break;case b.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case b.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND);"BLEND"==c.alphaMode&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};f.prototype.disableItemFlags=function(c){c.flags.flip_normals&&gl.frontFace(gl.CCW);!1===c.flags.depth_test&&gl.enable(gl.DEPTH_TEST);c.blend_mode!==b.BLEND_NONE&&gl.disable(gl.BLEND);c.flags.two_sided&&gl.disable(gl.CULL_FACE);
!1===c.flags.depth_write&&gl.depthMask(!0);"BLEND"==c.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};f.prototype.setPointSize=function(c){this.point_size=c;gl.shaders.point.uniforms({u_pointSize:this.point_size})};b.Renderer.prototype.renderPoints=function(c,a,e,d,n,f,l,k){if(!c||c.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";n||(k?(n=this.shaders._points_textured,n||(n=this.shaders._points_textured=new GL.Shader(b.points_vs_shader,b.points_fs_shader,{TEXTURED:""}),
n.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(n=this.shaders._points,n||(n=this.shaders._points=new GL.Shader(b.points_vs_shader,b.points_fs_shader),n.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));f=f||1;var g=1024;d=d||c.length/3;var r=null,u=null,h=this._points_mesh;d>c.length/3&&(d=c.length/3);!h||c.length>3*g?(d>g&&(g=GL.Texture.nextPOT(d)),r=new Float32Array(3*g),u=new Float32Array(4*g),h=this._points_mesh=GL.Mesh.load({vertices:r,extra4:u})):(r=this._points_mesh.getBuffer("vertices").data,
u=this._points_mesh.getBuffer("extra4").data);r.set(r.length>c.length?c:c.subarray(0,r.length));a?u.set(u.length>a.length?a:a.subarray(0,u.length)):u.fill&&u.fill(0);h.upload(GL.DYNAMIC_STREAM);n.setUniform("u_color",this._color);n.setUniform("u_pointSize",f);n.setUniform("u_camera_perspective",e._projection_matrix[5]);n.setUniform("u_viewport",gl.viewport_data);n.setUniform("u_viewprojection",e._viewprojection_matrix);k&&n.setUniform("u_texture",k.bind(0));n.drawRange(h,void 0!==l?l:GL.POINTS,0,
d);return h};b.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = a_vertex;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
b.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
f.prototype.renderLines=function(c,a,e,d){if(!c||c.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var n=this.shaders._lines;n||(n=this.shaders._lines=new GL.Shader(b.lines_vs_shader,this._flat_fragment_shader));var f=this._camera,l=1024,k=c.length/3,g=e?2*k:4*k,r=null,u=null,h=null,l=this._lines_mesh;!l||3*g>l.getBuffer("vertices").data.length?(l=GL.Texture.nextPOT(g),r=new Float32Array(3*l),u=new Float32Array(3*l),h=new Float32Array(2*l),indices_data=new Uint16Array(3*
l),l=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:r,normals:u,extra2:h})):(r=this._lines_mesh.getBuffer("vertices").data,u=this._lines_mesh.getBuffer("normals").data,h=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data);var g=vec2.fromValues(-1,-1),m=vec2.fromValues(1,-1),q=vec2.fromValues(-1,1),s=vec2.fromValues(1,1),v=vec3.create();if(e)throw"strip lines not supported yet";e=Math.floor(k/2);for(var p=0;p<e;++p){var D=2*p,t=
c.subarray(3*D,3*D+3),D=c.subarray(3*D+3,3*D+6);vec3.sub(v,D,t);r.set(t,12*p);r.set(t,12*p+3);r.set(D,12*p+6);r.set(D,12*p+9);u.set(v,12*p);u.set(v,12*p+3);u.set(v,12*p+6);u.set(v,12*p+9);h.set(g,8*p);h.set(m,8*p+2);h.set(q,8*p+4);h.set(s,8*p+6);indices_data.set([4*p+0,4*p+2,4*p+1,4*p+1,4*p+2,4*p+3],6*p)}l.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);n.setUniform("u_model",d||b.IDENTITY);n.setUniform("u_color",this._color);n.setUniform("u_camera_front",f._front);n.setUniform("u_camera_position",
f.eye);n.setUniform("u_lineWidth",0.5*a);n.setUniform("u_camera_perspective",f._projection_matrix[5]);n.setUniform("u_viewport",gl.viewport_data);n.setUniform("u_viewprojection",f._viewprojection_matrix);n.drawRange(l,gl.TRIANGLES,0,6*k);return l};b.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
f.prototype.loadMesh=function(c,b){if(!c)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[c]&&!this.assets_not_found[c]){var a=this.meshes[c];if(a)return b&&b(a),a;var e=this,a=c;-1==a.indexOf("://")&&(a=this.assets_folder+c);a=GL.Mesh.fromURL(a,function(a){a?e.meshes[c]=a:(e.assets_not_found[c]=!0,delete e.meshes[c]);e.num_assets_loading--;delete e.assets_loading[c];b&&b(a,c)});this.assets_loading[c]=a;this.num_assets_loading++;return this.meshes[c]=a}};f.prototype.loadTexture=
function(c,b,a){function e(b){f.debug&&console.log(" + texture loaded: "+c);b?f.textures[d]=b:f.assets_not_found[c]=!0;a&&a(b,d);f.num_assets_loading--;delete f.assets_loading[c];if(f.on_texture_load)f.on_texture_load(b,d)}if(!c)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[c]&&!this.assets_not_found[c]){var d=c;b&&(b.name&&(d=b.name),b.preview&&(d=b.preview));var n=this.textures[d];if(n&&!n.is_preview)return a&&a(n),n;var f=this,n=c;-1==n.indexOf("://")&&(n=this.assets_folder+
c);var l=null;-1!=c.indexOf("CUBEMAP")?l=GL.Texture.cubemapFromURL(n,this.default_cubemap_settings,e):this.credentials?(this.credentials.headers?this.credentials.headers["Content-Type"]="application/octet-stream":this.credentials.headers={"Content-Type":"application/octet-stream"},l=new GL.Texture(1,1,b),fetch(n,this.credentials).then(function(c){if(!c.ok)throw Error("HTTP "+c.status+":"+c.statusText);return c.arrayBuffer()}).then(function(c){var a=URL.createObjectURL(new Blob([c]));b.texture=l;l=
GL.Texture.fromURL(a,b,e);b.texture=null;setTimeout(function(){URL.revokeObjectURL(a)},6E4)})):l=GL.Texture.fromURL(n,b,e);b&&b.preview&&(l.is_preview=!0);this.assets_loading[c]=l;this.num_assets_loading++;return this.textures[d]=l}};f.prototype.loadTextureAtlas=function(c,b,a){"string"==typeof c&&(c=JSON.parse(c));var e=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(b){var d=c.files;e.textures[":atlas"]=b;for(var n in d)if(!e.textures[n]||e.textures[n].is_preview){var f=
d[n],l=new GL.Texture(c.size,c.size,{wrap:gl.REPEAT,filter:gl.LINEAR});l.drawTo(function(){b.gl.drawTexture(b,0,0,c.size,c.size,f.x,f.y,f.width||c.size,f.height||c.size)});l.is_preview=!0;e.textures[n]=l}a&&a(d)})};f.prototype.loadShaders=function(b,a,e){var d=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);b+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(b,function(b){d.compileShadersFromAtlas(b,e);d.loading_shaders=!1;a&&a(b)})};f.prototype.compileShadersFromAtlasCode=function(b,
a){var e=GL.processFileAtlas(b);this.compileShadersFromAtlas(e,a)};f.prototype.compileShadersFromAtlas=function(b,a){var e=b.shaders;if(e){this.shader_files=b;for(var d in b)b[d]=GL.Shader.expandImports(b[d],b);e=e.split("\n");for(d=0;d<e.length;++d){var n=e[d].trim().split(" "),f=n[0].trim();if("//"!=f.substr(0,2)){var l=b[n[1]],k=b[n[2]],g=null,r={};if(3<n.length)for(var u=3;u<n.length;++u)if("#"==n[u][0])r[n[u].substr(1)]=!0;else{g=n.slice(u).join(" ");break}if(!r.WEBGL1||1==gl.webgl_version)if(!r.WEBGL2||
2==gl.webgl_version){n[1]&&"@"==n[1][0]&&(r=n[1].substr(1)+"_VERTEX_SHADER",GL.Shader[r]&&(l=GL.Shader[r]));n[2]&&"@"==n[2][0]&&(r=n[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[r]&&(k=GL.Shader[r]));if(g)try{g=JSON.parse(g)}catch(h){console.error("Error in shader macros: ",f,g,h)}if(g&&a){var r={},m;for(m in g)r[m]=g[m];for(m in a)r[m]=a[m];g=r}else a&&(g=a);try{l&&k?this.shaders[f]?this.shaders[f].updateShader(l,k,g):this.shaders[f]=new GL.Shader(l,k,g):console.warn("Shader subfile not found: ",n[1],
n[2])}catch(q){GL.Shader.dumpErrorToConsole(q,l,k)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};f.prototype.setShadersFromFile=function(b){b=GL.processFileAtlas(b);this.compileShadersFromAtlas(b)};f.cubemap_info=[{front:[1,0,0],up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];f.prototype.renderToCubemap=function(c,a,e,d,n,l,k){var g=f.cubemap_camera;
g||(f.cubemap_camera=g=new b.Camera);g.perspective(90,1,l||0.1,k||1E3);var r=vec3.create(),u=this;c.drawTo(function(b,c){var l=f.cubemap_info[c];vec3.add(r,e,l.front);g.lookAt(e,r,l.up);u.clear();u.render(a,g,d,n)});return c};f.prototype.drawSphere3D=function(b,a,e){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var d=gl.shaders.flat;d.setUniform("u_color",e);d.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(v);mat4.translate(v,v,b);mat4.scale(v,v,[a,a,a]);
d.setUniform("u_model",v);d.draw(gl.meshes.sphere);this.draw_calls+=1};f.prototype.drawCircle2D=function(b,a,e,d,n){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:0.02,slices:64}));var f=gl.shaders.flat;f.setUniform("u_color",d);f.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(v);mat4.translate(v,v,[b,a,0]);mat4.scale(v,v,[2*e,2*e,2*e]);f.setUniform("u_model",v);f.draw(gl.meshes[n?
"circle":"ring"]);this.draw_calls+=1};f.prototype.drawLine2D=function(c,a,e,d,n,f,l){var k=gl.meshes.plane;l=l||gl.shaders.flat;l.setUniform("u_color",f);l.setUniform("u_viewprojection",this._viewprojection2D_matrix);var g=e-c,r=d-a;f=Math.atan2(g,r);g=Math.sqrt(g*g+r*r);n/=2;mat4.identity(v);mat4.translate(v,v,[0.5*(c+e),0.5*(a+d),0]);mat4.rotate(v,v,f,b.FRONT);c=n;mat4.scale(v,v,[c,g,c]);l.setUniform("u_model",v);l.draw(k);this.draw_calls+=1};b.sortByDistance=function(b,a){b.forEach(function(b){b._distance=
b.getDistanceTo(a)});b.sort(function(b,c){return c._distance-b._distance})};b.noBlending=function(c){return c.blend_mode===b.BLEND_NONE};b.generateTextureAtlas=function(b,a,e,d,n){a=a||1024;e=e||1024;d=d||64;var f=0,l;for(l in b)f++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var f=new GL.Texture(a,e),k={width:a,height:e,size:d,files:{}},g=0,r=0,u={};f.drawTo(function(){for(var f in b)if(":"!=f[0]&&"white"!=f&&"black"!=f&&"notfound"!=f){var l=b[f];if(!l.is_preview&&l.texture_type==
gl.TEXTURE_2D){if(n){var h=l.toBase64().hashCode();if(u[h]){k.files[f]=k.files[u[h]];continue}u[h]=f}k.files[f]={x:g,y:r};l.renderQuad(g,r,d,d);g+=d;if(g==a&&(g=0,r+=d,r==e)){console.warn("Atlas too small, some textures wont be stored.");break}}}});f.info=k;console.log(k);return f};f.prototype.computeResourcesLoaded=function(b){var a=0,e;for(e in b){var d=b[e],n=this.textures[d];n&&!1===n.ready||(d=this.meshes[d])&&!1===d.ready||(n||d)&&a++}return a};Object.defineProperty(f.prototype,"meshes",{get:function(){return this.gl.meshes},
set:function(b){},enumerable:!0});Object.defineProperty(f.prototype,"textures",{get:function(){return this.gl.textures},set:function(b){},enumerable:!0});Object.defineProperty(f.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(b){},enumerable:!0});f.prototype.addMesh=function(b,a){a.gl!=this.gl&&(a=a.cloneShared(this.gl));this.gl.meshes[b]=a};b.Renderer=f;b.Ray=q;q.prototype.testPlane=function(b,a){return geo.testRayPlane(this.origin,this.direction,b,a,this.collision_point)};
q.prototype.testSphere=function(b,a,e){return geo.testRaySphere(this.origin,this.direction,b,a,this.collision_point,e)};q.prototype.closestPointOnRay=function(b,a,e){e=e||vec3.create();var d=vec3.create();vec3.add(d,this.origin,this.direction);var n=vec3.create();vec3.add(n,b,a);geo.closestPointBetweenLines(this.origin,d,b,n,null,e);return e};b.Factory=function(c,a,e){c=b.Factory.templates[c];var d=new b.SceneNode;c&&d.configure(c);a&&(a.constructor===b.Scene?a.root:a).addChild(d);e&&d.configure(e);
return d};b.Factory.templates={grid:{mesh:"grid",primitive:1,color:[0.5,0.5,0.5,0.5],blend_mode:b.BLEND_ALPHA},mesh:{shader:"phong"},sphere:{mesh:"sphere",shader:"phong"},floor:{mesh:"planeXZ",scaling:10,shader:"phong"}};k.prototype._ctor=function(){a.prototype._ctor.call(this);this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};
k.prototype.updateVertices=function(b){b&&(this.vertices=b);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};k.prototype.updateNormals=function(b){b&&(this.normals=b);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=
new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};k.prototype.updateCoords=function(b){b&&(this.coords=b);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,
2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};k.prototype.updateIndices=function(b){b&&(this.indices=b);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);
this._total_indices=b.length};k.prototype.render=function(b,a){if(this._total){var e=b.shaders[this.shader||"flat"];if(e){b.setModelMatrix(this._global_matrix);var d=this._mesh,n=this._total_indices?this._total_indices:this._total/3;b.enableItemFlags(this);e.uniforms(b._uniforms).uniforms(this._uniforms).drawRange(d,void 0===this.primitive?GL.TRIANGLES:this.primitive,0,n,this._total_indices?"triangles":null);b.disableItemFlags(this)}}};extendClass(k,a);b.DynamicMeshNode=k;s.prototype._ctor=function(){a.prototype._ctor.call(this);
this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=b.TOP_LEFT;this.blend_mode=b.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};Object.defineProperty(s.prototype,"angle",{get:function(){return this._angle},set:function(c){this._angle=c;quat.setAxisAngle(this._rotation,
b.FRONT,this._angle*n);this._must_update_matrix=!0},enumerable:!0});s.prototype.setSize=function(b,a){this.size[0]=b;this.size[1]=a};s.createFrames=function(b,a,e){e=e||{};var d;b.constructor!=Number?(num_columns=b[0],d=b[1]):d=num_columns=b;var n=b=0,f=1/num_columns,l=1/d;d*=num_columns;if(!a){a=[];for(var k=0;k<d;++k)a.push(String(k))}for(k=0;k<a.length&&!(e[a[k]]={pos:[b,n],size:[f,l],normalized:!0},b+=f,1<=b&&(b=0,n+=l),1<=n);++k);return e};s.prototype.createFrames=function(b,a){s.createFrames(b,
a,this.frames)};s.prototype.addFrame=function(b,a,e,d,n,f){this.frames[b]={pos:vec2.fromValues(a,e),size:vec2.fromValues(d,n),normalized:!!f}};s.prototype.updateTextureMatrix=function(b){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var a=b.textures[this.texture];if(!a&&b.autoload_assets){var e=this;-1!=this.texture.indexOf(".")&&b.loadTexture(this.texture,b.default_texture_settings,function(b){b&&0==e.size[0]&&0==e.size[0]&&e.setSize(b.width,b.height)});a=gl.textures.white}if(!a)return!1;
b=this.texture_matrix;var d=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!d)return!1;if(!d)return this.flags.flipX&&(w[0]=this.flags.flipX?1:0,w[1]=0,mat3.translate(b,b,w),w[0]=this.flags.flipX?-1:1,w[1]=1,mat3.scale(b,b,w)),!0;if(d.normalized)w[0]=this.flags.flipX?d.pos[0]+d.size[0]:d.pos[0],w[1]=1-d.pos[1]-d.size[1],mat3.translate(b,b,w),w[0]=d.size[0]*(this.flags.flipX?-1:1),w[1]=d.size[1];else{var n=a.height;w[0]=(this.flags.flipX?d.pos[0]+d.size[0]:d.pos[0])/a.width;w[1]=
(n-d.pos[1]-d.size[1])/n;mat3.translate(b,b,w);w[0]=d.size[0]*(this.flags.flipX?-1:1)/a.width;w[1]=d.size[1]/a.height}mat3.scale(b,b,w);return!0};s.prototype.render=function(a,e){if(this.texture&&this.updateTextureMatrix(a)){var d=a.textures[this.texture];if(d){this.flags.pixelated&&(d.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));
this.billboard_mode&&b.orientNodeToCamera(this.billboard_mode,this,e,a);0==this.size[0]&&!1!==d.ready&&(this.size[0]=d.width);0==this.size[1]&&!1!==d.ready&&(this.size[1]=d.height);var n=this.size,f=0,l=0;v.set(this._global_matrix);var k=!1;this.current_frame&&this.current_frame.size&&(n=this.current_frame.size,k=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case b.TOP_LEFT:f=0.5;l=-0.5;break;case b.TOP_CENTER:l=-0.5;break;case b.TOP_RIGHT:f=-0.5;break;case b.BOTTOM_LEFT:l=
f=0.5;break;case b.BOTTOM_CENTER:l=0.5;break;case b.BOTTOM_RIGHT:f=-0.5,l=0.5}mat4.translate(v,v,[f*d.width*n[0],l*d.height*n[1],0])}k?mat4.scale(v,v,[d.width*n[0],d.height*n[1],1]):mat4.scale(v,v,[this.size[0],this.size[1],1]);a.setModelMatrix(v);a.renderNode(this,a,e)}}};extendClass(s,a);b.Sprite=s;e.prototype._ctor=function(){this.mesh="cube";this.shader="skybox";this.scaling=[10,10,10];this.flags.depth_test=!1;this.flags.two_sided=!0};e.prototype.render=function(b,a){this.position=a.position;
this.updateGlobalMatrix(!0);b.setModelMatrix(this._global_matrix);b.renderNode(this,a)};extendClass(e,a);b.Skybox=e;b.parseTextConfig=function(b){function a(b,c){for(var d=e.shift();d;)if(0==d.trim().length)d=e.shift();else{for(var n=0;"\t"==d[n]&&n<d.length;)n++;if(n<c)break;var f={children:[]};try{var l=d.trim();-1!=l.indexOf(":")&&(l="{"+l+"}");var k=new Function("return "+l);f.data=k()}catch(g){console.error(g)}n>=c&&(b&&b.children.push(f),d=a(f,n+1))}return d}var e=b.split("\n");b={data:"",children:[]};
a(b,0);return b};f.prototype.createShaders=function(){var a="",e="";b.Skeleton&&(a="\n\t\t#ifdef SKINNING\n\t\t\t"+b.Skeleton.shader_code+"\n\t\t#endif\n\t\t",e="\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t");a=this._vertex_shader="\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tattribute vec3 a_normal;\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec3 v_pos;\n\t\t\t\tvarying vec3 v_normal;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\t"+
a+"\n\t\t\t\t#ifdef INSTANCING\n\t\t\t\t\tattribute mat4 u_model;\n\t\t\t\t#else\n\t\t\t\t\tuniform mat4 u_model;\n\t\t\t\t#endif\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tvoid main() {\n\t\t\t\t\tv_pos = a_vertex;\n\t\t\t\t\tv_normal = a_normal;\n\t\t\t\t\t"+e+"\n\t\t\t\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t\t\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t\t\tgl_PointSize = 2.0;\n\t\t\t\t}\t\t\t\t";
e=this._flat_fragment_shader="\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,e);gl.shaders.flat_instancing=this._flat_instancing_shader=new GL.Shader(a,e,{INSTANCING:""});gl.shaders.flat_skinning=this._flat_shader=new GL.Shader(a,e,{SKINNING:""});this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t",
"\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=this._color_shader;e="\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\t\t}\t";
gl.shaders.texture=this._texture_shader=new GL.Shader(a,e);gl.shaders.texture_albedo=this._texture_albedo_shader=new GL.Shader(a,e,{ALBEDO:""});gl.shaders.texture_instancing=this._texture_instancing_shader=new GL.Shader(a,e,{INSTANCING:""});gl.shaders.texture_albedo_instancing=this._texture_albedo_instancing_shader=new GL.Shader(a,e,{ALBEDO:"",INSTANCING:""});b.Skeleton&&(gl.shaders.texture_skinning=this._texture_skinning_shader=new GL.Shader(a,e,{SKINNING:""}));this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_mvp;\n\t\tuniform mat3 u_texture_matrix;\n\t\tvoid main() {\n\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform float u_global_alpha_clip;\n\t\tuniform sampler2D u_color_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\t");gl.shaders.texture_transform=this._texture_transform_shader;this._phong_uniforms={u_ambient:vec3.create(),u_light_vector:vec3.fromValues(0.5442,0.6385,0.544),
u_light_color:b.WHITE};e=this._fragment_shader="\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec3 u_ambient;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_vector;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef TEXTURED\n\t\t\t\tuniform sampler2D u_color_texture;\n\t\t\t#endif\n\t\t\t#ifdef UNIFORMS\n\t\t\t\tUNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef TEXTURED\n\t\t\t\t\tcolor *= texture2D( u_color_texture, v_coord );\n\t\t\t\t#endif\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(u_light_vector,N));\n\t\t\t\t#ifdef EXTRA\n\t\t\t\t\tEXTRA\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color * (vec4(u_ambient,1.0) + NdotL * vec4(u_light_color,1.0));\n\t\t\t}\t";
gl.shaders.phong=this._phong_shader=new GL.Shader(a,e);this._phong_shader._uniforms=this._phong_uniforms;this._phong_shader.uniforms(this._phong_uniforms);gl.shaders.phong_instancing=this._phong_instancing_shader=new GL.Shader(a,e,{INSTANCING:""});this._phong_instancing_shader._uniforms=this._phong_uniforms;this._phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.textured_phong=this._textured_phong_shader=new GL.Shader(a,e,{TEXTURED:""});this._textured_phong_shader.uniforms(this._phong_uniforms);
gl.shaders.textured_phong_instancing=this._textured_phong_instancing_shader=new GL.Shader(a,e,{INSTANCING:"",TEXTURED:""});this._textured_phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.normal=this._normal_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4( normalize(v_normal),1.0);\n\t\t\t}\t");gl.shaders.uvs=this._uvs_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(v_coord,0.0,1.0);\n\t\t\t}\t")};
b.orientNodeToCamera=function(a,e,d,n){if(a){if(a==b.BILLBOARD_CYLINDRIC||a==b.BILLBOARD_PARALLEL_CYLINDRIC){var f=null;a==b.BILLBOARD_CYLINDRIC?(f=e.getGlobalPosition(y),vec3.sub(t,d._position,f),w[0]=t[0],w[1]=t[2]):(w[0]=d._front[0],w[1]=d._front[2]);a=vec2.computeSignedAngle(w,b.FRONT2D);isNaN(a)||(mat4.rotateY(v,u,-a),e._global_matrix.set(v),mat4.setTranslation(e._global_matrix,e._position),mat4.scale(e._global_matrix,e._global_matrix,e._scale))}else a==b.BILLBOARD_PARALLEL_SPHERIC?(e._global_matrix.set(d._model_matrix),
mat4.setTranslation(e._global_matrix,e._position)):(mat4.lookAt(e._global_matrix,e._position,d.position,b.UP),mat4.invert(e._global_matrix,e._global_matrix)),mat4.scale(e._global_matrix,e._global_matrix,e._scale);n.setModelMatrix(e._global_matrix)}};b.readPixels=function(b,a){var e=new Image;e.src=b;e.onload=function(){var b=document.createElement("canvas");b.width=this.width;b.height=this.height;var c=b.getContext("2d");c.drawImage(this,0,0);b=c.getImageData(0,0,b.width,b.height);a(b,this)}};"undefined"==
typeof GL&&(mat4.rotateVec3=function(b,a,e){var d=e[0],n=e[1];e=e[2];b[0]=a[0]*d+a[4]*n+a[8]*e;b[1]=a[1]*d+a[5]*n+a[9]*e;b[2]=a[2]*d+a[6]*n+a[10]*e;return b},mat4.projectVec3=function(b,a,e){var d=e[0],n=e[1];e=e[2];var f=a[1]*d+a[5]*n+a[9]*e+a[13],l=a[2]*d+a[6]*n+a[10]*e+a[14],k=a[3]*d+a[7]*n+a[11]*e+a[15];b[0]=((a[0]*d+a[4]*n+a[8]*e+a[12])/k+1)/2;b[1]=(f/k+1)/2;b[2]=(l/k+1)/2;return b})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(p){function a(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);
this._meshes={};this._last_point_id=this._accumulated_time=0}function g(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.velocity_variation=
this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function m(){this._ctor()}function h(a){this._ctor();a&&this.configure(a)}extendClass(a,
RD.SceneNode);RD.PointCloud=a;a.prototype.render=function(f,g){if(0!=this.points.length){this.updateVertices();var k=this._meshes[f.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,f.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);k=gl.shaders[this.shader];
k||(k=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(a._vertex_shader,a._pixel_shader));this.draw_range[1]=this.points.length;k=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;0<this.num_textures?(this._uniforms.u_texture_info[0]=1/this.num_textures,this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures):this._uniforms.u_texture_info[0]=0;this.ignore_transform&&(mat4.identity(f._model_matrix),f._mvp_matrix.set(f._viewprojection_matrix));
f.renderNode(this,f,g)}};a.prototype.updateVertices=function(a){if(a=this.points.length)for(var g=this._vertices,k=this._extra,h=0,e=this.num_textures*this.num_textures,d=0;d<a;d++){var l=this.points[d];g.set(l.pos?l.pos:l,h);k[h]=1;k[h+1]=1;1<e&&(k[h+2]=l.tex);h+=3}};a._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
a._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(g,RD.SceneNode);RD.ParticlesEmissor=g;g.prototype.update=function(a){var g=this.particles.length,k=this.particles_damping,h=this.particles_acceleration,e=vec3.length(h);if(g){for(var d=[],l=0;l<g;l++){var b=this.particles[l];vec3.scaleAndAdd(b.pos,b.pos,b.vel,a);e&&vec3.scaleAndAdd(b.vel,b.vel,h,a);k&&vec3.scaleAndAdd(b.vel,b.vel,b.vel,-a*k);b.ttl-=a;0<b.ttl&&d.push(b)}this.particles=d}g=this.getGlobalPosition();k=this.emissor_direction;h=this.particles_life;e=this.num_textures*this.num_textures;
d=this.velocity_variation;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),l=0;l<a&&!(this.particles.length>=this.max_particles);l++)k=vec3.clone(k),k[0]+=0.5*Math.random()*d,k[2]+=0.5*Math.random()*d,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*e)/e,pos:vec3.clone(g),vel:k,ttl:h})};g.prototype.render=function(a,h){if(0!=this.particles.length){this.updateVertices();
var k=this._meshes[a.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);k=gl.shaders[this.shader];k||(k=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(g._vertex_shader,g._pixel_shader));
this.draw_range[1]=this.particles.length;k=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,
h)}};g.prototype.updateVertices=function(a){if(a=this.particles.length)for(var g=this._vertices,k=this._extra,h=0,e=this.particles_life,d=this.num_textures*this.num_textures,l=0;l<a;l++){var b=this.particles[l];g.set(b.pos,h);k[h]=1;k[h+1]=b.ttl/e;1<d&&(k[h+2]=b.tex);h+=3}};g._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
g._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(m,RD.SceneNode);RD.Billboard=m;m.SPHERIC=1;m.PARALLEL_SPHERIC=2;m.CYLINDRIC=3;m.PARALLEL_CYLINDRIC=4;m.prototype._ctor=function(){this.billboard_mode=m.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};m.prototype.render=function(a,g){!1!==this.flags.visible&&(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,g,a),a.renderNode(this,a,g))};h.prototype._ctor=function(){RD.SceneNode.prototype._ctor.call(this);this.size=1;this._atlas_size=vec2.fromValues(1,
1);this.max_sprites=1024;this.positions=new Float32Array(3*this.max_sprites);this.sprite_info=new Float32Array(4*this.max_sprites);this.index=0;this.shader=null;this.use_points=!1;this.mode=h.CYLINDRICAL;this.must_update_buffers=!0};RD.SpritesBatch=h;h.XY=0;h.XZ=1;h.CYLINDRICAL=2;h.SPHERICAL=3;h.FLAT=4;Object.defineProperty(h.prototype,"atlas_size",{get:function(){return this._atlas_size},set:function(a){this._atlas_size.set(a)}});h.prototype.clear=function(){this.index=0};h.prototype.add=function(a,
g,k,h,e){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var d=this.index;this.index+=1;this.positions.set(a,3*d);2==a.length&&(this.positions[3*d+2]=0);a=4*d;this.sprite_info[a]=g||0;this.sprite_info[a+1]=k?1:0;this.sprite_info[a+2]=null==h?1:h;this.sprite_info[a+3]=e||0;this.must_update_buffers=!0}};h.prototype.addData=function(a,g){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var k=this.index;this.index+=
1;this.positions.set(a,3*k);this.sprite_info.set(g,4*k);this.must_update_buffers=!0}};h.prototype.render=function(a,g){if(this.texture){var k=a.textures[this.texture];k&&this.flags.pixelated&&(k.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.renderSprites(k,g,this.size,this.atlas_size,this.color,this.mode)}};h.prototype.renderSprites=
function(a,g,k,m,e,d){if(this.index){var l=gl.shaders[this.shader];l||(l=gl.shaders[this.use_points?"point_sprites":"quad_sprites"]);l||(l=this.use_points?gl.shaders.point_sprites=new GL.Shader(h.point_sprites_vertex_shader,h.point_sprites_fragment_shader):gl.shaders.quad_sprites=new GL.Shader(h.quad_sprites_vertex_shader,h.quad_sprites_fragment_shader));d=d||0;if(this.use_points)l.uniforms(GFX.scene_renderer._uniforms),l.setUniform("u_pointSize",k),l.setUniform("u_atlas",m),l.setUniform("u_texture",
a.bind(0)),RD.renderPoints(this.positions,this.sprite_info,g,this.index,l);else{if(!this.vertex_buffer_data){this.vertex_buffer_data=new Float32Array(12*this.max_sprites);this.extra4_buffer_data=new Float32Array(16*this.max_sprites);for(var b=new Int8Array(8*this.max_sprites),n=new Int8Array([-1,1,1,1,-1,-1,1,-1]),r=0;r<b.length;r+=8)b.set(n,r);for(var n=new Int16Array([0,2,1,1,2,3]),u=new Uint16Array(6*this.max_sprites),r=0;r<u.length;++r)u[r]=n[r%6]+4*Math.floor(r/6);this.vertex_buffer=new GL.Buffer(gl.ARRAY_BUFFER,
this.vertex_buffer_data,3,gl.DYNAMIC_DRAW);this.extra4_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this.extra4_buffer_data,4,gl.DYNAMIC_DRAW);this.extra2_buffer=new GL.Buffer(gl.ARRAY_BUFFER,b,2,gl.STATIC_DRAW);this.indices_buffer=new GL.Buffer(gl.ELEMENT_ARRAY_BUFFER,u,1,gl.STATIC_DRAW)}if(this.must_update_buffers){b=this.vertex_buffer_data;n=this.extra4_buffer_data;u=Math.min(this.index,this.positions.length/3);for(r=0;r<u;++r){var p=3*r,v=this.positions.subarray(p,p+3);b.set(v,4*p);b.set(v,4*p+3);b.set(v,
4*p+6);b.set(v,4*p+9);p=4*r;v=this.sprite_info.subarray(p,p+4);n.set(v,4*p);n.set(v,4*p+4);n.set(v,4*p+8);n.set(v,4*p+12)}this.vertex_buffer.uploadRange(0,48*this.index);this.extra4_buffer.uploadRange(0,64*this.index);this.must_update_buffers=!1}r=a.width/m[0]/(a.height/m[1]);b=RD.UP;n=RD.RIGHT;switch(d){case RD.SpritesBatch.SPHERICAL:b=g.getLocalVector(RD.UP);case RD.SpritesBatch.CYLINDRICAL:n=g.getLocalVector(RD.RIGHT);break;case RD.SpritesBatch.FLAT:b=g.getLocalVector(RD.FRONT);n=g.getLocalVector(RD.RIGHT);
break;case RD.SpritesBatch.XZ:b=RD.FRONT}l.bind();l.setUniform("u_model",RD.IDENTITY);l.setUniform("u_viewprojection",g._viewprojection_matrix);l.setUniform("u_color",e||RD.ONES4);l.setUniform("u_size",[k,k/r]);l.setUniform("u_top",b);l.setUniform("u_right",n);l.setUniform("u_atlas",m);l.setUniform("u_texture",a.bind(0));l.setUniform("u_itexsize",[1/a.width,1/a.height]);l.setUniform("u_viewport",gl.viewport_data);a=l.attributes.a_vertex;g=l.attributes.a_extra4;l=l.attributes.a_extra2;this.vertex_buffer.bind(a);
this.extra4_buffer.bind(g);this.extra2_buffer.bind(l);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer.buffer);gl.drawElements(gl.TRIANGLES,6*this.index,gl.UNSIGNED_SHORT,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.vertex_buffer.unbind(a);this.extra4_buffer.unbind(g);this.extra2_buffer.unbind(l)}}};extendClass(h,RD.SceneNode);h.quad_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4; //frame,flipx,scale,extranum\nattribute vec2 a_extra2;//expanse direction\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec2 u_size;\nuniform vec3 u_top;\nuniform vec3 u_right;\nuniform vec4 u_color;\nuniform vec2 u_atlas;\nuniform vec2 u_itexsize;\n\nvoid main() {\n\tvec3 vertex = a_vertex + a_extra4.z * u_size.y * u_top * a_extra2.y + a_extra4.z * u_size.x * u_right * a_extra2.x;\n\tvec2 uv = a_extra2;\n\tif( a_extra4.y != 0.0) //flip X\n\t\tuv.x *= -1.0;\n\tuv.x *= 1.0 - u_itexsize.x;\n\tuv.y *= -1.0;\n\tuv = uv * 0.5 + vec2(0.5);\n\t\n\tvec2 i_atlas = vec2(1.0) / u_atlas; \n\tfloat frame = a_extra4.x;\n\tfloat frame_x = mod( frame, u_atlas.x );\n\tfloat frame_y = floor( frame * i_atlas.x );\n\tuv.x = (uv.x + frame_x) * i_atlas.x;\n\tuv.y += frame_y;\n\tuv.y = 1.0 - uv.y * i_atlas.y;\n\tv_uv = uv;\n\tv_pos = (u_model * vec4(vertex,1.0)).xyz;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\t//gl_Position.x = floor(gl_Position.x * u_viewport.z * 1.0) / (u_viewport.z * 1.0);\n\t//gl_Position.y = floor(gl_Position.y * u_viewport.w * 1.0) / (u_viewport.w * 1.0);\n}\n\n";
h.quad_sprites_fragment_shader="\nprecision highp float;\nprecision mediump int;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n\tvec4 color = texture2D( u_texture, v_uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tcolor *= u_color;\n\tgl_FragColor = color;\n}\n";h.point_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_mvp;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tvec3 vertex = a_vertex;\t\n\tv_pos = vertex;\n\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_mvp * vec4(vertex,1.0);\n\tgl_Position.x = floor(gl_Position.x * u_viewport.z) / u_viewport.z;\n\tgl_Position.y = floor(gl_Position.y * u_viewport.w) / u_viewport.w;\n\tgl_PointSize = computePointSize( u_pointSize * u_extra4.z, gl_Position.w );\n}\n";
h.point_sprites_fragment_shader="\nprecision highp float;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4; //id,flip,scale,extra\nuniform float u_atlas;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\tfloat i_atlas = 1.0 / u_atlas;\n\tfloat frame = v_extra4.x;\n\tfloat x = frame * i_atlas;\n\tfloat y = floor(x);\n\tx = (x - y);\n\ty = y / u_atlas;\n\tif( v_extra4.y > 0.0 ) //must flip in x\n\t\tx -= gl_PointCoord.x * i_atlas - i_atlas;\n\telse\n\t\tx += gl_PointCoord.x * i_atlas;\n\t\n\tvec2 uv = vec2( x, 1.0 - (y + gl_PointCoord.y / u_atlas) );\n\tvec4 color = texture2D( u_texture, uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tgl_FragColor = color;\n}\n"})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
(function(p){function a(b){this._ctor();b&&this.configure(b);this.render_priority=0;this.targets=null;this.size=150;this.mode=a.DEFAULT;this.coordinates=a.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();b={x:a.XAXIS_COLOR,y:a.YAXIS_COLOR,z:a.ZAXIS_COLOR};var e="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");this.actions=
{};for(var d in e){var f=e[d],l={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:0.15,visible:!1,flag:a[f.toUpperCase()]};0==f.indexOf("move")&&(l.move=!0);0==f.indexOf("rotate")&&(l.rotate=!0);0==f.indexOf("scale")&&(l.scale=!0);l.color=b[f[f.length-1]];if(l.move||l.rotate)l.cursor="crosshair";this.actions[f]=l}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=vec3.fromValues(0,
1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=0.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
0.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1}a.MOVEX=1;a.MOVEY=2;a.MOVEZ=4;a.MOVEXY=8;a.MOVEXZ=16;a.MOVEYZ=32;a.ROTATEX=64;a.ROTATEY=128;a.ROTATEZ=256;a.SCALEX=512;a.SCALEY=1024;a.SCALEZ=2048;a.SCALEXY=4096;a.SCALEYZ=8192;a.SCALEXZ=
16384;a.SCALE=32768;a.DRAG=65536;a.ROTATE=131072;a.ROTATEFRONT=262144;a.MOVEAXIS=a.MOVEX|a.MOVEY|a.MOVEZ;a.MOVEPLANAR=a.MOVEXY|a.MOVEXZ|a.MOVEYZ;a.MOVEALL=a.DRAG|a.MOVEAXIS|a.MOVEPLANAR;a.PLANAR=a.MOVEX|a.MOVEZ|a.MOVEXZ|a.ROTATEY|a.SCALE;a.ROTATEALL=a.ROTATEX|a.ROTATEY|a.ROTATEZ|a.ROTATEFRONT;a.SCALEALL=a.SCALE|a.SCALEX|a.SCALEY|a.SCALEZ|a.SCALEXY|a.SCALEYZ|a.SCALEXZ;a.MOVEROTATESCALE=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALE;a.ALL=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALEALL;a.DEFAULT=a.PLANAR;
a.OBJECT_SPACE=1;a.WORLD_SPACE=2;p=mat4.create();var g=mat4.create(),m=mat4.create();mat4.create();mat4.create();mat4.create();var h=mat4.create(),f=mat4.create();mat4.create();var q=vec3.create(),k=vec3.create(),s=vec3.create(),e=vec4.create();vec4.create();mat4.translate(p,p,[1.1,0,0]);mat4.rotate(p,p,90*DEG2RAD,[0,0,-1]);mat4.translate(g,g,[0,1.1,0]);mat4.translate(m,m,[0,0,1.1]);mat4.rotate(m,m,90*DEG2RAD,[1,0,0]);p=mat4.create();mat4.scale(p,p,[-1,-1,-1]);a.full_viewport=null;var d=mat4.create(),
l=mat4.create();a.XAXIS_COLOR=[0.901,0.247,0.349,1];a.YAXIS_COLOR=[0.55,0.81,0.11,1];a.ZAXIS_COLOR=[0.23,0.57,0.93,1];a.XYAXIS_COLOR=[0.9,0.7,0.23,0.75];a.XZAXIS_COLOR=[0.6,0.4,0.7,0.75];a.YZAXIS_COLOR=[0.39,0.69,0.52,0.75];a.SPHERE_COLOR=[0.8,0.8,0.8,0.4];a.RING_COLOR=[0.5,0.5,0.5,1];a.INNERSPHERE_COLOR=[0.6,0.6,0.6,1];a.SELECTED_COLOR=[1,1,1,1];a.NOAXIS_COLOR=[0.901,0.247,0.749,1];a.STATIC_SPHERE_COLOR=[0.1,0.1,0.1,0.3];a.prototype.isTarget=function(b){return-1!=this.targets.indexOf(b)};a.prototype.setTargets=
function(b,a){if(b&&b.constructor!==Array)throw"nodes must be an Array";b&&0!=b.length?(a&&this.targets&&(b=this.targets.concat(b)),this.targets=b=b.filter(function(a,e){return b.indexOf(a)===e}),this.resetTransform(),this.position=this.computeCenter(this.targets)):a||(this.targets=null)};a.prototype.computeCenter=function(b){if((b=b||this.targets)&&b.length){for(var a=null,e=0;e<b.length;++e){var d=b[e];d.layers&this.layers&&(d=d.getGlobalPosition(),a?vec3.add(a,a,d):a=d)}if(!a)return[0,0,0];vec3.scale(a,
a,1/b.length);return a}};a.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?this.transform=this.targets[0].transform:this.position=this.computeCenter(this.targets)))};a.prototype.updateTargets=function(){if(this.targets)for(var b=this.getGlobalMatrix(mat4.create()),a=0;a<this.targets.length;++a){var e=this.targets[a];e.layers&this.layers&&e.fromMatrix(b,
!0)}};a.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(this.target_tranforms[b]=new Float32Array(a.transform))}}};a.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(a.transform=this.target_tranforms[b])}};a.prototype.removeTargetsFromScene=
function(){if(this.targets){for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&a.parentNode&&a.parentNode.removeChild(a)}this.targets=null}};a.prototype.getTargetBaseNodes=function(){function b(a){return-1!=e.indexOf(a)?!0:a.parentNode?b(a.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var a=[],e=this.targets,d=0;d<e.length;++d){var f=e[d];f.layers&this.layers&&(b(f.parentNode)||a.push(f))}return a};a.prototype.applyTransformToTarget=function(b){var a=
this.getGlobalMatrix(mat4.create()),e=mat4.invert(mat4.create(),a),d=mat4.create(),f=this.getTargetBaseNodes();if(f){for(var l=[1,1,1],k=0;k<f.length;++k){var g=f[k];l[0]=0<=g.scaling[0]?1:-1;l[1]=0<=g.scaling[1]?1:-1;l[2]=0<=g.scaling[2]?1:-1;g.getGlobalMatrix(d);mat4.multiply(d,e,d);mat4.multiply(d,b,d);mat4.multiply(d,a,d);g.fromMatrix(d,!0);vec3.mul(g._scale,g._scale,l);g.position=this.applySnap(g.position);if(this.grid_size){var h=quat.toEuler(vec3.create(),g.rotation);h[0]=15*Math.round(h[0]*
RAD2DEG/15)*DEG2RAD;h[1]=15*Math.round(h[1]*RAD2DEG/15)*DEG2RAD;h[2]=15*Math.round(h[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(g.rotation,h)}}mat4.multiply(d,a,b);this.fromMatrix(d);this.scaling=[1,1,1];this.updateGizmo()}};a.prototype.applyTranslation=function(b){var a=mat4.create();mat4.translate(a,a,b);this.applyTransformToTarget(a)};a.prototype.applyRotation=function(b,a){var e=mat4.create();mat4.rotate(e,e,b,a);this.applyTransformToTarget(e)};a.prototype.applyScale=function(b){b.constructor===Number&&
(b=[b,b,b]);var a=mat4.create();mat4.scale(a,a,b);this.applyTransformToTarget(a)};a.prototype.applySnap=function(b){if(!this.grid_size)return b;b[0]=Math.round(b[0]/this.grid_size)*this.grid_size;b[1]=Math.round(b[1]/this.grid_size)*this.grid_size;b[2]=Math.round(b[2]/this.grid_size)*this.grid_size;return b};a.prototype.setColor=function(b){if(this.targets)for(var a=0;a<this.targets.length;++a){var e=this.targets[a];e.layers&this.layers&&(e.color=b)}};a.prototype.cloneTargets=function(){if(this.allow_duplicating&&
(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var b=[],a=0;a<this.targets.length;++a){var e=this.targets[a];if(e.layers&this.layers){var d=e.clone(!0);e.parentNode.addChild(d);b.push(e)}}return this.targets=b}};a.prototype.onMouse=function(b){if(this._camera&&this.targets&&!1!==this.visible){var a=this._camera,e=a.getFront(),d=[b.canvasx,b.canvasy],f=a.getRay(d[0],d[1]),l=this.position,g=vec3.sub(vec3.create(),l,a.position);vec3.normalize(g,g);var k=this._selected_action,
h=this.actions[k],m=this._global_matrix;a.project(l,null,this.center_2D);if("mousedown"==b.type){if(this.click_2D[0]=this.click_2D2[0]=d[0],this.click_2D[1]=this.click_2D2[0]=d[1],b.is_touch&&this.testMouseOver(b),k=this._selected_action=this._hover_action,h=this.actions[k]){if(h.move&&h.axis){var p=vec3.clone(h.axis);mat4.rotateVec3(p,m,p);vec3.normalize(p,p);this._last=f.closestPointOnRay(l,p);b.shiftKey&&this.cloneTargets()}else h.move&&h.normal&&(f.testPlane(l,h.normal)&&(this.click_pos=f.collision_point),
b.shiftKey&&this.cloneTargets());"drag"==k&&(f.testPlane(l,e),this._last=f.collision_point,b.shiftKey&&this.cloneTargets());"rotatefront"==k?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,0.5*this.size),this.click_2D2.set(this.click_2D)):h.rotate&&(h.axis?(b=mat4.rotateVec3(vec3.create(),m,h.axis),f.testPlane(l,b)&&(vec3.sub(this.click_pos,f.collision_point,
l),vec3.normalize(this.click_pos,this.click_pos),l=vec3.scaleAndAdd(vec3.create(),l,this.click_pos,this.current_size),this.current_2D=this.click_2D=a.project(l))):f.testSphere(l,this.current_size)&&(this._last=f.collision_point,vec3.sub(this.click_pos,f.collision_point,l),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),g,this.click_pos)));this.click_model.set(m);this.click_transform.set(this.transform);this.click_dist=vec3.distance(this.click_2D,
this.center_2D);this.saveTargetTransforms()}}else if("mousemove"==b.type)if(b.dragging&&this._selected_action){if("rotatefront"==k)return l=vec2.sub(vec3.create(),d,this.center_2D),vec2.normalize(l,l),h=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,l,0.5*this.size),l=Math.atan2(l[0],l[1]),h=Math.atan2(h[0],h[1]),l-=h,b.shiftKey&&(l=2*Math.PI*Math.ceil(36*l/(2*Math.PI))/36),l&&(this.restoreTargetTransforms(),this.applyRotation(l,g)),!0;if(h.rotate)return h.axis?(b=mat4.rotateVec3(vec3.create(),
m,h.axis),f.testPlane(l,b)&&(k=vec3.sub(vec3.create(),f.collision_point,l),vec3.normalize(k,k),l=vec3.scaleAndAdd(vec3.create(),l,k,this.current_size),this.current_2D=a.project(l),a=Math.clamp(vec3.dot(k,this.click_pos),-1,1),l=Math.acos(a),k=vec3.cross(vec3.create(),k,this.click_pos),vec3.normalize(k,k),a=vec3.dot(b,k),0<a&&(l*=-1),this.restoreTargetTransforms(),this.applyRotation(l,h.axis))):(p=vec3.cross(vec3.create(),g,this.click_pos),l=0.01*(vec2.dist(this.center_2D,d)-this.click_dist),h=vec2.sub(vec2.create(),
this.center_2D,d),b=vec2.sub(vec2.create(),this.center_2D,this.click_2D),0>vec2.dot(h,b)&&(l=-l),console.log(l),this.restoreTargetTransforms(),this.applyRotation(l,p),this.click_axis=p),!0;g=null;if(h.move&&h.normal)f.testPlane(l,h.normal)&&(h=f.collision_point,this.applySnap(h),g=vec3.sub(vec3.create(),h,this.click_pos),this.click_pos=h);else if(h.move||h.scale){if("scale"==k||h.scale&&b.ctrlKey)return h=1+0.01*(d[1]-this.click_2D[1]),this.applyScale(h),this.click_2D[0]=d[0],this.click_2D[1]=d[1],
!0;if("scalexy"==k||"scalexz"==k||"scaleyz"==k){h=1+0.01*(d[1]-this.click_2D[1]);switch(k){case "scalexy":this.applyScale([h,h,1]);break;case "scaleyz":this.applyScale([1,h,h]);break;case "scalexz":this.applyScale([h,1,h])}this.click_2D[0]=d[0];this.click_2D[1]=d[1];return!0}p=vec3.clone(h.axis);mat4.rotateVec3(p,m,p);vec3.normalize(p,p);b=f.closestPointOnRay(l,p);if(h.scale)return h=vec2.distance(d,this.center_2D),b=h/this.click_dist,"scalex"==k?this.applyScale([b,1,1]):"scaley"==k?this.applyScale([1,
b,1]):"scalez"==k&&this.applyScale([1,1,b]),this.click_dist=h,!0;this.applySnap(b);g=vec3.sub(vec3.create(),b,this._last);this._last=b}"drag"==k&&(f.testPlane(l,this._camera.getFront()),b=f.collision_point,this.applySnap(b),g=vec3.sub(vec3.create(),b,this._last),this._last=b);if(g)return this.applyTranslation(g),!0}else this.testMouseOver(b);else if("mouseup"==b.type){if(this.saveTargetTransforms(),this._selected_action)return this._selected_action=null,this.render(this._last_renderer,this._last_camera),
this.testMouseOver(b),this.updateGizmo(),!0}else if("wheel"==b.type){if("scale"==this._selected_action)return h=1+2E-4*b.wheel,this.applyScale(h),!0;if("drag"==this._selected_action)return g=vec3.sub(vec3.create(),l,a.position),h=1+2E-4*b.wheel,vec3.scaleAndAdd(g,a.position,g,h),vec3.sub(g,g,l),this.applyTranslation(g),this._last=l,!0}return!1}};a.prototype.testMouseOver=function(b){this._hover_action=null;var e=[b.canvasx,b.canvasy],d=1E5;b=null;for(var f in this.actions){var l=this.actions[f];if(l.visible){var k=
vec2.distance(l.pos2D,e);k<l.radius*this.size&&k<d&&(d=k,b=f)}}b||(f=vec2.distance(this.center_2D,e),this.actions.rotatefront.visible&&10>Math.abs(f-0.5*this.size)?b="rotatefront":this.mode&a.ROTATE&&f<0.5*this.size&&(b="rotate"));return this._hover_action=b};a.prototype.cancel=function(){this._selected_action&&(this._selected_action=null,this.restoreTargetTransforms())};a.prototype.render=function(b,n){this._last_renderer=b;this._last_camera=n;for(var l in this.actions)this.actions[l].visible=!1;
if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:0.1,height:0.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:0.5*Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,
innerradius:0.02,outerslices:64,innerslices:8}));l=gl.meshes.torus;var g=n.getFront(),m=n.getLocalVector(RD.UP);n.getLocalVector(RD.RIGHT);var p=this._position;e.set(p);e[3]=1;var w=n._projection_matrix[5];this.updateMatrices();h.set(this._global_matrix);var t=vec3.sub(vec3.create(),p,n.position);vec3.normalize(t,t);this._camera=n;this._unitary_model=h;var y=this._hover_action,A=this._selected_action;A&&(y=A);var C=A?this.actions[A]:null,x=this.mode;mat4.rotateVec3(k,h,RD.RIGHT);mat4.rotateVec3(s,
h,RD.UP);mat4.rotateVec3(q,h,RD.FRONT);vec3.normalize(k,k);vec3.normalize(s,s);vec3.normalize(q,q);mat4.fromTranslationFrontTop(f,p,g,m);vec4.transformMat4(e,e,n._viewprojection_matrix);this.current_size=m=gl.canvas.width/gl.canvas.height*this.size*e[3]/(gl.canvas.width*w);mat4.scale(h,h,[m,m,m]);mat4.scale(f,f,[m,m,m]);var m=vec3.dot(t,k),w=vec3.dot(t,s),F=vec3.dot(t,q),E=vec3.dot(g,RD.RIGHT),c=vec3.dot(g,RD.UP),z=vec3.dot(g,RD.FRONT);this._camera.project(p,[0,0,gl.canvas.width,gl.canvas.height],
this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);t=gl.shaders[this.shader];t.uniforms(b._uniforms);t.uniforms(n.uniforms);t.uniforms(this.uniforms);if("movex"==A)mat4.rotateZ(d,h,-Math.PI/2),this.drawAxis(d,a.XAXIS_COLOR);else if("movey"==A)this.drawAxis(h,a.YAXIS_COLOR);else if("movez"==A)mat4.rotateX(d,h,-Math.PI/2),this.drawAxis(d,a.ZAXIS_COLOR);else if("drag"==A)b.drawCircle2D(this.center_2D[0],this.center_2D[1],
2,a.XAXIS_COLOR,!0);else if(C&&C.normal&&this.render_move_plane)d.set(h),"movexz"==A?mat4.rotateX(d,d,Math.PI/2):"moveyz"==A&&mat4.rotateY(d,d,Math.PI/2),mat4.scale(d,d,[100,100,100]),t.setUniform("u_model",d),t.setUniform("u_color",[0.1,0.1,0.1,0.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),t.draw(gl.meshes.plane),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==A)mat4.rotateX(d,f,Math.PI/2),t.setUniform("u_model",d),t.draw(l),b.drawCircle2D(this.click_2D[0],this.click_2D[1],
2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0),b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR),b.drawLine2D(this.click_2D2[0],this.click_2D2[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR);else{if("rotate"==A){this.click_axis&&(mat4.fromTranslationFrontTop(d,p,g,this.click_axis),mat4.scale(d,d,[this.current_size,this.current_size,
this.current_size]),this.drawAxis(d,a.NOAXIS_COLOR));this.drawRotateSphere(h,a.SPHERE_COLOR);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.NOAXIS_COLOR,!0);return}if(C&&C.rotate){g=C.color||a.XAXIS_COLOR;"rotatex"==A?mat4.rotateZ(d,h,Math.PI/2):"rotatey"==A?mat4.rotateY(d,h,Math.PI/2):"rotatez"==A&&mat4.rotateX(d,h,Math.PI/2);t.setUniform("u_model",d);t.setUniform("u_color",g);t.draw(l);b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g,!0);b.drawCircle2D(this.click_2D[0],this.click_2D[1],
2,g,!0);b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g);b.drawCircle2D(this.current_2D[0],this.current_2D[1],2,g,!0);b.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,g);return}}"scale"==A?(b.drawCircle2D(this.center_2D[0],this.click_2D[1],2,a.INNERSPHERE_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.INNERSPHERE_COLOR,!0),b.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],
4,a.INNERSPHERE_COLOR)):(this.drawRotateSphere(h,a.STATIC_SPHERE_COLOR),x&a.ROTATE&&"rotate"==y&&this.drawRotateSphere(h,a.SPHERE_COLOR),x&a.ROTATEFRONT&&(mat4.rotateX(d,f,Math.PI/2),t.setUniform("u_model",d),t.setUniform("u_color","rotatefront"==y?a.SELECTED_COLOR:a.RING_COLOR),t.draw(l),this.actions.rotatefront.visible=!0),0.1<Math.abs(m)&&x&a.ROTATEX&&(mat4.rotateZ(d,h,Math.PI/2),0>z&&mat4.rotateX(d,d,Math.PI),0>c&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatex"==y?a.SELECTED_COLOR:a.XAXIS_COLOR,
"rotatex")),0.1<Math.abs(w)&&x&a.ROTATEY&&(d.set(h),0<E&&0>z?mat4.rotateY(d,d,-Math.PI/2):0>E&&0>z?mat4.rotateY(d,d,Math.PI):0>E&&0<z&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatey"==y?a.SELECTED_COLOR:a.YAXIS_COLOR,"rotatey")),0.1<Math.abs(F)&&x&a.ROTATEZ&&(d.set(h),mat4.rotateX(d,d,Math.PI/2),0<E&&0>c?mat4.rotateY(d,d,-Math.PI/2):0>E&&0>c?mat4.rotateY(d,d,Math.PI):0>E&&0<c&&mat4.rotateY(d,d,Math.PI/2),this.drawRotator(d,"rotatez"==y?a.SELECTED_COLOR:a.ZAXIS_COLOR,"rotatez")),0.95>Math.abs(m)&&
(mat4.rotateZ(d,h,0>E?-Math.PI/2:Math.PI/2),x&a.MOVEX&&this.drawArrow(d,"movex"==y?a.SELECTED_COLOR:a.XAXIS_COLOR,"movex"),x&a.SCALEX&&this.drawScale(d,"scalex"==y?a.SELECTED_COLOR:a.XAXIS_COLOR,"scalex")),0.95>Math.abs(w)&&(0<c?mat4.rotateZ(d,h,Math.PI):d.set(h),x&a.MOVEY&&this.drawArrow(d,"movey"==y?a.SELECTED_COLOR:a.YAXIS_COLOR,"movey"),x&a.SCALEY&&this.drawScale(d,"scaley"==y?a.SELECTED_COLOR:a.YAXIS_COLOR,"scaley")),0.95>Math.abs(F)&&(mat4.rotateX(d,h,0>z?-Math.PI/2:Math.PI/2),x&a.MOVEZ&&this.drawArrow(d,
"movez"==y?a.SELECTED_COLOR:a.ZAXIS_COLOR,"movez"),x&a.SCALEZ&&this.drawScale(d,"scalez"==y?a.SELECTED_COLOR:a.ZAXIS_COLOR,"scalez")),0.2<Math.abs(F)&&(x&a.MOVEXY||x&a.SCALEXY)&&(mat4.translate(d,h,[0.45*(0>m?1:-1),0.45*(0>w?1:-1),0]),x&a.MOVEXY?this.drawFlat(d,"movexy"==y?a.SELECTED_COLOR:a.XYAXIS_COLOR,"movexy"):this.drawFlat(d,"scalexy"==y?a.SELECTED_COLOR:a.XYAXIS_COLOR,"scalexy","circle")),0.2<Math.abs(w)&&(x&a.MOVEXZ||x&a.SCALEXZ)&&(mat4.rotateX(d,h,Math.PI/2),mat4.translate(d,d,[0.45*(0>m?
1:-1),0.45*(0>F?-1:1),0]),x&a.MOVEXZ?this.drawFlat(d,"movexz"==y?a.SELECTED_COLOR:a.XZAXIS_COLOR,"movexz"):this.drawFlat(d,"scalexz"==y?a.SELECTED_COLOR:a.XZAXIS_COLOR,"scalexz","circle")),0.2<Math.abs(m)&&(x&a.MOVEYZ||x&a.SCALEYZ)&&(mat4.rotateY(d,h,Math.PI/2),mat4.translate(d,d,[0.45*(0>F?1:-1),0.45*(0>w?1:-1),0]),x&a.MOVEYZ?this.drawFlat(d,"moveyz"==y?a.SELECTED_COLOR:a.YZAXIS_COLOR,"moveyz"):this.drawFlat(d,"scaleyz"==y?a.SELECTED_COLOR:a.YZAXIS_COLOR,"scaleyz","circle")),x&a.DRAG&&this.drawInnerSphere(h,
"drag"),x&a.SCALE&&this.drawInnerSphere(h,"scale"),gl.enable(gl.DEPTH_TEST))}}};a.prototype.drawArrow=function(b,e,d){var f=gl.shaders[this.shader],g=gl.meshes.cone,k=gl.meshes.cylinder,h=this._hover_action;mat4.translate(l,b,[0,1.1,0]);f.setUniform("u_model",l);f.setUniform("u_color",h==d?a.SELECTED_COLOR:e);f.draw(g);this.mode==a.MOVEALL?(mat4.translate(l,l,[0,-0.4,0]),mat4.scale(l,l,[1,1,1])):(mat4.translate(l,l,[0,-0.15,0]),mat4.scale(l,l,[1,0.5,1]));f.setUniform("u_model",l);f.draw(k);this.toScreen(l,
d,[0,0.6,0])};a.prototype.drawAxis=function(b,a){var e=gl.shaders[this.shader],d=gl.meshes.sphere;mat4.scale(l,b,[0.01,100,0.01]);e.setUniform("u_model",l);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);e.setUniform("u_color",[a[0],a[1],a[2],0.2]);gl.depthFunc(gl.GREATER);e.draw(d);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);e.setUniform("u_color",a);e.draw(d);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(b)};a.prototype.drawFlat=
function(b,a,e,f){f=gl.meshes[f||"plane"];var l=gl.shaders[this.shader];mat4.scale(d,b,[0.25,0.25,0.25]);l.setUniform("u_color",a);l.setUniform("u_model",d);gl.enable(gl.BLEND);l.draw(f);gl.disable(gl.BLEND);this.toScreen(d,e)};a.prototype.drawRotator=function(b,a,e){var f=gl.meshes.quartertorus,l=gl.shaders[this.shader];mat4.scale(d,b,[0.9,0.9,0.9]);l.setUniform("u_color",a);l.setUniform("u_model",d);l.draw(f);this.toScreen(d,e,[-0.75,0,0.75])};a.prototype.drawScale=function(b,e,f){var l=gl.meshes.cylinder,
g=gl.meshes.sphere,k=gl.shaders[this.shader];k.setUniform("u_color",e);this.mode==a.SCALEALL?(mat4.translate(d,b,[0,0.5,0]),mat4.scale(d,d,[1,1,1])):(mat4.translate(d,b,[0,0.25,0]),mat4.scale(d,d,[1,0.5,1]));k.setUniform("u_model",d);k.draw(l);mat4.translate(d,b,[0,0.4,0]);this.mode==a.SCALEALL?mat4.scale(d,d,[0.1,0.1,0.1]):mat4.scale(d,d,[0.1,0.2,0.1]);k.setUniform("u_model",d);k.draw(g);this.toScreen(d,f)};a.prototype.drawRotateSphere=function(b,a){var e=gl.shaders[this.shader],f=gl.meshes.sphere;
gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(d,b,[0.9,0.9,0.9]);e.setUniform("u_model",d);e.setUniform("u_color",a);e.draw(f);gl.disable(gl.BLEND)};a.prototype.drawInnerSphere=function(b,e){var f=gl.shaders[this.shader],l=gl.meshes.sphere,g=this._hover_action;mat4.scale(d,b,[0.1,0.1,0.1]);f.setUniform("u_model",d);f.setUniform("u_color",g==e?a.SELECTED_COLOR:a.INNERSPHERE_COLOR);f.draw(l);"drag"==e&&(mat4.scale(d,b,[0.07,0.07,0.07]),f.setUniform("u_model",d),f.setUniform("u_color",
g==e?a.INNERSPHERE_COLOR:[0,0,0,1]),f.draw(l));e&&this.toScreen(d,e)};a.prototype.renderOutline=function(b,e,d,f){if((f=f||this.targets)&&f.length){var l=this.layers;f=f.filter(function(b){return b.layers&l});var g=gl.viewport_data[2],k=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==g&&this._selection_buffer.height==k||(this._selection_buffer=new GL.Texture(g,k,{magFilter:gl.NEAREST}));a.outline_material||(a.outline_material=new RD.Material({shader_name:"flat"}));var h=
this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);b.shader_overwrite=h;var a=b.onNodeShaderUniforms;b.onNodeShaderUniforms=function(b,a){a.setUniform("u_color",[1,1,1,1])};var l=b.pipeline;b.pipeline=null;b.overwrite_material=RD.Gizmo.outline_material;b.render(e,d,f);b.shader_overwrite=null;b.onNodeShaderUniforms=a;b.pipeline=l;b.overwrite_material=null});var m=gl.shaders.outline;m||(m=gl.shaders.outline=GL.Shader.createFX("\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n"));gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(m,{u_color:[1,1,1,1],u_res:[1/g,1/k]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};a.prototype.renderCameraGizmo=function(b,a){this.drawInnerSphere};a.prototype.toScreen=function(b,e,d){e=this.actions[e];mat4.multiplyVec3(e.pos,b,d||[0,0,0]);this._camera.project(e.pos,a.full_viewport,e.pos2D);e.visible=!0};extendClass(a,RD.SceneNode);RD.Gizmo=a})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,prefabs:{},texture_options:{format:GL.RGBA,magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT},load:function(p,a,g,m){function h(b){function a(e){var d=this.buffer;d.data=e;d.dataview=new Uint8Array(e);b.length?
h(b):f()}var e=b.pop(),d=s+"/"+e.uri;console.log(" - loading "+e.uri+" ...");"data:"==e.uri.substr(0,5)?(d=_base64ToArrayBuffer(e.uri.substr(37)),a.call({buffer:e},d)):fetch(d).then(function(b){return b.arrayBuffer()}).then(a.bind({buffer:e}))}function f(){console.log("parsing gltf ...");q.filename=k;q.folder=s;q.url=p;var b=RD.GLTF.parse(q);RD.GLTF.prefabs[p]=b.serialize();a&&a(b)}var q=null,k="",s="";if(p.constructor===String){s=p.split("/");k=s.pop();g=g||k.split(".").pop().toLowerCase();s=s.join("/");
console.log("loading gltf json...");var e=new XMLHttpRequest;e.onload=function(){if(200!=this.status)console.error("GLTF not found",p),a&&a(null);else{var b=e.response;"gltf"==g?(q=b,console.log("loading gltf binaries..."),h(q.buffers.concat())):"glb"==g&&(q=RD.GLTF.parseGLB(b))&&f()}};e.onerror=function(){console.error("Network Error");a&&a(null)};m&&(e.onprogress=function(b){m(p,b.loaded,b.total)});e.responseType="gltf"==g?"json":"arraybuffer";e.open("GET",p);e.send()}else{var d=p;console.log(d);
p=k=d.main;var l=d[k];if("glb"==l.extension)(q=RD.GLTF.parseGLB(l.data))&&f();else{q=l.data;for(l=0;l<q.buffers.length;++l){var b=q.buffers[l];"data:"==b.uri.substr(0,5)?b.data=_base64ToArrayBuffer(b.uri.substr(37)):b.data=d[b.uri].data;b.dataview=new Uint8Array(b.data)}f()}}},parseGLB:function(p){var a=new Uint8Array(p),g=new DataView(p);if(1179937895!=g.getUint32(0,!0))return console.error("incorrect gltf header"),null;var m=g.getUint32(4,!0);console.log("GLTF Version: "+m);g.getUint32(8,!0);for(var m=
12,h=null,f=0;m<a.length;){var q=g.getUint32(m,!0),k=g.getUint32(m+4,!0),s=p.slice(m+8,m+8+q),m=m+(8+q);if(k==RD.GLTF.JSON_CHUNK){if(!("TextDecoder"in window))throw"Sorry, this browser does not support TextDecoder...";h=(new TextDecoder("utf-8")).decode(s);h=JSON.parse(h)}else k==RD.GLTF.BINARY_CHUNK?(q=h.buffers[f],q.data=s,q.dataview=new Uint8Array(s),p.byteLength!=q.byteLength&&console.warn("gltf binary doesnt match json size hint"),f++):console.warn("gltf unknown chunk type: ","0x"+k.toString(16))}return h},
parse:function(p){console.log(p);var a=null,g={};1<p.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var m=p.scenes[p.scene].nodes;this.gltf_materials={};a=null;1<m.length&&(a=new RD.SceneNode,a.name="root");for(var h=0;h<m.length;++h){var f=m[h],q=f;null!=f.node&&(q=f.node);f=RD.GLTF.parseNode(null,q,p);a||(a=f);1<m.length&&a.addChild(f);f.id=p.url.replace(/\//gi,"_")+"::node_"+h;g[f.id]=g[h]=f}if(p.animations&&p.animations.length)if(RD.Animation)for(a.animations=
[],h=0;h<p.animations.length;++h)m=this.parseAnimation(h,p,g),m.id=p.filename+"::"+m.name,m&&(RD.Animations[m.id]=m,a.animations.push(m));else console.error("you must include rendeer-animation.js to allow animations");a.materials=this.gltf_materials;return a},parseNode:function(p,a,g){var m=g.nodes[a];p=p||new RD.SceneNode;for(var h in m){var f=m[h];switch(h){case "name":p.name=f;break;case "translation":p.position=f;break;case "rotation":p.rotation=f;break;case "scale":p.scaling=f;var q=0;0>p.scaling[0]&&
q++;0>p.scaling[1]&&q++;0>p.scaling[2]&&q++;1==q%2&&(p.flags.frontFace=GL.CW);break;case "matrix":p.fromMatrix(f);break;case "mesh":if(f=RD.GLTF.parseMesh(f,g))for(p.mesh=f.name,p.primitives=[],q=0;q<f.info.groups.length;++q){var k=f.info.groups[q],s=null;null!=k.material&&(s=this.parseMaterial(k.material,g));p.primitives.push({index:q,material:s?s.name:null,mode:k.mode})}break;case "skin":p.skin=this.parseSkin(f,g);break;case "children":if(f.length)for(q=0;q<f.length;++q)k=RD.GLTF.parseNode(null,
f[q],g),p.addChild(k);break;case "extras":break;default:console.log("gltf node info ignored:",h,m[h])}}m.name||(m.name=p.name="node_"+a);return p},parseMesh:function(p,a){for(var g=a.meshes[p],m=gl.meshes,h=[],f=[],q=0,k=0;k<g.primitives.length;++k){var s=this.parsePrimitive(g,k,a);s.start=q;q+=s.length;f.push(s);var e={vertexBuffers:{},indexBuffers:{}},d;for(d in s.buffers)"indices"==d||"triangles"==d?e.indexBuffers[d]={data:s.buffers[d]}:e.vertexBuffers[d]={data:s.buffers[d]};h.push({mesh:e})}q=
null;1<h.length?q=GL.Mesh.mergeMeshes(h):(k=h[0].mesh,q=new GL.Mesh(k.vertexBuffers,k.indexBuffers),q.info&&k.info&&(q.info=k.info));for(k=0;k<g.primitives.length;++k)(h=q.info.groups[k])||(q.info.groups[k]=h={}),s=g.primitives[k],h.material=s.material,h.mode=null!=s.mode?s.mode:4,h.start=f[k].start,h.length=f[k].length;q.name=g.name||"mesh_"+p;q.updateBoundingBox();q.computeGroupsBoundingBoxes();return m[q.name]=q},parsePrimitive:function(p,a,g){var m={buffers:{}},h=m.buffers;p=p.primitives[a];if(p.extensions)if(p.extensions.KHR_draco_mesh_compression){if("undefined"==
typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";this.decompressDraco(p)}else throw"mesh data is compressed, this importer does not support it yet";null==!p.attributes.POSITION?console.warn("gltf mesh without positions"):h.vertices=this.parseAccessor(p.attributes.POSITION,g);null!=p.attributes.NORMAL&&(h.normals=this.parseAccessor(p.attributes.NORMAL,g));null!=p.attributes.COLOR_0&&(h.colors=this.parseAccessor(p.attributes.COLOR_0,g));null!=p.attributes.TEXCOORD_0&&
(h.coords=this.parseAccessor(p.attributes.TEXCOORD_0,g,this.flip_uv));null!=p.attributes.TEXCOORD_1&&(h.coords1=this.parseAccessor(p.attributes.TEXCOORD_1,g,this.flip_uv));null!=p.attributes.WEIGHTS_0&&(h.weights=this.parseAccessor(p.attributes.WEIGHTS_0,g));null!=p.attributes.JOINTS_0&&(h.bones=this.parseAccessor(p.attributes.JOINTS_0,g));null!=p.indices&&(h.triangles=this.parseAccessor(p.indices,g));m.mode=p.mode;m.material=p.material;m.start=0;m.length=h.triangles?h.triangles.length:h.vertices.length/
3;return m},decompressDraco:function(p){var a=this;this.decoderModule?inner():"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(g){a.decoderModule=g;new g.Decoder;console.log("Decoder Module Initialized")}):console.error("Draco3D not installed")},decodeBuffer:function(p,a){var g=this.decoderModule,m=new g.DecoderBuffer;m.Init(new Int8Array(p),p.byteLength);a.GetEncodedGeometryType(m);var h=new g.Mesh;a.DecodeBufferToMesh(m,h);g.destroy(m);return h},parseAccessor:function(p,
a,g){var m=a.accessors[p];if(!m)return console.warn("gltf accessor not found"),null;p=this.numComponents[m.type];if(!p)return console.warn("gltf accessor of unknown type:",m.type),null;var h=m.count*p;switch(m.componentType){case RD.GLTF.FLOAT:databuffer=new Float32Array(h);break;case RD.GLTF.UNSIGNED_INT:databuffer=new Uint32Array(h);break;case RD.GLTF.SHORT:databuffer=new Int16Array(h);break;case RD.GLTF.UNSIGNED_SHORT:databuffer=new Uint16Array(h);break;case RD.GLTF.BYTE:databuffer=new Int8Array(h);
break;case RD.GLTF.UNSIGNED_BYTE:databuffer=new Uint8Array(h);break;default:console.warn("gltf accessor of unsupported type: ",m.componentType),databuffer=new Float32Array(h)}h=a.bufferViews[m.bufferView];if(!h)return console.warn("gltf bufferView not found"),null;var f=a.buffers[h.buffer];if(!f||!f.data)return console.warn("gltf buffer not found or data not loaded"),null;if(h.byteStride&&h.byteStride!=p*databuffer.BYTES_PER_ELEMENT)return console.warn("gltf buffer data is not tightly packed, not supported"),
null;a=new Uint8Array(databuffer.buffer);null==h.byteOffset&&(h.byteOffset=0);m=h.byteOffset+(m.byteOffset||0);m=f.dataview.subarray(m,m+a.length);a.set(m);if(g)for(g=1;g<databuffer.length;g+=p)databuffer[g]=1-databuffer[g];return databuffer},parseMaterial:function(p,a){var g=a.materials[p];if(!g)return console.warn("gltf material not found"),null;var m=RD.Materials[g.name];if(m)return m;m=new RD.Material;m.name=g.name;null!=g.alphaMode&&(m.alphaMode=g.alphaMode);m.alphaCutoff=null!=g.alphaCutoff?
g.alphaCutoff:0.5;null!=g.doubleSided&&(m.flags.two_sided=g.doubleSided);m.normalmapFactor=1;if(g.pbrMetallicRoughness){m.model="pbrMetallicRoughness";m.color.set([1,1,1]);m.opacity=1;m.metallicFactor=1;m.roughnessFactor=1;null!=g.pbrMetallicRoughness.baseColorFactor&&(m.color=g.pbrMetallicRoughness.baseColorFactor);if(g.pbrMetallicRoughness.baseColorTexture&&(m.textures.albedo=this.parseTexture(g.pbrMetallicRoughness.baseColorTexture,a),"MASK"==m.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic)){var h=
gl.textures[m.textures.albedo.texture];h&&(h.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8))}null!=g.pbrMetallicRoughness.metallicFactor&&(m.metallicFactor=g.pbrMetallicRoughness.metallicFactor);null!=g.pbrMetallicRoughness.roughnessFactor&&(m.roughnessFactor=g.pbrMetallicRoughness.roughnessFactor);g.pbrMetallicRoughness.metallicRoughnessTexture&&(m.textures.metallicRoughness=this.parseTexture(g.pbrMetallicRoughness.metallicRoughnessTexture,
a))}g.occlusionTexture&&(m.textures.occlusion=this.parseTexture(g.occlusionTexture,a));g.normalTexture&&(m.textures.normal=this.parseTexture(g.normalTexture,a));g.emissiveTexture&&(m.textures.emissive=this.parseTexture(g.emissiveTexture,a));g.emissiveFactor&&(m.emissive=g.emissiveFactor);RD.Materials[m.name]=m;return this.gltf_materials[m.name]=m},parseTexture:function(p,a){var g=a.textures[p.index];if(!g)return console.warn("gltf texture not found"),null;var m=a.images[g.source],h="",f=null;m.uri?
(f=m.uri,f.split(".").pop()):(f=a.url.replace(/[\/\.\:]/gi,"_")+"_image_"+p.index,h=m.mimeType?m.mimeType.split("/").pop():"png",f+="."+h);var q={};if(!gl.textures[f])if(m.uri){var k=m.uri;if("data:"==k.substr(0,5)){var s=m.uri.indexOf(","),e=m.uri.substr(5,s),h=e.split("/").pop().toLowerCase(),f=a.folder+"/"+k+"image_"+p.index+"."+h,h=_base64ToArrayBuffer(m.uri.substr(s+1)),m=URL.createObjectURL(new Blob([h],{type:e})),m=GL.Texture.fromURL(m,this.texture_options);m.name=f;gl.textures[f]=m}else q.texture=
a.folder+"/"+k}else null!=m.bufferView&&(e=a.bufferViews[m.bufferView],null==e.byteOffset&&(e.byteOffset=0),h=a.buffers[e.buffer].data.slice(e.byteOffset,e.byteOffset+e.byteLength),m=URL.createObjectURL(new Blob([h],{type:m.mimeType})),m=GL.Texture.fromURL(m,this.texture_options),m.name=f,gl.textures[f]=m);q.texture||(q.texture=f);null!=g.sampler&&(g=a.samplers[g.sampler],null!=g.magFilter&&(q.magFilter=g.magFilter),null!=g.minFilter&&(q.minFilter=g.minFilter));p.texCoord&&(q.uv_channel=p.texCoord);
return q},parseSkin:function(p,a){var g=a.skins[p],m={};null!=g.skeleton&&(m.skeleton_root=a.nodes[g.skeleton].name);m.bindMatrices=this.splitBuffer(this.parseAccessor(g.inverseBindMatrices,a),16);m.joints=[];for(var h=0;h<g.joints.length;++h)m.joints.push(a.nodes[g.joints[h]].id);return m},splitBuffer:function(p,a){for(var g=p.length,m=[],h=0;h<g;h+=a)m.push(new p.constructor(p.subarray(h,h+a)));return m},parseAnimation:function(p,a,g){g=a.animations[p];var m=new RD.Animation;m.name=g.name||"anim_"+
p;for(var h=p=0;h<g.channels.length;++h){var f=new RD.Animation.Track,q=g.channels[h],k=g.samplers[q.sampler];f.target_node=a.nodes[q.target.node].name;f.target_property=q.target.path.toLowerCase();if(q=this.rename_animation_properties[f.target_property])f.target_property=q;var q=this.parseAccessor(k.input,a),s=this.parseAccessor(k.output,a),e=a.accessors[k.output].type,k=RD.TYPES[e];k==RD.VEC4&&"rotation"==f.target_property&&(k=RD.QUAT);f.type=k;if(k=RD.TYPES_SIZE[k]){for(var e=s.length/k,d=new Float32Array((1+
k)*e),l=0;l<e;++l){d[l*(1+k)]=q[l];var b=s.subarray(l*k,l*k+k);d.set(b,l*(1+k)+1)}f.data=d;f.packed_data=!0;p=Math.max(p,q[q.length-1]);m.addTrack(f)}else console.warn("gltf unknown type:",e)}m.duration=p;return m},loadFromFiles:function(p,a){function g(e){var b=e.target.result,d=this.extension;if("gltf"==d)b=JSON.parse(b),m.main=this.filename;else if("glb"==d)m.main=this.filename;else if("bin"==d)q.push(this.filename);else if("jpeg"==d||"jpg"==d||"png"==d)e=URL.createObjectURL(new Blob([b],{type:e.target.mimeType})),
d=GL.Texture.fromURL(e,{wrap:gl.REPEAT,extension:d}),d.name=this.filename,gl.textures[d.name]=d;m[this.filename]={filename:this.filename,data:b,extension:this.extension};h--;0==h&&(m.binaries=q,f.load(m,function(b){a&&a(b)}))}for(var m={},h=p.length,f=this,q=[],k=0;k<p.length;++k){var s=p[k],e=new FileReader,d=s.name.split("."),d=d[d.length-1].toLowerCase();e.onload=g;e.filename=s.name;e.extension=d;"gltf"==d?e.readAsText(s):e.readAsArrayBuffer(s)}}};
RD.SceneNode.prototype.loadGLTF=function(p,a){function g(f){m.addChild(f);a&&a(m)}var m=this;if(RD.GLTF.prefabs[p]){var h=new RD.SceneNode;h.configure(RD.GLTF.prefabs[p]);g(h)}else RD.GLTF.load(p,g)};function _base64ToArrayBuffer(p){p=window.atob(p);for(var a=p.length,g=new Uint8Array(a),m=0;m<a;m++)g[m]=p.charCodeAt(m);return g.buffer}
(function(p){function a(f){this.renderer=f;this.mode=a.FORWARD;this.fbo=null;this.visible_layers=255;this.bgcolor=vec4.fromValues(0.1,0.1,0.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.brightness=this.contrast=this.emissive_factor=this.occlusion_factor=this.exposure=this.environment_factor=1;this.parallax_reflection=!1;this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=
mat4.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.single_pass=!1;this.use_rendertexture=!0;this.fx=null;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms=
{u_albedo:vec3.fromValues(1,1,1),u_emissive:vec3.fromValues(0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),u_normalFactor:1,u_metallicRough:!1,u_reflectance:0.1,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:0.5,u_isAnisotropic:!1,u_anisotropy:0.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};
this.final_fbo=this.final_texture=null;this.render_calls=[];this.last_num_render_calls=this.num_render_calls=0;this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new m.Material}function g(){this.name="";this.id=-1;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=null;this.reverse_faces=!1;this.node=null;this._render_priority=0}var m=p.RD;
a.FORWARD=1;a.DEFERRED=2;a.MACROS={UVS2:1,COLOR:2,PARALLAX_REFLECTION:4};a.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");a.prototype.render=function(f,g,k,h,e,d){this.renderer=f;this.mode==a.FORWARD?this.renderForward(g,k,e,d):this.mode==a.DEFERRED&&this.renderDeferred(g,k,d);this.getBRDFIntegratorTexture()};a.prototype.fillGlobalUniforms=function(){var a=this.getBRDFIntegratorTexture();a&&a.bind(0);this.environment_texture?(this.environment_texture.bind(1),
this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_exposure=this.exposure;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;
this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3)};a.prototype.renderForward=function(f,g,k,h){var e=Math.floor(gl.viewport_data[2]*this.resolution_factor),d=Math.floor(gl.viewport_data[3]*this.resolution_factor),e=Math.min(e,this.max_texture_size),d=Math.min(d,this.max_texture_size);this.use_rendertexture&&!k&&(this.final_texture&&this.final_texture.width==e&&this.final_texture.height==d||(this.final_texture=new GL.Texture(e,d,{format:gl.RGBA,type:gl.HIGH_PRECISION_FORMAT}),this.final_fbo?
this.final_fbo.setTextures([this.final_texture]):this.final_fbo=new GL.FBO([this.final_texture])),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);this.renderSkybox(g);this.fillGlobalUniforms();if(this.onRenderOpaque)this.onRenderOpaque(this,renderer,g);this.resetRenderCallsPool();for(e=0;e<f.length;++e)this.getNodeRenderCalls(f[e],
g,h);f=this.render_calls.slice(0,this.num_render_calls);for(e=0;e<f.length;++e)f[e].computeRenderPriority(g._position);f=f.sort(a.rc_sort_function);for(e=0;e<f.length;++e)h=f[e],this.renderMeshWithMaterial(h.model,h.mesh,h.material,h.index_buffer_name,h.group_index,h.node.extra_uniforms,h.reverse_faces);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,g);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,g);this.use_rendertexture&&!k&&this.renderFinalBuffer()};a.prototype.renderFinalBuffer=
function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.final_texture,this.final_texture);this.fx_uniforms.u_viewportSize[0]=this.final_texture.width;this.fx_uniforms.u_viewportSize[1]=this.final_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.final_texture.width;this.fx_uniforms.u_iViewportSize[1]=1/this.final_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=this.brightness;this.final_texture.toViewport(gl.shaders.tonemapper,
this.fx_uniforms)};a.prototype.getNodeRenderCalls=function(f,g,k){var h=null;if(f._mesh)h=f._mesh;else if(f.mesh&&(h=gl.meshes[f.mesh],!h))return;void 0===k&&(k=255);f.updateGlobalMatrix(!0);if(h&&!1!==f.flags.visible&&f.layers&k){if(this.test_visibility){a.temp_bbox||(a.temp_bbox=BBox.create(),a.aabb_center=BBox.getCenter(a.temp_bbox),a.aabb_halfsize=BBox.getHalfsize(a.temp_bbox));BBox.transformMat4(a.temp_bbox,h.getBoundingBox(),f._global_matrix);if(g.testBox(a.aabb_center,a.aabb_halfsize)==m.CLIP_OUTSIDE)return;
f._last_rendered_frame=this.renderer.frame}if(f.primitives&&f.primitives.length)for(g=0;g<f.primitives.length;++g){var e=f.primitives[g];k=null;if(k=e.material?m.Materials[e.material]:this.default_material)e=this.getRenderCallFromPool(),e.material=k,e.model=f._global_matrix,e.mesh=h,e.group_index=g,e.node=f,e._render_priority=k.render_priority||0,e.reverse_faces=f.flags.frontFace==GL.CW}else f.material&&(k=m.Materials[f.material])&&(e=this.getRenderCallFromPool(),e.material=k,e.model=f._global_matrix,
e.mesh=h,e.group_index=-1,e.node=f,e._render_priority=k.render_priority||0,e.reverse_faces=f.flags.frontFace==GL.CW)}};a.prototype.groupRenderCallsForInstancing=function(){for(var a={},g=0;g<this.num_render_calls;++g){var k=this.render_calls[g],h=k.mesh.name+":"+k.group_index+"/"+k.material.name+(k.reverse_faces?"[R]":"");a[h]?a[h].push(k):a[h]=[k]}for(g in a)1<a[g].length&&console.log(g,a[g].length)};a.rc_sort_function=function(a,g){return g._render_priority-a._render_priority};a.prototype.setParallaxReflectionTransform=
function(a){this.parallax_reflection_matrix.set(a);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};a.prototype.getShader=function(f,g){var k=this.compiled_shaders[g];k||(k=this.compiled_shaders[g]=new Map);var h=k.get(f);if(h)return h;if(!this.renderer.shader_files)return null;
var h=this.renderer.shader_files["default.vs"],e=this.renderer.shader_files[g],d=null;if(f){var d={},l;for(l in a.MACROS)f&a.MACROS[l]&&(d[l]="")}h=new GL.Shader(h,e,d);k.set(f,h);return h};a.prototype.renderMeshWithMaterial=function(f,g,k,h,e,d,l){var b=this.renderer,n=null;if(!("BLEND"==k.alphaMode&&0>=k.color[3])){var r=this.material_uniforms,p=this.sampler_uniforms;r.u_albedo=k.color.subarray(0,3);r.u_emissive.set(k.emissive||m.ZERO);1!=this.emissive_factor&&vec3.scale(r.u_emissive,r.u_emissive,
this.emissive_factor);n=0;g.vertexBuffers.coords1&&(n|=a.MACROS.UVS2);g.vertexBuffers.colors&&(n|=a.MACROS.COLOR);this.parallax_reflection&&(n|=a.MACROS.PARALLAX_REFLECTION);this.overwrite_shader_name?n=gl.shaders[this.overwrite_shader_name]:"pbrMetallicRoughness"==k.model&&this.quality?(r.u_metalness=k.metallicFactor,r.u_roughness=k.roughnessFactor,r.u_metallicRough=Boolean(k.textures.metallicRoughness),n=this.getShader(n,"pbr.fs")):n=this.getShader(n,"nopbr.fs");if(n){r.u_alpha=k.opacity;r.u_alpha_cutoff=
-1;r.u_normalFactor=null!=k.normalmapFactor?k.normalmapFactor:1;for(var D=2,v=r.u_maps_info,w=0;w<a.maps.length;++w){var t=a.maps[w];v[w]=-1;var y=k.textures[t];if(y){var A=null;y.constructor===Object?A=y.texture:y.constructor===String&&(A=y,y=null);if(A&&(t="u_"+t+"_texture",!n||n.samplers[t])){var C=gl.textures[A];C||(b.autoload_assets&&-1!=A.indexOf(".")&&b.loadTexture(A,b.default_texture_settings),C=gl.textures.white);A=16>this.max_textures?D++:w+2;p[t]=C.bind(A);v[w]=y&&1==y.uv_channel?1:0}}}l||
gl.frontFace(GL.CCW);b.enableItemFlags(k);l&&gl.frontFace(GL.CW);"BLEND"==k.alphaMode?(gl.enable(gl.BLEND),k.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1)):"MASK"==k.alphaMode?r.u_alpha_cutoff=k.alphaCutoff:gl.disable(gl.BLEND);b._uniforms.u_model.set(f);n.uniforms(b._uniforms);n.uniforms(this.global_uniforms);n.uniforms(r);n.uniforms(p);d&&n.uniforms(d);f=null;null!=e&&g.info&&g.info.groups&&g.info.groups[e]&&(f=g.info.groups[e]);k.flags.preAlpha&&
(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),f?n.drawRange(g,k.primitive,f.start,f.length,h):n.draw(g,k.primitive,h),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL));f?n.drawRange(g,k.primitive,f.start,f.length,h):n.draw(g,k.primitive,h);b.disableItemFlags(k);l&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};a.prototype.renderDeferred=function(a,g){};a.prototype.prepareBuffers=function(a){};a.prototype.renderToGBuffers=function(a,g){};a.prototype.renderFinalPass=function(a,g){};a.prototype.applyPostFX=
function(){};a.prototype.getRenderCallFromPool=function(){if(this.num_render_calls<this.render_calls.length){var a=this.render_calls[this.num_render_calls];this.num_render_calls++;return a}a=new m.RenderCall;a.id=this.num_render_calls;this.render_calls.push(a);this.num_render_calls++;return a};a.prototype.resetRenderCallsPool=function(){this.last_num_render_calls=this.num_render_calls;this.num_render_calls=0};a.prototype.renderSkybox=function(a){if((!this.onRenderSkybox||!this.onRenderSkybox(this,
a))&&this.environment_texture&&this.render_skybox){var g=gl.meshes.cube,k=gl.shaders[this.overwrite_shader_name||"skybox"];if(k){var h=this.skybox_texture||this.environment_texture;if(h){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var e=this.renderer._model_matrix;mat4.identity(e);mat4.translate(e,e,a.position);mat4.scale(e,e,[10,10,10]);this.renderer.setModelMatrix(e);k.uniforms(this.renderer._uniforms);k.uniforms({u_color_texture:h.bind(0),u_is_rgbe:!1,u_exposure:this.exposure,
u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD,u_camera_position:a.position});k.draw(g,GL.TRIANGLES)}}}};a.prototype.loadEnvironment=function(a,g,k){var h=this,e=gl.textures[a];e?(k?h.skybox_texture=e:(e.shs&&(h.environment_sh_coeffs=e.shs),h.environment_texture=e),g&&g(e)):HDRE.load(a,function(e){var l=e.toTexture(!0);l&&(gl.textures[a]=l,k?h.skybox_texture=l:(l.shs=e.shs?e.shs:null,h.environment_texture=l,l.shs&&(h.environment_sh_coeffs=l.shs)));g&&g(l)})};a.prototype.captureEnvironment=
function(a,g,k){k=k||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(k,k,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));var h=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,a,g);this.use_rendertexture=h;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);this.environment_texture||(this.environment_texture=
new GL.Texture(k,k,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};a.prototype.getBRDFIntegratorTexture=function(a){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var g=gl.shaders.brdf_integrator;if(g){var k=gl.textures.brdf_integrator=new GL.Texture(128,128,{type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});if(a)return fetch(a).then(function(a){return a.arrayBuffer()}).then(function(a){k.uploadData(new Float32Array(a),
{no_flip:!0})}),k;var h=gl.textures.hammersley_sample_texture;h||(h=this.createHammersleySampleTexture());k.drawTo(function(a){h&&h.bind(0);g.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return k}};a.prototype.createHammersleySampleTexture=function(a){a=a||8192;for(var g=3*a,k=new Float32Array(g),h=0;h<g;h+=3){var e=2*Math.radical_inverse(h)*Math.PI;k[h]=Math.cos(e);k[h+1]=Math.sin(e);k[h+2]=0}a=new GL.Texture(a,1,{pixel_data:k,type:GL.FLOAT,format:GL.RGB});
return gl.textures.hammersley_sample_texture=a};a.prototype.setClippingPlane=function(a,g){a?this.global_uniforms.u_clipping_plane.set([g[0],g[1],g[2],vec3.dot(a,g)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};Math.radical_inverse=function(a){for(var g=0,h=0.5;a;h*=0.5,a>>=1)a&1&&(g+=h);return g};var h=vec3.create();g.prototype.computeRenderPriority=function(a){this.name=this.node.name;var g=this.mesh.getBoundingBox();g&&(g=mat4.multiplyVec3(h,this.model,g),this._render_priority=this.material.priority||
0,this._render_priority+=0.001*vec3.distance(a,g),"BLEND"==this.material.alphaMode&&(this._render_priority-=100))};m.PBRPipeline=a;m.RenderCall=g})(this);
(function(p){function a(){this.intensity=1;this._color=vec3.fromValues(0.9,0.9,0.9);this._position=vec3.fromValues(10,20,5);this._target=vec3.create();this._vector=vec3.create();this.camera=new RD.Camera;this._castShadows=!1;this.shadowmap={texture:null,resolution:2048,bias:5E-6,uniforms:{u_shadowmap_matrix:this.camera._viewprojection_matrix,u_shadowmap_texture:4,u_shadowbias:1E-5}};this.uniforms={u_light_position:this._position,u_light_color:vec3.create(),u_light_vector:this._vector};this.flags=
{skip_shadows:!1}}Object.defineProperty(a.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});Object.defineProperty(a.prototype,"castShadows",{set:function(a){a?this.enableShadows():this.disableShadows()},get:function(){return this._castShadows},enumerable:!0});a.DEFAULT_SHADOWMAP_RESOLUTION=2048;a.prototype.updateData=function(){vec3.sub(this._vector,this._target,this._position);vec3.normalize(this._vector,this._vector)};a.prototype.setUniforms=
function(a){this.shadowmap.uniforms.u_shadowbias=this.shadowmap.bias;this.uniforms.u_light_color.set(this._color);vec3.scale(this.uniforms.u_light_color,this.uniforms.u_light_color,this.intensity);if(a.constructor===GL.Shader)a.uniforms(this.uniforms),this._castShadows&&(a.uniforms(this.shadowmap.uniforms),this.shadowmap.texture.bind(this.shadowmap.uniforms.u_shadowmap_texture));else{for(var m in this.uniforms)a[m]=this.uniforms[m];if(this._castShadows)for(m in this.shadowmap.uniforms)a[m]=this.shadowmap.uniforms[m]}};
a.prototype.lookAt=function(a,m,h){this._position.set(a);this._target.set(m);this.camera.lookAt(a,m,h);this.updateData()};a.prototype.setView=function(a,m,h){this.camera.orthographic(a,m,h,1);this.updateData()};a.prototype.followCamera=function(a,m){var h=m||5,f=vec3.scaleAndAdd(vec3.create(),a.target,this._vector,-m);this.lookAt(f,a.target,a.up);this.camera.orthographic(h,0.01,3*h,1);this.camera.updateMatrices()};a.prototype.enableShadows=function(){this._castShadows=!0;var g=this.shadowmap.resolution||
a.DEFAULT_SHADOWMAP_RESOLUTION;this.shadowmap.texture&&this.shadowmap.texture.width==g||(this.shadowmap.texture=new GL.Texture(g,g,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadowmap.fbo=new GL.FBO(null,this.shadowmap.texture))};a.prototype.disableShadows=function(){this._castShadows=!1;this.shadowmap.texture=null;this.shadowmap.fbo=null};a.prototype.generateShadowmap=function(a,m,h){if(this.castShadows){if(!this.shadowmap.fbo)throw"no shadowmap fbo";a.generating_shadowmap=
!0;this.shadowmap.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);a.shader_overwrite="flat";if(m.constructor===Array)for(var f=0;f<m.length;++f)a.render(m[f],this.camera,null,h||255);else a.render(m,this.camera,null,h||255);a.shader_overwrite=null;this.shadowmap.fbo.unbind();a.generating_shadowmap=!1;this.shadowmap.texture.bind(4)}};a.prototype.renderNode=function(a,m){gl.meshes.cylinder_light||(gl.meshes.cylinder_light=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone_light=GL.Mesh.cone({radius:0.1,
height:0.25}))};RD.Light=a})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(p){function a(){this.name="";this.tracks=[];this.duration=10}function g(){this.enabled=!0;this.target_property=this.target_node="";this.type=k.SCALAR;this.data=[];this.packed_data=!1;this._target=null}function m(a,d,l){return a*(1-l)+d*l}function h(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function f(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function q(){this.skeleton=
new h;this.duration=0;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this.bones_map=new Uint8Array(64);this.keyframes=null}var k=p.RD;k.Animations={};a.prototype.addTrack=function(a,d){if(d)for(var l=0;l<this.tracks.length;++l)if(this.tracks[l].target_node==a.target_node){this.tracks.splice(l+1,0,a);return}this.tracks.push(a)};a.prototype.applyAnimation=function(a,d,l){for(var b=0;b<this.tracks.length;++b)this.tracks[b].applyTrack(a,d,l)};a.prototype.serialize=function(){for(var a=
{name:this.name,duration:this.duration,tracks:[]},d=0;d<this.tracks.length;++d)a.tracks.push(this.tracks[d].serialize());return a};a.prototype.configure=function(a){this.name=a.name;this.duration=a.duration;for(var d=this.tracks.length=0;d<a.tracks.length;++d){var l=new k.Animation.Track;l.configure(a.tracks[d]);this.tracks.push(l)}return a};a.prototype.findNearestLeft=function(a){for(var d=0,l=0;l<this.tracks.length;++l){var b=this.tracks[l],n=b.findTimeIndex(a);-1!=n&&(b=b.data[n],b>d&&(d=b))}return d};
a.prototype.findNearestRight=function(a){for(var d=this.duration,l=0;l<this.tracks.length;++l){var b=this.tracks[l],n=b.findTimeIndex(a);-1!=n&&(b=b.data[n+1],null!=b&&b<d&&(d=b))}return d};k.Animation=a;a.Track=g;Object.defineProperty(g.prototype,"value_size",{set:function(a){throw"cannot be set, use type instead";},get:function(){return k.TYPES_SIZE[this.type]}});g.prototype.addKeyframe=function(a,d,l){1<this.value_size&&(d=new Float32Array(d));for(var b=0;b<this.data.length;++b)if(!(this.data[b][0]<
a))return this.data[b][0]!=a||l?this.data.splice(b,0,[a,d]):this.data[b][1]=d,b;this.data.push([a,d]);return this.data.length-1};g.prototype.getKeyframe=function(a){if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),null;var d=k.TYPES_SIZE[this.type];return this.packed_data?(a*=1+d,a>this.data.length-d?null:[this.data[a],this.data.subarray(a+1,a+d+1)]):this.data[a]};g.prototype.findTimeIndex=function(a){var d=this.data;if(!d||0==d.length)return-1;var l=k.TYPES_SIZE[this.type];
if(this.packed_data){var l=l+1,b=d.length/l,n=0,g=0,f=b;if(0==b)return-1;if(1==b)return 0;if(d[(f-1)*l]<a)return f-1;for(;f>=n;){g=0.5*(f+n)|0;b=d[g*l];if(b==a)break;if(n==f-1)return n;b<a?n=g:f=g}return g}b=d.length;g=n=0;f=b;if(0==b)return-1;if(1==b)return 0;if(d[f-1][0]<a)return f-1;for(;f>=n;){g=0.5*(f+n)|0;b=d[g][0];if(b==a)break;if(n==f-1)return n;b<a?n=g:f=g}return g};g.prototype.getSample=function(a,d,l){return this.data&&0!==this.data.length?this.packed_data?this.getSamplePacked(a,d,l):this.getSampleUnpacked(a,
d,l):void 0};g.prototype.getSampleUnpacked=function(a,d,l){var b=k.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-1][0]);var f=this.findTimeIndex(a);-1===f&&(f=0);var g=f,h=f+1,m=this.data,b=k.TYPES_SIZE[this.type];if(!d||0==b||1==m.length||h==m.length||0==g&&this.data[0][0]>a)return this.data[f][1];g=m[g];h=m[h];a=(h[0]-a)/(h[0]-g[0]);1<b&&(l=l||this._result,l&&l.length==b||(l=this._result=new Float32Array(b)));if(d===k.LINEAR)return 1==b?g[1]*a+h[1]*(1-a):k.interpolateLinear(g[1],
h[1],a,l,this.type,b,this);if(d===k.CUBIC){d=0<f?m[f-1]:g;f=f<m.length-2?m[f+2]:h;if(1===b)return k.EvaluateHermiteSpline(g[1],h[1],d[1],f[1],1-a);l=k.EvaluateHermiteSplineVector(g[1],h[1],d[1],f[1],1-a,l);this.type==k.QUAT?(quat.slerp(l,h[1],g[1],a),quat.normalize(l,l)):this.type==k.TRANS10&&(b=l.subarray(3,7),g=g[1].subarray(3,7),h=h[1].subarray(3,7),quat.slerp(b,h,g,a),quat.normalize(b,b));return l}return null};g.prototype.getSamplePacked=function(a,d,f){if(!this.data.length)return null;var b=
k.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-b-1]);var g=this.findTimeIndex(a);-1==g&&(g=0);var h=b+1,m=g,p=g+1,q=this.data,s=q.length/h;if(!d||1==s||p==s||0==m&&this.data[0]>a)return this.getKeyframe(g)[1];1<b&&(f=f||this._result,f&&f.length==b||(f=this._result=new Float32Array(b)));var t=q.subarray(m*h,(m+1)*h),m=q.subarray(p*h,(p+1)*h);a=(m[0]-a)/(m[0]-t[0]);if(d===k.LINEAR){if(1==b)return t[1]*a+m[1]*(1-a);h=t.subarray(1,b+1);m=m.subarray(1,b+1);return k.interpolateLinear(h,
m,a,f,this.type,b,this)}if(d===k.CUBIC){if(0===b)return t[1];d=0<g?q.subarray((g-1)*h,g*h):t;p=p<s-1?q.subarray((p+1)*h,(p+2)*h):m;if(1===b)return k.EvaluateHermiteSpline(t[1],m[1],d[1],p[1],1-a);b=t.subarray(1,h);m=m.subarray(1,h);f=k.EvaluateHermiteSplineVector(b,m,d.subarray(1,h),p.subarray(1,h),1-a,f);this.type==k.QUAT?(quat.slerp(f,m,b,a),quat.normalize(f,f)):this.type==k.TRANS10&&(h=f.subarray(3,7),b=b.subarray(3,7),m=m.subarray(3,7),quat.slerp(h,m,b,a),quat.normalize(h,h));return f}return null};
g.prototype.applyTrack=function(a,d,f){if(a)return d=this.getSample(d,f),a.constructor===k.SceneNode?(f=null,(f=a.name==this.target_node?a:a.findNodeByName(this.target_node))&&(f[this.target_property]=d)):a.constructor===k.Skeleton&&(a=a.getBone(this.target_node))&&this.type==k.MAT4&&a.model.set(d),d};g.prototype.serialize=function(){return{enabled:this.enabled,target_node:this.target_node,target_property:this.target_property,type:this.type,data:this.data.concat(),packed_data:this.packed_data}};g.prototype.configure=
function(a){this.enabled=a.enabled;this.target_node=a.target_node;this.target_property=a.target_property;if(a.property){var d=a.property.indexOf("/");this.target_node=a.property.substr(0,d);this.target_property=a.property.substr(d+1)}null!=a.type&&(this.type=a.type.constructor===String?k.TYPES[a.type.toUpperCase()]||0:a.type);this.data=a.data.concat?a.data.concat():new a.data.constructor(a.data);this.packed_data=a.packed_data?a.packed_data:this.data.constructor!==Array};k.interpolateLinear=function(a,
d,f,b,g,h,m){if(1==h)return a*f+d*(1-f);b=b||m._result;b&&b.length==h||(b=m._result=new Float32Array(h));switch(g){case k.QUAT:quat.slerp(b,d,a,f);quat.normalize(b,b);break;case k.TRANS10:for(g=0;3>g;g++)b[g]=a[g]*f+d[g]*(1-f);for(g=7;10>g;g++)b[g]=a[g]*f+d[g]*(1-f);a=a.subarray(3,7);d=d.subarray(3,7);h=b.subarray(3,7);quat.slerp(h,d,a,f);quat.normalize(h,h);break;default:for(g=0;g<h;g++)b[g]=a[g]*f+d[g]*(1-f)}return b};k.EvaluateHermiteSpline=function(a,d,f,b,g){var h=g*g,k=h*g;return(2*k-3*h+1)*
a+(-2*k+3*h)*d+(k-2*h+g)*(d-f)+(k-h)*(b-a)};k.EvaluateHermiteSplineVector=function(a,d,g,b,f,h){h=h||new Float32Array(h.length);var k=f*f,m=k*f,p=2*m-3*k+1,q=-2*m+3*k;f=m-2*k+f;for(var k=m-k,m=0,s=h.length;m<s;++m)h[m]=p*a[m]+q*d[m]+f*(d[m]-g[m])+k*(b[m]-a[m]);return h};Math.lerp||(Math.lerp=m);k.Skeleton=h;h.Bone=f;f.prototype.serialize=function(){return{name:this.name,model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,
this.num_children)):null}};f.prototype.configure=function(a){this.name=a.name;this.model.set(a.model);this.parent=a.parent;this.layer=a.layer;this.num_children=0;this.index=null!=a.index?a.index:-1;a.children&&(this.children.set(a.children),this.num_children=a.children.constructor===Array?a.children.length:a.num_children)};f.prototype.copyFrom=f.prototype.configure;h.prototype.applyTransformToBones=function(a,d){var f=this.getBone(a);f&&mat4.multiply(f.model,f.model,d)};h.prototype.getBone=function(a){return this.bones[this.bones_by_name.get(a)]};
h.identity=mat4.create();h.prototype.getBoneMatrix=function(a,d){void 0===d&&(d=!0);var f=this.bones_by_name.get(a);return void 0===f?h.identity:d?this.bones[f].model:this.global_bone_matrices[f]};h.prototype.importSkeleton=function(a){function d(a){var e=new f;e.name=a.name||a.id;e.model.set(a.model);e.index=g.length;g.push(e);b.bones_by_name.set(e.name,e.index);b.global_bone_matrices.push(mat4.create());if(a.children&&a.children.length){e.num_children=a.children.length;for(var h=0;h<a.children.length;++h){var k=
d(a.children[h]);e.children[h]=k.index;k.parent=e.index}}return e}var g=this.bones=[],b=this;d(a);this.updateGlobalMatrices()};h.temp_mat4=mat4.create();h.temp_mat43=h.temp_mat4.subarray(0,12);h.prototype.computeFinalBoneMatrices=function(a,d,f){if(!this.bones.length||!d||!d.bones)return a||[];this.updateGlobalMatrices();var b=f?12*d.bones.length:16*d.bones.length;a&&a.length==b||(a=new Float32Array(b));if(f){var g=h.temp_mat4,g=h.temp_mat43;for(f=0;f<d.bones.length;++f)b=d.bones[f],mat4.multiply(temp_mat4,
this.getBoneMatrix(b[0],!1),b[1]),mat4.transpose(temp_mat4,temp_mat4),a.set(g,12*f)}else for(f=0;f<d.bones.length;++f)b=d.bones[f],g=a.subarray(16*f,16*f+16),mat4.multiply(g,this.getBoneMatrix(b[0],!1),b[1]);return a};h.prototype.computeFinalBoneMatricesAsArray=function(a,d,f){if(!this.bones.length||!d||!d.bones)return a||[];this.updateGlobalMatrices();a=a||[];a.length=d.bones.length;for(var b=0;b<d.bones.length;++b){var g=d.bones[b];a[b]||(a[b]=mat4.create());var h=a[b];mat4.multiply(h,this.getBoneMatrix(g[0],
!1),g[1]);d.bind_matrix&&mat4.multiply(h,h,d.bind_matrix);f&&mat4.multiply(h,f,h)}return a};h.prototype.updateGlobalMatrices=function(){var a=this.bones;if(a.length){var d=this.bones.length;this.global_bone_matrices[0].set(a[0].model);for(var f=1;f<d;++f){var b=a[f];mat4.multiply(this.global_bone_matrices[f],this.global_bone_matrices[b.parent],b.model)}}};h.prototype.assignLayer=function(a,d){};h.prototype.applyTracksAnimation=function(a,d){for(var f=0;f<a.tracks.length;++f){var b=a.tracks[f],g=this.bones_by_name.get(b.target_node);
null!=g&&(g=this.bones[g],"model"!=b.target_property&&"matrix"!=b.target_property||b.getSample(d,k.LINEAR,g.model))}};h.prototype.getVertices=function(a){if(!this.bones.length)return null;var d=6*(this.bones.length-1);this._vertices&&this._vertices.length==d||(this._vertices=new Float32Array(d));for(var d=this._vertices,f=0,b=1;b<this.bones.length;++b){var g=this.global_bone_matrices[this.bones[b].parent],h=this.global_bone_matrices[b],k=d.subarray(f,f+3),m=d.subarray(f+3,f+6);mat4.getTranslation(k,
h);mat4.getTranslation(m,g);a&&(vec3.transformMat4(k,k,a),vec3.transformMat4(m,m,a));f+=6}return d};h.prototype.resizeBones=function(a){if(this.bones.length!=a)if(this.bones.length>a)this.bones.length=a,this.global_bone_matrices.length=a;else{var d=this.bones.length;for(this.bones.length=a;d<a;++d)this.bones[d]=new f,this.global_bone_matrices[d]=mat4.create()}};h.prototype.copyFrom=function(a){this.resizeBones(a.bones.length);for(var d=0;d<a.bones.length;++d)this.bones[d].copyFrom(a.bones[d]),this.global_bone_matrices[d].set(a.global_bone_matrices[d]);
this.bones_by_name=new Map(a.bones_by_name)};h.prototype.serialize=function(){for(var a={bones:[],bone_names:{}},d=0;d<this.bones.length;++d)a.bones.push(this.bones[d].serialize());return a};h.prototype.configure=function(a){this.resizeBones(a.bones.length);a.bones_by_name?this.bones_by_name=new Map(a.bones_by_name):this.bones_by_name.clear();for(var d=0;d<a.bones.length;++d){var f=this.bones[d];f.copyFrom(a.bones[d]);f.index=d;a.global_bone_matrices?this.global_bone_matrices[d].set(a.global_bone_matrices[d]):
this.bones_by_name.set(this.bones[d].name,d)}};var s=vec3.create();h.blend=function(a,d,f,b,g,k){if(a.bones.length!=d.bones.length)console.error("skeleton must contain the same number of bones");else{f=Math.clamp(f,0,1);if(255==g){if(0==f){if(b==a)return;b.copyFrom(a);return}if(1==f){b.copyFrom(d);return}}if(b!=a){b.bones.length=a.bones.length;for(g=0;g<b.bones.length;++g)(d=b.bones[g])||(d=new h.Bone),d.copyFrom(a.bones[g]);b.bones_by_name=new Map(a.bones_by_name)}for(g=0;g<b.bones.length;++g){for(var m=
b.bones[g],p=a.bones[g],q=d.bones[g],w=0;16>w;++w)m.model[w]=Math.lerp(p.model[w],q.model[w],f);if(!k)for(m=m.model,w=0;3>w;++w)s[0]=m[0+w],s[1]=m[4+w],s[2]=m[8+w],vec3.normalize(s,s),m[0+w]=s[0],m[4+w]=s[1],m[8+w]=s[2]}}};h.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
h.vertex_shader_code="\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\t\n\tvarying vec3 v_wPosition;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\t\n\tuniform mat4 u_viewprojection;\n\tuniform mat4 u_model;\n\tuniform mat4 u_normal_matrix;\n\t\n\t"+h.shader_code+"\n\t\n\tvoid main() {\n\t\tv_wPosition = a_vertex;\n\t\tv_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;\n\t\tv_coord = a_coord;\n\t\t\n\t\tcomputeSkinning( v_wPosition, v_wNormal);\n\t\t\n\t\tv_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;\n\t\t\n\t\tgl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );\n\t}\n";
k.SkeletalAnimation=q;q.prototype.load=function(a,d){var f=this;return HttpRequest(a,null,function(a){f.fromData(a);d&&d(f)})};q.prototype.assignTime=function(a,d,f,b){if(this.duration&&this.samples_per_second){d||void 0===d?(a%=this.duration,0>a&&(a=this.duration+a)):a=Math.clamp(a,0,this.duration-1/this.samples_per_second);void 0===f&&(f=!0);a*=this.samples_per_second;var g=Math.floor(a),h=(g+1)%this.num_keyframes,g=g%this.num_keyframes;a-=Math.floor(a);d=this.num_animated_bones;b=16*d;for(var g=
g*b,h=h*b,k=this.skeleton,p=this.keyframes,q=this.bones_map,s=0;s<d;++s){var t=k.bones[q[s]];if(!t)throw"bone not found in skeleton";b=16*s;if(f)for(var y=0;16>y;++y)t.model[y]=m(p[g+b+y],p[h+b+y],a);else t.model.set(p.subarray(g+b,g+b+16))}}};q.prototype.resize=function(a,d){this.num_keyframes=Math.floor(a);this.num_animated_bones=d;this.keyframes=new Float32Array(a*d*16)};q.prototype.assignPoseToKeyframe=function(a,d){if(d>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";
for(var f=d*this.num_animated_bones*16,b=0;b<this.num_animated_bones;++b){var g=a.bones[this.bones_map[b]];null!=g&&this.keyframes.set(g.model,f+16*b)}};q.prototype.fromData=function(a){a=a.split("\n");var d=a[0].split(",");this.duration=Number(d[0]);this.samples_per_second=Number(d[1]);this.num_keyframes=Number(d[2]);this.skeleton.resizeBones(Number(d[3]));for(var d=0,f=1;f<a.length;++f){var b=a[f],g=b[0],b=b.substr(1).split(",");if("B"==g){var h=Number(b[0]),k=this.skeleton.bones[h];if(!k)throw"bone not found in skeleton";
k.name=b[1];k.parent=Number(b[2]);for(g=0;16>g;++g)k.model[g]=Number(b[3+g]);-1!=k.parent&&(b=this.skeleton.bones[k.parent],16<=b.num_children?console.warn("too many child bones, max is 16"):b.children[b.num_children++]=h);this.skeleton.bones_by_name.set(k.name,h)}else if("@"==g){this.num_animated_bones=Number(b[0]);for(g=0;g<this.num_animated_bones;++g)this.bones_map[g]=Number(b[g+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==g){h=d*this.num_animated_bones*16;g=0;for(k=
16*this.num_animated_bones;g<k;++g)this.keyframes[h+g]=Number(b[g+1]);d++}else break}this.assignTime(0,!1,!1)};q.prototype.toData=function(){var a=[];a.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());for(var d=this.skeleton.bones,f=0;f<d.length;++f){var b=d[f];a.push("B"+f+","+b.name+","+b.parent+","+typedArrayToArray(b.model))}d=[];for(f=0;f<this.num_animated_bones;++f)d.push(this.bones_map[f]);a.push("@"+d.length+","+d.join(","));d=1/
this.samples_per_second;for(f=0;f<this.num_keyframes;++f){for(var b=16*f*this.num_animated_bones,b=this.keyframes.subarray(b,b+16*this.num_animated_bones),g=0;g<b.length;++g)1E-6>Math.abs(b[g])&&(b[g]=0);a.push("K"+(f*d).toFixed(3)+","+b.join(","))}return a.join("\n")};q.prototype.fromTracksAnimation=function(a,d,f){this.duration=d.duration;this.samples_per_second=f;this.skeleton.copyFrom(a);for(var b=0,g=0;g<d.tracks.length;++g){var h=a.bones_by_name.get(d.tracks[g].target_node);null!=h&&(this.bones_map[b]=
h,b++)}this.resize(Math.floor(d.duration*f),b);for(g=0;g<this.num_keyframes;++g)this.skeleton.applyTracksAnimation(d,1/f*g),this.assignPoseToKeyframe(this.skeleton,g)};k.SceneNode&&(k.SceneNode.prototype.assignAnimation=function(a){this.skeleton=a.skeleton;var d=gl.meshes[this.mesh];d&&(this.bones=a.skeleton.computeFinalBoneMatrices(this.bones,d),this.uniforms.u_bones=this.bones)})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
