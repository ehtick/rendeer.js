(function(x){function d(a){this.type=h.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();
this._right=vec3.create();this._front=vec3.create();this.uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection_matrix:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(.1,1E3)};a&&this.fromJSON(a);this.updateMatrices()}function A(){this._root=new h.SceneNode;this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=
this.time=0}function v(a,b){b=b||{};var f=this.gl=this.context=a;if(!f||!f.enable)throw"litegl GL context not found.";a!=x.gl&&f.makeCurrent();this.point_size=5;this.layers_affect_children=this.disable_cull_face=this.reverse_normals=this.sort_by_distance=!1;this.light_model="flat";this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._texture_matrix=
mat3.create();this._color=vec4.fromValues(1,1,1,1);this._viewprojection2D_matrix=mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_color:this._color,u_texture_matrix:this._texture_matrix};this.global_uniforms_containers=[this._uniforms];this.ambient_light=vec3.fromValues(.6,.67,.8);this.light_color=vec3.fromValues(.5,.4,.3);this.light_vector=vec3.fromValues(.5442,
.6385,.544);this._phong_uniforms={u_ambient:this.ambient_light,u_light_vector:this.light_vector,u_light_color:this.light_color};x.gl=this.gl;this.canvas=f.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:f.REPEAT,minFilter:f.LINEAR_MIPMAP_LINEAR,magFilter:f.LINEAR};this.default_cubemap_settings={minFilter:f.LINEAR_MIPMAP_LINEAR,magFilter:f.LINEAR,is_cross:1};this.default_material=new h.Material;this.meshes.plane=
GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:f.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:f.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.num_assets_loading=
0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;b.ignore_shaders||this.createShaders();b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}function u(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();a&&this.origin.set(a);b&&this.direction.set(b)}function m(a){this._ctor();a&&this.fromJSON(a)}function q(a){F.prototype._ctor.call(this,a);this._ctor();a&&this.fromJSON(a)}function n(a,b){return vec3.dot(a,
b)+a[3]}function z(a,b,f){var r=a[3];f=Math.abs(f[0]*a[0])+Math.abs(f[1]*a[1])+Math.abs(f[2]*a[2]);a=vec3.dot(a,b)+r;return a<=-f?H:a<=f?L:E}var h=x.RD={version:.5};h.ZERO=vec3.fromValues(0,0,0);h.ONE=vec3.fromValues(1,1,1);h.RIGHT=vec3.fromValues(1,0,0);h.LEFT=vec3.fromValues(-1,0,0);h.UP=vec3.fromValues(0,1,0);h.DOWN=vec3.fromValues(0,-1,0);h.FRONT=vec3.fromValues(0,0,-1);h.BACK=vec3.fromValues(0,0,1);h.FRONT2D=vec2.fromValues(0,1);h.WHITE=vec3.fromValues(1,1,1);h.BLACK=vec3.fromValues(0,0,0);h.IDENTITY=
mat4.create();h.ONES4=vec4.fromValues(1,1,1,1);h.TRANS10_IDENTITY=new Float32Array([0,0,0,0,0,0,1,1,1,1]);h.CENTER=0;h.TOP_LEFT=1;h.TOP_RIGHT=2;h.BOTTOM_LEFT=3;h.BOTTOM_RIGHT=4;h.TOP_CENTER=5;h.BOTTOM_CENTER=6;h.PRIORITY_BACKGROUND=30;h.PRIORITY_OPAQUE=20;h.PRIORITY_ALPHA=10;h.PRIORITY_HUD=0;h.BLEND_NONE=0;h.BLEND_ALPHA=1;h.BLEND_ADD=2;h.BLEND_MULTIPLY=3;h.NO_BILLBOARD=0;h.BILLBOARD_SPHERIC=1;h.BILLBOARD_PARALLEL_SPHERIC=2;h.BILLBOARD_CYLINDRIC=3;h.BILLBOARD_PARALLEL_CYLINDRIC=4;h.UNKNOWN=0;h.NUMBER=
h.SCALAR=1;h.VEC2=2;h.VEC3=3;h.VEC4=4;h.QUAT=5;h.MAT3=6;h.TRANS10=7;h.MAT4=8;h.STRING=9;h.TYPES={NUMBER:h.NUMBER,SCALAR:h.NUMBER,VEC2:h.VEC2,VEC3:h.VEC3,VEC4:h.VEC4,QUAT:h.QUAT,MAT3:h.MAT3,TRANS10:h.TRANS10,MAT4:h.MAT4,STRING:h.STRING};h.TYPES_SIZE=[0,1,2,3,4,4,9,10,16,0];h.NO_INTERPOLATION=0;h.LINEAR=1;h.CUBIC=2;var c=h.DEG2RAD=.0174532925;h.RAD2DEG=57.295779578552306;h.Materials={};h.Images={};h.setup=function(a){a=a||{};if(h.configuration)throw"already called setup";h.configuration=a};var k=0;
"undefined"==typeof extendClass&&(x.extendClass=function(a,b){for(var f in b)a.hasOwnProperty(f)||(a[f]=b[f]);if(b.prototype){var r=Object.getOwnPropertyNames(b.prototype);for(f=0;f<r.length;++f){var l=r[f];a.prototype.hasOwnProperty(l)||(b.prototype.__lookupGetter__(l)?a.prototype.__defineGetter__(l,b.prototype.__lookupGetter__(l)):a.prototype[l]=b.prototype[l],b.prototype.__lookupSetter__(l)&&a.prototype.__defineSetter__(l,b.prototype.__lookupSetter__(l)))}}a.hasOwnProperty("superclass")||Object.defineProperty(a,
"superclass",{get:function(){return b},enumerable:!1})});var e=mat4.create(),g=mat3.create(),p=mat4.create(),w=vec2.create(),t=vec3.create(),y=vec3.create();vec4.create();var J=quat.create();class F{set id(a){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=a}get id(){return this._id}get position(){return this._position}set position(a){this._position.set(a);this._must_update_matrix=!0}get x(){return this._position[0]}set x(a){this._position[0]=a;this._must_update_matrix=
!0}get y(){return this._position[1]}set y(a){this._position[1]=a;this._must_update_matrix=!0}get z(){return this._position[2]}set z(a){this._position[2]=a;this._must_update_matrix=!0}get rotation(){return this._rotation}set rotation(a){this._rotation.set(a);this._must_update_matrix=!0}get scaling(){return this._scale}set scaling(a){a.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=a:this._scale.set(a);this._must_update_matrix=!0}get transform(){return this._transform}set transform(a){this._transform.set(a);
quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0}get matrix(){return this._local_matrix}set matrix(a){this.fromMatrix(a)}get pivot(){return this._pivot}set pivot(a){this._must_update_matrix=!0;a?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(a),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)}set color(a){if(this.material){var b=this.getMaterial();b&&(b.color=a)}else console.warn("cannot set color of node without material")}get color(){var a=this.getMaterial();
a&&a.color;console.warn("cannot get color of node without material");return null}get mustUpdate(){return this._must_update_matrix}set mustUpdate(a){a&&(this._must_update_matrix=!0)}get visible(){return this.flags.visible}set visible(a){this.flags.visible=a}get scene(){return this._scene}set scene(a){throw"cannot set scene, you must use addChild in its parent node";}get parentNode(){return this._parent}set parentNode(a){throw"Cannot set parentNode of SceneNode, use addChild on parent";}constructor(a){if(this.constructor!==
h.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();a&&this.fromJSON(a)}_ctor(){this._uid=k++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,10);quat.identity(this._rotation);this._scale.set(h.ONE);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.layers=3;this.draw_range=this._instances=
null;this.primitives=[];this.material=this.mesh=null;this.flags={visible:!0,collides:!0};this._parent=null;this.children=[]}clone(a){var b=new this.constructor,f;for(f in this)if("_"!=f[0])if("children"==f){if(a)for(var r=0;r<this.children.length;++r)b.addChild(this.children[r].clone(a))}else r=this[f],void 0!==r&&(null===r?b[f]=null:r.constructor===Object?b[f]=GL.cloneObject(r):r.constructor===Array?b[f]=r.concat():b[f]!==r&&(b[f]=r));return b}toJSON(){var a={position:[this._position[0],this._position[1],
this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(a.name=this.name);this.primitives&&this.primitives.length&&(a.primitives=this.primitives.map(function(r){return Object.assign({},r)}));this.mesh&&(a.mesh=this.mesh);this.material&&(a.material=this.material);null!=this.submesh&&(a.submesh=this.submesh);this.flags&&(a.flags=JSON.parse(JSON.stringify(this.flags)));this.extra&&
(a.extra=this.extra);this.animation&&(a.animation=this.animation);if(this.animations){a.animations=[];for(var b=0;b<this.animations.length;++b)a.animations.push(this.animations[b].toJSON())}if(this.skin)for(a.skin={},a.skin.joints=this.skin.joints.concat(),a.skin.skeleton_root=this.skin.skeleton_root,a.skin.bindMatrices=[],b=0;b<this.skin.bindMatrices.length;++b)a.skin.bindMatrices.push(typedArrayToArray(this.skin.bindMatrices[b]));this.skeleton&&(a.skeleton=this.skeleton.toJSON());if(this.onSerialize)this.onSerialize(a);
if(this.children){b=0;for(var f=this.children.length;b<f;b++)a.children.push(this.children[b].toJSON())}return a}fromJSON(a){var b=null,f;for(f in a){switch(f){case "children":continue;case "uniforms":for(var r in a.uniforms)this.uniforms[r]=a.uniforms[r];continue;case "flags":for(r in a.flags)this.flags[r]=a.flags[r];continue;case "scale":case "scaling":vec3.copy(this._scale,[1,1,1]);this.scale(a[f]);continue;case "tiling":isNumber(a[f])?this.setTextureTiling(a[f],a[f]):this.setTextureTiling(a[f][0],
a[f][1],a[f][2],a[f][3]);continue;case "skeleton":var l=new h.Skeleton;l.fromJSON(a[f]);this.skeleton=l;continue;case "animations":this.animations=[];for(r=0;r<a.animations.length;++r)l=new h.Animation,l.fromJSON(a.animations[r]),this.animations.push(l);continue;case "primitives":this.primitives=a.primitives.map(function(B){return Object.assign({},B)});continue;case "material":this.material=a[f]&&a[f].constructor===Object?(new K(a[f])).register().name:a[f];continue;case "name":case "mesh":case "ref":case "draw_range":case "submesh":case "skin":case "extra":case "animation":this[f]=
a[f];continue;case "parent":b=a[f]}l=this[f];void 0!==l&&(l&&l.constructor===Float32Array?l.set(a[f]):this[f]=a[f])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(a.children)for(this.removeAllChildren(),f=0;f<a.children.length;++f)r=new h.SceneNode,r.fromJSON(a.children[f]),this.addChild(r);b&&(this.parentNode?console.error("This node already has a parent"):b.addChild(this))}setMesh(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null}addChild(a,b){function f(r,l){if(r._scene&&
r._scene!=l){var B=r._scene._nodes.indexOf(r);-1!=B&&r._scene._nodes.splice(B,1);r.id&&r._scene._nodes_by_id[r.id]==r&&delete r._scene._nodes_by_id[r.id]}if(r._scene=l)l._nodes.push(r),r.id&&l&&(l._nodes_by_id[r.id]=r);if(r.children){B=0;for(var C=r.children.length;B<C;B++){var D=r.children[B];D._scene!=l&&f(D,l)}}}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";a._parent=this;b&&a.fromMatrix(a._global_matrix);this.children||(this.children=[]);this.children.push(a);
this._scene!=a._scene&&f(a,this._scene);return this}removeChild(a,b){function f(l){if(l._scene){l.id&&l._scene._nodes_by_id[l.id]==l&&delete l._scene._nodes_by_id[l.id];var B=l._scene._nodes.indexOf(l);-1!=B&&l._scene._nodes.splice(B,1)}l._scene=null;B=0;for(var C=l.children.length;B<C;B++)f(l.children[B])}if(a._parent!=this)throw"removeChild: Not its children";if(!this.children)return this;var r=this.children.indexOf(a);if(-1==r)throw"removeChild: impossible, should be children";this.children.splice(r,
1);a._parent=null;b?a.fromMatrix(a._global_matrix):a._global_matrix.set(a._local_matrix);f(a);return this}removeAllChildren(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])}clear(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-1])}remove(){this._parent&&this._parent.removeChild(this)}destroy(a){!this.scene||a?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)}setChildIndex(a,b){if(this.children){var f=
this.children.indexOf(a);-1!=f&&(this.children.splice(f,1),this.children.splice(b,0,a))}}getAllChildren(a){a=a||[];if(!this.children)return a;for(var b=0,f=this.children.length;b<f;b++){var r=this.children[b];a.push(r);r.getAllChildren(a)}return a}getVisibleChildren(a,b,f){a=a||[];null==b&&(b=65535);if(!this.children||!1===this.flags.visible)return a;for(var r=0,l=this.children.length;r<l;r++){var B=this.children[r];if(!1!==B.flags.visible){var C=B.layers&b;if(!f||C)C&&a.push(B),B.getVisibleChildren(a,
b)}}return a}findNode(a){for(var b=0,f=this.children.length;b<f;b++){var r=this.children[b];if(r.id==a||(r=r.findNode(a)))return r}return null}findNodeByName(a){if(null==a)return null;for(var b=0,f=this.children.length;b<f;b++){var r=this.children[b];if(r.name==a||(r=r.findNodeByName(a)))return r}return null}findNodesByFilter(a,b,f){null==b&&(b=65535);f=f||[];for(var r=0,l=this.children.length;r<l;r++){var B=this.children[r];B.layers&b&&(a&&!a(B)||f.push(B),B.findNodesByFilter(a,b,f))}return f}propagate(a,
b){for(var f=0,r=this.children.length;f<r;f++){var l=this.children[f];l&&(l[a]&&l[a].apply(l,b),l.children&&l.children.length&&l.propagate(a,b))}}resetTransform(){this._position.set(h.ZERO);quat.identity(this._rotation);this._scale.set(h.ONE);this._must_update_matrix=!0}translate(a,b){b?this.getGlobalVector(a,t):t.set(a);vec3.add(this._position,this._position,t);this._must_update_matrix=!0}moveLocal(a){this.translate(a,!0)}setEulerRotation(a,b,f){a&&3<=a.length?quat.fromEuler(this._rotation,a):quat.fromEuler(this._rotation,
[a,b,f]);this._must_update_matrix=!0}getEulerRotation(a){a=a||vec3.create();quat.toEuler(a,this._rotation);return a}rotate(a,b,f){quat.setAxisAngle(J,b,a);f?quat.multiply(this._rotation,J,this._rotation):quat.multiply(this._rotation,this._rotation,J);this._must_update_matrix=!0}rotateQuat(a,b){b?quat.multiply(this._rotation,a,this._rotation):quat.multiply(this._rotation,this._rotation,a);this._must_update_matrix=!0}scale(a){a.constructor===Number?(t[0]=t[1]=t[2]=a,vec3.mul(this._scale,this._scale,
t)):vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0}lookAt(a,b,f,r){this.position=a;this.orientTo(b,r,f)}orientTo(a,b,f,r,l){var B=this.getGlobalPosition(),C=vec3.create();r?C.set(a):vec3.sub(C,B,a);l&&(C[1]=0);f=f||h.UP;vec3.normalize(C,C);b&&vec3.scale(C,C,-1);a=mat3.create();f=vec3.cross(vec3.create(),f,C);vec3.normalize(f,f);b=vec3.cross(vec3.create(),C,f);vec3.normalize(b,b);mat3.setColumn(a,f,0);mat3.setColumn(a,b,1);mat3.setColumn(a,C,2);quat.fromMat3(this._rotation,a);quat.normalize(this._rotation,
this._rotation);this._must_update_matrix=!0}setPivot(a){this.pivot=a}getLocalMatrix(a){this._must_update_matrix&&this.updateLocalMatrix();return a?(a.set(this._global_matrix),a):this._local_matrix}getGlobalMatrix(a,b){this.updateGlobalMatrix(b);return a?(a.set(this._global_matrix),a):this._global_matrix}getGlobalRotation(a){a=a||vec4.create();quat.identity(a);for(var b=this,f=this._scene?this._scene._root:null;b!=f;)quat.multiply(a,b._rotation,a),b=b._parent;return a}updateLocalMatrix(){var a=this._local_matrix;
this._must_update_matrix=!1;mat4.identity(a);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(a[12]=this._pivot[0],a[13]=this._pivot[1],a[14]=this._pivot[2]),mat4.translate(a,a,this._position),mat4.fromQuat(p,this._rotation),mat4.multiply(a,a,p),mat4.scale(a,a,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(a,a,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))}updateGlobalMatrix(a,b){this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&
!0!==this._parent.flags.no_transform?(a=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,b)}updateMatrices(a){this.updateLocalMatrix();this.updateGlobalMatrix(a)}fromMatrix(a,b){b&&this._parent&&this._parent._transform&&(mat4.copy(this._global_matrix,a),b=this._parent.getGlobalMatrix(),
mat4.invert(b,b),a=mat4.multiply(this._local_matrix,b,a));b=mat4.clone(a);mat4.multiplyVec3(this._position,b,[0,0,0]);var f=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(f,b,h.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(f,b,h.UP));this._scale[2]=vec3.length(mat4.rotateVec3(f,b,h.BACK));b=mat3.fromMat4(g,b);quat.fromMat3AndQuat(this._rotation,b);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1}getLocalPoint(a,b){b=b||vec3.create();this._must_update_matrix&&
this.updateLocalMatrix();return vec3.transformMat4(b,a,this._local_matrix)}getParentVector(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)}getLocalVector(a){console.error("DEPRECATED: SceneNode.prototype.getLocalVector, use getGlobalVector or getParentVector")}getGlobalPosition(a,b){a=a||vec3.create();if(b)return vec3.transformMat4(a,h.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return a.set(this._position),a;b=this.getGlobalMatrix();return vec3.transformMat4(a,
h.ZERO,b)}localToGlobal(a,b,f){b=b||vec3.create();f=this.getGlobalMatrix(null,f);return vec3.transformMat4(b,a,f)}globalToLocal(a,b){b=b||vec3.create();var f=this.getGlobalMatrix();mat4.invert(p,f);return vec3.transformMat4(b,a,p)}globalVectorToLocal(a,b){b=b||vec3.create();var f=this.getGlobalRotation();quat.invert(f,f);return vec3.transformQuat(b,a,f)}getGlobalVector(a,b){b=b||vec3.create();var f=this.getGlobalRotation(J);return vec3.transformQuat(b,a,f)}getDistanceTo(a){var b=this.getGlobalMatrix();
return vec3.distance(a,b.subarray(12,15))}updateBoundingBox(a){var b=this._global_matrix,f=gl.meshes[this.mesh],r=null;f&&(r=f.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),r=BBox.transformMat4(this.bounding_box,r,b));if(a||!this.children||0==this.children.length)return r;for(a=0;a<this.children.length;++a)if(b=this.children[a].updateBoundingBox())r?BBox.merge(r,r,b):(r=this.bounding_box=BBox.create(),r.set(b));return r}createMaterial(a){a=new h.Material(a);this.material=a.register().name;
return a}getMaterial(a){a=a||0;return this.material?h.Materials[this.material]:this.primitives&&this.primitives.length>a?h.Materials[this.primitives[a].material]:null}setLayerBit(a,b){a=1<<a;this.layers&=~a;b&&(this.layers|=a)}isInLayerBit(a){return 0!==(this.layers&1<<a)}setRangeFromSubmesh(a){if(null!=a&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(a.constructor===String){for(var f=0;f<b.info.groups.length;++f)if(b.info.groups[f].name==a){a=f;break}if(f===b.info.groups.length)return!1}if(a=
b.info.groups[a])this.draw_range[0]=a.start,this.draw_range[1]=a.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null}findNodesInSphere(a,b,f,r){null==f&&(f=65535);r=r||[];for(var l=0;l<this.children.length;++l){var B=this.children[l];B.layers&f&&(B.getGlobalPosition(t,!0),vec3.distance(t,a)<=b&&r.push(B));B.children.length&&B.findNodesInSphere(a,b,f,r)}return r}}h.SceneNode=F;F["@position"]={type:"vec3"};F["@scaling"]={type:"vec3"};
F["@rotation"]={type:"quat"};F.prototype.testRay=function(){var a=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();mat4.create();return function(b,f,r,l,B,C){r=null==r?Number.MAX_VALUE:r;null==l&&(l=65535);f=f||vec3.create();void 0!==A._ray_tested_objects&&A._ray_tested_objects++;var D=null,G=null;if(!1===this.flags.visible)return null;this.layers&l&&!this.flags.ignore_collisions&&this.mesh&&(G=this.testRayWithMesh(b,a,r,l,B,C));G&&(C=vec3.distance(b.origin,a),null==
r||C<r)&&(r=C,f.set(a),D=this);if(!this.children||!this.children.length)return D;G=vec3.create();for(var I=0,M=this.children.length;I<M;++I){var O=this.children[I].testRay(b,G,r,l,B);O&&(C=vec3.distance(b.origin,G),C>r||(r=C,f.set(G),D=O))}return D}}();F.prototype.testRayWithMesh=function(){var a=vec3.create(),b=vec3.create(),f=vec3.create(),r=mat4.create(),l=mat4.create();return function(B,C,D,G,I){if(!this.mesh)return!1;var M=gl.meshes[this.mesh];if(!M||!1===M.ready)return!1;var O=null==this.submesh?
-1:this.submesh,P=this.getGlobalMatrix(r,!0);mat4.invert(l,P);vec3.transformMat4(a,B.origin,l);vec3.add(f,B.origin,B.direction);vec3.transformMat4(f,f,l);vec3.sub(b,f,a);vec3.normalize(b,b);var N=this.flags.two_sided;if(this.primitives&&this.primitives.length){var U=h.Materials[this.primitives[0].material];U&&(N=U.flags.two_sided)}return h.testRayMesh(B,a,b,P,M,O,C,D,G,I,N)}}();F.prototype.testSphere=function(){return function(a,b,f,r){null==f&&(f=65535);var l=null;if(!1===this.flags.visible)return null;
this.layers&f&&!this.flags.ignore_collisions&&this.mesh&&(l=this.testSphereWithMesh(a,b,f,r));if(l)return this;if(!this.children||!this.children.length)return null;l=0;for(var B=this.children.length;l<B;++l){var C=this.children[l].testSphere(a,b,f,r);if(C)return C}return null}}();F.prototype.testSphereWithMesh=function(){var a=vec3.create();vec3.create();vec3.create();var b=mat4.create(),f=mat4.create();return function(r,l,B,C){if(!this.mesh)return!1;var D=gl.meshes[this.mesh];if(!D||!1===D.ready)return!1;
var G=null==this.submesh?-1:this.submesh,I=this.getGlobalMatrix(b,!0);mat4.invert(f,I);vec3.transformMat4(a,r,f);r=l/vec3.length(I);l=this.flags.two_sided;if(this.primitives&&this.primitives.length){var M=h.Materials[this.primitives[0].material];M&&(l=M.flags.two_sided)}return h.testSphereMesh(a,r,I,D,G,B,C,l)}}();h.Camera=d;d.PERSPECTIVE=1;d.ORTHOGRAPHIC=2;d.prototype.fromJSON=function(a){null!=a.type&&(this.type=a.type);a.position&&this._position.set(a.position);a.target&&this._target.set(a.target);
a.up&&this._up.set(a.up);a.near&&(this.near=a.near);a.far&&(this.far=a.far);a.fov&&(this.fov=a.fov);a.aspect&&(this.aspect=a.aspect)};d.prototype.toJSON=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};Object.defineProperty(d.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=
!0},enumerable:!1});Object.defineProperty(d.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(d.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(d.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(d.prototype,
"aspect",{get:function(){return this._aspect},set:function(a){this._aspect=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(d.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(a){this._frustum_size=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(d.prototype,"near",{get:function(){return this._near},set:function(a){this._near=this.uniforms.u_camera_planes[0]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(d.prototype,
"far",{get:function(){return this._far},set:function(a){this._far=this.uniforms.u_camera_planes[1]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(d.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(a){this._view_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(d.prototype,"projection_matrix",{get:function(){return this._projection_matrix},set:function(a){this._projection_matrix.set(a);
mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(d.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(a){this._viewprojection_matrix.set(a)},enumerable:!1});d.prototype.perspective=function(a,b,f,r){this.type=d.PERSPECTIVE;this._fov=a;this._aspect=b;this._near=f;this._far=r;this._must_update_matrix=!0};d.prototype.orthographic=function(a,b,f,r){this.type=d.ORTHOGRAPHIC;this._frustum_size=
a;1<arguments.lenth&&(this._near=b,this._far=f,this._aspect=r||1);this._must_update_matrix=!0};d.prototype.lookAt=function(a,b,f){this._position==b&&(b=vec3.clone(b));vec3.copy(this._position,a);vec3.copy(this._target,b);vec3.copy(this._up,f);this._must_update_matrix=!0};d.prototype.updateMatrices=function(a){if(this._autoupdate_matrices||a)if(this.type==d.ORTHOGRAPHIC?this.frustum_size.constructor===Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,
-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*c,this._aspect,this._near,this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,
this._position,this._target,this._up),this.view_texel_grid&&this.type==d.ORTHOGRAPHIC){a=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var b=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/a)*a;this._view_matrix[13]=Math.floor(this._view_matrix[13]/b)*b}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,
[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,h.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,h.UP);mat4.rotateVec3(this._front,this._model_matrix,h.FRONT);this.distance=vec3.distance(this._position,this._target);this.uniforms.u_camera_planes[0]=this._near;this.uniforms.u_camera_planes[1]=this._far};d.prototype.getModel=
function(a){a=a||mat4.create();this._must_update_matrix&&this.updateMatrices();mat4.copy(a,this._model_matrix);return a};d.prototype.updateVectors=function(a){var b=vec3.subtract(t,this._target,this._position);b=vec3.length(b);mat4.multiplyVec3(this._position,a,h.ZERO);mat4.multiplyVec3(this._target,a,[0,0,-b]);mat4.rotateVec3(this._up,a,h.UP)};d.prototype.getLocalVector=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,a)};d.prototype.localToGlobal=
function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};d.prototype.getLocalPoint=d.prototype.localToGlobal;d.prototype.globalToLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._view_matrix)};d.prototype.globalVectorToLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._view_matrix,a)};d.prototype.getFront=
function(a){a=a||vec3.create();vec3.subtract(a,this._target,this._position);vec3.normalize(a,a);return a};d.prototype.move=function(a,b){void 0!==b&&(vec3.scale(t,a,b),a=t);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};d.prototype.moveLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();a=mat4.rotateVec3(t,this._model_matrix,a);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,
a);this._must_update_matrix=!0};d.prototype.rotate=function(a,b){a=quat.setAxisAngle(J,b,a);b=vec3.subtract(t,this._target,this._position);vec3.transformQuat(b,b,a);vec3.add(this._target,this._position,b);this._must_update_matrix=!0};d.prototype.rotateLocal=function(a,b){this._must_update_matrix&&this.updateMatrices();b=mat4.rotateVec3(y,this._model_matrix,b);a=quat.setAxisAngle(J,b,a);b=vec3.subtract(t,this._target,this._position);vec3.transformQuat(b,b,a);vec3.add(this._target,this._position,b);
this._must_update_matrix=!0};d.prototype.orbit=function(a,b,f,r){if(!b)throw"RD: orbit axis missing";f=f||this._target;r&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(y,this._model_matrix,b));a=quat.setAxisAngle(J,b,a);b=vec3.subtract(t,this._position,this._target);vec3.transformQuat(b,b,a);vec3.add(this._position,f,b);this._must_update_matrix=!0};d.prototype.orbitDistanceFactor=function(a,b){b=b||this._target;var f=vec3.subtract(t,this._position,b);vec3.scale(f,f,a);vec3.add(this._position,
b,f);this._must_update_matrix=!0};d.prototype.project=function(a,b,f){f=f||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(f,this._viewprojection_matrix,a);f[0]=f[0]*b[2]+b[0];f[1]=f[1]*b[3]+b[1];return f};d.prototype.computeProjectedRadius=function(a,b,f,r){f=f||gl.viewport_data;if(r)return r=vec4.create(),r.set(a),r[3]=1,a=vec4.transformMat4(r,r,this._viewprojection_matrix),Math.max(1,f[3]*this._projection_matrix[5]*b/a[3]);if(this.type==h.Camera.ORTHOGRAPHIC)return b/
(this._frustum_size.constructor===Number?this._frustum_size:1)*f[3]/2;a=vec3.distance(a,this.position);return 0==a?0:1/Math.tan(this.fov/2*Math.PI/180)*b/Math.sqrt(a*a-b*b)*(f[3]/2)};d.prototype.unproject=function(a,b,f){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(f||vec3.create(),a,this._viewprojection_matrix,b)};d.prototype.getRay=function(a,b,f,r){if(void 0===a||void 0===b)throw"RD.Camera.getRay requires x and y parameters";f=f||gl.viewport_data;
r||=new h.Ray;this._must_update_matrix&&this.updateMatrices();var l=r.origin;vec3.set(l,a,b,0);this.type==h.Camera.ORTHOGRAPHIC?vec3.unproject(l,l,this._viewprojection_matrix,f):vec3.copy(l,this.position);var B=r.direction;vec3.set(B,a,b,1);vec3.unproject(B,B,this._viewprojection_matrix,f);vec3.sub(B,B,l);vec3.normalize(B,B);return r};d.prototype.getRayPlaneCollision=function(a,b,f,r,l,B){l=l||vec3.create();a=this.getRay(a,b,B);return geo.testRayPlane(a.origin,a.direction,f,r,l)?l:null};d.prototype.getModelForScreenPixel=
function(a,b,f,r,l){l=l||mat4.create();a=this.unproject([a,b,-1]);b=vec3.sub(vec3.create(),a,this._position);vec3.normalize(b,b);vec3.scaleAndAdd(a,a,b,f);vec3.normalize(b,b);mat4.fromTranslationFrontTop(l,a,b,this._up);return l};d.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};d.prototype.applyController=function(a,b,f,r){f=f||10;if(a){var l=vec3.create();if(gl.keys[d.controller_keys.forward]||r&&gl.keys.W)l[2]=-1;else if(gl.keys[d.controller_keys.back]||r&&gl.keys.S)l[2]=1;
if(gl.keys[d.controller_keys.left]||r&&gl.keys.A)l[0]=-1;else if(gl.keys[d.controller_keys.right]||r&&gl.keys.D)l[0]=1;vec3.sqrLen(l)&&this.moveLocal(l,a*f)}b&&(b.deltax&&this.rotate(-.005*b.deltax,h.UP),b.deltay&&this.rotateLocal(-.005*b.deltay,h.RIGHT))};d.prototype.lerp=function(a,b){vec3.lerp(this._position,this._position,a._position,b);vec3.lerp(this._target,this._target,a._target,b);vec3.lerp(this._up,this._up,a._up,b);this._fov=this._fov*(1-b)+a._fov*b;this._near=this._near*(1-b)+a._near*b;
this._far=this._far*(1-b)+a._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+a._frustum_sizer*b);this._must_update_matrix=!0};d.prototype.orientMatrixToCamera=function(a){a.set(this._right,0);a.set(this._top,4);a.set(this._front,8)};d.prototype.extractPlanes=function(){function a(r){var l=f.subarray(r,r+3);l=vec3.length(l);l=1/l;f[r]*=l;f[r+1]*=l;f[r+2]*=l;f[r+3]*=l}var b=this._viewprojection_matrix,f=this._planes_data||new Float32Array(24);f.set([b[3]-
b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);a(0);f.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);f.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);a(8);f.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);f.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);f.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);a(20);this._planes_data=f;this._frustrum_planes||(this._frustrum_planes=[f.subarray(0,4),f.subarray(4,8),f.subarray(8,12),f.subarray(12,16),f.subarray(16,20),
f.subarray(20,24)])};var E=h.CLIP_INSIDE=0,H=h.CLIP_OUTSIDE=1,L=h.CLIP_OVERLAP=2;d.prototype.testMesh=function(){if(x.BBox){var a=BBox.create(),b=a.subarray(0,3),f=a.subarray(3,6);return function(r,l){r=r.bounding;if(!r)return E;BBox.transformMat4(a,r,l);return this.testBox(b,f)}}}();d.prototype.testBox=function(a,b){this._frustrum_planes||this.extractPlanes();var f=this._frustrum_planes,r=0;var l=z(f[0],a,b);if(l==H)return H;r+=l;l=z(f[1],a,b);if(l==H)return H;r+=l;l=z(f[2],a,b);if(l==H)return H;
r+=l;l=z(f[3],a,b);if(l==H)return H;r+=l;l=z(f[4],a,b);if(l==H)return H;r+=l;l=z(f[5],a,b);return l==H?H:0==r+l?E:L};d.prototype.testSphere=function(a,b){this._frustrum_planes||this.extractPlanes();var f=this._frustrum_planes,r=!1;var l=n(f[0],a);if(l<-b)return H;l>=-b&&l<=b&&(r=!0);l=n(f[1],a);if(l<-b)return H;l>=-b&&l<=b&&(r=!0);l=n(f[2],a);if(l<-b)return H;l>=-b&&l<=b&&(r=!0);l=n(f[3],a);if(l<-b)return H;l>=-b&&l<=b&&(r=!0);l=n(f[4],a);if(l<-b)return H;l>=-b&&l<=b&&(r=!0);l=n(f[5],a);if(l<-b)return H;
l>=-b&&l<=b&&(r=!0);return r?L:E};h.Scene=A;A.prototype.clear=function(){this._root=new h.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};A.prototype.getNodeById=function(a){return this._nodes_by_id[a]};A.prototype.findNodesInBBox=function(a,b,f){null==b&&(b=65535);f=f||[];for(var r=0;r<this.nodes.length;++r){var l=this.nodes[r];l.bounding_box&&l.layers&b&&geo.testBBoxBBox(l.bounding_box,a)&&f.push(l)}return f};A.prototype.update=function(a){this.time+=a;this._root.propagate("update",
[a]);this.destroyPendingNodes()};A.prototype.destroyPendingNodes=function(a){if(this._to_destroy.length)for(;a=this._to_destroy.pop();)a._parent&&a._parent.removeChild(a)};Object.defineProperty(A.prototype,"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});A.prototype.testRay=function(a,b,f,r,l){h.Scene._ray_tested_objects=0;b||(b=a.collision_point);null==l&&(l=!0);return this.root.testRay(a,b,f,null==r?65535:r,l)};A.prototype.testSphere=function(a,
b,f,r){null==r&&(r=!0);return this.root.testSphere(a,b,null==f?65535:f,r)};A.prototype.gatherObjects=function(a,b,f){f=f||[];a.updateGlobalMatrix(!0);if(a.mesh&&b&a.layers&&!a.skeleton){if(a.primitives&&a.primitives.length)for(var r=0;r<a.primitives.length;++r){var l=a.primitives[r];(this.overwrite_material||h.Materials[l.material])&&f.push([a,a._global_matrix,a.mesh,r,a.material])}}else f.push([a,a._global_matrix,a.mesh,-1,a.material]);for(r=0;r<a.children.length;++r)this.gatherObjects(a.children[r],
b,f);return f};h.testRayWithNodes=function(a,b,f,r,l,B,C){h.testRayWithNodes.coll_node=null;r=null==r?Number.MAX_VALUE:r;l=null==l?65535:l;h.Scene._ray_tested_objects=0;f||(f=a.collision_point);h.testRayWithNodes.local_result||(h.testRayWithNodes.local_result=vec3.create());for(var D=h.testRayWithNodes.local_result,G=null,I=0;I<b.length;++I){var M=b[I],O=M.testRay(a,D,r,l,B);if(O){var P=vec3.distance(a.origin,D);P>r||(r=P,f.set(D),h.testRayWithNodes.coll_node=O,G=C?O:M)}}return G};h.last_hit_test=
null;h.testRayMesh=function(a,b,f,r,l,B,C,D,G,I,M){D=null==D?Number.MAX_VALUE:D;-1==B?(G=l.getBoundingBox(),B=l):(B=l.info.groups[B],G=B.bounding,G||(l.computeGroupsBoundingBoxes(),G=B.bounding));if(!G)return!1;D||=1E7;if(!geo.testRayBBox(b,f,G,null,t))return!1;vec3.transformMat4(C,t,r);G=vec3.distance(a.origin,C);if(G>D)return!1;if(!I)return!0;B._octree||(B._octree=B==l?new GL.Octree(l):new GL.Octree(l,B.start,B.length));b=B._octree.testRay(b,f,0,D,M);if(!b)return!1;h.last_hit_test=b;C.set(b.hit);
vec3.transformMat4(C,C,r);G=vec3.distance(a.origin,C);return G>D?!1:!0};h.testSphereMesh=function(a,b,f,r,l,B,C){-1==l?(f=r.getBoundingBox(),l=r):(l=r.info.groups[l],f=l.bounding,f||(r.computeGroupsBoundingBoxes(),f=l.bounding));if(!f||!geo.testSphereBBox(a,b,f))return!1;if(!C)return!0;l._octree||(l._octree=l==r?new GL.Octree(r):new GL.Octree(r,l.start,l.length));return l._octree.testSphere(a,b)?!0:!1};A.prototype.fromJSON=function(a){this.root.clear();this.root.fromJSON(a)};A.prototype.toJSON=function(a){function b(l,
B){if(a){if(!a(l,B))return!1}else{if(!l.flags.no_transform){B.position=typedArrayToArray(l.position);if(0!=l.rotation[0]||0!=l.rotation[1]||0!=l.rotation[2]||1!=l.rotation[3])B.rotation=typedArrayToArray(l.rotation);if(1!=l.scaling[0]||1!=l.scaling[1]||1!=l.scaling[2])B.scaling=typedArrayToArray(l.scaling)}l.id&&(B.id=l.id);l.ref=B.ref=f++;l.mesh&&(B.mesh=l.mesh);null!=l.submesh&&(B.submesh=l.submesh);l.draw_range&&(B.draw_range=l.draw_range.concat());l.material&&(B.material=l.material);l.extra&&
(B.extra=l.extra);B.layers=l.layers;B.flags=l.flags}if(!l.children.length)return!0;for(var C=[],D=0;D<l.children.length;++D){var G={};b(l.children[D],G)&&C.push(G)}C.length&&(B.children=C);return!0}a&&a.constructor!==Function&&(a=null);var f=0,r={};b(this.root,r);return r};class K{static $jscomp$static$init$m610168130$0$default_shader_name(){return"texture"}constructor(a){this._color=vec4.fromValues(1,1,1,1);this._emissive=vec3.fromValues(0,0,0);this.shader_name=null;this.uniforms={u_color:this._color,
u_emissive:this._emissive};this.textures={};this.primitive=GL.TRIANGLES;this.blend_mode=h.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};a&&this.fromJSON(a)}set color(a){this._color.set(a)}get color(){return this._color}set albedo(a){this._color.set(a)}get albedo(){return this._color}set emissive(a){this._emissive.set(a)}get emissive(){return this._emissive}set opacity(a){this._color[3]=a}get opacity(){return this._color[3]}fromJSON(a){for(var b in a){var f=a[b];if(f)if("texture"===
b){this.textures.color=f;continue}else f.constructor===Object?f=JSON.parse(JSON.stringify(f)):f.constructor===Array?f=f.concat():f.constructor===Float32Array&&(f=new Float32Array(f));this[b]=f}}register(a){a||=this.name||h.makeHash(32);this.name=a;h.Materials[this.name]=this;return this}toJSON(){var a={flags:JSON.parse(JSON.stringify(this.flags)),textures:JSON.parse(JSON.stringify(this.textures))};a.color=typedArrayToArray(this._color);this.name&&(a.name=this.name);this.alphaMode&&(a.alphaMode=this.alphaMode);
this.blendMode&&(a.blendMode=this.blendMode);.5!=this.alphaCutoff&&(a.alphaCutoff=this.alphaCutoff);this.uv_transform&&(a.uv_transform=this.uv_transform);this.normalFactor&&(a.normalFactor=this.normalFactor);this.displacementFactor&&(a.displacementFactor=this.displacementFactor);this.backface_color&&(a.backface_color=typedArrayToArray(this.backface_color));this.emissive&&(a.emissive=typedArrayToArray(this.emissive));this.model&&(a.model=this.model,a.metallicFactor=this.metallicFactor,a.roughnessFactor=
this.roughnessFactor);return a}static $jscomp$static$init$m610168130$1$MACROS(){return{COLOR:1,COORD1:2,INSTANCING:4,SKINNING:8,POINTS:16,PHONG:32,TEXTURE:64,ALBEDO:128,EMISSIVE:256,OCCLUSION:512}}render(a,b,f,r,l,B,C){if(a.on_getShader){var D=a.on_getShader(C,a._camera);if(!D)return}else(D=this.shader_name)?D=gl.shaders[D]:(D=0,f.vertexBuffers.colors&&(D|=K.MACROS.COLOR),f.vertexBuffers.coords1&&(D|=K.MACROS.COORD1),B&&(D|=K.MACROS.SKINNING),C._instances&&(D|=K.MACROS.INSTANCING),"phong"==a.light_model&&
(D|=K.MACROS.PHONG),this.textures.color&&(D|=K.MACROS.TEXTURE),this.textures.albedo&&(D|=K.MACROS.ALBEDO),this.textures.emissive&&(D|=K.MACROS.EMISSIVE),this.textures.occlusion&&(D|=K.MACROS.OCCLUSION),D=a.getMasterShader(D));D||(D=this.textures.color||this.textures.albedo,D=B?D?a._texture_skinning_shader:a._flat_skinning_shader:D?a._texture_shader:a._flat_shader);var G=!1;C._instances&&(1<gl.webgl_version||gl.extensions.ANGLE_instanced_arrays)&&(G=!0);G&&!D.attributes.u_model&&(G=!1);var I=0,M=null,
O;for(O in this.textures){var P=this.textures[O];if(P){P.constructor===Object&&(P=P.texture);var N="u_"+O+"_texture";if(!D||D.samplers[N])M=gl.textures[P],M||(a.autoload_assets&&-1!=P.indexOf(".")&&a.loadTexture(P,a.default_texture_settings),M=gl.textures.white),this.uniforms[N]=M.bind(I++)}}M||(D.samplers.u_albedo_texture||D.samplers.u_color_texture)&&gl.textures.white.bind(0);a.enableItemFlags(this);a._uniforms.u_model.set(b);B&&D.uniformInfo.u_bones&&(this.bones=B.computeFinalBoneMatrices(this.bones,
f),D.setUniform("u_bones",this.bones));a._uniforms.u_global_alpha_clip=null!=this.alphaCutoff&&"MASK"==this.alphaMode?this.alphaCutoff:-1;D.uniforms(a._uniforms);D.uniforms(this.uniforms);"phong"==a.light_model&&D.uniforms(a._phong_uniforms);if(a.onNodeShaderUniforms)a.onNodeShaderUniforms(a,D,C);b=null;null!=l&&f.info&&f.info.groups&&f.info.groups[l]&&(b=f.info.groups[l]);if(G)R.u_model=C._instances,b?D.drawInstanced(f,null==C.primitive?gl.TRIANGLES:C.primitive,C.indices,R,b.start,b.length):C.draw_range?
D.drawInstanced(f,null==C.primitive?gl.TRIANGLES:C.primitive,C.indices,R,C.draw_range[0],C.draw_range[1]):D.drawInstanced(f,null==C.primitive?gl.TRIANGLES:C.primitive,C.indices,R);else if(C._instances)for(O=0;O<C._instances.length;O+=16)D.setUniform("u_model",C._instances.subarray(O,O+16)),b?D.drawRange(f,this.primitive,b.start,b.length,r):C.draw_range?D.drawRange(f,null==C.primitive?gl.TRIANGLES:C.primitive,C.indices,C.draw_range[0],C.draw_range[1]):D.draw(f,this.primitive,r);else b?D.drawRange(f,
this.primitive,b.start,b.length,r):C.draw_range?D.drawRange(f,null==C.primitive?gl.TRIANGLES:C.primitive,C.indices,C.draw_range[0],C.draw_range[1]):D.draw(f,this.primitive,r);a.disableItemFlags(this);a.draw_calls+=1}}K.default_shader_name=K.$jscomp$static$init$m610168130$0$default_shader_name();K.MACROS=K.$jscomp$static$init$m610168130$1$MACROS();h.Material=K;v.prototype.getMasterShader=function(a){this.master_shaders_compiled||(this.master_shaders_compiled=new Map);var b=this.master_shaders_compiled,
f=b.get(a);if(f)return f;f=v.master_vertex_shader;var r=v.master_fragment_shader;h.Skeleton&&a&K.MACROS.SKINNING&&(f=f.replaceAll("#pragma SKINNING_HEADER",`
		#ifdef SKINNING
			${h.Skeleton.shader_code} //
		#endif
		`),f=f.replaceAll("#pragma SKINNING_BODY","\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t"));var l=null;if(a){l={};for(var B in K.MACROS)a&K.MACROS[B]&&(l[B]="")}f=new GL.Shader(f,r,l);b.set(a,f);return f};v.master_vertex_shader="\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\t#ifdef COORD1\n\t\tattribute vec2 a_coord1;\n\t\tvarying vec2 v_coord1;\n\t#endif\n\tvarying vec3 v_pos;\n\tvarying vec3 v_normal;\n\tvarying vec2 v_coord;\n\t#ifdef COLOR\n\tattribute vec4 a_color;\n\tvarying vec4 v_color;\n\t#endif\n\t#pragma SKINNING_HEADER\n\t#ifdef INSTANCING\n\t\tattribute mat4 u_model;\n\t#else\n\t\tuniform mat4 u_model;\n\t#endif\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tv_pos = a_vertex;\n\t\tv_normal = a_normal;\n\t\t#pragma SKINNING_BODY\n\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\tv_coord = a_coord;\n\t\t#ifdef COORD1\n\t\t\tv_coord1 = a_coord1;\n\t\t#endif\n\t\t#ifdef COLOR\n\t\tv_color = a_color;\n\t\t#endif\n\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\tgl_PointSize = 2.0;\n\t}\n";
v.master_fragment_shader="\n\tprecision highp float;\n\tvarying vec2 v_coord;\n\tvarying vec3 v_normal;\n\tuniform vec4 u_color;\n\tuniform vec3 u_emissive;\n\t#ifdef COLOR\n\tvarying vec4 v_color;\n\t#endif\n\t#ifdef TEXTURE\n\t\tuniform sampler2D u_color_texture;\n\t#endif\n\t#ifdef ALBEDO\n\t\tuniform sampler2D u_albedo_texture;\n\t#endif\n\t#ifdef EMISSIVE\n\t\tuniform sampler2D u_emissive_texture;\n\t#endif\n\t#ifdef OCCLUSION\n\t\tuniform sampler2D u_occlusion_texture;\n\t#endif\n\t#ifdef COORD1\n\t\tvarying vec2 v_coord1;\n\t#else\n\t\tvec2 v_coord1;\n\t#endif\t\n\t#ifdef PHONG\n\t\tuniform vec3 u_ambient;\n\t\tuniform vec3 u_light_color;\n\t\tuniform vec3 u_light_vector;\n\t#endif\n\tuniform float u_global_alpha_clip;\n\tvoid main() {\n\t\tvec4 color = u_color;\n\t\t#ifndef COORD1\n\t\t\tv_coord1 = v_coord;\n\t\t#endif\t\t\n\t\t#ifdef ALBEDO\n\t\t\tcolor *= texture2D(u_albedo_texture, v_coord);\n\t\t#endif\n\t\t#ifdef TEXTURE\n\t\t\tcolor *= texture2D(u_color_texture, v_coord);\n\t\t#endif\n\t\t#ifdef COLOR\n\t\t\tcolor *= v_color;\n\t\t#endif\n\t\tif(color.w <= u_global_alpha_clip)\n\t\t\tdiscard;\n\t\tvec3 N = normalize(v_normal);\n\t\tvec3 light = vec3(1.0);\n\t\t#ifdef PHONG\n\t\t\tfloat NdotL = max(dot(N,u_light_vector),0.0);\n\t\t\tlight = ( u_ambient * (1.0 - max(0.0,-N.y) * 0.5 ) ) + NdotL * u_light_color;\n\t\t#endif\n\t\t#ifdef OCCLUSION\n\t\t\tlight = texture2D(u_occlusion_texture, v_coord1).xyz;\n\t\t#endif\n\t\tcolor.xyz *= light;\n\t\t#ifdef EMISSIVE\n\t\t\tcolor.xyz += u_emissive * texture2D(u_emissive_texture, v_coord).xyz;\n\t\t#else\n\t\t\tcolor.xyz += u_emissive;\n\t\t#endif\n\t\tgl_FragColor = color;\n\t}\n";
h.Renderer=v;Object.defineProperty(v.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});v.prototype.setDataFolder=function(a){a?(this.assets_folder=a,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};v.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],3<=a.length?a[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};v._sort_by_dist_func=function(a,b){return b._distance-
a._distance};v._sort_by_priority_func=function(a,b){return b.render_priority-a.render_priority};v._sort_by_priority_and_dist_func=function(a,b){var f=b.render_priority-a.render_priority;return 0!=f?f:b._distance-a._distance};v.prototype.destroy=function(){gl.destroy();h.Materials={}};v.prototype.render=function(a,b,f,r,l,B){null==r&&(r=65535);if(!a)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";b=b||
a.camera;if(!b)throw"Renderer.render: camera not provided";x.gl=this.gl;this._nodes.length=0;f||a._root.getVisibleChildren(this._nodes,r,this.layers_affect_children);f=f||this._nodes;this.enableCamera(b);this.enable2DView();this._state=[];this._meshes_missing=0;this._current_scene=a;this._uniforms.u_time=a.time;this.sort_by_distance&&f.forEach(function(D){D._distance=D.getDistanceTo(b._position)});var C=this;f=f.filter(function(D){return!D.mustRender||0!=D.mustRender(C,b)});this.sort_by_distance&&
f.sort(h.Renderer._sort_by_dist_func);if(this.onPreRender)this.onPreRender(b);a._root.preRender&&a._root.preRender(this,b);if(l=l||this.pipeline)l.render(this,f,b,a,B);else{for(l=0;l<f.length;++l){B=f[l];B.updateGlobalMatrix(!0);if(this.onPreRenderNode)this.onPreRenderNode(B,b);B.preRender&&B.preRender(this,b)}for(l=0;l<f.length;++l)B=f[l],B.flags.was_rendered=!1,!1!==B.flags.visible&&B.layers&r&&(!this.mustRenderNode||!1!==this.mustRenderNode(B,b))&&(B.flags.was_rendered=!0,this.setModelMatrix(B._global_matrix),
this.renderNode(B,b));a._root.postRender&&a._root.postRender(this,b);for(l=0;l<f.length;++l)if(B=f[l],B.postRender&&B.postRender(this,b),this.onPostRenderNode)this.onPostRenderNode(B,b)}if(this.onPostRender)this.onPostRender(b);a.frame++;this.frame++;this._current_scene=null};v.prototype.enableCamera=function(a){this._camera=a;a.updateMatrices();a.extractPlanes();this._view_matrix.set(a._view_matrix);this._projection_matrix.set(a._projection_matrix);this._viewprojection_matrix.set(a._viewprojection_matrix);
this._uniforms.u_camera_position=a.position};v.prototype.enable2DView=function(){mat4.ortho(this._viewprojection2D_matrix,0,gl.viewport_data[2],0,gl.viewport_data[3],-1,1)};v.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};v.prototype.restoreState=function(){var a=this.state.pop(),b=this.camera=a.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=
b.position;this._nodes=a.nodes};v.prototype.setModelMatrix=function(a){this._model_matrix.set(a);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,a)};v.prototype.setGlobalUniforms=function(a){for(var b in a)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(a[b]):this._uniforms[b]=a[b]};var R={u_model:null};v.prototype.renderNode=function(a,b){b=null;a._mesh?b=a._mesh:a.mesh&&(b=gl.meshes[a.mesh],b||(this._meshes_missing++,this.autoload_assets&&-1!=a.mesh.indexOf(".")&&this.loadMesh(a.mesh)));
if(a.primitives&&a.primitives.length){if(b)for(var f=0;f<a.primitives.length;++f){var r=a.primitives[f],l=this.overwrite_material||h.Materials[r.material];l||(l=this.default_material);this.onFilterByMaterial&&0==this.onFilterByMaterial(l,h.Materials[r.material])||this.renderMeshWithMaterial(a._global_matrix,b,l,"triangles",f,a.skeleton,a)}}else l=h.Materials[a.material]||this.overwrite_material||this.default_material,b&&l&&(l.render?this.renderMeshWithMaterial(a._global_matrix,b,l,a.indices,a.submesh,
a.skeleton,a):a.color=l.color)};v.prototype.renderMesh=function(a,b,f,r,l,B,C,D){b&&(r&&this._uniforms.u_color.set(r),a||(a=h.IDENTITY),this._uniforms.u_model.set(a),l||=f?gl.shaders.texture:gl.shaders.flat,f&&(this._uniforms.u_texture=f.bind(0)),l.uniforms(this._uniforms),l.draw(b,null==B?gl.TRIANGLES:B,C),this.draw_calls+=1)};v.prototype.renderMeshWithMaterial=function(a,b,f,r,l,B,C){f.render&&f.render(this,a,b,r,l,B,C)};v.prototype.renderBounding=function(a,b,f){if(a){b=b||h.IDENTITY;var r=this._uniforms.u_model;
a=a.constructor===GL.Mesh?a._bounding:a;f=f||[1,1,0,1];var l=a.subarray(3,6);mat4.translate(r,b,a.subarray(0,3));mat4.scale(r,r,[2*l[0],2*l[1],2*l[2]]);this.renderMesh(r,gl.meshes.cube,null,f,null,gl.LINES,"wireframe")}};v.prototype.enableItemFlags=function(a){var b=a.flags.flip_normals;this.reverse_normals&&(b=!b);gl.frontFace(b?gl.CW:gl.CCW);gl[!1===a.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST);!1===a.flags.depth_write&&gl.depthMask(!1);gl[!0===a.flags.two_sided||this.disable_cull_face?
"disable":"enable"](gl.CULL_FACE);if(a.blend_mode!==h.BLEND_NONE)switch(gl.enable(gl.BLEND),a.blend_mode){case h.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case h.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case h.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND);"BLEND"==a.alphaMode&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};v.prototype.disableItemFlags=function(a){a.flags.flip_normals&&
gl.frontFace(gl.CCW);!1===a.flags.depth_test&&gl.enable(gl.DEPTH_TEST);a.blend_mode!==h.BLEND_NONE&&gl.disable(gl.BLEND);a.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===a.flags.depth_write&&gl.depthMask(!0);"BLEND"==a.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};v.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};h.Renderer.prototype.renderPoints=function(a,b,f,r,l,B,C,D,G){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";
l||(C==GL.LINES||C==GL.LINE_LOOP?l=this.shaders.flat:D?(l=this.shaders._points_textured,l||(l=this.shaders._points_textured=new GL.Shader(h.points_vs_shader,h.points_fs_shader,{TEXTURED:""}),l.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(l=this.shaders[b?"_points_color":"_points"],l||(l=b?this.shaders._points_color=new GL.Shader(h.points_vs_shader,h.points_fs_shader,{COLORED:""}):this.shaders._points=new GL.Shader(h.points_vs_shader,h.points_fs_shader),l.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));
B=B||1;var I=1024;r=r||a.length/3;var M=this._points_mesh;r>a.length/3&&(r=a.length/3);if(!M||a.length>3*I){r>I&&(I=GL.Texture.nextPOT(r));var O=new Float32Array(3*I);I=new Float32Array(4*I);M=this._points_mesh=GL.Mesh.load({vertices:O,extra4:I})}else O=this._points_mesh.getBuffer("vertices").data,I=this._points_mesh.getBuffer("extra4").data;O.set(O.length>a.length?a:a.subarray(0,O.length));b?I.set(I.length>b.length?b:b.subarray(0,I.length)):I.fill&&I.fill(0);M.upload(GL.DYNAMIC_STREAM);l.setUniform("u_color",
this._color);l.setUniform("u_pointSize",B);l.setUniform("u_camera_perspective",f._projection_matrix[5]);l.setUniform("u_model",G||h.IDENTITY);l.setUniform("u_viewport",gl.viewport_data);l.setUniform("u_viewprojection",f._viewprojection_matrix);D&&l.setUniform("u_texture",D.bind(0));l.drawRange(M,null!=C?C:GL.POINTS,0,r);return M};h.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
h.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvarying vec4 v_extra4;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef COLORED\n\t\tcolor *= v_extra4;\n\t#endif\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
v.prototype.renderLines=function(a,b,f){this.renderPoints(a,null,null,null,null,null,gl.LINES,null,f)};v.prototype.render3DLines=function(a,b,f,r){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var l=this.shaders._lines;l||=this.shaders._lines=new GL.Shader(h.lines_vs_shader,this._flat_fragment_shader);var B=this._camera,C=a.length/3,D=f?2*C:4*C;var G=this._lines_mesh;if(!G||3*D>G.getBuffer("vertices").data.length){G=GL.Texture.nextPOT(D);D=new Float32Array(3*
G);var I=new Float32Array(3*G);var M=new Float32Array(2*G);indices_data=new Uint16Array(3*G);G=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:D,normals:I,extra2:M})}else D=this._lines_mesh.getBuffer("vertices").data,I=this._lines_mesh.getBuffer("normals").data,M=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data;var O=vec2.fromValues(-1,-1),P=vec2.fromValues(1,-1),N=vec2.fromValues(-1,1),U=vec2.fromValues(1,1),T=vec3.create();if(f)throw"strip lines not supported yet";
for(var W=Math.floor(C/2),Q=0;Q<W;++Q){var S=2*Q,V=a.subarray(3*S,3*S+3);S=a.subarray(3*S+3,3*S+6);vec3.sub(T,S,V);D.set(V,12*Q);D.set(V,12*Q+3);D.set(S,12*Q+6);D.set(S,12*Q+9);I.set(T,12*Q);I.set(T,12*Q+3);I.set(T,12*Q+6);I.set(T,12*Q+9);M.set(O,8*Q);M.set(P,8*Q+2);M.set(N,8*Q+4);M.set(U,8*Q+6);indices_data.set([4*Q,4*Q+2,4*Q+1,4*Q+1,4*Q+2,4*Q+3],6*Q)}G.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);l.setUniform("u_model",r||h.IDENTITY);l.setUniform("u_color",this._color);l.setUniform("u_camera_front",
B._front);l.setUniform("u_camera_position",B.eye);l.setUniform("u_lineWidth",.5*b);l.setUniform("u_camera_perspective",B._projection_matrix[5]);l.setUniform("u_viewport",gl.viewport_data);l.setUniform("u_viewprojection",B._viewprojection_matrix);l.drawRange(G,gl.TRIANGLES,0,C*(f?6:3));return G};h.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
v.prototype.getAssetFullPath=function(a,b){if(-1==a.indexOf("://")&&!b&&this.assets_folder){if(this.onGetAssetsFolder)return this.onGetAssetFolder(a);b="/"==this.assets_folder.substr(-1);var f="/"==a[0];return b!=f?this.assets_folder+a:b&&f?this.assets_folder+a.substr(1):this.assets_folder+"/"+a}return a};v.prototype.loadMesh=function(a,b,f){if(!a)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var r=this.meshes[a];if(r)return b&&b(r),
r;var l=this;f=this.getAssetFullPath(a,f);f=GL.Mesh.fromURL(f,function(B){B?l.meshes[a]=B:(l.assets_not_found[a]=!0,delete l.meshes[a]);l.num_assets_loading--;delete l.assets_loading[a];b&&b(B,a)});this.assets_loading[a]=f;this.num_assets_loading++;return this.meshes[a]=f}};v.prototype.loadTexture=function(a,b,f,r){function l(I){D.debug&&console.log(" + texture loaded: "+a);I?D.textures[B]=I:D.assets_not_found[a]=!0;f&&f(I,B);D.num_assets_loading--;delete D.assets_loading[a];if(D.on_texture_load)D.on_texture_load(I,
B)}if(!a)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var B=a;b&&(b.name&&(B=b.name),b.preview&&(B=b.preview));var C=this.textures[B];if(C&&!C.is_preview)return f&&f(C),C;var D=this;r=this.getAssetFullPath(a,r);var G=null;-1!=a.indexOf("CUBEMAP")?G=GL.Texture.cubemapFromURL(r,this.default_cubemap_settings,l):this.credentials?(this.credentials.headers?this.credentials.headers["Content-Type"]="application/octet-stream":this.credentials.headers=
{"Content-Type":"application/octet-stream"},G=new GL.Texture(1,1,b),fetch(r,this.credentials).then(function(I){if(!I.ok)throw Error("HTTP "+I.status+":"+I.statusText);return I.arrayBuffer()}).then(function(I){var M=URL.createObjectURL(new Blob([I]));b.texture=G;G=GL.Texture.fromURL(M,b,l);b.texture=null;setTimeout(function(){URL.revokeObjectURL(M)},6E4)})):G=GL.Texture.fromURL(r,b,l);b&&b.preview&&(G.is_preview=!0);this.assets_loading[a]=G;this.num_assets_loading++;return this.textures[B]=G}};v.prototype.loadTextureAtlas=
function(a,b,f){"string"==typeof a&&(a=JSON.parse(a));var r=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(l){var B=a.files;r.textures[":atlas"]=l;for(var C in B)if(!r.textures[C]||r.textures[C].is_preview){var D=B[C],G=new GL.Texture(a.size,a.size,{wrap:gl.REPEAT,filter:gl.LINEAR});G.drawTo(function(){l.gl.drawTexture(l,0,0,a.size,a.size,D.x,D.y,D.width||a.size,D.height||a.size)});G.is_preview=!0;r.textures[C]=G}f&&f(B)})};v.prototype.loadShaders=function(a,
b,f,r){var l=this;-1!=a.indexOf("://")||r||(a=this.assets_folder+a);a+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(a,function(B){l.compileShadersFromAtlas(B,f);l.loading_shaders=!1;b&&b(B)})};v.prototype.reloadShaders=function(a){};v.prototype.compileShadersFromAtlasCode=function(a,b){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a,b)};v.prototype.compileShadersFromAtlas=function(a,b){var f=a.shaders;if(f){this.shader_files=a;for(var r in a)a[r]=GL.Shader.expandImports(a[r],
a);f=f.split("\n");for(r=0;r<f.length;++r){var l=f[r].trim().split(" "),B=l[0].trim();if("//"!=B.substr(0,2)){var C=a[l[1]],D=a[l[2]],G=null,I={};if(3<l.length)for(var M=3;M<l.length;++M)if("#"==l[M][0])I[l[M].substr(1)]=!0;else{G=l.slice(M).join(" ");break}if(!I.WEBGL1||1==gl.webgl_version)if(!I.WEBGL2||2==gl.webgl_version){l[1]&&"@"==l[1][0]&&(I=l[1].substr(1)+"_VERTEX_SHADER",GL.Shader[I]&&(C=GL.Shader[I]));l[2]&&"@"==l[2][0]&&(I=l[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[I]&&(D=GL.Shader[I]));
if(G)try{G=JSON.parse(G)}catch(P){console.error("Error in shader macros: ",B,G,P)}if(G&&b){I={};for(var O in G)I[O]=G[O];for(O in b)I[O]=b[O];G=I}else b&&(G=b);try{C&&D?this.shaders[B]?this.shaders[B].updateShader(C,D,G):this.shaders[B]=new GL.Shader(C,D,G):console.warn("Shader subfile not found: ",l[1],l[2])}catch(P){GL.Shader.dumpErrorToConsole(P,C,D)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};v.prototype.setShadersFromFile=function(a){a=GL.processFileAtlas(a);
this.compileShadersFromAtlas(a)};v.cubemap_info=[{front:[1,0,0],up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];v.prototype.renderToCubemap=function(a,b,f,r,l,B,C){var D=v.cubemap_camera;D||(v.cubemap_camera=D=new h.Camera);D.perspective(90,1,B||.1,C||1E3);var G=vec3.create(),I=this;a.drawTo(function(M,O){M=v.cubemap_info[O];vec3.add(G,f,M.front);D.lookAt(f,G,M.up);I.clear();I.render(b,D,r,
l)});return a};v.prototype.drawSphere3D=function(a,b,f){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var r=gl.shaders.flat;r.setUniform("u_color",f);r.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(p);mat4.translate(p,p,a);mat4.scale(p,p,[b,b,b]);r.setUniform("u_model",p);r.draw(gl.meshes.sphere);this.draw_calls+=1};v.prototype.drawCircle2D=function(a,b,f,r,l){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=
GL.Mesh.ring({radius:1,thickness:.02,slices:64}));var B=gl.shaders.flat;B.setUniform("u_color",r);B.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(p);mat4.translate(p,p,[a,b,0]);mat4.scale(p,p,[2*f,2*f,2*f]);B.setUniform("u_model",p);B.draw(gl.meshes[l?"circle":"ring"]);this.draw_calls+=1};v.prototype.drawLine2D=function(a,b,f,r,l,B,C){var D=gl.meshes.plane;C=C||gl.shaders.flat;C.setUniform("u_color",B);C.setUniform("u_viewprojection",this._viewprojection2D_matrix);var G=
f-a,I=r-b;B=Math.atan2(G,I);G=Math.sqrt(G*G+I*I);l/=2;mat4.identity(p);mat4.translate(p,p,[.5*(a+f),.5*(b+r),0]);mat4.rotate(p,p,B,h.FRONT);a=l;mat4.scale(p,p,[a,G,a]);C.setUniform("u_model",p);C.draw(D);this.draw_calls+=1};v.prototype.renderDebugSceneTree=function(a,b){for(var f=[],r=0;r<a._nodes.length;++r){var l=a._nodes[r];if(l._parent&&l._parent!=a.root){var B=l._parent.getGlobalPosition();l=l.getGlobalPosition();f.push(B[0],B[1],B[2],l[0],l[1],l[2])}}f=new Float32Array(f);this.renderPoints(f,
null,b,null,null,null,GL.LINES);this.renderPoints(f,null,b,null,null,-10,GL.POINTS)};h.sortByDistance=function(a,b){a.forEach(function(f){f._distance=f.getDistanceTo(b)});a.sort(function(f,r){return r._distance-f._distance})};h.noBlending=function(a){return a.blend_mode===h.BLEND_NONE};h.generateTextureAtlas=function(a,b,f,r,l){b=b||1024;f=f||1024;r=r||64;var B=0,C;for(C in a)B++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);B=new GL.Texture(b,f);var D={width:b,height:f,
size:r,files:{}},G=0,I=0,M={};B.drawTo(function(){for(var O in a)if(":"!=O[0]&&"white"!=O&&"black"!=O&&"notfound"!=O){var P=a[O];if(!P.is_preview&&P.texture_type==gl.TEXTURE_2D){if(l){var N=P.toBase64().hashCode();if(M[N]){D.files[O]=D.files[M[N]];continue}M[N]=O}D.files[O]={x:G,y:I};P.renderQuad(G,I,r,r);G+=r;if(G==b&&(G=0,I+=r,I==f)){console.warn("Atlas too small, some textures wont be stored.");break}}}});B.info=D;console.log(D);return B};v.prototype.computeResourcesLoaded=function(a){var b=0,
f;for(f in a){var r=a[f],l=this.textures[r];l&&!1===l.ready||(r=this.meshes[r])&&!1===r.ready||(l||r)&&b++}return b};Object.defineProperty(v.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(a){},enumerable:!0});Object.defineProperty(v.prototype,"textures",{get:function(){return this.gl.textures},set:function(a){},enumerable:!0});Object.defineProperty(v.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(a){},enumerable:!0});v.prototype.addMesh=function(a,
b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};h.Renderer=v;h.Ray=u;u.prototype.testPlane=function(a,b){return geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point)};u.prototype.testSphere=function(a,b,f){return geo.testRaySphere(this.origin,this.direction,a,b,this.collision_point,f)};u.prototype.closestPointOnRay=function(a,b,f){f=f||vec3.create();var r=vec3.create();vec3.add(r,this.origin,this.direction);var l=vec3.create();vec3.add(l,a,b);geo.closestPointBetweenLines(this.origin,
r,a,l,null,f);return f};h.Factory=function(a,b,f){a=h.Factory.templates[a];var r=new h.SceneNode;a&&r.fromJSON(a);b&&(b.constructor===h.Scene?b.root:b).addChild(r);f&&r.fromJSON(f);return r};h.Factory.templates={grid:{mesh:"grid",material:{primitive:1,color:[.5,.5,.5,.5],blend_mode:h.BLEND_ALPHA}},sphere:{mesh:"sphere"},floor:{mesh:"planeXZ",scaling:10}};m.prototype._ctor=function(){F.prototype._ctor.call(this);this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);
this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};m.prototype.updateVertices=function(a){a&&(this.vertices=a);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};
m.prototype.updateNormals=function(a){a&&(this.normals=a);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};m.prototype.updateCoords=function(a){a&&(this.coords=a);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=
new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};m.prototype.updateIndices=function(a){a&&(this.indices=a);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",
this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=a.length};m.prototype.preRender=function(){this._total&&(this.draw_range=[0,this._total_indices?this._total_indices:this._total/3])};extendClass(m,F);h.DynamicMeshNode=m;q.prototype._ctor=function(){this.mesh="cube";this.scaling=[10,10,10];this.flags.depth_test=!1;this.flags.two_sided=!0};q.prototype.render=function(a,b){this.position=b.position;
this.updateGlobalMatrix(!0);a.setModelMatrix(this._global_matrix);a.renderNode(this,b)};extendClass(q,F);h.Skybox=q;h.parseTextConfig=function(a){function b(r,l){for(var B=f.shift();B;)if(0==B.trim().length)B=f.shift();else{for(var C=0;"\t"==B[C]&&C<B.length;)C++;if(C<l)break;var D={children:[]};try{var G=B.trim();-1!=G.indexOf(":")&&(G="{"+G+"}");var I=new Function("return "+G);D.data=I()}catch(M){console.error(M)}C>=l&&(r&&r.children.push(D),B=b(D,C+1))}return B}var f=a.split("\n");a={data:"",children:[]};
b(a,0);return a};v.prototype.createShaders=function(){gl._shaders_created&&(this._flat_shader=gl.shaders.flat,this._flat_instancing_shader=gl.shaders.flat_instancing,this._flat_skinning_shader=gl.shaders.flat_skinning,this._point_shader=gl.shaders.point,this._color_shader=gl.shaders.color,this._texture_shader=gl.shaders.texture,this._texture_albedo_shader=gl.shaders.texture_albedo,this._texture_instancing_shader=gl.shaders.texture_instancing,this._texture_albedo_instancing_shader=gl.shaders.texture_albedo_instancing,
h.Skeleton&&(this._texture_skinning_shader=gl.shaders.texture_skinning),this._texture_transform_shader=gl.shaders.texture_transform,this._phong_shader=gl.shaders.phong,this._phong_shader._uniforms=this._phong_uniforms,this._phong_shader.uniforms(this._phong_uniforms),this._phong_instancing_shader=gl.shaders.phong_instancing,this._phong_instancing_shader._uniforms=this._phong_uniforms,this._phong_instancing_shader.uniforms(this._phong_uniforms),this._textured_phong_shader=gl.shaders.textured_phong,
this._textured_phong_shader.uniforms(this._phong_uniforms),this._textured_phong_instancing_shader=gl.shaders.textured_phong_instancing,this._textured_phong_instancing_shader.uniforms(this._phong_uniforms),this._normal_shader=gl.shaders.normal,this._uvs_shader=gl.shaders.uvs);var a="",b="";h.Skeleton&&(a=`
		#ifdef SKINNING
			${h.Skeleton.shader_code} //
		#endif
		`,b="\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t");a=this._vertex_shader=`
				precision highp float;
				attribute vec3 a_vertex;
				attribute vec3 a_normal;
				attribute vec2 a_coord;
				varying vec3 v_pos;
				varying vec3 v_normal;
				varying vec2 v_coord;
				#ifdef COLOR
				attribute vec4 a_color;
				varying vec4 v_color;
				#endif
				${a}
				#ifdef INSTANCING
					attribute mat4 u_model;
				#else
					uniform mat4 u_model;
				#endif
				uniform mat4 u_viewprojection;
				void main() {
					v_pos = a_vertex;
					v_normal = a_normal;
					${b}
					v_pos = (u_model * vec4(v_pos,1.0)).xyz;
					v_normal = (u_model * vec4(v_normal,0.0)).xyz;
					v_coord = a_coord;
					#ifdef COLOR
					v_color = a_color;
					#endif
					gl_Position = u_viewprojection * vec4( v_pos, 1.0 );
					gl_PointSize = 2.0;
				}
				`;b=this._flat_fragment_shader="\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\t#ifdef COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t\t#endif\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color = u_color;\n\t\t\t\t\t#ifdef COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t\t#endif\n\t\t\t\t  gl_FragColor = color;\n\t\t\t\t}\n\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,b);gl.shaders.flat_color=this._flat_instancing_shader=new GL.Shader(a,b,{COLOR:""});gl.shaders.flat_instancing=
this._flat_instancing_shader=new GL.Shader(a,b,{INSTANCING:""});gl.shaders.flat_color_instancing=this._flat_instancing_shader=new GL.Shader(a,b,{INSTANCING:"",COLOR:""});gl.shaders.flat_skinning=this._flat_skinning_shader=new GL.Shader(a,b,{SKINNING:""});gl.shaders.flat_color_skinning=this._flat_skinning_shader=new GL.Shader(a,b,{SKINNING:"",COLOR:""});this._point_shader=new GL.Shader("\n\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tuniform mat4 u_mvp;\n\t\t\t\tuniform float u_pointSize;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\t}\n\t\t\t\t",
"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\n\t\t\t\t     discard;\n\t\t\t\t  gl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t\tuniform vec4 u_color;\n\t\tuniform mat4 u_mvp;\n\t\tvoid main() {\n\t\t\tv_color = a_color * u_color;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec4 v_color;\n\t\tvoid main() {\n\t\t  gl_FragColor = v_color;\n\t\t}\n\t");gl.shaders.color=this._color_shader;b="\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\t#ifdef COLOR\n\t\tvarying vec4 v_color;\n\t\t#endif\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\t#ifdef COLOR\n\t\t\t\tcolor *= v_color;\n\t\t\t#endif\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t";
gl.shaders.texture=this._texture_shader=new GL.Shader(a,b);gl.shaders.texture_albedo=this._texture_albedo_shader=new GL.Shader(a,b,{ALBEDO:""});gl.shaders.texture_albedo_color=this._texture_albedo_color_shader=new GL.Shader(a,b,{ALBEDO:"",COLOR:""});gl.shaders.texture_albedo_skinning=this._texture_albedo_skinning_shader=new GL.Shader(a,b,{SKINNING:"",ALBEDO:""});gl.shaders.texture_albedo_color_skinning=this._texture_albedo_color_skinning_shader=new GL.Shader(a,b,{SKINNING:"",ALBEDO:"",COLOR:""});
gl.shaders.texture_instancing=this._texture_instancing_shader=new GL.Shader(a,b,{INSTANCING:""});gl.shaders.texture_albedo_instancing=this._texture_albedo_instancing_shader=new GL.Shader(a,b,{ALBEDO:"",INSTANCING:""});gl.shaders.texture_albedo_color_instancing=this._texture_albedo_instancing_shader=new GL.Shader(a,b,{ALBEDO:"",INSTANCING:"",COLOR:""});h.Skeleton&&(gl.shaders.texture_skinning=this._texture_skinning_shader=new GL.Shader(a,b,{SKINNING:""}));this._texture_transform_shader=new GL.Shader("\n\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_mvp;\n\t\tuniform mat3 u_texture_matrix;\n\t\tvoid main() {\n\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform float u_global_alpha_clip;\n\t\tuniform sampler2D u_color_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");gl.shaders.texture_transform=this._texture_transform_shader;b=this._fragment_shader="\n\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec3 u_ambient;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_vector;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef TEXTURED\n\t\t\t\tuniform sampler2D u_color_texture;\n\t\t\t#endif\n\t\t\t#ifdef UNIFORMS\n\t\t\t\tUNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef TEXTURED\n\t\t\t\t\tcolor *= texture2D( u_color_texture, v_coord );\n\t\t\t\t#endif\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(u_light_vector,N));\n\t\t\t\t#ifdef EXTRA\n\t\t\t\t\tEXTRA\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color * (vec4(u_ambient,1.0) + NdotL * vec4(u_light_color,1.0));\n\t\t\t}\n\t";
gl.shaders.phong=this._phong_shader=new GL.Shader(a,b);this._phong_shader._uniforms=this._phong_uniforms;this._phong_shader.uniforms(this._phong_uniforms);gl.shaders.phong_instancing=this._phong_instancing_shader=new GL.Shader(a,b,{INSTANCING:""});this._phong_instancing_shader._uniforms=this._phong_uniforms;this._phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.textured_phong=this._textured_phong_shader=new GL.Shader(a,b,{TEXTURED:""});this._textured_phong_shader.uniforms(this._phong_uniforms);
gl.shaders.textured_phong_instancing=this._textured_phong_instancing_shader=new GL.Shader(a,b,{INSTANCING:"",TEXTURED:""});this._textured_phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.normal=this._normal_shader=new GL.Shader(a,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4( normalize(v_normal),1.0);\n\t\t\t}\n\t");gl.shaders.uvs=this._uvs_shader=new GL.Shader(a,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(v_coord,0.0,1.0);\n\t\t\t}\n\t");
gl._shaders_created=!0};h.orientNodeToCamera=function(a,b,f,r){a&&(a==h.BILLBOARD_CYLINDRIC||a==h.BILLBOARD_PARALLEL_CYLINDRIC?(a==h.BILLBOARD_CYLINDRIC?(a=b.getGlobalPosition(y),vec3.sub(t,f._position,a),w[0]=t[0],w[1]=t[2]):(w[0]=f._front[0],w[1]=f._front[2]),f=vec2.computeSignedAngle(w,h.FRONT2D),isNaN(f)||(mat4.rotateY(p,e,-f),b._global_matrix.set(p),mat4.setTranslation(b._global_matrix,b._position),mat4.scale(b._global_matrix,b._global_matrix,b._scale))):(a==h.BILLBOARD_PARALLEL_SPHERIC?(b._global_matrix.set(f._model_matrix),
mat4.setTranslation(b._global_matrix,b._position)):(mat4.lookAt(b._global_matrix,b._position,f.position,h.UP),mat4.invert(b._global_matrix,b._global_matrix)),mat4.scale(b._global_matrix,b._global_matrix,b._scale)),r.setModelMatrix(b._global_matrix))};h.makeHash=function(a){let b="";for(var f=0;f<a;f++)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(62*Math.random()|0);return b};h.readPixels=function(a,b){var f=new Image;f.src=a;f.onload=function(){var r=document.createElement("canvas");
r.width=this.width;r.height=this.height;var l=r.getContext("2d");l.drawImage(this,0,0);r=l.getImageData(0,0,r.width,r.height);b(r,this)}};h.alignDivToNode=function(a,b,f,r,l,B){function C(N){return 1E-5>Math.abs(N)?0:N}function D(N){return"matrix3d("+C(N[0])+","+C(-N[1])+","+C(N[2])+","+C(N[3])+","+C(N[4])+","+C(-N[5])+","+C(N[6])+","+C(N[7])+","+C(N[8])+","+C(-N[9])+","+C(N[10])+","+C(N[11])+","+C(N[12])+","+C(-N[13])+","+C(N[14])+","+C(N[15])+")"}var G=parseInt(a.clientWidth),I=parseInt(a.clientHeight),
M=.5*G,O=.5*I,P=l._projection_matrix[5]*O;a.style.width=gl.canvas.width+"px";a.style.height=gl.canvas.height+"px";a.style.perspective=P+"px";a.style.pointerEvents="none";b&&(a="translateZ("+P+"px) "+D(l._view_matrix),b.style.transformStyle="preserve-3d",b.style.transform=a+" translate("+M+"px,"+O+"px)",b.style.width=G+"px",b.style.height=I+"px",b.style.pointerEvents="none");r=r.getGlobalMatrix();G=1/f.clientWidth;I=1/f.clientHeight;f.parentNode!=b&&b.appendChild(f);f.style.pointerEvents=B?"auto":
"none";f.style.transform=function(N){return"translate(-50%,-50%) matrix3d("+(C(N[0])+","+C(N[1])+","+C(N[2])+","+C(N[3])+","+C(-N[4])+","+C(-N[5])+","+C(-N[6])+","+C(-N[7])+","+C(N[8])+","+C(N[9])+","+C(N[10])+","+C(N[11])+","+C(N[12])+","+C(N[13])+","+C(N[14])+","+C(N[15])+")")}(r)+" scale3D("+G+","+I+",1)"};F.prototype.move=F.prototype.translate;F.prototype.setRotationFromEuler=F.prototype.setEulerRotation;F.prototype.getGlobalPoint=F.prototype.localToGlobal;F.prototype.serialize=F.prototype.toJSON;
F.prototype.configure=F.prototype.fromJSON;F.ctor=F.prototype._ctor;K.prototype.configure=K.prototype.fromJSON;K.prototype.serialize=K.prototype.toJSON;d.prototype.configure=d.prototype.fromJSON;d.prototype.serialize=d.prototype.toJSON;"undefined"==typeof GL&&(mat4.rotateVec3=function(a,b,f){var r=f[0],l=f[1];f=f[2];a[0]=b[0]*r+b[4]*l+b[8]*f;a[1]=b[1]*r+b[5]*l+b[9]*f;a[2]=b[2]*r+b[6]*l+b[10]*f;return a},mat4.projectVec3=function(a,b,f){var r=f[0],l=f[1];f=f[2];var B=b[1]*r+b[5]*l+b[9]*f+b[13],C=b[2]*
r+b[6]*l+b[10]*f+b[14],D=b[3]*r+b[7]*l+b[11]*f+b[15];a[0]=((b[0]*r+b[4]*l+b[8]*f+b[12])/D+1)/2;a[1]=(B/D+1)/2;a[2]=(C/D+1)/2;return a})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(x){function d(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=.5;this.particles_acceleration=vec3.create();this.velocity_variation=this.particles_end_scale=this.particles_start_scale=
1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function A(){this._ctor()}function v(u){this._ctor();u&&this.configure(u)}extendClass(d,RD.SceneNode);RD.ParticlesEmissor=d;d.prototype.update=
function(u){var m=this.particles.length,q=this.particles_damping,n=this.particles_acceleration,z=vec3.length(n);if(m){for(var h=[],c=0;c<m;c++){var k=this.particles[c];vec3.scaleAndAdd(k.pos,k.pos,k.vel,u);z&&vec3.scaleAndAdd(k.vel,k.vel,n,u);q&&vec3.scaleAndAdd(k.vel,k.vel,k.vel,-u*q);k.ttl-=u;0<k.ttl&&h.push(k)}this.particles=h}m=this.getGlobalPosition();q=this.emissor_direction;n=this.particles_life;z=this.num_textures*this.num_textures;h=this.velocity_variation;if(0<this.particles_per_second)for(u=
this.particles_per_second*(u+this._accumulated_time),this._accumulated_time=(u-Math.floor(u))/this.particles_per_second,u=Math.floor(u),c=0;c<u&&!(this.particles.length>=this.max_particles);c++)q=vec3.clone(q),q[0]+=.5*Math.random()*h,q[2]+=.5*Math.random()*h,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*z)/z,pos:vec3.clone(m),vel:q,ttl:n})};d.prototype.render=function(u,m){if(0!=this.particles.length){this.updateVertices();var q=this._meshes[u.gl.context_id];q||(q=
new GL.Mesh(void 0,void 0,u.gl),this._vertices_buffer=q.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=q.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=q;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);q=gl.shaders[this.shader];q||(q=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(d._vertex_shader,d._pixel_shader));this.draw_range[1]=this.particles.length;
q=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/q[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(u._model_matrix);u._mvp_matrix.set(u._viewprojection_matrix);u.renderNode(this,u,m)}};d.prototype.updateVertices=function(u){if(u=
this.particles.length)for(var m=this._vertices,q=this._extra,n=0,z=this.particles_life,h=this.num_textures*this.num_textures,c=0;c<u;c++){var k=this.particles[c];m.set(k.pos,n);q[n]=1;q[n+1]=k.ttl/z;1<h&&(q[n+2]=k.tex);n+=3}};extendClass(A,RD.SceneNode);RD.Billboard=A;A.SPHERIC=1;A.PARALLEL_SPHERIC=2;A.CYLINDRIC=3;A.PARALLEL_CYLINDRIC=4;A.prototype._ctor=function(){this.billboard_mode=A.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};A.prototype.render=function(u,m){!1!==this.flags.visible&&
(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,m,u),u.renderNode(this,u,m))};v.prototype._ctor=function(){SceneNode.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=RD.TOP_LEFT;this.blend_mode=RD.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=
this.texture_matrix};Object.defineProperty(v.prototype,"angle",{get:function(){return this._angle},set:function(u){this._angle=u;quat.setAxisAngle(this._rotation,RD.FRONT,this._angle*DEG2RAD);this._must_update_matrix=!0},enumerable:!0});v.prototype.setSize=function(u,m){this.size[0]=u;this.size[1]=m};v.createFrames=function(u,m,q){q=q||{};if(u.constructor!=Number){num_columns=u[0];var n=u[1]}else n=num_columns=u;var z=u=0,h=1/num_columns,c=1/n;n*=num_columns;if(!m){m=[];for(var k=0;k<n;++k)m.push(String(k))}for(k=
0;k<m.length&&!(q[m[k]]={pos:[u,z],size:[h,c],normalized:!0},u+=h,1<=u&&(u=0,z+=c),1<=z);++k);return q};v.prototype.createFrames=function(u,m){v.createFrames(u,m,this.frames)};v.prototype.addFrame=function(u,m,q,n,z,h){this.frames[u]={pos:vec2.fromValues(m,q),size:vec2.fromValues(n,z),normalized:!!h}};v.prototype.updateTextureMatrix=function(u){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var m=u.textures[this.texture];if(!m&&u.autoload_assets){var q=this;-1!=this.texture.indexOf(".")&&
u.loadTexture(this.texture,u.default_texture_settings,function(h){h&&0==q.size[0]&&0==q.size[0]&&q.setSize(h.width,h.height)});m=gl.textures.white}if(!m)return!1;u=this.texture_matrix;var n=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!n)return!1;if(!n)return this.flags.flipX&&(temp_vec2[0]=this.flags.flipX?1:0,temp_vec2[1]=0,mat3.translate(u,u,temp_vec2),temp_vec2[0]=this.flags.flipX?-1:1,temp_vec2[1]=1,mat3.scale(u,u,temp_vec2)),!0;if(n.normalized)temp_vec2[0]=this.flags.flipX?
n.pos[0]+n.size[0]:n.pos[0],temp_vec2[1]=1-n.pos[1]-n.size[1],mat3.translate(u,u,temp_vec2),temp_vec2[0]=n.size[0]*(this.flags.flipX?-1:1),temp_vec2[1]=n.size[1];else{var z=m.height;temp_vec2[0]=(this.flags.flipX?n.pos[0]+n.size[0]:n.pos[0])/m.width;temp_vec2[1]=(z-n.pos[1]-n.size[1])/z;mat3.translate(u,u,temp_vec2);temp_vec2[0]=n.size[0]*(this.flags.flipX?-1:1)/m.width;temp_vec2[1]=n.size[1]/m.height}mat3.scale(u,u,temp_vec2);return!0};v.prototype.render=function(u,m){if(this.texture&&this.updateTextureMatrix(u)){var q=
u.textures[this.texture];if(q){this.flags.pixelated&&(q.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.billboard_mode&&RD.orientNodeToCamera(this.billboard_mode,this,m,u);0==this.size[0]&&!1!==q.ready&&(this.size[0]=q.width);0==this.size[1]&&!1!==q.ready&&(this.size[1]=q.height);var n=this.size,z=0,h=0;temp_mat4.set(this._global_matrix);
var c=!1;this.current_frame&&this.current_frame.size&&(n=this.current_frame.size,c=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case RD.TOP_LEFT:z=.5;h=-.5;break;case RD.TOP_CENTER:h=-.5;break;case RD.TOP_RIGHT:z=-.5;break;case RD.BOTTOM_LEFT:h=z=.5;break;case RD.BOTTOM_CENTER:h=.5;break;case RD.BOTTOM_RIGHT:z=-.5,h=.5}mat4.translate(temp_mat4,temp_mat4,[z*q.width*n[0],h*q.height*n[1],0])}c?mat4.scale(temp_mat4,temp_mat4,[q.width*n[0],q.height*n[1],1]):mat4.scale(temp_mat4,
temp_mat4,[this.size[0],this.size[1],1]);u.setModelMatrix(temp_mat4);u.renderNode(this,u,m)}}};extendClass(v,RD.SceneNode);RD.Sprite=v})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(x){function d(e){this._ctor();e&&this.configure(e);this.render_priority=0;this.targets=null;this.size=150;this.mode=d.DEFAULT;this.coordinates=d.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();this.onDuplicateTargets=this.onActionFinished=null;e={x:d.XAXIS_COLOR,y:d.YAXIS_COLOR,z:d.ZAXIS_COLOR};var g="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");
this.actions={};for(var p in g){var w=g[p],t={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:.15,visible:!1,flag:d[w.toUpperCase()]};0==w.indexOf("move")&&(t.move=!0);0==w.indexOf("rotate")&&(t.rotate=!0);0==w.indexOf("scale")&&(t.scale=!0);t.color=e[w[w.length-1]];if(t.move||t.rotate)t.cursor="crosshair";this.actions[w]=t}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=
vec3.fromValues(0,1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1;this.mesh="sphere";this.createMaterial({name:"gizmo"}).render=d.prototype.render.bind(this)}d.MOVEX=1;d.MOVEY=2;d.MOVEZ=4;d.MOVEXY=8;d.MOVEXZ=16;d.MOVEYZ=32;d.ROTATEX=64;d.ROTATEY=128;d.ROTATEZ=
256;d.SCALEX=512;d.SCALEY=1024;d.SCALEZ=2048;d.SCALEXY=4096;d.SCALEYZ=8192;d.SCALEXZ=16384;d.SCALE=32768;d.DRAG=65536;d.ROTATE=131072;d.ROTATEFRONT=262144;d.RESIZE=524288;d.MOVEAXIS=d.MOVEX|d.MOVEY|d.MOVEZ;d.MOVEPLANAR=d.MOVEXY|d.MOVEXZ|d.MOVEYZ;d.MOVEALL=d.DRAG|d.MOVEAXIS|d.MOVEPLANAR;d.PLANAR=d.MOVEX|d.MOVEZ|d.MOVEXZ|d.ROTATEY|d.SCALE;d.ROTATEALL=d.ROTATEX|d.ROTATEY|d.ROTATEZ|d.ROTATEFRONT;d.SCALEALL=d.SCALE|d.SCALEX|d.SCALEY|d.SCALEZ|d.SCALEXY|d.SCALEYZ|d.SCALEXZ;d.MOVEROTATESCALE=d.MOVEAXIS|d.MOVEPLANAR|
d.ROTATEALL|d.SCALE;d.ALL=d.MOVEAXIS|d.MOVEPLANAR|d.ROTATEALL|d.SCALEALL;d.DEFAULT=d.PLANAR;d.OBJECT_SPACE=1;d.WORLD_SPACE=2;x=mat4.create();var A=mat4.create(),v=mat4.create();mat4.create();mat4.create();mat4.create();var u=mat4.create(),m=mat4.create();mat4.create();var q=vec3.create(),n=vec3.create(),z=vec3.create(),h=vec4.create();vec4.create();mat4.translate(x,x,[1.1,0,0]);mat4.rotate(x,x,90*DEG2RAD,[0,0,-1]);mat4.translate(A,A,[0,1.1,0]);mat4.translate(v,v,[0,0,1.1]);mat4.rotate(v,v,90*DEG2RAD,
[1,0,0]);x=mat4.create();mat4.scale(x,x,[-1,-1,-1]);d.full_viewport=null;var c=mat4.create(),k=mat4.create();d.XAXIS_COLOR=[.901,.247,.349,1];d.YAXIS_COLOR=[.55,.81,.11,1];d.ZAXIS_COLOR=[.23,.57,.93,1];d.XYAXIS_COLOR=[.9,.7,.23,.75];d.XZAXIS_COLOR=[.6,.4,.7,.75];d.YZAXIS_COLOR=[.39,.69,.52,.75];d.SPHERE_COLOR=[.8,.8,.8,.4];d.RING_COLOR=[.5,.5,.5,1];d.INNERSPHERE_COLOR=[.6,.6,.6,1];d.SELECTED_COLOR=[1,1,1,1];d.NOAXIS_COLOR=[.901,.247,.749,1];d.STATIC_SPHERE_COLOR=[.1,.1,.1,.3];d.prototype.isTarget=
function(e){return-1!=this.targets.indexOf(e)};d.prototype.setTargets=function(e,g){if(e&&e.constructor!==Array)throw"nodes must be an Array";e&&0!=e.length?(g&&this.targets&&(e=this.targets.concat(e)),this.targets=e=e.filter(function(p,w){return e.indexOf(p)===w}),this.resetTransform(),this.position=this.computeCenter(this.targets)):g||(this.targets=null)};d.prototype.computeCenter=function(e){if((e=e||this.targets)&&e.length){for(var g=null,p=0;p<e.length;++p){var w=e[p];w.layers&this.layers&&(w=
w.getGlobalPosition(),g?vec3.add(g,g,w):g=w)}if(!g)return[0,0,0];vec3.scale(g,g,1/e.length);return g}};d.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?(this.transform=this.targets[0].transform,this.scaling=[1,1,1]):this.position=this.computeCenter(this.targets)))};d.prototype.updateTargets=function(){if(this.targets)for(var e=this.getGlobalMatrix(mat4.create()),
g=0;g<this.targets.length;++g){var p=this.targets[g];p.layers&this.layers&&p.fromMatrix(e,!0)}};d.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var e=0;e<this.targets.length;++e){var g=this.targets[e];g.layers&this.layers&&(this.target_tranforms[e]=new Float32Array(g.transform))}}};d.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var e=0;e<this.targets.length;++e){var g=
this.targets[e];g.layers&this.layers&&(g.transform=this.target_tranforms[e])}};d.prototype.removeTargetsFromScene=function(){if(this.targets){for(var e=0;e<this.targets.length;++e){var g=this.targets[e];g.layers&this.layers&&g.parentNode&&g.parentNode.removeChild(g)}this.targets=null}};d.prototype.getTargetBaseNodes=function(){function e(y){return-1!=p.indexOf(y)?!0:y.parentNode?e(y.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var g=[],p=this.targets,w=0;w<p.length;++w){var t=
p[w];t.layers&this.layers&&(t.parentNode&&e(t.parentNode)||g.push(t))}return g};d.prototype.applyTransformToTarget=function(e,g){var p=this.getGlobalMatrix(mat4.create()),w=mat4.invert(mat4.create(),p),t=mat4.create(),y=this.getTargetBaseNodes();if(y){for(var J=[1,1,1],F=0;F<y.length;++F){var E=y[F];J[0]=0<=E.scaling[0]?1:-1;J[1]=0<=E.scaling[1]?1:-1;J[2]=0<=E.scaling[2]?1:-1;g?(mat4.multiply(t,e,E.matrix),E.fromMatrix(t)):(E.getGlobalMatrix(t),this.coordinates==d.WORLD_SPACE&&mat4.multiply(t,w,t),
mat4.multiply(t,e,t),this.coordinates==d.WORLD_SPACE&&mat4.multiply(t,p,t),E.fromMatrix(t,!0));vec3.mul(E._scale,E._scale,J);E.position=this.applySnap(E.position);if(this.grid_size){var H=quat.toEuler(vec3.create(),E.rotation);H[0]=15*Math.round(H[0]*RAD2DEG/15)*DEG2RAD;H[1]=15*Math.round(H[1]*RAD2DEG/15)*DEG2RAD;H[2]=15*Math.round(H[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(E.rotation,H);quat.normalize(E.rotation,E.rotation)}}mat4.multiply(t,p,e);this.fromMatrix(t);this.scaling=[1,1,1];this.updateGizmo()}};
d.prototype.applyTranslation=function(e,g){var p=mat4.create();mat4.translate(p,p,e);this.applyTransformToTarget(p,g)};d.prototype.applyRotation=function(e,g,p){var w=mat4.create();if(p){var t=mat4.create();mat4.setTranslation(t,p);mat4.mul(w,w,t);mat4.rotate(w,w,e,g);mat4.setTranslation(t,[-p[0],-p[1],-p[2]]);mat4.mul(w,w,t)}else mat4.rotate(w,w,e,g);this.applyTransformToTarget(w)};d.prototype.applyScale=function(e,g){e.constructor===Number&&(e=[e,e,e]);var p=mat4.create();mat4.scale(p,p,e);this.applyTransformToTarget(p,
g)};d.prototype.applySnap=function(e){if(!this.grid_size)return e;e[0]=Math.round(e[0]/this.grid_size)*this.grid_size;e[1]=Math.round(e[1]/this.grid_size)*this.grid_size;e[2]=Math.round(e[2]/this.grid_size)*this.grid_size;return e};d.prototype.setColor=function(e){if(this.targets)for(var g=0;g<this.targets.length;++g){var p=this.targets[g];p.layers&this.layers&&(p=p.getMaterial())&&(p.color=e)}};d.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var e=
[],g=0;g<this.targets.length;++g){var p=this.targets[g];if(p.layers&this.layers){var w=p.clone(!0);p.parentNode.addChild(w);e.push(p)}}return this.targets=e}};d.prototype.onMouse=function(e){if(this._camera&&this.targets&&!1!==this.visible){var g=this._camera,p=g.getFront(),w=[e.canvasx,e.canvasy],t=g.getRay(w[0],w[1]),y=this.position,J=vec3.sub(vec3.create(),y,g.position);vec3.normalize(J,J);var F=this._selected_action,E=this.actions[F],H=this._global_matrix;g.project(y,null,this.center_2D);var L=
mat4.invert(mat4.create(),H),K=this.coordinates==d.OBJECT_SPACE;if("mousedown"==e.type){if(this.click_2D[0]=this.click_2D2[0]=w[0],this.click_2D[1]=this.click_2D2[0]=w[1],e.is_touch&&this.testMouseOver(e),F=this._selected_action=this._hover_action,E=this.actions[F])E.move&&E.axis?(L=vec3.clone(E.axis),mat4.rotateVec3(L,H,L),vec3.normalize(L,L),this._last=t.closestPointOnRay(y,L),e.shiftKey&&this.cloneTargets()):E.move&&E.normal&&(t.testPlane(y,E.normal)&&(this.click_pos=t.collision_point),e.shiftKey&&
this.cloneTargets()),"drag"==F&&(t.testPlane(y,p),this._last=t.collision_point,e.shiftKey&&this.cloneTargets()),"rotatefront"==F?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,.5*this.size),this.click_2D2.set(this.click_2D)):E.rotate&&(E.axis?(F=mat4.rotateVec3(vec3.create(),H,E.axis),t.testPlane(y,F)&&(vec3.sub(this.click_pos,t.collision_point,y),vec3.normalize(this.click_pos,
this.click_pos),y=vec3.scaleAndAdd(vec3.create(),y,this.click_pos,this.current_size),this.current_2D=this.click_2D=g.project(y))):t.testSphere(y,this.current_size)&&(this._last=t.collision_point,vec3.sub(this.click_pos,t.collision_point,y),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),J,this.click_pos))),this.click_model.set(H),this.click_transform.set(this.transform),this.click_dist=vec3.distance(this.click_2D,this.center_2D),this.saveTargetTransforms()}else if("mousemove"==
e.type)if(e.dragging&&this._selected_action){if("rotatefront"==F)return E=vec2.sub(vec3.create(),w,this.center_2D),vec2.normalize(E,E),y=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,E,.5*this.size),y=Math.atan2(E[0],E[1])-Math.atan2(y[0],y[1]),e.shiftKey&&(y=2*Math.PI*Math.ceil(36*y/(2*Math.PI))/36),y&&(this.restoreTargetTransforms(),this.applyRotation(y,J)),!0;if(E.rotate)return E.axis?(F=mat4.rotateVec3(vec3.create(),H,E.axis),t.testPlane(y,F)&&(e=vec3.sub(vec3.create(),t.collision_point,
y),vec3.normalize(e,e),y=vec3.scaleAndAdd(vec3.create(),y,e,this.current_size),this.current_2D=g.project(y),g=Math.clamp(vec3.dot(e,this.click_pos),-1,1),y=Math.acos(g),e=vec3.cross(vec3.create(),e,this.click_pos),vec3.normalize(e,e),g=vec3.dot(F,e),0<g&&(y*=-1),this.restoreTargetTransforms(),this.applyRotation(y,E.axis))):(L=vec3.cross(vec3.create(),J,this.click_pos),y=.01*(vec2.dist(this.center_2D,w)-this.click_dist),e=vec2.sub(vec2.create(),this.center_2D,w),E=vec2.sub(vec2.create(),this.center_2D,
this.click_2D),0>vec2.dot(e,E)&&(y=-y),console.log(y),this.restoreTargetTransforms(),this.applyRotation(y,L),this.click_axis=L),!0;J=null;if(E.move&&E.normal){if(t.testPlane(y,E.normal)&&(E=t.collision_point,this.applySnap(E),J=vec3.sub(vec3.create(),E,this.click_pos),this.click_pos=E,this.coordinates==d.OBJECT_SPACE))return mat4.rotateVec3(J,L,J),this.applyTranslation(J,!0),!0}else if(E.move||E.scale){g=null;E.axis&&(L=vec3.clone(E.axis),mat4.rotateVec3(L,H,L),vec3.normalize(L,L),g=t.closestPointOnRay(y,
L));if("scale"==F||E.scale&&e.ctrlKey)return e=1+.01*(w[1]-this.click_2D[1]),this.applyScale(e,K),this.click_2D[0]=w[0],this.click_2D[1]=w[1],!0;if("scalexy"==F||"scalexz"==F||"scaleyz"==F){e=1+.01*(w[1]-this.click_2D[1]);switch(F){case "scalexy":this.applyScale([e,e,1],K);break;case "scaleyz":this.applyScale([1,e,e],K);break;case "scalexz":this.applyScale([e,1,e],K)}this.click_2D[0]=w[0];this.click_2D[1]=w[1];return!0}if(E.scale)return e=vec2.distance(w,this.center_2D),E=e/this.click_dist,"scalex"==
F?this.applyScale([E,1,1],K):"scaley"==F?this.applyScale([1,E,1],K):"scalez"==F&&this.applyScale([1,1,E],K),this.click_dist=e,!0;E.move&&(K||this.applySnap(g),J=vec3.sub(vec3.create(),g,this._last),this._last.set(g))}"drag"==F&&(t.testPlane(y,this._camera.getFront()),g=t.collision_point,this.applySnap(g),J=vec3.sub(vec3.create(),g,this._last),this._last=g);if(J)return this.applyTranslation(J),!0}else this.testMouseOver(e);else if("wheel"==e.type){if("scale"==this._selected_action)return e=1+2E-4*
e.wheel,this.applyScale(e),!0;if("drag"==this._selected_action)return J=vec3.sub(vec3.create(),y,g.position),e=1+2E-4*e.wheel,vec3.scaleAndAdd(J,g.position,J,e),vec3.sub(J,J,y),this.applyTranslation(J),this._last=y,!0}if("mouseup"==e.type||this._selected_action&&0==e.buttons)if(this.saveTargetTransforms(),this._selected_action){this._selected_action=null;this.render(this._last_renderer,this._last_camera);this.testMouseOver(e);this.updateGizmo();if(this.onActionFinished)this.onActionFinished();return!0}return!1}};
d.prototype.testMouseOver=function(e){this._hover_action=null;var g=[e.canvasx,e.canvasy],p=1E5;e=null;for(var w in this.actions){var t=this.actions[w];if(t.visible){var y=vec2.distance(t.pos2D,g);y<t.radius*this.size&&y<p&&(p=y,e=w)}}e||(w=vec2.distance(this.center_2D,g),this.actions.rotatefront.visible&&10>Math.abs(w-.5*this.size)?e="rotatefront":this.mode&d.ROTATE&&w<.5*this.size&&(e="rotate"));return this._hover_action=e};d.prototype.cancel=function(){this._selected_action&&(this._selected_action=
null,this.restoreTargetTransforms())};d.prototype.render=function(e){this._last_renderer=e;var g=this._last_camera=e._camera;for(p in this.actions)this.actions[p].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.cube=GL.Mesh.cube({size:1}),gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:.1,height:.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:.02,
outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:.5*Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:.02,outerslices:64,innerslices:8}));var p=gl.meshes.torus;var w=g.getFront(),t=g.getLocalVector(RD.UP);g.getLocalVector(RD.RIGHT);var y=this._position;h.set(y);h[3]=1;var J=g._projection_matrix[5];this.updateMatrices();u.set(this._global_matrix);var F=vec3.sub(vec3.create(),y,g.position);
vec3.normalize(F,F);this._camera=g;this._unitary_model=u;var E=this._hover_action,H=this._selected_action;H&&(E=H);var L=H?this.actions[H]:null,K=this.mode;mat4.rotateVec3(n,u,RD.RIGHT);mat4.rotateVec3(z,u,RD.UP);mat4.rotateVec3(q,u,RD.FRONT);vec3.normalize(n,n);vec3.normalize(z,z);vec3.normalize(q,q);mat4.fromTranslationFrontTop(m,y,w,t);vec4.transformMat4(h,h,g._viewprojection_matrix);this.current_size=t=gl.canvas.width/gl.canvas.height*this.size*h[3]/(gl.canvas.width*J);mat4.scale(u,u,[t,t,t]);
mat4.scale(m,m,[t,t,t]);t=vec3.dot(F,n);J=vec3.dot(F,z);var R=vec3.dot(F,q),a=vec3.dot(w,RD.RIGHT),b=vec3.dot(w,RD.UP),f=vec3.dot(w,RD.FRONT);this._camera.project(y,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);F=gl.shaders[this.shader];F.uniforms(e._uniforms);F.uniforms(g.uniforms);F.uniforms(this.uniforms);if("movex"==H)mat4.rotateZ(c,u,-Math.PI/2),this.drawAxis(c,d.XAXIS_COLOR);
else if("movey"==H)this.drawAxis(u,d.YAXIS_COLOR);else if("movez"==H)mat4.rotateX(c,u,-Math.PI/2),this.drawAxis(c,d.ZAXIS_COLOR);else if("drag"==H)e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,d.XAXIS_COLOR,!0);else if(L&&L.normal&&this.render_move_plane)c.set(u),"movexz"==H?mat4.rotateX(c,c,Math.PI/2):"moveyz"==H&&mat4.rotateY(c,c,Math.PI/2),mat4.scale(c,c,[100,100,100]),F.setUniform("u_model",c),F.setUniform("u_color",[.1,.1,.1,.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),F.draw(gl.meshes.plane),
gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==H)mat4.rotateX(c,m,Math.PI/2),F.setUniform("u_model",c),F.draw(p),e.drawCircle2D(this.click_2D[0],this.click_2D[1],2,d.XAXIS_COLOR,!0),e.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,d.XAXIS_COLOR,!0),e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,d.XAXIS_COLOR,!0),e.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,d.XAXIS_COLOR),e.drawLine2D(this.click_2D2[0],this.click_2D2[1],this.center_2D[0],
this.center_2D[1],4,d.XAXIS_COLOR);else{if("rotate"==H){this.click_axis&&(mat4.fromTranslationFrontTop(c,y,w,this.click_axis),mat4.scale(c,c,[this.current_size,this.current_size,this.current_size]),this.drawAxis(c,d.NOAXIS_COLOR));this.drawRotateSphere(u,d.SPHERE_COLOR);e.drawCircle2D(this.click_2D[0],this.click_2D[1],2,d.NOAXIS_COLOR,!0);return}if(L&&L.rotate){g=L.color||d.XAXIS_COLOR;"rotatex"==H?mat4.rotateZ(c,u,Math.PI/2):"rotatey"==H?mat4.rotateY(c,u,Math.PI/2):"rotatez"==H&&mat4.rotateX(c,u,
Math.PI/2);F.setUniform("u_model",c);F.setUniform("u_color",g);F.draw(p);e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,g,!0);e.drawCircle2D(this.click_2D[0],this.click_2D[1],2,g,!0);e.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,g);e.drawCircle2D(this.current_2D[0],this.current_2D[1],2,g,!0);e.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,g);return}}"scale"==H?(e.drawCircle2D(this.center_2D[0],this.click_2D[1],2,
d.INNERSPHERE_COLOR,!0),e.drawCircle2D(this.center_2D[0],this.center_2D[1],2,d.INNERSPHERE_COLOR,!0),e.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,d.INNERSPHERE_COLOR)):(this.drawRotateSphere(u,d.STATIC_SPHERE_COLOR),K&d.ROTATE&&"rotate"==E&&this.drawRotateSphere(u,d.SPHERE_COLOR),K&d.ROTATEFRONT&&(mat4.rotateX(c,m,Math.PI/2),F.setUniform("u_model",c),F.setUniform("u_color","rotatefront"==E?d.SELECTED_COLOR:d.RING_COLOR),F.draw(p),this.actions.rotatefront.visible=
!0),.1<Math.abs(t)&&K&d.ROTATEX&&(mat4.rotateZ(c,u,Math.PI/2),0>f&&mat4.rotateX(c,c,Math.PI),0>b&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatex"==E?d.SELECTED_COLOR:d.XAXIS_COLOR,"rotatex")),.1<Math.abs(J)&&K&d.ROTATEY&&(c.set(u),0<a&&0>f?mat4.rotateY(c,c,-Math.PI/2):0>a&&0>f?mat4.rotateY(c,c,Math.PI):0>a&&0<f&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatey"==E?d.SELECTED_COLOR:d.YAXIS_COLOR,"rotatey")),.1<Math.abs(R)&&K&d.ROTATEZ&&(c.set(u),mat4.rotateX(c,c,Math.PI/2),0<a&&0>b?
mat4.rotateY(c,c,-Math.PI/2):0>a&&0>b?mat4.rotateY(c,c,Math.PI):0>a&&0<b&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatez"==E?d.SELECTED_COLOR:d.ZAXIS_COLOR,"rotatez")),.95>Math.abs(t)&&(mat4.rotateZ(c,u,0>a?-Math.PI/2:Math.PI/2),K&d.MOVEX&&this.drawArrow(c,"movex"==E?d.SELECTED_COLOR:d.XAXIS_COLOR,"movex"),K&d.SCALEX&&this.drawScale(c,"scalex"==E?d.SELECTED_COLOR:d.XAXIS_COLOR,"scalex")),.95>Math.abs(J)&&(0<b?mat4.rotateZ(c,u,Math.PI):c.set(u),K&d.MOVEY&&this.drawArrow(c,"movey"==E?d.SELECTED_COLOR:
d.YAXIS_COLOR,"movey"),K&d.SCALEY&&this.drawScale(c,"scaley"==E?d.SELECTED_COLOR:d.YAXIS_COLOR,"scaley")),.95>Math.abs(R)&&(mat4.rotateX(c,u,0>f?-Math.PI/2:Math.PI/2),K&d.MOVEZ&&this.drawArrow(c,"movez"==E?d.SELECTED_COLOR:d.ZAXIS_COLOR,"movez"),K&d.SCALEZ&&this.drawScale(c,"scalez"==E?d.SELECTED_COLOR:d.ZAXIS_COLOR,"scalez")),.2<Math.abs(R)&&(K&d.MOVEXY||K&d.SCALEXY)&&(mat4.translate(c,u,[.45*(0>t?1:-1),.45*(0>J?1:-1),0]),K&d.MOVEXY?this.drawFlat(c,"movexy"==E?d.SELECTED_COLOR:d.XYAXIS_COLOR,"movexy"):
this.drawFlat(c,"scalexy"==E?d.SELECTED_COLOR:d.XYAXIS_COLOR,"scalexy","circle")),.2<Math.abs(J)&&(K&d.MOVEXZ||K&d.SCALEXZ)&&(mat4.rotateX(c,u,Math.PI/2),mat4.translate(c,c,[.45*(0>t?1:-1),.45*(0>R?-1:1),0]),K&d.MOVEXZ?this.drawFlat(c,"movexz"==E?d.SELECTED_COLOR:d.XZAXIS_COLOR,"movexz"):this.drawFlat(c,"scalexz"==E?d.SELECTED_COLOR:d.XZAXIS_COLOR,"scalexz","circle")),.2<Math.abs(t)&&(K&d.MOVEYZ||K&d.SCALEYZ)&&(mat4.rotateY(c,u,Math.PI/2),mat4.translate(c,c,[.45*(0>R?1:-1),.45*(0>J?1:-1),0]),K&d.MOVEYZ?
this.drawFlat(c,"moveyz"==E?d.SELECTED_COLOR:d.YZAXIS_COLOR,"moveyz"):this.drawFlat(c,"scaleyz"==E?d.SELECTED_COLOR:d.YZAXIS_COLOR,"scaleyz","circle")),K&d.DRAG&&this.drawInnerSphere(u,"drag"),K&d.SCALE&&this.drawInnerSphere(u,"scale"),K&d.RESIZE&&this.drawResize(u,"resize"),gl.enable(gl.DEPTH_TEST))}}};d.prototype.drawArrow=function(e,g,p){var w=gl.shaders[this.shader],t=gl.meshes.cone,y=gl.meshes.cylinder,J=this._hover_action;mat4.translate(k,e,[0,1.1,0]);w.setUniform("u_model",k);w.setUniform("u_color",
J==p?d.SELECTED_COLOR:g);w.draw(t);this.mode==d.MOVEALL?(mat4.translate(k,k,[0,-.4,0]),mat4.scale(k,k,[1,1,1])):(mat4.translate(k,k,[0,-.15,0]),mat4.scale(k,k,[1,.5,1]));w.setUniform("u_model",k);w.draw(y);this.toScreen(k,p,[0,.6,0])};d.prototype.drawAxis=function(e,g){var p=gl.shaders[this.shader],w=gl.meshes.sphere;mat4.scale(k,e,[.01,100,.01]);p.setUniform("u_model",k);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);p.setUniform("u_color",
[g[0],g[1],g[2],.2]);gl.depthFunc(gl.GREATER);p.draw(w);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);p.setUniform("u_color",g);p.draw(w);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(e)};d.prototype.drawFlat=function(e,g,p,w){w=gl.meshes[w||"plane"];var t=gl.shaders[this.shader];mat4.scale(c,e,[.25,.25,.25]);t.setUniform("u_color",g);t.setUniform("u_model",c);gl.enable(gl.BLEND);t.draw(w);gl.disable(gl.BLEND);this.toScreen(c,p)};d.prototype.drawRotator=function(e,g,p){var w=gl.meshes.quartertorus,
t=gl.shaders[this.shader];mat4.scale(c,e,[.9,.9,.9]);t.setUniform("u_color",g);t.setUniform("u_model",c);t.draw(w);this.toScreen(c,p,[-.75,0,.75])};d.prototype.drawScale=function(e,g,p){var w=gl.meshes.cylinder,t=gl.meshes.sphere,y=gl.shaders[this.shader];y.setUniform("u_color",g);this.mode==d.SCALEALL?(mat4.translate(c,e,[0,.5,0]),mat4.scale(c,c,[1,1,1])):(mat4.translate(c,e,[0,.25,0]),mat4.scale(c,c,[1,.5,1]));y.setUniform("u_model",c);y.draw(w);mat4.translate(c,e,[0,.4,0]);this.mode==d.SCALEALL?
mat4.scale(c,c,[.1,.1,.1]):mat4.scale(c,c,[.1,.2,.1]);y.setUniform("u_model",c);y.draw(t);this.toScreen(c,p)};d.prototype.drawRotateSphere=function(e,g){var p=gl.shaders[this.shader],w=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(c,e,[.9,.9,.9]);p.setUniform("u_model",c);p.setUniform("u_color",g);p.draw(w);gl.disable(gl.BLEND)};d.prototype.drawInnerSphere=function(e,g){var p=gl.shaders[this.shader],w=gl.meshes.sphere,t=this._hover_action;mat4.scale(c,
e,[.1,.1,.1]);p.setUniform("u_model",c);p.setUniform("u_color",t==g?d.SELECTED_COLOR:d.INNERSPHERE_COLOR);p.draw(w);"drag"==g&&(mat4.scale(c,e,[.07,.07,.07]),p.setUniform("u_model",c),p.setUniform("u_color",t==g?d.INNERSPHERE_COLOR:[0,0,0,1]),p.draw(w));g&&this.toScreen(c,g)};d.prototype.drawResize=function(e,g){};d.prototype.computeBounding=function(e){e=e||BBox.create();for(var g=0;g<this.targets.length;++g){var p=this.targets[g].updateBoundingBox();0==g?BBox.copy(e,p):BBox.merge(e,e,p)}return e};
d.prototype.renderOutline=function(e,g,p,w){if((w=w||this.targets)&&w.length){var t=this.layers;w=w.filter(function(H){return H.layers&t});var y=gl.viewport_data[2],J=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==y&&this._selection_buffer.height==J||(this._selection_buffer=new GL.Texture(y,J,{magFilter:gl.NEAREST}));d.outline_material||(d.outline_material=new RD.Material({shader_name:"flat"}));var F=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,
0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);e.shader_overwrite=F;var H=e.onNodeShaderUniforms;e.onNodeShaderUniforms=function(K,R){R.setUniform("u_color",[1,1,1,1])};var L=e.pipeline;e.pipeline=null;e.overwrite_material=RD.Gizmo.outline_material;e.render(g,p,w);e.shader_overwrite=null;e.onNodeShaderUniforms=H;e.pipeline=L;e.overwrite_material=null});var E=gl.shaders.outline;E||=gl.shaders.outline=GL.Shader.createFX("\n\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n");gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(E,{u_color:[1,1,1,1],u_res:[1/y,1/J]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};d.prototype.renderCameraGizmo=function(e,g){this.drawInnerSphere};d.prototype.toScreen=function(e,g,p){g=this.actions[g];mat4.multiplyVec3(g.pos,e,p||[0,0,0]);this._camera.project(g.pos,d.full_viewport,g.pos2D);g.visible=!0};extendClass(d,RD.SceneNode);RD.Gizmo=d})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,convert_skeletons:!1,overwrite_materials:!0,rename_assets:!1,prefabs:{},texture_options:{format:GL.RGBA,
magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT,no_flip:!1},load:function(x,d,A,v){function u(e){function g(t){var y=this.buffer;y.data=t;y.dataview=new Uint8Array(t);e.length?u(e):m()}var p=e.pop(),w=z+"/"+p.uri;"blob:"==p.uri.substr(0,5)&&(w=p.uri);"data:"==p.uri.substr(0,5)?(w=_base64ToArrayBuffer(p.uri.substr(37)),g.call({buffer:p},w)):fetch(w).then(function(t){return t.arrayBuffer()}).then(g.bind({buffer:p}))}function m(){q.filename=n;q.folder=z;q.url=x;RD.GLTF.parseBuffers(q,
c);var e=RD.GLTF.parse(q),g=e.serialize();RD.GLTF.prefabs[x]=g;d&&d(e)}if(!x)throw"url missing";var q=null,n="",z="";if(x.constructor===String){z=x.split("/");n=z.pop();A=A||n.split(".").pop().toLowerCase();z=z.join("/");var h=new XMLHttpRequest;h.onload=function(){if(200!=this.status)console.error("GLTF not found",x),d&&d(null);else{var e=h.response;"gltf"==A?(q=e,u(q.buffers.concat())):"glb"==A&&((q=RD.GLTF.parseGLB(e))?m():console.error("error parsing GLB:",n))}};h.onerror=function(){console.error("Network Error");
d&&d(null)};v&&(h.onprogress=function(e){v(x,e.loaded,e.total)});h.responseType="gltf"==A?"json":"arraybuffer";h.open("GET",x);h.send()}else{var c=x;if(n=c.main){x=n;var k=c[n];"glb"==k.extension?(q=RD.GLTF.parseGLB(k.data))&&m():(q=k.data,this.parseBuffers(),m())}}},parseBuffers:function(x,d){for(var A=0;A<x.buffers.length;++A){var v=x.buffers[A];if(!v.data){if(v.uri&&"data:"==v.uri.substr(0,5))v.data=_base64ToArrayBuffer(v.uri.substr(37));else{if(!d)throw"missing data in glb";v.data=d[v.uri].data}v.dataview=
new Uint8Array(v.data)}}},parseGLB:function(x){var d=new Uint8Array(x),A=new DataView(x);if(1179937895!=A.getUint32(0,!0))return console.error("incorrect gltf header"),null;var v=A.getUint32(4,!0);console.log("GLTF Version: "+v);A.getUint32(8,!0);v=12;for(var u=null,m=0;v<d.length;){var q=A.getUint32(v,!0),n=A.getUint32(v+4,!0),z=x.slice(v+8,v+8+q);v+=8+q;if(n==RD.GLTF.JSON_CHUNK){if("undefined"===typeof TextDecoder)throw"Sorry, this browser does not support TextDecoder...";u=(new TextDecoder("utf-8")).decode(z);
u=JSON.parse(u)}else n==RD.GLTF.BINARY_CHUNK?(q=u.buffers[m],q.data=z,q.dataview=new Uint8Array(z),m++):console.warn("gltf unknown chunk type: ","0x"+n.toString(16))}return u},parse:function(x,d){console.log(x);x.url||(x.url=d||"scene.glb");d={};1<x.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var A=x.scenes[x.scene||0].nodes;this.gltf_materials={};if(x.buffers&&x.buffers.length)for(var v=0;v<x.buffers.length;++v){var u=x.buffers[v];u.uri&&!u.data&&
"data:"==u.uri.substr(0,5)&&(u.data=_base64ToArrayBuffer(u.uri.substr(37)),u.dataview=new Uint8Array(u.data))}if(x.skins)for(v=0;v<x.skins.length;++v){u=x.skins[v];for(var m=0;m<u.joints.length;++m)x.nodes[u.joints[m]]._is_joint=!0}u=null;1<A.length&&(u=new RD.SceneNode,u.name="root");for(v=0;v<A.length;++v){var q=m=A[v];null!=m.node&&(q=m.node);m=RD.GLTF.parseNode(null,q,x);u||=m;1<A.length&&u.addChild(m);m.id=x.url.replace(/\//gi,"_")+"::node_"+v;d[m.id]=d[v]=m}if(x.animations&&x.animations.length){if(RD.Animation)for(u.animations=
[],v=0;v<x.animations.length;++v)A=this.parseAnimation(v,x,d),A.id=x.filename+"::"+A.name,A&&(RD.Animations[A.id]=A,u.animations.push(A));else console.error("you must include rendeer-animation.js to allow animations");this.convert_skeletons&&this.convertSkinToSkeleton(u,u)}u.materials=this.gltf_materials;u.meta={asset:x.asset};return u},parseNode:function(x,d,A){var v=A.nodes[d];x=x||new RD.SceneNode;for(var u in v){var m=v[u];switch(u){case "name":x.name=m;break;case "translation":x.position=m;break;
case "rotation":x.rotation=m;break;case "scale":x.scaling=m;var q=0;0>x.scaling[0]&&q++;0>x.scaling[1]&&q++;0>x.scaling[2]&&q++;1==q%2&&(x.flags.frontFace=GL.CW);break;case "matrix":x.fromMatrix(m);0>mat4.determinant(m)&&(x.flags.frontFace=GL.CW);break;case "mesh":if(m=RD.GLTF.parseMesh(m,A))for(x.mesh=m.name,x.primitives=[],q=0;q<m.info.groups.length;++q){var n=m.info.groups[q],z=null;null!=n.material&&(z=this.parseMaterial(n.material,A));x.primitives.push({index:q,material:z?z.name:null,mode:n.mode});
!x.material&&z&&(x.material=z.name)}break;case "skin":x.skin=this.parseSkin(m,A);break;case "children":if(m.length)for(q=0;q<m.length;++q)n=RD.GLTF.parseNode(null,m[q],A),x.addChild(n);break;case "extras":break;default:"_"!=u[0]&&console.log("gltf node info ignored:",u,v[u])}}if(x.mesh&&x.skin)for(m=gl.meshes[x.mesh],m.bones=[],q=0;q<x.skin.joints.length;++q)m.bones.push([x.skin.joints[q],x.skin.bindMatrices[q]]);v.name||(v.name=x.name="node_"+d);v._is_joint&&(x.is_joint=!0);return x},parseMesh:function(x,
d){for(var A=d.meshes[x],v=gl.meshes,u=[],m=[],q=0,n=0;n<A.primitives.length;++n){var z=this.parsePrimitive(A,n,d);if(z){z.start=q;q+=z.length;m.push(z);var h={vertexBuffers:{},indexBuffers:{}},c;for(c in z.buffers){var k=c;"bones"==k&&(k="bone_indices");"indices"==k||"triangles"==k?h.indexBuffers[k]={data:z.buffers[c]}:h.vertexBuffers[k]={data:z.buffers[c]}}u.push({mesh:h})}}q=null;1<u.length?q=GL.Mesh.mergeMeshes(u):1==u.length&&(n=u[0].mesh,q=new GL.Mesh(n.vertexBuffers,n.indexBuffers),q.info&&
n.info&&(q.info=n.info));if(!q)return null;for(n=0;n<A.primitives.length;++n)(u=q.info.groups[n])||(q.info.groups[n]=u={}),z=A.primitives[n],u.material=z.material,u.mode=null!=z.mode?z.mode:4,u.start=m[n].start,u.length=m[n].length;q.name=A.name+"_"+x;if(!q.name||this.rename_assets)q.name=d.filename+"::mesh_"+(A.name||x);q.updateBoundingBox();q.computeGroupsBoundingBoxes();return v[q.name]=q},parsePrimitive:function(x,d,A){var v={buffers:{}},u=v.buffers;x=x.primitives[d];if(x.extensions)if(x.extensions.KHR_draco_mesh_compression){if("undefined"==
typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";u=v.buffers=this.decompressDraco(x,A);if(!u)return null}else throw"mesh data is compressed, this importer does not support it yet";else{null==!x.attributes.POSITION&&console.warn("gltf mesh without positions");for(var m in this.buffer_names){d=this.buffer_names[m];var q=x.attributes[m];null!=q&&(q=this.parseAccessor(q,A,this.flip_uv&&("coords"==d||"coords1"==d)))&&(u[d]=q)}null!=x.indices&&(u.triangles=
this.parseAccessor(x.indices,A))}if(!u.vertices)return console.error("primitive without vertices"),null;v.mode=x.mode;v.material=x.material;v.start=0;v.length=u.triangles?u.triangles.length:u.vertices.length/3;return v},convertSkinToSkeleton:function(x,d){if(x.skin){var A=d.findNodeByName(x.skin.skeleton_root);x.skeleton||(x.skeleton=new RD.Skeleton);x.skeleton.importSkeleton(A||d)}for(A=0;A<x.children.length;++A)this.convertSkinToSkeleton(x.children[A],d)},installDracoModule:function(x){var d=this.draco_data_types=
{},A=this;this.decoderModule?x&&x(this.decoderModule):"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(v){var u=A.decoderModule=v;d[u.DT_INT8]=Int8Array;d[u.DT_UINT8]=Uint8Array;d[u.DT_INT16]=Int16Array;d[u.DT_UINT16]=Uint16Array;d[u.DT_INT32]=Int32Array;d[u.DT_UINT32]=Uint32Array;d[u.DT_FLOAT32]=Float32Array;x&&x(v)}):console.error("Draco3D not installed")},decompressDraco:function(x,d){if(!this.decoderModule||!this.decoderModule.Decoder)return console.warn("Mesh with DRACO encoding, DRACO Decoder Module not found"),
null;this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,x,d)},decodePrimitive:function(x,d,A){var v={};d=A.buffers[A.bufferViews[d.extensions.KHR_draco_mesh_compression.bufferView].buffer];var u=d.dataview.buffer;A=this.decoderModule;d=new A.DecoderBuffer;d.Init(new Int8Array(u),u.byteLength);if(x.GetEncodedGeometryType(d)==A.TRIANGULAR_MESH){var m=new A.Mesh;u=x.DecodeBufferToMesh(d,m);if(!u.ok()||0===m.ptr)throw Error("GLTF Draco: Decoding failed: "+
u.error_msg());m.num_points();for(var q in this.buffer_names){u=this.buffer_names[q];var n=q;"COLOR_0"==n?n="COLOR":"TEXCOORD_0"==n&&(n="TEX_COORD");if(n=this.decodeBuffer(m,A[n],"coords"==u||"coords1"==u,x))v[u]=n.data}q=3*m.num_faces();u=4*q;n=A._malloc(u);x.GetTrianglesUInt32Array(m,u,n);v.triangles=(new Uint32Array(A.HEAPF32.buffer,n,q)).slice();A._free(n)}A.destroy(d);A.destroy(m);return v},decodeBuffer:function(x,d,A,v){if(null==d)return null;var u=this.decoderModule;d=v.GetAttributeId(x,d);
if(-1==d)return null;var m=v.GetAttribute(x,d);d=m.data_type();var q=m.num_components(),n=x.num_points();m.size();var z=n*q,h=this.draco_data_types[d];u=new u.DracoFloat32Array;v.GetAttributeFloatForAllPoints(x,m,u);x=new h(z);for(v=0;v<x.length;++v)x[v]=u.GetValue(v);if(A)for(v=1;v<x.length;v+=q)x[v]=1-x[v];return{num_points:n,num_comps:q,data_type:d,data:x}},parseAccessor:function(x,d,A,v,u){u=d.accessors[x];if(!u)return console.warn("gltf accessor not found"),null;var m=this.numComponents[u.type];
if(!m)return console.warn("gltf accessor of unknown type:",u.type),null;var q=u.count*m;switch(u.componentType){case RD.GLTF.FLOAT:q=new Float32Array(q);break;case RD.GLTF.UNSIGNED_INT:q=new Uint32Array(q);break;case RD.GLTF.SHORT:q=new Int16Array(q);break;case RD.GLTF.UNSIGNED_SHORT:q=new Uint16Array(q);break;case RD.GLTF.BYTE:q=new Int8Array(q);break;case RD.GLTF.UNSIGNED_BYTE:q=new Uint8Array(q);break;default:console.warn("gltf accessor of unsupported type: ",u.componentType),q=new Float32Array(q)}null==
v&&(v=d.bufferViews[u.bufferView]);if(!v)return console.warn("gltf bufferView not found"),null;x=d.buffers[v.buffer];if(!x||!x.data)return console.warn("gltf buffer not found or data not loaded"),null;d=new Uint8Array(q.buffer);null==v.byteOffset&&(v.byteOffset=0);var n=v.byteOffset+(u.byteOffset||0);if(v.byteStride&&v.byteStride!=m*q.BYTES_PER_ELEMENT){d=m*q.BYTES_PER_ELEMENT;n=x.dataview.subarray(n,n+v.byteLength);for(var z=new q.constructor(m),h=new Uint8Array(z.buffer),c=x=0;c<u.count;++c)h.set(n.subarray(x,
x+d)),q.set(z,c*m),x+=v.byteStride}else n=x.dataview.subarray(n,n+d.length),d.set(n);if(A)for(c=1;c<q.length;c+=m)q[c]=1-q[c];return q},parseMaterial:function(x,d){var A=d.materials[x];if(!A)return console.warn("gltf material not found"),null;var v=A.name;if(!v||this.rename_assets)v=d.filename+"::mat_"+(A.name||x);if((x=RD.Materials[v])&&(!this.overwrite_materials||x.from_filename==d.filename))return x;x=new RD.Material;x.name=v;x.from_filename=d.filename;null!=A.alphaMode&&(x.alphaMode=A.alphaMode);
x.alphaCutoff=null!=A.alphaCutoff?A.alphaCutoff:.5;null!=A.doubleSided&&(x.flags.two_sided=A.doubleSided);x.normalmapFactor=1;A.pbrMetallicRoughness&&(x.model="pbrMetallicRoughness",x.color.set([1,1,1]),x.opacity=1,x.metallicFactor=1,x.roughnessFactor=1,null!=A.pbrMetallicRoughness.baseColorFactor&&(x.color=A.pbrMetallicRoughness.baseColorFactor),A.pbrMetallicRoughness.baseColorTexture&&(x.textures.albedo=this.parseTexture(A.pbrMetallicRoughness.baseColorTexture,d),"MASK"==x.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic&&
(v=gl.textures[x.textures.albedo.texture]))&&(v.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8)),null!=A.pbrMetallicRoughness.metallicFactor&&(x.metallicFactor=A.pbrMetallicRoughness.metallicFactor),null!=A.pbrMetallicRoughness.roughnessFactor&&(x.roughnessFactor=A.pbrMetallicRoughness.roughnessFactor),A.pbrMetallicRoughness.metallicRoughnessTexture&&(x.textures.metallicRoughness=this.parseTexture(A.pbrMetallicRoughness.metallicRoughnessTexture,
d)));A.occlusionTexture&&(x.textures.occlusion=this.parseTexture(A.occlusionTexture,d));A.normalTexture&&(x.textures.normal=this.parseTexture(A.normalTexture,d));A.emissiveTexture&&(x.textures.emissive=this.parseTexture(A.emissiveTexture,d));A.emissiveFactor&&(x.emissive=A.emissiveFactor);A.extensions&&A.extensions.KHR_materials_emissive_strength&&x.emissive&&vec3.scale(x.emissive,x.emissive,A.extensions.KHR_materials_emissive_strength.emissiveStrength);RD.Materials[x.name]=x;return this.gltf_materials[x.name]=
x},parseTexture:function(x,d){var A=d.textures[x.index];if(!A)return console.warn("gltf texture not found"),null;var v=d.images[A.source];if(v.uri){var u=v.uri;u.split(".").pop()}else{u=d.url.replace(/[\/\.:]/gi,"_")+"_image_"+x.index;var m=v.mimeType?v.mimeType.split("/").pop():"png";u+="."+m}var q={};if(!gl.textures[u])if(v.uri){var n=v.uri;if("data:"==n.substr(0,5)){var z=v.uri.indexOf(","),h=v.uri.substr(5,z);m=h.split("/").pop().toLowerCase();u=d.folder+"/"+n+"image_"+x.index+"."+m;m=_base64ToArrayBuffer(v.uri.substr(z+
1));h=URL.createObjectURL(new Blob([m],{type:h}));h=GL.Texture.fromURL(h,this.texture_options);h.name=u;gl.textures[u]=h}else"blob:"==n.substr(0,5)?q.texture=n:q.texture=d.folder+"/"+n}else null!=v.bufferView&&(h=d.bufferViews[v.bufferView],null==h.byteOffset&&(h.byteOffset=0),m=d.buffers[h.buffer].data.slice(h.byteOffset,h.byteOffset+h.byteLength),h=URL.createObjectURL(new Blob([m],{type:v.mimeType})),h=GL.Texture.fromURL(h,this.texture_options),h.name=u,gl.textures[u]=h,d.asset&&d.asset.low_quality&&
(v=d.folder+"/"+d.filename.replace(/\.[^/.]+$/,"")+"/"+v.name,d.asset.hd_textures||(d.asset.hd_textures={}),d.asset.hd_textures[u]=v));q.texture||(q.texture=u);null!=A.sampler&&(d=d.samplers[A.sampler],null!=d.magFilter&&(q.magFilter=d.magFilter),null!=d.minFilter&&(q.minFilter=d.minFilter));x.texCoord&&(q.uv_channel=x.texCoord);return q},parseSkin:function(x,d){x=d.skins[x];var A={};null!=x.skeleton&&(A.skeleton_root=d.nodes[x.skeleton].name);var v=this.parseAccessor(x.inverseBindMatrices,d);if(!v)return console.warn("accessor is null"),
null;A.bindMatrices=this.splitBuffer(v,16);A.joints=[];for(v=0;v<x.joints.length;++v){var u=d.nodes[x.joints[v]];A.joints.push(u.id||u.name)}return A},splitBuffer:function(x,d){x||console.warn("buffer is null");for(var A=x.length,v=[],u=0;u<A;u+=d)v.push(new x.constructor(x.subarray(u,u+d)));return v},parseAnimation:function(x,d,A){A=d.animations[x];var v=new RD.Animation;v.name=A.name||"anim_"+x;for(var u=x=0;u<A.channels.length;++u){var m=new RD.Animation.Track,q=A.channels[u],n=A.samplers[q.sampler];
m.target_node=d.nodes[q.target.node].name;m.target_property=q.target.path.toLowerCase();if(q=this.rename_animation_properties[m.target_property])m.target_property=q;q=this.parseAccessor(n.input,d);var z=this.parseAccessor(n.output,d);if(z){var h=d.accessors[n.output].type;n=RD.TYPES[h];n==RD.VEC4&&"rotation"==m.target_property&&(n=RD.QUAT);m.type=n;if(n=RD.TYPES_SIZE[n]){h=z.length/n;for(var c=new Float32Array((1+n)*h),k=0;k<h;++k){c[k*(1+n)]=q[k];var e=z.subarray(k*n,k*n+n);c.set(e,k*(1+n)+1)}m.data=
c;m.packed_data=!0;x=Math.max(x,q[q.length-1]);v.addTrack(m)}else console.warn("gltf unknown type:",h)}else console.warn("animation accedor missing")}v.duration=x;return v},loadFromFiles:function(x,d){function A(k){var e=k.target.result,g=this.extension;if("gltf"==g)e=JSON.parse(e),v.main=this.filename;else if("glb"==g)v.main=this.filename;else if("bin"==g)q.push(this.filename);else if("jpeg"==g||"jpg"==g||"png"==g)k=URL.createObjectURL(new Blob([e],{type:k.target.mimeType})),g=GL.Texture.fromURL(k,
{wrap:gl.REPEAT,extension:g}),g.name=this.filename,gl.textures[g.name]=g,gl.textures["/textures/"+g.name]&&(gl.textures["/textures/"+g.name]=g);v[this.filename]={filename:this.filename,data:e,extension:this.extension};u--;0==u&&(v.binaries=q,m.load(v,function(p){d&&d(p)}))}for(var v={},u=x.length,m=this,q=[],n=0;n<x.length;++n){var z=x[n],h=new FileReader,c=z.name.split(".");c=c[c.length-1].toLowerCase();h.onload=A;h.filename=z.name;h.extension=c;"gltf"==c?h.readAsText(z):h.readAsArrayBuffer(z)}},
removeRootPathFromTextures:function(x,d,A){if(d)for(var v in x){d=x[v];for(var u in d.textures)if(A=d.textures[u])A.constructor===String&&0==A.indexOf(ROOM.root_path)&&-1!=A.texture.indexOf("/")?A.substr(ROOM.root_path.length):A.texture&&0==A.texture.indexOf(ROOM.root_path)&&-1!=A.texture.indexOf("/")&&(A.texture=A.texture.substr(ROOM.root_path.length))}},encodeGLTF:function(x,d){function A(t,y){y=y.data?y.data:y;var J=y.length,F=1,E=v.FLOAT;y.constructor===Uint32Array?(E=v.UNSIGNED_INT,t="SCALAR"):
y.constructor===Uint16Array?(E=v.UNSIGNED_SHORT,t="SCALAR"):"TEXCOORD_0"==t||"TEXCOORD_1"==t?(F=2,t="VEC2"):(F=3,t="VEC3");J/=F;var H=Array.from(y.subarray(0,F));var L=Array.from(y.subarray(0,F));for(var K=0;K<y.length;K++)H[K%F]=Math.min(y[K],H[K%F]),L[K%F]=Math.max(y[K],L[K%F]);y={bufferView:u.push(y)-1,byteOffset:0,componentType:E,count:J,type:t,max:L,min:H};return m.accessors.push(y)-1}var v=WebGL2RenderingContext,u=[],m={accessors:[],asset:{generator:"RendeerJS",version:"2.0"},bufferViews:[],
buffers:[{}],meshes:[],nodes:[],scene:0,scenes:[{nodes:[0]}]},q=0;d=[];var n=0,z=[];x=x.root.getAllChildren([x.root]);for(var h=0;h<x.length;++h){var c=x[h];c._index_in_glb=h;var k=c.mesh?gl.meshes[c.mesh]:null;if(k&&null==k._index_in_glb){k._index_in_glb=q++;d[k._index_in_glb]=k;k._glb_attributes={};k._glb_attributes.POSITION=A("POSITION",k.vertexBuffers.vertices);if(k.vertexBuffers.normals){for(var e=0;e<k.vertexBuffers.normals.data.length;e+=3){var g=k.vertexBuffers.normals.data.subarray(e,e+3);
vec3.normalize(g,g)}k._glb_attributes.NORMAL=A("NORMAL",k.vertexBuffers.normals)}k.vertexBuffers.coords&&(k._glb_attributes.TEXCOORD_0=A("TEXCOORD_0",k.vertexBuffers.coords));k.vertexBuffers.coords1&&(k._glb_attributes.TEXCOORD_1=A("TEXCOORD_1",k.vertexBuffers.coords1));k.indexBuffers.triangles&&(k._glb_indices=A("INDICES",k.indexBuffers.triangles));if(k.indexBuffers.triangles&&k.info&&k.info.groups){g=k.indexBuffers.triangles;var p=[];for(e=0;e<k.info.groups.length;++e){var w=k.info.groups[e];w=
new g.data.constructor(g.data.subarray(w.start,w.start+w.length));w=A("INDICES",w);p.push(w)}k._glb_indices_group=p}}c.material&&(c=RD.Materials[c.material])&&null==c._index_in_glb&&(c._index_in_glb=n++,z[c._index_in_glb]=c)}for(h=0;h<x.length;++h){c=x[h];q={};c.name&&(q.name=c.name);if(c.mesh&&(n=RD.Materials[c.material],k=gl.meshes[c.mesh])){if(c.primitives&&c.primitives.length){e={primitives:[]};for(p=0;p<c.primitives.length;++p){g={attributes:k._glb_attributes,mode:v.TRIANGLES};if(w=RD.Materials[c.primitives[h].material]||
n)g.material=w._index_in_glb;null!=k._glb_indices_group[p]&&(g.indices=k._glb_indices_group[p]);e.primitives.push(g)}p=m.meshes.length}else p=m.meshes.length,g={attributes:k._glb_attributes,mode:v.TRIANGLES},n&&(g.material=n._index_in_glb),e={primitives:[g]},null!=c.submesh&&k._glb_indices_group?g.indices=k._glb_indices_group[c.submesh]:null!=k._glb_indices&&(g.indices=k._glb_indices);m.meshes.push(e);q.mesh=p}if(c.children&&c.children.length)for(q.children=[],e=0;e<c.children.length;e++)q.children.push(c.children[e]._index_in_glb);
k=mat4.create();for(e=0;16>e;++e)if(c._local_matrix[e]!=k[e]){q.matrix=typedArrayToArray(c._local_matrix);break}c.extra&&c.extra.info&&(q.extras=c.extra.info);m.nodes[h]=q}if(z.length)for(m.materials=[],h=0;h<z.length;h++)c=z[h],m.materials[h]={alphaMode:"OPAQUE",doubleSided:c.flags.two_sided,emissiveFactor:[0,0,0],pbrMetallicRoughness:{baseColorFactor:Array.from(c.color)}};for(h=z=c=0;h<u.length;h++)c+=u[h].byteLength;m.buffers[0].byteLength=c;c=new Uint8Array(c);for(h=0;h<u.length;h++){k=u[h];q=
new Uint8Array(k.buffer);c.set(q,z);n={buffer:0,byteOffset:z,byteLength:q.byteLength};if(k.constructor===Float32Array)n.target=v.ARRAY_BUFFER;else if(k.constructor===Uint16Array||k.constructor===Uint32Array)n.target=v.ELEMENT_ARRAY_BUFFER;m.bufferViews.push(n);z+=q.byteLength}for(h=0;h<d.length;++h)delete d[h]._glb_indices,delete d[h]._index_in_glb,delete d[h]._glb_attributes;for(h=0;h<x.length;++h)delete x[h]._index_in_glb;return{json:m,binary:c}},encodeGLB:function(x,d){x=JSON.stringify(x);var A=
(new TextEncoder).encode(x);x=4*Math.ceil(A.byteLength/4);var v=4*Math.ceil(d.byteLength/4),u=new Uint8Array(20+x+8+v),m=new DataView(u.buffer);m.setUint32(0,1179937895,!0);m.setUint32(4,2,!0);m.setUint32(8,u.byteLength,!0);var q=12;m.setUint32(q,x,!0);m.setUint32(q+4,RD.GLTF.JSON_CHUNK,!0);u.set(A,q+8);for(A=A.byteLength;A<x;++A)u[q+8+A]=32;q+=8+x;m.setUint32(q,v,!0);m.setUint32(q+4,RD.GLTF.BINARY_CHUNK,!0);u.set(d,q+8);return u}};
RD.SceneNode.prototype.loadGLTF=function(x,d){function A(m){v.loading=!1;m&&v.addChild(m);d&&d(v,m)}var v=this;if(RD.GLTF.prefabs[x]){var u=new RD.SceneNode;u.configure(RD.GLTF.prefabs[x]);A(u)}else this.loading=!0,RD.GLTF.load(x,A)};function _base64ToArrayBuffer(x){x=window.atob(x);for(var d=x.length,A=new Uint8Array(d),v=0;v<d;v++)A[v]=x.charCodeAt(v);return A.buffer}"undefined"!=typeof DracoDecoderModule&&RD.GLTF.installDracoModule(RD.GLTF.onReady);
(function(x){function d(m){this.renderer=m;this.mode=d.FORWARD;this.visible_layers=65535;this.bgcolor=vec4.fromValues(.1,.1,.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.emissive_factor=this.occlusion_gamma=this.occlusion_factor=this.exposure=this.environment_factor=1;this.postfx_shader_name=null;this.allow_overlay=this.timer_queries_enabled=!0;this.brightness=this.contrast=1;this.gamma=2.2;this.parallax_reflection=
!1;this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=mat4.create();this.texture_matrix=mat3.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.skip_background=this.single_pass=!1;this.allow_instancing=!0;this.debug_instancing=!1;this.use_rendertexture=!0;this.alpha_composite_target_texture=this.fx=null;this.frame_time=-1;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_occlusion_gamma:this.occlusion_gamma,
u_background_color:this.bgcolor.subarray(0,3),u_tonemapper:0,u_gamma:this.gamma,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_viewport:gl.viewport_data,u_camera_perspective:1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec4.fromValues(0,0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),
u_backface_color:vec3.fromValues(.5,.5,.5),u_normalFactor:1,u_metallicRough:!1,u_reflectance:.1,u_texture_matrix:this.texture_matrix,u_displacement_factor:0,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:.5,u_isAnisotropic:!1,u_anisotropy:.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this._instancing_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.final_fbo=this.final_texture=
null;this.render_calls=[];this.render_calls_pool=[];this.rendered_render_calls=this.used_render_calls=0;this.current_camera=null;this.overlay_rcs=[];this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new v.Material;this.onRenderBackground=null}function A(){this.name="";this.id=-1;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=null;this.reverse_faces=
!1;this.node=this._instancing=this.skin=null;this._render_priority=0}var v=x.RD;d.FORWARD=1;d.DEFERRED=2;d.MACROS={UVS2:1,COLOR:2,POINTS:4,INSTANCING:8,SKINNING:16,PARALLAX_REFLECTION:32};d.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");d.maps_sampler=[];for(x=0;x<d.maps.length;++x)d.maps_sampler[x]="u_"+d.maps[x]+"_texture";d.prototype.render=function(m,q,n,z,h,c){this.renderer=m;this.current_camera=n;this.mode==d.FORWARD?this.renderForward(q,n,h,
c):this.mode==d.DEFERRED&&this.renderDeferred(q,n,c)};d.prototype.fillGlobalUniforms=function(m){var q=this.getBRDFIntegratorTexture();q&&q.bind(0);this.environment_texture?(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=
this.environment_rotation*DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;this.global_uniforms.u_occlusion_gamma=this.occlusion_gamma;this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3);this.global_uniforms.u_camera_perspective=m._projection_matrix[5];this.global_uniforms.u_tonemapper=0;this.quality?(this.global_uniforms.u_exposure=this.exposure,this.global_uniforms.u_gamma=this.gamma):(this.global_uniforms.u_exposure=
Math.pow(this.exposure,1/2.2),this.global_uniforms.u_gamma=this.use_rendertexture?this.gamma:1)};d.prototype.renderForward=function(m,q,n,z){var h=Math.floor(gl.viewport_data[2]*this.resolution_factor),c=Math.floor(gl.viewport_data[3]*this.resolution_factor);h=Math.min(h,this.max_texture_size);c=Math.min(c,this.max_texture_size);this.use_rendertexture&&!n&&(this.frame_texture&&this.frame_texture.width==h&&this.frame_texture.height==c||(this.frame_texture=new GL.Texture(h,c,{format:gl.RGBA,type:gl.HIGH_PRECISION_FORMAT,
filter:gl.LINEAR}),this.final_fbo?this.final_fbo.setTextures([this.frame_texture]):this.final_fbo=new GL.FBO([this.frame_texture],null,!0),this.frame_texture.name=":frame_texture",gl.textures[this.frame_texture.name]=this.frame_texture,this.final_texture=new GL.Texture(h,c,{format:gl.RGB,filter:gl.LINEAR}),this.final_texture.name=":final_frame_texture",gl.textures[this.final_texture.name]=this.final_texture),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);
gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);if(!this.skip_background){if(this.onRenderBackground)this.onRenderBackground(q,this);else this.renderSkybox(q);LEvent.trigger(this,"renderSkybox",this)}this.fillGlobalUniforms(q);if(this.onRenderOpaque)this.onRenderOpaque(this,this.renderer,q);LEvent.trigger(this,"renderOpaque",this);this.renderNodes(m,q,z);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,
q);LEvent.trigger(this,"renderAlpha",this);if(this.onRenderGizmos)this.onRenderGizmos(this,this.renderer,q);LEvent.trigger(this,"renderGizmos",this);this.use_rendertexture&&!n&&this.renderFinalBuffer();if(this.overlay_rcs.length)for(m=this.overlay_rcs,this.global_uniforms.u_gamma=1,this.global_uniforms.u_exposure=1,gl.clear(gl.DEPTH_BUFFER_BIT),q=0;q<m.length;++q)n=m[q],this.renderMeshWithMaterial(n.model,n.mesh,n.material,n.index_buffer_name,n.group_index,n.node.extra_uniforms,n.reverse_faces,n.skin)};
d.prototype.renderNodes=function(m,q,n){m=this.getAllRenderCalls(m,q,n);q=(this.alpha_composite_callback||this.alpha_composite_target_texture)&&GL.FBO.current;n=!0;for(var z=this.overlay_rcs,h=z.length=0;h<m.length;++h){var c=m[h];if(c.material.overlay&&this.allow_overlay)z.push(c);else{n&&q&&"BLEND"==c.material.alphaMode&&(n=!1,this.alpha_composite_target_texture&&GL.FBO.current.color_textures[0].copyTo(this.alpha_composite_target_texture),this.alpha_composite_callback&&this.alpha_composite_callback(GL.FBO.current,
this.alpha_composite_target_texture));var k=c.model;c._instancing&&c._instancing.length&&(k=GL.linearizeArray(c._instancing,Float32Array));this.renderMeshWithMaterial(k,c.mesh,c.material,c.index_buffer_name,c.group_index,c.node.extra_uniforms,c.reverse_faces,c.skin)}}};d.prototype.getAllRenderCalls=function(m,q,n){this.resetRenderCallsPool();for(var z=this.render_calls,h=z.length=0;h<m.length;++h)this.getNodeRenderCalls(m[h],q,n);if(this.onFilterRenderCalls)this.onFilterRenderCalls(z);for(h=0;h<z.length;++h)z[h].computeRenderPriority(q._position);
z=z.sort(d.rc_sort_function);this.allow_instancing&&gl.extensions.ANGLE_instanced_arrays&&(z=this.groupRenderCallsForInstancing(z));return z};d.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.frame_texture,null,this.frame_texture);this.fx_uniforms.u_viewportSize[0]=this.frame_texture.width;this.fx_uniforms.u_viewportSize[1]=this.frame_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.frame_texture.width;
this.fx_uniforms.u_iViewportSize[1]=1/this.frame_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=this.brightness;this.fx_uniforms.u_gamma=this.gamma;this.frame_texture.copyTo(this.final_texture,gl.shaders.fxaa_tonemapper,this.fx_uniforms);var m=null;this.postfx_shader_name&&(m=gl.shaders[this.postfx_shader_name])&&m.setUniform("u_size",[this.final_texture.width,this.final_texture.height]);this.final_texture.toViewport(m)};d.prototype.getNodeRenderCalls=function(m,
q,n){var z=null;if(m._mesh)z=m._mesh;else if(m.mesh&&(z=gl.meshes[m.mesh],!z)){this.renderer.autoload_assets&&-1!=m.mesh.indexOf(".")&&this.renderer.loadMesh(m.mesh);return}void 0===n&&(n=65535);m.updateGlobalMatrix(!0);if(z&&!1!==m.flags.visible&&m.layers&n){n=m.skeleton||m.skin||null;!n||n.bones||n.joints||(n=null);n&&n.bones&&!n.bones.length&&(n=null);n&&n.joints&&!n.joints.length&&(n=null);n&&n.joints&&(n._bone_matrices||m.updateSkinningBones(m.parentNode));if(this.test_visibility&&!n){d.temp_bbox||
(d.temp_bbox=BBox.create(),d.aabb_center=BBox.getCenter(d.temp_bbox),d.aabb_halfsize=BBox.getHalfsize(d.temp_bbox));BBox.transformMat4(d.temp_bbox,z.getBoundingBox(),m._global_matrix);if(q.testBox(d.aabb_center,d.aabb_halfsize)==v.CLIP_OUTSIDE)return;m._last_rendered_frame=this.renderer.frame}if(m.primitives&&m.primitives.length)for(q=0;q<m.primitives.length;++q){var h=m.primitives[q];if(h=h.material?v.Materials[h.material]:this.default_material){var c=this.getRenderCallFromPool();c.material=h;c.model=
m._global_matrix;c.mesh=z;c.group_index=q;c.node=m;c._render_priority=h.render_priority||0;c._instancing=null;c.reverse_faces=m.flags.frontFace==GL.CW;c.skin=n;this.render_calls.push(c)}}else m.material&&(h=v.Materials[m.material])&&(c=this.getRenderCallFromPool(),c.material=h,c.model=m._global_matrix,c.mesh=z,c.group_index=-1,c.node=m,c._instancing=null,c.skin=n,c._render_priority=h.render_priority||0,c.reverse_faces=m.flags.frontFace==GL.CW,this.render_calls.push(c))}};d.prototype.groupRenderCallsForInstancing=
function(m){for(var q={},n=0,z=0;z<m.length;++z){var h=m[z];var c=h._instancing||h.skin?n++:h.mesh.name+":"+h.group_index+"/"+h.material.name+(h.reverse_faces?"[R]":"");q[c]?q[c].push(h):q[c]=[h]}m=[];for(z in q)if(n=q[z],0!=n.length)if(1==n.length)h=n[0],this.debug_instancing||m.push(h);else{h=this.getRenderCallFromPool();h.copyFrom(n[0]);h._instancing=Array(n.length);for(c=0;c<n.length;++c)h._instancing[c]=n[c].model;m.push(h)}return m};d.rc_sort_function=function(m,q){return q._render_priority-
m._render_priority};d.prototype.setParallaxReflectionTransform=function(m){this.parallax_reflection_matrix.set(m);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};d.prototype.resetShadersCache=function(){this.compiled_shaders={}};d.prototype.getShader=function(m,q,n){n=n||"";
var z=n+":"+q,h=this.compiled_shaders[z];h||=this.compiled_shaders[z]=new Map;if(z=h.get(m))return z;if(!this.renderer.shader_files)return null;n=this.renderer.shader_files[n||"default.vs"];q=this.renderer.shader_files[q];if(!n||!q)return null;z=null;if(m){z={};for(var c in d.MACROS)m&d.MACROS[c]&&(z[c]="")}z=new GL.Shader(n,q,z);h.set(m,z);return z};d.prototype.renderRenderCall=function(m){var q=m.model;m._instancing&&m._instancing.length&&(q=new Float32Array(m._instancing.flat()));this.renderMeshWithMaterial(q,
m.mesh,m.material,m.index_buffer_name,m.group_index,m.node.extra_uniforms,m.reverse_faces,m.skin)};d.default_backface_color=[.1,.1,.1];d.prototype.renderMeshWithMaterial=function(m,q,n,z,h,c,k,e){var g=this.renderer;if(!n||n.constructor===String)throw"no material in renderMeshWithMaterial";if(!("BLEND"==n.alphaMode&&0>=n.color[3])){var p=this.material_uniforms,w=this.sampler_uniforms,t=m.length/16;p.u_albedo=n.color.subarray(0,3);p.u_emissive.set(n.emissive||v.ZERO);p.u_emissive[3]=n.emissive_clamp_to_edge?
1:0;1!=this.emissive_factor&&vec3.scale(p.u_emissive,p.u_emissive,this.emissive_factor);p.u_backface_color=n.backface_color||d.default_backface_color;var y=0;q.vertexBuffers.coords1&&(y|=d.MACROS.UVS2);q.vertexBuffers.colors&&(y|=d.MACROS.COLOR);e&&(y|=d.MACROS.SKINNING);this.parallax_reflection&&(y|=d.MACROS.PARALLAX_REFLECTION);n.primitive==GL.POINTS&&(y|=d.MACROS.POINTS);1<t&&(y|=d.MACROS.INSTANCING);this.overwrite_shader_name?y=gl.shaders[this.overwrite_shader_name]:this.overwrite_shader_mode?
y=this.getShader(y,this.overwrite_shader_mode):n.shader_name?y=gl.shaders[n.shader_name]:n.overlay?y=this.getShader(y,"overlay.fs"):"pbrMetallicRoughness"==n.model&&this.quality?(p.u_metalness=n.metallicFactor,p.u_roughness=n.roughnessFactor,p.u_metallicRough=!!n.textures.metallicRoughness,y=this.getShader(y,"pbr.fs")):y=this.getShader(y,"nopbr.fs");if(y){p.u_alpha=n.opacity;p.u_alpha_cutoff=0;p.u_normalFactor=null!=n.normalmapFactor?n.normalmapFactor:1;p.u_displacement_factor=null!=n.displacementFactor?
n.displacementFactor:1;n.uv_transform?this.texture_matrix.set(n.uv_transform):mat3.identity(this.texture_matrix);for(var J=2,F=p.u_maps_info,E=0;E<d.maps.length;++E){var H=d.maps[E];F[E]=-1;if(H=n.textures[H]){var L=null;H.constructor===Object?L=H.texture:H.constructor===String&&(L=H,H=null);if(L){var K=d.maps_sampler[E];if(!y||y.samplers[K]){var R=gl.textures[L];R||(g.autoload_assets&&-1!=L.indexOf(".")&&g.loadTexture(L,g.default_texture_settings),R=gl.textures.white);L=16>this.max_textures?J++:
E+2;w[K]=R.bind(L);F[E]=H&&null!=H.uv_channel?Math.clamp(H.uv_channel,0,3):0}}}}k||gl.frontFace(GL.CCW);g.enableItemFlags(n);k&&gl.frontFace(GL.CW);"BLEND"==n.alphaMode?(gl.enable(gl.BLEND),n.additive||"ADD"==n.blendMode?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):"MULTIPLY"==n.blendMode?gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1),p.u_alpha_cutoff=0):"MASK"==n.alphaMode?p.u_alpha_cutoff=n.alphaCutoff:gl.disable(gl.BLEND);if(e){if(e.constructor===
v.Skeleton)this.bones=e.computeFinalBoneMatrices(this.bones,q),y.setUniform("u_bones",this.bones);else if(e._bone_matrices)y.setUniform("u_bones",e._bone_matrices);else return;e.joints&&(e.skip_model=!0)}1==t&&g._uniforms.u_model.set(m);e&&e.skip_model&&mat4.identity(g._uniforms.u_model);y.uniforms(g._uniforms);y.uniforms(this.global_uniforms);y.uniforms(n.uniforms);y.uniforms(p);y.uniforms(w);c&&y.uniforms(c);n.primitive==GL.POINTS&&y.setUniform("u_pointSize",n.point_size||-1);c=null;null!=h&&q.info&&
q.info.groups&&q.info.groups[h]&&(c=q.info.groups[h]);h=this._instancing_uniforms;h.u_model=m;n.flags.preAlpha&&(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),1<t?y.drawInstanced(q,void 0===n.primitive?gl.TRIANGLES:n.primitive,z,h):c?y.drawRange(q,n.primitive,c.start,c.length,z):y.draw(q,n.primitive,z),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL),this.rendered_render_calls++);1<t?c?y.drawInstanced(q,void 0===n.primitive?gl.TRIANGLES:n.primitive,z,h,c.start,c.length):y.drawInstanced(q,void 0===n.primitive?
gl.TRIANGLES:n.primitive,z,h):c?y.drawRange(q,n.primitive,c.start,c.length,z):y.draw(q,n.primitive,z);this.rendered_render_calls++;g.disableItemFlags(n);k&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};d.prototype.renderDeferred=function(m,q,n,z){n=this.prepareBuffers();n.fbo.bind();this.renderToGBuffers(m,q,z);n.fbo.unbind();n.final_fbo.bind();m=this.gatherLightsFromNodes(m,z);this.renderFinalPass(n,m,q);n.final_fbo.unbind();this.applyPostFX(n)};d.prototype.prepareBuffers=function(m){m=
gl.drawingBufferWidth;var q=gl.drawingBufferHeight;if(this._gbuffers&&this._gbuffers.width==m&&this._gbuffers.height==q)return this._gbuffers;this._gbuffers||(this._gbuffers={});var n=this._gbuffers;n.fbo||(n.fbo=new GL.FBO);n.final_fbo||(n.final_fbo=new GL.FBO);var z={format:GL.RGBA,minFilter:gl.NEAREST,magFilter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE},h=new GL.Texture(m,q,z),c=new GL.Texture(m,q,z),k=new GL.Texture(m,q,z);z=new GL.Texture(m,q,z);var e=new GL.Texture(m,q,{format:GL.DEPTH_STENCIL,type:GL.UNSIGNED_INT_24_8_WEBGL}),
g=new GL.Texture(m,q,{format:GL.RGB,type:gl.HIGH_PRECISION_FORMAT,magFilter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE});n.fbo.setTextures([h,c,k,z],e);n.final_fbo.setTextures([g]);n.albedo=h;n.matprop=c;n.emissive=k;n.normal=z;n.width=m;n.height=q;return n};d.prototype.renderToGBuffers=function(m,q,n){m=this.getAllRenderCalls(m,q,n);gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);
gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);this.fillGlobalUniforms(q);for(q=0;q<m.length;++q)if(n=m[q],n.material.overlay&&this.allow_overlay)overlay_rcs.push(n);else{var z=n.model;n._instancing&&n._instancing.length&&(z=GL.linearizeArray(n._instancing,Float32Array));this.renderMeshWithMaterialToGBuffers(z,n.mesh,n.material,n.index_buffer_name,n.group_index,n.node.extra_uniforms,n.reverse_faces,n.skin)}};d.prototype.renderFinalPass=function(m,q,n){m.albedo.toViewport()};d.prototype.applyPostFX=
function(m){gl.disable(GL.DEPTH_TEST);gl.disable(GL.BLEND);var q=m.width,n=m.height;gl.viewport(0,0,.5*q,.5*n);m.albedo.toViewport();gl.viewport(.5*q,0,.5*q,.5*n);m.matprop.toViewport();gl.viewport(0,.5*n,.5*q,.5*n);m.emissive.toViewport();gl.viewport(.5*q,.5*n,.5*q,.5*n);m.normal.toViewport();gl.viewport(0,0,q,n)};d.prototype.gatherLightsFromNodes=function(m,q){};d.prototype.renderMeshWithMaterialToGBuffers=function(m,q,n,z,h,c,k,e){var g=this.renderer;if(!n||n.constructor===String)throw"no material in renderMeshWithMaterial";
if("BLEND"!=n.alphaMode){var p=this.material_uniforms,w=this.sampler_uniforms,t=m.length/16;p.u_albedo=n.color.subarray(0,3);p.u_emissive.set(n.emissive||v.ZERO);p.u_emissive[3]=n.emissive_clamp_to_edge?1:0;1!=this.emissive_factor&&vec3.scale(p.u_emissive,p.u_emissive,this.emissive_factor);p.u_backface_color=n.backface_color||d.default_backface_color;var y=0;q.vertexBuffers.coords1&&(y|=d.MACROS.UVS2);q.vertexBuffers.colors&&(y|=d.MACROS.COLOR);e&&(y|=d.MACROS.SKINNING);n.primitive==GL.POINTS&&(y|=
d.MACROS.POINTS);1<t&&(y|=d.MACROS.INSTANCING);if(y=this.getShader(y,"gbuffer.fs")){p.u_alpha=n.opacity;p.u_alpha_cutoff=0;p.u_normalFactor=null!=n.normalmapFactor?n.normalmapFactor:1;p.u_displacement_factor=null!=n.displacementFactor?n.displacementFactor:1;n.uv_transform?this.texture_matrix.set(n.uv_transform):mat3.identity(this.texture_matrix);for(var J=2,F=p.u_maps_info,E=0;E<d.maps.length;++E){var H=d.maps[E];F[E]=-1;if(H=n.textures[H]){var L=null;H.constructor===Object?L=H.texture:H.constructor===
String&&(L=H,H=null);if(L){var K=d.maps_sampler[E];if(!y||y.samplers[K]){var R=gl.textures[L];R||(g.autoload_assets&&-1!=L.indexOf(".")&&g.loadTexture(L,g.default_texture_settings),R=gl.textures.white);L=16>this.max_textures?J++:E+2;w[K]=R.bind(L);F[E]=H&&null!=H.uv_channel?Math.clamp(H.uv_channel,0,3):0}}}}k||gl.frontFace(GL.CCW);g.enableItemFlags(n);k&&gl.frontFace(GL.CW);"MASK"==n.alphaMode&&(p.u_alpha_cutoff=n.alphaCutoff);if(e){if(e.constructor===v.Skeleton)this.bones=e.computeFinalBoneMatrices(this.bones,
q),y.setUniform("u_bones",this.bones);else if(e._bone_matrices)y.setUniform("u_bones",e._bone_matrices);else return;e.joints&&(e.skip_model=!0)}1==t&&g._uniforms.u_model.set(m);e&&e.skip_model&&mat4.identity(g._uniforms.u_model);y.uniforms(g._uniforms);y.uniforms(this.global_uniforms);y.uniforms(n.uniforms);y.uniforms(p);y.uniforms(w);c&&y.uniforms(c);n.primitive==GL.POINTS&&y.setUniform("u_pointSize",n.point_size||-1);c=null;null!=h&&q.info&&q.info.groups&&q.info.groups[h]&&(c=q.info.groups[h]);
h=this._instancing_uniforms;h.u_model=m;1<t?c?y.drawInstanced(q,void 0===n.primitive?gl.TRIANGLES:n.primitive,z,h,c.start,c.length):y.drawInstanced(q,void 0===n.primitive?gl.TRIANGLES:n.primitive,z,h):c?y.drawRange(q,n.primitive,c.start,c.length,z):y.draw(q,n.primitive,z);this.rendered_render_calls++;g.disableItemFlags(n);k&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};d.prototype.getRenderCallFromPool=function(){if(this.used_render_calls<this.render_calls_pool.length){var m=this.render_calls_pool[this.used_render_calls];
this.used_render_calls++;return m}m=new v.RenderCall;m.id=this.used_render_calls;this.render_calls_pool.push(m);this.used_render_calls++;return m};d.prototype.resetRenderCallsPool=function(){this.used_render_calls=0};d.prototype.renderSkybox=function(m){if((!this.onRenderSkybox||!this.onRenderSkybox(this,m))&&this.environment_texture&&this.render_skybox){var q=gl.meshes.cube,n=gl.shaders[this.overwrite_shader_name||"skybox"];if(n){var z=this.skybox_texture||this.environment_texture;if(z&&z.texture_type===
GL.TEXTURE_CUBE_MAP){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var h=this.renderer._model_matrix;mat4.identity(h);mat4.translate(h,h,m.position);mat4.scale(h,h,[10,10,10]);this.renderer.setModelMatrix(h);n.uniforms(this.renderer._uniforms);n.uniforms({u_color_texture:z.bind(1),u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD,u_camera_position:m.position});n.draw(q,GL.TRIANGLES)}}}};d.prototype.loadEnvironment=function(m,
q,n){var z=this,h=gl.textures[m];h?(n?z.skybox_texture=h:(h.shs&&(z.environment_sh_coeffs=h.shs),z.environment_texture=h),q&&q(h)):HDRE.load(m,function(c){var k=c.toTexture(!0);k&&(gl.textures[m]=k,n?z.skybox_texture=k:(k.shs=c.shs?c.shs:null,z.environment_texture=k,k.shs&&(z.environment_sh_coeffs=k.shs)));q&&q(k)})};d.prototype.captureEnvironment=function(m,q,n){n=n||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(n,n,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,
texture_type:GL.TEXTURE_CUBE_MAP}));var z=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,m,q);this.use_rendertexture=z;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);this.environment_texture||(this.environment_texture=new GL.Texture(n,n,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};
d.prototype.getBRDFIntegratorTexture=function(m){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var q=gl.shaders.brdf_integrator;if(q){var n=gl.textures.brdf_integrator=new GL.Texture(128,128,{type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});if(m)return fetch(m).then(function(h){return h.arrayBuffer()}).then(function(h){n.uploadData(new Float32Array(h),{no_flip:!0})}),n;var z=gl.textures.hammersley_sample_texture;z||=this.createHammersleySampleTexture();n.drawTo(function(h){z&&
z.bind(0);q.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return n}};d.prototype.createHammersleySampleTexture=function(m){m=m||8192;for(var q=3*m,n=new Float32Array(q),z=0;z<q;z+=3){var h=2*Math.radical_inverse(z)*Math.PI;n[z]=Math.cos(h);n[z+1]=Math.sin(h);n[z+2]=0}m=new GL.Texture(m,1,{pixel_data:n,type:GL.FLOAT,format:GL.RGB});return gl.textures.hammersley_sample_texture=m};d.prototype.setClippingPlane=function(m,q){m?this.global_uniforms.u_clipping_plane.set([q[0],
q[1],q[2],vec3.dot(m,q)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};d.prototype.startGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var m=gl.extensions.EXT_disjoint_timer_query;this._waiting_gpu_query||(void 0===this._useQueryTimestamps&&(this._useQueryTimestamps=!1,0<m.getQueryEXT(m.TIMESTAMP_EXT,m.QUERY_COUNTER_BITS_EXT)&&(this._useQueryTimestamps=!0)),gl.getParameter(m.GPU_DISJOINT_EXT),this._useQueryTimestamps?(this._start_gpu_query=m.createQueryEXT(),
this._end_gpu_query=m.createQueryEXT(),m.queryCounterEXT(this._start_gpu_query,m.TIMESTAMP_EXT)):(this._timeElapsed_gpu_query=m.createQueryEXT(),m.beginQueryEXT(m.TIME_ELAPSED_EXT,this._timeElapsed_gpu_query)))}};d.prototype.endGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled&&!this._waiting_gpu_query){var m=gl.extensions.EXT_disjoint_timer_query;this._useQueryTimestamps?m.queryCounterEXT(this._end_gpu_query,m.TIMESTAMP_EXT):m.endQueryEXT(m.TIME_ELAPSED_EXT);
this._waiting_gpu_query=!0}};d.prototype.resolveQueries=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var m=gl.extensions.EXT_disjoint_timer_query,q=this._start_gpu_query,n=this._end_gpu_query,z=this._timeElapsed_gpu_query,h=this._useQueryTimestamps;if(q||n||z){var c=gl.getParameter(m.GPU_DISJOINT_EXT),k;if(!c&&(k=h?m.getQueryObjectEXT(n,m.QUERY_RESULT_AVAILABLE_EXT):m.getQueryObjectEXT(z,m.QUERY_RESULT_AVAILABLE_EXT))){if(h){var e=m.getQueryObjectEXT(q,m.QUERY_RESULT_EXT);
e=m.getQueryObjectEXT(n,m.QUERY_RESULT_EXT)-e}else e=m.getQueryObjectEXT(z,m.QUERY_RESULT_EXT);this.frame_time=1E-6*e}if(k||c)h?(m.deleteQueryEXT(q),m.deleteQueryEXT(n),this._end_gpu_query=this._start_gpu_query=null):(m.deleteQueryEXT(z),this._timeElapsed_gpu_query=null),this._waiting_gpu_query=!1}return this.frame_time}};Math.radical_inverse=function(m){for(var q=0,n=.5;m;n*=.5,m>>=1)m&1&&(q+=n);return q};var u=vec3.create();A.prototype.copyFrom=function(m){this.name=m.name;this.id=m.id;this.mesh=
m.mesh;this.model=m.model;this.index_buffer_name=m.index_buffer_name;this.group_index=m.group_index;this.material=m.material;this.reverse_faces=m.reverse_faces;this.node=m.node;this.skin=m.skin;this._instancing=m._instancing;this._render_priority=m._render_priority};A.prototype.computeRenderPriority=function(m){this.name=this.node.name;var q=this.mesh.getBoundingBox();q&&(q=mat4.multiplyVec3(u,this.model,q),this._render_priority=this.material.render_priority||0,m=vec3.distance(m,q),"BLEND"==this.material.alphaMode?
(this._render_priority+=.001*m,this._render_priority-=100):this._render_priority+=1E3-.001*m)};v.PBRPipeline=d;v.RenderCall=A})(this);
(function(x){function d(){this.area=this.intensity=1;this._color=vec3.fromValues(.9,.9,.9);this._position=vec3.fromValues(10,20,5);this._target=vec3.create();this._vector=vec3.create();this.camera=new RD.Camera;this._castShadows=!1;this.shadowmap={texture:null,resolution:2048,bias:1E-5,uniforms:{u_shadowmap_matrix:this.camera._viewprojection_matrix,u_shadowmap_texture:4,u_shadowbias:1E-5}};this.uniforms={u_light_position:this._position,u_light_color:vec3.create(),u_light_vector:this._vector};this.flags=
{skip_shadows:!1}}Object.defineProperty(d.prototype,"color",{set:function(A){this._color.set(A)},get:function(){return this._color},enumerable:!0});Object.defineProperty(d.prototype,"castShadows",{set:function(A){A?this.enableShadows():this.disableShadows()},get:function(){return this._castShadows},enumerable:!0});d.DEFAULT_SHADOWMAP_RESOLUTION=2048;d.prototype.updateData=function(){vec3.sub(this._vector,this._target,this._position);vec3.normalize(this._vector,this._vector)};d.prototype.setUniforms=
function(A){this.shadowmap.uniforms.u_shadowbias=this.shadowmap.bias;this.uniforms.u_light_color.set(this._color);vec3.scale(this.uniforms.u_light_color,this.uniforms.u_light_color,this.intensity);if(A.constructor===GL.Shader)A.uniforms(this.uniforms),this._castShadows&&(A.uniforms(this.shadowmap.uniforms),this.shadowmap.texture.bind(this.shadowmap.uniforms.u_shadowmap_texture));else{for(var v in this.uniforms)A[v]=this.uniforms[v];if(this._castShadows)for(v in this.shadowmap.uniforms)A[v]=this.shadowmap.uniforms[v]}};
d.prototype.lookAt=function(A,v,u){this._position.set(A);this._target.set(v);this.camera.lookAt(A,v,u);this.updateData()};d.prototype.setView=function(A,v,u){this.area=A;this.camera.orthographic(A,v,u,1);this.updateData()};d.prototype.followCamera=function(A,v){var u=v||5;v=vec3.scaleAndAdd(vec3.create(),A.target,this._vector,-v);this.lookAt(v,A.target,A.up);this.camera.orthographic(u,.01,3*u,1);this.camera.updateMatrices()};d.prototype.enableShadows=function(){this._castShadows=!0;var A=this.shadowmap.resolution||
d.DEFAULT_SHADOWMAP_RESOLUTION;this.shadowmap.texture&&this.shadowmap.texture.width==A||(this.shadowmap.texture=new GL.Texture(A,A,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadowmap.fbo=new GL.FBO(null,this.shadowmap.texture))};d.prototype.disableShadows=function(){this._castShadows=!1;this.shadowmap.texture=null;this.shadowmap.fbo=null};d.prototype.generateShadowmap=function(A,v,u){if(this.castShadows){if(!this.shadowmap.fbo)throw"no shadowmap fbo";this.camera.view_texel_grid=
[this.shadowmap.resolution,this.shadowmap.resolution];A.generating_shadowmap=!0;this.shadowmap.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);A.shader_overwrite="flat";if(v.constructor===Array)for(var m=0;m<v.length;++m)A.render(v[m],this.camera,null,u||255);else A.render(v,this.camera,null,u||255);A.shader_overwrite=null;this.shadowmap.fbo.unbind();A.generating_shadowmap=!1;this.shadowmap.texture.bind(4);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR)}};d.shadow_shader_function="uniform mat4 u_shadowmap_matrix;\n\tuniform sampler2D u_shadowmap_texture;\n\t\n\tfloat testShadowmap( vec3 pos )\n\t{\n\t\tconst float bias = 0.004;\n\t\tvec4 proj = u_shadowmap_matrix * vec4(pos, 1.0);\n\t\tvec2 sample = (proj.xy / proj.w) * vec2(0.5) + vec2(0.5);\n\t\tif(sample.x >= 0.0 && sample.x <= 1.0 && sample.y >= 0.0 && sample.y <= 1.0 )\n\t\t{\n\t\t\tfloat depth = texture2D( u_shadowmap_texture, sample ).x;\n\t\t\tif( depth > 0.0 && depth < 1.0 && depth <= ( ((proj.z-bias) / proj.w) * 0.5 + 0.5) )\n\t\t\t\treturn 0.0;\n\t\t}\n\t\treturn 1.0;\n\t}";
RD.Light=d})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(x){function d(){this.name="";this.tracks=[];this.duration=10}function A(){this.enabled=!0;this.target_property=this.target_node="";this.type=z.SCALAR;this.data=[];this.packed_data=!1;this._target=null}function v(c,k,e){return c*(1-e)+k*e}function u(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function m(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function q(){this.skeleton=
new u;this.duration=0;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this._loading=!1;this.bones_map=new Uint8Array(q.MAX_BONES);this.keyframes=null}function n(c,k,e){for(var g="",p=0;p<e;++p){var w=c.getUint8(k+p);if(!w)break;g+=String.fromCharCode(w)}return g}var z=x.RD=x.RD||{};z.Animations={};d.prototype.addTrack=function(c,k){if(k)for(k=0;k<this.tracks.length;++k)if(this.tracks[k].target_node==c.target_node){this.tracks.splice(k+1,0,c);return}this.tracks.push(c)};d.prototype.applyAnimation=
function(c,k,e){for(var g=0;g<this.tracks.length;++g){var p=this.tracks[g];!1!==p.enabled&&p.applyTrack(c,k,e)}};d.prototype.toJSON=function(){for(var c={name:this.name,duration:this.duration,tracks:[]},k=0;k<this.tracks.length;++k)c.tracks.push(this.tracks[k].toJSON());return c};d.prototype.fromJSON=function(c){this.name=c.name;this.duration=c.duration;for(var k=this.tracks.length=0;k<c.tracks.length;++k){var e=new z.Animation.Track;e.fromJSON(c.tracks[k]);this.tracks.push(e)}return c};d.prototype.findNearestLeft=
function(c){for(var k=0,e=0;e<this.tracks.length;++e){var g=this.tracks[e],p=g.findTimeIndex(c);-1!=p&&(g=g.data[p],g>k&&(k=g))}return k};d.prototype.findNearestRight=function(c){for(var k=this.duration,e=0;e<this.tracks.length;++e){var g=this.tracks[e],p=g.findTimeIndex(c);-1!=p&&(g=g.data[p+1],null!=g&&g<k&&(k=g))}return k};z.Animation=d;d.Track=A;Object.defineProperty(A.prototype,"value_size",{set:function(c){throw"cannot be set, use type instead";},get:function(){return z.TYPES_SIZE[this.type]}});
A.prototype.addKeyframe=function(c,k,e){1<this.value_size&&(k=new Float32Array(k));for(var g=0;g<this.data.length;++g)if(!(this.data[g][0]<c))return this.data[g][0]!=c||e?this.data.splice(g,0,[c,k]):this.data[g][1]=k,g;this.data.push([c,k]);return this.data.length-1};A.prototype.getKeyframe=function(c){if(0>c||c>=this.data.length)return console.warn("keyframe index out of bounds"),null;var k=z.TYPES_SIZE[this.type];return this.packed_data?(c*=1+k,c>this.data.length-k?null:[this.data[c],this.data.subarray(c+
1,c+k+1)]):this.data[c]};A.prototype.findTimeIndex=function(c){var k=this.data;if(!k||0==k.length)return-1;var e=z.TYPES_SIZE[this.type];if(this.packed_data){e+=1;var g=k.length/e,p=0,w=0,t=g;if(0==g)return-1;if(1==g)return 0;if(k[(t-1)*e]<c)return t-1;for(;t>=p;){w=.5*(t+p)|0;g=k[w*e];if(g==c)break;if(p==t-1)return p;g<c?p=w:t=w}return w}g=k.length;w=p=0;t=g;if(0==g)return-1;if(1==g)return 0;if(k[t-1][0]<c)return t-1;for(;t>=p;){w=.5*(t+p)|0;g=k[w][0];if(g==c)break;if(p==t-1)return p;g<c?p=w:t=w}return w};
A.prototype.getSample=function(c,k,e){if(this.data&&0!==this.data.length)return this.packed_data?this.getSamplePacked(c,k,e):this.getSampleUnpacked(c,k,e)};A.prototype.getSampleUnpacked=function(c,k,e){c=Math.clamp(c,0,this.data[this.data.length-1][0]);var g=this.findTimeIndex(c);-1===g&&(g=0);var p=g,w=g+1,t=this.data;var y=z.TYPES_SIZE[this.type];if(!k||0==y||1==t.length||w==t.length||0==p&&this.data[0][0]>c)return this.data[g][1];p=t[p];w=t[w];c=(w[0]-c)/(w[0]-p[0]);1<y&&(e=e||this._result,e&&
e.length==y||(e=this._result=new Float32Array(y)));if(k===z.LINEAR)return 1==y?p[1]*c+w[1]*(1-c):z.interpolateLinear(p[1],w[1],c,e,this.type,y,this);if(k===z.CUBIC){k=0<g?t[g-1]:p;g=g<t.length-2?t[g+2]:w;if(1===y)return z.EvaluateHermiteSpline(p[1],w[1],k[1],g[1],1-c);e=z.EvaluateHermiteSplineVector(p[1],w[1],k[1],g[1],1-c,e);this.type==z.QUAT?(quat.slerp(e,w[1],p[1],c),quat.normalize(e,e)):this.type==z.TRANS10&&(y=e.subarray(3,7),p=p[1].subarray(3,7),w=w[1].subarray(3,7),quat.slerp(y,w,p,c),quat.normalize(y,
y));return e}return null};A.prototype.getSamplePacked=function(c,k,e){if(!this.data.length)return null;var g=z.TYPES_SIZE[this.type];c=Math.clamp(c,0,this.data[this.data.length-g-1]);var p=this.findTimeIndex(c);-1==p&&(p=0);var w=g+1,t=p,y=p+1,J=this.data,F=J.length/w;if(!k||1==F||y==F||0==t&&this.data[0]>c)return this.getKeyframe(p)[1];1<g&&(e=e||this._result,e&&e.length==g||(e=this._result=new Float32Array(g)));var E=J.subarray(t*w,(t+1)*w);t=J.subarray(y*w,(y+1)*w);c=(t[0]-c)/(t[0]-E[0]);if(k===
z.LINEAR){if(1==g)return E[1]*c+t[1]*(1-c);w=E.subarray(1,g+1);t=t.subarray(1,g+1);return z.interpolateLinear(w,t,c,e,this.type,g,this)}if(k===z.CUBIC){if(0===g)return E[1];k=0<p?J.subarray((p-1)*w,p*w):E;y=y<F-1?J.subarray((y+1)*w,(y+2)*w):t;if(1===g)return z.EvaluateHermiteSpline(E[1],t[1],k[1],y[1],1-c);g=E.subarray(1,w);t=t.subarray(1,w);e=z.EvaluateHermiteSplineVector(g,t,k.subarray(1,w),y.subarray(1,w),1-c,e);this.type==z.QUAT?(quat.slerp(e,t,g,c),quat.normalize(e,e)):this.type==z.TRANS10&&
(w=e.subarray(3,7),g=g.subarray(3,7),t=t.subarray(3,7),quat.slerp(w,t,g,c),quat.normalize(w,w));return e}return null};A.prototype.applyTrack=function(c,k,e){if(c){k=this.getSample(k,e);if(c.constructor===z.SceneNode){if(c=c.name==this.target_node?c:c.findNodeByName(this.target_node))this._node=c,c[this.target_property]=k}else c.constructor===z.Skeleton&&(c=c.getBone(this.target_node))&&this.type==z.MAT4&&(this._bone=c,c.model.set(k));return k}};A.prototype.toJSON=function(){return{enabled:this.enabled,
target_node:this.target_node,target_property:this.target_property,type:this.type,data:this.data.constructor==Array?this.data.concat():typedArrayToArray(this.data),packed_data:this.packed_data}};A.prototype.fromJSON=function(c){this.enabled=c.enabled;this.target_node=c.target_node;this.target_property=c.target_property;if(c.property){var k=c.property.indexOf("/");this.target_node=c.property.substr(0,k);this.target_property=c.property.substr(k+1)}null!=c.type&&(this.type=c.type.constructor===String?
z.TYPES[c.type.toUpperCase()]||0:c.type);c.packed_data||c.data.constructor===Float32Array?(this.packed_data=!0,this.data=new Float32Array(c.data)):(this.packed_data=!1,this.data=c.data.concat())};z.interpolateLinear=function(c,k,e,g,p,w,t){if(1==w)return c*e+k*(1-e);g=g||t._result;g&&g.length==w||(g=t._result=new Float32Array(w));switch(p){case z.QUAT:quat.slerp(g,k,c,e);quat.normalize(g,g);break;case z.TRANS10:for(p=0;3>p;p++)g[p]=c[p]*e+k[p]*(1-e);for(p=7;10>p;p++)g[p]=c[p]*e+k[p]*(1-e);c=c.subarray(3,
7);k=k.subarray(3,7);w=g.subarray(3,7);quat.slerp(w,k,c,e);quat.normalize(w,w);break;default:for(p=0;p<w;p++)g[p]=c[p]*e+k[p]*(1-e)}return g};z.EvaluateHermiteSpline=function(c,k,e,g,p){var w=p*p,t=w*p;return(2*t-3*w+1)*c+(-2*t+3*w)*k+(t-2*w+p)*(k-e)+(t-w)*(g-c)};z.EvaluateHermiteSplineVector=function(c,k,e,g,p,w){w=w||new Float32Array(w.length);var t=p*p,y=t*p,J=2*y-3*t+1,F=-2*y+3*t;p=y-2*t+p;t=y-t;y=0;for(var E=w.length;y<E;++y)w[y]=J*c[y]+F*k[y]+p*(k[y]-e[y])+t*(g[y]-c[y]);return w};Math.lerp||
(Math.lerp=v);z.Skeleton=u;u.Bone=m;m.prototype.toJSON=function(){return{name:this.name,model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};m.prototype.fromJSON=function(c){this.name=c.name;this.model.set(c.model);this.parent=c.parent;this.layer=c.layer;this.num_children=0;this.index=null!=c.index?c.index:-1;c.children&&(this.children.set(c.children),this.num_children=c.children.constructor===
Array?c.children.length:c.num_children)};u.prototype.applyTransformToBones=function(c,k){(c=this.getBone(c))&&mat4.multiply(c.model,c.model,k)};u.prototype.getBone=function(c){return this.bones[this.bones_by_name.get(c)]};u.identity=mat4.create();u.prototype.getBoneMatrix=function(c,k,e){var g=-1;c.constructor===String?g=this.bones_by_name.get(c):c.constructor===Number&&(g=c);if(void 0===g)return u.identity;if(!k)return this.bones[g].model;c=this.global_bone_matrices[g];if(!e)return c;e=this.bones[g];
c.set(e.model);for(e=this.bones[e.parent];e;)c=mat4.mul(c,e.model,c),e=this.bones[e.parent];return c};u.prototype.updateBoneGlobalMatrix=function(c){var k=this.bones[c];if(k)for(c=this.global_bone_matrices[c],c.set(k.model),k=this.bones[k.parent];k;)c=mat4.mul(c,k.model,c),k=this.bones[k.parent]};u.prototype.updateChildBonesGlobalMatrices=function(c){if(c=c.constructor==u.Bone?c:this.getBone(c)){var k=this.global_bone_matrices[c.index];mat4.mul(k,this.global_bone_matrices[c.parent],k);for(c=0;c<this.num_children;++c)this.updateChildBonesGlobalMatrices(this.children[c])}};
u.prototype.importSkeleton=function(c,k){function e(w){var t=new m;t.name=w.name||w.id;w.model?t.model.set(w.model):w.transform&&w.getLocalMatrix&&t.model.set(w.getLocalMatrix());t.index=p.length;p.push(t);g.bones_by_name.set(t.name,t.index);g.global_bone_matrices.push(mat4.create());if(w.children&&w.children.length){t.num_children=w.children.length;for(var y=0;y<w.children.length;++y){var J=e(w.children[y]);t.children[y]=J.index;J.parent=t.index}}return t}var g=this;p?this.bones.length=0:this.bones=
[];var p=this.bones;e(c);k&&mat4.mul(p[0].model,k,p[0].model);this.updateGlobalMatrices()};u.temp_mat4=mat4.create();u.temp_mat43=u.temp_mat4.subarray(0,12);u.prototype.computeFinalBoneMatrices=function(c,k,e){if(!this.bones.length||!k||!k.bones)return c||[];this.updateGlobalMatrices();var g=e?12*k.bones.length:16*k.bones.length;c&&c.length==g||(c=new Float32Array(g));if(e){var p=u.temp_mat43;for(e=0;e<k.bones.length;++e)g=k.bones[e],mat4.multiply(temp_mat4,this.getBoneMatrix(g[0],!0),g[1]),k.bind_matrix&&
mat4.multiply(temp_mat4,temp_mat4,k.bind_matrix),mat4.transpose(temp_mat4,temp_mat4),c.set(p,12*e)}else for(e=0;e<k.bones.length;++e)g=k.bones[e],p=c.subarray(16*e,16*e+16),mat4.multiply(p,this.getBoneMatrix(g[0],!0),g[1]),k.bind_matrix&&mat4.multiply(p,p,k.bind_matrix);return c};u.prototype.computeFinalBoneMatricesAsArray=function(c,k,e){if(!this.bones.length||!k||!k.bones)return c||[];this.updateGlobalMatrices();c=c||[];c.length=k.bones.length;for(var g=0;g<k.bones.length;++g){var p=k.bones[g];
c[g]||(c[g]=mat4.create());var w=c[g];mat4.multiply(w,this.getBoneMatrix(p[0],!0),p[1]);k.bind_matrix&&mat4.multiply(w,w,k.bind_matrix);e&&mat4.multiply(w,e,w)}return c};u.prototype.updateGlobalMatrices=function(){var c=this.bones;if(c.length){var k=this.bones.length;this.global_bone_matrices[0].set(c[0].model);for(var e=1;e<k;++e){var g=c[e];mat4.multiply(this.global_bone_matrices[e],this.global_bone_matrices[g.parent],g.model)}}};u.prototype.assignLayer=function(c,k){};u.temp_vec3=vec3.create();
u.temp_vec4=vec4.create();u.temp_mat4=mat4.create();u.prototype.applyTracksAnimation=function(c,k){for(var e=u.temp_vec3,g=u.temp_vec4,p=u.temp_mat4,w=0;w<c.tracks.length;++w){var t=c.tracks[w],y=this.bones_by_name.get(t.target_node);null!=y&&(y=this.bones[y],"model"==t.target_property||"matrix"==t.target_property?t.getSample(k,z.LINEAR,y.model):"position"==t.target_property?(t.getSample(k,z.LINEAR,e),mat4.setTranslation(y.model,e)):"rotation"==t.target_property?(t.getSample(k,z.LINEAR,g),mat4.fromQuat(p,
g),mat4.getTranslation(e,y.model),mat4.setTranslation(p,e),y.model.set(p)):"scaling"==t.target_property&&(t.getSample(k,z.LINEAR,e),mat4.scale(y.model,y.model,e)))}};u.prototype.getVertices=function(c,k){if(!this.bones.length)return null;k||this.updateGlobalMatrices();k=6*(this.bones.length-1);this._vertices&&this._vertices.length==k||(this._vertices=new Float32Array(k));k=this._vertices;for(var e=0,g=1;g<this.bones.length;++g){var p=this.global_bone_matrices[this.bones[g].parent],w=this.global_bone_matrices[g],
t=k.subarray(e,e+3),y=k.subarray(e+3,e+6);mat4.getTranslation(t,w);mat4.getTranslation(y,p);c&&(vec3.transformMat4(t,t,c),vec3.transformMat4(y,y,c));e+=6}return k};u.prototype.resizeBones=function(c){if(this.bones.length!=c)if(this.bones.length>c)this.bones.length=c,this.global_bone_matrices.length=c;else{var k=this.bones.length;for(this.bones.length=c;k<c;++k)this.bones[k]=new m,this.global_bone_matrices[k]=mat4.create()}};u.prototype.copyFrom=function(c){this.resizeBones(c.bones.length);for(var k=
0;k<c.bones.length;++k)this.bones[k].copyFrom(c.bones[k]),this.global_bone_matrices[k].set(c.global_bone_matrices[k]);this.bones_by_name=new Map(c.bones_by_name)};u.prototype.toJSON=function(){for(var c={bones:[],bone_names:{}},k=0;k<this.bones.length;++k)c.bones.push(this.bones[k].toJSON());return c};u.prototype.fromJSON=function(c){this.resizeBones(c.bones.length);c.bones_by_name?this.bones_by_name=new Map(c.bones_by_name):this.bones_by_name.clear();for(var k=0;k<c.bones.length;++k){var e=this.bones[k];
e.copyFrom(c.bones[k]);e.index=k;c.global_bone_matrices?this.global_bone_matrices[k].set(c.global_bone_matrices[k]):this.bones_by_name.set(this.bones[k].name,k)}};var h=vec3.create();u.blend=function(c,k,e,g,p,w){if(c.bones.length!=k.bones.length)console.error("skeleton must contain the same number of bones");else{e=Math.clamp(e,0,1);if(255==p){if(0==e){if(g==c)return;g.copyFrom(c);return}if(1==e){g.copyFrom(k);return}}if(g!=c){g.resizeBones(c.bones.length);for(p=0;p<g.bones.length;++p){var t=g.bones[p];
t||=g.bones[p]=new u.Bone;t.copyFrom(c.bones[p])}g.bones_by_name=new Map(c.bones_by_name)}for(p=0;p<g.bones.length;++p){var y=g.bones[p],J=c.bones[p],F=k.bones[p];for(t=0;16>t;++t)y.model[t]=Math.lerp(J.model[t],F.model[t],e);if(!w)for(y=y.model,t=0;3>t;++t)h[0]=y[0+t],h[1]=y[4+t],h[2]=y[8+t],vec3.normalize(h,h),y[0+t]=h[0],y[4+t]=h[1],y[8+t]=h[2]}}};u.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
u.vertex_shader_code=`
	precision highp float;
	attribute vec3 a_vertex;
	attribute vec3 a_normal;
	attribute vec2 a_coord;
	
	varying vec3 v_wPosition;
	varying vec3 v_wNormal;
	varying vec2 v_coord;
	
	uniform mat4 u_viewprojection;
	uniform mat4 u_model;
	uniform mat4 u_normal_matrix;
	
	${u.shader_code} //
	
	void main() {
		v_wPosition = a_vertex;
		v_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;
		v_coord = a_coord;
		
		computeSkinning( v_wPosition, v_wNormal);
		
		v_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;
		
		gl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );
	}
`;q.MAX_BONES=64;q.VERSION=4;z.SkeletalAnimation=q;q.prototype.load=function(c,k){var e=this,g=-1!=c.toLowerCase().indexOf(".abin");this._loading=!0;return HttpRequest(c,null,function(p){e._loading=!1;p.constructor===String?e.fromData(p):e.fromBinary(p);k&&k(e)},null,{binary:g})};q.prototype.assignTime=function(c,k,e,g){if(this.duration&&this.samples_per_second){k||void 0===k?(c%=this.duration,0>c&&(c=this.duration+c)):c=Math.clamp(c,0,this.duration-1/this.samples_per_second);void 0===e&&(e=!0);c*=
this.samples_per_second;g=Math.floor(c);var p=(g+1)%this.num_keyframes;g%=this.num_keyframes;c-=Math.floor(c);var w=this.num_animated_bones;k=16*w;g*=k;p*=k;var t=this.skeleton,y=this.keyframes,J=this.bones_map;w=Math.min(w,J.length);for(var F=0;F<w;++F){var E=t.bones[J[F]];if(!E)throw"bone not found in skeleton";k=16*F;if(e)for(var H=0;16>H;++H)E.model[H]=v(y[g+k+H],y[p+k+H],c);else E.model.set(y.subarray(g+k,g+k+16))}}};q.prototype.resize=function(c,k){this.num_keyframes=Math.floor(c);this.num_animated_bones=
k;this.keyframes=new Float32Array(c*k*16)};q.prototype.assignPoseToKeyframe=function(c,k){if(k>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";k=k*this.num_animated_bones*16;for(var e=0;e<this.num_animated_bones;++e){var g=c.bones[this.bones_map[e]];null!=g&&this.keyframes.set(g.model,k+16*e)}};q.prototype.fromData=function(c){var k=c.split("\n"),e=k[0].split(",");this.duration=Number(e[0]);this.samples_per_second=Number(e[1]);this.num_keyframes=
Number(e[2]);this._datasize=c.length;this.skeleton.resizeBones(Number(e[3]));c=0;for(e=1;e<k.length;++e){var g=k[e],p=g[0];g=g.substr(1).split(",");if("B"==p){var w=Number(g[0]),t=this.skeleton.bones[w];if(!t)throw"bone not found in skeleton";t.name=g[1];t.parent=Number(g[2]);for(p=0;16>p;++p)t.model[p]=Number(g[3+p]);-1!=t.parent&&(g=this.skeleton.bones[t.parent],16<=g.num_children?console.warn("too many child bones, max is 16"):g.children[g.num_children++]=w);this.skeleton.bones_by_name.set(t.name,
w)}else if("@"==p){this.num_animated_bones=Number(g[0]);for(p=0;p<this.num_animated_bones;++p)this.bones_map[p]=Number(g[p+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==p){w=c*this.num_animated_bones*16;p=0;for(t=16*this.num_animated_bones;p<t;++p)this.keyframes[w+p]=Number(g[p+1]);c++}else break}this.assignTime(0,!1,!1)};q.prototype.toData=function(){var c=[];c.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());
for(var k=this.skeleton.bones,e=0;e<k.length;++e){var g=k[e];c.push("B"+e+","+g.name+","+g.parent+","+typedArrayToArray(g.model))}k=[];for(e=0;e<this.num_animated_bones;++e)k.push(this.bones_map[e]);c.push("@"+k.length+","+k.join(","));k=1/this.samples_per_second;for(e=0;e<this.num_keyframes;++e){g=16*e*this.num_animated_bones;g=this.keyframes.subarray(g,g+16*this.num_animated_bones);for(var p=0;p<g.length;++p)1E-6>Math.abs(g[p])&&(g[p]=0);c.push("K"+(e*k).toFixed(3)+","+g.join(","))}return c.join("\n")};
q.prototype.fromPose=function(c){this.samples_per_second=15;this.duration=1/this.samples_per_second;this.skeleton.copyFrom(c);for(var k=c.bones.length,e=0;e<c.bones.length;++e)this.bones_map[e]=e;this.resize(1,k);this.assignPoseToKeyframe(this.skeleton,0)};q.prototype.fromTracksAnimation=function(c,k,e,g){this.duration=k.duration;this.samples_per_second=e;this.skeleton.copyFrom(c);for(var p=0,w={},t=0;t<k.tracks.length;++t){var y=k.tracks[t],J=c.bones_by_name.get(y.target_node);null!=J&&(this.bones_map[p]=
J,null==w[y.target_node]&&(w[y.target_node]=y.target_node,p++))}p>c.bones.length&&console.warn("more animated bones than bones?");this.resize(Math.floor(k.duration*e),p);for(t=0;t<this.num_keyframes;++t)this.skeleton.applyTracksAnimation(k,1/e*t),g&&mat4.mul(this.skeleton.bones[0].model,g,this.skeleton.bones[0].model),this.assignPoseToKeyframe(this.skeleton,t)};q.prototype.toBinary=function(){for(var c=this.skeleton.bones.length,k=new Uint8Array(176+115*c+this.num_keyframes*this.num_animated_bones*
64),e=new DataView(k.buffer),g=0;4>g;++g)e.setUint8(g,"ABIN".charCodeAt(g));e.setInt32(4,q.VERSION,!0);e.setInt32(8,172,!0);e.setFloat32(12,this.duration,!0);e.setFloat32(16,this.samples_per_second,!0);e.setUint32(20,this.num_animated_bones,!0);e.setUint32(24,this.num_keyframes,!0);e.setUint32(28,c,!0);for(g=0;g<this.bones_map.length;++g)e.setUint8(32+g,this.bones_map[g]);var p=176;for(g=0;g<this.skeleton.bones.length;++g){var w=this.skeleton.bones[g];e.setInt8(p,w.parent);for(var t=0;32>t;++t)e.setInt8(p+
t+1,w.name.charCodeAt(t)||0);for(t=0;16>t;++t)e.setFloat32(p+32+1+4*t,w.model[t],!0);e.setUint8(p+32+1+64,w.layer);e.setUint8(p+32+2+64,w.num_children);for(t=0;16>t;++t)e.setInt8(p+32+3+64+t,w.children[t]);p+=115}p=176+115*c;c=new Uint8Array(this.keyframes.buffer);k.set(c,p);return k};q.prototype.fromBinary=function(c){c.constructor===ArrayBuffer&&(c=new Uint8Array(c));var k=new DataView(c.buffer);if("ABIN"!=n(k,0,4))return console.error("not an animation file"),!1;var e=k.getInt32(4,!0);k.getInt32(8,
!0);this.duration=k.getFloat32(12,!0);this.samples_per_second=3==e?k.getInt32(16,!0):k.getFloat32(16,!0);this.num_animated_bones=k.getUint32(20,!0);this.num_keyframes=k.getUint32(24,!0);e=k.getUint32(28,!0);for(var g=0;g<this.bones_map.length;++g)this.bones_map[g]=k.getUint8(32+g);var p=176;this.skeleton.resizeBones(e);this.skeleton.bones_by_name.clear();for(g=0;g<e;++g){var w=this.skeleton.bones[g];w.parent=k.getInt8(p);w.name=n(k,p+1,32);for(var t=0;16>t;++t)w.model[t]=k.getFloat32(p+32+1+4*t,!0);
w.layer=k.getUint8(p+32+1+64);w.num_children=k.getUint8(p+32+2+64);for(t=0;16>t;++t)w.children[t]=k.getInt8(p+32+3+64+t);p+=115;this.skeleton.bones_by_name.set(w.name,g)}p=176+115*e;k=new Uint8Array(c.subarray(p,p+this.num_keyframes*this.num_animated_bones*64));this.keyframes=new Float32Array(k.buffer);this._datasize=c.length};z.SceneNode&&(z.SceneNode.prototype.assignSkeleton=function(c){var k=gl.meshes[this.mesh];k&&(this.bones=c.computeFinalBoneMatrices(this.bones,k),this.uniforms.u_bones=this.bones)},
z.SceneNode.prototype.assignAnimation=function(c){this.assignSkeleton(c.skeleton)},z.SceneNode.prototype.updateSkinningBones=function(c){c=c||this;this.skin&&this.mesh&&z.collectBones(c,this.skin,gl.meshes[this.mesh]);if(this.children&&this.children.length)for(var k=0;k<this.children.length;++k)this.children[k].updateSkinningBones(c)});z.collectBones=function(c,k,e){function g(E,H,L){if(!H||!E)return L;if(E==H)return mat4.mul(L,E.getGlobalMatrix(),L),L;mat4.mul(L,E.matrix,L);return g(E._parent,H,
L)}if(e&&e.bones){var p=e.bones.length;k._bone_matrices||(k._bone_matrices=new Float32Array(16*p));p=k._bone_matrices;mat4.create();(k=c.findNodeByName(k.skeleton_root))||k==c;for(var w=mat4.create(),t=0;t<e.bones.length;++t){var y=e.bones[t],J=p.subarray(16*t,16*t+16),F=c.findNodeByName(y[0]);F&&(mat4.identity(w),g(F,k,w),mat4.multiply(J,w,y[1]),e.bind_matrix&&mat4.multiply(J,J,e.bind_matrix))}return p}};z.AnimatedCharacterFromScene=function(c,k,e){var g=[],p=[],w=e=null;w=c.constructor===z.SceneNode?
c:c.root;for(var t=0;t<w.children.length;++t){var y=w.children[t];if(y.name&&("Armature"==y.name||-1!=y.name.indexOf("_Hips"))||"JOINT"==y.type||y.is_joint)e=y;else if(y.mesh){g.push(y);var J=null;gl.meshes[y.mesh]?J=gl.meshes[y.mesh]:c.meshes&&c.meshes[y.mesh]&&(J=GL.Mesh.load(c.meshes[y.mesh]));J&&p.push({mesh:J})}}!e&&w.findNodesByFilter&&(t=w.findNodesByFilter(function(F){return F.skin}))&&t.length&&(e=t[0]);!g.length&&w.findNodesByFilter&&(g=w.findNodesByFilter(function(F){return F.mesh}));g.length&&
g[0].skin&&g[0].skin.skeleton_root&&(e=w.findNodeByName(g[0].skin.skeleton_root));if(!e)throw"this scene doesnt contain an animated character";t=w=null;g.length&&(y=null,1<g.length?(t=GL.Mesh.mergeMeshes(p),y=g[0].mesh,t.filename=y):(y=g[0].mesh,gl.meshes[y]?(t=gl.meshes[y],t.filename=y):c.meshes&&(t=GL.Mesh.fromBinary(c.meshes[y]),t.filename=y)),gl.meshes[y]=t,p=null,g[0].material?p=g[0].material:g[0].primitives&&g[0].primitives.length&&(p=g[0].primitives[0].material),z.Materials[p]?w=z.Materials[p]:
c.materials&&(w=c.materials[p]));g=new z.Skeleton;g.importSkeleton(e,null);p=null;c.root&&c.root.animation?p=c.root.animation:c.animations&&(p=c.animations[0].id);e=null;null!=p&&(z.Animations[p]?e=z.Animations[p]:c.resources&&(c=c.resources[p],e=new z.Animation,e.fromJSON(c.takes["default"])));e?(c=new z.SkeletalAnimation,c.fromTracksAnimation(g,e,30,null)):(console.warn("no animation in scene, creating pose one"),c=new z.SkeletalAnimation,c.fromPose(g));c.filename=k;return{mesh:t?t.filename:null,
material:w,skeleton:g,skeletal_anim:c,tracks_anim:e}};d.prototype.serialize=d.prototype.toJSON;d.prototype.configure=d.prototype.fromJSON;A.prototype.serialize=A.prototype.toJSON;A.prototype.configure=A.prototype.fromJSON;u.prototype.serialize=u.prototype.toJSON;u.prototype.configure=u.prototype.fromJSON;m.prototype.serialize=m.prototype.toJSON;m.prototype.configure=m.prototype.fromJSON;m.prototype.copyFrom=m.prototype.configure})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
