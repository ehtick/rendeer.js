'use strict';(function(p){function a(d){if(this.constructor!==b.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();d&&this.configure(d)}function k(d){this.type=b.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=0.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=
mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();this.uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection_matrix:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position,u_camera_planes:vec2.fromValues(0.1,1E3)};d&&this.configure(d);this.updateMatrices()}function m(){this._root=new b.SceneNode;
this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}function g(d){this._color=vec4.fromValues(1,1,1,1);this.shader_name=null;this.uniforms={u_color:this._color};this.textures={};this.primitive=GL.TRIANGLES;this.blend_mode=b.BLEND_NONE;this.flags={two_sided:!1,depth_test:!0,depth_write:!0};d&&this.configure(d)}function e(d,b){b=b||{};var a=this.gl=this.context=d;if(!a||!a.enable)throw"litegl GL context not found.";d!=
p.gl&&a.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this.layers_affect_children=this.disable_cull_face=this.reverse_normals=this.sort_by_distance=!1;this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._texture_matrix=mat3.create();this._color=vec4.fromValues(1,1,1,1);this._viewprojection2D_matrix=mat4.create();this._nodes=[];this._uniforms=
{u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_color:this._color,u_texture_matrix:this._texture_matrix};this.global_uniforms_containers=[this._uniforms];p.gl=this.gl;this.canvas=a.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:a.REPEAT,minFilter:a.LINEAR_MIPMAP_LINEAR,magFilter:a.LINEAR};this.default_cubemap_settings=
{minFilter:a.LINEAR_MIPMAP_LINEAR,magFilter:a.LINEAR,is_cross:1};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:a.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,
1,{filter:a.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.createShaders();b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}function l(d,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();d&&this.origin.set(d);b&&this.direction.set(b)}function f(d){this._ctor();d&&this.configure(d)}function t(d){this._ctor();d&&this.configure(d)}
function h(d){a.prototype._ctor.call(this,d);this._ctor();d&&this.configure(d)}function c(d,b){return vec3.dot(d,b)+d[3]}function n(d,b,a){var h=d[3],c=Math.abs(a[0]*d[0]),e=Math.abs(a[1]*d[1]);a=Math.abs(a[2]*d[2]);c=c+e+a;d=vec3.dot(d,b)+h;return d<=-c?w:d<=c?D:B}var b=p.RD={version:0.5};b.ZERO=vec3.fromValues(0,0,0);b.ONE=vec3.fromValues(1,1,1);b.RIGHT=vec3.fromValues(1,0,0);b.LEFT=vec3.fromValues(-1,0,0);b.UP=vec3.fromValues(0,1,0);b.DOWN=vec3.fromValues(0,-1,0);b.FRONT=vec3.fromValues(0,0,-1);
b.BACK=vec3.fromValues(0,0,1);b.FRONT2D=vec2.fromValues(0,1);b.WHITE=vec3.fromValues(1,1,1);b.BLACK=vec3.fromValues(0,0,0);b.IDENTITY=mat4.create();b.ONES4=vec4.fromValues(1,1,1,1);b.TRANS10_IDENTITY=new Float32Array([0,0,0,0,0,0,1,1,1,1]);b.CENTER=0;b.TOP_LEFT=1;b.TOP_RIGHT=2;b.BOTTOM_LEFT=3;b.BOTTOM_RIGHT=4;b.TOP_CENTER=5;b.BOTTOM_CENTER=6;b.PRIORITY_BACKGROUND=30;b.PRIORITY_OPAQUE=20;b.PRIORITY_ALPHA=10;b.PRIORITY_HUD=0;b.BLEND_NONE=0;b.BLEND_ALPHA=1;b.BLEND_ADD=2;b.BLEND_MULTIPLY=3;b.NO_BILLBOARD=
0;b.BILLBOARD_SPHERIC=1;b.BILLBOARD_PARALLEL_SPHERIC=2;b.BILLBOARD_CYLINDRIC=3;b.BILLBOARD_PARALLEL_CYLINDRIC=4;b.UNKNOWN=0;b.NUMBER=b.SCALAR=1;b.VEC2=2;b.VEC3=3;b.VEC4=4;b.QUAT=5;b.MAT3=6;b.TRANS10=7;b.MAT4=8;b.STRING=9;b.TYPES={NUMBER:b.NUMBER,SCALAR:b.NUMBER,VEC2:b.VEC2,VEC3:b.VEC3,VEC4:b.VEC4,QUAT:b.QUAT,MAT3:b.MAT3,TRANS10:b.TRANS10,MAT4:b.MAT4,STRING:b.STRING};b.TYPES_SIZE=[0,1,2,3,4,4,9,10,16,0];b.NO_INTERPOLATION=0;b.LINEAR=1;b.CUBIC=2;var r=b.DEG2RAD=0.0174532925;b.RAD2DEG=57.295779578552306;
b.Materials={};b.Images={};b.setup=function(d){d=d||{};if(b.configuration)throw"already called setup";b.configuration=d};var s=0;"undefined"==typeof extendClass&&(p.extendClass=function(d,b){for(var a in b)d.hasOwnProperty(a)||(d[a]=b[a]);if(b.prototype){var h=Object.getOwnPropertyNames(b.prototype);for(a=0;a<h.length;++a){var c=h[a];d.prototype.hasOwnProperty(c)||(b.prototype.__lookupGetter__(c)?d.prototype.__defineGetter__(c,b.prototype.__lookupGetter__(c)):d.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&
d.prototype.__defineSetter__(c,b.prototype.__lookupSetter__(c)))}}d.hasOwnProperty("superclass")||Object.defineProperty(d,"superclass",{get:function(){return b},enumerable:!1})});var q=mat4.create(),A=mat3.create(),v=mat4.create(),z=vec2.create(),u=vec3.create(),x=vec3.create();vec4.create();var y=quat.create();b.SceneNode=a;a.prototype._ctor=function(){this._uid=s++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,
7);this._scale=this._transform.subarray(7,10);quat.identity(this._rotation);this._scale.set(b.ONE);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.render_priority=b.PRIORITY_OPAQUE;this.layers=3;this._instances=this.draw_range=null;this.primitive=GL.TRIANGLES;this.primitives=[];this.mesh=null;this.textures={};this.shader=null;this.blend_mode=b.BLEND_NONE;this._color=vec4.fromValues(1,1,1,1);this.material=null;this.onRender||
(this.onRender=null);this.onShaderUniforms||(this.onShaderUniforms=null);this.flags={visible:!0,collides:!0};this.children=[];this._uniforms={u_color:this._color,u_color_texture:0}};a.ctor=a.prototype._ctor;a["@position"]={type:"vec3"};a["@rotation"]={type:"quat"};a.prototype.clone=function(d){var b=new this.constructor,a;for(a in this)if("_"!=a[0])if("children"==a){if(d)for(var c=0;c<this.children.length;++c)b.addChild(this.children[c].clone(d))}else c=this[a],void 0!==c&&(null===c?b[a]=null:c.constructor===
Object?b[a]=GL.cloneObject(c):c.constructor===Array?b[a]=c.concat():b[a]!==c&&(b[a]=c));return b};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(d){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=d},enumerable:!0});Object.defineProperty(a.prototype,"uniforms",{get:function(){return this._uniforms},set:function(d){GL.cloneObject(d,this._uniforms);this._uniforms.u_color=this._color},enumerable:!0});Object.defineProperty(a.prototype,
"position",{get:function(){return this._position},set:function(d){this._position.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"x",{get:function(){return this._position[0]},set:function(d){this._position[0]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"y",{get:function(){return this._position[1]},set:function(d){this._position[1]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"z",{get:function(){return this._position[2]},
set:function(d){this._position[2]=d;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rotation},set:function(d){this._rotation.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"scaling",{get:function(){return this._scale},set:function(d){d.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=d:this._scale.set(d);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,
"transform",{get:function(){return this._transform},set:function(d){this._transform.set(d);quat.normalize(this._rotation,this._rotation);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(a.prototype,"matrix",{get:function(){return this._local_matrix},set:function(d){this.fromMatrix(d)},enumerable:!1});Object.defineProperty(a.prototype,"pivot",{get:function(){return this._pivot},set:function(d){this._must_update_matrix=!0;d?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(d),
this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(a.prototype,"mustUpdate",{get:function(){return this._must_update_matrix},set:function(d){d&&(this._must_update_matrix=!0)},enumerable:!1});Object.defineProperty(a.prototype,"color",{get:function(){return this._color},set:function(d){this._color.set(d)},enumerable:!0});Object.defineProperty(a.prototype,"opacity",{get:function(){return this._color[3]},set:function(d){this._color[3]=d},enumerable:!0});
Object.defineProperty(a.prototype,"visible",{get:function(){return this.flags.visible},set:function(d){this.flags.visible=d},enumerable:!0});Object.defineProperty(a.prototype,"texture",{get:function(){return this.textures.color},set:function(d){this.textures.color=d},enumerable:!1});Object.defineProperty(a.prototype,"scene",{get:function(){return this._scene},set:function(d){throw"cannot set scene, you must use addChild in its parent node";},enumerable:!1});Object.defineProperty(a.prototype,"parentNode",
{get:function(){return this._parent},set:function(d){throw"Cannot set parentNode of SceneNode";},enumerable:!1});a.prototype.addChild=function(d,b){function a(d,b){if(d._scene&&d._scene!=b){var C=d._scene._nodes.indexOf(d);-1!=C&&d._scene._nodes.splice(C,1);d.id&&d._scene._nodes_by_id[d.id]==d&&delete d._scene._nodes_by_id[d.id]}if(d._scene=b)b._nodes.push(d),d.id&&b&&(b._nodes_by_id[d.id]=d);if(d.children)for(var C=0,c=d.children.length;C<c;C++){var h=d.children[C];h._scene!=b&&a(h,b)}}if(d._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";
d._parent=this;b&&d.fromMatrix(d._global_matrix);this.children||(this.children=[]);this.children.push(d);this._scene!=d._scene&&a(d,this._scene);return this};a.prototype.removeChild=function(d,b){function a(d){if(d._scene){d.id&&d._scene._nodes_by_id[d.id]==d&&delete d._scene._nodes_by_id[d.id];var b=d._scene._nodes.indexOf(d);-1!=b&&d._scene._nodes.splice(b,1)}d._scene=null;for(var b=0,C=d.children.length;b<C;b++)a(d.children[b])}if(d._parent!=this)throw"removeChild: Not its children";if(!this.children)return this;
var c=this.children.indexOf(d);if(-1==c)throw"removeChild: impossible, should be children";this.children.splice(c,1);d._parent=null;b?d.fromMatrix(d._global_matrix):d._global_matrix.set(d._local_matrix);a(d);return this};a.prototype.removeAllChildren=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])};a.prototype.clear=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-1])};a.prototype.setChildIndex=function(d,
b){if(this.children){var a=this.children.indexOf(d);-1!=a&&(this.children.splice(a,1),this.children.splice(b,0,d))}};a.prototype.getAllChildren=function(d){d=d||[];if(!this.children)return d;for(var b=0,a=this.children.length;b<a;b++){var c=this.children[b];d.push(c);c.getAllChildren(d)}return d};a.prototype.getVisibleChildren=function(d,b,a){d=d||[];void 0===b&&(b=65535);if(!this.children||!1===this.flags.visible)return d;for(var c=0,h=this.children.length;c<h;c++){var e=this.children[c];if(!1!==
e.flags.visible){var r=e.layers&b;if(!a||r)r&&d.push(e),e.getVisibleChildren(d,b)}}return d};a.prototype.serialize=function(){var d={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};this.name&&(d.name=this.name);this.primitives&&this.primitives.length&&(d.primitives=this.primitives.map(function(d){return Object.assign({},d)}));this.mesh&&
(d.mesh=this.mesh);this.material&&(d.material=this.material);null!=this.submesh&&(d.submesh=this.submesh);this.flags&&(d.flags=JSON.parse(JSON.stringify(this.flags)));this.extra&&(d.extra=this.extra);this.animation&&(d.animation=this.animation);if(this.animations){d.animations=[];for(var b=0;b<this.animations.length;++b)d.animations.push(this.animations[b].serialize())}if(this.skin)for(d.skin={},d.skin.joints=this.skin.joints.concat(),d.skin.skeleton_root=this.skin.skeleton_root,d.skin.bindMatrices=
[],b=0;b<this.skin.bindMatrices.length;++b)d.skin.bindMatrices.push(typedArrayToArray(this.skin.bindMatrices[b]));this.skeleton&&(d.skeleton=this.skeleton.serialize());if(this.onSerialize)this.onSerialize(d);if(this.children)for(var b=0,a=this.children.length;b<a;b++)d.children.push(this.children[b].serialize());return d};a.prototype.configure=function(d){var C=null,a;for(a in d){switch(a){case "children":continue;case "uniforms":for(var c in d.uniforms)this.uniforms[c]=d.uniforms[c];continue;case "texture":this[a]=
d[a];continue;case "flags":for(c in d.flags)this.flags[c]=d.flags[c];continue;case "scale":case "scaling":vec3.copy(this._scale,[1,1,1]);this.scale(d[a]);continue;case "tiling":isNumber(d[a])?this.setTextureTiling(d[a],d[a]):this.setTextureTiling(d[a][0],d[a][1],d[a][2],d[a][3]);continue;case "skeleton":var h=new b.Skeleton;h.configure(d[a]);this.skeleton=h;continue;case "animations":this.animations=[];for(c=0;c<d.animations.length;++c)h=new b.Animation,h.configure(d.animations[c]),this.animations.push(h);
continue;case "primitives":this.primitives=d.primitives.map(function(d){return Object.assign({},d)});continue;case "name":case "mesh":case "material":case "ref":case "draw_range":case "submesh":case "skin":case "animation":this[a]=d[a];continue;case "parent":C=d[a]}h=this[a];void 0!==h&&(h&&h.constructor===Float32Array?h.set(d[a]):this[a]=d[a])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(d.children)for(this.removeAllChildren(),a=0;a<d.children.length;++a)c=new b.SceneNode,c.configure(d.children[a]),
this.addChild(c);C&&(this.parentNode?console.error("This node already has a parent"):C.addChild(this))};a.prototype.setMesh=function(d){d?"string"==typeof d?this.mesh=d:this._mesh=d:this.mesh=null};a.prototype.setTexture=function(d,b){b?"string"==typeof b&&(this.textures[d]=b):this.textures[d]=null};a.prototype.resetTransform=function(){this._position.set(b.ZERO);quat.identity(this._rotation);this._scale.set(b.ONE);this._must_update_matrix=!0};a.prototype.translate=function(d,b){b?this.getGlobalVector(d,
u):u.set(d);vec3.add(this._position,this._position,u);this._must_update_matrix=!0};a.prototype.move=a.prototype.translate;a.prototype.moveLocal=function(d){this.translate(d,!0)};a.prototype.setEulerRotation=function(d,b,a){d&&3<=d.length?quat.fromEuler(this._rotation,d):quat.fromEuler(this._rotation,[d,b,a]);this._must_update_matrix=!0};a.prototype.setRotationFromEuler=a.prototype.setEulerRotation;a.prototype.getEulerRotation=function(d){d=d||vec3.create();quat.toEuler(d,this._rotation);return d};
a.prototype.rotate=function(d,b,a){quat.setAxisAngle(y,b,d);a?quat.multiply(this._rotation,y,this._rotation):quat.multiply(this._rotation,this._rotation,y);this._must_update_matrix=!0};a.prototype.rotateQuat=function(d,b){b?quat.multiply(this._rotation,d,this._rotation):quat.multiply(this._rotation,this._rotation,d);this._must_update_matrix=!0};a.prototype.scale=function(d){d.constructor===Number?(u[0]=u[1]=u[2]=d,vec3.mul(this._scale,this._scale,u)):vec3.mul(this._scale,this._scale,d);this._must_update_matrix=
!0};a.prototype.lookAt=function(d,b,a,c){this.position=d;this.orientTo(b,c,a)};a.prototype.orientTo=function(d,a,c,h,e){var r=this.getGlobalPosition(),f=vec3.create();h?f.set(d):vec3.sub(f,r,d);e&&(f[1]=0);c=c||b.UP;vec3.normalize(f,f);a&&vec3.scale(f,f,-1);d=mat3.create();c=vec3.cross(vec3.create(),c,f);vec3.normalize(c,c);a=vec3.cross(vec3.create(),f,c);vec3.normalize(a,a);mat3.setColumn(d,c,0);mat3.setColumn(d,a,1);mat3.setColumn(d,f,2);quat.fromMat3(this._rotation,d);quat.normalize(this._rotation,
this._rotation);this._must_update_matrix=!0};a.prototype.setPivot=function(d){this.pivot=d};a.prototype.setTextureTiling=function(d,b,a,c){this.texture_matrix||(this.texture_matrix=mat3.create(),this._uniforms.u_texture_matrix=this.texture_matrix);a=a||0;c=c||0;this.shader||(this.shader="texture_transform");mat3.identity(this.texture_matrix);mat3.translate(this.texture_matrix,this.texture_matrix,[a,c]);mat3.scale(this.texture_matrix,this.texture_matrix,[d,b])};a.prototype.getLocalMatrix=function(d){this._must_update_matrix&&
this.updateLocalMatrix();return d?(d.set(this._global_matrix),d):this._local_matrix};a.prototype.getGlobalMatrix=function(d,b){this.updateGlobalMatrix(b);return d?(d.set(this._global_matrix),d):this._global_matrix};a.prototype.getGlobalRotation=function(d){d=d||vec4.create();quat.identity(d);for(var b=this,a=this._scene?this._scene._root:null;b!=a;)quat.multiply(d,b._rotation,d),b=b._parent;return d};a.prototype.updateLocalMatrix=function(){var d=this._local_matrix;this._must_update_matrix=!1;mat4.identity(d);
this.flags.no_transform||(this.flags.pivot&&this._pivot&&(d[12]=this._pivot[0],d[13]=this._pivot[1],d[14]=this._pivot[2]),mat4.translate(d,d,this._position),mat4.fromQuat(v,this._rotation),mat4.multiply(d,d,v),mat4.scale(d,d,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(d,d,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))};a.prototype.updateGlobalMatrix=function(d,b){var a=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&
!0!==this._parent.flags.no_transform?(a=d?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(a):mat4.multiply(this._global_matrix,a,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(a=0;a<this.children.length;a++)this.children[a].updateGlobalMatrix(!0,b)};a.prototype.updateMatrices=function(d){this.updateLocalMatrix();this.updateGlobalMatrix(d)};a.prototype.fromMatrix=function(d,a){if(a&&this._parent&&this._parent._transform){mat4.copy(this._global_matrix,
d);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);d=mat4.multiply(this._local_matrix,c,d)}c=mat4.clone(d);mat4.multiplyVec3(this._position,c,[0,0,0]);var h=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(h,c,b.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(h,c,b.UP));this._scale[2]=vec3.length(mat4.rotateVec3(h,c,b.BACK));c=mat3.fromMat4(A,c);quat.fromMat3AndQuat(this._rotation,c);d!=this._local_matrix&&mat4.copy(this._local_matrix,d);this._must_update_matrix=!1};a.prototype.getLocalPoint=
function(d,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,d,this._local_matrix)};a.prototype.getParentVector=function(d,b){b=b||vec3.create();return vec3.transformQuat(b,d,this._rotation)};a.prototype.getLocalVector=function(d){console.error("DEPRECATED: SceneNode.prototype.getLocalVector, use getGlobalVector or getParentVector")};a.prototype.getGlobalPosition=function(d,a){d=d||vec3.create();if(a)return vec3.transformMat4(d,b.ZERO,this._global_matrix);
if(!this._parent||!this._parent._transform)return d.set(this._position),d;var c=this.getGlobalMatrix();return vec3.transformMat4(d,b.ZERO,c)};a.prototype.localToGlobal=function(d,b,a){b=b||vec3.create();a=this.getGlobalMatrix(null,a);return vec3.transformMat4(b,d,a)};a.prototype.getGlobalPoint=a.prototype.localToGlobal;a.prototype.globalToLocal=function(d,b){b=b||vec3.create();var a=this.getGlobalMatrix();mat4.invert(v,a);return vec3.transformMat4(b,d,v)};a.prototype.globalVectorToLocal=function(d,
b){b=b||vec3.create();var a=this.getGlobalRotation();quat.invert(a,a);return vec3.transformQuat(b,d,a)};a.prototype.getGlobalVector=function(d,b){b=b||vec3.create();var a=this.getGlobalRotation(y);return vec3.transformQuat(b,d,a)};a.prototype.getDistanceTo=function(d){var b=this.getGlobalMatrix();return vec3.distance(d,b.subarray(12,15))};a.prototype.findNode=function(d){for(var b=0,a=this.children.length;b<a;b++){var c=this.children[b];if(c.id==d||(c=c.findNode(d)))return c}return null};a.prototype.findNodeByName=
function(d){if(null==d)return null;for(var b=0,a=this.children.length;b<a;b++){var c=this.children[b];if(c.name==d||(c=c.findNodeByName(d)))return c}return null};a.prototype.findNodesByFilter=function(d,b,a){void 0===b&&(b=65535);a=a||[];for(var c=0,h=this.children.length;c<h;c++){var e=this.children[c];e.layers&b&&(d&&!d(e)||a.push(e),e.findNodesByFilter(d,b,a))}return a};a.prototype.propagate=function(d,b){for(var a=0,c=this.children.length;a<c;a++){var h=this.children[a];h&&(h[d]&&h[d].apply(h,
b),h.children&&h.children.length&&h.propagate(d,b))}};a.prototype.loadTextConfig=function(d,a){GL.request(d,null,function(d){d=b.parseTextConfig(d);a&&a(d)},alert)};a.prototype.destroy=function(d){!this.scene||d?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)};a.prototype.updateBoundingBox=function(d){var b=this._global_matrix,a=gl.meshes[this.mesh],c=null;a&&(c=a.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),c=BBox.transformMat4(this.bounding_box,
c,b));if(d||!this.children||0==this.children.length)return c;for(d=0;d<this.children.length;++d)if(b=this.children[d].updateBoundingBox())c?BBox.merge(c,c,b):(c=this.bounding_box=BBox.create(),c.set(b));return c};a.prototype.getMaterial=function(d){d=d||0;return this.material?b.Materials[this.material]:this.primitives&&this.primitives.length>d?b.Materials[this.primitives[d].material]:null};a.prototype.testRay=function(){var d=vec3.create();vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();
mat4.create();return function(b,a,c,h,e,f){c=void 0===c?Number.MAX_VALUE:c;void 0===h&&(h=65535);a=a||vec3.create();void 0!==m._ray_tested_objects&&m._ray_tested_objects++;var r=null,n=null;if(!1===this.flags.visible)return null;this.layers&h&&!this.flags.ignore_collisions&&this.mesh&&(n=this.testRayWithMesh(b,d,c,h,e,f));n&&(f=vec3.distance(b.origin,d),null==c||f<c)&&(c=f,a.set(d),r=this);if(!this.children||!this.children.length)return r;for(var n=vec3.create(),q=0,s=this.children.length;q<s;++q){var g=
this.children[q].testRay(b,n,c,h,e);g&&(f=vec3.distance(b.origin,n),f>c||(c=f,a.set(n),r=g))}return r}}();a.prototype.testRayWithMesh=function(){var d=vec3.create(),a=vec3.create(),c=vec3.create(),h=mat4.create();return function(e,f,r,n,q){if(!this.mesh)return!1;var s=gl.meshes[this.mesh];if(!s||!1===s.ready)return!1;var g=null==this.submesh?-1:this.submesh,l=this._global_matrix;mat4.invert(h,l);vec3.transformMat4(d,e.origin,h);vec3.add(c,e.origin,e.direction);vec3.transformMat4(c,c,h);vec3.sub(a,
c,d);vec3.normalize(a,a);var k=this.flags.two_sided;if(this.primitives&&this.primitives.length){var A=b.Materials[this.primitives[0].material];A&&(k=A.flags.two_sided)}return b.testRayMesh(e,d,a,l,s,g,f,r,n,q,k)}}();a.prototype.setRangeFromSubmesh=function(d){if(void 0!==d&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(d.constructor===String){for(var a=0;a<b.info.groups.length;++a)if(b.info.groups[a].name==d){d=a;break}if(a===b.info.groups.length)return!1}if(d=b.info.groups[d])this.draw_range[0]=
d.start,this.draw_range[1]=d.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null};a.prototype.findNodesInSphere=function(d,b,a,c){void 0===a&&(a=65535);c=c||[];for(var h=0;h<this.children.length;++h){var e=this.children[h];e.layers&a&&(e.getGlobalPosition(u,!0),vec3.distance(u,d)<=b&&c.push(e));e.children.length&&e.findNodesInSphere(d,b,a,c)}return c};b.Camera=k;k.PERSPECTIVE=1;k.ORTHOGRAPHIC=2;k.prototype.configure=function(d){null!=
d.type&&(this.type=d.type);d.position&&this._position.set(d.position);d.target&&this._target.set(d.target);d.up&&this._up.set(d.up);d.near&&(this.near=d.near);d.far&&(this.far=d.far);d.fov&&(this.fov=d.fov);d.aspect&&(this.aspect=d.aspect)};k.prototype.serialize=function(){return{type:this.type,position:[this.position[0],this.position[1],this.position[2]],target:[this.target[0],this.target[1],this.target[2]],up:this.up,fov:this.fov,near:this.near,far:this.far,aspect:this.aspect}};Object.defineProperty(k.prototype,
"position",{get:function(){return this._position},set:function(d){this._position.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"target",{get:function(){return this._target},set:function(d){this._target.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"up",{get:function(){return this._up},set:function(d){this._up.set(d);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"fov",{get:function(){return this._fov},
set:function(d){this._fov=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"aspect",{get:function(){return this._aspect},set:function(d){this._aspect=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(d){this._frustum_size=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"near",{get:function(){return this._near},set:function(d){this._near=
this.uniforms.u_camera_planes[0]=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"far",{get:function(){return this._far},set:function(d){this._far=this.uniforms.u_camera_planes[1]=d;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(k.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(d){this._view_matrix.set(d);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(k.prototype,
"projection_matrix",{get:function(){return this._projection_matrix},set:function(d){this._projection_matrix.set(d);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(k.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(d){this._viewprojection_matrix.set(d)},enumerable:!1});k.prototype.perspective=function(d,b,a,c){this.type=k.PERSPECTIVE;this._fov=d;this._aspect=b;this._near=a;
this._far=c;this._must_update_matrix=!0};k.prototype.orthographic=function(d,b,a,c){this.type=k.ORTHOGRAPHIC;this._frustum_size=d;1<arguments.lenth&&(this._near=b,this._far=a,this._aspect=c||1);this._must_update_matrix=!0};k.prototype.lookAt=function(d,b,a){this._position==b&&(b=vec3.clone(b));vec3.copy(this._position,d);vec3.copy(this._target,b);vec3.copy(this._up,a);this._must_update_matrix=!0};k.prototype.updateMatrices=function(d){if(this._autoupdate_matrices||d)if(this.type==k.ORTHOGRAPHIC?this.frustum_size.constructor===
Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*r,this._aspect,this._near,
this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up),this.view_texel_grid&&this.type==k.ORTHOGRAPHIC){d=2*(this.frustum_size.constructor===Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var a=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/d)*
d;this._view_matrix[13]=Math.floor(this._view_matrix[13]/a)*a}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,b.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,b.UP);mat4.rotateVec3(this._front,this._model_matrix,b.FRONT);this.distance=vec3.distance(this._position,
this._target);this.uniforms.u_camera_planes[0]=this._near;this.uniforms.u_camera_planes[1]=this._far};k.prototype.getModel=function(d){d=d||mat4.create();this._must_update_matrix&&this.updateMatrices();mat4.copy(d,this._model_matrix);return d};k.prototype.updateVectors=function(d){var a=vec3.subtract(u,this._target,this._position),a=vec3.length(a);mat4.multiplyVec3(this._position,d,b.ZERO);mat4.multiplyVec3(this._target,d,[0,0,-a]);mat4.rotateVec3(this._up,d,b.UP)};k.prototype.getLocalVector=function(d,
b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,d)};k.prototype.localToGlobal=function(d,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),d,this._model_matrix)};k.prototype.getLocalPoint=k.prototype.localToGlobal;k.prototype.globalToLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),d,this._view_matrix)};k.prototype.globalVectorToLocal=
function(d,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._view_matrix,d)};k.prototype.getFront=function(d){d=d||vec3.create();vec3.subtract(d,this._target,this._position);vec3.normalize(d,d);return d};k.prototype.move=function(d,b){void 0!==b&&(vec3.scale(u,d,b),d=u);vec3.add(this._target,this._target,d);vec3.add(this._position,this._position,d);this._must_update_matrix=!0};k.prototype.moveLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();
var a=mat4.rotateVec3(u,this._model_matrix,d);void 0!==b&&vec3.scale(a,a,b);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};k.prototype.rotate=function(d,b){var a=quat.setAxisAngle(y,b,d),c=vec3.subtract(u,this._target,this._position);vec3.transformQuat(c,c,a);vec3.add(this._target,this._position,c);this._must_update_matrix=!0};k.prototype.rotateLocal=function(d,b){this._must_update_matrix&&this.updateMatrices();var a=mat4.rotateVec3(x,
this._model_matrix,b),a=quat.setAxisAngle(y,a,d),c=vec3.subtract(u,this._target,this._position);vec3.transformQuat(c,c,a);vec3.add(this._target,this._position,c);this._must_update_matrix=!0};k.prototype.orbit=function(d,b,a,c){if(!b)throw"RD: orbit axis missing";a=a||this._target;c&&(this._must_update_matrix&&this.updateMatrices(),b=mat4.rotateVec3(x,this._model_matrix,b));d=quat.setAxisAngle(y,b,d);b=vec3.subtract(u,this._position,this._target);vec3.transformQuat(b,b,d);vec3.add(this._position,a,
b);this._must_update_matrix=!0};k.prototype.orbitDistanceFactor=function(d,b){b=b||this._target;var a=vec3.subtract(u,this._position,b);vec3.scale(a,a,d);vec3.add(this._position,b,a);this._must_update_matrix=!0};k.prototype.project=function(d,b,a){a=a||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(a,this._viewprojection_matrix,d);a[0]=a[0]*b[2]+b[0];a[1]=a[1]*b[3]+b[1];return a};k.prototype.computeProjectedRadius=function(d,a,c,h){c=c||gl.viewport_data;
if(h)return h=vec4.create(),h.set(d),h[3]=1,d=vec4.transformMat4(h,h,this._viewprojection_matrix),Math.max(1,c[3]*this._projection_matrix[5]*a/d[3]);if(this.type==b.Camera.ORTHOGRAPHIC)return a/(this._frustum_size.constructor===Number?this._frustum_size:1)*c[3]/2;d=vec3.distance(d,this.position);return 0==d?0:1/Math.tan(this.fov/2*Math.PI/180)*a/Math.sqrt(d*d-a*a)*(c[3]/2)};k.prototype.unproject=function(d,b,a){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(a||
vec3.create(),d,this._viewprojection_matrix,b)};k.prototype.getRay=function(d,a,c,h){if(void 0===d||void 0===a)throw"RD.Camera.getRay requires x and y parameters";c=c||gl.viewport_data;h||(h=new b.Ray);this._must_update_matrix&&this.updateMatrices();var e=h.origin;vec3.set(e,d,a,0);this.type==b.Camera.ORTHOGRAPHIC?vec3.unproject(e,e,this._viewprojection_matrix,c):vec3.copy(e,this.position);var f=h.direction;vec3.set(f,d,a,1);vec3.unproject(f,f,this._viewprojection_matrix,c);vec3.sub(f,f,e);vec3.normalize(f,
f);return h};k.prototype.getRayPlaneCollision=function(d,b,a,c,h,e){h=h||vec3.create();d=this.getRay(d,b,e);return geo.testRayPlane(d.origin,d.direction,a,c,h)?h:null};k.prototype.getModelForScreenPixel=function(d,b,a,c,h){h=h||mat4.create();d=this.unproject([d,b,-1]);b=vec3.sub(vec3.create(),d,this._position);vec3.normalize(b,b);vec3.scaleAndAdd(d,d,b,a);vec3.normalize(b,b);mat4.fromTranslationFrontTop(h,d,b,this._up);return h};k.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};
k.prototype.applyController=function(d,a,c,h){c=c||10;if(d){var e=vec3.create();if(gl.keys[k.controller_keys.forward]||h&&gl.keys.W)e[2]=-1;else if(gl.keys[k.controller_keys.back]||h&&gl.keys.S)e[2]=1;if(gl.keys[k.controller_keys.left]||h&&gl.keys.A)e[0]=-1;else if(gl.keys[k.controller_keys.right]||h&&gl.keys.D)e[0]=1;vec3.sqrLen(e)&&this.moveLocal(e,d*c)}a&&(a.deltax&&this.rotate(-0.005*a.deltax,b.UP),a.deltay&&this.rotateLocal(-0.005*a.deltay,b.RIGHT))};k.prototype.lerp=function(d,b){vec3.lerp(this._position,
this._position,d._position,b);vec3.lerp(this._target,this._target,d._target,b);vec3.lerp(this._up,this._up,d._up,b);this._fov=this._fov*(1-b)+d._fov*b;this._near=this._near*(1-b)+d._near*b;this._far=this._far*(1-b)+d._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+d._frustum_sizer*b);this._must_update_matrix=!0};k.prototype.orientMatrixToCamera=function(d){d.set(this._right,0);d.set(this._top,4);d.set(this._front,8)};k.prototype.extractPlanes=function(){function d(d){var b=
a.subarray(d,d+3),b=vec3.length(b);0!==!b&&(b=1/b,a[d]*=b,a[d+1]*=b,a[d+2]*=b,a[d+3]*=b)}var b=this._viewprojection_matrix,a=this._planes_data||new Float32Array(24);a.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);d(0);a.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);d(4);a.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);d(8);a.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);d(12);a.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);d(16);a.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],
b[15]+b[14]],20);d(20);this._planes_data=a;this._frustrum_planes||(this._frustrum_planes=[a.subarray(0,4),a.subarray(4,8),a.subarray(8,12),a.subarray(12,16),a.subarray(16,20),a.subarray(20,24)])};var B=b.CLIP_INSIDE=0,w=b.CLIP_OUTSIDE=1,D=b.CLIP_OVERLAP=2;k.prototype.testMesh=function(){if(p.BBox){var d=BBox.create(),b=d.subarray(0,3),a=d.subarray(3,6);return function(c,h){var e=c.bounding;if(!e)return B;BBox.transformMat4(d,e,h);return this.testBox(b,a)}}}();k.prototype.testBox=function(d,b){this._frustrum_planes||
this.extractPlanes();var a=this._frustrum_planes,c=0,h=0,c=n(a[0],d,b);if(c==w)return w;h+=c;c=n(a[1],d,b);if(c==w)return w;h+=c;c=n(a[2],d,b);if(c==w)return w;h+=c;c=n(a[3],d,b);if(c==w)return w;h+=c;c=n(a[4],d,b);if(c==w)return w;h+=c;c=n(a[5],d,b);return c==w?w:0==h+c?B:D};k.prototype.testSphere=function(d,b){this._frustrum_planes||this.extractPlanes();var a=this._frustrum_planes,h,e=!1;h=c(a[0],d);if(h<-b)return w;h>=-b&&h<=b&&(e=!0);h=c(a[1],d);if(h<-b)return w;h>=-b&&h<=b&&(e=!0);h=c(a[2],d);
if(h<-b)return w;h>=-b&&h<=b&&(e=!0);h=c(a[3],d);if(h<-b)return w;h>=-b&&h<=b&&(e=!0);h=c(a[4],d);if(h<-b)return w;h>=-b&&h<=b&&(e=!0);h=c(a[5],d);if(h<-b)return w;h>=-b&&h<=b&&(e=!0);return e?D:B};b.Scene=m;m.prototype.clear=function(){this._root=new b.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};m.prototype.getNodeById=function(d){return this._nodes_by_id[d]};m.prototype.findNodesInBBox=function(d,b,a){void 0===b&&(b=65535);a=a||[];for(var c=0;c<this.nodes.length;++c){var h=
this.nodes[c];h.bounding_box&&h.layers&b&&geo.testBBoxBBox(h.bounding_box,d)&&a.push(h)}return a};m.prototype.update=function(d){this.time+=d;this._root.propagate("update",[d]);this.destroyPendingNodes()};m.prototype.destroyPendingNodes=function(d){if(this._to_destroy.length)for(d=null;d=this._to_destroy.pop();)d._parent&&d._parent.removeChild(d)};Object.defineProperty(m.prototype,"root",{get:function(){return this._root},set:function(d){throw"Cannot set root of scene";},enumerable:!1});m.prototype.testRay=
function(d,a,c,h,e){b.Scene._ray_tested_objects=0;a||(a=d.collision_point);void 0===e&&(e=!0);return this.root.testRay(d,a,c,void 0===h?65535:h,e)};b.testRayWithNodes=function(d,a,c,h,e,f,r){b.testRayWithNodes.coll_node=null;h=null==h?Number.MAX_VALUE:h;e=void 0===e?65535:e;b.Scene._ray_tested_objects=0;c||(c=d.collision_point);b.testRayWithNodes.local_result||(b.testRayWithNodes.local_result=vec3.create());for(var n=b.testRayWithNodes.local_result,q=null,s=0;s<a.length;++s){var g=a[s],l=g.testRay(d,
n,h,e,f);if(l){var k=vec3.distance(d.origin,n);k>h||(h=k,c.set(n),b.testRayWithNodes.coll_node=l,q=r?l:g)}}return q};b.last_hit_test=null;b.testRayMesh=function(d,a,c,h,e,f,r,n,q,s,g){n=null==n?Number.MAX_VALUE:n;var l=null;q=null;-1==f?(l=e.getBoundingBox(),q=e):(q=e.info.groups[f],l=q.bounding,l||(e.computeGroupsBoundingBoxes(),l=q.bounding));if(!l)return!1;n||(n=1E7);if(!geo.testRayBBox(a,c,l,null,u))return!1;vec3.transformMat4(r,u,h);f=vec3.distance(d.origin,r);if(f>n)return!1;if(!s)return!0;
q._octree||(q._octree=q==e?new GL.Octree(e):new GL.Octree(e,q.start,q.length));a=q._octree.testRay(a,c,0,n,g);if(!a)return!1;b.last_hit_test=a;r.set(a.hit);vec3.transformMat4(r,r,h);f=vec3.distance(d.origin,r);return f>n?!1:!0};m.prototype.fromJSON=function(d){this.root.clear();this.root.configure(d)};m.prototype.toJSON=function(d){function b(c,h){if(d){if(!d(c,h))return!1}else{if(!c.flags.no_transform){h.position=typedArrayToArray(c.position);if(0!=c.rotation[0]||0!=c.rotation[1]||0!=c.rotation[2]||
1!=c.rotation[3])h.rotation=typedArrayToArray(c.rotation);if(1!=c.scaling[0]||1!=c.scaling[1]||1!=c.scaling[2])h.scaling=typedArrayToArray(c.scaling)}c.id&&(h.id=c.id);c.ref=h.ref=a++;c.mesh&&(h.mesh=c.mesh);null!=c.submesh&&(h.submesh=c.submesh);c.draw_range&&(h.draw_range=c.draw_range.concat());c.material&&(h.material=c.material);c.shader&&(h.shader=c.shader);if(1!=c.color[0]||1!=c.color[1]||1!=c.color[2]||1!=c.color[3])h.color=typedArrayToArray(c.color);0<Object.values(c.textures).filter(function(d){return d})&&
(h.shader=c.shader);c.extra&&(h.extra=c.extra);h.layers=c.layers;h.flags=c.flags}if(!c.children.length)return!0;for(var e=[],f=0;f<c.children.length;++f){var r={};b(c.children[f],r)&&e.push(r)}e.length&&(h.children=e);return!0}d&&d.constructor!==Function&&(d=null);var a=0,c={};b(this.root,c);return c};g.default_shader_name="texture";Object.defineProperty(g.prototype,"color",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!0});Object.defineProperty(g.prototype,"opacity",
{get:function(){return this._color[3]},set:function(d){this._color[3]=d},enumerable:!0});Object.defineProperty(g.prototype,"albedo",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!1});g.prototype.configure=function(d){for(var b in d)this[b]=d[b]};g.prototype.register=function(d){d&&(this.name=d);if(!this.name)throw"cannot register material without name";b.Materials[this.name]=this;return this};g.prototype.serialize=function(){var d={flags:this.flags,textures:this.textures};
d.color=typedArrayToArray(this._color);this.name&&(d.name=this.name);this.alphaMode&&(d.alphaMode=this.alphaMode);this.blendMode&&(d.blendMode=this.blendMode);0.5!=this.alphaCutoff&&(d.alphaCutoff=this.alphaCutoff);this.uv_transform&&(d.uv_transform=this.uv_transform);this.normalFactor&&(d.normalFactor=this.normalFactor);this.displacementFactor&&(d.displacementFactor=this.displacementFactor);this.backface_color&&(d.backface_color=typedArrayToArray(this.backface_color));this.emissive&&(d.emissive=
typedArrayToArray(this.emissive));this.model&&(d.model=this.model,d.metallicFactor=this.metallicFactor,d.roughnessFactor=this.roughnessFactor);return d};g.prototype.render=function(d,a,c,h,e){var f=this.shader_name;f||(f="pbrMetallicRoughness"==this.model?"texture_albedo":d.default_shader_name||b.Material.default_shader_name);(f=gl.shaders[f])||(f=this.textures.color||this.textures.albedo?d._texture_shader:d._flat_shader);var r=0,n=null,q;for(q in this.textures){var s=this.textures[q];if(s){s.constructor===
Object&&(s=s.texture);var l="u_"+q+"_texture";if(!f||f.samplers[l])n=gl.textures[s],n||(d.autoload_assets&&-1!=s.indexOf(".")&&d.loadTexture(s,d.default_texture_settings),n=gl.textures.white),this.uniforms[l]=n.bind(r++)}}d.enableItemFlags(this);d._uniforms.u_model.set(a);f.uniforms(d._uniforms);f.uniforms(this.uniforms);a=null;null!=e&&c.info&&c.info.groups&&c.info.groups[e]&&(a=c.info.groups[e]);a?f.drawRange(c,this.primitive,a.start,a.length,h):f.draw(c,this.primitive,h);d.disableItemFlags(this);
d.draw_calls+=1};b.Material=g;b.Renderer=e;Object.defineProperty(e.prototype,"color",{set:function(d){this._color.set(d)},get:function(){return this._color},enumerable:!0});e.prototype.setDataFolder=function(d){d?(this.assets_folder=d,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};e.prototype.clear=function(d){d?this.gl.clearColor(d[0],d[1],d[2],3<=d.length?d[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};e._sort_by_dist_func=
function(d,b){return b._distance-d._distance};e._sort_by_priority_func=function(d,b){return b.render_priority-d.render_priority};e._sort_by_priority_and_dist_func=function(d,b){var a=b.render_priority-d.render_priority;return 0!=a?a:b._distance-d._distance};e.prototype.render=function(d,a,c,h,e,f){null==h&&(h=65535);if(!d)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";a=a||d.camera;if(!a)throw"Renderer.render: camera not provided";
p.gl=this.gl;this._nodes.length=0;c||d._root.getVisibleChildren(this._nodes,h,this.layers_affect_children);c=c||this._nodes;this.enableCamera(a);this.enable2DView();this._state=[];this._meshes_missing=0;this._current_scene=d;this._uniforms.u_time=d.time;this.sort_by_distance&&c.forEach(function(d){d._distance=d.getDistanceTo(a._position)});var r=this;c=c.filter(function(d){return!d.mustRender||!1!=d.mustRender(r,a)});this.sort_by_distance&&this.sort_by_priority?c.sort(b.Renderer._sort_by_priority_and_dist_func):
this.sort_by_priority?c.sort(b.Renderer._sort_by_priority_func):this.sort_by_distance&&c.sort(b.Renderer._sort_by_dist_func);if(this.onPreRender)this.onPreRender(a);d._root.preRender&&d._root.preRender(this,a);if(e=e||this.pipeline)e.render(this,c,a,d,f);else{for(e=0;e<c.length;++e){f=c[e];f.updateGlobalMatrix(!0);if(this.onPreRenderNode)this.onPreRenderNode(f,a);f.preRender&&f.preRender(this,a)}for(e=0;e<c.length;++e)f=c[e],f.flags.was_rendered=!1,!1!==f.flags.visible&&f.layers&h&&(!this.mustRenderNode||
!1!==this.mustRenderNode(f,a))&&(f.flags.was_rendered=!0,this.setModelMatrix(f._global_matrix),f.render?f.render(this,a):this.renderNode(f,a));d._root.postRender&&d._root.postRender(this,a);for(e=0;e<c.length;++e)if(f=c[e],f.postRender&&f.postRender(this,a),this.onPostRenderNode)this.onPostRenderNode(f,a)}if(this.onPostRender)this.onPostRender(a);d.frame++;this.frame++;this._current_scene=null};e.prototype.enableCamera=function(d){this._camera=d;d.updateMatrices();d.extractPlanes();this._view_matrix.set(d._view_matrix);
this._projection_matrix.set(d._projection_matrix);this._viewprojection_matrix.set(d._viewprojection_matrix);this._uniforms.u_camera_position=d.position};e.prototype.enable2DView=function(){mat4.ortho(this._viewprojection2D_matrix,0,gl.viewport_data[2],0,gl.viewport_data[3],-1,1)};e.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};e.prototype.restoreState=function(){var d=this.state.pop(),b=this.camera=d.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);
this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=d.nodes};e.prototype.setModelMatrix=function(d){this._model_matrix.set(d);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,d)};e.prototype.setGlobalUniforms=function(d){for(var b in d)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(d[b]):this._uniforms[b]=d[b]};var E={u_model:null};e.prototype.renderNode=function(d,a){var c=null;d._mesh?c=d._mesh:d.mesh&&(c=gl.meshes[d.mesh],
c||(this._meshes_missing++,this.autoload_assets&&-1!=d.mesh.indexOf(".")&&this.loadMesh(d.mesh)));if(d.primitives&&d.primitives.length){if(c)for(var h=0;h<d.primitives.length;++h){var e=d.primitives[h],f=this.overwrite_material||b.Materials[e.material];!f||this.onFilterByMaterial&&!1==this.onFilterByMaterial(f,b.Materials[e.material])||this.renderMeshWithMaterial(d._global_matrix,c,f,"triangles",h)}}else{if(c&&(d.material||this.overwrite_material)&&(f=this.overwrite_material||b.Materials[d.material])){if(f.render){this.renderMeshWithMaterial(d._global_matrix,
c,f,d.indices,d.submesh);return}d.color=f.color}if(c){e=!1;d._instances&&(1<gl.webgl_version||gl.extensions.ANGLE_instanced_arrays)&&(e=!0);var f=null,r=d.shader;this.on_getShader?f=this.on_getShader(d,a):(!f&&d.shader&&(f=gl.shaders[r]),this.shader_overwrite&&(f=gl.shaders[this.shader_overwrite]));f||(f=d.textures.color?this._texture_shader:this._flat_shader);e&&!f.attributes.u_model&&(e=!1);var r=0,n=null;for(h in d.textures){var q=d.textures[h];if(q){q.constructor===Object&&(q=q.texture);var s=
"u_"+h+"_texture";if(!f||f.samplers[s])n=gl.textures[q],n||(this.autoload_assets&&-1!=q.indexOf(".")&&this.loadTexture(q,this.default_texture_settings),n=gl.textures.white),d.flags.pixelated?(n.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST)):!1===d.flags.pixelated&&(n.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)),
d._uniforms[s]=n.bind(r++)}}this.ignore_flags||this.enableItemFlags(d);if(d.onRender)d.onRender(this,a,f);for(h=0;h<this.global_uniforms_containers.length;++h)f.uniforms(this.global_uniforms_containers[h]);this.skip_node_uniforms||f.uniforms(d._uniforms);if(d.onShaderUniforms)d.onShaderUniforms(this,f);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,f,d);h=null;null!=d.submesh&&c.info&&c.info.groups&&c.info.groups[d.submesh]&&(h=c.info.groups[d.submesh]);e?(E.u_model=d._instances,h?f.drawInstanced(c,
void 0===d.primitive?gl.TRIANGLES:d.primitive,d.indices,E,h.start,h.length):d.draw_range?f.drawInstanced(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.indices,E,d.draw_range[0],d.draw_range[1]):f.drawInstanced(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.indices,E)):h?f.drawRange(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,h.start,h.length,d.indices):d.draw_range?f.drawRange(c,void 0===d.primitive?gl.TRIANGLES:d.primitive,d.draw_range[0],d.draw_range[1],d.indices):f.draw(c,void 0===d.primitive?
gl.TRIANGLES:d.primitive,d.indices);this.ignore_flags||this.disableItemFlags(d);this.draw_calls+=1}else if(d.onRender)d.onRender(this,a)}};e.prototype.renderMesh=function(d,a,c,h,e,f,r,n){a&&(h&&this._uniforms.u_color.set(h),d||(d=b.IDENTITY),this._uniforms.u_model.set(d),e||(e=c?gl.shaders.texture:gl.shaders.flat),c&&(this._uniforms.u_texture=c.bind(0)),e.uniforms(this._uniforms),e.draw(a,void 0===f?gl.TRIANGLES:f,r),this.draw_calls+=1)};e.prototype.renderMeshWithMaterial=function(d,b,a,c,h){a.render&&
a.render(this,d,b,c,h)};e.prototype.renderBounding=function(d,a,c){if(d){a=a||b.IDENTITY;var h=this._uniforms.u_model,e=null,e=d.constructor===GL.Mesh?d._bounding:d;c=c||[1,1,0,1];d=e.subarray(3,6);mat4.translate(h,a,e.subarray(0,3));mat4.scale(h,h,[2*d[0],2*d[1],2*d[2]]);this.renderMesh(h,gl.meshes.cube,null,c,null,gl.LINES,"wireframe")}};e.prototype.enableItemFlags=function(d){var a=d.flags.flip_normals;this.reverse_normals&&(a=!a);gl.frontFace(a?gl.CW:gl.CCW);gl[!1===d.flags.depth_test?"disable":
"enable"](gl.DEPTH_TEST);!1===d.flags.depth_write&&gl.depthMask(!1);gl[!0===d.flags.two_sided||this.disable_cull_face?"disable":"enable"](gl.CULL_FACE);if(d.blend_mode!==b.BLEND_NONE)switch(gl.enable(gl.BLEND),d.blend_mode){case b.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case b.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case b.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND);"BLEND"==d.alphaMode&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,
gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1))};e.prototype.disableItemFlags=function(d){d.flags.flip_normals&&gl.frontFace(gl.CCW);!1===d.flags.depth_test&&gl.enable(gl.DEPTH_TEST);d.blend_mode!==b.BLEND_NONE&&gl.disable(gl.BLEND);d.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===d.flags.depth_write&&gl.depthMask(!0);"BLEND"==d.alphaMode&&(gl.depthMask(!0),gl.disable(gl.BLEND))};e.prototype.setPointSize=function(d){this.point_size=d;gl.shaders.point.uniforms({u_pointSize:this.point_size})};b.Renderer.prototype.renderPoints=
function(d,a,c,h,e,f,r,n,q){if(!d||d.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";e||(r==GL.LINES||r==GL.LINE_LOOP?e=this.shaders.flat:n?(e=this.shaders._points_textured,e||(e=this.shaders._points_textured=new GL.Shader(b.points_vs_shader,b.points_fs_shader,{TEXTURED:""}),e.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))):(e=this.shaders[a?"_points_color":"_points"],e||(e=a?this.shaders._points_color=new GL.Shader(b.points_vs_shader,b.points_fs_shader,{COLORED:""}):
this.shaders._points=new GL.Shader(b.points_vs_shader,b.points_fs_shader),e.uniforms({u_texture:0,u_atlas:1,u_pointSize:1}))));f=f||1;var s=1024;h=h||d.length/3;var l=null,g=null,k=this._points_mesh;h>d.length/3&&(h=d.length/3);!k||d.length>3*s?(h>s&&(s=GL.Texture.nextPOT(h)),l=new Float32Array(3*s),g=new Float32Array(4*s),k=this._points_mesh=GL.Mesh.load({vertices:l,extra4:g})):(l=this._points_mesh.getBuffer("vertices").data,g=this._points_mesh.getBuffer("extra4").data);l.set(l.length>d.length?d:
d.subarray(0,l.length));a?g.set(g.length>a.length?a:a.subarray(0,g.length)):g.fill&&g.fill(0);k.upload(GL.DYNAMIC_STREAM);e.setUniform("u_color",this._color);e.setUniform("u_pointSize",f);e.setUniform("u_camera_perspective",c._projection_matrix[5]);e.setUniform("u_model",q||b.IDENTITY);e.setUniform("u_viewport",gl.viewport_data);e.setUniform("u_viewprojection",c._viewprojection_matrix);n&&e.setUniform("u_texture",n.bind(0));e.drawRange(k,void 0!==r?r:GL.POINTS,0,h);return k};b.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
b.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\nvarying vec4 v_extra4;\nvec2 remap(in vec2 value, in vec2 low1, in vec2 high1, in vec2 low2, in vec2 high2 ) { vec2 range1 = high1 - low1; vec2 range2 = high2 - low2; return low2 + range2 * (value - low1) / range1; }\n#ifdef TEXTURED\n\tuniform sampler2D u_texture;\n#endif\n#ifdef FS_UNIFORMS\n\tFS_UNIFORMS\n#endif\n\nvoid main() {\n\tvec4 color = u_color;\n\t#ifdef COLORED\n\t\tcolor *= v_extra4;\n\t#endif\n\t#ifdef TEXTURED\n\t\tcolor *= texture2D( u_texture, gl_FragCoord );\n\t#endif\n\t#ifdef FS_CODE\n\t\tFS_CODE\n\t#endif\n\tgl_FragColor = color;\n}\n";
e.prototype.renderLines=function(d,a,c,h){if(!d||d.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";var e=this.shaders._lines;e||(e=this.shaders._lines=new GL.Shader(b.lines_vs_shader,this._flat_fragment_shader));var f=this._camera,r=1024,n=d.length/3,q=c?2*n:4*n,s=null,l=null,g=null,r=this._lines_mesh;!r||3*q>r.getBuffer("vertices").data.length?(r=GL.Texture.nextPOT(q),s=new Float32Array(3*r),l=new Float32Array(3*r),g=new Float32Array(2*r),indices_data=new Uint16Array(3*
r),r=this._lines_mesh=GL.Mesh.load({triangles:indices_data,vertices:s,normals:l,extra2:g})):(s=this._lines_mesh.getBuffer("vertices").data,l=this._lines_mesh.getBuffer("normals").data,g=this._lines_mesh.getBuffer("extra2").data,indices_data=this._lines_mesh.getIndexBuffer("triangles").data);var q=vec2.fromValues(-1,-1),k=vec2.fromValues(1,-1),A=vec2.fromValues(-1,1),m=vec2.fromValues(1,1),p=vec3.create();if(c)throw"strip lines not supported yet";c=Math.floor(n/2);for(var t=0;t<c;++t){var v=2*t,x=
d.subarray(3*v,3*v+3),v=d.subarray(3*v+3,3*v+6);vec3.sub(p,v,x);s.set(x,12*t);s.set(x,12*t+3);s.set(v,12*t+6);s.set(v,12*t+9);l.set(p,12*t);l.set(p,12*t+3);l.set(p,12*t+6);l.set(p,12*t+9);g.set(q,8*t);g.set(k,8*t+2);g.set(A,8*t+4);g.set(m,8*t+6);indices_data.set([4*t+0,4*t+2,4*t+1,4*t+1,4*t+2,4*t+3],6*t)}r.upload(GL.DYNAMIC_STREAM);gl.enable(gl.CULL_FACE);e.setUniform("u_model",h||b.IDENTITY);e.setUniform("u_color",this._color);e.setUniform("u_camera_front",f._front);e.setUniform("u_camera_position",
f.eye);e.setUniform("u_lineWidth",0.5*a);e.setUniform("u_camera_perspective",f._projection_matrix[5]);e.setUniform("u_viewport",gl.viewport_data);e.setUniform("u_viewprojection",f._viewprojection_matrix);e.drawRange(r,gl.TRIANGLES,0,6*n);return r};b.lines_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_extra2;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec3 u_camera_front;\nuniform vec3 u_camera_position;\nuniform float u_camera_perspective;\nuniform float u_lineWidth;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\nvoid main() {\n\tvec3 T = normalize( (u_model * vec4(a_normal,0.0)).xyz );\n\tvec3 pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\tvec3 pos2 = (u_model * vec4(a_vertex + T,1.0)).xyz;\n\tvec3 front = u_camera_front;//normalize( a_vertex - u_camera_position );\n\tT = normalize( pos2 - pos ) ;\n\t//float proj_w = (u_viewprojection * vec4(a_vertex,1.0)).w;\n\t//float fixed_size_factor = computePointSize( u_lineWidth, proj_w );\n\tvec3 side = normalize( cross(T,front) * a_extra2.x ) * u_lineWidth;\n\tpos += side;\n\tgl_Position = u_viewprojection * vec4(pos,1.0);\n}\n";
e.prototype.getAssetFullPath=function(d,b){if(-1==d.indexOf("://")&&!b&&this.assets_folder){if(this.onGetAssetsFolder)return this.onGetAssetFolder(d);var a="/"==this.assets_folder.substr(-1),c="/"==d[0];return a!=c?this.assets_folder+d:a&&c?this.assets_folder+d.substr(1):this.assets_folder+"/"+d}return d};e.prototype.loadMesh=function(d,b,a){if(!d)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[d]&&!this.assets_not_found[d]){var c=this.meshes[d];if(c)return b&&b(c),
c;var h=this;a=this.getAssetFullPath(d,a);a=GL.Mesh.fromURL(a,function(a){a?h.meshes[d]=a:(h.assets_not_found[d]=!0,delete h.meshes[d]);h.num_assets_loading--;delete h.assets_loading[d];b&&b(a,d)});this.assets_loading[d]=a;this.num_assets_loading++;return this.meshes[d]=a}};e.prototype.loadTexture=function(d,b,a,c){function h(b){r.debug&&console.log(" + texture loaded: "+d);b?r.textures[e]=b:r.assets_not_found[d]=!0;a&&a(b,e);r.num_assets_loading--;delete r.assets_loading[d];if(r.on_texture_load)r.on_texture_load(b,
e)}if(!d)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[d]&&!this.assets_not_found[d]){var e=d;b&&(b.name&&(e=b.name),b.preview&&(e=b.preview));var f=this.textures[e];if(f&&!f.is_preview)return a&&a(f),f;var r=this;c=this.getAssetFullPath(d,c);var n=null;-1!=d.indexOf("CUBEMAP")?n=GL.Texture.cubemapFromURL(c,this.default_cubemap_settings,h):this.credentials?(this.credentials.headers?this.credentials.headers["Content-Type"]="application/octet-stream":this.credentials.headers=
{"Content-Type":"application/octet-stream"},n=new GL.Texture(1,1,b),fetch(c,this.credentials).then(function(b){if(!b.ok)throw Error("HTTP "+b.status+":"+b.statusText);return b.arrayBuffer()}).then(function(d){var a=URL.createObjectURL(new Blob([d]));b.texture=n;n=GL.Texture.fromURL(a,b,h);b.texture=null;setTimeout(function(){URL.revokeObjectURL(a)},6E4)})):n=GL.Texture.fromURL(c,b,h);b&&b.preview&&(n.is_preview=!0);this.assets_loading[d]=n;this.num_assets_loading++;return this.textures[e]=n}};e.prototype.loadTextureAtlas=
function(b,a,c){"string"==typeof b&&(b=JSON.parse(b));var h=this;-1==a.indexOf("://")&&(a=this.assets_folder+a);GL.Texture.fromURL(a,null,function(a){var e=b.files;h.textures[":atlas"]=a;for(var f in e)if(!h.textures[f]||h.textures[f].is_preview){var r=e[f],n=new GL.Texture(b.size,b.size,{wrap:gl.REPEAT,filter:gl.LINEAR});n.drawTo(function(){a.gl.drawTexture(a,0,0,b.size,b.size,r.x,r.y,r.width||b.size,r.height||b.size)});n.is_preview=!0;h.textures[f]=n}c&&c(e)})};e.prototype.loadShaders=function(b,
a,c,h){var e=this;-1!=b.indexOf("://")||h||(b=this.assets_folder+b);b+="?nocache="+Math.random();this.loading_shaders=!0;GL.loadFileAtlas(b,function(b){e.compileShadersFromAtlas(b,c);e.loading_shaders=!1;a&&a(b)})};e.prototype.reloadShaders=function(b){};e.prototype.compileShadersFromAtlasCode=function(b,a){var c=GL.processFileAtlas(b);this.compileShadersFromAtlas(c,a)};e.prototype.compileShadersFromAtlas=function(b,a){var c=b.shaders;if(c){this.shader_files=b;for(var h in b)b[h]=GL.Shader.expandImports(b[h],
b);c=c.split("\n");for(h=0;h<c.length;++h){var e=c[h].trim().split(" "),f=e[0].trim();if("//"!=f.substr(0,2)){var r=b[e[1]],n=b[e[2]],q=null,s={};if(3<e.length)for(var l=3;l<e.length;++l)if("#"==e[l][0])s[e[l].substr(1)]=!0;else{q=e.slice(l).join(" ");break}if(!s.WEBGL1||1==gl.webgl_version)if(!s.WEBGL2||2==gl.webgl_version){e[1]&&"@"==e[1][0]&&(s=e[1].substr(1)+"_VERTEX_SHADER",GL.Shader[s]&&(r=GL.Shader[s]));e[2]&&"@"==e[2][0]&&(s=e[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[s]&&(n=GL.Shader[s]));
if(q)try{q=JSON.parse(q)}catch(g){console.error("Error in shader macros: ",f,q,g)}if(q&&a){var s={},k;for(k in q)s[k]=q[k];for(k in a)s[k]=a[k];q=s}else a&&(q=a);try{r&&n?this.shaders[f]?this.shaders[f].updateShader(r,n,q):this.shaders[f]=new GL.Shader(r,n,q):console.warn("Shader subfile not found: ",e[1],e[2])}catch(A){GL.Shader.dumpErrorToConsole(A,r,n)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};e.prototype.setShadersFromFile=function(b){b=GL.processFileAtlas(b);
this.compileShadersFromAtlas(b)};e.cubemap_info=[{front:[1,0,0],up:[0,-1,0]},{front:[-1,0,0],up:[0,-1,0]},{front:[0,1,0],up:[0,0,1]},{front:[0,-1,0],up:[0,0,-1]},{front:[0,0,1],up:[0,-1,0]},{front:[0,0,-1],up:[0,-1,0]}];e.prototype.renderToCubemap=function(d,a,c,h,f,r,n){var q=e.cubemap_camera;q||(e.cubemap_camera=q=new b.Camera);q.perspective(90,1,r||0.1,n||1E3);var s=vec3.create(),l=this;d.drawTo(function(b,d){var r=e.cubemap_info[d];vec3.add(s,c,r.front);q.lookAt(c,s,r.up);l.clear();l.render(a,
q,h,f)});return d};e.prototype.drawSphere3D=function(b,a,c){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var h=gl.shaders.flat;h.setUniform("u_color",c);h.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(v);mat4.translate(v,v,b);mat4.scale(v,v,[a,a,a]);h.setUniform("u_model",v);h.draw(gl.meshes.sphere);this.draw_calls+=1};e.prototype.drawCircle2D=function(b,a,c,h,e){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||
(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:0.02,slices:64}));var f=gl.shaders.flat;f.setUniform("u_color",h);f.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(v);mat4.translate(v,v,[b,a,0]);mat4.scale(v,v,[2*c,2*c,2*c]);f.setUniform("u_model",v);f.draw(gl.meshes[e?"circle":"ring"]);this.draw_calls+=1};e.prototype.drawLine2D=function(d,a,c,h,e,f,r){var n=gl.meshes.plane;r=r||gl.shaders.flat;r.setUniform("u_color",f);r.setUniform("u_viewprojection",this._viewprojection2D_matrix);
var q=c-d,s=h-a;f=Math.atan2(q,s);q=Math.sqrt(q*q+s*s);e/=2;mat4.identity(v);mat4.translate(v,v,[0.5*(d+c),0.5*(a+h),0]);mat4.rotate(v,v,f,b.FRONT);d=e;mat4.scale(v,v,[d,q,d]);r.setUniform("u_model",v);r.draw(n);this.draw_calls+=1};b.sortByDistance=function(b,a){b.forEach(function(b){b._distance=b.getDistanceTo(a)});b.sort(function(b,d){return d._distance-b._distance})};b.noBlending=function(d){return d.blend_mode===b.BLEND_NONE};b.generateTextureAtlas=function(b,a,c,h,e){a=a||1024;c=c||1024;h=h||
64;var f=0,r;for(r in b)f++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var f=new GL.Texture(a,c),n={width:a,height:c,size:h,files:{}},q=0,s=0,l={};f.drawTo(function(){for(var f in b)if(":"!=f[0]&&"white"!=f&&"black"!=f&&"notfound"!=f){var r=b[f];if(!r.is_preview&&r.texture_type==gl.TEXTURE_2D){if(e){var g=r.toBase64().hashCode();if(l[g]){n.files[f]=n.files[l[g]];continue}l[g]=f}n.files[f]={x:q,y:s};r.renderQuad(q,s,h,h);q+=h;if(q==a&&(q=0,s+=h,s==c)){console.warn("Atlas too small, some textures wont be stored.");
break}}}});f.info=n;console.log(n);return f};e.prototype.computeResourcesLoaded=function(b){var a=0,c;for(c in b){var h=b[c],e=this.textures[h];e&&!1===e.ready||(h=this.meshes[h])&&!1===h.ready||(e||h)&&a++}return a};Object.defineProperty(e.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(b){},enumerable:!0});Object.defineProperty(e.prototype,"textures",{get:function(){return this.gl.textures},set:function(b){},enumerable:!0});Object.defineProperty(e.prototype,"shaders",{get:function(){return this.gl.shaders},
set:function(b){},enumerable:!0});e.prototype.addMesh=function(b,a){a.gl!=this.gl&&(a=a.cloneShared(this.gl));this.gl.meshes[b]=a};b.Renderer=e;b.Ray=l;l.prototype.testPlane=function(b,a){return geo.testRayPlane(this.origin,this.direction,b,a,this.collision_point)};l.prototype.testSphere=function(b,a,c){return geo.testRaySphere(this.origin,this.direction,b,a,this.collision_point,c)};l.prototype.closestPointOnRay=function(b,a,c){c=c||vec3.create();var h=vec3.create();vec3.add(h,this.origin,this.direction);
var e=vec3.create();vec3.add(e,b,a);geo.closestPointBetweenLines(this.origin,h,b,e,null,c);return c};b.Factory=function(d,a,c){d=b.Factory.templates[d];var h=new b.SceneNode;d&&h.configure(d);a&&(a.constructor===b.Scene?a.root:a).addChild(h);c&&h.configure(c);return h};b.Factory.templates={grid:{mesh:"grid",primitive:1,color:[0.5,0.5,0.5,0.5],blend_mode:b.BLEND_ALPHA},mesh:{shader:"phong"},sphere:{mesh:"sphere",shader:"phong"},floor:{mesh:"planeXZ",scaling:10,shader:"phong"}};f.prototype._ctor=function(){a.prototype._ctor.call(this);
this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};f.prototype.updateVertices=function(b){b&&(this.vertices=b);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=
this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};f.prototype.updateNormals=function(b){b&&(this.normals=b);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};
f.prototype.updateCoords=function(b){b&&(this.coords=b);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};f.prototype.updateIndices=function(b){b&&(this.indices=b);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=
new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=b.length};f.prototype.render=function(b,a){if(this._total){var c=b.shaders[this.shader||"flat"];if(c){b.setModelMatrix(this._global_matrix);var h=this._mesh,e=this._total_indices?this._total_indices:this._total/3;b.enableItemFlags(this);
c.uniforms(b._uniforms).uniforms(this._uniforms).drawRange(h,void 0===this.primitive?GL.TRIANGLES:this.primitive,0,e,this._total_indices?"triangles":null);b.disableItemFlags(this)}}};extendClass(f,a);b.DynamicMeshNode=f;t.prototype._ctor=function(){a.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=b.TOP_LEFT;this.blend_mode=b.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";
this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};Object.defineProperty(t.prototype,"angle",{get:function(){return this._angle},set:function(d){this._angle=d;quat.setAxisAngle(this._rotation,b.FRONT,this._angle*r);this._must_update_matrix=!0},enumerable:!0});t.prototype.setSize=function(b,a){this.size[0]=b;this.size[1]=a};t.createFrames=function(b,a,c){c=c||{};var h;b.constructor!=Number?(num_columns=b[0],h=b[1]):h=
num_columns=b;var e=b=0,f=1/num_columns,r=1/h;h*=num_columns;if(!a){a=[];for(var n=0;n<h;++n)a.push(String(n))}for(n=0;n<a.length&&!(c[a[n]]={pos:[b,e],size:[f,r],normalized:!0},b+=f,1<=b&&(b=0,e+=r),1<=e);++n);return c};t.prototype.createFrames=function(b,a){t.createFrames(b,a,this.frames)};t.prototype.addFrame=function(b,a,c,h,e,f){this.frames[b]={pos:vec2.fromValues(a,c),size:vec2.fromValues(h,e),normalized:!!f}};t.prototype.updateTextureMatrix=function(b){mat3.identity(this.texture_matrix);if(!this.texture)return!1;
var a=b.textures[this.texture];if(!a&&b.autoload_assets){var c=this;-1!=this.texture.indexOf(".")&&b.loadTexture(this.texture,b.default_texture_settings,function(b){b&&0==c.size[0]&&0==c.size[0]&&c.setSize(b.width,b.height)});a=gl.textures.white}if(!a)return!1;b=this.texture_matrix;var h=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!h)return!1;if(!h)return this.flags.flipX&&(z[0]=this.flags.flipX?1:0,z[1]=0,mat3.translate(b,b,z),z[0]=this.flags.flipX?-1:1,z[1]=1,mat3.scale(b,b,
z)),!0;if(h.normalized)z[0]=this.flags.flipX?h.pos[0]+h.size[0]:h.pos[0],z[1]=1-h.pos[1]-h.size[1],mat3.translate(b,b,z),z[0]=h.size[0]*(this.flags.flipX?-1:1),z[1]=h.size[1];else{var e=a.height;z[0]=(this.flags.flipX?h.pos[0]+h.size[0]:h.pos[0])/a.width;z[1]=(e-h.pos[1]-h.size[1])/e;mat3.translate(b,b,z);z[0]=h.size[0]*(this.flags.flipX?-1:1)/a.width;z[1]=h.size[1]/a.height}mat3.scale(b,b,z);return!0};t.prototype.render=function(a,c){if(this.texture&&this.updateTextureMatrix(a)){var h=a.textures[this.texture];
if(h){this.flags.pixelated&&(h.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.billboard_mode&&b.orientNodeToCamera(this.billboard_mode,this,c,a);0==this.size[0]&&!1!==h.ready&&(this.size[0]=h.width);0==this.size[1]&&!1!==h.ready&&(this.size[1]=h.height);var e=this.size,f=0,r=0;v.set(this._global_matrix);var n=!1;
this.current_frame&&this.current_frame.size&&(e=this.current_frame.size,n=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case b.TOP_LEFT:f=0.5;r=-0.5;break;case b.TOP_CENTER:r=-0.5;break;case b.TOP_RIGHT:f=-0.5;break;case b.BOTTOM_LEFT:r=f=0.5;break;case b.BOTTOM_CENTER:r=0.5;break;case b.BOTTOM_RIGHT:f=-0.5,r=0.5}mat4.translate(v,v,[f*h.width*e[0],r*h.height*e[1],0])}n?mat4.scale(v,v,[h.width*e[0],h.height*e[1],1]):mat4.scale(v,v,[this.size[0],this.size[1],1]);a.setModelMatrix(v);
a.renderNode(this,a,c)}}};extendClass(t,a);b.Sprite=t;h.prototype._ctor=function(){this.mesh="cube";this.shader="skybox";this.scaling=[10,10,10];this.flags.depth_test=!1;this.flags.two_sided=!0};h.prototype.render=function(b,a){this.position=a.position;this.updateGlobalMatrix(!0);b.setModelMatrix(this._global_matrix);b.renderNode(this,a)};extendClass(h,a);b.Skybox=h;b.parseTextConfig=function(b){function a(b,d){for(var h=c.shift();h;)if(0==h.trim().length)h=c.shift();else{for(var e=0;"\t"==h[e]&&
e<h.length;)e++;if(e<d)break;var f={children:[]};try{var r=h.trim();-1!=r.indexOf(":")&&(r="{"+r+"}");var n=new Function("return "+r);f.data=n()}catch(q){console.error(q)}e>=d&&(b&&b.children.push(f),h=a(f,e+1))}return h}var c=b.split("\n");b={data:"",children:[]};a(b,0);return b};e.prototype.createShaders=function(){gl._shaders_created&&(this._flat_shader=gl.shaders.flat,this._flat_instancing_shader=gl.shaders.flat_instancing,this._flat_skinning_shader=gl.shaders.flat_skinning,this._point_shader=
gl.shaders.point,this._color_shader=gl.shaders.color,this._texture_shader=gl.shaders.texture,this._texture_albedo_shader=gl.shaders.texture_albedo,this._texture_instancing_shader=gl.shaders.texture_instancing,this._texture_albedo_instancing_shader=gl.shaders.texture_albedo_instancing,b.Skeleton&&(this._texture_skinning_shader=gl.shaders.texture_skinning),this._texture_transform_shader=gl.shaders.texture_transform,this._phong_uniforms={u_ambient:vec3.create(),u_light_vector:vec3.fromValues(0.5442,
0.6385,0.544),u_light_color:b.WHITE},this._phong_shader=gl.shaders.phong,this._phong_shader._uniforms=this._phong_uniforms,this._phong_shader.uniforms(this._phong_uniforms),this._phong_instancing_shader=gl.shaders.phong_instancing,this._phong_instancing_shader._uniforms=this._phong_uniforms,this._phong_instancing_shader.uniforms(this._phong_uniforms),this._textured_phong_shader=gl.shaders.textured_phong,this._textured_phong_shader.uniforms(this._phong_uniforms),this._textured_phong_instancing_shader=
gl.shaders.textured_phong_instancing,this._textured_phong_instancing_shader.uniforms(this._phong_uniforms),this._normal_shader=gl.shaders.normal,this._uvs_shader=gl.shaders.uvs);var a="",c="";b.Skeleton&&(a="\n\t\t#ifdef SKINNING\n\t\t\t"+b.Skeleton.shader_code+"\n\t\t#endif\n\t\t",c="\n\t\t#ifdef SKINNING\n\t\t\tcomputeSkinning(v_pos,v_normal);\n\t\t#endif\n\t\t");a=this._vertex_shader="\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tattribute vec3 a_normal;\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec3 v_pos;\n\t\t\t\tvarying vec3 v_normal;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\t"+
a+"\n\t\t\t\t#ifdef INSTANCING\n\t\t\t\t\tattribute mat4 u_model;\n\t\t\t\t#else\n\t\t\t\t\tuniform mat4 u_model;\n\t\t\t\t#endif\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tvoid main() {\n\t\t\t\t\tv_pos = a_vertex;\n\t\t\t\t\tv_normal = a_normal;\n\t\t\t\t\t"+c+"\n\t\t\t\t\tv_pos = (u_model * vec4(v_pos,1.0)).xyz;\n\t\t\t\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t\t\tgl_PointSize = 2.0;\n\t\t\t\t}\t\t\t\t";
c=this._flat_fragment_shader="\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,c);gl.shaders.flat_instancing=this._flat_instancing_shader=new GL.Shader(a,c,{INSTANCING:""});gl.shaders.flat_skinning=this._flat_skinning_shader=new GL.Shader(a,c,{SKINNING:""});this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t",
"\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=this._color_shader;c="\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\n\t\t#ifdef ALBEDO\n\t\t\tuniform sampler2D u_albedo_texture;\n\t\t#else\n\t\t\tuniform sampler2D u_color_texture;\n\t\t#endif\n\t\tuniform float u_global_alpha_clip;\n\t\tvoid main() {\n\t\t\t#ifdef ALBEDO\n\t\t\t\tvec4 color = u_color * texture2D(u_albedo_texture, v_coord);\n\t\t\t#else\n\t\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\t#endif\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\t\t}\t";
gl.shaders.texture=this._texture_shader=new GL.Shader(a,c);gl.shaders.texture_albedo=this._texture_albedo_shader=new GL.Shader(a,c,{ALBEDO:""});gl.shaders.texture_instancing=this._texture_instancing_shader=new GL.Shader(a,c,{INSTANCING:""});gl.shaders.texture_albedo_instancing=this._texture_albedo_instancing_shader=new GL.Shader(a,c,{ALBEDO:"",INSTANCING:""});b.Skeleton&&(gl.shaders.texture_skinning=this._texture_skinning_shader=new GL.Shader(a,c,{SKINNING:""}));this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_mvp;\n\t\tuniform mat3 u_texture_matrix;\n\t\tvoid main() {\n\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform float u_global_alpha_clip;\n\t\tuniform sampler2D u_color_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w <= u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\t");gl.shaders.texture_transform=this._texture_transform_shader;this._phong_uniforms={u_ambient:vec3.create(),u_light_vector:vec3.fromValues(0.5442,0.6385,
0.544),u_light_color:b.WHITE};c=this._fragment_shader="\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec3 u_ambient;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_vector;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef TEXTURED\n\t\t\t\tuniform sampler2D u_color_texture;\n\t\t\t#endif\n\t\t\t#ifdef UNIFORMS\n\t\t\t\tUNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef TEXTURED\n\t\t\t\t\tcolor *= texture2D( u_color_texture, v_coord );\n\t\t\t\t#endif\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(u_light_vector,N));\n\t\t\t\t#ifdef EXTRA\n\t\t\t\t\tEXTRA\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color * (vec4(u_ambient,1.0) + NdotL * vec4(u_light_color,1.0));\n\t\t\t}\t";
gl.shaders.phong=this._phong_shader=new GL.Shader(a,c);this._phong_shader._uniforms=this._phong_uniforms;this._phong_shader.uniforms(this._phong_uniforms);gl.shaders.phong_instancing=this._phong_instancing_shader=new GL.Shader(a,c,{INSTANCING:""});this._phong_instancing_shader._uniforms=this._phong_uniforms;this._phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.textured_phong=this._textured_phong_shader=new GL.Shader(a,c,{TEXTURED:""});this._textured_phong_shader.uniforms(this._phong_uniforms);
gl.shaders.textured_phong_instancing=this._textured_phong_instancing_shader=new GL.Shader(a,c,{INSTANCING:"",TEXTURED:""});this._textured_phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.normal=this._normal_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4( normalize(v_normal),1.0);\n\t\t\t}\t");gl.shaders.uvs=this._uvs_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(v_coord,0.0,1.0);\n\t\t\t}\t");
gl._shaders_created=!0};b.orientNodeToCamera=function(a,c,h,e){if(a){if(a==b.BILLBOARD_CYLINDRIC||a==b.BILLBOARD_PARALLEL_CYLINDRIC){var f=null;a==b.BILLBOARD_CYLINDRIC?(f=c.getGlobalPosition(x),vec3.sub(u,h._position,f),z[0]=u[0],z[1]=u[2]):(z[0]=h._front[0],z[1]=h._front[2]);a=vec2.computeSignedAngle(z,b.FRONT2D);isNaN(a)||(mat4.rotateY(v,q,-a),c._global_matrix.set(v),mat4.setTranslation(c._global_matrix,c._position),mat4.scale(c._global_matrix,c._global_matrix,c._scale))}else a==b.BILLBOARD_PARALLEL_SPHERIC?
(c._global_matrix.set(h._model_matrix),mat4.setTranslation(c._global_matrix,c._position)):(mat4.lookAt(c._global_matrix,c._position,h.position,b.UP),mat4.invert(c._global_matrix,c._global_matrix)),mat4.scale(c._global_matrix,c._global_matrix,c._scale);e.setModelMatrix(c._global_matrix)}};b.readPixels=function(b,a){var c=new Image;c.src=b;c.onload=function(){var b=document.createElement("canvas");b.width=this.width;b.height=this.height;var d=b.getContext("2d");d.drawImage(this,0,0);b=d.getImageData(0,
0,b.width,b.height);a(b,this)}};b.alignDivToNode=function(b,a,c,h,e,f){function r(b){return 1E-5>Math.abs(b)?0:b}function n(b){return"matrix3d("+r(b[0])+","+r(-b[1])+","+r(b[2])+","+r(b[3])+","+r(b[4])+","+r(-b[5])+","+r(b[6])+","+r(b[7])+","+r(b[8])+","+r(-b[9])+","+r(b[10])+","+r(b[11])+","+r(b[12])+","+r(-b[13])+","+r(b[14])+","+r(b[15])+")"}var q=parseInt(b.clientWidth),s=parseInt(b.clientHeight),l=0.5*q,g=0.5*s,k=e._projection_matrix[5]*g;b.style.width=gl.canvas.width+"px";b.style.height=gl.canvas.height+
"px";b.style.perspective=k+"px";b.style.pointerEvents="none";a&&(b="translateZ("+k+"px) "+n(e._view_matrix)+" translate("+l+"px,"+g+"px)",a.style.transformStyle="preserve-3d",a.style.transform=b,a.style.width=q+"px",a.style.height=s+"px",a.style.pointerEvents="none");h=h.getGlobalMatrix();q=1/c.clientWidth;s=1/c.clientHeight;c.parentNode!=a&&a.appendChild(c);c.style.pointerEvents=f?"auto":"none";c.style.transform=function(b){return"translate(-50%,-50%) "+("matrix3d("+r(b[0])+","+r(b[1])+","+r(b[2])+
","+r(b[3])+","+r(-b[4])+","+r(-b[5])+","+r(-b[6])+","+r(-b[7])+","+r(b[8])+","+r(b[9])+","+r(b[10])+","+r(b[11])+","+r(b[12])+","+r(b[13])+","+r(b[14])+","+r(b[15])+")")}(h)+" scale3D("+q+","+s+",1)"};"undefined"==typeof GL&&(mat4.rotateVec3=function(b,a,c){var h=c[0],e=c[1];c=c[2];b[0]=a[0]*h+a[4]*e+a[8]*c;b[1]=a[1]*h+a[5]*e+a[9]*c;b[2]=a[2]*h+a[6]*e+a[10]*c;return b},mat4.projectVec3=function(b,a,c){var h=c[0],e=c[1];c=c[2];var f=a[1]*h+a[5]*e+a[9]*c+a[13],r=a[2]*h+a[6]*e+a[10]*c+a[14],n=a[3]*
h+a[7]*e+a[11]*c+a[15];b[0]=((a[0]*h+a[4]*e+a[8]*c+a[12])/n+1)/2;b[1]=(f/n+1)/2;b[2]=(r/n+1)/2;return b})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(p){function a(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);
this._meshes={};this._last_point_id=this._accumulated_time=0}function k(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.velocity_variation=
this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function m(){this._ctor()}function g(a){this._ctor();a&&this.configure(a)}extendClass(a,
RD.SceneNode);RD.PointCloud=a;a.prototype.render=function(e,l){if(0!=this.points.length){this.updateVertices();var f=this._meshes[e.gl.context_id];f||(f=new GL.Mesh(void 0,void 0,e.gl),this._vertices_buffer=f.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=f.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=f;this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);f=gl.shaders[this.shader];
f||(f=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(a._vertex_shader,a._pixel_shader));this.draw_range[1]=this.points.length;f=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/f[2]);this._uniforms.u_color=this.color;0<this.num_textures?(this._uniforms.u_texture_info[0]=1/this.num_textures,this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures):this._uniforms.u_texture_info[0]=0;this.ignore_transform&&(mat4.identity(e._model_matrix),e._mvp_matrix.set(e._viewprojection_matrix));
e.renderNode(this,e,l)}};a.prototype.updateVertices=function(a){if(a=this.points.length)for(var l=this._vertices,f=this._extra,g=0,h=this.num_textures*this.num_textures,c=0;c<a;c++){var n=this.points[c];l.set(n.pos?n.pos:n,g);f[g]=1;f[g+1]=1;1<h&&(f[g+2]=n.tex);g+=3}};a._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
a._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(k,RD.SceneNode);RD.ParticlesEmissor=k;k.prototype.update=function(a){var l=this.particles.length,f=this.particles_damping,g=this.particles_acceleration,h=vec3.length(g);if(l){for(var c=[],n=0;n<l;n++){var b=this.particles[n];vec3.scaleAndAdd(b.pos,b.pos,b.vel,a);h&&vec3.scaleAndAdd(b.vel,b.vel,g,a);f&&vec3.scaleAndAdd(b.vel,b.vel,b.vel,-a*f);b.ttl-=a;0<b.ttl&&c.push(b)}this.particles=c}l=this.getGlobalPosition();f=this.emissor_direction;g=this.particles_life;h=this.num_textures*this.num_textures;
c=this.velocity_variation;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),n=0;n<a&&!(this.particles.length>=this.max_particles);n++)f=vec3.clone(f),f[0]+=0.5*Math.random()*c,f[2]+=0.5*Math.random()*c,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*h)/h,pos:vec3.clone(l),vel:f,ttl:g})};k.prototype.render=function(a,g){if(0!=this.particles.length){this.updateVertices();
var f=this._meshes[a.gl.context_id];f||(f=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=f.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=f.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=f;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);f=gl.shaders[this.shader];f||(f=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(k._vertex_shader,k._pixel_shader));
this.draw_range[1]=this.particles.length;f=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/f[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,
g)}};k.prototype.updateVertices=function(a){if(a=this.particles.length)for(var g=this._vertices,f=this._extra,k=0,h=this.particles_life,c=this.num_textures*this.num_textures,n=0;n<a;n++){var b=this.particles[n];g.set(b.pos,k);f[k]=1;f[k+1]=b.ttl/h;1<c&&(f[k+2]=b.tex);k+=3}};k._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
k._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(m,RD.SceneNode);RD.Billboard=m;m.SPHERIC=1;m.PARALLEL_SPHERIC=2;m.CYLINDRIC=3;m.PARALLEL_CYLINDRIC=4;m.prototype._ctor=function(){this.billboard_mode=m.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};m.prototype.render=function(a,g){!1!==this.flags.visible&&(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,g,a),a.renderNode(this,a,g))};g.prototype._ctor=function(){RD.SceneNode.prototype._ctor.call(this);this.size=1;this._atlas_size=vec2.fromValues(1,
1);this.max_sprites=1024;this.positions=new Float32Array(3*this.max_sprites);this.sprite_info=new Float32Array(4*this.max_sprites);this.index=0;this.shader=null;this.use_points=!1;this.mode=g.CYLINDRICAL;this.must_update_buffers=!0};RD.SpritesBatch=g;g.XY=0;g.XZ=1;g.CYLINDRICAL=2;g.SPHERICAL=3;g.FLAT=4;Object.defineProperty(g.prototype,"atlas_size",{get:function(){return this._atlas_size},set:function(a){this._atlas_size.set(a)}});g.prototype.clear=function(){this.index=0};g.prototype.add=function(a,
g,f,k,h){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var c=this.index;this.index+=1;this.positions.set(a,3*c);2==a.length&&(this.positions[3*c+2]=0);a=4*c;this.sprite_info[a]=g||0;this.sprite_info[a+1]=f?1:0;this.sprite_info[a+2]=null==k?1:k;this.sprite_info[a+3]=h||0;this.must_update_buffers=!0}};g.prototype.addData=function(a,g){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var f=this.index;this.index+=
1;this.positions.set(a,3*f);this.sprite_info.set(g,4*f);this.must_update_buffers=!0}};g.prototype.render=function(a,g){if(this.texture){var f=a.textures[this.texture];f&&this.flags.pixelated&&(f.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.renderSprites(f,g,this.size,this.atlas_size,this.color,this.mode)}};g.prototype.renderSprites=
function(a,l,f,k,h,c){if(this.index){var n=gl.shaders[this.shader];n||(n=gl.shaders[this.use_points?"point_sprites":"quad_sprites"]);n||(n=this.use_points?gl.shaders.point_sprites=new GL.Shader(g.point_sprites_vertex_shader,g.point_sprites_fragment_shader):gl.shaders.quad_sprites=new GL.Shader(g.quad_sprites_vertex_shader,g.quad_sprites_fragment_shader));c=c||0;if(this.use_points)n.uniforms(GFX.scene_renderer._uniforms),n.setUniform("u_pointSize",f),n.setUniform("u_atlas",k),n.setUniform("u_texture",
a.bind(0)),RD.renderPoints(this.positions,this.sprite_info,l,this.index,n);else{if(!this.vertex_buffer_data){this.vertex_buffer_data=new Float32Array(12*this.max_sprites);this.extra4_buffer_data=new Float32Array(16*this.max_sprites);for(var b=new Int8Array(8*this.max_sprites),r=new Int8Array([-1,1,1,1,-1,-1,1,-1]),s=0;s<b.length;s+=8)b.set(r,s);for(var r=new Int16Array([0,2,1,1,2,3]),q=new Uint16Array(6*this.max_sprites),s=0;s<q.length;++s)q[s]=r[s%6]+4*Math.floor(s/6);this.vertex_buffer=new GL.Buffer(gl.ARRAY_BUFFER,
this.vertex_buffer_data,3,gl.DYNAMIC_DRAW);this.extra4_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this.extra4_buffer_data,4,gl.DYNAMIC_DRAW);this.extra2_buffer=new GL.Buffer(gl.ARRAY_BUFFER,b,2,gl.STATIC_DRAW);this.indices_buffer=new GL.Buffer(gl.ELEMENT_ARRAY_BUFFER,q,1,gl.STATIC_DRAW)}if(this.must_update_buffers){b=this.vertex_buffer_data;r=this.extra4_buffer_data;q=Math.min(this.index,this.positions.length/3);for(s=0;s<q;++s){var A=3*s,m=this.positions.subarray(A,A+3);b.set(m,4*A);b.set(m,4*A+3);b.set(m,
4*A+6);b.set(m,4*A+9);A=4*s;m=this.sprite_info.subarray(A,A+4);r.set(m,4*A);r.set(m,4*A+4);r.set(m,4*A+8);r.set(m,4*A+12)}this.vertex_buffer.uploadRange(0,48*this.index);this.extra4_buffer.uploadRange(0,64*this.index);this.must_update_buffers=!1}s=a.width/k[0]/(a.height/k[1]);b=RD.UP;r=RD.RIGHT;switch(c){case RD.SpritesBatch.SPHERICAL:b=l.getLocalVector(RD.UP);case RD.SpritesBatch.CYLINDRICAL:r=l.getLocalVector(RD.RIGHT);break;case RD.SpritesBatch.FLAT:b=l.getLocalVector(RD.FRONT);r=l.getLocalVector(RD.RIGHT);
break;case RD.SpritesBatch.XZ:b=RD.FRONT}n.bind();n.setUniform("u_model",RD.IDENTITY);n.setUniform("u_viewprojection",l._viewprojection_matrix);n.setUniform("u_color",h||RD.ONES4);n.setUniform("u_size",[f,f/s]);n.setUniform("u_top",b);n.setUniform("u_right",r);n.setUniform("u_atlas",k);n.setUniform("u_texture",a.bind(0));n.setUniform("u_itexsize",[1/a.width,1/a.height]);n.setUniform("u_viewport",gl.viewport_data);a=n.attributes.a_vertex;l=n.attributes.a_extra4;n=n.attributes.a_extra2;this.vertex_buffer.bind(a);
this.extra4_buffer.bind(l);this.extra2_buffer.bind(n);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer.buffer);gl.drawElements(gl.TRIANGLES,6*this.index,gl.UNSIGNED_SHORT,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.vertex_buffer.unbind(a);this.extra4_buffer.unbind(l);this.extra2_buffer.unbind(n)}}};extendClass(g,RD.SceneNode);g.quad_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4; //frame,flipx,scale,extranum\nattribute vec2 a_extra2;//expanse direction\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec2 u_size;\nuniform vec3 u_top;\nuniform vec3 u_right;\nuniform vec4 u_color;\nuniform vec2 u_atlas;\nuniform vec2 u_itexsize;\n\nvoid main() {\n\tvec3 vertex = a_vertex + a_extra4.z * u_size.y * u_top * a_extra2.y + a_extra4.z * u_size.x * u_right * a_extra2.x;\n\tvec2 uv = a_extra2;\n\tif( a_extra4.y != 0.0) //flip X\n\t\tuv.x *= -1.0;\n\tuv.x *= 1.0 - u_itexsize.x;\n\tuv.y *= -1.0;\n\tuv = uv * 0.5 + vec2(0.5);\n\t\n\tvec2 i_atlas = vec2(1.0) / u_atlas; \n\tfloat frame = a_extra4.x;\n\tfloat frame_x = mod( frame, u_atlas.x );\n\tfloat frame_y = floor( frame * i_atlas.x );\n\tuv.x = (uv.x + frame_x) * i_atlas.x;\n\tuv.y += frame_y;\n\tuv.y = 1.0 - uv.y * i_atlas.y;\n\tv_uv = uv;\n\tv_pos = (u_model * vec4(vertex,1.0)).xyz;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\t//gl_Position.x = floor(gl_Position.x * u_viewport.z * 1.0) / (u_viewport.z * 1.0);\n\t//gl_Position.y = floor(gl_Position.y * u_viewport.w * 1.0) / (u_viewport.w * 1.0);\n}\n\n";
g.quad_sprites_fragment_shader="\nprecision highp float;\nprecision mediump int;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n\tvec4 color = texture2D( u_texture, v_uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tcolor *= u_color;\n\tgl_FragColor = color;\n}\n";g.point_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_mvp;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tvec3 vertex = a_vertex;\t\n\tv_pos = vertex;\n\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_mvp * vec4(vertex,1.0);\n\tgl_Position.x = floor(gl_Position.x * u_viewport.z) / u_viewport.z;\n\tgl_Position.y = floor(gl_Position.y * u_viewport.w) / u_viewport.w;\n\tgl_PointSize = computePointSize( u_pointSize * u_extra4.z, gl_Position.w );\n}\n";
g.point_sprites_fragment_shader="\nprecision highp float;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4; //id,flip,scale,extra\nuniform float u_atlas;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\tfloat i_atlas = 1.0 / u_atlas;\n\tfloat frame = v_extra4.x;\n\tfloat x = frame * i_atlas;\n\tfloat y = floor(x);\n\tx = (x - y);\n\ty = y / u_atlas;\n\tif( v_extra4.y > 0.0 ) //must flip in x\n\t\tx -= gl_PointCoord.x * i_atlas - i_atlas;\n\telse\n\t\tx += gl_PointCoord.x * i_atlas;\n\t\n\tvec2 uv = vec2( x, 1.0 - (y + gl_PointCoord.y / u_atlas) );\n\tvec4 color = texture2D( u_texture, uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tgl_FragColor = color;\n}\n"})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
(function(p){function a(b){this._ctor();b&&this.configure(b);this.render_priority=0;this.targets=null;this.size=150;this.mode=a.DEFAULT;this.coordinates=a.WORLD_SPACE;this.layers=255;this.grid_size=0;this.render_move_plane=this.allow_duplicating=!0;this.shader="flat";this._last=vec3.create();this.onDuplicateTargets=this.onActionFinished=null;b={x:a.XAXIS_COLOR,y:a.YAXIS_COLOR,z:a.ZAXIS_COLOR};var c="drag movex movey movez movexy movexz moveyz scalex scaley scalez scalexy scaleyz scalexz rotatex rotatey rotatez rotatefront rotate scale".split(" ");this.actions=
{};for(var h in c){var e=c[h],f={mask:255,pos:vec3.create(),pos2D:vec3.create(),radius:0.15,visible:!1,flag:a[e.toUpperCase()]};0==e.indexOf("move")&&(f.move=!0);0==e.indexOf("rotate")&&(f.rotate=!0);0==e.indexOf("scale")&&(f.scale=!0);f.color=b[e[e.length-1]];if(f.move||f.rotate)f.cursor="crosshair";this.actions[e]=f}this.actions.scalex.axis=this.actions.rotatex.axis=this.actions.movex.axis=vec3.fromValues(1,0,0);this.actions.scaley.axis=this.actions.rotatey.axis=this.actions.movey.axis=vec3.fromValues(0,
1,0);this.actions.scalez.axis=this.actions.rotatez.axis=this.actions.movez.axis=vec3.fromValues(0,0,1);this.actions.movexy.normal=this.actions.scalexy.normal=vec3.fromValues(0,0,1);this.actions.movexz.normal=this.actions.scalexz.normal=vec3.fromValues(0,1,0);this.actions.moveyz.normal=this.actions.scaleyz.normal=vec3.fromValues(1,0,0);this.actions.movexy.radius=this.actions.movexz.radius=this.actions.moveyz.radius=0.1;this.actions.scalexy.radius=this.actions.scalexz.radius=this.actions.scaleyz.radius=
0.1;this.actions.drag.cursor="move";this.actions.scale.cursor="row-resize";this.click_model=mat4.create();this.click_transform=new Float32Array(10);this.click_pos=vec3.create();this.click_2D=vec3.create();this.click_2D2=vec3.create();this.click_2D_norm=vec3.create();this.center_2D=vec3.create();this.click_dist=1}a.MOVEX=1;a.MOVEY=2;a.MOVEZ=4;a.MOVEXY=8;a.MOVEXZ=16;a.MOVEYZ=32;a.ROTATEX=64;a.ROTATEY=128;a.ROTATEZ=256;a.SCALEX=512;a.SCALEY=1024;a.SCALEZ=2048;a.SCALEXY=4096;a.SCALEYZ=8192;a.SCALEXZ=
16384;a.SCALE=32768;a.DRAG=65536;a.ROTATE=131072;a.ROTATEFRONT=262144;a.MOVEAXIS=a.MOVEX|a.MOVEY|a.MOVEZ;a.MOVEPLANAR=a.MOVEXY|a.MOVEXZ|a.MOVEYZ;a.MOVEALL=a.DRAG|a.MOVEAXIS|a.MOVEPLANAR;a.PLANAR=a.MOVEX|a.MOVEZ|a.MOVEXZ|a.ROTATEY|a.SCALE;a.ROTATEALL=a.ROTATEX|a.ROTATEY|a.ROTATEZ|a.ROTATEFRONT;a.SCALEALL=a.SCALE|a.SCALEX|a.SCALEY|a.SCALEZ|a.SCALEXY|a.SCALEYZ|a.SCALEXZ;a.MOVEROTATESCALE=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALE;a.ALL=a.MOVEAXIS|a.MOVEPLANAR|a.ROTATEALL|a.SCALEALL;a.DEFAULT=a.PLANAR;
a.OBJECT_SPACE=1;a.WORLD_SPACE=2;p=mat4.create();var k=mat4.create(),m=mat4.create();mat4.create();mat4.create();mat4.create();var g=mat4.create(),e=mat4.create();mat4.create();var l=vec3.create(),f=vec3.create(),t=vec3.create(),h=vec4.create();vec4.create();mat4.translate(p,p,[1.1,0,0]);mat4.rotate(p,p,90*DEG2RAD,[0,0,-1]);mat4.translate(k,k,[0,1.1,0]);mat4.translate(m,m,[0,0,1.1]);mat4.rotate(m,m,90*DEG2RAD,[1,0,0]);p=mat4.create();mat4.scale(p,p,[-1,-1,-1]);a.full_viewport=null;var c=mat4.create(),
n=mat4.create();a.XAXIS_COLOR=[0.901,0.247,0.349,1];a.YAXIS_COLOR=[0.55,0.81,0.11,1];a.ZAXIS_COLOR=[0.23,0.57,0.93,1];a.XYAXIS_COLOR=[0.9,0.7,0.23,0.75];a.XZAXIS_COLOR=[0.6,0.4,0.7,0.75];a.YZAXIS_COLOR=[0.39,0.69,0.52,0.75];a.SPHERE_COLOR=[0.8,0.8,0.8,0.4];a.RING_COLOR=[0.5,0.5,0.5,1];a.INNERSPHERE_COLOR=[0.6,0.6,0.6,1];a.SELECTED_COLOR=[1,1,1,1];a.NOAXIS_COLOR=[0.901,0.247,0.749,1];a.STATIC_SPHERE_COLOR=[0.1,0.1,0.1,0.3];a.prototype.isTarget=function(b){return-1!=this.targets.indexOf(b)};a.prototype.setTargets=
function(b,a){if(b&&b.constructor!==Array)throw"nodes must be an Array";b&&0!=b.length?(a&&this.targets&&(b=this.targets.concat(b)),this.targets=b=b.filter(function(a,c){return b.indexOf(a)===c}),this.resetTransform(),this.position=this.computeCenter(this.targets)):a||(this.targets=null)};a.prototype.computeCenter=function(b){if((b=b||this.targets)&&b.length){for(var a=null,c=0;c<b.length;++c){var h=b[c];h.layers&this.layers&&(h=h.getGlobalPosition(),a?vec3.add(a,a,h):a=h)}if(!a)return[0,0,0];vec3.scale(a,
a,1/b.length);return a}};a.prototype.updateGizmo=function(){this.targets&&(0==this.targets.length?this.transform=this.targets[0].transform:(this.resetTransform(),1==this.targets.length&&this.coordinates==RD.Gizmo.OBJECT_SPACE?(this.transform=this.targets[0].transform,this.scaling=[1,1,1]):this.position=this.computeCenter(this.targets)))};a.prototype.updateTargets=function(){if(this.targets)for(var b=this.getGlobalMatrix(mat4.create()),a=0;a<this.targets.length;++a){var c=this.targets[a];c.layers&
this.layers&&c.fromMatrix(b,!0)}};a.prototype.saveTargetTransforms=function(){if(this.targets){this.target_tranforms=[];for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(this.target_tranforms[b]=new Float32Array(a.transform))}}};a.prototype.restoreTargetTransforms=function(){if(this.target_tranforms&&this.targets&&this.target_tranforms.length==this.targets.length)for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&(a.transform=this.target_tranforms[b])}};
a.prototype.removeTargetsFromScene=function(){if(this.targets){for(var b=0;b<this.targets.length;++b){var a=this.targets[b];a.layers&this.layers&&a.parentNode&&a.parentNode.removeChild(a)}this.targets=null}};a.prototype.getTargetBaseNodes=function(){function b(a){return-1!=c.indexOf(a)?!0:a.parentNode?b(a.parentNode):!1}if(!this.targets||!this.targets.length)return null;for(var a=[],c=this.targets,h=0;h<c.length;++h){var e=c[h];e.layers&this.layers&&(b(e.parentNode)||a.push(e))}return a};a.prototype.applyTransformToTarget=
function(b,c){var h=this.getGlobalMatrix(mat4.create()),e=mat4.invert(mat4.create(),h),f=mat4.create(),n=this.getTargetBaseNodes();if(n){for(var g=[1,1,1],l=0;l<n.length;++l){var k=n[l];g[0]=0<=k.scaling[0]?1:-1;g[1]=0<=k.scaling[1]?1:-1;g[2]=0<=k.scaling[2]?1:-1;c?(mat4.multiply(f,b,k.matrix),k.fromMatrix(f)):(k.getGlobalMatrix(f),this.coordinates==a.WORLD_SPACE&&mat4.multiply(f,e,f),mat4.multiply(f,b,f),this.coordinates==a.WORLD_SPACE&&mat4.multiply(f,h,f),k.fromMatrix(f,!0));vec3.mul(k._scale,
k._scale,g);k.position=this.applySnap(k.position);if(this.grid_size){var m=quat.toEuler(vec3.create(),k.rotation);m[0]=15*Math.round(m[0]*RAD2DEG/15)*DEG2RAD;m[1]=15*Math.round(m[1]*RAD2DEG/15)*DEG2RAD;m[2]=15*Math.round(m[2]*RAD2DEG/15)*DEG2RAD;quat.fromEuler(k.rotation,m);quat.normalize(k.rotation,k.rotation)}}mat4.multiply(f,h,b);this.fromMatrix(f);this.scaling=[1,1,1];this.updateGizmo()}};a.prototype.applyTranslation=function(b,a){var c=mat4.create();mat4.translate(c,c,b);this.applyTransformToTarget(c,
a)};a.prototype.applyRotation=function(b,a,c){var h=mat4.create();if(c){var e=mat4.create();mat4.setTranslation(e,c);mat4.mul(h,h,e);mat4.rotate(h,h,b,a);mat4.setTranslation(e,[-c[0],-c[1],-c[2]]);mat4.mul(h,h,e)}else mat4.rotate(h,h,b,a);this.applyTransformToTarget(h)};a.prototype.applyScale=function(b,a){b.constructor===Number&&(b=[b,b,b]);var c=mat4.create();mat4.scale(c,c,b);this.applyTransformToTarget(c,a)};a.prototype.applySnap=function(b){if(!this.grid_size)return b;b[0]=Math.round(b[0]/this.grid_size)*
this.grid_size;b[1]=Math.round(b[1]/this.grid_size)*this.grid_size;b[2]=Math.round(b[2]/this.grid_size)*this.grid_size;return b};a.prototype.setColor=function(b){if(this.targets)for(var a=0;a<this.targets.length;++a){var c=this.targets[a];c.layers&this.layers&&(c.color=b)}};a.prototype.cloneTargets=function(){if(this.allow_duplicating&&(!this.onDuplicateTargets||!this.onDuplicateTargets(this.targets))){for(var b=[],a=0;a<this.targets.length;++a){var c=this.targets[a];if(c.layers&this.layers){var h=
c.clone(!0);c.parentNode.addChild(h);b.push(c)}}return this.targets=b}};a.prototype.onMouse=function(b){if(this._camera&&this.targets&&!1!==this.visible){var c=this._camera,h=c.getFront(),e=[b.canvasx,b.canvasy],f=c.getRay(e[0],e[1]),n=this.position,g=vec3.sub(vec3.create(),n,c.position);vec3.normalize(g,g);var k=this._selected_action,l=this.actions[k],m=this._global_matrix;c.project(n,null,this.center_2D);var p=mat4.invert(mat4.create(),m),t=this.coordinates==a.OBJECT_SPACE;if("mousedown"==b.type){if(this.click_2D[0]=
this.click_2D2[0]=e[0],this.click_2D[1]=this.click_2D2[0]=e[1],b.is_touch&&this.testMouseOver(b),k=this._selected_action=this._hover_action,l=this.actions[k])l.move&&l.axis?(p=vec3.clone(l.axis),mat4.rotateVec3(p,m,p),vec3.normalize(p,p),this._last=f.closestPointOnRay(n,p),b.shiftKey&&this.cloneTargets()):l.move&&l.normal&&(f.testPlane(n,l.normal)&&(this.click_pos=f.collision_point),b.shiftKey&&this.cloneTargets()),"drag"==k&&(f.testPlane(n,h),this._last=f.collision_point,b.shiftKey&&this.cloneTargets()),
"rotatefront"==k?(vec2.sub(this.click_2D,this.click_2D,this.center_2D),vec2.normalize(this.click_2D,this.click_2D),this.click_2D_norm.set(this.click_2D),vec2.scaleAndAdd(this.click_2D,this.center_2D,this.click_2D,0.5*this.size),this.click_2D2.set(this.click_2D)):l.rotate&&(l.axis?(k=mat4.rotateVec3(vec3.create(),m,l.axis),f.testPlane(n,k)&&(vec3.sub(this.click_pos,f.collision_point,n),vec3.normalize(this.click_pos,this.click_pos),n=vec3.scaleAndAdd(vec3.create(),n,this.click_pos,this.current_size),
this.current_2D=this.click_2D=c.project(n))):f.testSphere(n,this.current_size)&&(this._last=f.collision_point,vec3.sub(this.click_pos,f.collision_point,n),vec3.normalize(this.click_pos,this.click_pos),this.click_axis=vec3.cross(this.click_axis||vec3.create(),g,this.click_pos))),this.click_model.set(m),this.click_transform.set(this.transform),this.click_dist=vec3.distance(this.click_2D,this.center_2D),this.saveTargetTransforms()}else if("mousemove"==b.type)if(b.dragging&&this._selected_action){if("rotatefront"==
k)return n=vec2.sub(vec3.create(),e,this.center_2D),vec2.normalize(n,n),l=this.click_2D_norm,vec2.scaleAndAdd(this.click_2D2,this.center_2D,n,0.5*this.size),n=Math.atan2(n[0],n[1]),l=Math.atan2(l[0],l[1]),n-=l,b.shiftKey&&(n=2*Math.PI*Math.ceil(36*n/(2*Math.PI))/36),n&&(this.restoreTargetTransforms(),this.applyRotation(n,g)),!0;if(l.rotate)return l.axis?(k=mat4.rotateVec3(vec3.create(),m,l.axis),f.testPlane(n,k)&&(b=vec3.sub(vec3.create(),f.collision_point,n),vec3.normalize(b,b),n=vec3.scaleAndAdd(vec3.create(),
n,b,this.current_size),this.current_2D=c.project(n),c=Math.clamp(vec3.dot(b,this.click_pos),-1,1),n=Math.acos(c),b=vec3.cross(vec3.create(),b,this.click_pos),vec3.normalize(b,b),c=vec3.dot(k,b),0<c&&(n*=-1),this.restoreTargetTransforms(),this.applyRotation(n,l.axis))):(p=vec3.cross(vec3.create(),g,this.click_pos),n=0.01*(vec2.dist(this.center_2D,e)-this.click_dist),b=vec2.sub(vec2.create(),this.center_2D,e),l=vec2.sub(vec2.create(),this.center_2D,this.click_2D),0>vec2.dot(b,l)&&(n=-n),console.log(n),
this.restoreTargetTransforms(),this.applyRotation(n,p),this.click_axis=p),!0;g=null;if(l.move&&l.normal){if(f.testPlane(n,l.normal)&&(l=f.collision_point,this.applySnap(l),g=vec3.sub(vec3.create(),l,this.click_pos),this.click_pos=l,this.coordinates==a.OBJECT_SPACE))return mat4.rotateVec3(g,p,g),this.applyTranslation(g,!0),!0}else if(l.move||l.scale){c=null;l.axis&&(p=vec3.clone(l.axis),mat4.rotateVec3(p,m,p),vec3.normalize(p,p),c=f.closestPointOnRay(n,p));if("scale"==k||l.scale&&b.ctrlKey)return b=
1+0.01*(e[1]-this.click_2D[1]),this.applyScale(b,t),this.click_2D[0]=e[0],this.click_2D[1]=e[1],!0;if("scalexy"==k||"scalexz"==k||"scaleyz"==k){b=1+0.01*(e[1]-this.click_2D[1]);switch(k){case "scalexy":this.applyScale([b,b,1],t);break;case "scaleyz":this.applyScale([1,b,b],t);break;case "scalexz":this.applyScale([b,1,b],t)}this.click_2D[0]=e[0];this.click_2D[1]=e[1];return!0}if(l.scale)return b=vec2.distance(e,this.center_2D),l=b/this.click_dist,"scalex"==k?this.applyScale([l,1,1],t):"scaley"==k?
this.applyScale([1,l,1],t):"scalez"==k&&this.applyScale([1,1,l],t),this.click_dist=b,!0;l.move&&(t||this.applySnap(c),g=vec3.sub(vec3.create(),c,this._last),this._last.set(c))}"drag"==k&&(f.testPlane(n,this._camera.getFront()),c=f.collision_point,this.applySnap(c),g=vec3.sub(vec3.create(),c,this._last),this._last=c);if(g)return this.applyTranslation(g),!0}else this.testMouseOver(b);else if("wheel"==b.type){if("scale"==this._selected_action)return b=1+2E-4*b.wheel,this.applyScale(b),!0;if("drag"==
this._selected_action)return g=vec3.sub(vec3.create(),n,c.position),b=1+2E-4*b.wheel,vec3.scaleAndAdd(g,c.position,g,b),vec3.sub(g,g,n),this.applyTranslation(g),this._last=n,!0}if("mouseup"==b.type||this._selected_action&&0==b.buttons)if(this.saveTargetTransforms(),this._selected_action){this._selected_action=null;this.render(this._last_renderer,this._last_camera);this.testMouseOver(b);this.updateGizmo();if(this.onActionFinished)this.onActionFinished();return!0}return!1}};a.prototype.testMouseOver=
function(b){this._hover_action=null;var c=[b.canvasx,b.canvasy],h=1E5;b=null;for(var e in this.actions){var f=this.actions[e];if(f.visible){var n=vec2.distance(f.pos2D,c);n<f.radius*this.size&&n<h&&(h=n,b=e)}}b||(e=vec2.distance(this.center_2D,c),this.actions.rotatefront.visible&&10>Math.abs(e-0.5*this.size)?b="rotatefront":this.mode&a.ROTATE&&e<0.5*this.size&&(b="rotate"));return this._hover_action=b};a.prototype.cancel=function(){this._selected_action&&(this._selected_action=null,this.restoreTargetTransforms())};
a.prototype.render=function(b,n){this._last_renderer=b;this._last_camera=n;for(var k in this.actions)this.actions[k].visible=!1;if(this.targets&&this.targets.length&&!1!==this.visible){gl.meshes.cone||(gl.meshes.circle=GL.Mesh.circle({radius:1}),gl.meshes.cylinder=GL.Mesh.cylinder({radius:0.02,height:1}),gl.meshes.cone=GL.Mesh.cone({radius:0.1,height:0.25}),gl.meshes.torus=GL.Mesh.torus({outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.quartertorus=GL.Mesh.torus({angle:0.5*
Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}),gl.meshes.halftorus=GL.Mesh.torus({angle:Math.PI,outerradius:1,innerradius:0.02,outerslices:64,innerslices:8}));k=gl.meshes.torus;var q=n.getFront(),m=n.getLocalVector(RD.UP);n.getLocalVector(RD.RIGHT);var p=this._position;h.set(p);h[3]=1;var z=n._projection_matrix[5];this.updateMatrices();g.set(this._global_matrix);var u=vec3.sub(vec3.create(),p,n.position);vec3.normalize(u,u);this._camera=n;this._unitary_model=g;var x=this._hover_action,
y=this._selected_action;y&&(x=y);var B=y?this.actions[y]:null,w=this.mode;mat4.rotateVec3(f,g,RD.RIGHT);mat4.rotateVec3(t,g,RD.UP);mat4.rotateVec3(l,g,RD.FRONT);vec3.normalize(f,f);vec3.normalize(t,t);vec3.normalize(l,l);mat4.fromTranslationFrontTop(e,p,q,m);vec4.transformMat4(h,h,n._viewprojection_matrix);this.current_size=m=gl.canvas.width/gl.canvas.height*this.size*h[3]/(gl.canvas.width*z);mat4.scale(g,g,[m,m,m]);mat4.scale(e,e,[m,m,m]);var m=vec3.dot(u,f),z=vec3.dot(u,t),D=vec3.dot(u,l),E=vec3.dot(q,
RD.RIGHT),d=vec3.dot(q,RD.UP),C=vec3.dot(q,RD.FRONT);this._camera.project(p,[0,0,gl.canvas.width,gl.canvas.height],this.center_2D);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);u=gl.shaders[this.shader];u.uniforms(b._uniforms);u.uniforms(n.uniforms);u.uniforms(this.uniforms);if("movex"==y)mat4.rotateZ(c,g,-Math.PI/2),this.drawAxis(c,a.XAXIS_COLOR);else if("movey"==y)this.drawAxis(g,a.YAXIS_COLOR);else if("movez"==y)mat4.rotateX(c,
g,-Math.PI/2),this.drawAxis(c,a.ZAXIS_COLOR);else if("drag"==y)b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0);else if(B&&B.normal&&this.render_move_plane)c.set(g),"movexz"==y?mat4.rotateX(c,c,Math.PI/2):"moveyz"==y&&mat4.rotateY(c,c,Math.PI/2),mat4.scale(c,c,[100,100,100]),u.setUniform("u_model",c),u.setUniform("u_color",[0.1,0.1,0.1,0.4]),gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),u.draw(gl.meshes.plane),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);else{if("rotatefront"==
y)mat4.rotateX(c,e,Math.PI/2),u.setUniform("u_model",c),u.draw(k),b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.click_2D2[0],this.click_2D2[1],2,a.XAXIS_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,a.XAXIS_COLOR,!0),b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR),b.drawLine2D(this.click_2D2[0],this.click_2D2[1],this.center_2D[0],this.center_2D[1],4,a.XAXIS_COLOR);else{if("rotate"==y){this.click_axis&&
(mat4.fromTranslationFrontTop(c,p,q,this.click_axis),mat4.scale(c,c,[this.current_size,this.current_size,this.current_size]),this.drawAxis(c,a.NOAXIS_COLOR));this.drawRotateSphere(g,a.SPHERE_COLOR);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,a.NOAXIS_COLOR,!0);return}if(B&&B.rotate){q=B.color||a.XAXIS_COLOR;"rotatex"==y?mat4.rotateZ(c,g,Math.PI/2):"rotatey"==y?mat4.rotateY(c,g,Math.PI/2):"rotatez"==y&&mat4.rotateX(c,g,Math.PI/2);u.setUniform("u_model",c);u.setUniform("u_color",q);u.draw(k);
b.drawCircle2D(this.center_2D[0],this.center_2D[1],2,q,!0);b.drawCircle2D(this.click_2D[0],this.click_2D[1],2,q,!0);b.drawLine2D(this.click_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,q);b.drawCircle2D(this.current_2D[0],this.current_2D[1],2,q,!0);b.drawLine2D(this.current_2D[0],this.current_2D[1],this.center_2D[0],this.center_2D[1],4,q);return}}"scale"==y?(b.drawCircle2D(this.center_2D[0],this.click_2D[1],2,a.INNERSPHERE_COLOR,!0),b.drawCircle2D(this.center_2D[0],this.center_2D[1],
2,a.INNERSPHERE_COLOR,!0),b.drawLine2D(this.center_2D[0],this.click_2D[1],this.center_2D[0],this.center_2D[1],4,a.INNERSPHERE_COLOR)):(this.drawRotateSphere(g,a.STATIC_SPHERE_COLOR),w&a.ROTATE&&"rotate"==x&&this.drawRotateSphere(g,a.SPHERE_COLOR),w&a.ROTATEFRONT&&(mat4.rotateX(c,e,Math.PI/2),u.setUniform("u_model",c),u.setUniform("u_color","rotatefront"==x?a.SELECTED_COLOR:a.RING_COLOR),u.draw(k),this.actions.rotatefront.visible=!0),0.1<Math.abs(m)&&w&a.ROTATEX&&(mat4.rotateZ(c,g,Math.PI/2),0>C&&
mat4.rotateX(c,c,Math.PI),0>d&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatex"==x?a.SELECTED_COLOR:a.XAXIS_COLOR,"rotatex")),0.1<Math.abs(z)&&w&a.ROTATEY&&(c.set(g),0<E&&0>C?mat4.rotateY(c,c,-Math.PI/2):0>E&&0>C?mat4.rotateY(c,c,Math.PI):0>E&&0<C&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatey"==x?a.SELECTED_COLOR:a.YAXIS_COLOR,"rotatey")),0.1<Math.abs(D)&&w&a.ROTATEZ&&(c.set(g),mat4.rotateX(c,c,Math.PI/2),0<E&&0>d?mat4.rotateY(c,c,-Math.PI/2):0>E&&0>d?mat4.rotateY(c,c,Math.PI):
0>E&&0<d&&mat4.rotateY(c,c,Math.PI/2),this.drawRotator(c,"rotatez"==x?a.SELECTED_COLOR:a.ZAXIS_COLOR,"rotatez")),0.95>Math.abs(m)&&(mat4.rotateZ(c,g,0>E?-Math.PI/2:Math.PI/2),w&a.MOVEX&&this.drawArrow(c,"movex"==x?a.SELECTED_COLOR:a.XAXIS_COLOR,"movex"),w&a.SCALEX&&this.drawScale(c,"scalex"==x?a.SELECTED_COLOR:a.XAXIS_COLOR,"scalex")),0.95>Math.abs(z)&&(0<d?mat4.rotateZ(c,g,Math.PI):c.set(g),w&a.MOVEY&&this.drawArrow(c,"movey"==x?a.SELECTED_COLOR:a.YAXIS_COLOR,"movey"),w&a.SCALEY&&this.drawScale(c,
"scaley"==x?a.SELECTED_COLOR:a.YAXIS_COLOR,"scaley")),0.95>Math.abs(D)&&(mat4.rotateX(c,g,0>C?-Math.PI/2:Math.PI/2),w&a.MOVEZ&&this.drawArrow(c,"movez"==x?a.SELECTED_COLOR:a.ZAXIS_COLOR,"movez"),w&a.SCALEZ&&this.drawScale(c,"scalez"==x?a.SELECTED_COLOR:a.ZAXIS_COLOR,"scalez")),0.2<Math.abs(D)&&(w&a.MOVEXY||w&a.SCALEXY)&&(mat4.translate(c,g,[0.45*(0>m?1:-1),0.45*(0>z?1:-1),0]),w&a.MOVEXY?this.drawFlat(c,"movexy"==x?a.SELECTED_COLOR:a.XYAXIS_COLOR,"movexy"):this.drawFlat(c,"scalexy"==x?a.SELECTED_COLOR:
a.XYAXIS_COLOR,"scalexy","circle")),0.2<Math.abs(z)&&(w&a.MOVEXZ||w&a.SCALEXZ)&&(mat4.rotateX(c,g,Math.PI/2),mat4.translate(c,c,[0.45*(0>m?1:-1),0.45*(0>D?-1:1),0]),w&a.MOVEXZ?this.drawFlat(c,"movexz"==x?a.SELECTED_COLOR:a.XZAXIS_COLOR,"movexz"):this.drawFlat(c,"scalexz"==x?a.SELECTED_COLOR:a.XZAXIS_COLOR,"scalexz","circle")),0.2<Math.abs(m)&&(w&a.MOVEYZ||w&a.SCALEYZ)&&(mat4.rotateY(c,g,Math.PI/2),mat4.translate(c,c,[0.45*(0>D?1:-1),0.45*(0>z?1:-1),0]),w&a.MOVEYZ?this.drawFlat(c,"moveyz"==x?a.SELECTED_COLOR:
a.YZAXIS_COLOR,"moveyz"):this.drawFlat(c,"scaleyz"==x?a.SELECTED_COLOR:a.YZAXIS_COLOR,"scaleyz","circle")),w&a.DRAG&&this.drawInnerSphere(g,"drag"),w&a.SCALE&&this.drawInnerSphere(g,"scale"),gl.enable(gl.DEPTH_TEST))}}};a.prototype.drawArrow=function(b,c,h){var e=gl.shaders[this.shader],f=gl.meshes.cone,g=gl.meshes.cylinder,l=this._hover_action;mat4.translate(n,b,[0,1.1,0]);e.setUniform("u_model",n);e.setUniform("u_color",l==h?a.SELECTED_COLOR:c);e.draw(f);this.mode==a.MOVEALL?(mat4.translate(n,n,
[0,-0.4,0]),mat4.scale(n,n,[1,1,1])):(mat4.translate(n,n,[0,-0.15,0]),mat4.scale(n,n,[1,0.5,1]));e.setUniform("u_model",n);e.draw(g);this.toScreen(n,h,[0,0.6,0])};a.prototype.drawAxis=function(b,a){var c=gl.shaders[this.shader],h=gl.meshes.sphere;mat4.scale(n,b,[0.01,100,0.01]);c.setUniform("u_model",n);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthMask(!1);c.setUniform("u_color",[a[0],a[1],a[2],0.2]);gl.depthFunc(gl.GREATER);c.draw(h);gl.depthFunc(gl.LESS);
gl.disable(gl.BLEND);c.setUniform("u_color",a);c.draw(h);gl.depthMask(!0);gl.disable(gl.DEPTH_TEST);this.drawInnerSphere(b)};a.prototype.drawFlat=function(b,a,h,e){e=gl.meshes[e||"plane"];var f=gl.shaders[this.shader];mat4.scale(c,b,[0.25,0.25,0.25]);f.setUniform("u_color",a);f.setUniform("u_model",c);gl.enable(gl.BLEND);f.draw(e);gl.disable(gl.BLEND);this.toScreen(c,h)};a.prototype.drawRotator=function(b,a,h){var e=gl.meshes.quartertorus,f=gl.shaders[this.shader];mat4.scale(c,b,[0.9,0.9,0.9]);f.setUniform("u_color",
a);f.setUniform("u_model",c);f.draw(e);this.toScreen(c,h,[-0.75,0,0.75])};a.prototype.drawScale=function(b,h,e){var f=gl.meshes.cylinder,n=gl.meshes.sphere,g=gl.shaders[this.shader];g.setUniform("u_color",h);this.mode==a.SCALEALL?(mat4.translate(c,b,[0,0.5,0]),mat4.scale(c,c,[1,1,1])):(mat4.translate(c,b,[0,0.25,0]),mat4.scale(c,c,[1,0.5,1]));g.setUniform("u_model",c);g.draw(f);mat4.translate(c,b,[0,0.4,0]);this.mode==a.SCALEALL?mat4.scale(c,c,[0.1,0.1,0.1]):mat4.scale(c,c,[0.1,0.2,0.1]);g.setUniform("u_model",
c);g.draw(n);this.toScreen(c,e)};a.prototype.drawRotateSphere=function(b,a){var h=gl.shaders[this.shader],e=gl.meshes.sphere;gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);mat4.scale(c,b,[0.9,0.9,0.9]);h.setUniform("u_model",c);h.setUniform("u_color",a);h.draw(e);gl.disable(gl.BLEND)};a.prototype.drawInnerSphere=function(b,h){var e=gl.shaders[this.shader],f=gl.meshes.sphere,n=this._hover_action;mat4.scale(c,b,[0.1,0.1,0.1]);e.setUniform("u_model",c);e.setUniform("u_color",n==
h?a.SELECTED_COLOR:a.INNERSPHERE_COLOR);e.draw(f);"drag"==h&&(mat4.scale(c,b,[0.07,0.07,0.07]),e.setUniform("u_model",c),e.setUniform("u_color",n==h?a.INNERSPHERE_COLOR:[0,0,0,1]),e.draw(f));h&&this.toScreen(c,h)};a.prototype.renderOutline=function(b,c,h,e){if((e=e||this.targets)&&e.length){var f=this.layers;e=e.filter(function(b){return b.layers&f});var n=gl.viewport_data[2],g=gl.viewport_data[3];this._selection_buffer&&this._selection_buffer.width==n&&this._selection_buffer.height==g||(this._selection_buffer=
new GL.Texture(n,g,{magFilter:gl.NEAREST}));a.outline_material||(a.outline_material=new RD.Material({shader_name:"flat"}));var l=this.shader;this._selection_buffer.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);b.shader_overwrite=l;var a=b.onNodeShaderUniforms;b.onNodeShaderUniforms=function(b,a){a.setUniform("u_color",[1,1,1,1])};var f=b.pipeline;b.pipeline=null;b.overwrite_material=RD.Gizmo.outline_material;b.render(c,h,e);b.shader_overwrite=null;b.onNodeShaderUniforms=
a;b.pipeline=f;b.overwrite_material=null});var k=gl.shaders.outline;k||(k=gl.shaders.outline=GL.Shader.createFX("\t\t\tvec3 colorU = texture2D(u_texture, uv - vec2(0.0,u_res.y)).xyz;\n\t\t\tvec3 colorUL = texture2D(u_texture, uv - u_res).xyz;\n\t\t\tvec3 colorUR = texture2D(u_texture, uv + vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 colorL = texture2D(u_texture, uv - vec2(u_res.x,0.0)).xyz;\n\t\t\tvec3 colorDL = texture2D(u_texture, uv - vec2(u_res.x,-u_res.y)).xyz;\n\t\t\tvec3 outline = abs(color.xyz - colorU) * 0.3 + abs(color.xyz - colorL) * 0.3;\n\t\t\toutline += (abs(color.xyz - colorUL) + abs(color.xyz - colorDL) + abs(color.xyz - colorUR)) * 0.1;\n\t\t\tcolor = vec4( clamp(outline,vec3(0.0),vec3(1.0)),1.0 );\n\t\t\t//color = texture2D(u_texture, uv);\n\t\t",
"uniform vec2 u_res;\n"));gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);this._selection_buffer.toViewport(k,{u_color:[1,1,1,1],u_res:[1/n,1/g]});gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};a.prototype.renderCameraGizmo=function(b,a){this.drawInnerSphere};a.prototype.toScreen=function(b,c,h){c=this.actions[c];mat4.multiplyVec3(c.pos,b,h||[0,0,0]);this._camera.project(c.pos,a.full_viewport,c.pos2D);c.visible=!0};extendClass(a,RD.SceneNode);RD.Gizmo=a})("undefined"!=typeof window?
window:"undefined"!=typeof self?self:global);
RD.GLTF={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,convert_skeletons:!1,overwrite_materials:!0,rename_assets:!1,prefabs:{},texture_options:{format:GL.RGBA,
magFilter:GL.LINEAR,minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT,no_flip:!1},load:function(p,a,k,m){function g(b){function a(c){var h=this.buffer;h.data=c;h.dataview=new Uint8Array(c);b.length?g(b):e()}var c=b.pop(),h=t+"/"+c.uri;"blob:"==c.uri.substr(0,5)&&(h=c.uri);"data:"==c.uri.substr(0,5)?(h=_base64ToArrayBuffer(c.uri.substr(37)),a.call({buffer:c},h)):fetch(h).then(function(b){return b.arrayBuffer()}).then(a.bind({buffer:c}))}function e(){l.filename=f;l.folder=t;l.url=p;var b=RD.GLTF.parse(l),
c=b.serialize();RD.GLTF.prefabs[p]=c;a&&a(b)}if(!p)throw"url missing";var l=null,f="",t="";if(p.constructor===String){t=p.split("/");f=t.pop();k=k||f.split(".").pop().toLowerCase();var t=t.join("/"),h=new XMLHttpRequest;h.onload=function(){if(200!=this.status)console.error("GLTF not found",p),a&&a(null);else{var b=h.response;"gltf"==k?(l=b,g(l.buffers.concat())):"glb"==k&&((l=RD.GLTF.parseGLB(b))?e():console.error("error parsing GLB:",f))}};h.onerror=function(){console.error("Network Error");a&&a(null)};
m&&(h.onprogress=function(b){m(p,b.loaded,b.total)});h.responseType="gltf"==k?"json":"arraybuffer";h.open("GET",p);h.send()}else{var c=p;if(f=c.main){p=f;var n=c[f];if("glb"==n.extension)(l=RD.GLTF.parseGLB(n.data))&&e();else{l=n.data;for(n=0;n<l.buffers.length;++n){var b=l.buffers[n];"data:"==b.uri.substr(0,5)?b.data=_base64ToArrayBuffer(b.uri.substr(37)):b.data=c[b.uri].data;b.dataview=new Uint8Array(b.data)}e()}}}},parseGLB:function(p){var a=new Uint8Array(p),k=new DataView(p);if(1179937895!=k.getUint32(0,
!0))return console.error("incorrect gltf header"),null;k.getUint32(4,!0);k.getUint32(8,!0);for(var m=12,g=null,e=0;m<a.length;){var l=k.getUint32(m,!0),f=k.getUint32(m+4,!0),t=p.slice(m+8,m+8+l),m=m+(8+l);if(f==RD.GLTF.JSON_CHUNK){if(!("TextDecoder"in window))throw"Sorry, this browser does not support TextDecoder...";g=(new TextDecoder("utf-8")).decode(t);g=JSON.parse(g)}else f==RD.GLTF.BINARY_CHUNK?(l=g.buffers[e],l.data=t,l.dataview=new Uint8Array(t),e++):console.warn("gltf unknown chunk type: ",
"0x"+f.toString(16))}return g},parse:function(p,a){p.url||(p.url=a||"scene.glb");var k=null,m={};1<p.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var g=p.scenes[p.scene].nodes;this.gltf_materials={};if(p.skins)for(var e=0;e<p.skins.length;++e)for(var k=p.skins[e],l=0;l<k.joints.length;++l)p.nodes[k.joints[l]]._is_joint=!0;k=null;1<g.length&&(k=new RD.SceneNode,k.name="root");for(e=0;e<g.length;++e){var f=l=g[e];null!=l.node&&(f=l.node);l=RD.GLTF.parseNode(null,
f,p);k||(k=l);1<g.length&&k.addChild(l);l.id=p.url.replace(/\//gi,"_")+"::node_"+e;m[l.id]=m[e]=l}if(p.animations&&p.animations.length){if(RD.Animation)for(k.animations=[],e=0;e<p.animations.length;++e)g=this.parseAnimation(e,p,m),g.id=p.filename+"::"+g.name,g&&(RD.Animations[g.id]=g,k.animations.push(g));else console.error("you must include rendeer-animation.js to allow animations");this.convert_skeletons&&this.convertSkinToSkeleton(k,k)}k.materials=this.gltf_materials;return k},parseNode:function(p,
a,k){var m=k.nodes[a];p=p||new RD.SceneNode;for(var g in m){var e=m[g];switch(g){case "name":p.name=e;break;case "translation":p.position=e;break;case "rotation":p.rotation=e;break;case "scale":p.scaling=e;var l=0;0>p.scaling[0]&&l++;0>p.scaling[1]&&l++;0>p.scaling[2]&&l++;1==l%2&&(p.flags.frontFace=GL.CW);break;case "matrix":p.fromMatrix(e);0>mat4.determinant(e)&&(p.flags.frontFace=GL.CW);break;case "mesh":if(e=RD.GLTF.parseMesh(e,k))for(p.mesh=e.name,p.primitives=[],l=0;l<e.info.groups.length;++l){var f=
e.info.groups[l],t=null;null!=f.material&&(t=this.parseMaterial(f.material,k));p.primitives.push({index:l,material:t?t.name:null,mode:f.mode})}break;case "skin":p.skin=this.parseSkin(e,k);break;case "children":if(e.length)for(l=0;l<e.length;++l)f=RD.GLTF.parseNode(null,e[l],k),p.addChild(f);break;case "extras":break;default:"_"!=g[0]&&console.log("gltf node info ignored:",g,m[g])}}if(p.mesh&&p.skin)for(e=gl.meshes[p.mesh],e.bones=[],l=0;l<p.skin.joints.length;++l)e.bones.push([p.skin.joints[l],p.skin.bindMatrices[l]]);
m.name||(m.name=p.name="node_"+a);m._is_joint&&(p.is_joint=!0);return p},parseMesh:function(p,a){for(var k=a.meshes[p],m=gl.meshes,g=[],e=[],l=0,f=0;f<k.primitives.length;++f){var t=this.parsePrimitive(k,f,a);if(t){t.start=l;l+=t.length;e.push(t);var h={vertexBuffers:{},indexBuffers:{}},c;for(c in t.buffers){var n=c;"bones"==n&&(n="bone_indices");"indices"==n||"triangles"==n?h.indexBuffers[n]={data:t.buffers[c]}:h.vertexBuffers[n]={data:t.buffers[c]}}g.push({mesh:h})}}l=null;1<g.length?l=GL.Mesh.mergeMeshes(g):
1==g.length&&(f=g[0].mesh,l=new GL.Mesh(f.vertexBuffers,f.indexBuffers),l.info&&f.info&&(l.info=f.info));if(!l)return null;for(f=0;f<k.primitives.length;++f)(g=l.info.groups[f])||(l.info.groups[f]=g={}),t=k.primitives[f],g.material=t.material,g.mode=null!=t.mode?t.mode:4,g.start=e[f].start,g.length=e[f].length;l.name=k.name;if(!l.name||this.rename_assets)l.name=a.filename+"::mesh_"+(k.name||p);l.updateBoundingBox();l.computeGroupsBoundingBoxes();return m[l.name]=l},parsePrimitive:function(p,a,k){var m=
{buffers:{}},g=m.buffers;p=p.primitives[a];if(p.extensions)if(p.extensions.KHR_draco_mesh_compression){if("undefined"==typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";g=m.buffers=this.decompressDraco(p,k)}else throw"mesh data is compressed, this importer does not support it yet";else{null==!p.attributes.POSITION&&console.warn("gltf mesh without positions");for(var e in this.buffer_names){a=this.buffer_names[e];var l=this.flip_uv&&("coords"==a||
"coords1"==a),f=p.attributes[e];null!=f&&(l=this.parseAccessor(f,k,l))&&(g[a]=l)}null!=p.indices&&(g.triangles=this.parseAccessor(p.indices,k))}if(!g.vertices)return console.error("primitive without vertices"),null;m.mode=p.mode;m.material=p.material;m.start=0;m.length=g.triangles?g.triangles.length:g.vertices.length/3;return m},convertSkinToSkeleton:function(p,a){if(p.skin){var k=a.findNodeByName(p.skin.skeleton_root);p.skeleton||(p.skeleton=new RD.Skeleton);p.skeleton.importSkeleton(k||a)}for(k=
0;k<p.children.length;++k)this.convertSkinToSkeleton(p.children[k],a)},installDracoModule:function(p){var a=this.draco_data_types={},k=this;this.decoderModule?p&&p(this.decoderModule):"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(m){var g=k.decoderModule=m;a[g.DT_INT8]=Int8Array;a[g.DT_UINT8]=Uint8Array;a[g.DT_INT16]=Int16Array;a[g.DT_UINT16]=Uint16Array;a[g.DT_INT32]=Int32Array;a[g.DT_UINT32]=Uint32Array;a[g.DT_FLOAT32]=Float32Array;p&&p(m)}):console.error("Draco3D not installed")},
decompressDraco:function(p,a){this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,p,a)},decodePrimitive:function(p,a,k){var m={};a=k.buffers[k.bufferViews[a.extensions.KHR_draco_mesh_compression.bufferView].buffer];var g=a.dataview.buffer;k=this.decoderModule;a=new k.DecoderBuffer;a.Init(new Int8Array(g),g.byteLength);if(p.GetEncodedGeometryType(a)==k.TRIANGULAR_MESH){var e=new k.Mesh,g=p.DecodeBufferToMesh(a,e);if(!g.ok()||0===e.ptr)throw Error("GLTF Draco: Decoding failed: "+
g.error_msg());e.num_points();for(var l in this.buffer_names){var g=this.buffer_names[l],f=l;"COLOR_0"==f?f="COLOR":"TEXCOORD_0"==f&&(f="TEX_COORD");if(f=this.decodeBuffer(e,k[f],"coords"==g||"coords1"==g,p))m[g]=f.data}l=3*e.num_faces();g=4*l;f=k._malloc(g);p.GetTrianglesUInt32Array(e,g,f);m.triangles=(new Uint32Array(k.HEAPF32.buffer,f,l)).slice();k._free(f)}k.destroy(a);k.destroy(e);return m},decodeBuffer:function(p,a,k,m){if(null==a)return null;var g=this.decoderModule;a=m.GetAttributeId(p,a);
if(-1==a)return null;var e=m.GetAttribute(p,a);a=e.data_type();var l=e.num_components(),f=p.num_points();e.size();var t=f*l,h=this.draco_data_types[a],g=new g.DracoFloat32Array;m.GetAttributeFloatForAllPoints(p,e,g);p=new h(t);for(m=0;m<p.length;++m)p[m]=g.GetValue(m);if(k)for(m=1;m<p.length;m+=l)p[m]=1-p[m];return{num_points:f,num_comps:l,data_type:a,data:p}},parseAccessor:function(p,a,k,m,g){var e=a.accessors[p];if(!e)return console.warn("gltf accessor not found"),null;p=this.numComponents[e.type];
if(!p)return console.warn("gltf accessor of unknown type:",e.type),null;var l=e.count*p;g=null;switch(e.componentType){case RD.GLTF.FLOAT:g=new Float32Array(l);break;case RD.GLTF.UNSIGNED_INT:g=new Uint32Array(l);break;case RD.GLTF.SHORT:g=new Int16Array(l);break;case RD.GLTF.UNSIGNED_SHORT:g=new Uint16Array(l);break;case RD.GLTF.BYTE:g=new Int8Array(l);break;case RD.GLTF.UNSIGNED_BYTE:g=new Uint8Array(l);break;default:console.warn("gltf accessor of unsupported type: ",e.componentType),g=new Float32Array(l)}null==
m&&(m=a.bufferViews[e.bufferView]);if(!m)return console.warn("gltf bufferView not found"),null;l=a.buffers[m.buffer];if(!l||!l.data)return console.warn("gltf buffer not found or data not loaded"),null;if(m.byteStride&&m.byteStride!=p*g.BYTES_PER_ELEMENT)return console.warn("gltf buffer data is not tightly packed, not supported"),null;a=new Uint8Array(g.buffer);null==m.byteOffset&&(m.byteOffset=0);m=m.byteOffset+(e.byteOffset||0);m=l.dataview.subarray(m,m+a.length);a.set(m);if(k)for(k=1;k<g.length;k+=
p)g[k]=1-g[k];return g},parseMaterial:function(p,a){var k=a.materials[p];if(!k)return console.warn("gltf material not found"),null;var m=k.name;if(!m||this.rename_assets)m=a.filename+"::mat_"+(k.name||p);var g=RD.Materials[m];if(g&&(!this.overwrite_materials||g.from_filename==a.filename))return g;g=new RD.Material;g.name=m;g.from_filename=a.filename;null!=k.alphaMode&&(g.alphaMode=k.alphaMode);g.alphaCutoff=null!=k.alphaCutoff?k.alphaCutoff:0.5;null!=k.doubleSided&&(g.flags.two_sided=k.doubleSided);
g.normalmapFactor=1;k.pbrMetallicRoughness&&(g.model="pbrMetallicRoughness",g.color.set([1,1,1]),g.opacity=1,g.metallicFactor=1,g.roughnessFactor=1,null!=k.pbrMetallicRoughness.baseColorFactor&&(g.color=k.pbrMetallicRoughness.baseColorFactor),k.pbrMetallicRoughness.baseColorTexture&&(g.textures.albedo=this.parseTexture(k.pbrMetallicRoughness.baseColorTexture,a),"MASK"==g.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic&&(m=gl.textures[g.textures.albedo.texture]))&&(m.bind(0),gl.texParameteri(gl.TEXTURE_2D,
gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,8)),null!=k.pbrMetallicRoughness.metallicFactor&&(g.metallicFactor=k.pbrMetallicRoughness.metallicFactor),null!=k.pbrMetallicRoughness.roughnessFactor&&(g.roughnessFactor=k.pbrMetallicRoughness.roughnessFactor),k.pbrMetallicRoughness.metallicRoughnessTexture&&(g.textures.metallicRoughness=this.parseTexture(k.pbrMetallicRoughness.metallicRoughnessTexture,a)));k.occlusionTexture&&(g.textures.occlusion=this.parseTexture(k.occlusionTexture,
a));k.normalTexture&&(g.textures.normal=this.parseTexture(k.normalTexture,a));k.emissiveTexture&&(g.textures.emissive=this.parseTexture(k.emissiveTexture,a));k.emissiveFactor&&(g.emissive=k.emissiveFactor);RD.Materials[g.name]=g;return this.gltf_materials[g.name]=g},parseTexture:function(p,a){var k=a.textures[p.index];if(!k)return console.warn("gltf texture not found"),null;var m=a.images[k.source],g="",e=null;m.uri?(e=m.uri,e.split(".").pop()):(e=a.url.replace(/[\/\.\:]/gi,"_")+"_image_"+p.index,
g=m.mimeType?m.mimeType.split("/").pop():"png",e+="."+g);var l={};if(!gl.textures[e])if(m.uri){var f=m.uri;if("data:"==f.substr(0,5)){var t=m.uri.indexOf(","),h=m.uri.substr(5,t),g=h.split("/").pop().toLowerCase(),e=a.folder+"/"+f+"image_"+p.index+"."+g,g=_base64ToArrayBuffer(m.uri.substr(t+1)),m=URL.createObjectURL(new Blob([g],{type:h})),m=GL.Texture.fromURL(m,this.texture_options);m.name=e;gl.textures[e]=m}else"blob:"==f.substr(0,5)?l.texture=f:l.texture=a.folder+"/"+f}else null!=m.bufferView&&
(h=a.bufferViews[m.bufferView],null==h.byteOffset&&(h.byteOffset=0),g=a.buffers[h.buffer].data.slice(h.byteOffset,h.byteOffset+h.byteLength),m=URL.createObjectURL(new Blob([g],{type:m.mimeType})),m=GL.Texture.fromURL(m,this.texture_options),m.name=e,gl.textures[e]=m);l.texture||(l.texture=e);null!=k.sampler&&(k=a.samplers[k.sampler],null!=k.magFilter&&(l.magFilter=k.magFilter),null!=k.minFilter&&(l.minFilter=k.minFilter));p.texCoord&&(l.uv_channel=p.texCoord);return l},parseSkin:function(p,a){var k=
a.skins[p],m={};null!=k.skeleton&&(m.skeleton_root=a.nodes[k.skeleton].name);var g=this.parseAccessor(k.inverseBindMatrices,a);if(!g)return console.warn("accessor is null"),null;m.bindMatrices=this.splitBuffer(g,16);m.joints=[];for(g=0;g<k.joints.length;++g){var e=a.nodes[k.joints[g]];m.joints.push(e.id||e.name)}return m},splitBuffer:function(p,a){p||console.warn("buffer is null");for(var k=p.length,m=[],g=0;g<k;g+=a)m.push(new p.constructor(p.subarray(g,g+a)));return m},parseAnimation:function(p,
a,k){k=a.animations[p];var m=new RD.Animation;m.name=k.name||"anim_"+p;for(var g=p=0;g<k.channels.length;++g){var e=new RD.Animation.Track,l=k.channels[g],f=k.samplers[l.sampler];e.target_node=a.nodes[l.target.node].name;e.target_property=l.target.path.toLowerCase();if(l=this.rename_animation_properties[e.target_property])e.target_property=l;var l=this.parseAccessor(f.input,a),t=this.parseAccessor(f.output,a),h=a.accessors[f.output].type,f=RD.TYPES[h];f==RD.VEC4&&"rotation"==e.target_property&&(f=
RD.QUAT);e.type=f;if(f=RD.TYPES_SIZE[f]){for(var h=t.length/f,c=new Float32Array((1+f)*h),n=0;n<h;++n){c[n*(1+f)]=l[n];var b=t.subarray(n*f,n*f+f);c.set(b,n*(1+f)+1)}e.data=c;e.packed_data=!0;p=Math.max(p,l[l.length-1]);m.addTrack(e)}else console.warn("gltf unknown type:",h)}m.duration=p;return m},loadFromFiles:function(p,a){function k(c){var b=c.target.result,h=this.extension;if("gltf"==h)b=JSON.parse(b),m.main=this.filename;else if("glb"==h)m.main=this.filename;else if("bin"==h)l.push(this.filename);
else if("jpeg"==h||"jpg"==h||"png"==h)c=URL.createObjectURL(new Blob([b],{type:c.target.mimeType})),h=GL.Texture.fromURL(c,{wrap:gl.REPEAT,extension:h}),h.name=this.filename,gl.textures[h.name]=h,gl.textures["/textures/"+h.name]&&(gl.textures["/textures/"+h.name]=h);m[this.filename]={filename:this.filename,data:b,extension:this.extension};g--;0==g&&(m.binaries=l,e.load(m,function(b){a&&a(b)}))}for(var m={},g=p.length,e=this,l=[],f=0;f<p.length;++f){var t=p[f],h=new FileReader,c=t.name.split("."),
c=c[c.length-1].toLowerCase();h.onload=k;h.filename=t.name;h.extension=c;"gltf"==c?h.readAsText(t):h.readAsArrayBuffer(t)}},removeRootPathFromTextures:function(p,a){if(a)for(var k in p){var m=p[k],g;for(g in m.textures){var e=m.textures[g];e&&(e.constructor===String&&0==e.indexOf(ROOM.root_path)&&-1!=e.texture.indexOf("/")?e.substr(ROOM.root_path.length):e.texture&&0==e.texture.indexOf(ROOM.root_path)&&-1!=e.texture.indexOf("/")&&(e.texture=e.texture.substr(ROOM.root_path.length)))}}}};
RD.SceneNode.prototype.loadGLTF=function(p,a){function k(e){m.loading=!1;e&&m.addChild(e);a&&a(m,e)}var m=this;if(RD.GLTF.prefabs[p]){var g=new RD.SceneNode;g.configure(RD.GLTF.prefabs[p]);k(g)}else this.loading=!0,RD.GLTF.load(p,k)};function _base64ToArrayBuffer(p){p=window.atob(p);for(var a=p.length,k=new Uint8Array(a),m=0;m<a;m++)k[m]=p.charCodeAt(m);return k.buffer}"undefined"!=typeof DracoDecoderModule&&RD.GLTF.installDracoModule(RD.GLTF.onReady);
(function(p){function a(e){this.renderer=e;this.mode=a.FORWARD;this.visible_layers=65535;this.bgcolor=vec4.fromValues(0.1,0.1,0.1,1);this.environment_texture=null;this.render_skybox=!0;this.environment_sh_coeffs=this.skybox_texture=null;this.environment_rotation=180;this.emissive_factor=this.occlusion_factor=this.exposure=this.environment_factor=1;this.postfx_shader_name=null;this.allow_overlay=this.timer_queries_enabled=!0;this.brightness=this.contrast=1;this.gamma=2.2;this.parallax_reflection=!1;
this.parallax_reflection_matrix=mat4.create();this.parallax_reflection_matrix_inv=mat4.create();this.texture_matrix=mat3.create();this.quality=this.resolution_factor=1;this.test_visibility=!0;this.skip_background=this.single_pass=!1;this.allow_instancing=!0;this.debug_instancing=!1;this.use_rendertexture=!0;this.alpha_composite_target_texture=this.fx=null;this.frame_time=-1;this.global_uniforms={u_brdf_texture:0,u_exposure:this.exposure,u_occlusion_factor:this.occlusion_factor,u_background_color:this.bgcolor.subarray(0,
3),u_tonemapper:0,u_gamma:this.gamma,u_SpecularEnvSampler_texture:1,u_skybox_mipCount:5,u_skybox_info:[this.environment_rotation,this.environment_factor],u_use_environment_texture:!1,u_viewport:gl.viewport_data,u_camera_perspective:1,u_clipping_plane:vec4.fromValues(0,0,0,0)};this.material_uniforms={u_albedo:vec3.fromValues(1,1,1),u_emissive:vec4.fromValues(0,0,0,0),u_roughness:1,u_metalness:1,u_alpha:1,u_alpha_cutoff:0,u_tintColor:vec3.fromValues(1,1,1),u_backface_color:vec3.fromValues(0.5,0.5,0.5),
u_normalFactor:1,u_metallicRough:!1,u_reflectance:0.1,u_texture_matrix:this.texture_matrix,u_displacement_factor:0,u_maps_info:new Int8Array(10),u_clearCoat:0,u_clearCoatRoughness:0.5,u_isAnisotropic:!1,u_anisotropy:0.5,u_anisotropy_direction:vec3.fromValues(0,0,1)};this.sampler_uniforms={};this._instancing_uniforms={};this.material_uniforms.u_maps_info.fill(-1);this.fx_uniforms={u_viewportSize:vec2.create(),u_iViewportSize:vec2.create()};this.final_fbo=this.final_texture=null;this.render_calls=[];
this.render_calls_pool=[];this.rendered_render_calls=this.used_render_calls=0;this.current_camera=null;this.overlay_rcs=[];this.compiled_shaders={};this.max_textures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.max_texture_size=gl.getParameter(gl.MAX_TEXTURE_SIZE);this.default_material=new m.Material;this.onRenderBackground=null}function k(){this.name="";this.id=-1;this.model=this.mesh=null;this.index_buffer_name="triangles";this.group_index=-1;this.material=null;this.reverse_faces=!1;this.node=
this._instancing=this.skin=null;this._render_priority=0}var m=p.RD;a.FORWARD=1;a.DEFERRED=2;a.MACROS={UVS2:1,COLOR:2,POINTS:4,INSTANCING:8,SKINNING:16,PARALLAX_REFLECTION:32};a.maps="albedo metallicRoughness occlusion normal emissive opacity displacement detail".split(" ");a.maps_sampler=[];for(p=0;p<a.maps.length;++p)a.maps_sampler[p]="u_"+a.maps[p]+"_texture";a.prototype.render=function(e,g,f,k,h,c){this.renderer=e;this.current_camera=f;this.mode==a.FORWARD?this.renderForward(g,f,h,c):this.mode==
a.DEFERRED&&this.renderDeferred(g,f,c)};a.prototype.fillGlobalUniforms=function(a){var g=this.getBRDFIntegratorTexture();g&&g.bind(0);this.environment_texture?(this.environment_texture.bind(1),this.global_uniforms.u_use_environment_texture=!0):this.global_uniforms.u_use_environment_texture=!1;this.environment_sh_coeffs?(this.global_uniforms.u_useDiffuseSH=!0,this.global_uniforms.u_sh_coeffs=this.environment_sh_coeffs):this.global_uniforms.u_useDiffuseSH=!1;this.global_uniforms.u_skybox_info[0]=this.environment_rotation*
DEG2RAD;this.global_uniforms.u_skybox_info[1]=this.environment_factor;this.global_uniforms.u_occlusion_factor=this.occlusion_factor;this.global_uniforms.u_background_color=this.bgcolor.subarray(0,3);this.global_uniforms.u_camera_perspective=a._projection_matrix[5];this.global_uniforms.u_tonemapper=0;this.quality?(this.global_uniforms.u_exposure=this.exposure,this.global_uniforms.u_gamma=this.gamma):(this.global_uniforms.u_exposure=Math.pow(this.exposure,1/2.2),this.global_uniforms.u_gamma=this.use_rendertexture?
this.gamma:1)};a.prototype.renderForward=function(a,g,f,k){var h=Math.floor(gl.viewport_data[2]*this.resolution_factor),c=Math.floor(gl.viewport_data[3]*this.resolution_factor),h=Math.min(h,this.max_texture_size),c=Math.min(c,this.max_texture_size);this.use_rendertexture&&!f&&(this.frame_texture&&this.frame_texture.width==h&&this.frame_texture.height==c||(this.frame_texture=new GL.Texture(h,c,{format:gl.RGBA,type:gl.HIGH_PRECISION_FORMAT}),this.final_fbo?this.final_fbo.setTextures([this.frame_texture]):
this.final_fbo=new GL.FBO([this.frame_texture],null,!0),this.frame_texture.name=":frame_texture",gl.textures[this.frame_texture.name]=this.frame_texture,this.final_texture=new GL.Texture(h,c,{format:gl.RGB}),this.final_texture.name=":final_frame_texture",gl.textures[this.final_texture.name]=this.final_texture),this.final_fbo.bind(0));gl.clearColor(this.bgcolor[0],this.bgcolor[1],this.bgcolor[2],this.bgcolor[3]);gl.clear((this.skip_background?0:gl.COLOR_BUFFER_BIT)|gl.DEPTH_BUFFER_BIT);gl.frontFace(gl.CCW);
gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);if(!this.skip_background){if(this.onRenderBackground)this.onRenderBackground(g,this);else this.renderSkybox(g);LEvent.trigger(this,"renderSkybox",this)}this.fillGlobalUniforms(g);if(this.onRenderOpaque)this.onRenderOpaque(this,this.renderer,g);LEvent.trigger(this,"renderOpaque",this);this.renderNodes(a,g,k);if(this.onRenderAlpha)this.onRenderAlpha(this,this.renderer,g);LEvent.trigger(this,"renderAlpha",this);if(this.onRenderGizmos)this.onRenderGizmos(this,
this.renderer,g);LEvent.trigger(this,"renderGizmos",this);this.use_rendertexture&&!f&&this.renderFinalBuffer();if(this.overlay_rcs.length)for(a=this.overlay_rcs,this.global_uniforms.u_gamma=1,this.global_uniforms.u_exposure=1,gl.clear(gl.DEPTH_BUFFER_BIT),g=0;g<a.length;++g)f=a[g],this.renderMeshWithMaterial(f.model,f.mesh,f.material,f.index_buffer_name,f.group_index,f.node.extra_uniforms,f.reverse_faces,f.skin)};a.prototype.renderNodes=function(e,g,f){this.resetRenderCallsPool();for(var k=this.render_calls.length=
0;k<e.length;++k)this.getNodeRenderCalls(e[k],g,f);e=this.render_calls;if(this.onFilterRenderCalls)this.onFilterRenderCalls(e);for(k=0;k<e.length;++k)e[k].computeRenderPriority(g._position);e=e.sort(a.rc_sort_function);this.allow_instancing&&gl.extensions.ANGLE_instanced_arrays&&(e=this.groupRenderCallsForInstancing(e));g=(this.alpha_composite_callback||this.alpha_composite_target_texture)&&GL.FBO.current;f=!0;for(var h=this.overlay_rcs,k=h.length=0;k<e.length;++k){var c=e[k];if(c.material.overlay&&
this.allow_overlay)h.push(c);else{f&&g&&"BLEND"==c.material.alphaMode&&(f=!1,this.alpha_composite_target_texture&&GL.FBO.current.color_textures[0].copyTo(this.alpha_composite_target_texture),this.alpha_composite_callback&&this.alpha_composite_callback(GL.FBO.current,this.alpha_composite_target_texture));var n=c.model;c._instancing&&c._instancing.length&&(n=GL.linearizeArray(c._instancing,Float32Array));this.renderMeshWithMaterial(n,c.mesh,c.material,c.index_buffer_name,c.group_index,c.node.extra_uniforms,
c.reverse_faces,c.skin)}}};a.prototype.renderFinalBuffer=function(){this.final_fbo.unbind(0);gl.disable(GL.BLEND);gl.disable(GL.DEPTH_TEST);this.fx&&this.fx.applyFX(this.frame_texture,null,this.frame_texture);this.fx_uniforms.u_viewportSize[0]=this.frame_texture.width;this.fx_uniforms.u_viewportSize[1]=this.frame_texture.height;this.fx_uniforms.u_iViewportSize[0]=1/this.frame_texture.width;this.fx_uniforms.u_iViewportSize[1]=1/this.frame_texture.height;this.fx_uniforms.u_contrast=this.contrast;this.fx_uniforms.u_brightness=
this.brightness;this.fx_uniforms.u_gamma=this.gamma;this.frame_texture.copyTo(this.final_texture,gl.shaders.fxaa_tonemapper,this.fx_uniforms);var a=null;this.postfx_shader_name&&(a=gl.shaders[this.postfx_shader_name])&&a.setUniform("u_size",[this.final_texture.width,this.final_texture.height]);this.final_texture.toViewport(a)};a.prototype.getNodeRenderCalls=function(e,g,f){var k=null;if(e._mesh)k=e._mesh;else if(e.mesh&&(k=gl.meshes[e.mesh],!k)){this.renderer.autoload_assets&&-1!=e.mesh.indexOf(".")&&
this.renderer.loadMesh(e.mesh);return}void 0===f&&(f=65535);e.updateGlobalMatrix(!0);if(k&&!1!==e.flags.visible&&e.layers&f){f=e.skeleton||e.skin||null;if(this.test_visibility&&!f){a.temp_bbox||(a.temp_bbox=BBox.create(),a.aabb_center=BBox.getCenter(a.temp_bbox),a.aabb_halfsize=BBox.getHalfsize(a.temp_bbox));BBox.transformMat4(a.temp_bbox,k.getBoundingBox(),e._global_matrix);if(g.testBox(a.aabb_center,a.aabb_halfsize)==m.CLIP_OUTSIDE)return;e._last_rendered_frame=this.renderer.frame}if(e.primitives&&
e.primitives.length)for(g=0;g<e.primitives.length;++g){var h=e.primitives[g],c=null;if(c=h.material?m.Materials[h.material]:this.default_material)h=this.getRenderCallFromPool(),h.material=c,h.model=e._global_matrix,h.mesh=k,h.group_index=g,h.node=e,h._render_priority=c.render_priority||0,h._instancing=null,h.reverse_faces=e.flags.frontFace==GL.CW,h.skin=f,this.render_calls.push(h)}else e.material&&(c=m.Materials[e.material])&&(h=this.getRenderCallFromPool(),h.material=c,h.model=e._global_matrix,h.mesh=
k,h.group_index=-1,h.node=e,h._instancing=null,h.skin=f,h._render_priority=c.render_priority||0,h.reverse_faces=e.flags.frontFace==GL.CW,this.render_calls.push(h))}};a.prototype.groupRenderCallsForInstancing=function(a){for(var g={},f=0,k=0;k<a.length;++k){var h=a[k],c=null,c=h._instancing||h.skin?f++:h.mesh.name+":"+h.group_index+"/"+h.material.name+(h.reverse_faces?"[R]":"");g[c]?g[c].push(h):g[c]=[h]}a=[];for(k in g)if(f=g[k],0!=f.length)if(1==f.length)h=f[0],this.debug_instancing||a.push(h);else{h=
this.getRenderCallFromPool();h.copyFrom(f[0]);h._instancing=Array(f.length);for(c=0;c<f.length;++c)h._instancing[c]=f[c].model;a.push(h)}return a};a.rc_sort_function=function(a,g){return g._render_priority-a._render_priority};a.prototype.setParallaxReflectionTransform=function(a){this.parallax_reflection_matrix.set(a);this.parallax_reflection=!0;this.global_uniforms.u_cube_reflection_matrix=this.parallax_reflection_matrix;mat4.invert(this.parallax_reflection_matrix_inv,this.parallax_reflection_matrix);
this.global_uniforms.u_inv_cube_reflection_matrix=this.parallax_reflection_matrix_inv};a.prototype.resetShadersCache=function(){this.compiled_shaders={}};a.prototype.getShader=function(e,g,f){f=f||"";var k=f+":"+g,h=this.compiled_shaders[k];h||(h=this.compiled_shaders[k]=new Map);if(k=h.get(e))return k;if(!this.renderer.shader_files)return null;f=this.renderer.shader_files[f||"default.vs"];g=this.renderer.shader_files[g];if(!f||!g)return null;k=null;if(e){var k={},c;for(c in a.MACROS)e&a.MACROS[c]&&
(k[c]="")}k=new GL.Shader(f,g,k);h.set(e,k);return k};a.prototype.renderRenderCall=function(a){var g=a.model;a._instancing&&a._instancing.length&&(g=new Float32Array(a._instancing.flat()));this.renderMeshWithMaterial(g,a.mesh,a.material,a.index_buffer_name,a.group_index,a.node.extra_uniforms,a.reverse_faces,a.skin)};a.default_backface_color=[0.1,0.1,0.1];a.prototype.renderMeshWithMaterial=function(e,g,f,k,h,c,n,b){var r=this.renderer,s=null;if(!f||f.constructor===String)throw"no material in renderMeshWithMaterial";
if(!("BLEND"==f.alphaMode&&0>=f.color[3])){var q=this.material_uniforms,p=this.sampler_uniforms,v=e.length/16;q.u_albedo=f.color.subarray(0,3);q.u_emissive.set(f.emissive||m.ZERO);q.u_emissive[3]=f.emissive_clamp_to_edge?1:0;1!=this.emissive_factor&&vec3.scale(q.u_emissive,q.u_emissive,this.emissive_factor);q.u_backface_color=f.backface_color||a.default_backface_color;s=0;g.vertexBuffers.coords1&&(s|=a.MACROS.UVS2);g.vertexBuffers.colors&&(s|=a.MACROS.COLOR);b&&(s|=a.MACROS.SKINNING);this.parallax_reflection&&
(s|=a.MACROS.PARALLAX_REFLECTION);f.primitive==GL.POINTS&&(s|=a.MACROS.POINTS);1<v&&(s|=a.MACROS.INSTANCING);this.overwrite_shader_name?s=gl.shaders[this.overwrite_shader_name]:this.overwrite_shader_mode?s=this.getShader(s,this.overwrite_shader_mode):f.shader_name?s=gl.shaders[f.shader_name]:f.overlay?s=this.getShader(s,"overlay.fs"):"pbrMetallicRoughness"==f.model&&this.quality?(q.u_metalness=f.metallicFactor,q.u_roughness=f.roughnessFactor,q.u_metallicRough=Boolean(f.textures.metallicRoughness),
s=this.getShader(s,"pbr.fs")):s=this.getShader(s,"nopbr.fs");if(s){q.u_alpha=f.opacity;q.u_alpha_cutoff=0;q.u_normalFactor=null!=f.normalmapFactor?f.normalmapFactor:1;q.u_displacement_factor=null!=f.displacementFactor?f.displacementFactor:1;f.uv_transform?this.texture_matrix.set(f.uv_transform):mat3.identity(this.texture_matrix);for(var z=2,u=q.u_maps_info,x=0;x<a.maps.length;++x){var y=a.maps[x];u[x]=-1;if(y=f.textures[y]){var B=null;y.constructor===Object?B=y.texture:y.constructor===String&&(B=
y,y=null);if(B){var w=a.maps_sampler[x];if(!s||s.samplers[w]){var D=gl.textures[B];D||(r.autoload_assets&&-1!=B.indexOf(".")&&r.loadTexture(B,r.default_texture_settings),D=gl.textures.white);B=16>this.max_textures?z++:x+2;p[w]=D.bind(B);u[x]=y&&null!=y.uv_channel?Math.clamp(y.uv_channel,0,3):0}}}}n||gl.frontFace(GL.CCW);r.enableItemFlags(f);n&&gl.frontFace(GL.CW);"BLEND"==f.alphaMode?(gl.enable(gl.BLEND),f.additive||"ADD"==f.blendMode?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):"MULTIPLY"==f.blendMode?gl.blendFunc(gl.DST_COLOR,
gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.depthMask(!1),q.u_alpha_cutoff=0):"MASK"==f.alphaMode?q.u_alpha_cutoff=f.alphaCutoff:gl.disable(gl.BLEND);if(b)if(b.constructor===m.Skeleton)this.bones=b.computeFinalBoneMatrices(this.bones,g),s.setUniform("u_bones",this.bones);else if(b._bone_matrices)s.setUniform("u_bones",b._bone_matrices);else return;1==v&&r._uniforms.u_model.set(e);b&&b.skip_model&&mat4.identity(r._uniforms.u_model);s.uniforms(r._uniforms);s.uniforms(this.global_uniforms);
s.uniforms(f.uniforms);s.uniforms(q);s.uniforms(p);c&&s.uniforms(c);f.primitive==GL.POINTS&&s.setUniform("u_pointSize",f.point_size||-1);c=null;null!=h&&g.info&&g.info.groups&&g.info.groups[h]&&(c=g.info.groups[h]);h=this._instancing_uniforms;h.u_model=e;f.flags.preAlpha&&(gl.colorMask(!1,!1,!1,!1),gl.depthMask(!0),1<v?s.drawInstanced(g,void 0===f.primitive?gl.TRIANGLES:f.primitive,k,h):c?s.drawRange(g,f.primitive,c.start,c.length,k):s.draw(g,f.primitive,k),gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.LEQUAL),
this.rendered_render_calls++);1<v?c?s.drawInstanced(g,void 0===f.primitive?gl.TRIANGLES:f.primitive,k,h,c.start,c.length):s.drawInstanced(g,void 0===f.primitive?gl.TRIANGLES:f.primitive,k,h):c?s.drawRange(g,f.primitive,c.start,c.length,k):s.draw(g,f.primitive,k);this.rendered_render_calls++;r.disableItemFlags(f);n&&gl.frontFace(GL.CCW);gl.depthFunc(gl.LESS);gl.depthMask(!0)}}};a.prototype.renderDeferred=function(a,g){};a.prototype.prepareBuffers=function(a){};a.prototype.renderToGBuffers=function(a,
g){};a.prototype.renderFinalPass=function(a,g){};a.prototype.applyPostFX=function(){};a.prototype.getRenderCallFromPool=function(){if(this.used_render_calls<this.render_calls_pool.length){var a=this.render_calls_pool[this.used_render_calls];this.used_render_calls++;return a}a=new m.RenderCall;a.id=this.used_render_calls;this.render_calls_pool.push(a);this.used_render_calls++;return a};a.prototype.resetRenderCallsPool=function(){this.used_render_calls=0};a.prototype.renderSkybox=function(a){if((!this.onRenderSkybox||
!this.onRenderSkybox(this,a))&&this.environment_texture&&this.render_skybox){var g=gl.meshes.cube,f=gl.shaders[this.overwrite_shader_name||"skybox"];if(f){var k=this.skybox_texture||this.environment_texture;if(k&&k.texture_type===GL.TEXTURE_CUBE_MAP){gl.disable(gl.CULL_FACE);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var h=this.renderer._model_matrix;mat4.identity(h);mat4.translate(h,h,a.position);mat4.scale(h,h,[10,10,10]);this.renderer.setModelMatrix(h);f.uniforms(this.renderer._uniforms);f.uniforms({u_color_texture:k.bind(1),
u_is_rgbe:!1,u_exposure:this.exposure,u_mipmap_offset:0,u_rotation:this.environment_rotation*DEG2RAD,u_camera_position:a.position});f.draw(g,GL.TRIANGLES)}}}};a.prototype.loadEnvironment=function(a,g,f){var k=this,h=gl.textures[a];h?(f?k.skybox_texture=h:(h.shs&&(k.environment_sh_coeffs=h.shs),k.environment_texture=h),g&&g(h)):HDRE.load(a,function(c){var h=c.toTexture(!0);h&&(gl.textures[a]=h,f?k.skybox_texture=h:(h.shs=c.shs?c.shs:null,k.environment_texture=h,h.shs&&(k.environment_sh_coeffs=h.shs)));
g&&g(h)})};a.prototype.captureEnvironment=function(a,g,f){f=f||256;this.capture_environment_texture||(this.capture_environment_texture=new GL.Texture(f,f,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));var k=this.use_rendertexture;this.use_rendertexture=!1;this.renderer.renderToCubemap(this.capture_environment_texture,a,g);this.use_rendertexture=k;this.capture_environment_texture.bind(0);gl.generateMipmap(this.capture_environment_texture.texture_type);
this.environment_texture||(this.environment_texture=new GL.Texture(f,f,{format:gl.RGBA,type:GL.UNSIGNED_BYTE,minFilter:gl.LINEAR_MIPMAP_LINEAR,texture_type:GL.TEXTURE_CUBE_MAP}));this.capture_environment_texture.copyTo(this.environment_texture)};a.prototype.getBRDFIntegratorTexture=function(a){if(gl.textures.brdf_integrator)return gl.textures.brdf_integrator;var g=gl.shaders.brdf_integrator;if(g){var f=gl.textures.brdf_integrator=new GL.Texture(128,128,{type:gl.FLOAT,texture_type:gl.TEXTURE_2D,filter:gl.LINEAR});
if(a)return fetch(a).then(function(a){return a.arrayBuffer()}).then(function(a){f.uploadData(new Float32Array(a),{no_flip:!0})}),f;var k=gl.textures.hammersley_sample_texture;k||(k=this.createHammersleySampleTexture());f.drawTo(function(a){k&&k.bind(0);g.uniforms({u_hammersley_sample_texture:0}).draw(GL.Mesh.getScreenQuad(),gl.TRIANGLES)});return f}};a.prototype.createHammersleySampleTexture=function(a){a=a||8192;for(var g=3*a,f=new Float32Array(g),k=0;k<g;k+=3){var h=2*Math.radical_inverse(k)*Math.PI;
f[k]=Math.cos(h);f[k+1]=Math.sin(h);f[k+2]=0}a=new GL.Texture(a,1,{pixel_data:f,type:GL.FLOAT,format:GL.RGB});return gl.textures.hammersley_sample_texture=a};a.prototype.setClippingPlane=function(a,g){a?this.global_uniforms.u_clipping_plane.set([g[0],g[1],g[2],vec3.dot(a,g)]):this.global_uniforms.u_clipping_plane.set([0,0,0,0])};a.prototype.startGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var a=gl.extensions.EXT_disjoint_timer_query;this._waiting_gpu_query||
(void 0===this._useQueryTimestamps&&(this._useQueryTimestamps=!1,0<a.getQueryEXT(a.TIMESTAMP_EXT,a.QUERY_COUNTER_BITS_EXT)&&(this._useQueryTimestamps=!0)),gl.getParameter(a.GPU_DISJOINT_EXT),this._useQueryTimestamps?(this._start_gpu_query=a.createQueryEXT(),this._end_gpu_query=a.createQueryEXT(),a.queryCounterEXT(this._start_gpu_query,a.TIMESTAMP_EXT)):(this._timeElapsed_gpu_query=a.createQueryEXT(),a.beginQueryEXT(a.TIME_ELAPSED_EXT,this._timeElapsed_gpu_query)))}};a.prototype.endGPUQuery=function(){if(gl.extensions.EXT_disjoint_timer_query&&
this.timer_queries_enabled&&!this._waiting_gpu_query){var a=gl.extensions.EXT_disjoint_timer_query;this._useQueryTimestamps?a.queryCounterEXT(this._end_gpu_query,a.TIMESTAMP_EXT):a.endQueryEXT(a.TIME_ELAPSED_EXT);this._waiting_gpu_query=!0}};a.prototype.resolveQueries=function(){if(gl.extensions.EXT_disjoint_timer_query&&this.timer_queries_enabled){var a=gl.extensions.EXT_disjoint_timer_query,g=this._start_gpu_query,f=this._end_gpu_query,k=this._timeElapsed_gpu_query,h=this._useQueryTimestamps;if(g||
f||k){var c=gl.getParameter(a.GPU_DISJOINT_EXT),n;if(!c&&(n=h?a.getQueryObjectEXT(f,a.QUERY_RESULT_AVAILABLE_EXT):a.getQueryObjectEXT(k,a.QUERY_RESULT_AVAILABLE_EXT))){var b;h?(b=a.getQueryObjectEXT(g,a.QUERY_RESULT_EXT),b=a.getQueryObjectEXT(f,a.QUERY_RESULT_EXT)-b):b=a.getQueryObjectEXT(k,a.QUERY_RESULT_EXT);this.frame_time=1E-6*b}if(n||c)h?(a.deleteQueryEXT(g),a.deleteQueryEXT(f),this._end_gpu_query=this._start_gpu_query=null):(a.deleteQueryEXT(k),this._timeElapsed_gpu_query=null),this._waiting_gpu_query=
!1}return this.frame_time}};Math.radical_inverse=function(a){for(var g=0,f=0.5;a;f*=0.5,a>>=1)a&1&&(g+=f);return g};var g=vec3.create();k.prototype.copyFrom=function(a){this.name=a.name;this.id=a.id;this.mesh=a.mesh;this.model=a.model;this.index_buffer_name=a.index_buffer_name;this.group_index=a.group_index;this.material=a.material;this.reverse_faces=a.reverse_faces;this.node=a.node;this.skin=a.skin;this._instancing=a._instancing;this._render_priority=a._render_priority};k.prototype.computeRenderPriority=
function(a){this.name=this.node.name;var k=this.mesh.getBoundingBox();k&&(k=mat4.multiplyVec3(g,this.model,k),this._render_priority=this.material.render_priority||0,a=vec3.distance(a,k),"BLEND"==this.material.alphaMode?(this._render_priority+=0.001*a,this._render_priority-=100):this._render_priority+=1E3-0.001*a)};m.PBRPipeline=a;m.RenderCall=k})(this);
(function(p){function a(){this.intensity=1;this._color=vec3.fromValues(0.9,0.9,0.9);this._position=vec3.fromValues(10,20,5);this._target=vec3.create();this._vector=vec3.create();this.camera=new RD.Camera;this._castShadows=!1;this.shadowmap={texture:null,resolution:2048,bias:5E-6,uniforms:{u_shadowmap_matrix:this.camera._viewprojection_matrix,u_shadowmap_texture:4,u_shadowbias:1E-5}};this.uniforms={u_light_position:this._position,u_light_color:vec3.create(),u_light_vector:this._vector};this.flags=
{skip_shadows:!1}}Object.defineProperty(a.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});Object.defineProperty(a.prototype,"castShadows",{set:function(a){a?this.enableShadows():this.disableShadows()},get:function(){return this._castShadows},enumerable:!0});a.DEFAULT_SHADOWMAP_RESOLUTION=2048;a.prototype.updateData=function(){vec3.sub(this._vector,this._target,this._position);vec3.normalize(this._vector,this._vector)};a.prototype.setUniforms=
function(a){this.shadowmap.uniforms.u_shadowbias=this.shadowmap.bias;this.uniforms.u_light_color.set(this._color);vec3.scale(this.uniforms.u_light_color,this.uniforms.u_light_color,this.intensity);if(a.constructor===GL.Shader)a.uniforms(this.uniforms),this._castShadows&&(a.uniforms(this.shadowmap.uniforms),this.shadowmap.texture.bind(this.shadowmap.uniforms.u_shadowmap_texture));else{for(var m in this.uniforms)a[m]=this.uniforms[m];if(this._castShadows)for(m in this.shadowmap.uniforms)a[m]=this.shadowmap.uniforms[m]}};
a.prototype.lookAt=function(a,m,g){this._position.set(a);this._target.set(m);this.camera.lookAt(a,m,g);this.updateData()};a.prototype.setView=function(a,m,g){this.camera.orthographic(a,m,g,1);this.updateData()};a.prototype.followCamera=function(a,m){var g=m||5,e=vec3.scaleAndAdd(vec3.create(),a.target,this._vector,-m);this.lookAt(e,a.target,a.up);this.camera.orthographic(g,0.01,3*g,1);this.camera.updateMatrices()};a.prototype.enableShadows=function(){this._castShadows=!0;var k=this.shadowmap.resolution||
a.DEFAULT_SHADOWMAP_RESOLUTION;this.shadowmap.texture&&this.shadowmap.texture.width==k||(this.shadowmap.texture=new GL.Texture(k,k,{format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT,filter:gl.NEAREST}),this.shadowmap.fbo=new GL.FBO(null,this.shadowmap.texture))};a.prototype.disableShadows=function(){this._castShadows=!1;this.shadowmap.texture=null;this.shadowmap.fbo=null};a.prototype.generateShadowmap=function(a,m,g){if(this.castShadows){if(!this.shadowmap.fbo)throw"no shadowmap fbo";a.generating_shadowmap=
!0;this.shadowmap.fbo.bind();gl.clear(gl.DEPTH_BUFFER_BIT);a.shader_overwrite="flat";if(m.constructor===Array)for(var e=0;e<m.length;++e)a.render(m[e],this.camera,null,g||255);else a.render(m,this.camera,null,g||255);a.shader_overwrite=null;this.shadowmap.fbo.unbind();a.generating_shadowmap=!1;this.shadowmap.texture.bind(4);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR)}};RD.Light=a})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(p){function a(){this.name="";this.tracks=[];this.duration=10}function k(){this.enabled=!0;this.target_property=this.target_node="";this.type=f.SCALAR;this.data=[];this.packed_data=!1;this._target=null}function m(a,c,f){return a*(1-f)+c*f}function g(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function e(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.index=-1;this.children=new Int8Array(16)}function l(){this.skeleton=
new g;this.duration=0;this.samples_per_second=30;this.num_keyframes=this.num_animated_bones=0;this.bones_map=new Uint8Array(64);this.keyframes=null}var f=p.RD=p.RD||{};f.Animations={};a.prototype.addTrack=function(a,c){if(c)for(var f=0;f<this.tracks.length;++f)if(this.tracks[f].target_node==a.target_node){this.tracks.splice(f+1,0,a);return}this.tracks.push(a)};a.prototype.applyAnimation=function(a,c,f){for(var b=0;b<this.tracks.length;++b){var e=this.tracks[b];!1!==e.enabled&&e.applyTrack(a,c,f)}};
a.prototype.serialize=function(){for(var a={name:this.name,duration:this.duration,tracks:[]},c=0;c<this.tracks.length;++c)a.tracks.push(this.tracks[c].serialize());return a};a.prototype.configure=function(a){this.name=a.name;this.duration=a.duration;for(var c=this.tracks.length=0;c<a.tracks.length;++c){var e=new f.Animation.Track;e.configure(a.tracks[c]);this.tracks.push(e)}return a};a.prototype.findNearestLeft=function(a){for(var c=0,f=0;f<this.tracks.length;++f){var b=this.tracks[f],e=b.findTimeIndex(a);
-1!=e&&(b=b.data[e],b>c&&(c=b))}return c};a.prototype.findNearestRight=function(a){for(var c=this.duration,f=0;f<this.tracks.length;++f){var b=this.tracks[f],e=b.findTimeIndex(a);-1!=e&&(b=b.data[e+1],null!=b&&b<c&&(c=b))}return c};f.Animation=a;a.Track=k;Object.defineProperty(k.prototype,"value_size",{set:function(a){throw"cannot be set, use type instead";},get:function(){return f.TYPES_SIZE[this.type]}});k.prototype.addKeyframe=function(a,c,f){1<this.value_size&&(c=new Float32Array(c));for(var b=
0;b<this.data.length;++b)if(!(this.data[b][0]<a))return this.data[b][0]!=a||f?this.data.splice(b,0,[a,c]):this.data[b][1]=c,b;this.data.push([a,c]);return this.data.length-1};k.prototype.getKeyframe=function(a){if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),null;var c=f.TYPES_SIZE[this.type];return this.packed_data?(a*=1+c,a>this.data.length-c?null:[this.data[a],this.data.subarray(a+1,a+c+1)]):this.data[a]};k.prototype.findTimeIndex=function(a){var c=this.data;if(!c||
0==c.length)return-1;var e=f.TYPES_SIZE[this.type];if(this.packed_data){var e=e+1,b=c.length/e,g=0,k=0,q=b;if(0==b)return-1;if(1==b)return 0;if(c[(q-1)*e]<a)return q-1;for(;q>=g;){k=0.5*(q+g)|0;b=c[k*e];if(b==a)break;if(g==q-1)return g;b<a?g=k:q=k}return k}b=c.length;k=g=0;q=b;if(0==b)return-1;if(1==b)return 0;if(c[q-1][0]<a)return q-1;for(;q>=g;){k=0.5*(q+g)|0;b=c[k][0];if(b==a)break;if(g==q-1)return g;b<a?g=k:q=k}return k};k.prototype.getSample=function(a,c,f){return this.data&&0!==this.data.length?
this.packed_data?this.getSamplePacked(a,c,f):this.getSampleUnpacked(a,c,f):void 0};k.prototype.getSampleUnpacked=function(a,c,e){var b=f.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-1][0]);var g=this.findTimeIndex(a);-1===g&&(g=0);var k=g,q=g+1,l=this.data,b=f.TYPES_SIZE[this.type];if(!c||0==b||1==l.length||q==l.length||0==k&&this.data[0][0]>a)return this.data[g][1];k=l[k];q=l[q];a=(q[0]-a)/(q[0]-k[0]);1<b&&(e=e||this._result,e&&e.length==b||(e=this._result=new Float32Array(b)));
if(c===f.LINEAR)return 1==b?k[1]*a+q[1]*(1-a):f.interpolateLinear(k[1],q[1],a,e,this.type,b,this);if(c===f.CUBIC){c=0<g?l[g-1]:k;g=g<l.length-2?l[g+2]:q;if(1===b)return f.EvaluateHermiteSpline(k[1],q[1],c[1],g[1],1-a);e=f.EvaluateHermiteSplineVector(k[1],q[1],c[1],g[1],1-a,e);this.type==f.QUAT?(quat.slerp(e,q[1],k[1],a),quat.normalize(e,e)):this.type==f.TRANS10&&(b=e.subarray(3,7),k=k[1].subarray(3,7),q=q[1].subarray(3,7),quat.slerp(b,q,k,a),quat.normalize(b,b));return e}return null};k.prototype.getSamplePacked=
function(a,c,e){if(!this.data.length)return null;var b=f.TYPES_SIZE[this.type];a=Math.clamp(a,0,this.data[this.data.length-b-1]);var g=this.findTimeIndex(a);-1==g&&(g=0);var k=b+1,q=g,l=g+1,m=this.data,p=m.length/k;if(!c||1==p||l==p||0==q&&this.data[0]>a)return this.getKeyframe(g)[1];1<b&&(e=e||this._result,e&&e.length==b||(e=this._result=new Float32Array(b)));var t=m.subarray(q*k,(q+1)*k),q=m.subarray(l*k,(l+1)*k);a=(q[0]-a)/(q[0]-t[0]);if(c===f.LINEAR){if(1==b)return t[1]*a+q[1]*(1-a);k=t.subarray(1,
b+1);q=q.subarray(1,b+1);return f.interpolateLinear(k,q,a,e,this.type,b,this)}if(c===f.CUBIC){if(0===b)return t[1];c=0<g?m.subarray((g-1)*k,g*k):t;l=l<p-1?m.subarray((l+1)*k,(l+2)*k):q;if(1===b)return f.EvaluateHermiteSpline(t[1],q[1],c[1],l[1],1-a);b=t.subarray(1,k);q=q.subarray(1,k);e=f.EvaluateHermiteSplineVector(b,q,c.subarray(1,k),l.subarray(1,k),1-a,e);this.type==f.QUAT?(quat.slerp(e,q,b,a),quat.normalize(e,e)):this.type==f.TRANS10&&(k=e.subarray(3,7),b=b.subarray(3,7),q=q.subarray(3,7),quat.slerp(k,
q,b,a),quat.normalize(k,k));return e}return null};k.prototype.applyTrack=function(a,c,e){if(a)return c=this.getSample(c,e),a.constructor===f.SceneNode?(e=null,(e=a.name==this.target_node?a:a.findNodeByName(this.target_node))&&(e[this.target_property]=c)):a.constructor===f.Skeleton&&(a=a.getBone(this.target_node))&&this.type==f.MAT4&&a.model.set(c),c};k.prototype.serialize=function(){return{enabled:this.enabled,target_node:this.target_node,target_property:this.target_property,type:this.type,data:this.data.constructor==
Array?this.data.concat():typedArrayToArray(this.data),packed_data:this.packed_data}};k.prototype.configure=function(a){this.enabled=a.enabled;this.target_node=a.target_node;this.target_property=a.target_property;if(a.property){var c=a.property.indexOf("/");this.target_node=a.property.substr(0,c);this.target_property=a.property.substr(c+1)}null!=a.type&&(this.type=a.type.constructor===String?f.TYPES[a.type.toUpperCase()]||0:a.type);a.packed_data||a.data.constructor===Float32Array?(this.packed_data=
!0,this.data=new Float32Array(a.data)):(this.packed_data=!1,this.data=a.data.concat())};f.interpolateLinear=function(a,c,e,b,g,k,q){if(1==k)return a*e+c*(1-e);b=b||q._result;b&&b.length==k||(b=q._result=new Float32Array(k));switch(g){case f.QUAT:quat.slerp(b,c,a,e);quat.normalize(b,b);break;case f.TRANS10:for(g=0;3>g;g++)b[g]=a[g]*e+c[g]*(1-e);for(g=7;10>g;g++)b[g]=a[g]*e+c[g]*(1-e);a=a.subarray(3,7);c=c.subarray(3,7);k=b.subarray(3,7);quat.slerp(k,c,a,e);quat.normalize(k,k);break;default:for(g=0;g<
k;g++)b[g]=a[g]*e+c[g]*(1-e)}return b};f.EvaluateHermiteSpline=function(a,c,e,b,f){var g=f*f,k=g*f;return(2*k-3*g+1)*a+(-2*k+3*g)*c+(k-2*g+f)*(c-e)+(k-g)*(b-a)};f.EvaluateHermiteSplineVector=function(a,c,f,b,e,g){g=g||new Float32Array(g.length);var k=e*e,l=k*e,m=2*l-3*k+1,p=-2*l+3*k;e=l-2*k+e;for(var k=l-k,l=0,t=g.length;l<t;++l)g[l]=m*a[l]+p*c[l]+e*(c[l]-f[l])+k*(b[l]-a[l]);return g};Math.lerp||(Math.lerp=m);f.Skeleton=g;g.Bone=e;e.prototype.serialize=function(){return{name:this.name,model:typedArrayToArray(this.model),
parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};e.prototype.configure=function(a){this.name=a.name;this.model.set(a.model);this.parent=a.parent;this.layer=a.layer;this.num_children=0;this.index=null!=a.index?a.index:-1;a.children&&(this.children.set(a.children),this.num_children=a.children.constructor===Array?a.children.length:a.num_children)};e.prototype.copyFrom=e.prototype.configure;g.prototype.applyTransformToBones=
function(a,c){var e=this.getBone(a);e&&mat4.multiply(e.model,e.model,c)};g.prototype.getBone=function(a){return this.bones[this.bones_by_name.get(a)]};g.identity=mat4.create();g.prototype.getBoneMatrix=function(a,c){var e=-1;a.constructor===String?e=this.bones_by_name.get(a):a.constructor===Number&&(e=a);return void 0===e?g.identity:c?this.global_bone_matrices[e]:this.bones[e].model};g.prototype.importSkeleton=function(a,c){function f(a){var c=new e;c.name=a.name||a.id;a.model?c.model.set(a.model):
a.transform&&a.getLocalMatrix&&c.model.set(a.getLocalMatrix());c.index=g.length;g.push(c);b.bones_by_name.set(c.name,c.index);b.global_bone_matrices.push(mat4.create());if(a.children&&a.children.length){c.num_children=a.children.length;for(var h=0;h<a.children.length;++h){var k=f(a.children[h]);c.children[h]=k.index;k.parent=c.index}}return c}var b=this;g?this.bones.length=0:this.bones=[];var g=this.bones;f(a);c&&mat4.mul(g[0].model,c,g[0].model);this.updateGlobalMatrices()};g.temp_mat4=mat4.create();
g.temp_mat43=g.temp_mat4.subarray(0,12);g.prototype.computeFinalBoneMatrices=function(a,c,e){if(!this.bones.length||!c||!c.bones)return a||[];this.updateGlobalMatrices();var b=e?12*c.bones.length:16*c.bones.length;a&&a.length==b||(a=new Float32Array(b));if(e){var f=g.temp_mat4,f=g.temp_mat43;for(e=0;e<c.bones.length;++e)b=c.bones[e],mat4.multiply(temp_mat4,this.getBoneMatrix(b[0],!0),b[1]),c.bind_matrix&&mat4.multiply(temp_mat4,temp_mat4,c.bind_matrix),mat4.transpose(temp_mat4,temp_mat4),a.set(f,
12*e)}else for(e=0;e<c.bones.length;++e)b=c.bones[e],f=a.subarray(16*e,16*e+16),mat4.multiply(f,this.getBoneMatrix(b[0],!0),b[1]),c.bind_matrix&&mat4.multiply(f,f,c.bind_matrix);return a};g.prototype.computeFinalBoneMatricesAsArray=function(a,c,e){if(!this.bones.length||!c||!c.bones)return a||[];this.updateGlobalMatrices();a=a||[];a.length=c.bones.length;for(var b=0;b<c.bones.length;++b){var f=c.bones[b];a[b]||(a[b]=mat4.create());var g=a[b];mat4.multiply(g,this.getBoneMatrix(f[0],!0),f[1]);c.bind_matrix&&
mat4.multiply(g,g,c.bind_matrix);e&&mat4.multiply(g,e,g)}return a};g.prototype.updateGlobalMatrices=function(){var a=this.bones;if(a.length){var c=this.bones.length;this.global_bone_matrices[0].set(a[0].model);for(var e=1;e<c;++e){var b=a[e];mat4.multiply(this.global_bone_matrices[e],this.global_bone_matrices[b.parent],b.model)}}};g.prototype.assignLayer=function(a,c){};g.temp_vec3=vec3.create();g.temp_vec4=vec4.create();g.temp_mat4=mat4.create();g.prototype.applyTracksAnimation=function(a,c){for(var e=
g.temp_vec3,b=g.temp_vec4,k=g.temp_mat4,l=0;l<a.tracks.length;++l){var q=a.tracks[l],m=this.bones_by_name.get(q.target_node);null!=m&&(m=this.bones[m],"model"==q.target_property||"matrix"==q.target_property?q.getSample(c,f.LINEAR,m.model):"position"==q.target_property?(q.getSample(c,f.LINEAR,e),mat4.setTranslation(m.model,e)):"rotation"==q.target_property?(q.getSample(c,f.LINEAR,b),mat4.fromQuat(k,b),mat4.getTranslation(e,m.model),mat4.setTranslation(k,e),m.model.set(k)):"scaling"==q.target_property&&
(q.getSample(c,f.LINEAR,e),mat4.scale(m.model,m.model,e)))}};g.prototype.getVertices=function(a,c){if(!this.bones.length)return null;c||this.updateGlobalMatrices();var e=6*(this.bones.length-1);this._vertices&&this._vertices.length==e||(this._vertices=new Float32Array(e));for(var e=this._vertices,b=0,f=1;f<this.bones.length;++f){var g=this.global_bone_matrices[this.bones[f].parent],k=this.global_bone_matrices[f],l=e.subarray(b,b+3),m=e.subarray(b+3,b+6);mat4.getTranslation(l,k);mat4.getTranslation(m,
g);a&&(vec3.transformMat4(l,l,a),vec3.transformMat4(m,m,a));b+=6}return e};g.prototype.resizeBones=function(a){if(this.bones.length!=a)if(this.bones.length>a)this.bones.length=a,this.global_bone_matrices.length=a;else{var c=this.bones.length;for(this.bones.length=a;c<a;++c)this.bones[c]=new e,this.global_bone_matrices[c]=mat4.create()}};g.prototype.copyFrom=function(a){this.resizeBones(a.bones.length);for(var c=0;c<a.bones.length;++c)this.bones[c].copyFrom(a.bones[c]),this.global_bone_matrices[c].set(a.global_bone_matrices[c]);
this.bones_by_name=new Map(a.bones_by_name)};g.prototype.serialize=function(){for(var a={bones:[],bone_names:{}},c=0;c<this.bones.length;++c)a.bones.push(this.bones[c].serialize());return a};g.prototype.configure=function(a){this.resizeBones(a.bones.length);a.bones_by_name?this.bones_by_name=new Map(a.bones_by_name):this.bones_by_name.clear();for(var c=0;c<a.bones.length;++c){var e=this.bones[c];e.copyFrom(a.bones[c]);e.index=c;a.global_bone_matrices?this.global_bone_matrices[c].set(a.global_bone_matrices[c]):
this.bones_by_name.set(this.bones[c].name,c)}};var t=vec3.create();g.blend=function(a,c,e,b,f,k){if(a.bones.length!=c.bones.length)console.error("skeleton must contain the same number of bones");else{e=Math.clamp(e,0,1);if(255==f){if(0==e){if(b==a)return;b.copyFrom(a);return}if(1==e){b.copyFrom(c);return}}if(b!=a){b.resizeBones(a.bones.length);for(f=0;f<b.bones.length;++f){var l=b.bones[f];l||(l=b.bones[f]=new g.Bone);l.copyFrom(a.bones[f])}b.bones_by_name=new Map(a.bones_by_name)}for(f=0;f<b.bones.length;++f){for(var m=
b.bones[f],p=a.bones[f],z=c.bones[f],l=0;16>l;++l)m.model[l]=Math.lerp(p.model[l],z.model[l],e);if(!k)for(m=m.model,l=0;3>l;++l)t[0]=m[0+l],t[1]=m[4+l],t[2]=m[8+l],vec3.normalize(t,t),m[0+l]=t[0],m[4+l]=t[1],m[8+l]=t[2]}}};g.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
g.vertex_shader_code="\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec3 a_normal;\n\tattribute vec2 a_coord;\n\t\n\tvarying vec3 v_wPosition;\n\tvarying vec3 v_wNormal;\n\tvarying vec2 v_coord;\n\t\n\tuniform mat4 u_viewprojection;\n\tuniform mat4 u_model;\n\tuniform mat4 u_normal_matrix;\n\t\n\t"+g.shader_code+"\n\t\n\tvoid main() {\n\t\tv_wPosition = a_vertex;\n\t\tv_wNormal = (u_normal_matrix * vec4(a_normal,0.0)).xyz;\n\t\tv_coord = a_coord;\n\t\t\n\t\tcomputeSkinning( v_wPosition, v_wNormal);\n\t\t\n\t\tv_wPosition = (u_model * vec4(v_wPosition,1.0)).xyz;\n\t\t\n\t\tgl_Position = u_viewprojection * vec4( v_wPosition, 1.0 );\n\t}\n";
f.SkeletalAnimation=l;l.prototype.load=function(a,c){var e=this;return HttpRequest(a,null,function(a){e.fromData(a);c&&c(e)})};l.prototype.assignTime=function(a,c,e,b){if(this.duration&&this.samples_per_second){c||void 0===c?(a%=this.duration,0>a&&(a=this.duration+a)):a=Math.clamp(a,0,this.duration-1/this.samples_per_second);void 0===e&&(e=!0);a*=this.samples_per_second;b=Math.floor(a);var f=(b+1)%this.num_keyframes;b%=this.num_keyframes;a-=Math.floor(a);var g=this.num_animated_bones;c=16*g;b*=c;
for(var f=f*c,k=this.skeleton,l=this.keyframes,p=this.bones_map,g=Math.min(g,p.length),t=0;t<g;++t){var u=k.bones[p[t]];if(!u)throw"bone not found in skeleton";c=16*t;if(e)for(var x=0;16>x;++x)u.model[x]=m(l[b+c+x],l[f+c+x],a);else u.model.set(l.subarray(b+c,b+c+16))}}};l.prototype.resize=function(a,c){this.num_keyframes=Math.floor(a);this.num_animated_bones=c;this.keyframes=new Float32Array(a*c*16)};l.prototype.assignPoseToKeyframe=function(a,c){if(c>=this.num_keyframes)throw"index is out of range, this skeletal animation doesnt have so many samples, resize first";
for(var e=c*this.num_animated_bones*16,b=0;b<this.num_animated_bones;++b){var f=a.bones[this.bones_map[b]];null!=f&&this.keyframes.set(f.model,e+16*b)}};l.prototype.fromData=function(a){a=a.split("\n");var c=a[0].split(",");this.duration=Number(c[0]);this.samples_per_second=Number(c[1]);this.num_keyframes=Number(c[2]);this.skeleton.resizeBones(Number(c[3]));for(var c=0,e=1;e<a.length;++e){var b=a[e],f=b[0],b=b.substr(1).split(",");if("B"==f){var g=Number(b[0]),k=this.skeleton.bones[g];if(!k)throw"bone not found in skeleton";
k.name=b[1];k.parent=Number(b[2]);for(f=0;16>f;++f)k.model[f]=Number(b[3+f]);-1!=k.parent&&(b=this.skeleton.bones[k.parent],16<=b.num_children?console.warn("too many child bones, max is 16"):b.children[b.num_children++]=g);this.skeleton.bones_by_name.set(k.name,g)}else if("@"==f){this.num_animated_bones=Number(b[0]);for(f=0;f<this.num_animated_bones;++f)this.bones_map[f]=Number(b[f+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==f){g=c*this.num_animated_bones*16;f=0;for(k=
16*this.num_animated_bones;f<k;++f)this.keyframes[g+f]=Number(b[f+1]);c++}else break}this.assignTime(0,!1,!1)};l.prototype.toData=function(){var a=[];a.push([this.duration.toFixed(3),this.samples_per_second,this.num_keyframes,this.skeleton.bones.length].join());for(var c=this.skeleton.bones,e=0;e<c.length;++e){var b=c[e];a.push("B"+e+","+b.name+","+b.parent+","+typedArrayToArray(b.model))}c=[];for(e=0;e<this.num_animated_bones;++e)c.push(this.bones_map[e]);a.push("@"+c.length+","+c.join(","));c=1/
this.samples_per_second;for(e=0;e<this.num_keyframes;++e){for(var b=16*e*this.num_animated_bones,b=this.keyframes.subarray(b,b+16*this.num_animated_bones),f=0;f<b.length;++f)1E-6>Math.abs(b[f])&&(b[f]=0);a.push("K"+(e*c).toFixed(3)+","+b.join(","))}return a.join("\n")};l.prototype.fromTracksAnimation=function(a,c,e,b){this.duration=c.duration;this.samples_per_second=e;this.skeleton.copyFrom(a);for(var f=0,g={},k=0;k<c.tracks.length;++k){var l=c.tracks[k],m=a.bones_by_name.get(l.target_node);null!=
m&&(this.bones_map[f]=m,null==g[l.target_node]&&(g[l.target_node]=l.target_node,f++))}f>a.bones.length&&console.warn("more animated bones than bones?");this.resize(Math.floor(c.duration*e),f);for(k=0;k<this.num_keyframes;++k)this.skeleton.applyTracksAnimation(c,1/e*k),b&&mat4.mul(this.skeleton.bones[0].model,b,this.skeleton.bones[0].model),this.assignPoseToKeyframe(this.skeleton,k)};f.SceneNode&&(f.SceneNode.prototype.assignSkeleton=function(a){var c=gl.meshes[this.mesh];c&&(this.bones=a.computeFinalBoneMatrices(this.bones,
c),this.uniforms.u_bones=this.bones)},f.SceneNode.prototype.assignAnimation=function(a){this.assignSkeleton(a.skeleton)},f.SceneNode.prototype.updateSkinningBones=function(a){a=a||this;this.skin&&this.mesh&&f.collectBones(a,this.skin,gl.meshes[this.mesh]);if(this.children&&this.children.length)for(var c=0;c<this.children.length;++c)this.children[c].updateSkinningBones(a)});f.collectBones=function(a,c,e){function b(a,c,e){if(!c||!a)return e;if(a==c)return mat4.mul(e,a.getGlobalMatrix(),e),e;mat4.mul(e,
a.matrix,e);return b(a._parent,c,e)}if(e&&e.bones){var f=e.bones.length;c._bone_matrices||(c._bone_matrices=new Float32Array(16*f));f=c._bone_matrices;mat4.create();(c=a.findNodeByName(c.skeleton_root))||c==a;for(var g=mat4.create(),k=0;k<e.bones.length;++k){var l=e.bones[k],m=f.subarray(16*k,16*k+16),p=a.findNodeByName(l[0]);p&&(mat4.identity(g),b(p,c,g),mat4.multiply(m,g,l[1]),e.bind_matrix&&mat4.multiply(m,m,e.bind_matrix))}return f}};f.AnimatedCharacterFromScene=function(a,c,e){for(var b=[],g=
[],k=e=null,k=a.constructor===f.SceneNode?a:a.root,l=0;l<k.children.length;++l){var m=k.children[l];if(m.name&&("Armature"==m.name||-1!=m.name.indexOf("_Hips"))||"JOINT"==m.type||m.is_joint)e=m;else if(m.mesh){b.push(m);var p=null;gl.meshes[m.mesh]?p=gl.meshes[m.mesh]:a.meshes&&a.meshes[m.mesh]&&(p=GL.Mesh.load(a.meshes[m.mesh]));p&&g.push({mesh:p})}}!e&&k.findNodesByFilter&&(l=k.findNodesByFilter(function(a){return a.skin}))&&l.length&&(e=l[0]);!b.length&&k.findNodesByFilter&&(b=k.findNodesByFilter(function(a){return a.mesh}));
if(!e)throw"this scene doesnt contain an animated character";l=k=null;b.length&&(m=null,1<b.length?(l=GL.Mesh.mergeMeshes(g),m=b[0].mesh,l.filename=m):(m=b[0].mesh,gl.meshes[m]?(l=gl.meshes[m],l.filename=m):a.meshes&&(l=GL.Mesh.fromBinary(a.meshes[m]),l.filename=m)),gl.meshes[m]=l,g=null,b[0].material?g=b[0].material:b[0].primitives&&b[0].primitives.length&&(g=b[0].primitives[0].material),f.Materials[g]?k=f.Materials[g]:a.materials&&(k=a.materials[g]));b=new f.Skeleton;b.importSkeleton(e,null);g=
null;a.root&&a.root.animation?g=a.root.animation:a.animations&&(g=a.animations[0].id);e=null;f.Animations[g]?e=f.Animations[g]:a.resources&&(a=a.resources[g],e=new f.Animation,e.configure(a.takes["default"]));if(!e)throw"no animation in scene";a=new f.SkeletalAnimation;a.fromTracksAnimation(b,e,30,null);a.filename=c;return{mesh:l?l.filename:null,material:k,skeleton:b,skeletal_anim:a,tracks_anim:e}}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
